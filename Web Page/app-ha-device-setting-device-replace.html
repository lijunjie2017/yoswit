<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">${title}</div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="main-box">
          <div class="toolbar-box" style="padding: 0 15px; margin-top: 15px" v-if="stepList.length && !updateSceneStatus">
            <div class="toolbar tabbar tabbar-scrollable" style="height: 60px">
              <div class="toolbar-inner scene-toolbar-inner">
                <button
                  v-for="(item,index) in stepList"
                  :key="item.id"
                  :class="item.isActive?'button-active button':'button'"
                  v-on:click="toTab(item.id)"
                  v-if="item.isShow"
                >
                  {{_('Step')}} {{item.name}}
                </button>
              </div>
            </div>
          </div>
          <div class="tabs">
            <!-- find device page -->
            <div id="step-0" class="view tab view-main" :class="[index == 1 ? 'tab-active' : '']" v-if="index == 1">
              <div class="card">
                <div
                  class="card-header display-flex justify-content-space-between align-content-center"
                  style="font-weight: 500; font-size: 18px"
                >
                  <a class="link" v-on:click="showDevices()"><i class="material-icons">refresh</i></a>
                  <div class="">
                    <a class="link show-more-button" v-on:click="toggle()" show-more="false"
                      ><span style="font-size: 18px">{{_('more')}}</span>
                      <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!moreStatus">toggle_off</i>
                      <i class="material-icons text-color-theme" style="font-size: 50px" v-if="moreStatus">toggle_on</i>
                    </a>
                  </div>
                </div>
                <div class="card-content card-content-padding">
                  <div class="list media-list" style="margin-top: 0px">
                    <ul>
                      <li
                        v-for="(deviceItem,deviceIndex) in deviceList"
                        :key="deviceItem.id"
                        v-if="deviceIndex < 3 || (deviceIndex >= 3 && moreStatus) "
                      >
                        <div class="item-content" style="padding-left: 15px">
                          <!--<div
                            class="item-media"
                            :style="{'width' : '75px','background-image' : 'url('+deviceItem.img+')','height' : '75px'}"
                          ></div>-->
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title">({{deviceItem.rssi}}) <b>{{deviceItem.model}}</b></div>
                            </div>
                            <div class="item-subtitle">{{deviceItem.name.substring(0,12)}}</div>
                          </div>
                          <div style="float: right; margin-right: 10px; width: 405px">
                            <a
                              v-on:click="coreDeviceReplaceDevice(deviceItem)"
                              class="button button-raised button-round color-theme-bg-blue"
                              style="width: 50px; float: right; margin-left: 10px"
                            >
                              <span class="material-icons"> upgrade </span>
                            </a>
                            <a
                              v-on:click="coreDeviceFlashLed(deviceItem)"
                              :class="{'button button-raised button-round button-preloader color-theme-bg-blue':true,'button-fill':deviceItem.flash?true:false}"
                              style="width: 50px; float: right; margin-left: 10px"
                            >
                              <span class="material-icons"> flare </span>
                            </a>
                            <a
                              v-on:click="iotResetPasswordPeripheral(deviceItem)"
                              class="button button-raised button-round button-preloader color-theme-bg-blue"
                              style="width: 50px; float: right"
                            >
                              <span class="material-icons"> restart_alt </span>
                            </a>
                          </div>
                        </div>
                      </li>
                    </ul>
                    <div class="block" style="text-align: center; margin: 30px 0" v-if="deviceList.length == 0">
                      <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                      <p>${_('You do not have any devices')}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- find device setting page -->
            <div id="step-1" class="view tab view-main" :class="[index == 3 ? 'tab-active' : '']" v-if="index == 3">
              <div class="list media-list" style="margin-top: 0px; padding: 15px; padding-bottom: 45px" v-if="settingList.length != 0">
                <ul>
                  <li v-for="(settingItem,settingIndex) in settingList" :key="settingItem.settingIndex">
                    <div class="card margin-bottom-half mx-0 my-3">
                      <div class="card-content card-content-padding">
                        <div class="row">
                          <div class="col-auto">
                            <div class="avatar avatar-44 elevation-2 rounded-10 bg-color-gray text-color-white">
                              <i class="material-icons">settings</i>
                            </div>
                          </div>
                          <div class="col align-self-center no-padding-left">
                            <h5
                              class="no-margin-bottom"
                              style="width: 215px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap"
                            >
                              {{ _(settingItem.title) }}
                            </h5>
                            <p class="setting-value text-muted size-12">{{_(settingItem.value)}}</p>
                          </div>
                          <div class="col-auto">
                            <a
                              id="action"
                              href="#"
                              class="button button-fill button-44 bg-color-gray button-raised"
                              v-if="!settingItem.writeStatus"
                            >
                              <i class="material-icons">watch_later</i>
                            </a>
                            <a
                              id="action"
                              href="#"
                              class="button button-fill button-44 color-theme button-raised"
                              v-if="settingItem.writeStatus"
                            >
                              <i class="material-icons">check</i>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="card" v-if="settingList.length == 0">
                <div class="card-content card-content-padding">
                  <div class="block" style="text-align: center; margin: 30px 0" v-if="settingList.length == 0">
                    <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                    <p>${_('You do not have any settings.')}</p>
                  </div>
                </div>
              </div>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px; position: fixed; bottom: 10px; z-index: 999">
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="toTab(2)">{{_("previous")}}</div>
                </div>
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="updateSetting()">{{_("Mapping")}}</div>
                </div>
              </div>
            </div>
            <!-- device network page -->
            <div id="step-1" class="view tab view-main" :class="[index == 2 ? 'tab-active' : '']" v-if="index == 2">
              <div class="card" v-if="networkType == 1">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_('Device Network')}}</div>
                <div class="card-content card-content-padding">
                  <div class="list media-list" style="margin-top: 0px">
                    <ul>
                      <li class="device" v-for="(deviceItem,deviceIndex) in deviceNetworkList" :key="deviceItem.name">
                        <div class="item-content" style="padding-left: 15px">
                          <div
                            class="item-media"
                            :style="{'width' : '60px','background-image' : 'url('+deviceItem.image+')','height' : '60px'}"
                          ></div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title"><b>{{deviceItem.device_model}} </b>- {{deviceItem.device_name.substring(0,12)}}</div>
                            </div>
                            <div class="item-subtitle">{{deviceItem.roomInfo}}</div>
                            <div class="signal-panel item-text height-21">
                              <div>
                                <div class="signal"></div>
                                <div class="bluetooth"></div>
                                <div class="mesh"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </li>
                    </ul>
                    <div class="block" style="text-align: center; margin: 30px 0" v-if="deviceNetworkList.length == 0">
                      <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                      <p>${_('You do not have any devices to mesh')}</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card" v-if="networkType == 2">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_('Mesh Network')}}</div>
                <div class="card-content card-content-padding">
                  <div class="list list-outline-ios list-strong-ios list-dividers-ios" style="margin-top: 0px">
                    <ul>
                      <li class="">
                        <a class="item-content">
                          <div class="item-media"><i class="material-icons">dns</i></div>
                          <div class="item-inner">
                            <div class="item-title">
                              <div class="item-header">Name</div>
                              <span class="text-color-gray size-12">{{meshNetworkName}}</span>
                            </div>
                          </div>
                        </a>
                      </li>
                      <li class="">
                        <a class="item-content">
                          <div class="item-media"><i class="material-icons">key</i></div>
                          <div class="item-inner">
                            <div class="item-title">
                              <div class="item-header">{{_('App Keys')}}</div>
                              <span class="text-color-gray size-12">{{appKey}}</span>
                            </div>
                          </div>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px; z-index: 999">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="iotSetMeshIdentify()">{{_("Identify")}}</div>
                  </div>
                </div>
              </div>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px; position: fixed; bottom: 10px">
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="toTab(1)">{{_("previous")}}</div>
                </div>
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="checkMeshComplete()">{{_('Next')}}</div>
                </div>
              </div>
            </div>
            <!-- scene page -->
            <div id="step-4" class="view tab view-main" :class="[index == 5 ? 'tab-active' : '']" v-if="index == 5">
              <!-- this is the scene page -->
              <div class="list media-list" style="margin-top: 0px; padding: 15px; padding-bottom: 45px" v-if="sceneList.length != 0">
                <ul>
                  <li v-for="(sceneItem,sceneIndex) in sceneList" :key="sceneItem.sceneIndex">
                    <div class="card margin-bottom-half mx-0 my-3">
                      <div class="card-content card-content-padding">
                        <div class="row">
                          <div class="col-auto">
                            <div class="avatar avatar-44 elevation-2 rounded-10 bg-color-gray text-color-white">
                              <i class="material-icons">settings</i>
                            </div>
                          </div>
                          <div class="col align-self-center no-padding-left">
                            <h5
                              class="no-margin-bottom"
                              style="width: 215px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap"
                            >
                              {{ tran(sceneItem.title) }}
                            </h5>
                            <p class="setting-value text-muted size-12">{{_(sceneItem.scene_template)}}</p>
                          </div>
                          <div class="col-auto">
                            <a
                              id="action"
                              href="#"
                              class="button button-fill button-44 bg-color-gray button-raised"
                              v-if="!sceneItem.writeStatus"
                            >
                              <i class="material-icons">watch_later</i>
                            </a>
                            <a
                              id="action"
                              href="#"
                              class="button button-fill button-44 color-theme button-raised"
                              v-if="sceneItem.writeStatus"
                            >
                              <i class="material-icons">check</i>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="card" v-if="sceneList.length == 0">
                <div class="card-content card-content-padding">
                  <div class="block" style="text-align: center; margin: 30px 0" v-if="sceneList.length == 0">
                    <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                    <p>${_('You do not have any scenes.')}</p>
                  </div>
                </div>
              </div>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px; position: fixed; bottom: 10px; z-index: 999">
                <div class="col" v-if="!updateSceneStatus">
                  <div class="button button-fill button-save" v-on:click="toTab(4)">{{_("previous")}}</div>
                </div>
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="updateRcuSceneDevice()">
                    {{updateSceneStatus ? _('Update') : _('Mapping')}}
                  </div>
                </div>
              </div>
              <!-- this is the scene page end -->
            </div>
            <!-- firmware upgrade page -->
            <div id="step-6" class="view tab view-main" :class="[index == 4 ? 'tab-active' : '']" v-if="index == 4">
              <device-firmware-upgrade-component
                ref="childRefForFirmwareUpgrade"
                :guid="targetGuid"
                :model="device_map_mode"
                :gateway="gateway"
                v-on:update-status="updateStatusFun"
              ></device-firmware-upgrade-component>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px; position: fixed; bottom: 10px; z-index: 999">
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="toTab(3)">{{_("previous")}}</div>
                </div>
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="startFirmwareUpgrade()">{{_("Next")}}</div>
                </div>
              </div>
            </div>
            <!-- firmware upgrade page end -->
            <!-- gateway page -->
            <div id="step-5" class="view tab view-main" :class="[index == 6 ? 'tab-active' : '']" v-if="index == 6">
              <device-gateway-setting-component
                :gateway="gateway"
                :guid="targetGuid"
                :type="2"
                ref="childRef"
                @child-event="handleChildEvent"
                :ismobile="false"
                :config="gateway_config"
                :isShowUnassigned="true"
              ></device-gateway-setting-component>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="syncGateway()">{{_("COMPLETE")}}</div>
                </div>
              </div>
            </div>
            <!-- device restart and return  -->
            <div id="step-7" class="view tab view-main" :class="[index == 7 ? 'tab-active' : '']" v-if="index == 7">
              <!-- show the device info -->
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_('Restart And Return')}}</div>
              <div class="card-content card-content-padding">
                <div class="list media-list" style="margin-top: 0px">
                  <ul>
                    <li>
                      <div class="item-content" style="padding-left: 15px">
                        <div
                          class="item-media"
                          :style="{'width' : '75px','background-image' : 'url('+imageUrl+')','height' : '75px','background-size' : 'contain','background-position' : 'center','position' : 'relative','background-repeat' : 'no-repeat'}"
                        ></div>
                        <div class="item-inner" style="padding-top: 0px;">
                          <div class="item-title-row" style="width: 100%;">
                            <div class="item-title" style="width: 100%;"><b>{{device_map_model}}</b></div>
                          </div>
                          <div class="item-subtitle" style="width: 100%;">{{core_utils_get_mac_address_from_guid(targetGuid)}}</div>
                          <div class="signal-panel item-text height-21" style="width: 120%" :bluetooth="isConnected?1:0">
                            <div class="signal"></div>
                            <div class="bluetooth"></div>
                          </div>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              </div>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px; position: fixed; bottom: 10px; z-index: 999">
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="toTab(5)">{{_("previous")}}</div>
                </div>
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="restartDevice()">{{_("Complete")}}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $update = ctx.$update,
      $on = ctx.$on;

    let vueApp = null;
    let { guid, title, name, filter_value, update_scene } = $f7route.query;
    console.log('filter_value', filter_value);
    window.retryUpdateTriggerButton = () => {
      console.log('retryUpdateTriggerButton');
      if (vueApp && vueApp.$retryUpdate) {
        vueApp.$retryUpdate();
      }
    };
    console.log('title', title);
    $update();
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        components: {
          DeviceGatewaySettingComponent: window.device_gateway_setting_component,
          DeviceFirmwareUpgradeComponent: window.device_firmware_upgrade_component,
        },
        data: {
          stepList: [
            { id: 1, name: 1, isActive: true, isShow: true },
            { id: 2, name: 2, isActive: false, isShow: true },
            { id: 3, name: 3, isActive: false, isShow: true },
            { id: 4, name: 4, isActive: false, isShow: true },
            { id: 5, name: 5, isActive: false, isShow: true },
            { id: 6, name: 4, isActive: false, isShow: true },
            { id: 7, name: 6, isActive: false, isShow: true },
          ],
          index: 1,
          deviceList: [],
          moreStatus: false,
          settingList: [],
          deviceNetworkList: [],
          targetGuid: '',
          targetPosition: 0,
          networkCount: 0,
          targetNetworkCommandList: [],
          targetPairingCommandList: [],
          blePostCommand: [],
          gateway: '',
          isGateway: false,
          step_title: 'COMPLETE',
          gateway_config: '',
          device_map_model: '',
          device_map_mode: '',
          profile_device_name: '',
          oldMac: '',
          sceneList: [],
          settingUserName: '',
          networkType: 2, //1 :network by yoswit 2:mesh by node
          meshConfig: null,
          appKey: '',
          meshNetworkName: '',
          meshComplete: false, //this means mesh is complete
          rawGuid: '',
          rawSceneList: [],
          thisModel: null,
          updateSceneTriggerDeviceMap: {},
          oldRcuGuid: '',
          currentRcuGuid: '',
          emmitStatus: false,
          retryCount: 0,
          maxRetryCount: 5, // 新增：最大重试次数限制
          bleCommandRetryCount: 0, // 新增：BLE命令重试次数限制
          identifyListenerFun: null, // 新增：预定义监听器函数
          _getWifiMacAddressFun: null, // 新增：预定义WiFi MAC监听器函数
          gatewayListenerFun: null, // 新增：预定义gateway监听器函数
          identifyTimer: null, // 新增：identify定时器引用
          isDisconnectingDevices: false, // 新增：设备断开状态标志
          changeTitle: '',
          updateSceneStatus: isset(update_scene) ? update_scene : false, //if true,should update the scene
          replacePassword: '000000',
          sta_mac_address: '',
          ap_mac_address: '',
          lan_mac_address: '',
          isConnected : false, //target device connect status
        },
        watch: {},
        async mounted() {
          Vue.prototype.$retryUpdate = this.retryUpdate;
          if (this.updateSceneStatus) {
            this.targetGuid = cloneDeep(guid);
            this.initSettingList(this.targetGuid);
            //guid = '';
            this.toTab(5);
          }
          this.showDevices();
          this.initStepList();
          await this.initSceneList();
          await this.checkDeviceReplaceReady();
          await this.getRcuWifiInfo();
          console.log('erp.wifiInfo', erp.wifiInfo);
          // await this.initRolePermission();
          
          // 初始化监听器函数
          this.initializeListeners();
          
          // 注册gateway/sync监听器
          emitter.off('gateway/sync', this.gatewayListenerFun);
          emitter.on('gateway/sync', this.gatewayListenerFun);
        },
        methods: {
          toTab(id) {
            this.index = id;
            this.stepList.forEach((item) => {
              if (item.id == id) {
                item.isActive = true;
              } else {
                item.isActive = false;
              }
            });
            if (id > 3 && !this.updateSceneStatus) {
              this.scrollItem(110 * 2);
            }
            // if (id == 3) {
            //   this.initDeviceNetwork();
            // }
          },
          scrollItem(num) {
            const scrollContainer = document.querySelector('.scene-toolbar-inner');
            scrollContainer.scrollBy({
              top: 0,
              left: num,
              behavior: 'instant',
            });
          },
          async getRcuWifiInfo() {
            return new Promise(async (resolve, reject) => {
              try {
                //get the profile device
                let profile_device = cloneDeep(erp.info.profile.profile_device);
                let rcu_device = profile_device.find(
                  (item) => item.device_model.includes('RCU Controller') || item.device_model.includes('YO780')
                );
                if (!rcu_device.device) {
                  resolve();
                } else {
                  let device = erp.info.device[rcu_device.device];
                  if (device) {
                    let settings = device.settings;
                    if (settings.length) {
                      settings.forEach((kit_item) => {
                        if (kit_item.setting_type == 'Wifi SSID') {
                          if (isset(erp.wifiInfo)) {
                            erp.wifiInfo.ssid = kit_item.setting;
                          } else {
                            erp.wifiInfo = {
                              ssid: kit_item.setting,
                              password: '',
                            };
                          }
                        }
                        if (kit_item.setting_type == 'Wifi Password') {
                          if (isset(erp.wifiInfo)) {
                            erp.wifiInfo.password = kit_item.setting;
                          } else {
                            erp.wifiInfo = {
                              ssid: '',
                              password: kit_item.setting,
                            };
                          }
                        }
                      });
                    }
                  }
                  resolve();
                }
              } catch (err) {
                reject(err);
              }
            });
          },
          async checkDeviceReplaceReady() {
            return new Promise(async (resolve, reject) => {
              try {
                //if the rcu, pay attention, should replace the wifi device
                /*
                1.if repalce the rcu, check if have the wifi device
                */
                let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                let subdevice_map = subdevices.find((item) => item.name == name);
                if (!subdevice_map) {
                  resolve(0);
                }
                this.changeTitle = subdevice_map.title;
                if (subdevice_map.device_mode.includes('RCU Controller')) {
                  let profile_device = cloneDeep(erp.info.profile.profile_device);
                  let isWifiDevice = profile_device.filter(
                    (item) => item.device_model.includes('360') || item.device_model.includes('121-AC') || item.device_model.includes('103')
                  );
                  let replaceStatus = true;
                  isWifiDevice.forEach((item) => {
                    if (!item.device) {
                      replaceStatus = false;
                    }
                  });
                  if (!replaceStatus) {
                    // app.dialog.alert(_('Please note, you must first replace the other Wi-Fi devices.'));
                    resolve(1);
                  }
                } else {
                  resolve(0);
                }
              } catch (error) {
                reject(error);
              }
            });
          },
          async initRolePermission() {
            let url = `/api/method/get_user_permission_4_doctype?doctype=Scene&user=${users[users.current].usr}`;
            try {
              let res = await http2.request(url, {
                method: 'GET',
                serializer: 'json',
                responseType: 'json',
                timeout: 3,
              });
              console.log('res', res);
              if (res.data) {
                console.log('res.data.data', res.data.message);
                if (!res.data.message.write) {
                  app.dialog.alert(_('Pay attention, you do not have permission to replace scene.'));
                  return;
                }
              }
            } catch (error) {
              console.log('error', error);
            }
          },
          initDeviceImage(thisGuid){
            let imageUrl = 'https://my.yoswit.com/files/products/YO2086-1G.svg';
            //this.device_map_model
            const hexid = thisGuid.substring(thisGuid.length - 6, thisGuid.length - 2);
            const model = erp.doctype.device_model[hexid.toUpperCase()];
            debugger
            if (model && model.image) {
              imageUrl = model.image;
            }
            this.imageUrl = imageUrl;
          },
          async initSceneList() {
            let thisGuid = '';
            if (!isset(guid) || guid == 'undefined' || guid == '') {
              let obj = await this.getDeviceMacFromCopyProfile();
              thisGuid = obj.guid;
              this.rawGuid = obj.guid;
              console.log('thisGuid', thisGuid);
              console.log('this.thisModel', this.thisModel);
              let need_action = '1';
              if (
                (this.thisModel.includes('M86') && !this.thisModel.includes('M86-DP')) ||
                this.thisModel.includes('M146') ||
                this.thisModel.includes('YO780')
              ) {
                need_action = '0';
              }
              try {
                let listMap = await http2.request(`/api/method/appv6.getSceneListWithDevice`, {
                  method: 'POST',
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: {
                    profile: erp.info.profile.copy_from,
                    device: thisGuid,
                    need_action: need_action,
                  },
                });
                list = listMap.data.data;
                console.log('list', list);
                //should update the curtain scene and welcome scene
                let thisSceneMap = cloneDeep(erp.info.scene);

                list.forEach((item) => {
                  item.writeStatus = false;
                  for (let scene in thisSceneMap) {
                    if (thisSceneMap[scene].copy_from == item.name) {
                      item.action = thisSceneMap[scene].action;
                      item.trigger = thisSceneMap[scene].trigger;
                    }
                  }
                });
                this.sceneList = list;
                this.rawSceneList = list;
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            } else {
              thisGuid = guid;
              this.oldRcuGuid = thisGuid;
              //if guid is not set,should find the old scene,
              let scenes = cloneDeep(erp.info.scene);
              for (let scene in scenes) {
                let scene_item = scenes[scene];
                scene_item.writeStatus = false;
                let scene_device_location = scene_item.scene_device_location || [];
                let scene_location_map = scene_device_location.find((item) => item.device == thisGuid);
                if (scene_location_map) {
                  this.sceneList.push(scenes[scene]);
                }
                if((this.thisModel.includes('YO121-AC') || this.thisModel.includes('M360s') || this.thisModel.includes('YO103')) && scenes[scene].action.includes(thisGuid)){
                  this.sceneList.push(scenes[scene]);
                }
              }
              console.log('this.sceneList', this.sceneList);
            }
            if (this.thisModel.includes('YO780')) {
              let is_check = await window.iot_check_profile_device('rcu');
              if (!is_check) {
                this.sceneList = [];
                return;
              }
            }
          },
          initStepList() {
            //check if the device is gateway
            let device_models = cloneDeep(erp.doctype.device_model);
            //get this model

            let this_model = '';
            let device_model = '';
            let device_mode = '';
            let profile_device_name = '';
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);

            //check if device is no mode
            profile_subdevices.forEach((item) => {
              if (guid) {
                if (item.device == guid) {
                  device_mode = item.device_mode;
                  profile_device_name = item.profile_device;
                  this.profile_device_name = item.profile_device;
                }
              } else {
                if (item.name == name) {
                  devicem_ode = item.device_mode;
                  profile_device_name = item.profile_device;
                }
              }
            });
            profile_devices.forEach((item) => {
              if (item.name == profile_device_name) {
                this_model = item.device_model;
                this.thisModel = item.device_model;
                this.oldMac = item.device_name;
              }
            });
            let device_map = {};
            for (let model in device_models) {
              if (device_models[model].model_code == this_model) {
                device_map = device_models[model];
              }
            }
            console.log('device_map', device_map);
            if (device_map.gateway && device_map.gateway == 1) {
              this.stepList[4].isShow = true;
              this.stepList[5].isShow = true;
              this.isGateway = true;
              this.step_title = 'Next';
              this.initGatewayConfig();
            } else {
              // this.stepList[4].isShow = false;
              this.stepList[5].isShow = false;
              this.isGateway = false;
              this.step_title = 'COMPLETE';
            }
          },
          syncGateway() {
            this.$refs.childRef.syncGateways();
          },
          startFirmwareUpgrade() {
            this.$refs.childRefForFirmwareUpgrade.startUpdateFirmware();
            // if(users.current.includes('grace.zhao@yoswit.com') || users.current.includes('takyeyu@gmail.com') || users.current.includes('david.lam@yoswit.com') || users.current.includes('jacob.wong@yoswit.local')){
            //   this.$refs.childRefForFirmwareUpgrade.startUpdateFirmware();
            // }else{ 
            //   this.toTab(5);
            // }
          },
          initGatewayConfig() {
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            subdevices.forEach((item) => {
              if (item.device == guid) {
                this.gateway_config = item.config;
              }
            });
          },
          toggle() {
            this.moreStatus = !this.moreStatus;
          },
          showDevices() {
            //get the device model
            let device_model = '';
            let device_mode = '';
            let profile_device_name = '';
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);

            //check if device is no mode
            profile_subdevices.forEach((item) => {
              if (guid) {
                if (item.device == guid) {
                  device_mode = item.device_mode;
                  this.device_map_mode = item.device_mode;
                  profile_device_name = item.profile_device;
                  this.profile_device_name = item.profile_device;
                }
              } else {
                if (item.name == name) {
                  device_mode = item.device_mode;
                  this.device_map_mode = item.device_mode;
                  profile_device_name = item.profile_device;
                  this.profile_device_name = item.profile_device;
                }
              }
            });
            profile_devices.forEach((item) => {
              if (item.name == profile_device_name) {
                this.device_map_model = item.device_model;
                this.replacePassword = item.password;
              }
            });
            //if scene button,
            if (
              this.device_map_model.includes('M86') ||
              this.device_map_model.includes('M146') ||
              this.device_map_model.includes('YO780')
            ) {
              this.networkType = 2;
            } else {
              this.networkType = 1;
            }

            let devices = cloneDeep(peripheral);
            let modeList = cloneDeep(erp.doctype.device_model);
            let erp_device = cloneDeep(erp.info.device);
            let map_device = Object.keys(erp_device);
            let ps = [];
            //debugger
            for (let guid in devices) {
              let p = devices[guid].prop;
              if (!p || !p.rssi || p.rssi >= 0) continue;
              let p_model = Object.values(modeList).find((e) => e.hexid.toLowerCase() === p.hexModel.toLowerCase());
              if (!p_model || device_mode != p_model.mode) continue;
              if(this.device_map_model && this.device_map_model != p_model.model_code) continue;
              if (map_device.indexOf(p.guid) != -1) continue;
              if (filter_value && p.rssi < filter_value) continue;
              ps.push(app.utils.extend({ model: p_model.model_code }, p));
            }
            let rssi_sort = function (a, b) {
              if (a.rssi === b.rssi) {
                return 0;
              } else {
                return a.rssi > b.rssi ? -1 : 1;
              }
            };
            ps.sort(rssi_sort);
            ps.forEach((item) => {
              item.flash = false;
            });
            this.deviceList = ps;
          },
          async coreDeviceFlashLed(item) {
            console.log(item);
            let guid = item.guid;
            let connectStatus = peripheral[guid].prop.connected;
            if (!connectStatus) {
              app.dialog.preloader();
            }
            if (item.flash) {
              item.flash = false;
            } else {
              item.flash = true;
            }
            if (item.model.includes('YO121')) {
              let data = '890064';
              if (item.flash) {
                data = '890064';
              } else {
                data = '890000';
              }
              try {
                await peripheral[guid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: data,
                  },
                ]);
                app.dialog.close();
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
              return;
            }else if(this.device_map_model.includes('790')){
              let data = `980900000101`; // tv
              if(item.flash){
                data = `980900000100`; // phone
              }
              try{
                await peripheral[guid].doMusicPlayer([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    command: data,
                  },
                ]);
                app.dialog.close();
              }catch(error){
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
              return;
            }else if(this.device_map_model.includes('103')){
              let data = '972102016b6120312030300d';
              if (item.flash) {
                data = '972102016b6120312030310d';
              }
              try{
                await peripheral[guid].doHdmiCec([
                  {
                    gang: 1,
                    command: data,
                  },
                ]);
                app.dialog.close();
              }catch(error){
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            }else if(this.device_map_model.includes('360')){
              //command
              const this_gang = 44;
              let data = '9406000001';
              let speed_vaule = 25;
              if (item.flash) {
                speed_vaule = 27;
              }
              data = data + parseInt(speed_vaule).toString(16).pad('00');
              try {
                await peripheral[guid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: data,
                  },
                ]);
                app.dialog.close();
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
              return;
            } else {
              //command
              let data = '8101';
              if (item.flash) {
                data = '812c01';
              } else {
                data = '812c00';
              }
              try {
                await peripheral[guid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: data,
                  },
                ]);
                app.dialog.close();
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            }
            //this.activeDeviceList(item.id,"flash",item.flash);
          },
          activeDeviceList(id, type, value) {
            this.deviceList.forEach((item) => {
              if (item.id == id) {
                item[type] = value;
              }
            });
            console.log('this.deviceList', this.deviceList);
          },
          async connectDevice() {
            return new Promise(async (resolve, reject) => {
              //connect the device if the device is be set paw
              let connect_timer = setTimeout(() => {
                reject(_('Connect failed, please try again.'));
              }, 10000);
              try {
                app.dialog.preloader(_('Connecting to the device.'));
                await window.peripheral[this.targetGuid].connect();
                clearTimeout(connect_timer);
                app.dialog.close();
                resolve();
              } catch (error) {
                clearTimeout(connect_timer);
                this.clearAllDialogs();
                if (error == 7200) {
                  //find the profile password ,this.replacePassword
                  try{
                    app.dialog.preloader(_('Connecting to the device.'));
                    window.peripheral[this.targetGuid].prop.password = this.replacePassword;
                    await window.peripheral[this.targetGuid].connect();
                    app.dialog.close();
                    resolve();
                  }catch(errors){
                    app.dialog.close();
                    window.peripheral[this.targetGuid].prop.password = '000000'
                    reject(errors);
                  }
                } else {
                  reject(error);
                }
              }
            });
          },
          async coreDeviceReplaceDevice(item) {
            //should stop scan for the mesh device
            bleManager.clear();
            await bleManager.stopScan();
            this.targetGuid = item.guid;
            try{
              await this.connectDevice();
            }catch(error){
              app.dialog.alert(_(erp.get_log_description(error)));
              return;
            }
            this.toTab(2);
            this.initDeviceImage(this.targetGuid);
            this.initMeshNetwork();
            this.initDeviceNetwork();
            //this.initSettingList(item);
          },
          async getDeviceSettingWithApi(guid) {
            return new Promise(async (resolve, reject) => {
              try {
                let url = `/api/resource/Device/${guid}`;
                let data = await http2.request(url, {
                  method: 'GET',
                  serializer: 'json',
                  responseType: 'json',
                });
                erp.info.device[guid] = data.data.data;
                resolve(data);
              } catch (error) {
                reject(error);
              }
            });
          },
          async initSettingList(kitem) {
            //settingList
            let settings = [];
            if (!isset(guid) || guid == 'undefined' || guid == '') {
              try {
                let obj = await this.getDeviceSettingWithApi(this.rawGuid);
                console.log('obj', obj);
                settings = obj.data.data.settings;
                //change the ble name
                let bleNameMap = settings.find((item) => item.setting_type == 'Ble Name');
                if (bleNameMap) {
                  let value = bleNameMap.setting;
                  let nameList = value.split('/');
                  let newName = nameList[0];
                  let oldName = nameList[1];
                  newName = newName.replace(`${oldName}`, `${erp.info.profile.flat?erp.info.profile.flat.replace(/^0+/, ''):''}`);
                  bleNameMap.setting = `${newName}/${erp.info.profile.flat}`;
                }
              } catch (error) {
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            } else {
              settings = erp.info.device[guid] ? erp.info.device[guid].settings : [];
            }
            let thisList = [];
            settings.forEach((item) => {
              if (item.setting_type == 'Email Address') {
                this.gateway = `${core_utils_get_mac_address_from_guid(this.targetGuid)}-${item.setting}`;
              }
              let list = iot_ble_device_setting_type_init(
                item.setting_type,
                item.setting,
                kitem.guid ? kitem.guid : this.rawGuid,
                guid ? guid : this.rawGuid
              );
              //console.log("list",list);
              thisList = thisList.concat(list);
            });
            //if have the profile email,then should be add the profile email to the settingList
            if(isset(erp.info.profile.profile_email) && erp.info.profile.profile_email){
              this.gateway = `${core_utils_get_mac_address_from_guid(this.targetGuid)}-${erp.info.profile.profile_email}`;
            }
            //add the change name fun
            if (this.thisModel.includes('YO790')) {
              thisList.push({
                command: '810e',
                value: _('Restart'),
                title: 'Restart',
                setting_type: 'Restart',
                writeStatus: false,
              });
              //open the mtu
              if (Capacitor.getPlatform() === 'android') {
                try {
                  app.dialog.preloader(_('Connecting...'));
                  await window.peripheral[this.targetGuid].connect();
                  app.dialog.close();
                  
                  ble.requestMtu(
                    window.peripheral[this.targetGuid].prop.id,
                    512,
                    () => {
                      console.log('request mtu success');
                    },
                    (error) => {
                      if (error) {
                        app.dialog.alert(_(erp.get_log_description(error)));
                      }
                    }
                  );
                } catch (error) {
                  app.dialog.close();
                  app.dialog.alert(_(erp.get_log_description(error)));
                  return;
                }
              }
            }
            //select the device pairing
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            profile_subdevices.forEach((item) => {
              if (item.device == guid) {
                if (item.config) {
                  //check if the Object is valid
                  let config_map = {};
                  try {
                    let config = JSON.parse(item.config);
                    if (typeof config !== 'object') {
                      return;
                    }
                    config_map = config;
                  } catch (e) {
                    return;
                  }
                  let this_button_group = item.device_button_group;
                  let mapping = config_map.mapping;
                  let subdeviceItem = profile_subdevices.find((e) => e.name == mapping);
                  let targer_button_group = subdeviceItem.device_button_group;
                  let paramsMap = {
                    mapping: mapping,
                    virtual: config_map.virtual,
                    pairing_guid: config_map.pairing_guid,
                    be_pairing: config_map.be_pairing,
                    this_button_group: this_button_group,
                    target_button_group: targer_button_group,
                    this_gang: this_button_group.replace('ONOFF GANG', ''),
                    targer_gang: targer_button_group.replace('ONOFF GANG', ''),
                  };
                  // debugger;
                  if (config_map.pairing_guid) {
                    let list = iot_ble_device_setting_type_init('Device Pairing', paramsMap, kitem.guid, guid);
                    thisList = thisList.concat(list);
                  }
                  //should change to command: title: value:
                  //tindy the command
                  //should params the obj like {"mapping":"vj33epcikm","virtual":"","pairing_guid":"66326262633362663264346412020f1d","be_pairing":"1",this_gang,targer_gang}
                  // {"mapping":"vj33epcikm","virtual":"","pairing_guid":"66326262633362663264346412020f1d","be_pairing":"1"}
                }
              }
            });
            thisList.forEach((item) => {
              item.writeStatus = false;
            });
            this.settingList = thisList;
            console.log('this.settingList', this.settingList);
            let userMap = this.settingList.find((item) => item.setting_type == 'Email Address');
            if (userMap) {
              this.settingUserName = userMap.value;
            }
          },
          async updateSetting() {
            // app.dialog.close();
            // this.toTab(4);
            // return;
            let commandList = [];
            this.targetPairingCommandList = [];
            let mac_address = core_utils_get_mac_address_from_guid(this.targetGuid);
            // debugger;
            const hexid = this.targetGuid.substring(this.targetGuid.length - 6, this.targetGuid.length - 2);
            const model = erp.doctype.device_model[hexid.toUpperCase()];
            let hex_batch = '1D';
            let hex_model = hexid;

            //first update the profile paw
            if (guid.endsWith('12011A01') && this.targetGuid) {
              let data = `88014B${mac_address.substr(9, 2)}${mac_address.substr(0, 2)}A16E95`;
              let data_1 = `8100${mac_address.split(':').join('').convertToHex()}12${hex_model.toLowerCase()}${hex_batch.toLowerCase()}`;
              //'8100'+core_device_replace_target_device.mac_address.split(':').join('').convertToHex()+'12'+core_device_replace_original_device.hex_model.toLowerCase()+core_device_replace_original_device.hex_batch.toLowerCase()
              //'88014B'+core_device_replace_target_device.mac_address.substr(9,2)+core_device_replace_target_device.mac_address.substr(0,2)+'A16E95',
              commandList.unshift(data, data_1);
            }
            let password = peripheral[this.targetGuid].prop.password || '000000';
            let new_password = guid ? peripheral[guid].prop.password : '000000';
            //if the guid is none, should get the password form the erp
            if (!guid) {
              new_password = this.replacePassword;
            } else {
              this.replacePassword = new_password;
            }
            debugger;
            this.settingList.forEach((item) => {
              //filter same item command
              if (commandList.indexOf(item.command) == -1) {
                commandList.push(item.command);
              }
              if (isset(item.targetPairingCommand)) {
                this.targetPairingCommandList.push({
                  command: item.targetPairingCommand,
                  guid: item.targetGuid,
                });
              }
            });
            console.log('commandList', commandList);
            commandList.push(82 + password.convertToHex() + new_password.convertToHex());
            commandList.push('812A');
            this.blePostCommand = commandList;
            //if android, should request mtu
            await new Promise((resolves)=>{
              if(deviceInfo.operatingSystem != 'ios'){
                ble.requestMtu(
                    peripheral[this.targetGuid].prop.id,
                    512,
                    ()=>{
                        console.log('requestMtu success');
                        resolves();
                    },
                    ()=>{
                        console.log('requestMtu error');
                        resolves();
                    },
                )
              }else{
                resolves();
              }
            });
            //get the device wifi mac address
            await this.getDeviceWifiMacAddress();
            await this.updateBleCommand();
            console.log('this.targetPairingCommandList', this.targetPairingCommandList);
          },
          getDeviceWifiMacAddress() {
            return new Promise(async (resolve, reject) => {
              let toast = app.toast.create({
                text: _('Getting device wifi mac address...'),
                position: 'center',
                closeTimeout: 1000 * 60 * 2,
              });
              toast.open();
              try {
                await window.peripheral[this.targetGuid].disconnect();
                await this.sleep(1000);
                await window.peripheral[this.targetGuid].connect();
              } catch (err) {
                console.log('err', err);
                toast.close();
                app.dialog.alert(_(erp.get_log_description(err)));
                reject(err); // 修复Promise悬挂问题
                return;
              }
              // 定义WiFi MAC地址监听器函数（如果尚未定义）
              if (!this._getWifiMacAddressFun) {
                this._getWifiMacAddressFun = (data) => {
                  console.log('data', data);
                  let rs = data.rs;
                  if (data.guid == this.targetGuid) {
                    this.sta_mac_address = rs.substring(10, 22);
                    this.ap_mac_address = rs.substring(22, 34);
                    this.lan_mac_address = rs.substring(46, 58);
                    
                    // 获取到数据后立即清除监听器，避免重复处理
                    emitter.off(`wifi_mac_address`, this._getWifiMacAddressFun);
                    this._getWifiMacAddressFun = null;
                  }
                };
              }
              
              emitter.off(`wifi_mac_address`, this._getWifiMacAddressFun);
              emitter.on(`wifi_mac_address`, this._getWifiMacAddressFun);
              
              setTimeout(async () => {
                try {
                  await window.peripheral[this.targetGuid].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: '932d',
                    },
                  ]);
                  toast.close();
                  
                  // 设置超时清理机制，防止监听器永久存在
                  setTimeout(() => {
                    if (this._getWifiMacAddressFun) {
                      emitter.off(`wifi_mac_address`, this._getWifiMacAddressFun);
                      this._getWifiMacAddressFun = null;
                    }
                  }, 10000); // 10秒后强制清除
                  
                  resolve();
                } catch (writeError) {
                  toast.close();
                  // 写入失败时也要清除监听器
                  if (this._getWifiMacAddressFun) {
                    emitter.off(`wifi_mac_address`, this._getWifiMacAddressFun);
                    this._getWifiMacAddressFun = null;
                  }
                  reject(writeError);
                }
              }, 200);
            });
          },
          async updateBleCommand() {
            // 清理之前可能存在的toast
            this.clearAllToasts();
            
            this.settingToast = app.toast.create({
              text: _('Updating...'),
              position: 'center',
              closeTimeout: 1000 * 60 * 2,
            });
            this.settingToast.open();
            let commands = this.blePostCommand;
            for (let i in commands) {
              if (commands[i].writeStatus) {
                continue;
              }
              try {
                let bleList = [
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: commands[i],
                  },
                ];
                console.log('bleList', bleList);
                await peripheral[this.targetGuid].write(bleList);
                this.settingList.forEach((item) => {
                  if (item.command == commands[i]) {
                    item.writeStatus = true;
                    commands[i].writeStatus = true;
                  }
                });
                let nextStepStatus = true;
                this.settingList.forEach((item) => {
                  if (!item.writeStatus) {
                    nextStepStatus = false;
                  }
                });
                console.log('nextStepStatus', nextStepStatus);
                if (nextStepStatus) {
                  this.settingToast.close();
                  this.bleCommandRetryCount = 0; // 成功后重置重试计数
                  await this.updateSceneDevice();
                  // await this.updateDeviceSettingInErp();
                  app.dialog.close();
                  //check if the device is mesh device
                  // debugger
                  let device_model = this.thisModel;
                  let meshModelList = [
                    'M86-1G',
                    'M86-3DP',
                    'M86-3BR',
                    'M86-3MIR',
                    'M146-LRL',
                    'M146-BRR',
                    'M146-BRL',
                    'YO780',
                    'M86-1PTY',
                    'M86-1MIR',
                    'M86-1CHR',
                    'M86-1BR',
                    'M86-3MBR',
                  ];
                  if (meshModelList.indexOf(device_model) != -1) {
                    this.toTab(4);
                  } else {
                    this.toTab(4);
                    // this.toTab(3);
                    // this.initDeviceNetwork();
                  }
                }
              } catch (error) {
                this.settingToast.close();
                app.dialog.close();
                //if have error,should alert this error and tip
                this.bleCommandRetryCount = this.bleCommandRetryCount || 0;
                if (this.bleCommandRetryCount < 3) {
                  app.dialog.confirm(
                    `${_(erp.get_log_description(error))} ,${_('retry?')} (${3 - this.bleCommandRetryCount} ${_('attempts remaining')})`,
                    () => {
                      this.bleCommandRetryCount++;
                      this.updateBleCommand();
                    },
                    () => {
                      this.bleCommandRetryCount = 0;
                      this.toTab(3);
                      this.initDeviceNetwork();
                    }
                  );
                } else {
                  this.bleCommandRetryCount = 0;
                  app.dialog.alert(_('BLE command retry limit reached, please check device connection'));
                  this.toTab(3);
                  this.initDeviceNetwork();
                }
                break;
                //app.dialog.alert(_(erp.get_log_description(error)));
              }
            }
            peripheral[this.targetGuid].prop.password = this.replacePassword;
          },
          updateDeviceSettingInErp() {
            return new Promise(async (resolve, reject) => {
              let list = cloneDeep(this.settingList);
              // debugger;
              let settingList = [];
              list.forEach((item) => {
                settingList.push({
                  setting_type: item.title,
                  setting: item.value,
                });
              });
              try {
                let url = `/api/resource/Device/${this.targetGuid}`;
                await http2.request(url, {
                  method: 'PUT',
                  serializer: 'json',
                  responseType: 'json',
                  data: {
                    settings: settingList,
                  },
                });
                resolve(1);
              } catch (error) {
                reject(error);
              }
            });
          },
          updateSceneDevice() {
            //scene banner, room scene button,mutiway scene button,rcu scene button,rcu scene toggle,rcu radar,rcu curtain
            //first can not update the rcu scene
            /*
            1.scene banner
            mutiway gang 815 825 835...
            */
            return new Promise(async (resolve, reject) => {
              let scenes = cloneDeep(erp.info.scene);
              for (let i in scenes) {
                if (scenes[i].scene_template == 'Scene Banner' || scenes[i].scene_template == 'Room Scene Button') {
                  try {
                    let actionMap = JSON.parse(scenes[i].action);
                    let post_status = false;
                    actionMap.forEach((item) => {
                      if (item.device == guid) {
                        //update the scene
                        item.device = this.targetGuid;
                        post_status = true;
                      }
                    });
                    //update to erp
                    if (post_status) {
                      let url = `/api/resource/Scene/${scenes[i].name}`;
                      await http2.request(url, {
                        method: 'PUT',
                        serializer: 'json',
                        data: {
                          action: JSON.stringify(actionMap),
                        },
                      });
                    }
                  } catch (e) {
                    reject(e);
                  }
                }
              }
              resolve();
            });
          },
          async retryUpdate() {
            try {
              await this.updateSceneButtonWithBle();

              await this.updateRcuSceneDeviceWithApi();
              await this.updateErpSceneTriggerCommandAndActionCommand();
              this.updateErpData();
            } catch (error) {
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          updateRcuSceneDevice() {
            return new Promise(async (resolve, reject) => {
              //update the device in server script
              try {
                // await this.updateRcuSceneDeviceWithApi();
                debugger
                app.dialog.preloader(_('Checking Device Information.'));
                await this.checkIsOnDeviceErp();
                app.dialog.close();
                if (this.thisModel.includes('YO780') || this.thisModel.includes('M86') || this.thisModel.includes('M146')) {
                  //replace the command
                  await this.replaceRcuSceneDeviceCommand();
                  console.log('this.updateSceneTriggerDeviceMap', this.updateSceneTriggerDeviceMap);

                  if (this.thisModel == 'YO780' && guid != 'undefined' && guid != '' && !this.updateSceneStatus) {
                    await this.updateTriggerButton();
                    await this.updateSceneButtonWithBle();
                    //return;
                  }
                  await this.updateRcuSceneDeviceWithApi();
                  //update the erp scene trigger command
                  await this.updateErpSceneTriggerCommandAndActionCommand();
                } else if (this.thisModel.includes('121-AC') || this.thisModel.includes('360') || this.thisModel.includes('103')) {
                  //update the erp scene trigger command
                  await this.repalceRcuSceneActionCommandForWifiDevice();
                }
                this.updateErpData();
              } catch (error) {
                app.dialog.close();
                reject(error);
                app.dialog.alert(_(erp.get_log_description(error)));
              }

              //if scene button ,replace the trigger,replace the Scene Device Location,replace the Scene Virtual Button

              //if rcu,replace the Action,replace the trigger,replace the Scene Device Location,replace the Scene Virtual Button,replace the Scene Subscribe Address,replace Condition,replace the UI Configuration
            });
          },
          repalceRcuSceneActionCommandForWifiDevice() {
            /*
            1. find the scene of the wifi device 
            2. replace the action command
            */
            return new Promise(async (resolve, reject) => {
              let thisGuid = guid ? guid : this.rawGuid;
              let scenes = cloneDeep(erp.info.scene);
              try {
                for (let i in this.sceneList) {
                  let thisSceneMap = null;
                  //if have been exit guid
                  if(guid){
                    thisSceneMap = this.sceneList[i]
                  }else{
                    for (let j in scenes) {
                      if (scenes[j].copy_from == this.sceneList[i].name) {
                        thisSceneMap = scenes[j];
                        break;
                      }
                    }
                  }
                  if (!thisSceneMap) continue;
                  let action = thisSceneMap.action;
                  let uiConfiguration = null;
                  console.log('thisSceneMap', thisSceneMap);
                  debugger;
                  try {
                    uiConfiguration = JSON.parse(thisSceneMap.ui_configuration);
                  } catch (e) {
                    uiConfiguration = null;
                  }
                  if (action.includes(thisGuid) || (isset(uiConfiguration) && isset(uiConfiguration[`${thisGuid}_device`]))) {
                    //update the action command
                    let newAction = this.replaceInJsonString(action, {
                      [thisGuid]: this.targetGuid,
                      [core_utils_get_mac_address_from_guid(thisGuid, true)]: core_utils_get_mac_address_from_guid(this.targetGuid, true),
                      [core_utils_get_mac_address_from_guid(thisGuid).replace(/:/g, '')]: core_utils_get_mac_address_from_guid(
                        this.targetGuid
                      ).replace(/:/g, ''),
                      [core_utils_get_mac_address_from_guid(thisGuid)]: core_utils_get_mac_address_from_guid(this.targetGuid),
                    });
                    let newuiConfiguration = '';
                    if (isset(uiConfiguration) && isset(uiConfiguration[`${thisGuid}_device`])) {
                      newuiConfiguration = thisSceneMap.ui_configuration;
                      newuiConfiguration = this.replaceInJsonString(newuiConfiguration, {
                        [thisGuid]: this.targetGuid,
                      });
                      let selfCommand = uiConfiguration[`${thisGuid}_device`];
                      if (selfCommand) {
                        let toast = app.toast.create({
                          text: _('Update Self Command'),
                          position: 'center',
                          closeTimeout: 1000 * 60 * 2,
                        });
                        toast.open();
                        try {
                          await peripheral[this.targetGuid].write([
                            {
                              service: 'ff80',
                              characteristic: 'ff81',
                              data: selfCommand.toLocaleLowerCase(),
                            },
                          ]);
                          toast.close();
                        } catch (e) {
                          toast.close();
                          app.dialog.alert(_(erp.get_log_description(e)));
                          break;
                        }
                      }
                    }

                    //write the scene in rcu
                    let rcuGuid = this.getTheSceneRcu(thisSceneMap);
                    // if (rcuGuid) {
                    //   let jsonData = JSON.parse(newAction);
                    //   let bleList = [];
                    //   debugger
                    //   let actionCommand = jsonData[rcuGuid];
                    //   if(actionCommand){
                    //     if (typeof actionCommand == 'string') {
                    //       bleList.push({
                    //         service: 'ff80',
                    //         characteristic: 'ff81',
                    //         data: actionCommand.toLocaleLowerCase(),
                    //       });
                    //     }
                    //     let actionCommand_1 = jsonData[rcuGuid]['actionCommand'];
                    //     if (actionCommand_1) {
                    //       bleList.push({
                    //         service: 'ff80',
                    //         characteristic: 'ff81',
                    //         data: actionCommand_1.toLocaleLowerCase(),
                    //       });
                    //     }
                    //     let actionCommand_2 = jsonData[rcuGuid]['actionCommand_2'];
                    //     if (actionCommand_2) {
                    //       bleList.push({
                    //         service: 'ff80',
                    //         characteristic: 'ff81',
                    //         data: actionCommand_2.toLocaleLowerCase(),
                    //       });
                    //     }
                    //     let rcuToast = app.toast.create({
                    //       text: _('Update RCU Command'),
                    //       position: 'center',
                    //       closeTimeout: 1000 * 60 * 1,
                    //     });
                    //     rcuToast.open();
                    //     try {
                    //       await peripheral[rcuGuid].write(bleList);
                    //       rcuToast.close();
                    //     } catch (error) {
                    //       rcuToast.close();
                    //       reject(error);
                    //       break;
                    //     }
                    //   }
                    // }
                    //post to the erp

                    if (thisSceneMap) {
                      let postData = {
                        action: newAction,
                      };
                      if (isset(newuiConfiguration) && newuiConfiguration != '') {
                        postData['ui_configuration'] = newuiConfiguration;
                      }
                      let url = `/api/resource/Scene/${thisSceneMap.name}`;
                      await http2.request(url, {
                        method: 'PUT',
                        serializer: 'json',
                        data: postData,
                      });
                    }
                  }
                  this.sceneList[i].writeStatus = true;
                }
                if(guid){
                  await http2.request(`/api/resource/Profile/${erp.info.profile.name}`, {
                    method: 'PUT',
                    serializer: 'json',
                    debug: true,
                    data: {
                      'location': '',
                    },
                  });
                }
                resolve(1);
              } catch (error) {
                reject(error);
              }
            });
          },
          replaceRcuSceneDeviceCommand() {
            let self = this;
            let outerResolve, outerReject;
            return new Promise(async (resolve, reject) => {
              outerResolve = resolve;
              outerReject = reject;
              /*
            1.select the scene 
            2.select the trigger
            3.update the trigger command ,trigger action command, setting command
            */
              let scenes = {};
              if ((!isset(guid) || guid == 'undefined' || guid == '') && !this.updateSceneStatus) {
                this.rawSceneList.forEach((item) => {
                  scenes[item.name] = item;
                });
              } else {
                scenes = cloneDeep(erp.info.scene);
              }
              let totalScene = this.sceneList.length;
              let writeScene = 0;
              if (totalScene == 0) {
                app.dialog.close();
                this.currentRcuGuid = this.targetGuid;
                resolve(1);
                return;
              }
              // debugger;
              for (let i in scenes) {
                let scene_device_location = scenes[i].scene_device_location || [];

                let scene_location_map = scene_device_location.find(
                  (item) => item.device == (guid ? guid : this.updateSceneStatus ? this.targetGuid : this.rawGuid)
                );
                if (!scene_location_map && !this.thisModel.includes('M86-DP')) {
                  continue;
                }
                //if the scene have been write ,skip
                let thisSceneMap = this.sceneList.find((item) => item.name == scenes[i].name);
                if (thisSceneMap && thisSceneMap.writeStatus) {
                  writeScene++;
                  continue;
                }
                let templateName = scenes[i].scene_template;
                let trigger = JSON.parse(scenes[i].trigger);
                let action = JSON.parse(scenes[i].action);
                let rcuGuid = this.getTheSceneRcu(scenes[i]);
                //if not rcuGuid,skip
                if (!rcuGuid) {
                  rcuGuid = this.rawGuid;
                }
                let bleList = [];
                if (this.thisModel == 'YO780') {
                  this.saveRcuTriggerCommand(scenes[i]);
                  let thisCommandList = await this.saveActionCommand(scenes[i]);
                  thisCommandList.forEach((item) => {
                    let thisItemCommand = item.command;
                    // debugger
                    if (this.oldRcuGuid) {
                      thisItemCommand = this.replaceMacInInstruction(
                        thisItemCommand,
                        core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                        core_utils_get_mac_address_from_guid(this.targetGuid, true)
                      );
                    }
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: thisItemCommand,
                    });
                  });
                } else {
                  bleList = await this.saveTriggetCommand(scenes[i]);
                }
                // debugger;
                console.log('bleList', bleList);
                //alert(JSON.stringify(bleList));
                let postStatus = true;
                let tips = `${_('Update')} ${tran(scenes[i].title)}`;
                let toast = app.toast.create({
                  text: tips,
                  position: 'center',
                  closeTimeout: 1000 * 30,
                });
                toast.open();
                try {
                  
                  await peripheral[this.targetGuid].write(bleList);
                  postStatus = true;
                  this.sceneList.forEach((item) => {
                    if (item.name == scenes[i].name) {
                      item.writeStatus = true;
                    }
                  });
                  writeScene++;
                  toast.close();
                } catch (error) {
                  postStatus = false;
                  toast.close();
                  app.dialog.confirm(
                    `${_('Update faild,retry?')}`,
                    async () => {
                      try {
                        await self.replaceRcuSceneDeviceCommand();
                        outerResolve(1);
                      } catch (err) {
                        outerReject(err);
                      }
                    },
                    () => {
                      outerReject(error);
                    }
                  );
                  break;
                }
              }
              if (writeScene == totalScene) {
                app.dialog.close();
                resolve(1);
                //app.dialog.alert(_('Update success'));
              }
            });
          },
          strucActionList(list) {
            let targetList = [];
            if (list.length == 0) {
              return targetList;
            }
            //filter the differ mac device
            let macMap = {};
            list.forEach((item) => {
              if (!isset(macMap[item.device])) {
                macMap[item.device] = {};
                macMap[item.device]['device_mode'] = item.device_mode;
              }
            });
            for (let i in macMap) {
              macMap[i]['list'] = [];
              list.forEach((kitem) => {
                if (kitem.device === i) {
                  macMap[i]['list'].push(kitem);
                }
              });
            }
            return macMap;
          },
          getActionCommandByNewToggle(sceneId, vId, guid, actionList, sceneName) {
            let commandList = [];
            let actualActionList = this.strucActionList(actionList);
            for (let guid in actualActionList) {
              let list = actualActionList[guid].list;
              let toggle_setting_item = ``;
              let toggle_default_on_item = '';
              let toggle_default_off_item = '';
              let pannel_setting_item = ``;
              let settingVirtualList = [];
              let firstSceneFlag = '';
              for (let i in list) {
                let device_button_group = list[i].device_button_group;
                if (device_button_group.startsWith('RCU ONOFF GANG')) {
                  let solt = list[i].config;
                  let gang = device_button_group.replace('RCU ONOFF GANG', '') * 1;
                  let target_gang = gang % 4;
                  if (target_gang == 0) {
                    target_gang = 4;
                  }
                  let on_command = this.getRcuOnOffCommand(solt, target_gang, 1);
                  let off_command = this.getRcuOnOffCommand(solt, target_gang, 0);
                  toggle_setting_item += `04971f${parseInt(solt).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;

                  toggle_default_on_item += `${on_command}`;
                  toggle_default_off_item += `${off_command}`;
                } else if (device_button_group.startsWith('RCU DIMMING')) {
                  let solt = list[i].config;
                  let gang = device_button_group.replace('RCU DIMMING', '') * 1;
                  let target_gang = gang % 2;
                  if (target_gang == 0) {
                    target_gang = 2;
                  }
                  toggle_setting_item += `04971f${parseInt(solt).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                  toggle_default_on_item += `06971f${parseInt(solt).toString(16).pad('00')}892${target_gang == 1 ? 0 : 1}ff`;
                  toggle_default_off_item += `06971f${parseInt(solt).toString(16).pad('00')}892${target_gang == 1 ? 0 : 1}00`;
                } else if (device_button_group.startsWith('RCU OUTPUT')) {
                  let target_gang = device_button_group.replace('RCU OUTPUT', '') * 1;
                  toggle_setting_item += `04972101${parseInt(target_gang).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                  toggle_default_on_item += `05972101${parseInt(target_gang).toString(16).pad('00')}01`;
                  toggle_default_off_item += `05972101${parseInt(target_gang).toString(16).pad('00')}00`;
                } else if (device_button_group.startsWith('ONOFF GANG1') && isset(list[i].virtualId)) {
                  settingVirtualList.push({
                    virtualId: list[i].virtualId,
                    ref: list[i].ref,
                  });
                  if (list[i].ref == 1) {
                    toggle_setting_item += `04972103${parseInt(list[i].virtualId).toString(16).pad('00')}`;
                    //toggle_default_on_item += `05972103${parseInt(list[i].virtualId).toString(16).pad('00')}01`;
                  }
                  //toggle_default_off_item += `05972103${parseInt(list[i].virtualId).toString(16).pad('00')}00`;

                  pannel_setting_item += `04972103${parseInt(list[i].virtualId).toString(16).pad('00')}`;
                }
              }
              let command = `972303${parseInt(vId).toString(16).pad('00')}02${toggle_setting_item}`;
              let pannelCommand = '';
              if (pannel_setting_item) {
                pannelCommand = `972003${parseInt(vId).toString(16).pad('00')}02${pannel_setting_item}`;
              }
              if (settingVirtualList.length) {
                //first is on and thore is off
                let firstOne = settingVirtualList[0].virtualId;
                toggle_default_on_item += `05972103${parseInt(firstOne).toString(16).pad('00')}01`;
                defaultOnCommand = `972303${parseInt(vId).toString(16).pad('00')}0105972103${parseInt(firstOne).toString(16).pad('00')}01`;
                let defaultoffCommandItem = '';
                let defaultOnCommandItem = '';
                //if master , all on
                // debugger;
                if (sceneName.toLowerCase().includes('master')) {
                  toggle_default_on_item = '';
                  defaultOnCommand = '';
                }
                settingVirtualList.forEach((item, index) => {
                  toggle_default_off_item += `05972103${parseInt(item.virtualId).toString(16).pad('00')}00`;
                  if (item.ref == 1) {
                    toggle_default_on_item += `05972103${parseInt(item.virtualId).toString(16).pad('00')}01`;
                  }
                  defaultoffCommandItem += `05972103${parseInt(item.virtualId).toString(16).pad('00')}00`;
                });
                defaultOffCommand = `972303${parseInt(vId).toString(16).pad('00')}00${defaultoffCommandItem}`;
                if (sceneName.toLowerCase().includes('master')) {
                  defaultOnCommand = `972303${parseInt(vId).toString(16).pad('00')}01${toggle_default_on_item}`;
                }
              }
              if (toggle_default_on_item) {
                commandList.push(`972303${parseInt(vId).toString(16).pad('00')}01${toggle_default_on_item}`);
              }
              if (toggle_default_off_item) {
                commandList.push(`972303${parseInt(vId).toString(16).pad('00')}00${toggle_default_off_item}`);
              }
              commandList.push(command);
              let actionCommandItem = `0e02${core_utils_get_mac_address_from_guid(guid, true)}1305972103${parseInt(vId).toString(16).pad('00')}02`;
              commandList.push(`8F1000${parseInt(sceneId).toString(16).pad('00')}${actionCommandItem}`);
            }
            return commandList;
          },

          async saveActionCommand(scenesMap) {
            return new Promise(async (resolve, reject) => {
              let sceneTemplate = scenesMap.scene_template;
              let sceneName = scenesMap.title;
              let scene_device_location = scenesMap.scene_device_location || [];
              let scene_virtual_button = scenesMap.scene_virtual_button || [];
              let actionMap = JSON.parse(scenesMap.action);
              let triggerMap = JSON.parse(scenesMap.trigger);
              let uiConfiguration = null;
              try {
                uiConfiguration = JSON.parse(scenesMap.ui_configuration);
              } catch (e) {
                uiConfiguration = null;
              }
              let rcuGuid = this.getTheSceneRcu(scenesMap);
              if (!rcuGuid) {
                rcuGuid = this.rawGuid;
              }
              this.currentRcuGuid = this.targetGuid;
              console.log('guid', guid);
              debugger;
              let oldMac = core_utils_get_mac_address_from_guid(guid ? guid : this.rawGuid, true);
              let newMac = core_utils_get_mac_address_from_guid(this.targetGuid, true);
              let commandList = [];
              if (sceneTemplate == 'RCU Radar' || sceneTemplate == 'Welcome Scene') {
                let triggerCommand = triggerMap[0].triggercommand;
                commandList.push({
                  guid: rcuGuid,
                  command: triggerCommand.toLocaleLowerCase(),
                });
                let uiConfigurationMap = uiConfiguration[`${guid ? guid : this.rawGuid}_device`];
                console.log('uiConfigurationMap guid', `${guid ? guid : this.rawGuid}_device`);
                if (isset(uiConfiguration) && isset(uiConfiguration[`${guid ? guid : this.rawGuid}_device`])) {
                  commandList.push({
                    guid: rcuGuid,
                    command: uiConfiguration[`${guid ? guid : this.rawGuid}_device`].toLocaleLowerCase(),
                  });
                  if (isset(uiConfiguration[`${guid ? guid : this.rawGuid}_scene_command`])) {
                    debugger;
                    commandList.push({
                      guid: rcuGuid,
                      command: uiConfiguration[`${guid ? guid : this.rawGuid}_scene_command`].toLocaleLowerCase(),
                    });
                  }
                }
              }
              if (actionMap[rcuGuid]) {
                // debugger;
                if (typeof actionMap[rcuGuid] === 'string') {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['triggerCommand']) && actionMap[rcuGuid]['triggerCommand']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['triggerCommand'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['actionCommand']) && actionMap[rcuGuid]['actionCommand']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['actionCommand'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['settingCommand']) && actionMap[rcuGuid]['settingCommand']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['settingCommand'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['defaultOnCommand']) && actionMap[rcuGuid]['defaultOnCommand']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['defaultOnCommand'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['defaultOffCommand']) && actionMap[rcuGuid]['defaultOffCommand']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['defaultOffCommand'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['actionCommand_2']) && actionMap[rcuGuid]['actionCommand_2']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['actionCommand_2'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['trigger']) && actionMap[rcuGuid]['trigger']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['trigger'].toLocaleLowerCase(),
                  });
                }
                if (isset(actionMap[rcuGuid]['trigger_2']) && actionMap[rcuGuid]['trigger_2']) {
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[rcuGuid]['trigger_2'].toLocaleLowerCase(),
                  });
                };
                if(isset(actionMap[`second_action_${rcuGuid}`])){
                  commandList.push({
                    guid: rcuGuid,
                    command: actionMap[`second_action_${rcuGuid}`].toLocaleLowerCase(),
                  });
                }
              }
              resolve(commandList);
            });
          },
          async saveRcuTriggerCommand(scenesMap) {
            return new Promise(async (resolve, reject) => {
              let triggerList = JSON.parse(scenesMap.trigger);
              let rcuGuid = this.getTheSceneRcu(scenesMap);
              let oldMac = core_utils_get_mac_address_from_guid(guid ? guid : this.rawGuid, true);
              let newMac = core_utils_get_mac_address_from_guid(this.targetGuid, true);
              for (let i in triggerList) {
                let thisGuid = triggerList[i].guid;
                if (!isset(this.updateSceneTriggerDeviceMap[thisGuid])) {
                  this.updateSceneTriggerDeviceMap[thisGuid] = {};
                }
                if (!isset(this.updateSceneTriggerDeviceMap[thisGuid]['commandList'])) {
                  this.updateSceneTriggerDeviceMap[thisGuid]['commandList'] = [];
                }
                let triggercommand = triggerList[i].triggercommand;
                let actionCommand = triggerList[i].actionCommand;
                let settingCommandList = triggerList[i].settingCommandList;
                let ledTriggerOn = triggerList[i].ledTriggerOn;
                let ledTriggerOff = triggerList[i].ledTriggerOff;
                let ledActionOn = triggerList[i].ledActionOn;
                let ledActionOff = triggerList[i].ledActionOff;
                let ledRawSettingCommand = triggerList[i].ledRawSettingCommand;
                [triggercommand, actionCommand, ledTriggerOn, ledTriggerOff, ledActionOn, ledActionOff, ledRawSettingCommand].forEach(
                  (item) => {
                    if (item) {
                      let command = this.replaceMacInInstruction(item, oldMac, newMac);
                      this.updateSceneTriggerDeviceMap[thisGuid]['commandList'].push(command);
                    }
                  }
                );
                settingCommandList?.forEach((item) => {
                  let command = this.replaceMacInInstruction(item, oldMac, newMac);
                  this.updateSceneTriggerDeviceMap[thisGuid]['commandList'].push(command);
                });
              }
              //if have the dnd and clean
              if(scenesMap.title.includes('Do Not Disturb') || scenesMap.title.includes('Clean Up')){
                //get the m86-dp device
                let profile_device = cloneDeep(erp.info.profile.profile_device);
                let m86_dp_device = profile_device.find((item) => item.device_model == 'M86-DP');
                if(m86_dp_device){
                  //get the m86-dp device id
                  let m86_dp_device_id = m86_dp_device.device;
                  if (!isset(this.updateSceneTriggerDeviceMap[m86_dp_device_id])) {
                    this.updateSceneTriggerDeviceMap[m86_dp_device_id] = {};
                  }
                  if (!isset(this.updateSceneTriggerDeviceMap[m86_dp_device_id]['commandList'])) {
                    this.updateSceneTriggerDeviceMap[m86_dp_device_id]['commandList'] = [];
                  }
                  let uiConfiguration = null; 
                  try{
                    uiConfiguration = JSON.parse(scenesMap.ui_configuration);
                  }catch(e){
                    uiConfiguration = null;
                  }
                  if(uiConfiguration){
                    let keyList = Object.keys(uiConfiguration);
                    keyList.forEach((item)=>{
                      if(uiConfiguration[item] && typeof uiConfiguration[item] === 'string' && uiConfiguration[item].includes('8f32')){
                        this.updateSceneTriggerDeviceMap[m86_dp_device_id]['commandList'].push(uiConfiguration[item].toLocaleLowerCase());
                      }
                    })
                  }
                }
              }
              resolve(1);
            });
          },
          async saveTriggetCommand(scenesMap) {
            return new Promise(async (resolve, reject) => {
              /*
              1.select the trigger list 
              2.find the trigger triggercommand,actionCommand,settingCommandList,ledTriggerOn,ledTriggerOff,ledActionOn,ledActionOff,ledRawSettingCommand
              3.find the old mac address
              4.replace the new mac address
              5.set the new trigger command,action command,setting command
              */
              let triggerList = JSON.parse(scenesMap.trigger);
              let actionList = JSON.parse(scenesMap.action);
              let uiConfiguration = null;
              try {
                uiConfiguration = JSON.parse(scenesMap.ui_configuration);
              } catch (e) {
                uiConfiguration = null;
              }
              let rcuGuid = this.getTheSceneRcu(scenesMap);
              this.currentRcuGuid = rcuGuid;
              let oldMac = core_utils_get_mac_address_from_guid(guid ? guid : this.rawGuid, true);
              let newMac = core_utils_get_mac_address_from_guid(this.targetGuid, true);

              let bleList = [];
              for (let i in triggerList) {
                if (triggerList[i].guid != (guid ? guid : this.rawGuid)) {
                  continue;
                }
                let triggercommand = triggerList[i].triggercommand;
                let actionCommand = triggerList[i].actionCommand;
                let settingCommandList = triggerList[i].settingCommandList;
                let ledTriggerOn = triggerList[i].ledTriggerOn;
                let ledTriggerOff = triggerList[i].ledTriggerOff;
                let ledActionOn = triggerList[i].ledActionOn;
                let ledActionOff = triggerList[i].ledActionOff;
                let ledRawSettingCommand = triggerList[i].ledRawSettingCommand;

                //debugger
                if (triggercommand) {
                  triggercommand = this.replaceMacInInstruction(triggercommand, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    triggercommand = this.replaceMacInInstruction(
                      triggercommand,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: triggercommand.toLocaleLowerCase(),
                  });
                }
                if (actionCommand) {
                  actionCommand = this.replaceMacInInstruction(actionCommand, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    actionCommand = this.replaceMacInInstruction(
                      actionCommand,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: actionCommand.toLocaleLowerCase(),
                  });
                }
                if (settingCommandList && settingCommandList.length) {
                  settingCommandList.forEach((item) => {
                    item = this.replaceMacInInstruction(item, oldMac, newMac);
                    if (this.oldRcuGuid) {
                      item = this.replaceMacInInstruction(
                        item,
                        core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                        core_utils_get_mac_address_from_guid(rcuGuid, true)
                      );
                    }
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: item.toLocaleLowerCase(),
                    });
                  });
                }
                if (ledTriggerOn) {
                  ledTriggerOn = this.replaceMacInInstruction(ledTriggerOn, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    ledTriggerOn = this.replaceMacInInstruction(
                      ledTriggerOn,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: ledTriggerOn.toLocaleLowerCase(),
                  });
                }
                if (ledTriggerOff) {
                  ledTriggerOff = this.replaceMacInInstruction(ledTriggerOff, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    ledTriggerOff = this.replaceMacInInstruction(
                      ledTriggerOff,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: ledTriggerOff.toLocaleLowerCase(),
                  });
                }
                if (ledActionOn) {
                  ledActionOn = this.replaceMacInInstruction(ledActionOn, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    ledActionOn = this.replaceMacInInstruction(
                      ledActionOn,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: ledActionOn.toLocaleLowerCase(),
                  });
                }
                if (ledActionOff) {
                  ledActionOff = this.replaceMacInInstruction(ledActionOff, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    ledActionOff = this.replaceMacInInstruction(
                      ledActionOff,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: ledActionOff.toLocaleLowerCase(),
                  });
                }
                if (ledRawSettingCommand) {
                  ledRawSettingCommand = this.replaceMacInInstruction(ledRawSettingCommand, oldMac, newMac);
                  if (this.oldRcuGuid) {
                    ledRawSettingCommand = this.replaceMacInInstruction(
                      ledRawSettingCommand,
                      core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                      core_utils_get_mac_address_from_guid(rcuGuid, true)
                    );
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: ledRawSettingCommand.toLocaleLowerCase(),
                  });
                }
              }
              let dp_command = '';
              if (isset(uiConfiguration)) {
                let keyList = Object.keys(uiConfiguration);
                keyList.forEach((item)=>{
                  if(uiConfiguration[item] && typeof uiConfiguration[item] === 'string' && uiConfiguration[item].includes('8f32')){
                    dp_command = uiConfiguration[item].toLocaleLowerCase();
                  }
                })
                dp_command = this.replaceMacInInstruction(
                  dp_command,
                  core_utils_get_mac_address_from_guid(this.oldRcuGuid, true),
                  core_utils_get_mac_address_from_guid(rcuGuid, true)
                );
                if(dp_command && this.thisModel == 'M86-DP'){
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: dp_command.toLocaleLowerCase(),
                  });
                }
              }
              resolve(bleList);
            });
          },
          replaceMacInInstruction(instruction, oldMac, newMac) {
            if (typeof instruction !== 'string' || typeof oldMac !== 'string' || typeof newMac !== 'string') {
              return instruction;
            }
            if (oldMac.length === 0 || oldMac.length !== newMac.length) {
              return instruction;
            }
            try {
              const normalizedOld = oldMac.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const regex = new RegExp(normalizedOld, 'gi');
              return instruction.replace(regex, newMac);
            } catch (e) {
              console.error('MAC replacement error:', e);
              return instruction;
            }
          },
          async saveTriggerOnble(templateName, triggerList, action, rcuGuid, scenesMap) {
            //tip of the scene
            return new Promise(async (resolve, reject) => {
              let triggerCommandList = [];
              if (templateName == 'RCU Radar' || templateName == 'Welcome Scene') {
              } else {
                let haveWriteStatus = false;
                this.sceneList.forEach((item) => {
                  if (item.name == scenesMap.name && item.writeStatus) {
                    haveWriteStatus = true;
                  }
                });
                if (haveWriteStatus) {
                  resolve(1);
                }
                let tips = `${_('Update')} ${tran(scenesMap.title)}`;
                let toast = app.toast.create({
                  text: tips,
                  position: 'center',
                  closeTimeout: 2000,
                });
                toast.open();
                let postStatus = true;
                for (let i in triggerList) {
                  let mac = core_utils_get_mac_address_from_guid(this.targetGuid, true);
                  let rcuMac = core_utils_get_mac_address_from_guid(rcuGuid, true);
                  if (triggerList[i].guid != guid) {
                    continue;
                  } else {
                    //get the scene id
                    let triggerId = triggerList[i].triggerId;
                    let triggerId_2 = triggerList[i].triggerId_2;
                    let triggerId_3 = triggerList[i].triggerId_3;
                    let changeLedStatus_1 = false;
                    let ledActionCommand_1 = '';
                    let changeLedStatus_2 = false;
                    let ledActionCommand_2 = '';
                    let actionList = action['actionList'];
                    let actionList_2 = isset(action['actionList_2']) ? action['actionList_2'] : [];
                    let last_command = ``;
                    let gang = 1;
                    if (triggerList[i].button_group.startsWith('ONOFF GANG')) {
                      gang = triggerList[i].button_group.replace('ONOFF GANG', '') * 1;
                      if (triggerList[i].model == 'YO780-Scene-4G') {
                        if (gang == 2) {
                          gang = 3;
                        }
                        if (gang == 3) {
                          gang = 4;
                        }
                        if (gang == 4) {
                          gang = 6;
                        }
                      }
                    }
                    actionList.forEach((actionItem) => {
                      if (actionItem.device_mode == 'RCU Controller' && actionItem.device_button_group == 'ONOFF GANG1') {
                        changeLedStatus_1 = true;
                        let virtualId = actionItem.virtualId;
                        let virtualIdType = actionItem.virtualIdType;
                        ledActionCommand_1 += `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                      }
                    });
                    actionList_2.forEach((actionItem) => {
                      if (actionItem.device_mode == 'RCU Controller' && actionItem.device_button_group == 'ONOFF GANG1') {
                        changeLedStatus_2 = true;
                        let virtualId = actionItem.virtualId;
                        let virtualIdType = actionItem.virtualIdType;
                        ledActionCommand_2 += `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                      }
                    });
                    if (templateName == 'RCU Curtain') {
                      actionList.forEach((actionItem) => {
                        if (actionItem.device_mode == 'RCU Controller' && actionItem.device_button_group == 'ONOFF GANG1') {
                          changeLedStatus_1 = true;
                          let virtualId = actionItem.virtualId;
                          let virtualIdType = actionItem.virtualIdType;
                          if (triggerList[i] == 2) {
                            //click open or close
                            ledActionCommand_1 += `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                          } else if (triggerList[i] == 4) {
                            ledActionCommand_1 += `05972103${parseInt(virtualId).toString(16).pad('00')}00`;
                          }
                        }
                      });
                    }
                    last_command = this.tidyCommand(
                      parseInt(triggerId).toString(16).pad('00'),
                      parseInt(triggerId).toString(16).pad('00'),
                      triggerList[i],
                      0,
                      templateName,
                      rcuMac
                    );
                    console.log('last_command', last_command);
                    let thisActionCommand = '';
                    let actionItemCommand = '';
                    let settingCommandList = [];
                    settingCommandList.push(`8f0c00${rcuMac}`);
                    let virtualId = this.getRcuVirtualId(rcuGuid, scenesMap);
                    if (!actionList_2.length) {
                      let idList = this.getRcuSceneId(rcuGuid, scenesMap);
                      let this_sceneId = idList[0];
                      actionItemCommand = `0d02${rcuMac}13048f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                    }
                    thisActionCommand = `8f1000${parseInt(triggerId).toString(16).pad('00')}${actionItemCommand}`;
                    // actionItemCommand = `0d02${rcuMac}13048f0200`

                    if (actionList_2.length) {
                      let idList = this.getRcuSceneId(rcuGuid, scenesMap);
                      if (templateName != 'RCU Curtain') {
                        if (this.rcuIsMain(rcuGuid)) {
                          let this_command_data = '';
                          let actionCommandItem = `02${mac}1305972103${parseInt(virtualId).toString(16).pad('00')}02`;
                          this_command_data += `02${rcuMac}972103${parseInt(virtualId).toString(16).pad('00')}02`;
                          if (triggerId_2 && !triggerId_3) {
                            actionCommandItem += ledActionCommand_1;
                          }
                          this_command_data = `${(this_command_data.length / 2).toString(16).pad('00')}${this_command_data}${(actionCommandItem.length / 2).toString(16).pad('00')}${actionCommandItem}}`;
                          thisActionCommand = `8f1000${parseInt(triggerId).toString(16).pad('00')}${this_command_data}`;
                          settingCommandList.push(
                            `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(virtualId).toString(16).pad('00')}00`
                          );
                        } else {
                          let this_command_data = `02${rcuMac}972103${parseInt(virtualId).toString(16).pad('00')}02`;
                          let actionCommandItem = `02${mac}1305972103${parseInt(virtualId).toString(16).pad('00')}02`;
                          if (triggerId_2 && !triggerId_3) {
                            actionCommandItem += ledActionCommand_1;
                          }
                          this_command_data = `${parseInt(this_command_data.length / 2)
                            .toString(16)
                            .pad('00')}${this_command_data}${parseInt(actionCommandItem.length / 2)
                            .toString(16)
                            .pad('00')}${actionCommandItem}`;
                          thisActionCommand = `8f1000${parseInt(triggerId).toString(16).pad('00')}${this_command_data}`;
                          settingCommandList.push(
                            `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(triggerId).toString(16).pad('00')}00`
                          );
                        }
                      }
                    } else {
                      settingCommandList.push(
                        `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(virtualId).toString(16).pad('00')}00`
                      );
                      let _commands = `02${mac}1305972103${parseInt(virtualId).toString(16).pad('00')}01`;
                      if (triggerId_2 && !triggerId_3) {
                        _commands += ledActionCommand_1;
                      }
                      thisActionCommand = `${thisActionCommand}${parseInt(_commands.length / 2)
                        .toString(16)
                        .pad('00')}${_commands}`;
                    }
                    if (templateName == 'RCU Curtain') {
                      console.log('RCU Curtain Comming.');
                      let idList = this.getRcuSceneId(rcuGuid, scenesMap);
                      // debugger;
                      if (triggerList[i].ref == 2) {
                        let $command = `02${rcuMac}8f0200${parseInt(idList[0]).toString(16).pad('00')}`;
                        actionItemCommand = `${parseInt($command.length / 2)
                          .toString(16)
                          .pad('00')}${$command}`;
                        if (ledActionCommand_1) {
                          let $command = `02${mac}13${ledActionCommand_1}`;
                          actionItemCommand = `${actionItemCommand}${parseInt($command.length / 2)
                            .toString(16)
                            .pad('00')}${$command}`;
                        }
                        thisActionCommand = `8f1000${parseInt(triggerId).toString(16).pad('00')}${actionItemCommand}`;
                      } else if (triggerList[i].ref == 4) {
                        let $command_1 = `02${mac}8f0200${parseInt(idList[1]).toString(16).pad('00')}`;
                        actionItemCommand = `${parseInt($command_1.length / 2)
                          .toString(16)
                          .pad('00')}${$command_1}`;
                        if (ledActionCommand_2) {
                          let $command = `02${rcuMac}13${ledActionCommand_2}`;
                          actionItemCommand = `${actionItemCommand}${parseInt($command.length / 2)
                            .toString(16)
                            .pad('00')}${$command}`;
                        }
                        thisActionCommand = `8f1000${parseInt(triggerId).toString(16).pad('00')}${actionItemCommand}`;
                      }
                      //setting self virtual id
                      settingCommandList.push(
                        `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(virtualId).toString(16).pad('00')}00`
                      );
                    }
                    let ledTriggerOn = '';
                    let ledTriggerOff = '';
                    let ledActionOn = '';
                    let ledActionOff = '';
                    if (triggerId_2 && triggerId_3) {
                      let pre_command = `8F2000${parseInt(triggerId_2).toString(16).pad('00')}${parseInt(triggerId_2).toString(16).pad('00')}`;
                      let $thisCommand = `${'00'}${'1f'}${mac}00${'01'}13${parseInt(virtualId).toString(16).pad('00')}`;
                      $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                      ledTriggerOn = `${pre_command}${$thisCommand}`;
                      let pre_command_3 = `8F2000${parseInt(triggerId_3).toString(16).pad('00')}${parseInt(triggerId_3).toString(16).pad('00')}`;
                      let $thisCommand_3 = `${'00'}${'1f'}${mac}00${'00'}13${parseInt(virtualId).toString(16).pad('00')}`;
                      $thisCommand_3 = `${($thisCommand_3.length / 2).toString(16).pad('00')}${$thisCommand_3}`;
                      ledTriggerOff = `${pre_command_3}${$thisCommand_3}`;
                      let _this_command_1 = `02${mac}13${ledActionCommand_1}`;
                      let _this_command_2 = `02${mac}13${ledActionCommand_2}`;
                      ledActionOn = `8f1000${parseInt(triggerId_2).toString(16).pad('00')}${parseInt(_this_command_1.length / 2)
                        .toString(16)
                        .pad('00')}${_this_command_1}`;
                      ledActionOff = `8f1000${parseInt(triggerId_3).toString(16).pad('00')}${parseInt(_this_command_2.length / 2)
                        .toString(16)
                        .pad('00')}${_this_command_2}`;
                    }
                    let bleList = [
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: last_command,
                      },
                    ];
                    if (ledTriggerOn) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: ledTriggerOn,
                      });
                    }
                    if (ledActionOn) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: ledActionOn,
                      });
                    }
                    if (ledTriggerOff) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: ledTriggerOff,
                      });
                    }
                    if (ledActionOff) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: ledActionOff,
                      });
                    }
                    if (thisActionCommand) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: thisActionCommand,
                      });
                    }
                    for (let z in settingCommandList) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: settingCommandList[z],
                      });
                    }
                    console.log('settingCommandList', settingCommandList);
                    console.log('bleList', bleList);
                    try {
                      await peripheral[this.targetGuid].write(bleList);
                      postStatus = true;
                    } catch (error) {
                      postStatus = false;
                    }
                  }
                }
                if (postStatus) {
                  //scenesMap
                  this.sceneList.forEach((item) => {
                    if (item.name == scenesMap.name) {
                      item.writeStatus = true;
                    }
                  });
                  toast.close();
                  resolve(1);
                } else {
                  reject(0);
                }
              }
            });
          },
          tidyCommand(scene_id, listIndex, item, index, templateName, rcuMac) {
            let isOldChip = false;
            let typeIndex = '02';
            let triggerCommand = ``;
            let pre_command = `8F2000${scene_id}${listIndex}`;
            let total_command = ``;
            let guid = this.targetGuid;
            let mac = core_utils_get_mac_address_from_guid(guid, true);
            let ref = item.ref;
            let this_command = '';
            let virtualCommand = ``;
            let totalVirtualCommand = ``;
            if (isset(ref)) {
              let sensor_command = ``;
              if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor') {
                if (templateName == 'RCU Radar' || templateName == 'RCU Scene Button') {
                  typeIndex = `01`;
                  let opcode = '00';
                  let rcu_mac = rcuMac;
                  let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                  triggerCommand = `${opcode}${typeIndex}${rcu_mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                } else {
                  typeIndex = `02`;
                  let opcode = '00';
                  triggerCommand = `${opcode}${typeIndex}${mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                }
              }
              if (item.button_group.startsWith('ONOFF GANG')) {
                let gang = item.button_group.replace('ONOFF GANG', '') * 1;
                if (item.model == 'YO780-Scene-4G') {
                  if (gang == 2) {
                    gang = 3;
                  } else if (gang == 3) {
                    gang = 4;
                  } else if (gang == 4) {
                    gang = 6;
                  }
                }
                typeIndex = `01`;
                let this_ref = '00';
                let runTime = '';
                if (ref) {
                  //this_ref = Math.pow(2, gang*1 - 1).toString(16).pad('00');
                  if (ref == 1 || ref == 2) {
                    this_ref = '01';
                  } else if (ref == 4) {
                    this_ref = '04';
                    typeIndex = '21';
                    runTime = '0f';
                  } else if (ref == 5) {
                    // this.isExtraStatus = true;
                    this_ref = '00';
                  } else {
                    this_ref = '00';
                  }
                }
                let opcode = '00'; //this params used check "or" condition,must be set data length after it;
                triggerCommand = `${opcode}${typeIndex}${mac}${parseInt(gang).toString(16).pad('00')}${this_ref}${runTime}`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
              if (item.button_group.startsWith('SCENE MUTIWAY ONOFF GANG')) {
                typeIndex = `1f`;
                let this_ref = item.ref;
                let opcode = '00';
                let gang = isset(item.config) ? item.config : parseInt(this.actionLocation[item.guid]);
                // debugger;
                let $thisCommand = `${opcode}${typeIndex}${mac}00${parseInt(this_ref).toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
                $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                total_command += $thisCommand;
              }
              if (item.button_group.startsWith('DIMMING')) {
                typeIndex = `1a`;
                let this_ref = '00';
                if (ref) {
                  this_ref = `02`;
                }
                triggerCommand = `${typeIndex}${mac}${this_ref}00`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
              if (item.button_group.startsWith('Door Open')) {
                //if the ti chip,the command is like
                //8f01008d010200053e49168d3a0802
                //only support 8c、8d、8e、8f
                //typeIndex = `04`;
                typeIndex = `05`;
                isOldChip = true;
                let opcode = '00';
                //let this_ref = '00';
                let this_ref = '7b';
                if (ref) {
                  //this_ref = `01`;
                  this_ref = '7c';
                }
                let this_id = '';
                if (scene_id == '01') {
                  this_id = '8c';
                } else if (scene_id == '02') {
                  this_id = '8d';
                } else if (scene_id == '03') {
                  this_id = '8e';
                } else if (scene_id == '04') {
                  this_id = '8f';
                }
                // triggerCommand = `${opcode}${typeIndex}${mac}${this_ref}`;
                // triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                // total_command += triggerCommand;
                triggerCommand = `8f0100${this_id}010200${typeIndex}${core_utils_get_mac_address_from_guid(this.gatewayMapGuid, true)}${parseInt(this.actionLocation[this.gatewayMapGuid]).toString(16).pad('00')}`;
                total_command = `${triggerCommand}&&8f0300${this_ref}${this_id}`;
              }
            }
            if (item.temp || item.temp_less) {
              typeIndex = '05';
              if (item.temp) {
                let temp_command = `${typeIndex}${mac}02${core_utils_float_ieee_convert(item.temp)}`;
                this_command = `${(temp_command.length / 2).toString(16).pad('00')}${temp_command}`;
                triggerCommand += this_command;
              }
              if (item.temp_less) {
                let temp_less_command = `${typeIndex}${mac}01${core_utils_float_ieee_convert(item.temp_less)}`;
                this_command = `${(temp_less_command.length / 2).toString(16).pad('00')}${temp_less_command}`;
                triggerCommand += this_command;
              }
              total_command += triggerCommand;
            }
            if (item.hum || item.hum_less) {
              let hum_command = ``;
              typeIndex = '06';
              if (item.hum) {
                let this_hum_command = `${typeIndex}${mac}02${core_utils_float_ieee_convert(item.hum)}`;
                hum_command = `${(this_hum_command.length / 2).toString(16).pad('00')}${this_hum_command}`;
                triggerCommand += hum_command;
              }
              if (item.hum_less) {
                let this_hum_less_command = `${typeIndex}${mac}01${core_utils_float_ieee_convert(item.hum_less)}`;
                hum_command = `${(this_hum_less_command.length / 2).toString(16).pad('00')}${this_hum_less_command}`;
                triggerCommand += hum_command;
              }
              total_command += triggerCommand;
            }
            if (isOldChip) {
              return `${total_command}`;
            } else {
              return `${pre_command}${this.replaceTTWithLength(total_command)}${totalVirtualCommand}`;
            }
          },
          replaceTTWithLength(str) {
            let list = str.split('tt');
            console.log('list', list);
            if (list.length == 1) {
              return str;
            }
            let command = ``;
            let total = 0;
            let $length = list.length - 1;
            for (let i = $length; i >= 0; i--) {
              if (i == $length) {
                let index = (list[i].length / 2).toString(16).pad('00');
                command = `${index}${list[i]}`;
              } else if (i == 0) {
                command = `${list[i]}${command}`;
              } else {
                let index = ((list[i].length + command.length) / 2).toString(16).pad('00');
                command = `${index}${list[i]}${command}`;
              }
            }
            return command;
          },
          rcuIsMain(guid) {
            let result = false;
            let setting = erp.info.device[guid].settings;
            if (isset(setting)) {
              setting.forEach((item) => {
                if (item.setting_type == 'main_rcu' && item.setting == '1') {
                  result = true;
                }
              });
            }
            return result;
          },
          getRcuVirtualId(guid, sceneMap) {
            let rcuVirtualId = '';
            let scene_virtual_button = isset(sceneMap['scene_virtual_button']) ? sceneMap['scene_virtual_button'] : [];
            scene_virtual_button.forEach((item) => {
              if (item.device == guid) {
                rcuVirtualId = item.virtual_button_id;
              }
            });
            return rcuVirtualId;
          },
          getRcuSceneId(guid, sceneMap) {
            let idList = [];
            let scene_device_location = isset(sceneMap['scene_device_location']) ? sceneMap['scene_device_location'] : [];
            scene_device_location.forEach((item) => {
              if (item.device == guid) {
                idList.push(item.storage_id);
              }
            });
            return idList;
          },
          getTheSceneRcu(sceneMap) {
            //select the profile rcu,and return the rcu guid
            // debugger
            let rcuGuid = '';
            let rcuList = [];
            let scene_device_location = sceneMap.scene_device_location || [];
            for (let i in scene_device_location) {
              let guid = scene_device_location[i].device;
              if (isset(erp.info.device[guid])) {
                let device_mode = erp.info.device[guid].device_mode;
                if (device_mode == 'RCU Controller') {
                  if (rcuList.indexOf(guid) == -1) {
                    rcuList.push(guid);
                  }
                }
              }
            }
            //if have two rcu
            if (rcuList.length > 1) {
              rcuList.forEach((item) => {
                let setting = erp.info.device[item].settings;
                setting.forEach((kitem) => {
                  if (kitem.setting_type == 'main_rcu' && kitem.setting == '1') {
                    rcuGuid = item;
                  }
                });
              });
            } else if (rcuList.length == 1) {
              rcuGuid = rcuList[0];
            }
            //if rcuGuid is empty, find the current rcu guid
            if (!rcuGuid) {
              let thisDevices = cloneDeep(erp.info.device);
              for (let i in thisDevices) {
                if (thisDevices[i].device_mode == 'RCU Controller' || thisDevices[i].device_model == 'YO780') {
                  rcuGuid = i;
                  break;
                }
              }
            }
            return rcuGuid;
          },
          async updateErpSceneTriggerCommandAndActionCommand() {
            app.dialog.preloader(_('Updating Scene Commands, it may take about 2-3 minutes.'));
            let list = [];
            let oldMac = '';
            if (!isset(guid) || guid == 'undefined' || guid == '') {
              let result = await this.getDeviceMacFromCopyProfile();
              oldMac = result.mac;
            } else {
              oldMac = core_utils_get_mac_address_from_guid(guid, true);
            }
            let newMac = core_utils_get_mac_address_from_guid(this.targetGuid, true);
            try {
              //fixed if M86-DP,should get the scene from ui_configuration
              let postData = {
                profile: erp.info.profile.name,
                device: this.targetGuid,
              };
              if(this.thisModel == 'M86-DP' && !guid){
                postData = {
                  profile: erp.info.profile.name,
                  device: this.rawGuid,
                  need_action: '1'
                }
              }else{
                postData = {
                  profile: erp.info.profile.name,
                  device: guid,
                  need_action: '1'
                }
              }
              let listMap = await http2.request(`/api/method/appv6.getSceneListWithDevice`, {
                method: 'POST',
                serializer: 'json',
                responseType: 'json',
                debug: true,
                data: postData,
              });
              list = listMap.data.data;
              console.log('list', list);
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
              return;
            }
            //update the action and trigger data
            let thisSceneMap = cloneDeep(erp.info.scene);
            for (let i in list) {
              if (thisSceneMap[list[i].name]) {
                list[i].trigger = thisSceneMap[list[i].name].trigger;
                list[i].action = thisSceneMap[list[i].name].action;
              }
              let trigger = list[i].trigger;
              let action = list[i].action;
              let ui_configration = list[i].ui_configuration;
              let obj = {};
              obj[oldMac] = newMac;
              obj[guid ? guid : this.rawGuid] = this.targetGuid;
              obj[core_utils_get_mac_address_from_guid(guid ? guid : this.rawGuid).replace(/:/g, '')] =
                core_utils_get_mac_address_from_guid(this.targetGuid).replace(/:/g, '');
              let newTrigger = this.replaceInJsonString(trigger, obj);
              let newAction = this.replaceInJsonString(action, obj);
              let newUiConfigration = this.replaceInJsonString(ui_configration, obj);
              debugger;
              if (this.oldRcuGuid) {
                let oldRcuReplaceMap = {};
                oldRcuReplaceMap[core_utils_get_mac_address_from_guid(this.oldRcuGuid, true)] = core_utils_get_mac_address_from_guid(
                  this.currentRcuGuid,
                  true
                );
                oldRcuReplaceMap[this.oldRcuGuid] = this.currentRcuGuid;
                oldRcuReplaceMap[core_utils_get_mac_address_from_guid(this.oldRcuGuid).replace(/:/g, '')] =
                  core_utils_get_mac_address_from_guid(this.currentRcuGuid).replace(/:/g, '');
                oldRcuReplaceMap[core_utils_get_mac_address_from_guid(this.oldRcuGuid)] = core_utils_get_mac_address_from_guid(
                  this.currentRcuGuid
                );
                newTrigger = this.replaceInJsonString(newTrigger, oldRcuReplaceMap);
                newAction = this.replaceInJsonString(newAction, oldRcuReplaceMap);
                newUiConfigration = this.replaceInJsonString(newUiConfigration, oldRcuReplaceMap);
              }
              // debugger;
              console.log('newTrigger', newTrigger);
              console.log('newAction', newAction);
              console.log('newUiConfigration', newUiConfigration);
              list[i].trigger = newTrigger;
              list[i].action = newAction;
              list[i].ui_configuration = newUiConfigration;
              try {
                let url = `/api/resource/Scene/${list[i].name}`;
                let response = await http2.request(url, {
                  method: 'PUT',
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: {
                    trigger: newTrigger,
                    action: newAction,
                    ui_configuration: newUiConfigration,
                  },
                });
                console.log('response', response);
                await this.sleep(1000);
              } catch (error) {
                console.log('error', error);
                return;
              }
            }
            app.dialog.close();
          },
          async getDeviceMacFromCopyProfile() {
            return new Promise(async (resolve, reject) => {
              let mac = '';
              let thisGuid = '';
              try {
                let url = `/api/method/appv6.getProfileNoPermission?name=${erp.info.profile.copy_from}`;
                let response = await http2.request(url, {
                  method: 'GET',
                  serializer: 'json',
                  debug: true,
                });
                console.log('response', response);
                let profile_device = response.data.data.profile_device;
                let profile_subdevice = response.data.data.profile_subdevice;
                let profile_device_map = profile_device.find((item) => item.device_name == this.oldMac);
                if (this.updateSceneStatus) {
                  profile_device_map = profile_device.find((item) => item.device_model == 'YO780' || item.device_mode == 'RCU Controller');
                }
                if (profile_device_map) {
                  thisGuid = profile_device_map.device;
                }
                //pay attention, if have two rcu, this logic is wrong
                let rcuMap = profile_device.find((item) => item.device_model == 'YO780');
                if (rcuMap) {
                  this.oldRcuGuid = rcuMap.device;
                }
                console.log('thisGuid', thisGuid);
                mac = core_utils_get_mac_address_from_guid(thisGuid, true);
                console.log('mac', mac);
              } catch (e) {
                console.log('e', e);
              }
              resolve({
                mac: core_utils_get_mac_address_from_guid(thisGuid, true),
                guid: thisGuid,
              });
            });
          },
          replaceInJsonString(jsonStr, replaceMap) {
            const pattern = new RegExp(
              Object.keys(replaceMap)
                .map((key) =>
                  // 转义特殊正则字符
                  key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                )
                .join('|'),
              'g'
            );

            // 执行替换操作
            return jsonStr.replace(pattern, (match) => replaceMap[match]);
          },
          //update the trigger button
          updateTriggerButton() {
            return new Promise(async (resolve, reject) => {
              //show the device connet button
              let html = '';
              for (let i in this.updateSceneTriggerDeviceMap) {
                let this_mac = core_utils_get_mac_address_from_guid(i);
                let obj = this.getSubDeviceInfo(i);
                let room_name = obj.room_name;
                let sub_device_title = obj.title;
                let device_model = obj.device_model;
                if (device_model == 'YO780') {
                  continue;
                }
                this.updateSceneTriggerDeviceMap.postStatus = false;
                html += `<li class="manufacturing-steps manufacturing-step1" deviceName="${i}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">
                      <span class="device-title">${device_model}</span>
                      <span class="device-title">-</span>
                      <span class="device-title">${this_mac}</span>
                      <p>
                        <span class="room-title text-color-gray">${tran(room_name)}</span>
                        <span class="room-title text-color-gray">/</span>
                          <span class="room-title text-color-gray">${tran(sub_device_title)}</span>
                        </p>
                      <p class="error-log text-color-red">${this.updateSceneTriggerDeviceMap[i].errorLog ? this.updateSceneTriggerDeviceMap[i].errorLog : ''}</p>
                    </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>`;
              }
              // debugger
              this.deviceSheet = app.sheet.create({
                content: `
                <div class="sheet-modal" style="height:auto">
                  <div class="sheet-modal-inner">
                    <div class="swipe-handler"></div>
                    <div class="page-content" style="height:600px;">
                      <div class="list list-strong list-outline list-dividers-ios">
                        <ul class="manufacturing-steps-list">
                        ${html}
                        </ul>
                      </div>
                      <div class="block block-strong">
                        <p class="row">
                          <div class="col">
                            <div class="button button-raised button-fill button-save" func="retryUpdateTriggerButton">${_('Retry')}</div>
                          </div>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              `,
                on: {
                  closed: () => {
                    console.log('closed');
                  },
                },
                swipeToClose: true,
                push: true,
                backdrop: true,
              });
              this.deviceSheet.open();
              resolve(1);
            });
          },
          updateStep(device, type, error) {
            if (type == 0) {
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('i').removeClass('rotate-animation');
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('i').html('error');
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('.error-log').html(error);
            } else if (type == 1) {
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('i').removeClass('rotate-animation');
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('i').html('check');
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('.error-log').html('');
            } else if (type == 2) {
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('i').addClass('rotate-animation');
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('i').html('sync');
              $(`.manufacturing-steps-list li[deviceName="${device}"]`).find('.error-log').html('');
            }
          },
          updateSceneButtonWithBle() {
            return new Promise(async (resolve, reject) => {
              let thisPostStatus = true;
              let postError = '';
              for (let i in this.updateSceneTriggerDeviceMap) {
                let device_model = this.getSubDeviceInfo(i).device_model;
                if (device_model == 'YO780') {
                  continue;
                }
                if (this.updateSceneTriggerDeviceMap[i].postStatus) {
                  this.updateStep(i, 1);
                  continue;
                }
                this.updateStep(i, 2);
                let index = 1;

                let list = this.updateSceneTriggerDeviceMap[i].commandList;
                for (let j in list) {
                  try {
                    // debugger
                    await window.peripheral[i].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: list[j],
                      },
                    ]);
                    index++;
                    if (index == list.length) {
                      this.updateStep(i, 1);
                      this.updateSceneTriggerDeviceMap[i].postStatus = true;
                    }
                  } catch (error) {
                    console.log('error', error);
                    this.updateSceneTriggerDeviceMap[i].errorLog = erp.get_log_description(error);
                    this.updateStep(i, 0);
                    // app.dialog.alert(_(erp.get_log_description(error)));
                    thisPostStatus = false;
                    postError = error;
                  }
                }
              }
              if (thisPostStatus) {
                this.deviceSheet.close();
                resolve(1);
              } else {
                reject(postError);
              }
            });
          },
          getSubDeviceInfo(device) {
            //device is means guid
            let profile_subdevice = cloneDeep(erp.info.profile.profile_subdevice);
            let deviceMap = erp.info.device[device];
            let obj = {
              room_name: '',
              title: '',
              device_model: isset(deviceMap) ? deviceMap.device_model : '',
            };
            for (let i in profile_subdevice) {
              if (profile_subdevice[i].device == device) {
                obj.room_name = profile_subdevice[i].room_name;
                obj.title = profile_subdevice[i].title;
                break;
              }
            }
            return obj;
          },
          updateRcuSceneDeviceWithApi() {
            return new Promise(async (resolve, reject) => {
              let oldResolve = resolve;
              let oldReject = reject;
              let tips = `${_('Update Scene Configuration')}`;
              app.dialog.preloader(tips);
              // let toast = app.toast.create({
              //   text: tips,
              //   position: 'center',
              //   closeTimeout: 20000,
              // });
              // toast.open();
              // let url = `/api/method/appv6.updateSceneReplace`;
              let url = `/api/method/lincogn.iot.doctype.scene.scene.update_scene_device`;
              //let url = `https://frappe.cecgaming.com/api/method/lincogn.iot.doctype.device_replacement.update_scene`;
              // debugger;
              let postObj = {};
              let thisGateway = '';
              if (this.settingUserName) {
                thisGateway = `${core_utils_get_mac_address_from_guid(this.targetGuid)}-${this.settingUserName}`;
              }
              if (this.device_map_model == 'YO780') {
                //get the profile_device name
                postObj = {
                  'rcu_data': {
                    'profile': erp.info.profile.name,
                    'rcu_list': ['0346'],
                    'device_model': 'YO780',
                    'raw_device': isset(guid) && guid != 'undefined' && guid != '' ? guid : '',
                    'profile_device': this.profile_device_name,
                    'replace_device': this.targetGuid,
                    'replace_mac': core_utils_get_mac_address_from_guid(this.targetGuid).replace(/:/g, ''),
                    'replace_gateway': thisGateway,
                  },
                };
              } else {
                postObj = {
                  'button_data': {
                    'profile': erp.info.profile.name,
                    'hexid_list': ['0371', '0374', '0370', '0369', '0368', '0367', '0372', '0402', '0401', '037f', '037e', '037d','037e','037f','0401','0402','0406'],
                    'device_model': this.device_map_model,
                    'raw_device': isset(guid) && guid != 'undefined' && guid != '' ? guid : '',
                    'profile_device': this.profile_device_name,
                    'replace_device': this.targetGuid,
                    'replace_mac': core_utils_get_mac_address_from_guid(this.targetGuid).replace(/:/g, ''),
                    'replace_gateway': thisGateway,
                  },
                };
              }
              try {
                let response = await http2.request(url, {
                  method: 'POST',
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: postObj,
                });
                app.dialog.close();
                console.log('response', response);
                if(response.data.message){
                  if(response.data.message.error_count != 0){
                    //check if the error include the 'Deleted orphaned'
                    let operation_log = response.data.message.operation_log;
                    if(operation_log && operation_log.includes('Deleted orphaned')){
                      //repeat the update scene device
                      try{
                        let repeat_response = await this.updateRcuSceneDeviceWithApi();
                        if(repeat_response.data.message.error_count != 0){
                          oldReject(repeat_response.data._server_messages.substring(0,300)+'...');
                        }else{
                          oldResolve(repeat_response);
                        }
                      }catch(errors){
                        oldReject(errors);
                      }
                    }else if(operation_log == ""){
                      oldResolve(true);
                    }else{
                      reject(response.data._server_messages.substring(0,300)+'...');
                    }
                    return;
                  }
                }
                resolve(response);
              } catch (e) {
                app.dialog.close();
                reject(e);
              }
            });
          },
          //update the sync gateway list
          async updateSyncGatewayList() {
            //this case is: device is been replaced,should update the sync gateway list
            //check if have the gateway,and find the gateway topic
            let devices = cloneDeep(erp.info.profile.profile_device);
          },
          //update the google device list
          async updateGoogleDeviceList() {
            //this case can not update the google device list
          },
          async initDeviceNetwork() {
            let profile_device = cloneDeep(erp.info.profile.profile_device);
            let network_id = '';
            let network_position = '';
            profile_device.forEach((item) => {
              if (item.device == guid) {
                network_id = item.network_id;
                network_position = item.network_position;
                this.targetPosition = item.network_position;
              }
            });
            let thisList = [];
            //show the pre device and the next device
            if (network_id && guid) {
              let networkIdList = profile_device
                .filter((e) => e.network_id == network_id && e.network_id != 0)
                .sort((a, b) => {
                  return a.network_position - b.network_position;
                });
              this.networkCount = networkIdList.length;
              let headBytes = '';
              let tailBytes = '';
              //if network_position in leader or end
              if (network_position == 0) {
                headBytes = `8500010000000000000000000000`;
                tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position) + 1].device, true).toLowerCase()}0100000000`;
                if (networkIdList.length > 1) {
                  thisList.push(networkIdList[1]);
                }
              } else if (network_position == networkIdList.length - 1) {
                headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position) - 1].device, true).toLowerCase()}0000000000`;
                tailBytes = `8500010000000000000100000000`;
                thisList.push(networkIdList[network_position - 1]);
              } else {
                headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position) - 1].device, true).toLowerCase()}0000000000`;
                tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position) + 1].device, true).toLowerCase()}0100000000`;
                thisList.push(networkIdList[network_position - 1]);
                thisList.push(networkIdList[network_position + 1]);
              }
              this.targetNetworkCommandList = ['85000000', '850200', tailBytes, '850201', headBytes, '850200'];
            } else {
              thisList = [];
            }
            //show device info
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            thisList.forEach((item) => {
              if (item.device) {
                let guid = item.device;
                if (isset(peripheral[guid])) {
                  peripheral[guid].prop.password = item.password;
                  const hexid = guid.substring(guid.length - 6, guid.length - 2);
                  const model = erp.doctype.device_model[hexid.toUpperCase()];
                  if (!model && !model.image) {
                    item.image = model.image;
                  } else {
                    item.image = 'https://my.yoswit.com/files/products/YO2086-1G.svg';
                  }
                  //filter the room info
                  item.roomInfo = '';
                  subdevices.forEach((kitem) => {
                    if (kitem.device == item.device && kitem.device) {
                      item.roomInfo += `${tran(kitem.room_name)}-${tran(kitem.title)} `;
                    }
                  });
                }
              }
            });
            //this.deviceNetworkList = thisList;
            this.deviceNetworkList = [];
            console.log('this.deviceNetworkList', this.deviceNetworkList);
          },
          async updateDeviceNetwork() {
            let list = cloneDeep(this.deviceNetworkList);
            if (list.length) {
              app.dialog.preloader(_('Connecting...'));
              //push this device
              let count = 1;
              for (let i in list) {
                let network_position = list[i].network_position;
                let headBytes = '';
                let tailBytes = '';
                let this_guid = list[i].device;
                if (network_position == 0) {
                  headBytes = `8500010000000000000000000000`;
                  tailBytes = `850001${core_utils_get_mac_address_from_guid(this.targetGuid, true).toLowerCase()}0100000000`;
                } else if (network_position == this.networkCount - 1) {
                  headBytes = `850001${core_utils_get_mac_address_from_guid(this.targetGuid, true).toLowerCase()}0000000000`;
                  tailBytes = `8500010000000000000100000000`;
                } else {
                  //if < targetPosition,update tail,if > targetPosition ,update headBytes
                  if (network_position < this.targetPosition) {
                    tailBytes = `850001${core_utils_get_mac_address_from_guid(this.targetGuid, true).toLowerCase()}0100000000`;
                  } else {
                    headBytes = `850001${core_utils_get_mac_address_from_guid(this.targetGuid, true).toLowerCase()}0000000000`;
                  }
                }
                let meshCommands = ['85000000', '850200', tailBytes, '850201', headBytes, '850200'];
                let bleList = [];
                meshCommands.forEach((zitem) => {
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: zitem,
                  });
                });
                bleList.push({
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: '810e',
                });
                try {
                  console.log('bleList', bleList);
                  await peripheral[this_guid].write(bleList);
                  this.updateSelfNetwork();
                } catch (error) {
                  app.dialog.close();
                  app.dialog.alert(_(erp.get_log_description(error)));
                }
              }
            } else {
              // debugger;
              try {
                app.dialog.preloader(_('Updating...'));
                await peripheral[this.targetGuid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: '810e',
                  },
                ]);
                this.updateErpData();
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            }
          },
          async updateSelfNetwork() {
            //update target device
            let targetBleList = [];
            this.targetNetworkCommandList.forEach((zitem) => {
              targetBleList.push({
                service: 'ff80',
                characteristic: 'ff81',
                data: zitem,
              });
            });
            targetBleList.push({
              service: 'ff80',
              characteristic: 'ff81',
              data: '810e',
            });
            try {
              console.log('targetBleList', targetBleList);
              await peripheral[this.targetGuid].write(targetBleList);
              //this.blePostCommand.shift();
              //check if all status is true,next
              if (this.targetPairingCommandList.length) {
                for (let i in this.targetPairingCommandList) {
                  let command = this.targetPairingCommandList[i].command;
                  console.log('command', command);
                  let post_guid = this.targetPairingCommandList[i].guid;
                  console.log('guid', post_guid);
                  try {
                    await peripheral[post_guid].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: command,
                      },
                    ]);
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(_(erp.get_log_description(error)));
                  }
                }
              }
              this.updateErpData();
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          checkIsOnDeviceErp(){
            return new Promise(async(resolve, reject) => {
              if(isset(erp.info.device[this.targetGuid])){
                resolve(true);
              }else{
                let mac_address = core_utils_get_mac_address_from_guid(this.targetGuid);
                let this_firmware = peripheral[this.targetGuid].getProp().firmware;
                let model_name = this.device_map_model;
                let mode_name = this.device_map_mode;
                let device_batch = erp.doctype.device_batch[peripheral[this.targetGuid].getProp().hexBatch.toUpperCase()];
                let url = `/api/method/appv6.getOrUpdateDevice`;
                let method = 'POST';
                try{
                  let deviceData = await http2.request(url, {
                    method: method,
                    serializer: 'json',
                    debug: true,
                    data: {
                      'parent': erp.info.profile.name,
                      'guid': this.targetGuid,
                      'password': peripheral[this.targetGuid].getProp().password,
                      'device_mode': mode_name,
                      'mac_address': mac_address,
                      'device_model': model_name,
                      'batch': isset(device_batch) ? device_batch.batch_id : 'YO0012',
                      'firmware': isset(this_firmware) ? this_firmware : '----',
                      'settings': [],
                      'mac_address': mac_address,
                    },
                  });
                  resolve(true);
                }catch(error){
                  reject(error)
                }
              }
            });
          },
          async updateErpData() {
            // 清理之前可能存在的dialog
            this.clearAllDialogs();
            const sendRemoveCommand = ()=>{
              return new Promise(async(resolve, reject)=>{
                let oldResolve = resolve;
                let oldReject = reject;
                //check the mesh device is be replace and should send the command to the rcu and remove it
                if((this.thisModel.includes('M146') || this.thisModel.includes('M86')) && guid && guid != ''){
                  //send the command to the rcu and remove it
                  //find the rcu device
                  let rcu_guid = '';
                  let profile_device = cloneDeep(erp.info.profile.profile_device);
                  profile_device.forEach((item)=>{
                    if(item.device_model == 'YO780'){
                      rcu_guid = item.device;
                    }
                  })
                  if(rcu_guid){
                    //alert the user
                    //send the command to the rcu and remove it
                    let rcu_command = `02ffffffffffff11${core_utils_get_mac_address_from_guid(guid,true)}`;
                    try{
                      app.dialog.close();
                      app.dialog.preloader(_('Sending command to RCU...'));
                      await peripheral[rcu_guid].write([{
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: rcu_command,
                      }]);
                      app.dialog.close();
                      resolve();
                    }catch(error){
                      app.dialog.close();
                      if(error != 7200){
                        app.dialog.confirm(_('Please move closer to the RCU to facilitate the removal of unused devices from the mesh.'), async()=>{
                          await sendRemoveCommand();
                          oldResolve();
                        },()=>{
                          //do nothing
                          oldResolve(error);
                        })
                      }else{
                        oldResolve();
                      }
                    }
                  }
                }else{
                  resolve();
                }
              })
            }
            try{
              await sendRemoveCommand();
              debugger
            }catch(error){
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
            app.dialog.preloader(_('Updating, it may take about 1-2 minutes.'));
            let mac_address = core_utils_get_mac_address_from_guid(this.targetGuid);
            let this_firmware = peripheral[this.targetGuid].prop.firmware;
            //let device_hex_model = peripheral[guid].getProp().hexModel.toUpperCase();
            let model_name = this.device_map_model;
            let mode_name = this.device_map_mode;
            let device_batch = erp.doctype.device_batch[peripheral[this.targetGuid].getProp().hexBatch.toUpperCase()];

            //init device setting
            let settings = erp.info.device[guid ? guid : this.rawGuid] ? erp.info.device[guid ? guid : this.rawGuid].settings : [];
            settings.forEach((item) => {
              delete item.name;
            });
            let url = `/api/method/appv6.getOrUpdateDevice`;
            let method = 'POST';
            // debugger;
            console.log('device_model', model_name);
            try {
              let deviceData = await http2.request(url, {
                method: method,
                serializer: 'json',
                debug: true,
                data: {
                  'guid': this.targetGuid,
                  'password': peripheral[this.targetGuid].getProp().password,
                  'device_mode': mode_name,
                  'mac_address': mac_address,
                  'device_model': model_name,
                  'batch': isset(device_batch) ? device_batch.batch_id : 'YO0012',
                  'firmware': isset(this_firmware) ? this_firmware : '----',
                  'settings': this.updateSceneStatus ? erp.info.device[this.targetGuid].settings : settings,
                  'parent': erp.info.profile.name,
                  'profile_device_name': this.profile_device_name,
                  'old_guid': guid,
                  'device_name': mac_address.replace(/:/g, ''),
                  'gateway': this.gateway,
                  'sta_mac_address': this.sta_mac_address ? formatMAC(this.sta_mac_address) : '',
                  'ap_mac_address': this.ap_mac_address ? formatMAC(this.ap_mac_address) : '',
                  'lan_mac_address': this.lan_mac_address ? formatMAC(this.lan_mac_address) : '',
                },
              });
              if (this.isGateway) {
                this.toTab(4);
                return;
              }
              //if update the rcu, write 1 write
              if (this.updateSceneStatus) {
                await http2.request(`/api/resource/Profile/${erp.info.profile.name}`, {
                  method: 'PUT',
                  serializer: 'json',
                  debug: true,
                  data: {
                    'location': '1 write',
                  },
                });
              }
              //check if the profile is repalce
              // await http2.request(`/api/method/clear_profile_copy_from`, {
              //   method: 'POST',
              //   serializer: 'json',
              //   debug: true,
              //   data: {
              //     'profile': erp.info.profile.name,
              //   },
              // });
              await ha_profile_ready();
              this.clearAllDialogs();
              if(!this.updateSceneStatus){
                this.toDeviceRestart();
                return
              }
              app.dialog.confirm(`${_('Replace successfully,return?')}`, () => {
                window.globalUpdate = true;
                if(!this.updateSceneStatus){
                  window.peripheral[this.targetGuid].write([{
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: '810e',
                  }]);
                }
                mainView.router.back();
              });
            } catch (error) {
              this.clearAllDialogs();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          toDeviceRestart(){
            //check the bluetooth connect
            let isConnected = false;
            if(window.peripheral[this.targetGuid]){
              isConnected = window.peripheral[this.targetGuid].prop.connected;
            }
            debugger
            this.isConnected = isConnected;
            this.toTab(7);
          },
          async restartDevice(){
            //restart the device
            app.dialog.preloader(_('Restarting...'));
            try{
              window.peripheral[this.targetGuid].write([{
                service: 'ff80',
                characteristic: 'ff81',
                data: '810e',
              }]);
              await this.sleep(6000);
              this.isConnected = false;
              this.clearAllDialogs();
              app.dialog.confirm(`${_('Replace successfully,return?')}`, () => {
                window.globalUpdate = true;
                if(!this.updateSceneStatus){
                  window.peripheral[this.targetGuid].write([{
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: '810e',
                  }]);
                }
                mainView.router.back();
              });
            }catch(error){
              this.clearAllDialogs();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          sleep(time) {
            return new Promise((resolve) => {
              setTimeout(() => {
                resolve();
              }, time);
            });
          },
          async iotResetPasswordPeripheral(item) {
            console.log(item);
            let guid = item.guid;
            const mac = core_utils_get_mac_address_from_guid(guid, true);
            const byte = mac.match(/.{1,2}/g);
            const cmd = '880083' + byte[3] + byte[0] + '543e15';
            const promisifyWrite = (device_id, service_uuid, characteristic_uuid, data) => {
              return new Promise((resolve, reject) => {
                ble.write(
                  device_id,
                  service_uuid,
                  characteristic_uuid,
                  data.convertToBytes(),
                  () => {
                    resolve();
                  },
                  (error) => {
                    if (data === '810e') {
                      resolve();
                    } else {
                      reject(error);
                    }
                  }
                );
              });
            };
            const promisifyConnect = (device_id) => {
              return new Promise((resolve, reject) => {
                ble.connect(
                  device_id,
                  () => {
                    resolve();
                  },
                  (error) => {
                    reject(error);
                  }
                );
              });
            };

            const promisifyDisconnect = (device_id) => {
              return new Promise((resolve, reject) => {
                ble.disconnect(
                  device_id,
                  () => {
                    resolve();
                  },
                  (error) => {
                    reject(error);
                  }
                );
              });
            };
            const sleep = (time) => {
              return new Promise((resolve) => {
                setTimeout(() => {
                  resolve();
                }, time);
              });
            };
            app.dialog.confirm(
              _('Reset Password?'),
              async () => {
                try {
                  app.preloader.show();
                  const periperal = window.peripheral[guid].prop;

                  await promisifyConnect(periperal.id);
                  await promisifyWrite(periperal.id, 'ff80', 'ff81', cmd);
                  // ble.startNotification(periperal.id, 'ff80', 'ff82');
                  await promisifyDisconnect(periperal.id);

                  await sleep(2000);

                  await promisifyConnect(periperal.id);

                  await promisifyWrite(periperal.id, 'ff80', 'ff81', '812700');
                  // await promisifyWrite(periperal.id, 'ff80', 'ff81', '810e');

                  // 88ff00aa77
                  // 8e01

                  app.preloader.hide();
                  app.dialog.alert(_('Reset Success!'));
                } catch (err) {
                  app.preloader.hide();
                  app.dialog.alert(_('Reset fail: ') + JSON.stringify(err));
                }
              },
              () => {}
            );
          },
          getNetworkId() {
            //get the network id
            let network_id = '';
            let network_position = '';
            let profile_device = cloneDeep(erp.info.profile.profile_device);
            profile_device.forEach((item) => {
              if (item.name == this.profile_device_name) {
                network_id = item.network_id;
                network_position = item.network_position;
              }
            });
            return { network_id, network_position };
          },
          // mesh tool function
          async initMeshNetwork() {
            let needMeshNetwork = false;
            let newMeshNetwork = false;
            //get the mesh config
            try {
              this.meshConfig = JSON.parse(erp.info.profile.mesh_config);
              if (!isset(this.meshConfig.networks)) {
                this.meshConfig = { networks: {} };
                if (isset(this.meshConfig.meshUUID)) {
                  this.meshConfig.networks[this.meshConfig.meshUUID] = this.meshConfig;
                } else {
                  newMeshNetwork = true;
                }
              }
            } catch (error) {
              this.meshConfig = { networks: {} };
              newMeshNetwork = true;
            }
            //get the mesh network id
            let { network_id, network_position } = this.getNetworkId();
            if (network_id && network_id > 100) {
              //this is the mesh network
              let actNetwork = parseInt(network_id) - 100;
              this.meshNetworkName = _('Mesh Network ' + actNetwork);

              needMeshNetwork = true;
              //check if the profile is the new profile
              if (newMeshNetwork) {
                this.meshNetworkName = _('New Mesh Network');
                console.log('ble.createNetwork');
                const provisionerUUid = generateUUIDv4();
                console.log('provisionerUUid=' + provisionerUUid);
                const newNetworkConfig = `{
                        	"$schema": "http://json-schema.org/draft-04/schema#",
                        	"id": "https://www.bluetooth.com/specifications/specs/mesh-cdb-1-0-1-schema.json#",
                        	"version": "1.0.1",
                        	"meshUUID": "${generateUUIDv4()}",
                        	"meshName": "nRF Mesh Network",
                        	"timestamp": "${getCurrentISOFormat()}",
                        	"partial": false,
                        	"netKeys": [
                        		{
                        			"name": "Network Key 1",
                        			"index": 0,
                        			"key": "${generateMeshKey()}",
                        			"phase": 0,
                        			"minSecurity": "secure",
                        			"timestamp": "${getCurrentISOFormat()}"
                        		}
                        	],
                        	"appKeys": [
                        		{
                        			"name": "Application Key 1",
                        			"index": 0,
                        			"boundNetKey": 0,
                        			"key": "${generateMeshKey()}"
                        		}
                        	],
                        	"provisioners": [
                        		{
                        			"provisionerName": "nRF Mesh Provisioner",
                        			"UUID": "${provisionerUUid}",
                        			"allocatedUnicastRange": [
                        				{
                        					"lowAddress": "0001",
                        					"highAddress": "199A"
                        				}
                        			],
                        			"allocatedGroupRange": [
                        				{
                        					"lowAddress": "C000",
                        					"highAddress": "CC9A"
                        				}
                        			],
                        			"allocatedSceneRange": [
                        				{
                        					"firstScene": "0001",
                        					"lastScene": "3333"
                        				}
                        			]
                        		}
                        	],
                        	"nodes": [
                        		{
                        			"UUID": "${provisionerUUid}",
                        			"name": "nRF Mesh Provisioner",
                        			"deviceKey": "${generateMeshKey()}",
                        			"unicastAddress": "0001",
                        			"security": "insecure",
                        			"configComplete": false,
                              "cid":"004C",
                              "configComplete":true,
                              "crpl":"7FFF",
                        			"features": {
                        				"friend": 2,
                        				"lowPower": 2,
                        				"proxy": 2,
                        				"relay": 2
                        			},
                        			"defaultTTL": 5,
                        			"netKeys": [
                        				{
                        					"index": 0,
                        					"updated": false
                        				}
                        			],
                        			"appKeys": [],
                        			"elements": [
                        				{
                        					"name": "Element: 0x0001",
                        					"index": 0,
                        					"location": "0000",
                        					"models": [
                        						{
                        							"modelId": "0001",
                        							"bind": [],
                        							"subscribe": []
                        						}
                        					]
                        				}
                        			],
                        			"excluded": false
                        		}
                        	],
                        	"groups": [],
                        	"scenes": [],
                        	"networkExclusions": []
                        }`;
                console.log('newNetworkConfig=' + newNetworkConfig);
                let iot_setmesh_scan_count = 0;
                this.appKey = 'New Key';
                ble.importNetwork(
                  newNetworkConfig,
                  () => {
                    console.log('ble.importNetwork successfully');
                    bleManager.scan(async (p) => {
                      if (p.id == window.peripheral[this.targetGuid].getProp().id) {
                        iot_setmesh_scan_count++;
                        if (iot_setmesh_scan_count >= 6) {
                          await bleManager.stopScan();
                          bleManager.clear();
                        }
                      }
                    });
                  },
                  (err) => {
                    console.log('ble.importNetwork error=' + err);
                  }
                );
              } else {
                console.log('ble.importNetwork--exist');
                //get the networks key
                let network_key = Object.keys(this.meshConfig.networks)[actNetwork - 1];
                this.appKey = this.meshConfig.networks[network_key].appKeys[0].key;
                let nodearray = [];
                let nodedetail = {};
                for (let nnn in this.meshConfig.networks[network_key].nodes) {
                  const node = this.meshConfig.networks[network_key].nodes[nnn];
                  console.log(JSON.stringify(node));
                  if (!isset(nodedetail[node.UUID])) nodearray.push(node.UUID);
                  nodedetail[node.UUID] = node;
                }
                let newnodearray = [];
                for (let nnn in nodearray) {
                  newnodearray.push(nodedetail[nodearray[nnn]]);
                }
                this.meshConfig.networks[network_key].nodes = newnodearray;
                let iot_setmesh_scan_count = 0;
                ble.importNetwork(
                  JSON.stringify(this.meshConfig.networks[network_key]),
                  () => {
                    console.log('ble.importNetwork successfully');
                    bleManager.scan(async (p) => {
                      if (p.id == window.peripheral[this.targetGuid].getProp().id) {
                        iot_setmesh_scan_count++;
                        if (iot_setmesh_scan_count >= 6) {
                          await bleManager.stopScan();
                          bleManager.clear();
                        }
                      }
                    });
                  },
                  (error) => {
                    console.log('ble.importNetwork error=' + error);
                  }
                );
              }
            } else {
              //can not mesh network
              needMeshNetwork = false;
            }
            return needMeshNetwork;
          },
          async iotSetMeshIdentify() {
            console.log('iotSetMeshIdentify');
            
            // 检查重试次数限制
            if (this.retryCount >= this.maxRetryCount) {
              this.clearAllDialogs();
              app.dialog.alert(_('Maximum retry attempts reached, please try again later or contact technical support'));
              return;
            }
            
            // 清除之前的定时器、监听器和toast
            this.clearAllTimers();
            this.clearEventListeners();
            this.clearAllToasts();
            
            //should disconnect all the devices
            try {
              // 避免重复显示断开连接的 preloader
              if (!this.isDisconnectingDevices) {
                this.isDisconnectingDevices = true;
                app.dialog.preloader(_('Disconnecting other devices.'));
                
                // 添加超时保护，确保断开连接不会无限等待
                const disconnectPromises = [];
                for (let device in window.peripheral) {
                  if (window.peripheral[device].getProp().connected) {
                    const disconnectPromise = Promise.race([
                      window.peripheral[device].disconnect(),
                      new Promise((resolve) => setTimeout(() => resolve('timeout'), 5000)) // 5秒超时
                    ]).catch(error => {
                      console.log('disconnect error for device ' + device + ':', error);
                      return 'error'; // 返回错误标识而不是抛出异常
                    });
                    disconnectPromises.push(disconnectPromise);
                  }
                }
                
                // 等待所有断开连接完成或超时
                await Promise.all(disconnectPromises);
                
                // 重置状态并确保关闭 preloader
                this.isDisconnectingDevices = false;
                this.clearAllDialogs();
              } else {
                console.log('Already disconnecting devices, skipping...');
                // 如果已经在断开连接过程中，等待一下再继续
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
            } catch (error) {
              console.log('disconnect process error=' + error);
              // 发生任何错误都要重置状态并确保关闭 preloader
              this.isDisconnectingDevices = false;
              this.clearAllDialogs();
            }
            
            //set timer
            erp.replaceIdentifyTimer = setTimeout(async () => {
              this.clearAllDialogs();
              app.dialog.confirm(
                _('Mesh timeout failed, reset and retry?') + ' (' + _('Remaining attempts') + ': ' + (this.maxRetryCount - this.retryCount) + ')',
                async () => {
                  try {
                    // 在重试前清除所有定时器
                    this.clearAllTimers();
                    this.clearEventListeners();
                    this.initMeshNetwork();
                    this.retryCount++;
                    this.iotSetMeshIdentify();
                  } catch (error) {
                    this.clearAllDialogs();
                    app.dialog.alert(_(erp.get_log_description(error)));
                  }
                },
                () => {
                  this.retryCount = 0; // 重置重试计数
                  // 取消重试时也要清除定时器
                  this.clearAllTimers();
                }
              );
            }, 150000);
            
            try {
              setmesh_produce_timer = null;
            } catch (error) {
              this.clearAllTimers();
              this.clearAllDialogs();
              app.dialog.alert(_(erp.get_log_description(error)));
              return;
            }
            
            try {
              app.dialog.preloader(_('Restarting, this will take about 2 minutes.'));
              await window.peripheral[this.targetGuid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: '8110',
                },
              ]);
              
              window.peripheral[this.targetGuid].getProp().password = '000000';
              await this.sleep(15000);
              app.dialog.close();
              app.dialog.preloader(_('Identifying, this will take about 2 minute.'));
              await window.peripheral[this.targetGuid].identify();
              this.identifyNotify();
            } catch (error) {
              this.clearAllDialogs();
              this.clearAllTimers();
              
              console.log('iotSetMeshIdentify error=' + error);
              let text = _('Identification failed, retry?') + ' (' + _('Remaining attempts') + ': ' + (this.maxRetryCount - this.retryCount) + ')';
              
              try {
                if (error.includes('The bearer is closed.') && this.retryCount > 0) {
                  text = _(
                    'Mesh failed, you need to disconnect Bluetooth in phone settings, then turn it back on, try restarting the app and retry, confirm to continue?'
                  );
                }
              } catch (err) {
                if (err == 7200) {
                  text = _('Unable to connect to device, incorrect password, please reset password and retry.');
                }
                console.log(typeof error);
              }
              
              if (this.retryCount < this.maxRetryCount) {
                app.dialog.confirm(
                  text,
                  async () => {
                    try {
                      this.retryCount++;
                      // 在重试前清除所有定时器
                      this.clearAllTimers();
                      this.clearEventListeners();
                      this.initMeshNetwork();
                      this.iotSetMeshIdentify();
                    } catch (error) {
                      this.clearAllDialogs();
                      app.dialog.alert(_(erp.get_log_description(error)));
                    }
                  },
                  () => {
                    this.retryCount = 0; // 重置重试计数
                    // 取消重试时也要清除定时器
                    this.clearAllTimers();
                  }
                );
              } else {
                app.dialog.alert(_('Maximum retry attempts reached, please try again later or contact technical support'));
                this.retryCount = 0;
                // 达到最大重试次数时清除所有资源
                this.clearAllTimers();
              }
            }
          },
          // 新增：初始化监听器函数（避免重复定义）
          initializeListeners() {
            // 只在第一次调用时定义监听器函数
            if (!this.identifyListenerFun) {
              this.identifyListenerFun = (rs) => {
                console.log('identifyListenerFun received=', rs);
                
                if (rs.code == 200) {
                  console.log('Identification successful, clearing timer');
                  // 收到成功响应，清除4秒超时定时器
                  if (this.identifyTimer) {
                    clearTimeout(this.identifyTimer);
                    this.identifyTimer = null;
                  }
                  if (!this.emmitStatus) {
                    this.clearAllDialogs();
                    this.iotSetMeshProvisioning();
                  }
                  this.emmitStatus = true;
                } else if (rs.code == 7300) {
                  console.log('Identification failed with code 7300, clearing timer');
                  // 收到失败响应，清除4秒超时定时器并处理重试
                  if (this.identifyTimer) {
                    clearTimeout(this.identifyTimer);
                    this.identifyTimer = null;
                  }
                  this.clearAllDialogs();
                  
                  if (this.retryCount < this.maxRetryCount) {
                    app.dialog.confirm(
                      _('Identification failed, retry?') + ' (' + _('Remaining attempts') + ': ' + (this.maxRetryCount - this.retryCount) + ')',
                      async () => {
                        try {
                          // 在重试前清除所有定时器
                          this.clearAllTimers();
                          this.clearEventListeners();
                          this.retryCount++;
                          this.iotSetMeshIdentify();
                        } catch (error) {
                          this.clearAllDialogs();
                          app.dialog.alert(_(erp.get_log_description(error)));
                        }
                      },
                      () => {
                        this.retryCount = 0;
                        // 取消重试时也要清除定时器
                        this.clearAllTimers();
                      }
                    );
                  } else {
                    app.dialog.alert(_('Maximum retry attempts reached, please try again later or contact technical support'));
                    this.retryCount = 0;
                    // 达到最大重试次数时清除所有资源
                    this.clearAllTimers();
                  }
                } else {
                  // 收到其他未知响应码，记录日志但保持定时器继续运行
                  console.log('Received unexpected code:', rs.code, 'keeping timeout timer active');
                }
              };
            }
            
            // 初始化gateway监听器函数
            if (!this.gatewayListenerFun) {
              this.gatewayListenerFun = (data) => {
                if (data.code == 1) {
                  app.dialog.confirm(`${_('Replace successfully,return?')}`, () => {
                    window.globalUpdate = true;
                    mainView.router.back();
                  });
                }
              };
            }
          },
          
          async identifyNotify() {
            console.log('identifyNotify started');
            this.emmitStatus = false;
            
            // 清除可能存在的旧定时器
            if (this.identifyTimer) {
              console.log('Clearing existing identify timer');
              clearTimeout(this.identifyTimer);
              this.identifyTimer = null;
            }
            
            // 确保监听器函数已初始化
            this.initializeListeners();
            
            this.clearEventListeners(); // 确保清除之前的监听器
            console.log('Registering mesh/identify listener');
            emitter.on('mesh/identify', this.identifyListenerFun);
            
            // 在注册监听器后立即设置4秒超时定时器，无论是否收到事件
            console.log('Setting 4000ms timeout timer immediately after registering listener');
            this.identifyTimer = setTimeout(() => {
              console.log('4000ms timeout triggered - no response received');
              this.clearAllDialogs();
              
              if (this.retryCount < this.maxRetryCount) {
                app.dialog.confirm(
                  _('Identification timeout (no response), retry?') + ' (' + _('Remaining attempts') + ': ' + (this.maxRetryCount - this.retryCount) + ')',
                  async () => {
                    try {
                      this.clearAllTimers();
                      this.clearEventListeners();
                      this.retryCount++;
                      this.iotSetMeshIdentify();
                    } catch (error) {
                      this.clearAllDialogs();
                      app.dialog.alert(_(erp.get_log_description(error)));
                    }
                  },
                  () => {
                    this.retryCount = 0;
                    this.clearAllTimers();
                  }
                );
              } else {
                app.dialog.alert(_('Maximum retry attempts reached, please try again later or contact technical support'));
                this.retryCount = 0;
                this.clearAllTimers();
              }
              this.identifyTimer = null;
            }, 4000);
          },
          async iotSetMeshProvisioning() {
            console.log('iotSetMeshProvisioning');
            this.clearAllDialogs();
            app.dialog.preloader(_('Provisioning, this will take about 2 minutes.'));
            
            try {
              let uuid = window.peripheral[this.targetGuid].getProp().id;
              await ble.startProvisioning(
                uuid,
                0,
                async (rs) => {
                  console.log('ble.startProvisioning success=' + JSON.stringify(rs));
                  rs = JSON.parse(rs);
                  this.meshConfig.networks[rs.meshUUID] = rs;
                  
                  this.clearAllDialogs();
                  this.clearOtherTimers(); // 只清除其他定时器，保护identify的4000ms超时
                  
                  await http.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
                    method: 'PUT',
                    serializer: 'json',
                    data: {
                      mesh_config: JSON.stringify(this.meshConfig),
                    },
                  });
                  
                  this.meshComplete = true;
                  this.retryCount = 0; // 成功后重置重试计数
                  
                  if (!this.toast) {
                    this.toast = app.toast.create({
                      text: _('Mesh Successfully!'),
                      position: 'center',
                      closeTimeout: 2000,
                    });
                  }
                  this.toast.open();
                  this.initSettingList({ guid: guid });
                  this.toTab(3);
                  this.clearEventListeners();
                },
                (error) => {
                  this.clearAllDialogs();
                  // 在 reject 时清除所有定时器
                  this.clearAllTimers();
                  this.clearEventListeners(); // 错误时也要清除监听器
                  console.log('Provisioning', error);
                  
                  if (this.retryCount < this.maxRetryCount) {
                    app.dialog.confirm(
                      _('Configuration failed, retry?') + ' (' + _('Remaining attempts') + ': ' + (this.maxRetryCount - this.retryCount) + ')',
                      async () => {
                        this.retryCount++;
                        this.iotSetMeshIdentify();
                      },
                      () => {
                        this.retryCount = 0;
                        // 取消重试时也要清除定时器
                        this.clearAllTimers();
                      }
                    );
                  } else {
                    app.dialog.alert(_('Maximum retry attempts reached, please try again later or contact technical support'));
                    this.retryCount = 0;
                    // 达到最大重试次数时清除所有资源
                    this.clearAllTimers();
                  }
                }
              );
            } catch (error) {
              this.clearAllDialogs();
              // 在 catch 时清除所有定时器
              this.clearAllTimers();
              this.clearEventListeners(); // catch块中也要清除监听器
              console.log('iotSetMeshProvisioning error=' + error);
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          //check if mesh is complete
          checkMeshComplete() {
            if (this.meshComplete) {
              // this.updateDeviceNetwork();
              this.initSettingList({ guid: guid });
              this.toTab(3);
            } else {
              if (this.networkType == 2) {
                app.dialog.confirm(
                  `${_('The mesh is not yet complete. Do you confirm to skip this step?')}`,
                  () => {
                    this.initSettingList({ guid: guid });
                    this.toTab(3);
                  },
                  () => {}
                );
              } else {
                //this.updateDeviceNetwork();
                this.initSettingList({ guid: guid });
                this.toTab(3);
              }
            }
          },
          updateStatusFun(status) {
            if (status) {
              this.toTab(5);
            } else {
              //warnning
              app.dialog.confirm(
                `${_('Firmware upgrade failed, would you want to retry?')}`,
                () => {
                  this.startFirmwareUpgrade();
                },
                () => {
                  this.toTab(5);
                }
              );
            }
          },
          // 新增：统一的preloader清除方法
          clearAllDialogs() {
            try {
              // 强制关闭所有可能的对话框
              for (let i = 0; i < 10; i++) {
                try {
                  app.dialog.close();
                } catch (e) {
                  // 忽略关闭失败的错误
                }
              }
              
              // 额外保险：直接操作DOM移除preloader元素
              try {
                const preloaders = document.querySelectorAll('.preloader-backdrop, .dialog-backdrop');
                preloaders.forEach(el => {
                  if (el && el.parentNode) {
                    el.parentNode.removeChild(el);
                  }
                });
              } catch (e) {
                console.log('DOM preloader cleanup error:', e);
              }
            } catch (error) {
              console.log('clearAllDialogs error:', error);
            }
          },
          
                     // 新增：清除所有定时器
           clearAllTimers() {
             if (this.identifyTimer) {
               clearTimeout(this.identifyTimer);
               this.identifyTimer = null;
             }
             if (erp.replaceIdentifyTimer) {
               clearTimeout(erp.replaceIdentifyTimer);
               erp.replaceIdentifyTimer = null;
             }
             if (typeof setmesh_produce_timer !== 'undefined' && setmesh_produce_timer) {
               clearTimeout(setmesh_produce_timer);
               setmesh_produce_timer = null;
             }
           },
           
           // 新增：清除非identify定时器（保护4000ms超时）
           clearOtherTimers() {
             if (erp.replaceIdentifyTimer) {
               clearTimeout(erp.replaceIdentifyTimer);
               erp.replaceIdentifyTimer = null;
             }
             if (typeof setmesh_produce_timer !== 'undefined' && setmesh_produce_timer) {
               clearTimeout(setmesh_produce_timer);
               setmesh_produce_timer = null;
             }
           },
           
           // 新增：清除所有Toast
           clearAllToasts() {
             if (this.settingToast) {
               this.settingToast.close();
               this.settingToast = null;
             }
             if (this.toast) {
               this.toast.close();
               this.toast = null;
             }
           },
          
                     // 新增：清除事件监听器
           clearEventListeners() {
             if (this.identifyListenerFun) {
               console.log('off mesh/identify');
               emitter.off('mesh/identify', this.identifyListenerFun);
               // 注意：不要设置为null，保持函数引用以便重用
             }
             if (this._getWifiMacAddressFun) {
               emitter.off(`wifi_mac_address`, this._getWifiMacAddressFun);
               this._getWifiMacAddressFun = null;
             }
             if (this.gatewayListenerFun) {
               emitter.off('gateway/sync', this.gatewayListenerFun);
               // 注意：不要设置为null，保持函数引用以便重用
             }
           },
           
           // 新增：全面清理方法
           cleanupAll() {
             this.clearAllDialogs();
             this.clearAllTimers();
             this.clearAllToasts();
             this.clearEventListeners();
             
             // 在组件销毁时，完全清理所有监听器引用
             if (this.identifyListenerFun) {
               emitter.off('mesh/identify', this.identifyListenerFun);
               this.identifyListenerFun = null;
             }
             if (this._getWifiMacAddressFun) {
               emitter.off(`wifi_mac_address`, this._getWifiMacAddressFun);
               this._getWifiMacAddressFun = null;
             }
             if (this.gatewayListenerFun) {
               emitter.off('gateway/sync', this.gatewayListenerFun);
               this.gatewayListenerFun = null;
             }
             
             // 重置重试计数和状态标志
             this.retryCount = 0;
             this.bleCommandRetryCount = 0;
             this.isDisconnectingDevices = false;
           },
        },
        computed: {},
        beforeDestroy() {
          // 使用全面的清理方法
          this.cleanupAll();
        },
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  .empty-box + .list ul::before,
  .empty-box + .list ul::after {
    content: none;
  }
  .toolbar-inner .button {
    min-width: 110px;
    border-radius: inherit;
  }
  .rotate-animation {
    animation: rotate 2s linear infinite;
    display: inline-block; /* 确保transform生效 */
  }
  .rotate-animation.paused {
    animation: none;
  }

  /* HTML: <div class="loader"></div> */
  .loader {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    aspect-ratio: 1;
    border-radius: 50%;
    background:
      radial-gradient(farthest-side, #ffa516 94%, #0000) top/8px 8px no-repeat,
      conic-gradient(#0000 30%, #ffa516);
    -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
    mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
    animation: l13 1s infinite linear;
  }

  @keyframes l13 {
    100% {
      transform: rotate(1turn);
    }
  }
</style>
