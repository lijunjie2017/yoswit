<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">${titleDiv}</div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="top-status">
          <div
            class="top-item"
            :class="{ danger: !wifiConnected }"
            v-on:click="toggleOffline"
            :aria-label="wifiConnected ? _('WiFi connected') : _('WiFi disconnected')"
          >
            <i class="icon f7-icons">{{ wifiConnected ? 'wifi' : 'wifi_slash' }}</i>
          </div>
          <div
            class="top-item"
            :class="{ muted: !btConnected }"
            v-on:click="toggleBt"
            :aria-label="btConnected ? _('Bluetooth connected') : _('Bluetooth disconnected')"
          >
            <i class="material-icons">{{ btConnected ? 'bluetooth' : 'bluetooth_disabled' }}</i>
          </div>
        </div>
        <div class="device-header">
          <div class="status" :class="{ offline: isOffline }" v-if="showStatus">
            {{ deviceType == 1 ? _('Smart Water Heater ')+_('Disconnected') : _('Hob Disconnected') }}
          </div>
        </div>
        <div class="dial-card card" v-if="deviceType == 1">
          <div class="card-content card-content-padding">
            <div class="section prefs">
              <div class="prefs-header">
                <div class="label">{{ _('Preferred Temperature') }}</div>
                <a class="mini-btn" v-on:click="saveFavorite" :aria-label="_('Add')">
                  <i class="icon f7-icons">plus</i>
                </a>
              </div>
              <div class="favorite-list" v-if="favorites.length">
                <a
                  class="fav-btn"
                  v-for="(t,i) in favorites"
                  :key="t"
                  v-on:click="onFavoriteClick(t)"
                  v-on:mousedown="onFavoritePressStart(i)"
                  v-on:touchstart="onFavoritePressStart(i)"
                  v-on:mouseup="onFavoritePressEnd"
                  v-on:mouseleave="onFavoritePressEnd"
                  v-on:touchend="onFavoritePressEnd"
                  v-on:touchcancel="onFavoritePressEnd"
                >
                  {{ t }}°C
                </a>
              </div>
            </div>
            <div class="dial-wrap">
              <svg
                ref="dialSvg"
                :width="svgWidth"
                :height="svgHeight"
                viewBox="0 0 320 200"
                v-on:mousedown="startDrag"
                v-on:touchstart="startDrag"
                v-on:pointerdown="startDrag"
                class="dial-svg"
              >
                <!-- 半圆轨道（静态） -->
                <defs>
                  <linearGradient id="dialGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#56CCF2" />
                    <stop offset="50%" stop-color="#6FCF97" />
                    <stop offset="100%" stop-color="#F2994A" />
                  </linearGradient>
                </defs>
                <path ref="trackPath" class="dial-track" d="M40 160 A120 120 0 0 1 280 160" />
                <!-- 进度弧线（动态Dash） -->
                <path
                  ref="progressPath"
                  class="dial-progress"
                  d="M40 160 A120 120 0 0 1 280 160"
                  :style="{ strokeDasharray: dashArray, strokeDashoffset: dashOffset }"
                />

                <!-- 大号命中环：沿弧线的交互带，提升安卓拖拽命中率 -->
                <path
                  class="dial-hit-arc"
                  d="M40 160 A120 120 0 0 1 280 160"
                  v-on:pointerdown="startDrag"
                  v-on:mousedown="startDrag"
                  v-on:touchstart="startDrag"
                />

                <!-- 半圆内部命中区：扩大内侧显示区域的触控范围 -->
                <path
                  class="dial-hit-area"
                  d="M40 160 A120 120 0 0 1 280 160 L160 160 Z"
                  v-on:pointerdown="startDrag"
                  v-on:mousedown="startDrag"
                  v-on:touchstart="startDrag"
                />

                <!-- 刻度与标记 -->
                <g class="ticks">
                  <line x1="40" y1="160" x2="48" y2="160" class="tick" />
                  <line x1="160" y1="40" x2="160" y2="56" class="tick" />
                  <line x1="280" y1="160" x2="272" y2="160" class="tick" />
                  <text x="44" y="178" class="tick-label">{{ minTemp }}</text>
                  <text x="152" y="28" class="tick-label">{{ midTemp }}</text>
                  <text x="268" y="178" class="tick-label">{{ maxTemp }}</text>
                </g>

                <!-- 拖拽圆点 -->
                <circle class="dial-knob" :cx="knobX" :cy="knobY" r="12" />
                <!-- 扩大可点击区域，提升再次拖拽命中率 -->
                <circle
                  class="dial-knob-hit"
                  :cx="knobX"
                  :cy="knobY"
                  r="44"
                  v-on:mousedown="startDrag"
                  v-on:touchstart="startDrag"
                  v-on:pointerdown="startDrag"
                />
              </svg>
              <div class="dial-center">
                <div class="value">{{ displayTemp }}°C</div>
              </div>
            </div>

            <div class="controls-grid">
              <div class="grid-col">
                <a
                  class="control-pill"
                  v-on:click="stepDown"
                  v-on:mousedown="pressStart($event, 'down')"
                  v-on:touchstart="pressStart($event, 'down')"
                  v-on:mouseup="pressEnd"
                  v-on:mouseleave="pressEnd"
                  v-on:touchend="pressEnd"
                  v-on:touchcancel="pressEnd"
                >
                  <i class="icon f7-icons">chevron_down</i>
                </a>
              </div>
              <div class="grid-col center-col">
                <a class="control-circle power" v-on:click="togglePower">
                  <i class="icon f7-icons">power</i>
                </a>
              </div>
              <div class="grid-col">
                <a
                  class="control-pill"
                  v-on:click="stepUp"
                  v-on:mousedown="pressStart($event, 'up')"
                  v-on:touchstart="pressStart($event, 'up')"
                  v-on:mouseup="pressEnd"
                  v-on:mouseleave="pressEnd"
                  v-on:touchend="pressEnd"
                  v-on:touchcancel="pressEnd"
                >
                  <i class="icon f7-icons">chevron_up</i>
                </a>
              </div>
            </div>

            <div class="secondary-actions" style="margin-top: 25px; margin-bottom: 25px">
              <a class="chip action" :class="{ active: isFavorite }" v-on:click="toggleFavorite">
                <i class="icon f7-icons">heart</i>
                <span>{{ _('Favorite') }}</span>
              </a>
              <a class="chip action" v-on:click="mobileOverride">
                <i class="icon f7-icons">bolt</i>
                <span>{{ _('Mobile Override') }}</span>
              </a>
            </div>

            <div class="tertiary-actions">
              <a class="tertiary-circle" v-on:click="() => app.dialog.alert(_('Coming Soon'))">
                <i class="material-icons">eco</i>
              </a>
              <a class="tertiary-circle" v-on:click="() => app.dialog.alert(_('Coming Soon'))">
                <i class="icon f7-icons">arrow_2_circlepath</i>
              </a>
              <a class="tertiary-circle" v-on:click="toggleChart">
                <i class="material-icons">bar_chart</i>
              </a>
            </div>
          </div>
        </div>

        <div class="dial-card card" v-if="deviceType == 2">
          <div class="card-content card-content-padding">
            <div class="hob-header">
              <div class="hob-label left"><i class="icon f7-icons">flame</i> {{ _('Left Burner') }}</div>
              <div class="hob-label right"><i class="icon f7-icons">flame</i> {{ _('Right Burner') }}</div>
            </div>
            <div class="hob-surface side">
              <div
                class="burner left"
                :class="{ on: leftBurnerOn, igniting: leftIgniting, extinguish: leftExtinguishing }"
                :style="{ '--flame-scale': flameScale('left') }"
                v-on:click.self="toggleBurner('left')"
              >
                <div class="stove-base"></div>
                <div class="nozzle"></div>
                <div class="flame-side">
                  <span class="tongue t1"></span>
                  <span class="tongue t2"></span>
                  <span class="tongue t3"></span>
                  <span class="glow"></span>
                </div>
                <div class="sparks"><i></i><i></i><i></i></div>
              </div>
              <div
                class="burner right"
                :class="{ on: rightBurnerOn, igniting: rightIgniting, extinguish: rightExtinguishing }"
                :style="{ '--flame-scale': flameScale('right') }"
                v-on:click.self="toggleBurner('right')"
              >
                <div class="stove-base"></div>
                <div class="nozzle"></div>
                <div class="flame-side">
                  <span class="tongue t1"></span>
                  <span class="tongue t2"></span>
                  <span class="tongue t3"></span>
                  <span class="glow"></span>
                </div>
                <div class="sparks"><i></i><i></i><i></i></div>
              </div>
              <!-- 品牌徽标（位于中间下方） -->
              <div class="hob-brand" v-on:click="editBrand">{{ brandName }}</div>
            </div>
            <div class="hob-knobs">
              <div class="knob-ctrl">
                <div class="knob" :style="{ '--arc': knobArc('left') }">
                  <div class="knob-face">
                    <div class="gauge-arc"></div>
                    <div class="gauge-ticks">
                      <i class="t0"></i><i class="t1"></i><i class="t2"></i><i class="t3"></i><i class="t4"></i><i class="t5"></i>
                    </div>
                    <div class="rotor" :style="{ transform: 'translate(-50%, -50%) rotate(' + knobAngle('left') + 'deg)' }">
                      <i class="pointer"></i>
                    </div>
                  </div>
                </div>
                <div class="knob-actions">
                  <a class="knob-btn" v-on:click="changeLevel('left', -1)"><i class="icon f7-icons">minus</i></a>
                  <div class="knob-value">{{ leftLevel }}</div>
                  <a class="knob-btn" v-on:click="changeLevel('left', 1)"><i class="icon f7-icons">plus</i></a>
                </div>
              </div>
              <div class="knob-ctrl">
                <div class="knob" :style="{ '--arc': knobArc('right') }">
                  <div class="knob-face">
                    <div class="gauge-arc"></div>
                    <div class="gauge-ticks">
                      <i class="t0"></i><i class="t1"></i><i class="t2"></i><i class="t3"></i><i class="t4"></i><i class="t5"></i>
                    </div>
                    <div class="rotor" :style="{ transform: 'translate(-50%, -50%) rotate(' + knobAngle('right') + 'deg)' }">
                      <i class="pointer"></i>
                    </div>
                  </div>
                </div>
                <div class="knob-actions">
                  <a class="knob-btn" v-on:click="changeLevel('right', -1)"><i class="icon f7-icons">minus</i></a>
                  <div class="knob-value">{{ rightLevel }}</div>
                  <a class="knob-btn" v-on:click="changeLevel('right', 1)"><i class="icon f7-icons">plus</i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-panel card" v-if="showChart">
          <div class="card-content card-content-padding">
            <div class="chart-controls">
              <div class="granularity">
                <a class="chip action" :class="{ active: chartGranularity === 'day' }" v-on:click="setGranularity('day')">{{ _('Day') }}</a>
                <a class="chip action" :class="{ active: chartGranularity === 'month' }" v-on:click="setGranularity('month')">{{ _('Month') }}</a>
                <a class="chip action" :class="{ active: chartGranularity === 'year' }" v-on:click="setGranularity('year')">{{ _('Year') }}</a>
              </div>
              <div class="metrics">
                <a class="chip action" :class="{ active: chartMetric === 'usage' }" v-on:click="setMetric('usage')">{{ _('Usage') }}</a>
                <a class="chip action" :class="{ active: chartMetric === 'duration' }" v-on:click="setMetric('duration')">{{ _('Duration') }}</a>
              </div>
              <div class="range">
                <input type="date" v-model="dateStart" v-on:change="onDateChange" />
                <span class="range-sep">~</span>
                <input type="date" v-model="dateEnd" v-on:change="onDateChange" />
              </div>
            </div>
            <div class="chart-container" ref="chartEl"></div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $update = ctx.$update,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;
    let showIrLearnIcon = false;
    let titleDiv = 'Device Control';
    let vueApp = null;
    let { guid, sub_name, type,title } = $f7route.query;
    titleDiv = title;
    $update();
    //let { guid, subdevice_name } = $f7route.query;
    await new Promise((resolve) => {
      if (window['echarts']) {
        resolve();
      } else {
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.onload = function () {
          resolve(true);
        };

        script.onerror = function () {
          // reject(false);
          console.warn(`Echart load error`);
        };

        script.src = 'https://dev.mob-mob.com/files/echarts.min.js';
        document.head.appendChild(script);
      }
    });
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          // 设备与UI状态（业务文案通过 _() 提供英文）
          isOffline: true,
          showStatus: true,
          isPowerOn: false,
          isFavorite: false,
          deviceTitle: '1211',
          minTemp: 35,
          maxTemp: 60,
          currentTemp: 35,
          step: 1,
          pressTimer: null,
          pressDir: null,
          pressDelayMs: 380,
          pressIntervalMs: 90,
          // 收藏温度
          favorites: [],
          favPressTimer: null,
          favPressIndex: null,
          favLongPressMs: 600,
          svgWidth: 320,
          svgHeight: 200,
          dragging: false,
          arcLength: Math.PI * 120, // 半圆长度（r=120）
          deviceType: type, //1 热水器 2 煮食炉
          // 连接状态
          btConnected: false,
          // 煮食炉状态
          leftBurnerOn: false,
          rightBurnerOn: false,
          leftIgniting: false,
          rightIgniting: false,
          leftExtinguishing: false,
          rightExtinguishing: false,
          // 火力档位（0-5）
          leftLevel: 0,
          rightLevel: 0,
          // 旋钮仅作为表盘显示
          brandName: 'TGC',
          // Chart
          showChart: false,
          chartGranularity: 'day', // 'day' | 'month' | 'year'
          chartMetric: 'usage', // 'usage' | 'duration'
          dateStart: '',
          dateEnd: '',
          chartInstance: null,
          chartDataSeed: null,
          viewportWidth: 0,
        },
        computed: {
          wifiConnected() {
            return !this.isOffline;
          },
          displayTemp() {
            return Math.round(this.currentTemp);
          },
          progressRatio() {
            const range = this.maxTemp - this.minTemp;
            return (this.currentTemp - this.minTemp) / range;
          },
          midTemp() {
            return Math.round(this.minTemp + (this.maxTemp - this.minTemp) / 2);
          },
          dashArray() {
            return `${this.arcLength} ${this.arcLength}`;
          },
          dashOffset() {
            return (1 - this.progressRatio) * this.arcLength;
          },
          angleRad() {
            // 半圆角度：PI(左) -> 2PI(右)
            // 加上极小偏移，避免在 2PI 处 atan2 环绕导致跳变
            const eps = 1e-4;
            let ang = Math.PI + this.progressRatio * Math.PI;
            if (ang >= 2 * Math.PI) ang = 2 * Math.PI - eps;
            if (ang <= Math.PI) ang = Math.PI + eps;
            return ang;
          },
          knobX() {
            const r = 120;
            const cx = 160,
              cy = 160;
            const rad = this.angleRad;
            return cx + r * Math.cos(rad);
          },
          knobY() {
            const r = 120;
            const cx = 160,
              cy = 160;
            const rad = this.angleRad;
            return cy + r * Math.sin(rad);
          },
        },
        watch: {},
        components: {},
        mounted() {
          // 初始化长度以启用平滑动画
          try {
            const p = this.$refs.progressPath;
            if (p && p.getTotalLength) this.arcLength = p.getTotalLength();
          } catch (e) {}
          // 轻微延迟展示状态栏动画
          setTimeout(() => (this.showStatus = this.isOffline), 300);
          // 初始化日期范围（随粒度设置）
          this.setDateRangeForGranularity(this.chartGranularity);
          // 初始数据种子
          this.chartDataSeed = Math.floor(Math.random() * 10000);
          this.viewportWidth = (typeof window !== 'undefined' && window.innerWidth) ? window.innerWidth : 0;
        },
        methods: {
          // --- Chart Range Helpers ---
          setDateRangeForGranularity(g) {
            const today = new Date();
            const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            let start = new Date(end);
            if (g === 'day') {
              // 含今天与前两天（共3天）
              start.setDate(end.getDate() - 2);
            } else if (g === 'month') {
              // 从今天起往前30天（共30天）
              start.setDate(end.getDate() - 29);
            } else {
              // 从今天起往前1年
              start.setFullYear(end.getFullYear() - 1);
            }
            this.dateStart = this.formatDateInput(start);
            this.dateEnd = this.formatDateInput(end);
          },
          setMetric(m) {
            if (this.chartMetric === m) return;
            this.chartMetric = m;
            this.renderChart();
          },
          // --- Hob ---
          toggleBurner(side) {
            const isLeft = side === 'left';
            const onKey = isLeft ? 'leftBurnerOn' : 'rightBurnerOn';
            const ignKey = isLeft ? 'leftIgniting' : 'rightIgniting';
            const extKey = isLeft ? 'leftExtinguishing' : 'rightExtinguishing';
            // 清理对侧的短暂态
            this[ignKey] = false;
            this[extKey] = false;

            if (!this[onKey]) {
              this[ignKey] = true;
              setTimeout(() => {
                this[onKey] = true;
                this[ignKey] = false;
              }, 420); // 点火过渡
            } else {
              this[extKey] = true;
              setTimeout(() => {
                this[onKey] = false;
                this[extKey] = false;
              }, 360); // 熄火过渡
            }
          },
          changeLevel(side, delta) {
            const key = side === 'left' ? 'leftLevel' : 'rightLevel';
            const onKey = side === 'left' ? 'leftBurnerOn' : 'rightBurnerOn';
            let next = this[key] + delta;
            next = Math.max(0, Math.min(5, next));
            this[key] = next;
            // 如果调整档位时未点火，可自动点火
            if (next > 0 && !this[onKey]) this.toggleBurner(side);
            if (next === 0 && this[onKey]) this.toggleBurner(side);
          },
          flameScale(side) {
            const level = side === 'left' ? this.leftLevel : this.rightLevel;
            // 0~5 -> 0.0 ~ 1.0 的比例，并以 CSS var 输出
            const ratio = level / 5;
            return String(ratio);
          },
          knobAngle(side) {
            const level = side === 'left' ? this.leftLevel : this.rightLevel;
            // 家用旋钮常见：OFF 在 -60°，最大火到 +120°
            const minDeg = -60,
              maxDeg = 120;
            return minDeg + (maxDeg - minDeg) * (level / 5);
          },
          knobArc(side) {
            const level = side === 'left' ? this.leftLevel : this.rightLevel;
            // 用于渐变弧线高亮百分比
            return (level / 5).toFixed(3);
          },
          // 旋钮不再响应拖拽
          stepUp() {
            if (this.currentTemp >= this.maxTemp) return;
            this.setTemp(this.currentTemp + this.step);
          },
          stepDown() {
            if (this.currentTemp <= this.minTemp) return;
            this.setTemp(this.currentTemp - this.step);
          },
          setTemp(val, snap = true) {
            // Optional snapping: during drag we keep raw value for higher fidelity
            const raw = snap ? Math.round(val / this.step) * this.step : val;
            const v = Math.max(this.minTemp, Math.min(this.maxTemp, raw));
            if (v !== this.currentTemp) {
              this.currentTemp = v;
            }
          },
          pressStart(e, dir) {
            this.pressDir = dir;
            if (this.pressTimer) clearTimeout(this.pressTimer);
            // 先延迟进入连发模式
            this.pressTimer = setTimeout(() => {
              const tick = () => {
                if (this.pressDir === 'up') this.stepUp();
                else if (this.pressDir === 'down') this.stepDown();
                this.pressTimer = setTimeout(tick, this.pressIntervalMs);
              };
              tick();
            }, this.pressDelayMs);
          },
          pressEnd() {
            if (this.pressTimer) clearTimeout(this.pressTimer);
            this.pressTimer = null;
            this.pressDir = null;
          },
          valueFromPoint(clientX, clientY) {
            // 将指针坐标映射到上半弧（PI..2PI）上的角度
            const rect = this.$refs.dialSvg.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            const cx = 160,
              cy = 160;
            // 为了在下半区也保持平滑，投影到上半弧：
            // 将 y 夹到 ( -∞, cy - δ ]，避免跳到边界
            const eps = 1e-4;
            const yClamped = Math.min(y, cy - 0.001);
            let ang = Math.atan2(yClamped - cy, x - cx); // [-PI, PI]
            if (ang < 0) ang += 2 * Math.PI; // [0, 2PI)
            // 非线性映射：靠近中段提高灵敏度（easeInOut）
            const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
            ang = clamp(ang, Math.PI + eps, 2 * Math.PI - eps);
            let ratio = (ang - Math.PI) / Math.PI; // 0..1
            // easeInOutCubic
            ratio = ratio < 0.5 ? 4 * ratio * ratio * ratio : 1 - Math.pow(-2 * ratio + 2, 3) / 2;
            return this.minTemp + ratio * (this.maxTemp - this.minTemp);
          },
          startDrag(e) {
            // 统一指针事件：Android 某些浏览器对 touch 触发顺序不稳定
            this.dragging = true;
            const p = e.touches ? e.touches[0] : e.pointerType ? e : e;
            window.addEventListener('mousemove', this.onDrag, { passive: false });
            window.addEventListener('touchmove', this.onDrag, { passive: false });
            window.addEventListener('pointermove', this.onDrag, { passive: false });
            window.addEventListener('mouseup', this.endDrag);
            window.addEventListener('touchend', this.endDrag);
            window.addEventListener('pointerup', this.endDrag);
            // 立即更新一次，提升起手手感
            this.setTemp(this.valueFromPoint(p.clientX, p.clientY));
          },
          onDrag(e) {
            if (!this.dragging) return;
            const p = e.touches ? e.touches[0] : e.pointerType ? e : e;
            // Follow finger exactly during drag (no snapping), improves mid-range responsiveness
            const v = this.valueFromPoint(p.clientX, p.clientY);
            this.setTemp(v, false);
            e.preventDefault();
          },
          endDrag() {
            if (!this.dragging) return;
            this.dragging = false;
            window.removeEventListener('mousemove', this.onDrag);
            window.removeEventListener('touchmove', this.onDrag);
            window.removeEventListener('pointermove', this.onDrag);
            window.removeEventListener('mouseup', this.endDrag);
            window.removeEventListener('touchend', this.endDrag);
            window.removeEventListener('pointerup', this.endDrag);
            // 释放时若在边界附近，吸附到最小或最大，避免回绕
            if (this.currentTemp >= this.maxTemp - 0.0001) this.currentTemp = this.maxTemp;
            if (this.currentTemp <= this.minTemp + 0.0001) this.currentTemp = this.minTemp;
            // 在释放时，如果指针在下半部，保持当前值并不做跳变
            // Snap to integer at release for consistency with button steps
            this.setTemp(this.currentTemp, true);
          },
          togglePower() {
            const label = this.isPowerOn ? _('Turn off heater?') : _('Turn on heater?');
            app.dialog.confirm(label, _('Confirm'), () => {
              this.isPowerOn = !this.isPowerOn;
            });
          },
          toggleFavorite() {
            const t = Math.round(this.currentTemp);
            this.addFavorite(t);
          },
          saveFavorite() {
            app.dialog.prompt(
              _('Enter a Temperature (0-60, Integer)'),
              _('Save Favorite'),
              (val) => {
                const num = Number(val);
                if (!Number.isInteger(num) || num < 0 || num > 60) {
                  app.dialog.alert(_('Please enter an integer between 0 and 60.'));
                  return;
                }
                this.addFavorite(num);
              },
              () => {},
              ''
            );
          },
          mobileOverride() {
            app.dialog.confirm(_('Give mobile app priority?'), _('Mobile Override'), () => {
              app.dialog.alert(_('Mobile Override Enabled'));
            });
          },
          editDeviceTitle() {
            app.dialog.prompt(
              _('Enter Name'),
              _('Edit'),
              (val) => {
                if (typeof val === 'string' && val.trim()) this.deviceTitle = val.trim();
              },
              () => {},
              this.deviceTitle
            );
          },
          showDeviceInfo() {
            app.dialog.alert(`${_('Device')}: ${this.deviceTitle}`);
          },
          toggleOffline() {
            // 用于演示状态，真实项目应由设备上报
            this.isOffline = !this.isOffline;
            this.showStatus = this.isOffline;
          },
          editBrand() {
            app.dialog.prompt(
              _('Enter brand'),
              _('Brand'),
              (val) => {
                if (typeof val === 'string' && val.trim()) this.brandName = val.trim();
              },
              () => {},
              this.brandName
            );
          },
          addFavorite(temp) {
            let t = temp;
            if (!Number.isInteger(t)) t = Math.round(t);
            // 限制范围 0-60
            if (t < 0 || t > 60) {
              app.dialog.alert(_('Please enter an integer between 0 and 60'));
              return;
            }
            if (this.favorites.includes(t)) {
              app.dialog.alert(_('Already exists'));
              this.isFavorite = this.favorites.includes(Math.round(this.currentTemp));
              return;
            }
            this.favorites = [...this.favorites, t].sort((a, b) => a - b);
            this.isFavorite = this.favorites.includes(Math.round(this.currentTemp));
            if (app?.toast?.create) {
              try {
                app.toast.create({ text: _('Saved'), position: 'center', closeTimeout: 1200 }).open();
              } catch (e) {
                app.dialog.alert(_('Saved'));
              }
            } else {
              app.dialog.alert(_('Saved'));
            }
          },
          onFavoriteClick(t) {
            this.setTemp(t, true);
          },
          onFavoritePressStart(index) {
            if (this.favPressTimer) clearTimeout(this.favPressTimer);
            this.favPressIndex = index;
            this.favPressTimer = setTimeout(() => {
              this.deleteFavorite(this.favPressIndex);
              this.favPressIndex = null;
              this.favPressTimer = null;
            }, this.favLongPressMs);
          },
          onFavoritePressEnd() {
            if (this.favPressTimer) clearTimeout(this.favPressTimer);
            this.favPressTimer = null;
            this.favPressIndex = null;
          },
          deleteFavorite(index) {
            if (index === null || index === undefined) return;
            const list = this.favorites.slice();
            list.splice(index, 1);
            this.favorites = list;
            this.isFavorite = this.favorites.includes(Math.round(this.currentTemp));
          },
          toggleBt() {
            this.btConnected = !this.btConnected;
          },
          // --- Chart ---
          toggleChart() {
            this.showChart = !this.showChart;
            this.$nextTick(() => {
              if (this.showChart) this.renderChart();
              else this.disposeChart();
            });
          },
          setGranularity(g) {
            if (this.chartGranularity === g) return;
            this.chartGranularity = g;
            // 切换粒度时同步日期范围
            this.setDateRangeForGranularity(g);
            this.renderChart();
          },
          onDateChange() {
            // 简单校验：开始时间不大于结束时间
            if (this.dateStart && this.dateEnd && this.dateStart > this.dateEnd) {
              const t = this.dateStart;
              this.dateStart = this.dateEnd;
              this.dateEnd = t;
            }
            this.renderChart();
          },
          formatDateInput(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
          },
          disposeChart() {
            if (this.chartInstance && this.chartInstance.dispose) {
              try { this.chartInstance.dispose(); } catch(e) {}
            }
            this.chartInstance = null;
          },
          renderChart() {
            if (!window.echarts) return;
            const el = this.$refs.chartEl;
            if (!el) return;
            if (!this.chartInstance) {
              this.chartInstance = window.echarts.init(el);
              window.addEventListener('resize', this.resizeChart, { passive: true });
            }
            const { labels, values } = this.generateSeries();
            const option = this.buildOption(labels, values);
            this.chartInstance.setOption(option, true);
          },
          resizeChart() {
            if (typeof window !== 'undefined') this.viewportWidth = window.innerWidth || 0;
            if (this.chartInstance && this.chartInstance.resize) this.chartInstance.resize();
          },
          buildOption(labels, values) {
            const isUsage = this.chartMetric === 'usage';
            const titleMapUsage = { day: _('Daily Gas Usage'), month: _('Monthly Gas Usage'), year: _('Yearly Gas Usage') };
            const titleMapDuration = { day: _('Daily Duration'), month: _('Monthly Duration'), year: _('Yearly Duration') };
            const titleMap = isUsage ? titleMapUsage : titleMapDuration;
            const count = labels.length;
            const small = this.viewportWidth && this.viewportWidth <= 420;
            const dense = count > (this.chartGranularity === 'day' ? 20 : this.chartGranularity === 'month' ? 18 : 10);
            const showSlider = dense;
            const barWidth = small || dense ? 16 : 26;
            const showLabels = (this.chartGranularity === 'day') && count <= 30;
            // 主题色（用于强调）
            let themeColor = '#3a86ff';
            try {
              const root = (typeof document !== 'undefined') ? document.documentElement : null;
              const v = root ? getComputedStyle(root).getPropertyValue('--f7-theme-color') : '';
              if (v && v.trim()) themeColor = v.trim();
            } catch (e) {}
            // 单位与 tooltip/label 格式（时长统一保留 1 位小数）
            let yName = isUsage ? _('m³') : _('h');
            const decimals = isUsage ? null : 1;
            const formatter = (p) => {
              if (isUsage) return `${p.value}`;
              const val = Number(p.value);
              return `${decimals != null ? val.toFixed(decimals) : val} ${yName}`;
            };
            return {
              backgroundColor: 'transparent',
              tooltip: { trigger: 'axis', valueFormatter: (v) => {
                if (isUsage) return `${v}`;
                const val = Number(v);
                return `${decimals != null ? val.toFixed(decimals) : val} ${yName}`;
              } },
              grid: { left: 16, right: 16, top: 40, bottom: showSlider ? 36 : 14, containLabel: true },
              xAxis: {
                type: 'category',
                boundaryGap: true,
                data: labels,
                axisTick: { alignWithLabel: true },
                axisLine: { onZero: true },
                axisLabel: { interval: 'auto', rotate: dense ? 40 : 0, hideOverlap: true, fontSize: small ? 10 : 12 },
              },
              yAxis: { type: 'value', min: 0, name: yName, nameTextStyle: { padding: [0, 0, 0, 6] } },
              dataZoom: showSlider ? [
                { type: 'inside', zoomOnMouseWheel: true, moveOnMouseMove: true, moveOnMouseWheel: true, throttle: 50 },
                { type: 'slider', height: 16, bottom: 8, left: 8, right: 8 }
              ] : [],
              series: [
                {
                  type: 'bar',
                  name: titleMap[this.chartGranularity] || _('Usage'),
                  data: values,
                  barMaxWidth: barWidth,
                  itemStyle: {
                    color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      { offset: 0, color: '#56CCF2' },
                      { offset: 0.5, color: '#6FCF97' },
                      { offset: 1, color: '#F2994A' },
                    ]),
                    borderRadius: [6, 6, 0, 0],
                  },
                  label: {
                    show: showLabels,
                    position: 'top',
                    distance: 4,
                    color: '#333',
                    fontWeight: 600,
                    formatter,
                  },
                  emphasis: { focus: 'series', itemStyle: { color: themeColor } },
                  select: { itemStyle: { color: themeColor } },
                  selectedMode: 'single',
                },
              ],
            };
          },
          generateSeries() {
            // 基于粒度与时间范围生成模拟数据（按规则：
            // day=3天（日粒度），month=30天（日粒度），year=1年（月粒度））
            let start = this.dateStart ? new Date(this.dateStart) : null;
            let end = this.dateEnd ? new Date(this.dateEnd) : null;
            if (!start || !end) {
              const today = new Date();
              const e = new Date(today.getFullYear(), today.getMonth(), today.getDate());
              let s = new Date(e);
              if (this.chartGranularity === 'day') s.setDate(e.getDate() - 2);
              else if (this.chartGranularity === 'month') s.setDate(e.getDate() - 29);
              else s.setFullYear(e.getFullYear() - 1);
              start = start || s;
              end = end || e;
            }
            const labels = [];
            const values = [];
            const rng = this.seededRandom(this.chartDataSeed + (start?.getTime() || 0) + (end?.getTime() || 0));
            if (this.chartGranularity === 'year') {
              // 月粒度（单位：小时）
              const cur = new Date(start.getFullYear(), start.getMonth(), 1);
              const e = new Date(end.getFullYear(), end.getMonth(), 1);
              while (cur <= e) {
                labels.push(`${cur.getFullYear()}-${String(cur.getMonth() + 1).padStart(2, '0')}`);
                if (this.chartMetric === 'usage') values.push(this.randomUsage(rng, 10, 60));
                else values.push(Math.round(this.randomUsage(rng, 120, 600))); // h（整）
                cur.setMonth(cur.getMonth() + 1);
              }
            } else {
              // 日粒度（单位：小时，保留 1 位小数）
              const cur = new Date(start.getFullYear(), start.getMonth(), start.getDate());
              const e = new Date(end.getFullYear(), end.getMonth(), end.getDate());
              while (cur <= e) {
                labels.push(`${cur.getMonth() + 1}/${String(cur.getDate()).padStart(2, '0')}`);
                if (this.chartMetric === 'usage') values.push(this.randomUsage(rng, 0.2, 3.2));
                else values.push(Number(this.randomUsage(rng, 0.1, 3.0).toFixed(1))); // h（1 位小数）
                cur.setDate(cur.getDate() + 1);
              }
            }
            return { labels, values };
          },
          seededRandom(seed) {
            let x = Math.sin(seed) * 10000;
            return () => {
              x = Math.sin(x) * 10000;
              return x - Math.floor(x);
            };
          },
          randomUsage(rand, min, max) {
            const v = min + (max - min) * rand();
            return Number(v.toFixed(2));
          },
        },

        beforeDestroy() {},
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  /* 半圆温控 - 现代轻拟态风格，强调过渡与阴影 */
  .top-status {
    position: sticky;
    top: 0;
    z-index: 5;
    margin: 8px 12px 2px;
    background: var(--f7-card-bg-color);
    height: 44px;
    border-radius: 22px;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    display: grid;
    grid-template-columns: 56px 56px;
    justify-content: center;
    align-items: center;
    column-gap: 8px;
  }
  .top-item {
    text-align: center;
    color: var(--f7-text-color);
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 44px;
  }
  .top-item .icon,
  .top-item .material-icons {
    font-size: 22px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .top-item .material-icons { transform: translateY(1px); }
  .top-item.danger {
    color: var(--f7-color-red);
  }
  .top-item.muted {
    color: var(--f7-color-gray, #9e9e9e);
  }
  .device-header {
    margin: 8px 0 4px;
    text-align: center;
  }
  .status {
    color: var(--f7-color-red);
    font-size: 14px;
    opacity: 0;
    transform: translateY(-6px);
    transition: all 320ms ease;
  }
  .status.offline {
    opacity: 1;
    transform: translateY(0);
  }

  .section.prefs {
    padding: 4px 16px 0;
  }
  .prefs-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .section.prefs .label {
    color: var(--f7-text-color);
    font-size: 15px;
    font-weight: 500;
  }
  .mini-btn {
    width: 34px;
    height: 34px;
    border-radius: 10px;
    background: var(--f7-card-bg-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  .mini-btn .icon {
    font-size: 18px;
    color: var(--f7-theme-color);
  }

  /* 收藏温度列表 */
  .favorite-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }
  .fav-btn {
    padding: 8px 12px;
    border-radius: 14px;
    background: var(--f7-card-bg-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    color: var(--f7-text-color);
    font-weight: 600;
    user-select: none;
  }
  .fav-btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
  }

  .dial-card {
    margin: 12px 12px 8px;
    border-radius: 16px;
  }
  .dial-wrap {
    position: relative;
  }
  .dial-svg {
    display: block;
    margin: 0 auto;
    overflow: visible;
  }
  .dial-track {
    stroke: var(--f7-theme-color-shade, #dde2e7);
    stroke-width: 16;
    fill: none;
    opacity: 0.6;
  }
  .dial-progress {
    stroke: url(#dialGradient);
    stroke-width: 16;
    fill: none;
    filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.12));
    transition: stroke-dashoffset 200ms ease;
    stroke-linecap: round;
  }
  .dial-hit-arc {
    stroke: transparent;
    stroke-width: 48;
    fill: none;
    cursor: grab;
    touch-action: none;
  }
  .dial-hit-area {
    fill: transparent;
    stroke: none;
    cursor: grab;
    touch-action: none;
  }
  .ticks .tick {
    stroke: var(--f7-text-color);
    stroke-opacity: 0.25;
    stroke-width: 2;
  }
  .ticks .tick-label {
    font-size: 12px;
    fill: var(--f7-text-color);
    opacity: 0.6;
    user-select: none;
  }
  .dial-knob {
    fill: #fff;
    stroke: var(--f7-theme-color, #3a86ff);
    stroke-width: 3;
    filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.2));
    transition: transform 150ms ease;
  }
  .dial-knob-hit {
    fill: transparent;
    cursor: grab;
    touch-action: none;
  }
  /* 移除脉冲闪烁效果，保持稳定 */

  .dial-center {
    position: absolute;
    left: 0;
    right: 0;
    top: 52px;
    text-align: center;
  }
  .dial-center .value {
    font-size: 28px;
    font-weight: 600;
    color: var(--f7-text-color);
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
  }

  /* 新控制布局 */
  .controls-grid {
    display: grid;
    grid-template-columns: 1fr 1.2fr 1fr;
    align-items: center;
    gap: 16px;
    margin-top: 10px;
  }
  .grid-col {
    display: flex;
    justify-content: center;
  }
  .center-col {
    transform: translateY(-2px);
  }
  .control-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--f7-card-bg-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      0 8px 24px rgba(0, 0, 0, 0.1),
      inset 0 0 0 1px rgba(0, 0, 0, 0.05);
    transition:
      transform 120ms ease,
      box-shadow 200ms ease;
  }
  .control-circle .icon {
    font-size: 28px;
    color: var(--f7-theme-color);
  }
  .control-circle:active {
    transform: scale(0.97);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
  }

  .control-pill {
    min-width: 92px;
    height: 48px;
    border-radius: 24px;
    background: var(--f7-card-bg-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      0 6px 18px rgba(0, 0, 0, 0.08),
      inset 0 0 0 1px rgba(0, 0, 0, 0.05);
    transition:
      transform 120ms ease,
      box-shadow 200ms ease;
  }
  .control-pill .icon {
    font-size: 22px;
    color: var(--f7-text-color);
  }
  .control-pill:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }

  .secondary-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .chip.action {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: 18px;
    background: var(--f7-card-bg-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition: background-color 160ms ease, color 160ms ease, box-shadow 160ms ease, transform 120ms ease;
  }
  .chip.action .icon {
    font-size: 16px;
  }
  .chip.action:active {
    background: var(--f7-theme-color);
    color: #fff;
    transform: translateY(1px);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  .chip.action.active {
    background: var(--f7-theme-color);
    color: #fff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
  }
  .chip.action.active .icon,
  .chip.action:active .icon {
    color: #fff;
  }
  .chip.action.add {
    color: var(--f7-theme-color);
  }

  .tertiary-actions {
    display: flex;
    justify-content: space-around;
    margin-top: 14px;
  }
  .tertiary-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--f7-card-bg-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      0 6px 16px rgba(0, 0, 0, 0.08),
      inset 0 0 0 1px rgba(0, 0, 0, 0.04);
  }
  .tertiary-circle .icon {
    font-size: 22px;
  }

  /* 统一全局留白与卡片内节奏 */
  .card-content-padding {
    padding-top: 18px;
    padding-bottom: 18px;
  }

  /* --- Hob styles --- */
  .hob-header {
    display: grid;
    grid-template-columns: 1fr 1fr;
    padding: 4px 8px 12px;
    color: var(--f7-text-color);
  }
  .hob-header .hob-label {
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    opacity: 0.8;
  }
  .hob-header .hob-label.right {
    justify-self: end;
  }
  /* 侧面视角容器：增加透视与倾斜模拟 */
  .hob-surface.side {
    position: relative;
    background: linear-gradient(#f6f7f9, #eaedf2);
    border-radius: 14px;
    padding: 22px 16px;
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.6),
      inset 0 -1px 0 rgba(0, 0, 0, 0.04);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    perspective: 900px;
  }
  .burner {
    position: relative;
    height: 160px;
    border-radius: 12px;
    background: #f3f5f8;
    box-shadow:
      inset 0 0 0 1px rgba(0, 0, 0, 0.05),
      0 8px 20px rgba(0, 0, 0, 0.06);
    cursor: pointer;
    overflow: hidden;
    transform: rotateX(14deg);
    transform-origin: bottom center;
  }
  .burner:before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: -10px;
    height: 18px;
    filter: blur(10px);
    background: radial-gradient(ellipse at 50% 0, rgba(0, 0, 0, 0.22), rgba(0, 0, 0, 0) 60%);
    pointer-events: none;
  }
  .stove-base {
    position: absolute;
    left: 50%;
    bottom: 22px;
    width: 120px;
    height: 16px;
    transform: translateX(-50%);
    background: linear-gradient(#444a55, #262d36);
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25) inset;
  }
  .nozzle {
    position: absolute;
    left: 50%;
    bottom: 38px;
    width: 32px;
    height: 14px;
    transform: translateX(-50%);
    background: linear-gradient(#707b88, #4d5661);
    border-radius: 8px;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.18);
  }
  /* 火焰（侧面） */
  .flame-side {
    position: absolute;
    left: 50%;
    bottom: 38px;
    width: 120px;
    height: 86px;
    transform: translateX(-50%);
    pointer-events: none;
    display: none;
  }
  .burner.on .flame-side {
    display: block;
  }
  .tongue {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 22px;
    height: 68px;
    transform-origin: bottom center;
    background: linear-gradient(
      180deg,
      rgba(255, 240, 150, 0.75) 0%,
      rgba(0, 168, 255, 0.85) 36%,
      rgba(0, 120, 255, 0.7) 72%,
      rgba(0, 100, 220, 0) 100%
    );
    filter: blur(0.6px);
    border-radius: 16px 16px 10px 10px/70% 70% 40% 40%;
    opacity: 0.95;
    mix-blend-mode: screen;
  }
  .tongue.t1 {
    --fs1: calc(0.45 + var(--flame-scale, 0) * 0.9);
    animation: sideWaver1 1.6s ease-in-out infinite;
  }
  .tongue.t2 {
    left: 42%;
    width: 18px;
    height: 60px;
    --fs2: calc(0.42 + var(--flame-scale, 0) * 0.75);
    animation: sideWaver2 1.9s ease-in-out infinite;
    opacity: 0.9;
  }
  .tongue.t3 {
    left: 58%;
    width: 19px;
    height: 62px;
    --fs3: calc(0.44 + var(--flame-scale, 0) * 0.8);
    animation: sideWaver3 2.2s ease-in-out infinite;
    opacity: 0.88;
  }
  .glow {
    position: absolute;
    left: 50%;
    bottom: 4px;
    width: 120px;
    height: 40px;
    transform: translateX(-50%);
    background: radial-gradient(ellipse at 50% 100%, rgba(0, 160, 255, 0.55), rgba(0, 110, 255, 0.18) 60%, rgba(0, 110, 255, 0) 70%);
    filter: blur(8px);
    opacity: 0.8;
  }
  /* 点火火花 */
  .sparks {
    position: absolute;
    left: 50%;
    bottom: 42px;
    width: 54px;
    height: 40px;
    transform: translateX(-50%);
    pointer-events: none;
    display: none;
  }
  .burner.igniting .sparks {
    display: block;
  }
  .sparks i {
    position: absolute;
    width: 3px;
    height: 3px;
    background: radial-gradient(circle, #fff, #ffd36b);
    border-radius: 50%;
    opacity: 0;
  }
  .burner.igniting .sparks i:nth-child(1) {
    left: 10px;
    bottom: 10px;
    animation: spark 420ms ease-out 40ms forwards;
  }
  .burner.igniting .sparks i:nth-child(2) {
    left: 26px;
    bottom: 16px;
    animation: spark 420ms ease-out 80ms forwards;
  }
  .burner.igniting .sparks i:nth-child(3) {
    left: 38px;
    bottom: 8px;
    animation: spark 420ms ease-out 0ms forwards;
  }
  @keyframes spark {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0;
    }
    30% {
      opacity: 1;
    }
    100% {
      transform: translateY(-14px) scale(0.4);
      opacity: 0;
    }
  }
  /* 熄火过渡：高度与透明度衰减 */
  .burner.extinguish .flame-side .tongue {
    animation: fadeDown 360ms ease-out forwards;
  }
  @keyframes fadeDown {
    0% {
      opacity: 1;
      transform: translateX(-50%) scaleY(1);
    }
    100% {
      opacity: 0;
      transform: translateX(-50%) scaleY(0.1);
    }
  }
  /* 侧面火焰摇曳 */
  @keyframes sideWaver1 {
    0% {
      transform: translateX(-50%) rotate(-3deg) scaleY(var(--fs1, 0.8));
    }
    50% {
      transform: translateX(calc(-50% + 2px)) rotate(3deg) scaleY(calc(var(--fs1, 0.8) * 1.08));
    }
    100% {
      transform: translateX(-50%) rotate(-3deg) scaleY(var(--fs1, 0.8));
    }
  }
  @keyframes sideWaver2 {
    0% {
      transform: translateX(-50%) rotate(2deg) scaleY(var(--fs2, 0.78));
    }
    50% {
      transform: translateX(calc(-50% - 1px)) rotate(-4deg) scaleY(calc(var(--fs2, 0.78) * 1.1));
    }
    100% {
      transform: translateX(-50%) rotate(2deg) scaleY(var(--fs2, 0.78));
    }
  }
  @keyframes sideWaver3 {
    0% {
      transform: translateX(-50%) rotate(-2deg) scaleY(var(--fs3, 0.82));
    }
    50% {
      transform: translateX(calc(-50% + 1px)) rotate(3deg) scaleY(calc(var(--fs3, 0.82) * 1.08));
    }
    100% {
      transform: translateX(-50%) rotate(-2deg) scaleY(var(--fs3, 0.82));
    }
  }
  /* 档位控制区 */
  .hob-levels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-top: 14px;
  }
  .level-ctrl {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .lv-btn {
    width: 34px;
    height: 34px;
    border-radius: 10px;
    background: var(--f7-card-bg-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    flex: 0 0 auto;
  }
  .lv-value {
    min-width: 84px;
    text-align: center;
    font-weight: 600;
    color: var(--f7-text-color);
  }
  @media (max-width: 360px) {
    .hob-levels {
      grid-template-columns: 1fr;
    }
  }

  /* 旋钮样式 */
  .hob-knobs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  .knob-ctrl {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .knob {
    width: 92px;
    height: 92px;
    border-radius: 50%;
    background: var(--f7-card-bg-color);
    box-shadow:
      0 8px 20px rgba(0, 0, 0, 0.1),
      inset 0 0 0 1px rgba(0, 0, 0, 0.06);
    position: relative;
    cursor: default;
    touch-action: none;
  }
  .knob:active {
    cursor: default;
  }
  .knob-face {
    position: absolute;
    inset: 10px;
    border-radius: 50%;
    background: radial-gradient(circle at 50% 35%, #ffffff, #e9eef5);
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  /* 仪表盘弧与刻度 */
  .gauge-arc {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: conic-gradient(
      from -60deg,
      var(--f7-theme-color) 0deg,
      var(--f7-theme-color) calc(var(--arc, 0) * 180deg),
      rgba(0, 0, 0, 0.14) calc(var(--arc, 0) * 180deg),
      rgba(0, 0, 0, 0.14) 180deg,
      transparent 180deg
    );
    mask: radial-gradient(circle at 50% 50%, transparent 58%, black 59%);
    -webkit-mask: radial-gradient(circle at 50% 50%, transparent 58%, black 59%);
  }
  .gauge-ticks i {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 2px;
    height: 8px;
    background: rgba(0, 0, 0, 0.25);
    transform-origin: bottom center;
  }
  .gauge-ticks .t0 {
    transform: translate(-50%, -50%) rotate(-60deg) translateY(-34px);
  }
  .gauge-ticks .t1 {
    transform: translate(-50%, -50%) rotate(-24deg) translateY(-34px);
  }
  .gauge-ticks .t2 {
    transform: translate(-50%, -50%) rotate(12deg) translateY(-34px);
  }
  .gauge-ticks .t3 {
    transform: translate(-50%, -50%) rotate(48deg) translateY(-34px);
  }
  .gauge-ticks .t4 {
    transform: translate(-50%, -50%) rotate(84deg) translateY(-34px);
  }
  .gauge-ticks .t5 {
    transform: translate(-50%, -50%) rotate(120deg) translateY(-34px);
  }
  .rotor {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 60px;
    height: 60px;
    transform: translate(-50%, -50%);
    transform-origin: center;
    transition: transform 80ms ease;
    will-change: transform;
  }
  .rotor .pointer {
    position: absolute;
    left: 50%;
    top: 6px;
    width: 4px;
    height: 24px;
    background: var(--f7-theme-color);
    border-radius: 2px;
    transform: translateX(-50%);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }
  .knob-label {
    font-size: 13px;
    color: var(--f7-text-color);
    opacity: 0.9;
  }
  .knob-actions {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 2px;
  }
  .knob-btn {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    background: var(--f7-card-bg-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  }
  .knob-btn .icon {
    font-size: 22px;
  }
  .knob-value {
    width: 48px;
    text-align: center;
    font-weight: 800;
    font-size: 16px;
  }
  @media (max-width: 360px) {
    .knob-btn {
      width: 44px;
      height: 44px;
    }
    .knob-value {
      width: 44px;
    }
  }

  /* 品牌铭牌（居中下方） */
  .hob-brand {
    position: absolute;
    left: 50%;
    bottom: 8px;
    transform: translateX(-50%);
    padding: 6px 12px;
    border-radius: 8px;
    background: linear-gradient(180deg, #fafbff, #e6ebf3);
    color: #4a5565;
    font-weight: 700;
    letter-spacing: 0.6px;
    font-size: 12px;
    box-shadow:
      0 3px 10px rgba(0, 0, 0, 0.1),
      inset 0 0 0 1px rgba(0, 0, 0, 0.08);
    user-select: none;
  }
  .hob-brand:active {
    box-shadow:
      0 2px 6px rgba(0, 0, 0, 0.1),
      inset 0 0 0 1px rgba(0, 0, 0, 0.1);
  }
  /* Chart styles */
  .chart-panel { margin: 8px 12px 16px; border-radius: 16px; }
  .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .chart-controls .granularity { display: flex; gap: 8px; }
  .chart-controls .metrics { display: flex; gap: 8px; }
  .chart-controls .range { display: inline-flex; align-items: center; gap: 6px; }
  .chart-controls .range .range-sep { opacity: .6; }
  .chart-controls .range input[type="date"] { min-width: 140px; font-variant-numeric: tabular-nums; }
  .chart-container { width: 100%; height: 240px; }
</style>
