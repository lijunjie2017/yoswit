<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('AI Page') }}</div>
        <div class="right">
          <a class="link icon-only" @click="${()=>saveForm()}">
            <i class="icon material-icons md-only">check</i>
          </a>
          <a class="link icon-only" @click="${()=>loadAndDebug()}">
            <i class="icon material-icons md-only">refresh</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content page-bg-gradient">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="block no-hairlines-between">
          <!-- é¡µé¢æ ‡é¢˜ -->
          <div class="page-header">
            <h2 class="page-title">{{ _('Smart Scene Templates') }}</h2>
            <p class="page-subtitle">{{ _('Customize Your Smart Home Control Panel') }}</p>
          </div>

          <!-- æ¨¡æ¿åˆ—è¡¨ -->
          <div
            v-for="(template, ti) in templates"
            :key="template.id"
            class="template-card"
          >
            <div class="template-header">
              <div class="template-room-container">
                <div class="template-room-selector" v-on:click="openRoomPicker(ti)">
                  <div class="template-room-info">
                    <i class="icon f7-icons room-icon">location</i>
                    <span class="template-room-name" v-if="!templates[ti].roomName">
                      {{ _('Select Room') }}
                    </span>
                    <span class="template-room-name selected" v-else>
                      {{ templates[ti].roomName }}
                    </span>
                  </div>
                  <i class="icon f7-icons room-arrow">chevron_right</i>
                </div>
              </div>
              <a
                class="link template-delete"
                v-on:click="deleteTemplate(ti)"
                v-if="templates.length > 1"
              >
                <i class="icon f7-icons">trash</i>
              </a>
            </div>
            
            <div class="template-grid">
              <div 
                v-for="(slot, slotIdx) in template.slots"
                v-if="!slot || !slot.isPlaceholder"
                :key="'cell-' + ti + '-' + slotIdx"
                class="template-cell"
                :class="getCellClasses(ti, slotIdx)"
                :style="getCellStyle(ti, slotIdx)"
              >
                <transition name="fade-scale">
                  <button
                    v-if="!slot"
                    class="cell-button cell-empty"
                    v-on:click="openPicker(ti, slotIdx)"
                  >
                    <div class="cell-inner">
                      <i class="icon f7-icons icon-plus">plus_circle_fill</i>
                      <span class="cell-label">{{ _('Add') }}</span>
                    </div>
                  </button>
                  <button
                    v-else
                    class="cell-button cell-filled-btn"
                    v-on:click="onTemplateItemClick(ti, slotIdx)"
                  >
                    <div class="cell-inner">
                      <i
                        v-if="slot.icon"
                        class="icon f7-icons cell-icon"
                      >{{ slot.icon }}</i>
                      <span class="cell-label">
                        {{ slot.text }}
                      </span>
                    </div>
                  </button>
                </transition>
              </div>
            </div>
          </div>

          <!-- æ–°å¢æ¨¡æ¿æŒ‰é’® -->
          <div class="add-template-section">
            <button class="button-add-template" v-on:click="addTemplate">
              <i class="icon f7-icons">plus_circle</i>
              <span>{{ _('Add Template') }}</span>
            </button>

            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div class="debug-info" v-if="templates.length > 0">
              <p class="debug-text">
                {{ _('Loaded') }} {{ templates.length }} {{ _('template(s) with') }}
                {{ getTotalDevices() }} {{ _('device(s)') }}
                <span v-if="getTotalRooms() > 0">
                  ({{ getTotalRooms() }} {{ _('room(s)') }})
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    let { guid, sub_name } = $f7route.query;
    //let { guid, subdevice_name } = $f7route.query;

    const saveForm = ()=>{
      vueApp.$saveForm();
    }

    const debugAnalysis = ()=>{
      vueApp.$debugTemplateAnalysis();
      vueApp.$runSystemTest();
    }

    const loadAndDebug = ()=>{
      console.log('ğŸ”„ Manual reload and debug triggered');
      vueApp.$loadFromServer();
      vueApp.$runSystemTest();
    }
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          templates: [],            // ä¼˜åŒ–åçš„æ¨¡æ¿æ•°æ®ç»“æ„
          compactData: [],         // æœåŠ¡å™¨å­˜å‚¨çš„ç²¾ç®€æ•°æ®: [{idx, deviceId, size, templateOrder}]
          templateOrderCounter: 0,  // æ¨¡æ¿åˆ›å»ºé¡ºåºè®¡æ•°å™¨
          availableItems: [],
          sizeOptions: [
            { text: _('1Ã—1 (Standard)'), width: 1, height: 1, slots: 1 },
            { text: _('2Ã—1 (Horizontal)'), width: 2, height: 1, slots: 2 },
            { text: _('1Ã—2 (Vertical)'), width: 1, height: 2, slots: 2 },
            { text: _('2Ã—2 (Large)'), width: 2, height: 2, slots: 4 },
            { text: _('3Ã—1 (Wide)'), width: 3, height: 1, slots: 3 },
            { text: _('1Ã—3 (Tall)'), width: 1, height: 3, slots: 3 },
            { text: _('4Ã—1 (Extra Wide)'), width: 4, height: 1, slots: 4 },
          ],
          searchQuery: '',
          filteredItems: [],
          // å°ºå¯¸æ˜ å°„è¡¨ - ä»device_button_groupè·å–å æ¯”ä¿¡æ¯
          sizeMapping: {
            '1*1': { width: 1, height: 1, slots: 1 },
            '2*1': { width: 2, height: 1, slots: 2 },
            '1*2': { width: 1, height: 2, slots: 2 },
            '2*2': { width: 2, height: 2, slots: 4 },
            '3*1': { width: 3, height: 1, slots: 3 },
            '1*3': { width: 1, height: 3, slots: 3 },
            '4*1': { width: 4, height: 1, slots: 4 }
          },
          roomList: [],
        },
        watch: {},
        components: {

        },
        mounted() {
          Vue.prototype.$saveForm = this.saveForm;
          Vue.prototype.$debugTemplateAnalysis = this.debugTemplateAnalysis;
          Vue.prototype.$runSystemTest = this.runSystemTest;
          Vue.prototype.$loadFromServer = this.loadFromServer;
          this.addTemplate();
          this.getRoomList();
          this.initData();

          // è¿è¡Œåˆå§‹ç³»ç»Ÿæ£€æŸ¥
          setTimeout(() => {
            console.log('ğŸš€ ' + _('AI Web Page Management System initialized successfully'));
            this.runSystemTest();
          }, 1000);
        },
        methods: {
          getRoomList(){
           console.log('Loading room list from profile...');

           // æ£€æŸ¥profileæ•°æ®æ˜¯å¦å­˜åœ¨
           if (!erp || !erp.info || !erp.info.profile) {
             console.error('ERP profile data not available');
             this.roomList = [];
             return;
           }

           let list = erp.info.profile.profile_room || [];
           console.log('Raw room data:', list);

           this.roomList = [];
           list.forEach(item=>{
            if (item && item.name) {
              this.roomList.push({
                name: item.name,
                title: tran(item.title) || item.name,
              });
            }
           });

           console.log('Processed room list:', this.roomList);
          },
          // æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—æŒ‡å®šä½ç½®å’Œå°ºå¯¸å ç”¨çš„æ ¼å­
          calculateOccupiedSlots(idx, size) {
            const sizeInfo = this.sizeMapping[size] || { width: 1, height: 1, slots: 1 };
            const occupied = [];

            // 3è¡Œ4åˆ—ç½‘æ ¼å¸ƒå±€
            const row = Math.floor(idx / 4);
            const col = idx % 4;

            // è®¡ç®—å ç”¨çš„æ‰€æœ‰æ ¼å­ä½ç½®
            for (let h = 0; h < sizeInfo.height; h++) {
              for (let w = 0; w < sizeInfo.width; w++) {
                const newRow = row + h;
                const newCol = col + w;

                // æ£€æŸ¥è¾¹ç•Œ
                if (newRow < 3 && newCol < 4) {
                  occupied.push(newRow * 4 + newCol);
                }
              }
            }

            return occupied;
          },

          // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®æŒ‡å®šå°ºå¯¸çš„é¡¹ç›®
          canPlaceItem(templates, newItemIdx, newItemSize) {
            const newOccupied = this.calculateOccupiedSlots(newItemIdx, newItemSize);

            // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
            if (newOccupied.length === 0) return false;

            // æ£€æŸ¥ä¸ç°æœ‰é¡¹ç›®çš„å†²çª
            for (const item of templates) {
              const existingOccupied = this.calculateOccupiedSlots(item.idx, item.size);

              // æ£€æŸ¥æ˜¯å¦æœ‰é‡å 
              const hasOverlap = newOccupied.some(slot =>
                existingOccupied.includes(slot)
              );

              if (hasOverlap) {
                return false;
              }
            }

            return true;
          },

          // æ ¸å¿ƒç®—æ³•ï¼šåˆ†æcompactDataï¼Œè‡ªåŠ¨åˆ†ç»„ä¸ºå¤šä¸ªæ¨¡æ¿ï¼ˆä¿æŒåˆ›å»ºé¡ºåºï¼‰
          analyzeTemplates(compactData) {
            if (!compactData || compactData.length === 0) {
              return [];
            }

            // å…ˆæŒ‰æ¨¡æ¿åˆ›å»ºé¡ºåºåˆ†ç»„ï¼Œç„¶ååœ¨æ¯ä¸ªç»„å†…æŒ‰idxæ’åº
            const templateGroupsMap = new Map();

            compactData.forEach(item => {
              const templateOrder = item.templateOrder || 0;

              if (!templateGroupsMap.has(templateOrder)) {
                templateGroupsMap.set(templateOrder, []);
              }
              templateGroupsMap.get(templateOrder).push(item);
            });

            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ¨¡æ¿é¡ºåºæ’åº
            const templateGroups = [];
            const sortedOrders = Array.from(templateGroupsMap.keys()).sort((a, b) => a - b);

            sortedOrders.forEach(order => {
              const group = templateGroupsMap.get(order);
              // åœ¨æ¯ä¸ªç»„å†…æŒ‰idxæ’åº
              const sortedGroup = group.sort((a, b) => a.idx - b.idx);
              templateGroups.push(sortedGroup);
            });

            return templateGroups;
          },

          // å°†compactDataè½¬æ¢ä¸ºæ¸²æŸ“ç”¨çš„templatesæ•°æ®ç»“æ„
          convertToTemplates(compactData, templateNames = null) {
            const templateGroups = this.analyzeTemplates(compactData);
            const templates = [];

            templateGroups.forEach((group, groupIndex) => {
              const template = this.createEmptyTemplate();

              // ä¸ºæ¨¡æ¿è®¾ç½®æ­£ç¡®çš„é¡ºåºä¿¡æ¯
              const templateOrder = group[0]?.templateOrder || groupIndex;
              template.templateOrder = templateOrder;

              // æ¢å¤æ¨¡æ¿åç§°ï¼ˆä»templateNamesä¸­è·å–ï¼Œæ›´å¯é ï¼‰
              if (templateNames && templateNames.length > templateOrder && templateNames[templateOrder]) {
                template.roomName = templateNames[templateOrder];
                console.log(`Restored template name for order ${templateOrder}: ${template.roomName}`);
              }
              // å¤‡ç”¨æ–¹æ¡ˆï¼šä»compactDataä¸­ç¬¬ä¸€ä¸ªè®¾å¤‡è·å–
              else if (group.length > 0) {
                const firstDevice = group[0];
                if (firstDevice.originalDevice && firstDevice.originalDevice.roomName) {
                  template.roomName = firstDevice.originalDevice.roomName;
                  console.log(`Fallback: restored template name from first device: ${template.roomName}`);
                }
              }

              // å°†æ¯ä¸ªé¡¹ç›®æ”¾ç½®åˆ°å¯¹åº”çš„æ ¼å­ä¸­
              group.forEach(item => {
                const occupied = this.calculateOccupiedSlots(item.idx, item.size);
                const deviceInfo = this.availableItems.find(d => d.id === item.deviceId);

                if (deviceInfo) {
                  const sizeInfo = this.sizeMapping[item.size];

                  // è®¾ç½®èµ·å§‹æ ¼å­
                  template.slots[item.idx] = {
                    ...deviceInfo,
                    width: sizeInfo.width,
                    height: sizeInfo.height,
                    size: item.size,
                    idx: item.idx,
                    templateOrder: templateOrder
                  };

                  // è®¾ç½®å ä½ç¬¦
                  occupied.forEach((slot, index) => {
                    if (slot !== item.idx) {
                      template.slots[slot] = {
                        startIndex: item.idx,
                        isPlaceholder: true,
                        templateOrder: templateOrder
                      };
                    }
                  });
                }
              });

              templates.push(template);
            });

            return templates;
          },

          // å°†templatesæ•°æ®ç»“æ„è½¬æ¢ä¸ºcompactDataç”¨äºä¿å­˜
          convertToCompactData(templates) {
            const compactData = [];

            templates.forEach((template, templateIndex) => {
              // è·å–æ¨¡æ¿çš„templateOrderï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç´¢å¼•
              const templateOrder = template.templateOrder !== undefined ? template.templateOrder : templateIndex;

              template.slots.forEach((slot, idx) => {
                if (slot && !slot.isPlaceholder) {
                  compactData.push({
                    idx: idx,
                    deviceId: slot.id,
                    size: slot.size || '1*1',
                    templateOrder: templateOrder,  // ä¿ç•™æ¨¡æ¿é¡ºåºä¿¡æ¯
                    roomName: template.roomName   // æ·»åŠ æˆ¿é—´åä¿¡æ¯
                  });
                }
              });
            });

            return compactData;
          },

          async saveForm(){
            try {
              // æ•°æ®éªŒè¯
              if (!this.templates || this.templates.length === 0) {
                $f7.dialog.alert(_('No templates available. Please add at least one template.'));
                return;
              }

              // è½¬æ¢ä¸ºç²¾ç®€æ•°æ®æ ¼å¼
              const compactData = this.convertToCompactData(this.templates);
              console.log(`${_('Original data:')}`, this.templates);
              console.log(`${_('Compact data:')}`, compactData);
              console.log(`${_('Compression rate:')}`, `${((1 - JSON.stringify(compactData).length / JSON.stringify(this.templates).length) * 100).toFixed(1)}%`);

              // å¦‚æœæ˜¯æ²¡æœ‰ä¿å­˜ä»»ä½•ä¸œè¥¿ï¼Œè­¦å‘Š
              if(compactData.length == 0){
                $f7.dialog.alert(_('Please add at least one device to the templates.'));
                return;
              }

              // æ”¶é›†æ‰€æœ‰æˆ¿é—´çš„åç§°
              const roomNames = [];
              this.templates.forEach(template => {
                if (template && template.roomName) {
                  roomNames.push(template.roomName);
                }
              });

              if (roomNames.length === 0) {
                $f7.dialog.alert(_('Please select rooms for at least one template.'));
                return;
              }

              console.log(`${_('Room names to save:')} ${roomNames.join(', ')}`);

              // éªŒè¯ERPæ•°æ®å¯ç”¨æ€§
              if (!erp || !erp.info || !erp.info.profile) {
                $f7.dialog.alert(_('Profile data not available. Please refresh the page and try again.'));
                return;
              }

              // æäº¤åˆ°erp
              let subdevices = cloneDeep(erp.info.profile.profile_subdevice);

              if (!subdevices || !Array.isArray(subdevices)) {
                $f7.dialog.alert(_('Device data not available. Please refresh the page and try again.'));
                return;
              }

              // é‡ç½®å½“å‰ç³»ç»Ÿç›¸å…³çš„è®¾å¤‡é…ç½®çŠ¶æ€
              subdevices.forEach(item => {
                if (item && item.function && typeof item.function === 'string') {
                  // æ£€æŸ¥functionå­—æ®µæ˜¯å¦åŒ…å«æˆ‘ä»¬çš„ç³»ç»Ÿåˆ†éš”ç¬¦
                  if (item.function.includes('%') && item.function.includes('#')) {
                    // å¦‚æœæ˜¯æœ¬ç³»ç»Ÿç”Ÿæˆçš„functionå­—æ®µï¼Œé‡ç½®
                    item.controller_mode = 0;
                    item.controller_mode_idx = null;
                    item.function = null;
                    console.log(`Reset device ${item.name} with old function: ${item.function}`);
                  }
                  // å¦åˆ™ä¿ç•™åŸæœ‰çš„functionå­—æ®µï¼ˆå¯èƒ½æ˜¯å…¶ä»–ä¸šåŠ¡çš„æ•°æ®ï¼‰
                } else if (item) {
                  // æ²¡æœ‰functionå­—æ®µæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œé‡ç½®çŠ¶æ€
                  item.controller_mode = 0;
                  item.controller_mode_idx = null;
                }
              });

              // é‡æ–°è®¾ç½®æ‰€æœ‰è®¾å¤‡é…ç½® 
              let updatedCount = 0;
              subdevices.forEach(item => {
                if (item) {
                  compactData.forEach(kitem => {
                    if(kitem.deviceId == item.name){
                      // æ„å»ºæ–°çš„functionå­—æ®µï¼ŒåŒ…å«æˆ¿é—´å
                      const baseFunction = `%${kitem.size}#${kitem.templateOrder}`;
                      let functionStr = baseFunction;

                      // å¦‚æœæ¨¡æ¿æœ‰æˆ¿é—´åï¼Œæ·»åŠ åˆ°functionå­—æ®µ
                      if (kitem.roomName) {
                        functionStr = `${baseFunction}&&&${kitem.roomName}`;
                      }

                      item['function'] = functionStr;
                      item.controller_mode_idx = kitem.idx;
                      item.controller_mode = 1;

                      updatedCount++;
                      console.log(`${_('Updated device:')} ${item.name} ${_('with function:')} ${functionStr}`);
                    }
                  });
                }
              });

              console.log(`Total devices updated: ${updatedCount}`);

              if (updatedCount === 0) {
                $f7.dialog.alert(_('No devices were updated. Please check your device configuration.'));
                return;
              }

              // ä¿å­˜æˆ¿é—´åç§°åˆ°Profileçš„descriptionå­—æ®µï¼Œç”¨&&&ç¬¦å·åˆ†éš”
              $f7.dialog.preloader();
              let url = `/api/resource/Profile/${erp.info.profile.name}`;

              const response = await http2
              .request(url, {
                method: 'PUT',
                serializer: 'json',
                responseType: 'json',
                debug: true,
                data: {
                  profile_subdevice: subdevices
                },
              });

              console.log('Save response:', response);
              $f7.dialog.close();

            } catch(error) {
              console.error('Save error:', error);
              $f7.dialog.close();
              $f7.dialog.alert(_('Save failed: ') + (error.message || error.toString() || _('Unknown error')));
            }
          },
          initData(){
            //get the erp data
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            this.availableItems = [];

            // è¿™é‡Œéœ€è¦æ ¹æ®ä¸åŒçš„button groupæŒ‡å®šæ–¹å‘å’Œè§„æ ¼
            /*
            é¦–å…ˆéœ€è¦çŸ¥é“å“ªäº›button groupä¼šæœ‰ç‰¹åˆ«çš„æ–¹å‘å’Œè§„æ ¼
            1.å«æœ‰DIMMINGçš„ï¼Œæ–¹å‘å‚ç›´ï¼Œè§„æ ¼ä¸º1*2
            2.å«æœ‰Curtain Motorçš„ï¼Œæ–¹å‘æ°´å¹³ï¼Œè§„æ ¼2*1
            */

            profile_subdevices.forEach(item=>{
              // æ ¹æ®device_button_groupè‡ªåŠ¨ç¡®å®šé»˜è®¤å°ºå¯¸
              let defaultSize = '1*1'; // é»˜è®¤å°ºå¯¸

              if (item.device_button_group) {
                const group = item.device_button_group.toUpperCase();

                // æ ¹æ®è®¾å¤‡ç±»å‹è‡ªåŠ¨è®¾ç½®åˆé€‚çš„å°ºå¯¸
                if (group.includes('DIMMING')) {
                  defaultSize = '1*2'; // è°ƒå…‰è®¾å¤‡ï¼šçºµå‘
                } else if (group.includes('CURTAIN') || group.includes('MOTOR')) {
                  defaultSize = '2*1'; // çª—å¸˜ç”µæœºï¼šæ¨ªå‘
                } else if (group.includes('AIR') || group.includes('HVAC')) {
                  defaultSize = '2*2'; // ç©ºè°ƒï¼šå¤§å°ºå¯¸
                } else if (group.includes('SCENE')) {
                  defaultSize = '3*1'; // åœºæ™¯ï¼šå®½å¹…
                } else if (group.includes('SENSOR')) {
                  defaultSize = '1*3'; // ä¼ æ„Ÿå™¨ï¼šçºµå‘é•¿æ¡
                }
              }
              //è·å–æœåŠ¡å™¨çš„æ•°æ®

              this.availableItems.push({
                id: item.name,
                text: tran(item.title),
                icon: 'lightbulb',
                category: item.device_button_group,
                defaultSize: defaultSize, // é»˜è®¤æ¨èå°ºå¯¸
                // å¯ä»¥æ‰©å±•æ›´å¤šè®¾å¤‡å±æ€§
                deviceInfo: item
              });
            });

            // ä»æœåŠ¡å™¨åŠ è½½é…ç½®çš„æ•°æ®
            this.loadFromServer();
          },

          // ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
          loadFromServer() {
            console.group('ğŸ”„ ' + _('Loading Saved Configuration'));
            // ä¼˜å…ˆä»profile_subdevicesåŠ è½½å·²é…ç½®çš„æ•°æ®
            const profileData = this.parseProfileSubdevices();
            console.log('profileData', profileData);

            if (profileData.compactData && profileData.compactData.length > 0) {
              console.log('âœ… ' + _('Loaded data from profile_subdevices'));
              console.log(`   ${_('Found')} ${profileData.compactData.length} ${_('configured devices')}`);

              // ä½¿ç”¨ä»functionå­—æ®µä¸­æå–çš„æ¨¡æ¿åç§°
              const templateNames = profileData.templateNames || [];
              console.log(`   ${_('Loaded template names from function fields:')} ${templateNames.join(', ')}`);

              console.log('ğŸ”„ Converting to templates...');
              this.templates = this.convertToTemplates(profileData.compactData, templateNames);
              this.compactData = profileData.compactData;

              console.log(`âœ… ${_('Successfully loaded')} ${this.templates.length} ${_('templates')}`);
              console.groupEnd();
              return;
            }

            // å¤‡ç”¨ï¼šä»localStorageåŠ è½½æ•°æ®
            const savedData = localStorage.getItem('ai-web-page-mangement-compact');
            const oldData = localStorage.getItem('ai-web-page-mangement'); // å‘åå…¼å®¹

            let compactData = null;

            if (savedData) {
              // åŠ è½½æ–°çš„ç²¾ç®€æ•°æ®æ ¼å¼
              try {
                compactData = JSON.parse(savedData);
                console.log(_('Loaded compact data format'));
              } catch (e) {
                console.error(`${_('Failed to parse compact data:')}`, e);
              }
            } else if (oldData) {
              // å‘åå…¼å®¹ï¼šè½¬æ¢æ—§æ•°æ®æ ¼å¼
              try {
                const oldTemplates = JSON.parse(oldData);
                compactData = this.convertLegacyData(oldTemplates);
                console.log(_('Converted legacy data format'));
              } catch (e) {
                console.error(`${_('Failed to convert legacy data:')}`, e);
              }
            }

            // ç¤ºä¾‹æ•°æ®ï¼Œæ¼”ç¤ºcompactDataçš„æ ¼å¼å’ŒåŠŸèƒ½ï¼ˆä¼šé€šè¿‡ç©ºé—´å†²çªè‡ªåŠ¨åˆ†ç»„ï¼‰
            const exampleCompactData = [
              // ç¬¬ä¸€ç»„è®¾å¤‡ - è¿™äº›è®¾å¤‡ä¹‹é—´æ²¡æœ‰ç©ºé—´å†²çªï¼Œä¼šå½¢æˆç¬¬ä¸€ä¸ªæ¨¡æ¿
              { idx: 0, deviceId: "device1", size: "2*2", templateOrder: 0 },  // å ç”¨æ ¼å­: [0,1,4,5]
              { idx: 6, deviceId: "device2", size: "1*1", templateOrder: 0 },  // å ç”¨æ ¼å­: [6]
              { idx: 7, deviceId: "device3", size: "1*1", templateOrder: 0 },  // å ç”¨æ ¼å­: [7]
              { idx: 8, deviceId: "device4", size: "2*1", templateOrder: 0 },  // å ç”¨æ ¼å­: [8,9]

              // ç¬¬äºŒç»„è®¾å¤‡ - ä¸ç¬¬ä¸€ç»„è®¾å¤‡æœ‰ç©ºé—´å†²çªï¼Œä¼šå½¢æˆç¬¬äºŒä¸ªæ¨¡æ¿
              { idx: 0, deviceId: "device5", size: "3*1", templateOrder: 1 },  // å ç”¨æ ¼å­: [0,1,2] - ä¸device1å†²çª
              { idx: 3, deviceId: "device6", size: "1*2", templateOrder: 1 },  // å ç”¨æ ¼å­: [3,7]
              { idx: 6, deviceId: "device7", size: "2*1", templateOrder: 1 },  // å ç”¨æ ¼å­: [6,7] - ä¸device6æœ‰éƒ¨åˆ†å†²çªï¼Œä½†ä¼šå¼€å§‹æ–°æ¨¡æ¿
            ];

            if (compactData && compactData.length > 0) {
              // è½¬æ¢ä¸ºæ¸²æŸ“ç”¨çš„æ¨¡æ¿æ•°æ®
              this.templates = this.convertToTemplates(compactData);
              this.compactData = compactData;
            } else if (exampleCompactData && exampleCompactData.length > 0) {
              // ä½¿ç”¨ç¤ºä¾‹æ•°æ®æ¼”ç¤ºåŠŸèƒ½
              this.templates = this.convertToTemplates(exampleCompactData);
              this.compactData = exampleCompactData;
              console.log(_('Using example data to demonstrate optimization features'));
            } else {
              // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªç©ºæ¨¡æ¿
              this.addTemplate();
            }
          },

          // è§£æprofile_subdevicesæ•°æ®ï¼Œè½¬æ¢ä¸ºcompactDataæ ¼å¼
          parseProfileSubdevices() {
            if (!erp || !erp.info || !erp.info.profile || !erp.info.profile.profile_subdevice) {
              console.log(_('No profile_subdevices data found'));
              return { compactData: null, templateNames: [] };
            }

            const profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice) ;
            const compactData = [];
            const templateNamesMap = new Map(); // å­˜å‚¨æ¯ä¸ªæ¨¡æ¿çš„åç§°

            console.log(`${_('Parsing profile_subdevices:')} ${profile_subdevices.length} ${_('devices')}`);

            profile_subdevices.forEach(device => {
              // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²é…ç½® (controller_mode = 1)
              if (device.controller_mode === 1) {
                // è§£æfunctionå­—æ®µï¼šæ ¼å¼å¦‚ "%1*1#0" æˆ– "%1*1#0&&&æ¨¡æ¿å"
                if (device.function && typeof device.function === 'string') {
                  const parsed = this.parseFunctionString(device.function);

                  if (parsed && device.controller_mode_idx !== undefined && device.controller_mode_idx !== null) {
                    // ä»functionå­—æ®µä¸­æå–æ¨¡æ¿åç§°
                    let templateName = parsed.roomName || null;

                    // å¦‚æœæå–åˆ°äº†æ¨¡æ¿åç§°ï¼Œå­˜å‚¨åˆ°templateNamesMapä¸­
                    if (templateName) {
                      if (!templateNamesMap.has(parsed.templateOrder)) {
                        templateNamesMap.set(parsed.templateOrder, templateName);
                        console.log(`${_('Found template name for order')} ${parsed.templateOrder}: ${templateName}`);
                      }
                    }

                    compactData.push({
                      idx: device.controller_mode_idx,        // èµ·å§‹ä½ç½®
                      deviceId: device.name,                // è®¾å¤‡ID
                      size: parsed.size,                    // å°ºå¯¸ (å¦‚ "1*1")
                      templateOrder: parsed.templateOrder,  // æ¨¡æ¿é¡ºåº
                      roomName: templateName,               // æ¨¡æ¿åç§°
                      // ä¿ç•™åŸå§‹è®¾å¤‡ä¿¡æ¯ä»¥ä¾›è°ƒè¯•
                      originalDevice: {
                        name: device.name,
                        title: device.title,
                        function: device.function,
                        controller_mode: device.controller_mode,
                        controller_mode_idx: device.controller_mode_idx,
                        roomName: templateName
                      }
                    });

                    console.log(`${_('Found configured device:')} ${device.name} ${_('at position')} ${device.controller_mode_idx}, ${_('size:')} ${parsed.size}, ${_('template:')} ${parsed.templateOrder}, ${_('template name:')} ${templateName || _('none')}`);
                  } else {
                    console.warn(`${_('Invalid function string or missing controller_mode_idx for device:')} ${device.name}`);
                  }
                }
              }
            });

            // å°†Mapè½¬æ¢ä¸ºæŒ‰templateOrderæ’åºçš„æ•°ç»„
            const sortedTemplateOrders = Array.from(templateNamesMap.keys()).sort((a, b) => a - b);
            const templateNames = sortedTemplateOrders.map(order => templateNamesMap.get(order));

            console.log(`${_('Parsed')} ${compactData.length} ${_('configured devices from profile_subdevices')}`);
            console.log(`${_('Found template names:')} ${templateNames.join(', ')}`);

            return {
              compactData: compactData.length > 0 ? compactData : null,
              templateNames: templateNames
            };
          },

          // è§£æfunctionå­—ç¬¦ä¸²ï¼Œæå–å°ºå¯¸å’Œæ¨¡æ¿é¡ºåº
          parseFunctionString(functionStr) {
            // functionæ ¼å¼: "%1*1#0" æˆ– "%1*1#0&&&æˆ¿é—´å"
            // å…¶ä¸­: 1*1 æ˜¯å°ºå¯¸ï¼Œ0 æ˜¯æ¨¡æ¿é¡ºåºï¼Œ&&&åé¢æ˜¯æˆ¿é—´åï¼ˆå¯é€‰ï¼‰

            // å…ˆåŒ¹é…åŸºç¡€æ ¼å¼
            const baseMatch = functionStr.match(/^%(\d+\*\d+)#(\d+)/);

            if (!baseMatch) {
              console.warn(`${_('Invalid function string format:')} ${functionStr}`);
              return null;
            }

            const result = {
              size: baseMatch[1],                    // å¦‚ "1*1"
              templateOrder: parseInt(baseMatch[2], 10)  // å¦‚ 0
            };

            // æå–æˆ¿é—´åï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const roomMatch = functionStr.match(/&&&(.+)$/);
            if (roomMatch) {
              result.roomName = roomMatch[1];  // æˆ¿é—´å
            }

            return result;
          },

          // å‘åå…¼å®¹ï¼šè½¬æ¢æ—§æ•°æ®æ ¼å¼
          convertLegacyData(oldTemplates) {
            const compactData = [];

            oldTemplates.forEach((template, templateIndex) => {
              if (template.slots && Array.isArray(template.slots)) {
                template.slots.forEach((slot, idx) => {
                  if (slot && !slot.isPlaceholder) {
                    // æ ¹æ®widthå’Œheightç¡®å®šsize
                    let size = '1*1';
                    if (slot.width && slot.height) {
                      size = `${slot.width}*${slot.height}`;
                    }

                    compactData.push({
                      idx: idx,
                      deviceId: slot.id || `device_${idx}`,
                      size: size,
                      templateOrder: templateIndex  // ä½¿ç”¨æ¨¡æ¿ç´¢å¼•ä½œä¸ºé¡ºåº
                    });
                  }
                });
              }
            });

            return compactData;
          },

          // è°ƒè¯•å·¥å…·ï¼šåˆ†ææ¨¡æ¿åˆ†ç»„
          debugTemplateAnalysis() {
            console.group('=== ' + _('Template Group Analysis') + ' ===');
            console.log(`${_('Current compact data:')}`, this.compactData);

            const groups = this.analyzeTemplates(this.compactData);
            console.log(`${_('Group result:')}`, groups);

            groups.forEach((group, index) => {
              console.log(`${_('Template')} ${index + 1}:`, group);

              // æ˜¾ç¤ºæ¯ä¸ªæ¨¡æ¿å ç”¨çš„æ ¼å­
              const occupiedSlots = [];
              group.forEach(item => {
                const slots = this.calculateOccupiedSlots(item.idx, item.size);
                occupiedSlots.push(...slots);
              });
              console.log(`  ${_('Occupied slots:')} [${occupiedSlots.sort((a,b) => a-b).join(', ')}]`);
              console.log(`  ${_('Occupancy rate:')} ${(occupiedSlots.length / 12 * 100).toFixed(1)}%`);
            });

            // æ·»åŠ è®¾å¤‡é€‰æ‹©çŠ¶æ€ä¿¡æ¯
            const selectionInfo = this.getDeviceSelectionInfo();
            console.log('\n=== ' + _('Device Selection Status') + ' ===');
            console.log(`${_('Total devices:')} ${selectionInfo.total}`);
            console.log(`${_('Selected:')} ${selectionInfo.selected}`);
            console.log(`${_('Available:')} ${selectionInfo.available}`);
            console.log(`${_('Selected device IDs:')}`, selectionInfo.selectedIds);

            // æ˜¾ç¤ºå¯ç”¨è®¾å¤‡
            const availableItems = this.getAvailableItemsForSelection();
            console.log('\n' + _('Available devices:') + ':');
            availableItems.forEach(item => {
              console.log(`  - ${item.text} (${item.id}) - ${item.category}`);
            });

            console.groupEnd();
          },

          // ç»¼åˆæµ‹è¯•åŠŸèƒ½
          runSystemTest() {
            console.group('=== ' + _('System Health Check') + ' ===');

            try {
              // 1. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
              console.log('1. ' + _('Data Integrity Check:'));
              console.log(`  - Templates: ${this.templates ? this.templates.length : 0} templates`);
              console.log(`  - Available Items: ${this.availableItems ? this.availableItems.length : 0} devices`);
              console.log(`  - Room List: ${this.roomList ? this.roomList.length : 0} rooms`);
              console.log(`  - Compact Data: ${this.compactData ? this.compactData.length : 0} configured devices`);

              // 2. æ£€æŸ¥æˆ¿é—´æ•°æ®
              console.log('\n2. ' + _('Room Data Check:'));
              if (this.roomList && this.roomList.length > 0) {
                this.roomList.forEach((room, index) => {
                  console.log(`  - Room ${index + 1}: ${room.title || room.name} (${room.name})`);
                });
              } else {
                console.warn('  âš ï¸ No rooms available');
              }

              // 3. æ£€æŸ¥æ¨¡æ¿æˆ¿é—´å…³è”
              console.log('\n3. ' + _('Template-Room Association Check:'));
              this.templates.forEach((template, index) => {
                const roomStatus = template.roomName ? `âœ“ ${template.roomName}` : 'âœ— No room';
                const deviceCount = template.slots ? template.slots.filter(slot => slot && !slot.isPlaceholder).length : 0;
                console.log(`  - Template ${index + 1}: ${roomStatus}, ${deviceCount} devices`);
              });

              // 4. æ£€æŸ¥è®¾å¤‡åˆ†é…
              console.log('\n4. ' + _('Device Allocation Check:'));
              const allocatedDevices = new Set();
              this.templates.forEach((template, ti) => {
                if (template.slots) {
                  template.slots.forEach((slot, si) => {
                    if (slot && !slot.isPlaceholder && slot.id) {
                      allocatedDevices.add(slot.id);
                    }
                  });
                }
              });

              console.log(`  - Allocated devices: ${allocatedDevices.size}/${this.availableItems.length}`);
              console.log(`  - Unallocated devices: ${this.availableItems.length - allocatedDevices.size}`);

              // 5. æ£€æŸ¥æ•°æ®å‹ç¼©ç‡
              if (this.templates.length > 0) {
                const compactData = this.convertToCompactData(this.templates);
                const originalSize = JSON.stringify(this.templates).length;
                const compactSize = JSON.stringify(compactData).length;
                const compressionRate = ((1 - compactSize / originalSize) * 100).toFixed(1);
                console.log('\n5. ' + _('Data Compression Analysis:'));
                console.log(`  - Original size: ${originalSize} bytes`);
                console.log(`  - Compact size: ${compactSize} bytes`);
                console.log(`  - Compression rate: ${compressionRate}%`);
              }

              // 6. æ£€æŸ¥ç®—æ³•åŠŸèƒ½
              console.log('\n6. ' + _('Algorithm Functionality Check:'));
              console.log('  âœ“ calculateOccupiedSlots: Function exists');
              console.log('  âœ“ canPlaceItem: Function exists');
              console.log('  âœ“ analyzeTemplates: Function exists');
              console.log('  âœ“ convertToTemplates: Function exists');
              console.log('  âœ“ convertToCompactData: Function exists');

              console.log('\nâœ… ' + _('System health check completed successfully'));

            } catch (error) {
              console.error('\nâŒ ' + _('System health check failed:'), error);
            }

            console.groupEnd();
          },
          createEmptyTemplate() {
            // è®¡ç®—æ–°æ¨¡æ¿çš„é¡ºåº
            const nextOrder = this.getNextTemplateOrder(this.compactData);

            return {
              id: 'tpl-' + Date.now() + '-' + Math.random().toString(36).slice(2, 7),
              templateOrder: nextOrder,  // è®¾ç½®æ¨¡æ¿é¡ºåº
              roomName: null,           // æˆ¿é—´åç§°
              slots: Array(12).fill(null), // 3è¡ŒÃ—4åˆ— = 12æ ¼
            };
          },

          // æ‰“å¼€æˆ¿é—´é€‰æ‹©å™¨ - ä½¿ç”¨Framework7æ ‡å‡†Picker
          openRoomPicker(ti) {
            console.log(`${_('Opening room picker for template')} ${ti}`);

            // é‡æ–°åŠ è½½æˆ¿é—´åˆ—è¡¨ï¼Œç¡®ä¿æœ€æ–°æ•°æ®
            this.getRoomList();

            // æ£€æŸ¥æ•°æ®æº
            if (!erp || !erp.info || !erp.info.profile) {
              $f7.dialog.alert(_('Profile data not available. Please try again later.'));
              return;
            }

            // ç¡®ä¿roomListæœ‰æ•°æ®
            if (this.roomList.length === 0) {
              console.warn('Room list is empty, attempting to reload...');
              // å°è¯•ä»åŸå§‹æ•°æ®é‡æ–°åŠ è½½
              if (erp.info.profile.profile_room && Array.isArray(erp.info.profile.profile_room)) {
                this.roomList = erp.info.profile.profile_room
                  .filter(room => room && room.name)
                  .map(room => ({
                    name: room.name,
                    title: tran(room.title) || room.name
                  }));
              }
            }

            if (this.roomList.length === 0) {
              $f7.dialog.alert(_('No rooms available. Please add rooms in the profile settings first.'));
              return;
            }

            console.log(`Available rooms for selection:`, this.roomList);

            // å‡†å¤‡Pickeræ•°æ®
            const roomPickerValues = this.roomList.map(room => tran(room.name) || tran(room.title));
            const roomPickerDisplayValues = this.roomList.map(room => tran(room.title) || tran(room.name));

            // å¦‚æœå·²ç»é€‰æ‹©äº†æˆ¿é—´ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼
            let currentValue = 0;
            if (this.templates[ti] && this.templates[ti].roomName) {
              const index = roomPickerDisplayValues.indexOf(this.templates[ti].roomName);
              if (index !== -1) {
                currentValue = index;
              }
            }

            // åˆ›å»ºæˆ¿é—´é€‰æ‹©å™¨
            const picker = $f7.picker.create({
              inputEl: null, // ä¸ç»‘å®šåˆ°è¾“å…¥æ¡†
              value: [currentValue],
              cols: [
                {
                  textAlign: 'center',
                  values: roomPickerValues,
                  displayValues: roomPickerDisplayValues
                }
              ],
              on: {
                change: (picker, values) => {
                  console.log('Picker values:', values);
                  const selectedIndex = values[0];

                  // æŸ¥æ‰¾é€‰ä¸­çš„æˆ¿é—´
                  const selectedRoom = this.roomList.find(item => item.name === selectedIndex);
                  console.log('Selected room:', selectedRoom);

                  if (selectedRoom) {
                    this.setTemplateRoom(ti, selectedRoom.name, selectedRoom.title || selectedRoom.name);
                    console.log(`${_('Selected room:')} ${selectedRoom.title || selectedRoom.name}`);
                  }
                },
                open: () => {
                  console.log(`${_('Room picker opened with')} ${this.roomList.length} ${_('rooms')}`);
                },
                close: () => {
                  console.log(`${_('Room picker closed')}`);
                }
              }
            });

            // æ·»åŠ æ¸…é™¤æˆ¿é—´é€‰é¡¹
            if (this.templates[ti] && this.templates[ti].roomName) {
              picker.params.cols[0].values.push('');
              picker.params.cols[0].displayValues.push(_('Clear Room'));
            }

            picker.open();
          },

          // è®¾ç½®æ¨¡æ¿æˆ¿é—´
          setTemplateRoom(ti, roomName, roomTitle) {
            const previousRoom = this.templates[ti].roomName;
            this.$set(this.templates[ti], 'roomName', roomTitle);

            // æ·»åŠ è§†è§‰åé¦ˆ
            const roomSelector = document.querySelector(`.template-card:nth-child(${ti + 1}) .template-room-selector`);
            if (roomSelector) {
              roomSelector.style.transform = 'scale(0.95)';
              setTimeout(() => {
                roomSelector.style.transform = 'scale(1)';
              }, 150);
            }

            console.log(`${_('Template')} ${ti + 1} ${_('room changed from')} ${previousRoom || _('none')} ${_('to:')} ${roomTitle || _('none')}`);
          },
          addTemplate() {
            console.log(`${_('Adding new template with order:')} ${this.getNextTemplateOrder(this.compactData)}`);
            this.templates.push(this.createEmptyTemplate());
            setTimeout(() => {
              const pageContent = document.querySelector('.page-content');
              if (pageContent) {
                pageContent.scrollTop = pageContent.scrollHeight;
              }
            }, 100);
          },
          deleteTemplate(ti) {
            if (this.templates.length > 1) {
              $f7.dialog.confirm(_('Are you sure you want to delete this template?'), () => {
                this.templates.splice(ti, 1);
              });
            }
          },
          // è·å–è¡Œåˆ—ä½ç½®ï¼ˆ3è¡Œ4åˆ—ï¼‰
          getRowCol(index) {
            return {
              row: Math.floor(index / 4), // æ¯è¡Œ4åˆ—
              col: index % 4
            };
          },
          // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦è¢«å ç”¨
          isCellOccupied(ti, si) {
            const slot = this.templates[ti].slots[si];
            return slot !== null;
          },
          // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦ä¸ºç©ºï¼ˆå¯ä»¥æ·»åŠ å†…å®¹ï¼‰
          isCellEmpty(ti, si) {
            return this.templates[ti].slots[si] === null;
          },
          // æ£€æŸ¥æ˜¯å¦ä¸ºå ä½ç¬¦
          isPlaceholder(ti, si) {
            const slot = this.templates[ti].slots[si];
            return slot && slot.isPlaceholder === true;
          },
          // æ£€æŸ¥æ˜¯å¦ä¸ºèµ·å§‹å•å…ƒæ ¼ï¼ˆæ˜¾ç¤ºå†…å®¹çš„æ ¼å­ï¼‰
          isCellStart(ti, si) {
            const slot = this.templates[ti].slots[si];
            if (!slot) return false;
            // å¦‚æœæœ‰ startIndex å±æ€§ï¼Œè¯´æ˜æ˜¯å ä½ç¬¦
            return !slot.hasOwnProperty('startIndex');
          },
          // æ£€æŸ¥æŸä¸ªä½ç½®æ˜¯å¦å¯ä»¥æ”¾ç½®æŒ‡å®šå°ºå¯¸çš„é¡¹ç›®
          canPlaceItem(ti, si, width, height, excludeStartIndex = null) {
            const { row, col } = this.getRowCol(si);
            
            // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œï¼ˆ3è¡Œ4åˆ—ï¼‰
            if (col + width > 4 || row + height > 3) {
              return false;
            }
            
            // æ£€æŸ¥æ‰€æœ‰è¦å ç”¨çš„æ ¼å­æ˜¯å¦éƒ½ä¸ºç©º
            for (let h = 0; h < height; h++) {
              for (let w = 0; w < width; w++) {
                const checkIndex = (row + h) * 4 + (col + w);
                const slot = this.templates[ti].slots[checkIndex];
                
                // å¦‚æœæ ¼å­ä¸ä¸ºç©º
                if (slot !== null) {
                  // å¦‚æœæ˜¯å ä½ç¬¦ï¼Œæ£€æŸ¥æ˜¯å¦å±äºè¦æ›¿æ¢çš„é¡¹ç›®
                  if (slot.isPlaceholder && slot.startIndex === excludeStartIndex) {
                    continue; // è·³è¿‡ï¼Œå…è®¸å ç”¨
                  }
                  // å¦‚æœæ˜¯èµ·å§‹æ ¼å­ä¸”å°±æ˜¯è¦æ›¿æ¢çš„ä½ç½®
                  if (checkIndex === excludeStartIndex) {
                    continue; // è·³è¿‡ï¼Œå…è®¸å ç”¨
                  }
                  // å¦åˆ™ï¼Œè¯¥ä½ç½®å·²è¢«å…¶ä»–é¡¹ç›®å ç”¨
                  return false;
                }
              }
            }
            
            return true;
          },
          // è®¾ç½®é¡¹ç›®ï¼ˆå ç”¨å¤šä¸ªæ ¼å­ï¼‰
          setItem(ti, si, item, width, height) {
            if (!item) {
              // æ¸…é™¤é¡¹ç›®
              this.clearItem(ti, si);
              return;
            }
            
            // æ£€æŸ¥å½“å‰ä½ç½®æ˜¯å¦æœ‰æ—§é¡¹ç›®ï¼ˆç”¨äºæ›´æ¢ç±»å‹ï¼‰
            const existingSlot = this.templates[ti].slots[si];
            const isReplacing = existingSlot && !existingSlot.isPlaceholder;
            
            // å¦‚æœæ˜¯æ›´æ¢ç±»å‹ï¼Œæ£€æŸ¥æ—¶æ’é™¤å½“å‰é¡¹ç›®å ç”¨çš„æ ¼å­
            if (!this.canPlaceItem(ti, si, width, height, isReplacing ? si : null)) {
              $f7.dialog.alert(_('Cannot place, insufficient space or already occupied'));
              return;
            }
            
            // å¦‚æœæ˜¯æ›´æ¢ç±»å‹ï¼Œå…ˆæ¸…é™¤æ—§çš„
            if (isReplacing) {
              this.clearItem(ti, si);
            }
            
            const { row, col } = this.getRowCol(si);
            const selected = { ...item, width, height };
            
            // è®¾ç½®èµ·å§‹æ ¼å­
            this.$set(this.templates[ti].slots, si, selected);
            
            // è®¾ç½®å ä½ç¬¦
            for (let h = 0; h < height; h++) {
              for (let w = 0; w < width; w++) {
                if (h === 0 && w === 0) continue; // è·³è¿‡èµ·å§‹æ ¼å­
                const occupyIndex = (row + h) * 4 + (col + w);
                this.$set(this.templates[ti].slots, occupyIndex, { 
                  startIndex: si,
                  isPlaceholder: true 
                });
              }
            }
          },
          // ä¼˜åŒ–ç‰ˆæœ¬çš„clearItemæ–¹æ³• - ä½¿ç”¨æ–°çš„æ•°æ®ç»“æ„
          clearItem(ti, si) {
            const slot = this.templates[ti].slots[si];
            if (!slot) return;

            // å¦‚æœæ˜¯å ä½ç¬¦ï¼Œæ‰¾åˆ°èµ·å§‹æ ¼å­
            let startIndex = si;
            if (slot.isPlaceholder) {
              startIndex = slot.startIndex;
            }

            const item = this.templates[ti].slots[startIndex];
            if (!item || item.isPlaceholder) return;

            // æ·»åŠ åˆ é™¤åŠ¨ç”»
            const cellElements = [];
            const occupiedSlots = this.calculateOccupiedSlots(startIndex, item.size || '1*1');

            occupiedSlots.forEach(slotIndex => {
              const cellElement = document.querySelector(`.template-card:nth-child(${ti + 1}) .template-cell:nth-child(${slotIndex + 1})`);
              if (cellElement) {
                cellElements.push(cellElement);
                cellElement.style.transition = 'all 0.3s ease';
                cellElement.style.opacity = '0';
                cellElement.style.transform = 'scale(0.8)';
              }
            });

            setTimeout(() => {
              // è·å–å½“å‰çš„compactæ•°æ®
              const currentCompactData = this.convertToCompactData(this.templates);

              // æ‰¾åˆ°è¦åˆ é™¤çš„é¡¹ç›®
              const itemToDelete = currentCompactData.findIndex(compactItem =>
                compactItem.idx === startIndex && compactItem.deviceId === item.id
              );

              if (itemToDelete !== -1) {
                // åˆ é™¤é¡¹ç›®
                currentCompactData.splice(itemToDelete, 1);

                // é‡æ–°è®¡ç®—æ¨¡æ¿åˆ†ç»„
                const newTemplates = this.convertToTemplates(currentCompactData);

                // æ›´æ–°æ•°æ®
                this.templates = newTemplates;
                this.compactData = currentCompactData;

                // åˆ é™¤åè¯¥è®¾å¤‡é‡æ–°å˜ä¸ºå¯é€‰æ‹©çŠ¶æ€
                console.log(`${_('Item deleted, device')} ${item.id} ${_('is now available for selection')}`);
                console.log(`${_('Available devices count:')} ${this.getAvailableItemsForSelection().length}`);

                // æ¢å¤åŠ¨ç”»
                setTimeout(() => {
                  cellElements.forEach(cellElement => {
                    if (cellElement) {
                      cellElement.style.opacity = '1';
                      cellElement.style.transform = 'scale(1)';
                    }
                  });
                }, 100);
              }
            }, 300);
          },
          // æ‰“å¼€é€‰æ‹©å™¨ï¼šå…ˆé€‰ç±»å‹ï¼Œå†é€‰å°ºå¯¸
          openPicker(ti, si) {
            this.searchQuery = '';
            // è¿‡æ»¤æ‰å·²é€‰æ‹©çš„è®¾å¤‡
            this.filteredItems = this.getAvailableItemsForSelection();
            
            // åˆ›å»ºè‡ªå®šä¹‰ Sheet Modal
            const sheetHtml = `
              <div class="sheet-modal item-picker-sheet">
                <div class="toolbar picker-toolbar">
                  <div class="toolbar-inner">
                    <div class="left"></div>
                    <div class="title">${_('Select Control')}</div>
                    <div class="right">
                      <a class="link sheet-close picker-close-btn">${_('Done')}</a>
                    </div>
                  </div>
                </div>
                <div class="sheet-modal-inner">
                  <div class="picker-searchbar-wrap">
                    <div class="searchbar picker-searchbar">
                      <div class="searchbar-inner">
                        <div class="searchbar-input-wrap">
                          <input type="search" placeholder="${_('Search controls or categories...')}" class="item-search-input">
                          <i class="searchbar-icon"></i>
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="page-content picker-page-content">
                    <div class="list picker-item-list media-list no-hairlines">
                      <ul id="item-picker-list"></ul>
                    </div>
                    <div class="picker-empty-state">
                      <i class="icon f7-icons">search</i>
                      <p>${_('No matching controls found')}</p>
                      <span>${_('Please try other keywords')}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            const sheet = $f7.sheet.create({
              content: sheetHtml,
              swipeToClose: true,
              backdrop: true,
              closeByBackdropClick: true,
              on: {
                opened: () => {
                  // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                  const searchInput = sheet.$el.find('.item-search-input');
                  const emptyState = sheet.$el.find('.picker-empty-state');
                  const itemList = sheet.$el.find('.picker-item-list');
                  
                  searchInput.on('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    this.searchQuery = query;

                    // å…ˆè¿‡æ»¤å·²é€‰æ‹©çš„è®¾å¤‡ï¼Œå†è¿›è¡Œæœç´¢è¿‡æ»¤
                    const availableItems = this.getAvailableItemsForSelection();
                    this.filteredItems = availableItems.filter(item =>
                      item.text.toLowerCase().includes(query) ||
                      item.category.toLowerCase().includes(query)
                    );
                    this.renderItemList(sheet, ti, si);
                    
                    // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
                    if (this.filteredItems.length === 0) {
                      itemList.hide();
                      emptyState.show();
                    } else {
                      itemList.show();
                      emptyState.hide();
                    }
                  });
                  
                  // æ¸…é™¤æŒ‰é’®
                  sheet.$el.find('.input-clear-button').on('click', () => {
                    searchInput.val('');
                    searchInput.trigger('input');
                  });
                  
                  // æ¸²æŸ“åˆ—è¡¨
                  this.renderItemList(sheet, ti, si);
                  emptyState.hide();
                },
                closed: () => {
                  sheet.destroy();
                }
              }
            });
            
            sheet.open();
          },
          // æ¸²æŸ“é€‰é¡¹åˆ—è¡¨
          renderItemList(sheet, ti, si) {
            const listEl = sheet.$el.find('#item-picker-list');
            listEl.empty();

            // æ·»åŠ é€‰æ‹©çŠ¶æ€ä¿¡æ¯
            const selectionInfo = this.getDeviceSelectionInfo();
            if (selectionInfo.selected > 0) {
              const statusItem = $(`
                <li class="picker-status-item">
                  <div class="picker-status-content">
                    <div class="picker-status-info">
                      <span class="picker-status-text">
                        ${ _('Selected') } ${selectionInfo.selected} ${ _('devices, available') } ${selectionInfo.available} ${ _('more') }
                      </span>
                    </div>
                  </div>
                </li>
              `);
              listEl.append(statusItem);
            }

            // ç›´æ¥æ¸²æŸ“æ‰€æœ‰å¯ç”¨é¡¹ç›®
            if (this.filteredItems.length === 0) {
              const emptyItem = $(`
                <li class="picker-empty-item">
                  <div class="picker-empty-content">
                    <i class="icon f7-icons">checkmark_circle_fill</i>
                    <span class="picker-empty-text">${ _('All devices have been added to templates') }</span>
                  </div>
                </li>
              `);
              listEl.append(emptyItem);
              return;
            }

            this.filteredItems.forEach(item => {
              // è·å–è®¾å¤‡æè¿°
              const deviceDescription = this.getDeviceDescription(item.category, item.defaultSize);

              const li = $(`
                <li class="control-picker-list-item">
                  <div class="control-picker-item-content">
                    <div class="control-picker-icon-wrap">
                      <div class="control-picker-icon-bg">
                        <i class="icon f7-icons">${item.icon}</i>
                      </div>
                    </div>
                    <div class="control-picker-text-wrap">
                      <div class="control-picker-title-row">
                        <div class="control-picker-title">${item.text}</div>
                        <div class="control-picker-arrow">
                          <i class="icon f7-icons">chevron_right</i>
                        </div>
                      </div>
                      <div class="control-picker-subtitle">${item.category}</div>
                      <div class="control-picker-description">${deviceDescription}</div>
                    </div>
                  </div>
                </li>
              `);

              li.on('click', (e) => {
                e.preventDefault();
                sheet.close();
                // é€‰æ‹©ç±»å‹åï¼Œå†é€‰æ‹©å°ºå¯¸
                setTimeout(() => {
                  this.openSizePicker(ti, si, item);
                }, 300);
              });

              listEl.append(li);
            });
          },

          // è·å–è®¾å¤‡æè¿°ä¿¡æ¯
          getDeviceDescription(category, defaultSize) {
            const descriptions = {
              'DIMMING': _('Dimmable light with brightness control'),
              'CURTAIN': _('Curtain motor with open/close control'),
              'MOTOR': _('Smart motor for various applications'),
              'AIR': _('Air conditioner with temperature control'),
              'HVAC': _('HVAC system with climate control'),
              'SCENE': _('Scene controller for preset configurations'),
              'SENSOR': _('Environmental sensor for monitoring'),
              'SWITCH': _('Basic on/off switch control'),
              'LIGHT': _('Standard light control'),
              'default': _('Smart home device control')
            };

            // æ£€æŸ¥categoryä¸­æ˜¯å¦åŒ…å«å…³é”®è¯
            for (const [key, description] of Object.entries(descriptions)) {
              if (category && category.toUpperCase().includes(key)) {
                return description;
              }
            }

            return descriptions.default;
          },
          // æ‰“å¼€å°ºå¯¸é€‰æ‹©å™¨ - ä¼˜åŒ–ç‰ˆæœ¬
          openSizePicker(ti, si, item) {
            // è·å–è®¾å¤‡çš„æ¨èå°ºå¯¸
            const recommendedSize = item.defaultSize || '1*1';

            const groups = [];
            const sizeButtons = this.sizeOptions.map((size) => {
              const isRecommended = size.width + '*' + size.height === recommendedSize;
              return {
                text: size.text + (isRecommended ? ' â­' : ''),
                onClick: () => {
                  const sizeKey = size.width + '*' + size.height;
                  this.setItemOptimized(ti, si, item, sizeKey);
                },
              };
            });

            groups.push(sizeButtons);
            groups.push([{ text: _('Cancel'), color: 'gray' }]);

            const act = $f7.actions.create({
              buttons: groups,
              cssClass: 'template-actions-sheet'
            });
            act.open();
          },

          // ä¼˜åŒ–ç‰ˆæœ¬çš„setItemæ–¹æ³• - ç›´æ¥ä½¿ç”¨æ¨¡æ¿ç´¢å¼•ä½œä¸ºtemplateOrder
          setItemOptimized(ti, si, item, size) {
            if (!item) {
              this.clearItem(ti, si);
              return;
            }

            console.log(`${_('Adding item to template')} ${ti} ${_('at position')} ${si}`);

            // æ·»åŠ åŠ è½½åŠ¨ç”»
            const cellElement = document.querySelector(`.template-card:nth-child(${ti + 1}) .template-cell:nth-child(${si + 1})`);
            if (cellElement) {
              cellElement.style.opacity = '0.6';
              cellElement.style.transform = 'scale(0.9)';
            }

            setTimeout(() => {
              // æ£€æŸ¥å½“å‰ä½ç½®æ˜¯å¦æœ‰æ—§é¡¹ç›®
              const existingSlot = this.templates[ti].slots[si];
              const isReplacing = existingSlot && !existingSlot.isPlaceholder;

              // è·å–å½“å‰æ¨¡æ¿çš„templateOrder
              const currentTemplate = this.templates[ti];
              const templateOrder = currentTemplate.templateOrder !== undefined ? currentTemplate.templateOrder : ti;

              // è·å–å½“å‰æ¨¡æ¿çš„æ‰€æœ‰compactæ•°æ®
              const currentCompactData = this.convertToCompactData(this.templates);

              // å¦‚æœæ˜¯æ›¿æ¢ï¼Œå…ˆç§»é™¤æ—§çš„
              if (isReplacing) {
                const oldSize = existingSlot.size || '1*1';
                const oldItem = {
                  idx: si,
                  deviceId: existingSlot.id,
                  size: oldSize,
                  templateOrder: templateOrder
                };
                const index = currentCompactData.findIndex(item =>
                  item.idx === oldItem.idx && item.deviceId === oldItem.deviceId && item.templateOrder === oldItem.templateOrder
                );
                if (index !== -1) {
                  currentCompactData.splice(index, 1);
                  console.log(`${_('Removed old item:')} ${existingSlot.id} ${_('from template')} ${ti}`);
                }
              }

              // åˆ›å»ºæ–°é¡¹ç›®ï¼Œä½¿ç”¨å½“å‰æ¨¡æ¿çš„templateOrder
              const newItem = {
                idx: si,
                deviceId: item.id,
                size: size,
                templateOrder: templateOrder
              };

              // æ£€æŸ¥åœ¨å½“å‰æ¨¡æ¿ä¸­æ˜¯å¦å¯ä»¥æ”¾ç½®
              const currentTemplateItems = currentCompactData.filter(item =>
                item.templateOrder === templateOrder
              );

              if (!this.canPlaceItemInTemplate(currentTemplateItems, newItem)) {
                $f7.dialog.alert(_('Cannot place, insufficient space or already occupied'));
                if (cellElement) {
                  cellElement.style.opacity = '1';
                  cellElement.style.transform = 'scale(1)';
                }
                return;
              }

              // æ·»åŠ æ–°é¡¹ç›®
              currentCompactData.push(newItem);
              console.log(`${_('Added new item:')} ${item.id} ${_('to template order')} ${templateOrder}`);

              // é‡æ–°æ„å»ºtemplatesï¼ˆä¿æŒç°æœ‰çš„åˆ†ç»„ï¼‰
              this.templates = this.convertToTemplates(currentCompactData);
              this.compactData = currentCompactData;

              console.log(`${_('Template reconstruction complete. Total templates:')} ${this.templates.length}`);

              // æ¢å¤åŠ¨ç”»
              setTimeout(() => {
                if (cellElement) {
                  cellElement.style.opacity = '1';
                  cellElement.style.transform = 'scale(1)';
                }
              }, 100);

            }, 200);
          },

          // è·å–ä¸‹ä¸€ä¸ªæ¨¡æ¿çš„é¡ºåºå·
          getNextTemplateOrder(compactData) {
            const existingOrders = compactData.map(item => item.templateOrder || 0);
            return Math.max(...existingOrders, -1) + 1;
          },

          // è·å–å½“å‰é¡¹ç›®æ‰€å±çš„æ¨¡æ¿ç´¢å¼•
          getCurrentTemplateIndex(templateGroups, itemIdx) {
            for (let i = 0; i < templateGroups.length; i++) {
              const group = templateGroups[i];
              if (group.some(item => item.idx === itemIdx)) {
                return i;
              }
            }
            return 0;
          },

          // è·å–å½“å‰å·²é€‰æ‹©çš„è®¾å¤‡IDåˆ—è¡¨
          getSelectedDeviceIds() {
            const selectedIds = new Set();

            // éå†æ‰€æœ‰æ¨¡æ¿
            this.templates.forEach(template => {
              if (template.slots && Array.isArray(template.slots)) {
                template.slots.forEach(slot => {
                  if (slot && !slot.isPlaceholder && slot.id) {
                    selectedIds.add(slot.id);
                  }
                });
              }
            });

            return selectedIds;
          },

          // è·å–å¯ä¾›é€‰æ‹©çš„è®¾å¤‡åˆ—è¡¨ï¼ˆæ’é™¤å·²é€‰æ‹©çš„ï¼‰
          getAvailableItemsForSelection() {
            const selectedIds = this.getSelectedDeviceIds();

            return this.availableItems.filter(item => !selectedIds.has(item.id));
          },

          // è·å–ä¸‹ä¸€ä¸ªæ¨¡æ¿çš„é¡ºåºå·
          getNextTemplateOrder(compactData) {
            const existingOrders = compactData.map(item => item.templateOrder || 0);
            return Math.max(...existingOrders, -1) + 1;
          },

          // æ£€æŸ¥åœ¨æŒ‡å®šæ¨¡æ¿ä¸­æ˜¯å¦å¯ä»¥æ”¾ç½®é¡¹ç›®
          canPlaceItemInTemplate(templateItems, newItem) {
            const newOccupied = this.calculateOccupiedSlots(newItem.idx, newItem.size);

            // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
            if (newOccupied.length === 0) return false;

            // æ£€æŸ¥ä¸ç°æœ‰é¡¹ç›®çš„å†²çª
            for (const item of templateItems) {
              const existingOccupied = this.calculateOccupiedSlots(item.idx, item.size);

              // æ£€æŸ¥æ˜¯å¦æœ‰é‡å 
              const hasOverlap = newOccupied.some(slot =>
                existingOccupied.includes(slot)
              );

              if (hasOverlap) {
                return false;
              }
            }

            return true;
          },

          // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è¢«é€‰æ‹©
          isDeviceSelected(deviceId) {
            const selectedIds = this.getSelectedDeviceIds();
            return selectedIds.has(deviceId);
          },

          // è·å–è®¾å¤‡çš„é€‰æ‹©çŠ¶æ€ä¿¡æ¯
          getDeviceSelectionInfo() {
            const selectedIds = this.getSelectedDeviceIds();
            const totalDevices = this.availableItems.length;
            const selectedCount = selectedIds.size;
            const availableCount = totalDevices - selectedCount;

            return {
              total: totalDevices,
              selected: selectedCount,
              available: availableCount,
              selectedIds: Array.from(selectedIds)
            };
          },
          // ç‚¹å‡»å·²æœ‰é¡¹ç›®
          onTemplateItemClick(ti, si) {
            const groups = [
              [
                {
                  text: _('Change Type'),
                  icon: `<i class="icon f7-icons">arrow_2_squarepath</i>`,
                  onClick: () => this.openPicker(ti, si),
                },
                {
                  text: _('Clear'),
                  color: 'red',
                  onClick: () => this.clearItem(ti, si),
                },
              ],
              [{ text: _('Cancel'), color: 'gray' }]
            ];
            const act = $f7.actions.create({ 
              buttons: groups,
              cssClass: 'template-actions-sheet'
            });
            act.open();
          },
          // è·å–å•å…ƒæ ¼çš„CSSç±»
          getCellClasses(ti, si) {
            const slot = this.templates[ti].slots[si];
            if (!slot || slot.isPlaceholder) return '';
            
            return `cell-filled cell-span-${slot.width}x${slot.height}`;
          },
          // è·å–å•å…ƒæ ¼çš„æ ·å¼
          getCellStyle(ti, si) {
            const slot = this.templates[ti].slots[si];
            if (!slot || slot.isPlaceholder) return {};

            const width = slot.width || 1;
            const height = slot.height || 1;

            return {
              gridColumn: `span ${width}`,
              gridRow: `span ${height}`
            };
          },

          // ç»Ÿè®¡æ–¹æ³•
          getTotalDevices() {
            let total = 0;
            this.templates.forEach(template => {
              if (template.slots) {
                total += template.slots.filter(slot => slot && !slot.isPlaceholder).length;
              }
            });
            return total;
          },

          getTotalRooms() {
            let total = 0;
            this.templates.forEach(template => {
              if (template.roomName) {
                total++;
              }
            });
            return total;
          },
        },
        computed: {},
        beforeDestroy() {},
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  /* é¡µé¢èƒŒæ™¯æ¸å˜ */
  .page-bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }

  /* é¡µé¢å¤´éƒ¨ */
  .page-header {
    text-align: center;
    padding: 24px 16px 16px;
    margin-bottom: 8px;
  }

  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .page-subtitle {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.85);
    margin: 0;
    font-weight: 400;
  }

  /* æ¨¡æ¿å¡ç‰‡ */
  .template-card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    margin: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
    backdrop-filter: blur(4px);
    transition: all 0.3s ease;
  }

  .template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(31, 38, 135, 0.3);
  }

  /* æ¨¡æ¿å¤´éƒ¨ - Framework7 é£æ ¼ */
  .template-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .template-room-container {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  .template-room-selector {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 200px;
  }

  .template-room-selector:hover {
    background: #e9ecef;
    border-color: #ced4da;
  }

  .template-room-selector:active {
    background: #dee2e6;
    transform: scale(0.98);
  }

  .template-room-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .room-icon {
    color: #6c757d;
    font-size: 18px;
  }

  .template-room-name {
    font-size: 16px;
    font-weight: 400;
    color: #495057;
    flex: 1;
  }

  .template-room-name.selected {
    color: #212529;
    font-weight: 500;
  }

  .room-arrow {
    color: #6c757d;
    font-size: 16px;
    transition: transform 0.2s ease;
  }

  .template-room-selector:hover .room-arrow {
    color: #495057;
  }

  .template-delete {
    color: #dc3545;
    font-size: 18px;
    padding: 6px 10px;
    border-radius: 6px;
    transition: all 0.2s ease;
    margin-left: 12px;
  }

  .template-delete:hover {
    background: rgba(220, 53, 69, 0.1);
  }

  .template-delete:active {
    background: rgba(220, 53, 69, 0.2);
    transform: scale(0.95);
  }

  /* æ¨¡æ¿ç½‘æ ¼ - 3è¡Œ4åˆ— */
  .template-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4åˆ— */
    grid-template-rows: repeat(3, 1fr);    /* 3è¡Œ */
    gap: 12px;
    padding: 4px;
    min-height: 280px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œé˜²æ­¢ç¼©å° */
  }

  .template-cell {
    aspect-ratio: 1;
    position: relative;
    min-width: 0; /* é˜²æ­¢æº¢å‡º */
    min-height: 0; /* é˜²æ­¢æº¢å‡º */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* è·¨æ ¼å­çš„å•å…ƒæ ¼ */
  .template-cell.cell-filled {
    aspect-ratio: auto; /* å–æ¶ˆå›ºå®šæ¯”ä¾‹ï¼Œè®©gridæ§åˆ¶ */
  }

  /* éšè—çš„å ä½ç¬¦å•å…ƒæ ¼ */
  .template-cell.cell-placeholder {
    display: none !important;
  }

  /* å•å…ƒæ ¼æŒ‰é’® */
  .cell-button {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 16px;
    padding: 0;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  /* ç©ºå•å…ƒæ ¼æ ·å¼ */
  .cell-empty {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    border: 2px dashed rgba(102, 126, 234, 0.3);
  }

  .cell-empty:active {
    transform: scale(0.95);
    border-color: rgba(102, 126, 234, 0.6);
  }

  .cell-empty .icon-plus {
    color: rgba(102, 126, 234, 0.6);
    font-size: 32px;
    transition: all 0.3s ease;
  }

  .cell-empty:active .icon-plus {
    color: #667eea;
    transform: rotate(90deg);
  }

  /* å·²å¡«å……å•å…ƒæ ¼æ ·å¼ */
  .cell-filled-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .cell-filled-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
  }

  .cell-filled-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0) 100%);
    border-radius: 16px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .cell-filled-btn:active::before {
    opacity: 1;
  }

  /* å•å…ƒæ ¼å†…å®¹ */
  .cell-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 4px;
    position: relative;
    z-index: 1;
  }

  .cell-icon {
    font-size: 28px;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: font-size 0.3s ease;
  }

  .cell-label {
    font-size: 11px;
    font-weight: 500;
    color: rgba(102, 126, 234, 0.7);
    text-align: center;
    letter-spacing: 0.3px;
    transition: font-size 0.3s ease;
  }

  .cell-filled-btn .cell-label {
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  /* ä¸åŒå°ºå¯¸çš„å•å…ƒæ ¼æ ·å¼ */
  /* 2x1 æ¨ªå‘åŒæ ¼ */
  .cell-span-2x1 .cell-icon {
    font-size: 36px;
  }

  .cell-span-2x1 .cell-label {
    font-size: 13px;
  }

  .cell-span-2x1 .cell-inner {
    flex-direction: row;
    gap: 8px;
  }

  /* 1x2 çºµå‘åŒæ ¼ */
  .cell-span-1x2 .cell-icon {
    font-size: 36px;
  }

  .cell-span-1x2 .cell-label {
    font-size: 13px;
  }

  /* 2x2 å¤§å‹æ–¹å— */
  .cell-span-2x2 .cell-icon {
    font-size: 48px;
  }

  .cell-span-2x2 .cell-label {
    font-size: 16px;
  }

  /* 3x1 é•¿æ¨ªæ¡ */
  .cell-span-3x1 .cell-icon {
    font-size: 40px;
  }

  .cell-span-3x1 .cell-label {
    font-size: 14px;
  }

  .cell-span-3x1 .cell-inner {
    flex-direction: row;
    gap: 10px;
  }

  /* 1x3 é•¿çºµæ¡ */
  .cell-span-1x3 .cell-icon {
    font-size: 42px;
  }

  .cell-span-1x3 .cell-label {
    font-size: 14px;
  }

  /* 4x1 è¶…é•¿æ¨ªæ¡ */
  .cell-span-4x1 .cell-icon {
    font-size: 38px;
  }

  .cell-span-4x1 .cell-label {
    font-size: 14px;
  }

  .cell-span-4x1 .cell-inner {
    flex-direction: row;
    gap: 12px;
  }

  /* æ–°å¢æ¨¡æ¿æŒ‰é’®åŒºåŸŸ */
  .add-template-section {
    padding: 24px 16px 32px;
    text-align: center;
  }

  /* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
  .debug-info {
    margin-top: 16px;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    backdrop-filter: blur(4px);
  }

  .debug-text {
    margin: 0;
    font-size: 13px;
    color: #666;
    font-weight: 500;
    text-align: center;
  }

  .button-add-template {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 32px;
    background: rgba(255, 255, 255, 0.95);
    color: #667eea;
    border: none;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 6px 20px rgba(31, 38, 135, 0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
  }

  .button-add-template:active {
    transform: scale(0.96);
    box-shadow: 0 4px 16px rgba(31, 38, 135, 0.3);
  }

  .button-add-template .icon {
    font-size: 22px;
    transition: transform 0.3s ease;
  }

  .button-add-template:active .icon {
    transform: rotate(90deg);
  }

  /* è¿‡æ¸¡åŠ¨ç”» */
  .fade-scale-enter-active, .fade-scale-leave-active {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .fade-scale-enter, .fade-scale-leave-to {
    opacity: 0;
    transform: scale(0.8);
  }

  /* äº¤äº’åé¦ˆåŠ¨ç”» */
  .template-cell {
    transition: all 0.2s ease;
  }

  .template-room-selector {
    transition: all 0.2s ease;
  }

  .cell-button {
    transition: all 0.2s ease;
  }

  /* åŠ è½½çŠ¶æ€ */
  .cell-loading {
    opacity: 0.6;
    transform: scale(0.95);
    pointer-events: none;
  }

  /* è„‰å†²åŠ¨ç”»æ•ˆæœ */
  @keyframes pulse {
    0% {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    50% {
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
    }
    100% {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
  }

  .cell-filled-btn:hover {
    animation: pulse 2s infinite;
  }

  /* Sheet Modal æ ·å¼ - é€‰æ‹©å™¨ */
  .item-picker-sheet {
    height: 75vh;
    max-height: 650px;
    border-radius: 24px 24px 0 0;
    overflow: hidden;
  }

  /* å·¥å…·æ æ ·å¼ */
  .item-picker-sheet .picker-toolbar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff;
    box-shadow: 0 2px 16px rgba(102, 126, 234, 0.3);
    --f7-toolbar-height: 50px;
  }

  .item-picker-sheet .picker-toolbar .title {
    color: #ffffff;
    font-weight: 700;
    font-size: 18px;
    letter-spacing: 0.3px;
  }

  .item-picker-sheet .picker-close-btn {
    color: #ffffff;
    font-weight: 600;
    font-size: 16px;
    opacity: 0.95;
  }

  /* æœç´¢æ åŒºåŸŸ */
  .item-picker-sheet .picker-searchbar-wrap {
    background: #ffffff;
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .item-picker-sheet .picker-searchbar {
    margin: 0;
    background: #f5f7fa;
    border-radius: 12px;
    box-shadow: none;
    overflow: hidden;
  }

  .item-picker-sheet .picker-searchbar .searchbar-inner {
    padding: 0;
  }

  .item-picker-sheet .picker-searchbar .searchbar-input-wrap {
    height: 44px;
    padding: 0 12px;
    background: #f5f7fa;
  }

  .item-picker-sheet .picker-searchbar input {
    font-size: 15px;
    color: #333;
    background: transparent;
  }

  .item-picker-sheet .picker-searchbar input::placeholder {
    color: #999;
  }

  .item-picker-sheet .picker-searchbar .searchbar-icon {
    color: #667eea;
    font-size: 20px;
  }

  .item-picker-sheet .picker-searchbar .input-clear-button {
    color: #999;
  }

  /* é¡µé¢å†…å®¹åŒºåŸŸ */
  .item-picker-sheet .picker-page-content {
    background: #ffffff;
    padding-top: 0;
  }

  .item-picker-sheet .picker-item-list {
    margin: 0;
    background: #ffffff;
  }

  .item-picker-sheet .picker-item-list ul {
    background: #ffffff;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .item-picker-sheet .picker-item-list li {
    list-style: none;
  }

  /* åˆ†ç±»æ ‡é¢˜ */
  .item-picker-sheet .picker-category-divider {
    background: #fafbfc !important;
    border: none !important;
    padding: 12px 16px 8px !important;
    margin-top: 8px !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    list-style: none;
  }

  .item-picker-sheet .picker-category-divider:first-child {
    margin-top: 0 !important;
  }

  .item-picker-sheet .category-badge {
    display: inline-block;
    padding: 4px 12px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
    color: #667eea;
    font-weight: 600;
    font-size: 12px;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* åˆ—è¡¨é¡¹æ ·å¼ */
  .item-picker-sheet .control-picker-list-item {
    background: #ffffff;
    transition: all 0.2s ease;
    cursor: pointer;
    list-style: none;
    border: none;
    border-radius: 0;
    box-shadow: none;
    margin: 0;
    padding: 0;
  }

  .item-picker-sheet .control-picker-item-content {
    padding: 12px 16px;
    min-height: 72px;
    display: flex;
    align-items: center;
    background: #ffffff;
    border: none;
    border-radius: 0;
  }

  .item-picker-sheet .control-picker-list-item:active {
    background: rgba(102, 126, 234, 0.05);
  }

  .item-picker-sheet .control-picker-list-item + .control-picker-list-item {
    border-top: 1px solid rgba(0, 0, 0, 0.04);
  }

  .item-picker-sheet .control-picker-text-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
    padding-left: 12px;
  }

  .item-picker-sheet .control-picker-title-row {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* å›¾æ ‡æ ·å¼ */
  .item-picker-sheet .control-picker-icon-wrap {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .item-picker-sheet .control-picker-icon-bg {
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    transition: all 0.3s ease;
  }

  .item-picker-sheet .control-picker-list-item:active .control-picker-icon-bg {
    transform: scale(0.95);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .item-picker-sheet .control-picker-icon-bg .icon {
    font-size: 26px;
    color: #ffffff;
  }

  /* æ–‡å­—æ ·å¼ */
  .item-picker-sheet .control-picker-title {
    font-weight: 600;
    font-size: 16px;
    color: #222;
    letter-spacing: 0.2px;
    flex: 1;
  }

  .item-picker-sheet .control-picker-subtitle {
    font-size: 13px;
    color: #888;
    font-weight: 400;
    margin-top: 4px;
  }

  .item-picker-sheet .control-picker-description {
    font-size: 11px;
    color: #aaa;
    font-weight: 400;
    margin-top: 2px;
    font-style: italic;
  }

  .item-picker-sheet .control-picker-arrow {
    color: #ccc;
    font-size: 18px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
  }

  .item-picker-sheet .control-picker-arrow .icon {
    font-size: 20px;
  }

  /* é€‰æ‹©çŠ¶æ€ä¿¡æ¯æ ·å¼ */
  .item-picker-sheet .picker-status-item {
    background: #f8f9fa !important;
    border: none !important;
    padding: 8px 16px !important;
    margin: 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    list-style: none;
  }

  .item-picker-sheet .picker-status-content {
    padding: 8px 16px;
    min-height: 40px;
    display: flex;
    align-items: center;
    background: #f8f9fa;
    border: none;
    border-radius: 0;
  }

  .item-picker-sheet .picker-status-info {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .item-picker-sheet .picker-status-text {
    font-size: 13px;
    color: #666;
    font-weight: 500;
    text-align: center;
  }

  /* ç©ºé€‰æ‹©é¡¹æ ·å¼ */
  .item-picker-sheet .picker-empty-item {
    background: #ffffff !important;
    border: none !important;
    padding: 16px !important;
    margin: 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    list-style: none;
  }

  .item-picker-sheet .picker-empty-content {
    padding: 20px 16px;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #ffffff;
    border: none;
    border-radius: 0;
    text-align: center;
  }

  .item-picker-sheet .picker-empty-content .icon {
    font-size: 36px;
    color: #28a745;
    margin-bottom: 8px;
  }

  .item-picker-sheet .picker-empty-text {
    font-size: 15px;
    color: #666;
    font-weight: 500;
    text-align: center;
    line-height: 1.4;
  }

  /* ç©ºçŠ¶æ€æ ·å¼ */
  .item-picker-sheet .picker-empty-state {
    display: none;
    text-align: center;
    padding: 80px 40px;
  }

  .item-picker-sheet .picker-empty-state .icon {
    font-size: 64px;
    color: #ddd;
    margin-bottom: 16px;
  }

  .item-picker-sheet .picker-empty-state p {
    font-size: 17px;
    font-weight: 600;
    color: #666;
    margin: 0 0 8px 0;
  }

  .item-picker-sheet .picker-empty-state span {
    font-size: 14px;
    color: #999;
  }

  /* Framework7 Actions æ ·å¼ä¼˜åŒ– */
  .template-actions-sheet.actions-modal {
    background: transparent;
  }

  .template-actions-sheet .actions-group {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    margin: 8px 16px;
    overflow: hidden;
  }

  .template-actions-sheet .actions-button {
    font-size: 17px;
    padding: 16px;
    min-height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: background 0.2s ease;
  }

  .template-actions-sheet .actions-button:last-child {
    border-bottom: none;
  }

  .template-actions-sheet .actions-button:active {
    background: rgba(102, 126, 234, 0.08);
  }

  .template-actions-sheet .actions-button-bold {
    font-weight: 600;
  }

  .template-actions-sheet .actions-button-color-red {
    color: #ff3b30;
  }

  .template-actions-sheet .actions-button-color-red:active {
    background: rgba(255, 59, 48, 0.08);
  }

  .template-actions-sheet .actions-button-color-gray {
    color: #8e8e93;
    font-weight: 500;
  }

  .template-actions-sheet .actions-button .icon {
    margin-right: 12px;
    font-size: 24px;
    vertical-align: middle;
    color: #667eea;
  }

  .template-actions-sheet .actions-button-media {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    text-align: left;
    padding-left: 20px;
  }

  .template-actions-sheet .actions-label {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    margin: 8px 16px 16px;
    padding: 12px 16px;
    text-align: center;
    font-size: 13px;
    color: #8e8e93;
  }

  /* å“åº”å¼ä¼˜åŒ– */
  @media (max-width: 375px) {
    .template-grid {
      gap: 8px;
      min-height: 240px; /* å°å±æœ€å°é«˜åº¦ */
    }
    
    .cell-icon {
      font-size: 24px;
    }
    
    .cell-label {
      font-size: 10px;
    }
    
    .page-title {
      font-size: 24px;
    }
  }

  @media (min-width: 376px) and (max-width: 767px) {
    .template-grid {
      min-height: 280px; /* ä¸­ç­‰å±å¹•æœ€å°é«˜åº¦ */
    }
  }

  @media (min-width: 768px) {
    .template-card {
      margin: 24px auto;
      max-width: 700px;
    }
    
    .template-grid {
      min-height: 320px; /* å¤§å±æœ€å°é«˜åº¦ */
      gap: 16px;
    }
  }

  @media (min-width: 1024px) {
    .template-card {
      max-width: 800px;
    }
    
    .template-grid {
      min-height: 360px; /* è¶…å¤§å±æœ€å°é«˜åº¦ */
    }
  }
</style>
