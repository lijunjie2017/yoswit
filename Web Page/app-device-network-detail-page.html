<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Add Device Network') }}</div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="main-box">
          <div class="block mx-3 margin-top">
            <p class="segmented segmented-strong">
              <button class="button" :class="index == 0?'button-active button':'button'" v-on:click="toTab(0)">{{_('Step')}} 1</button>
              <button class="button" :class="index == 1?'button-active button':'button'" v-on:click="toTab(1)">{{_('Step')}} 2</button>
              <button class="button" :class="index == 2?'button-active button':'button'" v-on:click="toTab(2)">{{_('Step')}} 3</button>
              <span class="segmented-highlight"></span>
            </p>
          </div>
          <div class="tabs">
            <div id="step-0" class="view tab view-main" :class="[index == 0 ? 'tab-active' : '']" v-if="index == 0">
              <!-- choose device div start -->
              <div class="block-title" style="overflow: initial">{{_("Choose Devices")}}</div>
              <div class="list media-list no-margin list-group" v-if="totalDevices != 0">
                <ul>
                  <li class="list-group-title display-flex justify-content-space-between">
                    <span>{{_('Network')}} {{networkIndex}}</span>
                    <div class="item-after"><span class="badge color-blue">{{totalDevices}}</span></div>
                  </li>
                  <div v-for="(item,index) in deviceList" :key="item.name">
                    <li class="device mobmob-device swipeout" v-if="dealwithShow(item)">
                      <div class="item-content swipeout-content">
                        <label class="checkbox" style="padding-left: 20px; padding-right: 20px"
                          ><input v-on:click="changeVal(item)" type="checkbox" :checked="item.checked?true:false" /><i
                            class="icon-checkbox"
                          ></i
                        ></label>
                        <div
                          class="item-media"
                          :style="{'background-image' : 'url('+erp.get_url(item.image?item.image:imgError)+')'}"
                        ></div>
                        <div class="item-inner">
                          <div class="item-title-row" style="margin-top: 10px">
                            <div class="item-title">{{item.device_model}} - {{item.device_name.substring(0,12)}}</div>
                          </div>
                          <div class="item-subtitle text-muted">{{item.roomInfo}}</div>
                        </div>
                        <div class="control-panel-right"></div>
                      </div>
                    </li>
                  </div>
                </ul>
              </div>
              <!-- unnasiggned start -->
              <div class="list media-list no-margin list-group" v-if="uncatDevices != 0">
                <ul>
                  <li class="list-group-title display-flex justify-content-space-between">
                    <span>{{_('Unassigned')}}</span>
                    <div class="item-after"><span class="badge color-blue">{{uncatDevices}}</span></div>
                  </li>
                  <div v-for="(item,index) in uncatDeviceList" :key="item.name">
                    <li class="device mobmob-device swipeout" v-if="item.network_id == 0">
                      <div class="item-content swipeout-content">
                        <label class="checkbox" style="padding-left: 20px; padding-right: 20px"
                          ><input v-on:click="changeUcatVal(item)" type="checkbox" :checked="item.checked?true:false" /><i
                            class="icon-checkbox"
                          ></i
                        ></label>
                        <div
                          class="item-media"
                          :style="{'background-image' : 'url('+erp.get_url(item.image?item.image:imgError)+')'}"
                        ></div>
                        <div class="item-inner">
                          <div class="item-title-row" style="margin-top: 10px">
                            <div class="item-title">{{item.device_model}} - {{item.device_name.substring(0,12)}}</div>
                          </div>
                          <div class="item-subtitle text-muted">{{item.roomInfo}}</div>
                        </div>
                        <div class="control-panel-right"></div>
                      </div>
                    </li>
                  </div>
                </ul>
              </div>
              <!-- unnasiggned end -->
              <!-- choose device div end -->
              <div class="device-null" v-if="totalDevices == 0 && uncatDevices == 0">
                <div class="block" style="text-align: center">
                  <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                  <p>${_('You don\'t have any devices, create one')}</p>
                </div>
                <div class="block block-strong">
                  <p class="row">
                    <a class="col button button-large" v-on:click="createDevice()">{{ _('Create Device') }}</a>
                  </p>
                </div>
              </div>
              <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                <div class="col">
                  <div class="button button-fill button-save" v-on:click="nextStep(1)">{{_("NEXT STEP")}}</div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 0 ? 'tab-active' : '']" v-if="index == 0">
              <!-- sort device div start -->

              <!-- sort device div end -->
            </div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    const { network_index, edit } = $f7route.query;
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          index: 0,
          deviceList: [],
          uncatDeviceList: [],
          postDeviceList: [],
          networkIndex: 1,
          totalDevices: 0,
          uncatDevices: 0,
          imgError: 'https://my.yoswit.com/files/products/YO2086-1G.svg',
        },
        mounted() {
          this.networkIndex = network_index && network_index != 'undefined' ? network_index : 1;
          this.init();
        },
        methods: {
          async init() {
            let devices = cloneDeep(erp.info.profile.profile_device);
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            //get the image
            devices.forEach((item) => {
              //choose status
              item.checked = true;
              if (item.device) {
                let guid = item.device;
                const hexid = guid.substring(guid.length - 6, guid.length - 2);
                const model = erp.doctype.device_model[hexid.toUpperCase()];
                item.deviceNetworkSize = model.device_network_size ? model.device_network_size : 1;
                if (!model && !model.image) {
                  item.image = model.image;
                } else {
                  item.image = '';
                }
                //filter the room info
                item.roomInfo = '';
                subdevices.forEach((kitem) => {
                  if (kitem.device == item.device && kitem.device) {
                    item.roomInfo = `${tran(kitem.room_name)}-${tran(kitem.title)}`;
                  }
                });
              }
            });
            //this.postDeviceList = devices;
            this.deviceList = devices;
            //if edit and add
            console.log('edit', edit);
            if (edit == 1) {
              this.deviceList.forEach((item) => {
                if (item.network_id != this.networkIndex) {
                  item.checked = false;
                }
              });
              this.totalDevices = cloneDeep(this.deviceList).filter((item) => item.network_id == this.networkIndex).length;
              console.log('this.totalDevices', this.totalDevices);
              this.uncatDeviceList = cloneDeep(this.deviceList).filter((item) => item.network_id == 0);
              this.uncatDeviceList.forEach((item) => {
                item.checked = false;
              });
              this.uncatDevices = this.uncatDeviceList.length;
            } else {
              let newDevices = cloneDeep(this.deviceList);
              this.totalDevices = newDevices.filter((item) => item.network_id == 0).length;
              //fliter the device in uncat,if networl size be used
              newDevices.forEach(kitem=>{
                let usedSize = 0;
                
              })
              // newDevices.forEach((item) => {
              //   console.log(item.deviceNetworkSize);
              //   if (item.deviceNetworkSize > 1) {
              //     item.network_id = 0;
              //     item.checked = false;
              //     this.uncatDeviceList.push(item);
              //   }
              // });
              // this.uncatDevices = this.uncatDeviceList.length;
            }
          },
          nextStep(index) {
            if (index == 1) {
              if (this.totalDevices == 0) {
                app.dialog.alert(_('No devices need to be networked'));
              } else {
                this.saveDeviceInNetwork();
              }
            }
          },
          dealwithShow(item) {
            if (edit == 1) {
              return item.network_id == this.networkIndex;
            } else {
              if(item.deviceNetworkSize > 1){
                return true
              }else{
                return item.network_id == this.networkIndex || item.network_id == 0;
              }
            }
          },
          createDevice() {
            mainView.router.navigate('/mobile-app/yoswit-device-type');
          },
          changeUcatVal(item) {
            item.checked = !item.checked;
            if (item.checked) {
              item.network_id = this.networkIndex;
              this.deviceList.forEach((kitem) => {
                if (kitem.device === item.device) {
                  kitem.network_id = this.networkIndex;
                  kitem.checked = true;
                }
              });
            }
            this.uncatDevices = this.uncatDeviceList.filter((kitem) => kitem.network_id == 0).length;
          },
          changeVal(item) {
            item.checked = !item.checked;
            if (edit == 1) {
              if (!item.checked) {
                item.network_id = 0;
                if (cloneDeep(this.uncatDeviceList).filter((kitem) => item.device == kitem.device).length == 0) {
                  this.uncatDeviceList.push(item);
                } else {
                  this.uncatDeviceList.forEach((kitem) => {
                    if (kitem.device == item.device) {
                      kitem.network_id = 0;
                      kitem.checked = false;
                    }
                  });
                }
              } else {
                item.network_id = this.networkIndex;
              }
              this.uncatDevices = this.uncatDeviceList.filter((kitem) => kitem.network_id == 0).length;
              let totalList = cloneDeep(this.deviceList).filter((item) => item.checked === true);
              console.log(totalList);
              this.totalDevices = cloneDeep(this.deviceList).filter((item) => item.network_id === this.networkIndex).length;
            }
          },
          async saveDeviceInNetwork() {
            app.dialog.preloader();
            this.deviceList.forEach((item) => {
              if (item.checked) {
                item.network_id = this.networkIndex;
              }
            });
            try {
              await http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
                method: 'PUT',
                responseType: 'json',
                dataType: 'json',
                responseType: 'json',
                serializer: 'json',
                timeout: 60,
                data: {
                  profile_device: this.deviceList,
                },
              });
              app.dialog.close();
              erp.info.profile.profile_device = this.deviceList;
              app.dialog.alert('Successfully');
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(error);
            }
          },
        },
        computed: {},
        beforeDestroy() {},
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>
<style>
  .checkbox i.icon-checkbox {
    opacity: 1;
  }
</style>
