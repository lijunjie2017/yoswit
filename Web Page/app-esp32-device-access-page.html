<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Add Device Access') }}</div>
        <div class="right">
          <a href="#" class="link icon-only esp-access-wifi esp-wifi">
            <i class="icon material-icons wifi-icons" ref="0">wifi</i>
          </a>
          <a href="#" class="link icon-only esp-access-bluetooth" @click="${()=>bleConnect()}">
            <i class="icon material-icons bluetooth-icons" ref="0">bluetooth</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <!-- 选择设备类型后，显示设备列表 -->
        <div>
          <div class="toolbar-box" style="padding: 0 15px; margin-top: 15px" v-if="stepList.length">
            <div class="toolbar tabbar tabbar-scrollable" style="height: 60px">
              <div class="toolbar-inner scene-toolbar-inner">
                <button
                  v-for="(item,index) in stepList"
                  :key="item.id"
                  :class="item.isActive?'button-active button':'button'"
                  v-on:click="toTab(item.relatedIndex)"
                >
                  {{_('Step')}} {{item.name}}
                </button>
              </div>
            </div>
          </div>
          <div class="tabs">
            <div id="step-1" class="view tab view-main" :class="[index == 1 ? 'tab-active' : '']" v-show="index == 1">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div class="list list-strong-ios list-outline-ios list-dividers-ios">
                    <ul>
                      <li>
                        <a class="item-link smart-select smart-select-init" data-open-in="sheet">
                          <select name="mac-windows" v-model="accessType">
                            <option value="0" selected>Door Management</option>
                            <option value="1">Dynamic QR Code</option>
                            <option value="2">QR Code</option>
                            <option value="3">Key Card</option>
                            <option value="4">Secure Key Card</option>
                            <option value="5">Octopus Card</option>
                            <option value="6">Auto Open</option>
                            <option value="7">Door Blocking Schedule</option>
                          </select>
                          <div class="item-content" style="height: 70px">
                            <div class="item-inner">
                              <div class="item-title">{{_('Access Type')}}</div>
                            </div>
                          </div>
                        </a>
                      </li>
                      <li class="item-content item-input" v-if="accessType == 1 || accessType == 1">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Guest Email")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="text"
                              name="guestEmail"
                              v-model="guestEmail"
                              :placeholder="_('Please enter the guest email.')"
                              v-on:blur="checkGuestEmail"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input" v-if="accessType == 3 || accessType == 4">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Key Card ID")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="text"
                              name="keyCardId"
                              v-model="keyCardId"
                              readonly="readonly"
                              :placeholder="_('Please enter the key card id.')"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input" v-if="accessType == 4" style="display: none">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Key Card Secret")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="text"
                              name="keyCardSecret"
                              v-model="keyCardSecret"
                              :placeholder="_('Please enter the key card secret.')"
                              readonly="readonly"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input" v-if="accessType == 5">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Octopus Card ID")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="text"
                              name="octopusCardId"
                              v-model="octopusCardId"
                              :placeholder="_('Please enter the octopus card id.')"
                              readonly="readonly"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="item-content item-input" v-if="accessType != 0">
                          <div class="item-inner">
                            <div class="item-input-wrap">
                              <input type="text" :placeholder="_('Valid From')" readonly="readonly" id="demo-calendar-date-time" />
                            </div>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="item-content item-input" v-if="accessType != 0">
                          <div class="item-inner">
                            <div class="item-input-wrap">
                              <input type="text" :placeholder="_('Valid To')" readonly="readonly" id="demo-calendar-date-time-to" />
                            </div>
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input" v-if="accessType != 0">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Access Group")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="number"
                              name="accessGroup"
                              v-model="accessGroup"
                              :placeholder="_('Please enter the access group.')"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                      <li>
                        <a class="item-link smart-select smart-select-init" data-open-in="sheet">
                          <select name="smart-select-post-type" v-model="postType">
                            <option value="1" :selected="device_type == 3 ? true : false">WIFI</option>
                            <option value="2" :selected="device_type != 3 ? true : false" v-if="device_type != 3">BLE</option>
                          </select>
                          <div class="item-content" style="height: 70px">
                            <div class="item-inner">
                              <div class="item-title">{{_('Sync Method')}}</div>
                            </div>
                          </div>
                        </a>
                      </li>
                      <li class="item-content item-input" v-if="postType == 1 && !wifiConnected && !wifiStatus">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">
                            {{_("Ssid")}}
                            <span class="text-color-red" style="font-size: 12px"> ({{_('2.4 GHz Wi-Fi Only')}})</span>
                          </div>
                          <div class="item-input-wrap">
                            <input
                              type="text"
                              name="ssid"
                              v-model="ssid"
                              :placeholder="_('Please enter the wifi ssid.')"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input" v-if="postType == 1 && !wifiConnected && !wifiStatus" style="padding-left: 15px">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Password")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="password"
                              name="password"
                              v-model="password"
                              :placeholder="_('Please enter the wifi password.')"
                              required
                              validate
                            />
                            <i
                              class="material-icons"
                              style="
                                position: absolute;
                                right: 10px;
                                top: 0px;
                                padding: 10px 0px 10px 10px;
                                font-size: 20px;
                                z-index: 999999;
                              "
                              func="show_hide_password_field"
                              >visibility_off</i
                            >
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px" v-if="accessType == 3 || accessType == 4 || accessType == 5">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="testKey()">{{_("Test")}}</div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="toTab(2)">{{_("Next")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-5" class="view tab view-main" :class="[index == 2 ? 'tab-active' : '']" v-if="index == 2">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px" v-if="accessType != 0">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in scheduleList" :key="index">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div class="item-inner">
                              <div class="item-title-row" style="margin-top: 10px">
                                <div class="item-title ellipsis" lang="en" style="width: 235px">
                                  {{item.name}}<span
                                    class="text-color-gray"
                                    v-if="item.whole_day == 1"
                                    style="margin-left: 10px; font-size: 12px"
                                    >{{_('(Whole Day)')}}</span
                                  >
                                </div>
                              </div>
                              <div class="item-subtitle ellipsis" style="width: 235px">
                                <span>{{item.from_time}} - {{item.to_time}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteSchedule(item.name)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-space-between align-items-center"
                      v-on:click="addSchedule()"
                    >
                      <div class="trigger-icon display-flex justify-content-flex-start align-items-center">
                        <i class="material-icons">add_circle</i>
                        <div class="trigger-text margin-left">{{_("Add Schedule")}}</div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="position-relative display-flex flex-direction-column justify-content-center align-items-center"
                    style="margin-top: 10px"
                    v-if="accessType == 1 || accessType == 2"
                  >
                    <img :src="qr_code_base64" style="object-fit: contain; width: 150px; height: 150px" />
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="syncToDevice()">
                      {{_("Sync To Device")}}({{isSyncSetting?_('Synced') : _('Not Synced')}})
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="toTab(1)">{{_("Previous")}}</div>
                  </div>
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="completeDeviceAccess()">{{_("Compelte")}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    let { guid, sub_name, button_group, button_group_command,device_type } = $f7route.query;
    bleConnect = async () => {
      await vueApp.connectBleAndUiHandle();
    };
    //let { guid, subdevice_name } = $f7route.query;
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          index: 1, // control the step-content
          stepList: [
            {
              id: 1,
              name: '1',
              isActive: true,
              relatedIndex: 1,
            },
            {
              id: 2,
              name: '2',
              isActive: false,
              relatedIndex: 2,
            },
          ],
          accessType: 0, //default Door Management
          guestEmail: '',
          keyCardId: '',
          keyCardSecret: '',
          octopusCardId: '',
          calendarDateTimeFrom: null,
          calendarDateTimeTo: null,
          postType: 2,
          device_type: device_type,
          ssid: '',
          password: '',
          email: '',
          iot_attempt: 0,
          postBleDataList: [],
          postBleDataListIndex: 0,
          postBleDataListChunkIndex: 0,
          uuid: '',
          qr_code_base64: '',
          scheduleList: [],
          accessGroup: 0,
          totalVailFrom: '',
          totalVailTo: '',
          qrcode_random_16: '',
          deviceAccessMap: {},
          wifiConnected: false,
          isSyncSetting: false,
          bleStatus: false,
          wifiStatus: false,
          heartbeatTimer: null,
          wifiCheckTimeout: null,
          wifiTopicHandler: null,
        },
        watch: {
          accessType: function (newVal, oldVal) {
            console.log('accessType', newVal, oldVal);
            if (newVal != 0) {
              this.initDateDom();
            }
          },
          postType: function (newVal, oldVal) {
            console.log('postType', newVal, oldVal);
            if (newVal == 1) {
              let mobmob = window.peripheral[guid].prop.is_mobmob;
              if (mobmob) {
                this.wifiConnected = true;
              } else {
                this.wifiConnected = false;
              }
            }
          },
          bleStatus(newVal) {
            $('.esp-access-bluetooth i').attr('ref', newVal ? '1' : '0');
          },
          wifiStatus(newVal) {
            $('.esp-access-wifi i').attr('ref', newVal ? '1' : '0');
          },
        },
        components: {},
        async mounted() {
          Vue.prototype.connectBleAndUiHandle = this.connectBleAndUiHandle;
          this.init();
          this.qrcode_random_16 = this.generateRandom16();
          this.generateQRCode(`{{${this.qrcode_random_16}}}`);
          emitter.on('saveSchedule', (data) => {
            console.log('saveSchedule', data);
            let list = data;
            list.forEach((item) => {
              item.schedule = item.name;
              item.doctype = 'Device Blocking Schedule';
              item.parentfield = 'blocking_schedule';
              item.parenttype = 'Device Access';
            });
            this.scheduleList = this.scheduleList.concat(data);
          });
          this.startHeartbeat();
        },
        methods: {
          initDateDom(){
            setTimeout(() => {
              app.calendar.create({
                inputEl: '#demo-calendar-date-time',
                timePicker: true,
                dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' },
              });
              app.calendar.create({
                inputEl: '#demo-calendar-date-time-to',
                timePicker: true,
                dateFormat: { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' },
              });
            }, 500);
          },
          async init() {
            this.initDateDom();
            //init the device sync type
            if(device_type == 3){
              this.postType = 1;
            }else{
              this.postType = 2;
            }
            $('select[name="smart-select-post-type"]').val(this.postType);
            //init the device wifi
            if (isset(erp.info.device) && isset(erp.info.device[guid])) {
              let device = erp.info.device[guid];
              const settings = device.settings;
              settings.forEach((item) => {
                if (item.setting_type == 'Wifi SSID') {
                  this.ssid = item.setting;
                }
                if (item.setting_type == 'Wifi Password') {
                  this.password = item.setting;
                }
                if (item.setting_type == 'Email Address') {
                  this.email = item.setting.toLowerCase();
                  this.checkIfOnline(this.email);
                }
              });
            }
            try {
              await this.requestMtuForBle();
            } catch (error) {
              console.log('error', error);
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          generateRandom16() {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyz';
            return Array.from({ length: 16 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
          },
          startHeartbeat() {
            this.stopHeartbeat(); // 防止重复开启
            this.checkBleConnection();
            this.checkWifiConnection();
            this.heartbeatTimer = setInterval(() => {
              this.checkBleConnection();
              this.checkWifiConnection();
            }, 1000 * 60);
          },
          stopHeartbeat() {
            if (this.heartbeatTimer) {
              clearInterval(this.heartbeatTimer);
              this.heartbeatTimer = null;
            }
            if (this.$wifiCheckTimeout) {
              clearTimeout(this.$wifiCheckTimeout);
              this.$wifiCheckTimeout = null;
            }
            if (this.$listenWifiFun) {
              emitter.off('iot/wifi/info', this.$listenWifiFun);
              this.$listenWifiFun = null;
            }
          },
          checkBleConnection() {
            console.log('checkBleConnectionForAccess');
            if (guid && window.peripheral && window.peripheral[guid]) {
              // 检查 BLE 连接状态
              const isConnected = window.peripheral[guid].prop.connected;
              if (this.bleStatus !== isConnected) {
                this.bleStatus = isConnected;
              }
            } else {
              this.bleStatus = false;
            }
          },
          async checkWifiConnection() {
            /*
            1. 如果有蓝牙可以通过蓝牙检测wifi的连接状况
            2. 如果没有蓝牙可以通过mqtt检测wifi的连接状况
            3. 但是进入到配置阶段，只能依靠蓝牙，所有只需要考虑蓝牙
            4. 因为需要发送蓝牙指令，这里是否需要定时检查wifi状态，可能会影响到蓝牙上传时候的状态
            */

            //设置超时处理，防止蓝牙没有任何反应
            if (this.$wifiCheckTimeout) {
              clearTimeout(this.$wifiCheckTimeout);
              this.$wifiCheckTimeout = null;
            }
            //清理旧的监听，防止多次绑定
            if (this.$listenWifiFun) {
              emitter.off('iot/wifi/info', this.$listenWifiFun);
              this.$listenWifiFun = null;
            }

            this.$wifiCheckTimeout = setTimeout(() => {
              this.wifiStatus = false;
              // 超时也要清理监听
              if (this.$listenWifiFun) {
                emitter.off('iot/wifi/info', this.$listenWifiFun);
                this.$listenWifiFun = null;
              }
            }, 10000);

            this.$listenWifiFun = (data) => {
              console.log('data', data);
              try {
                let rs = data.rs;
                if (rs && rs.length > 10) {
                  let jsonData = JSON.parse(this.hexToPlainText(rs.substring(10, rs.length)));
                  console.log('jsonData', jsonData);
                  if (isset(jsonData)) {
                    if (isset(jsonData.ipv4)) {
                      this.wifiStatus = true;
                    } else {
                      this.wifiStatus = false;
                    }
                  }
                }
              } catch (e) {
                console.error('checkWifiConnection error:', e);
              } finally {
                clearTimeout(this.$wifiCheckTimeout);
                this.$wifiCheckTimeout = null;
                emitter.off('iot/wifi/info', this.$listenWifiFun);
                this.$listenWifiFun = null;
              }
            };
            try {
              emitter.on('iot/wifi/info', this.$listenWifiFun);
              await window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: '9329',
                },
              ]);
            } catch (error) {
              console.log(erp.get_log_description(error));
              // 发送失败也要清理
              if (this.$listenWifiFun) {
                emitter.off('iot/wifi/info', this.$listenWifiFun);
                this.$listenWifiFun = null;
              }
              if (this.$wifiCheckTimeout) {
                clearTimeout(this.$wifiCheckTimeout);
                this.$wifiCheckTimeout = null;
              }
              this.wifiStatus = false;
            }
          },
          hexToPlainText(hexString) {
            // 使用正则表达式检查输入是否是合法的十六进制字符串
            const hexPattern = /^[0-9A-Fa-f]+$/;
            if (!hexPattern.test(hexString)) {
              throw new Error('Invalid HEX input. Only hexadecimal characters (0-9, A-F) are allowed.');
            }

            // 将十六进制字符串转换为字节数组
            const byteArray = [];
            for (let i = 0; i < hexString.length; i += 2) {
              byteArray.push(parseInt(hexString.substr(i, 2), 16));
            }

            // 使用TextDecoder将字节数组转换为普通字符
            const decoder = new TextDecoder();
            const plainText = decoder.decode(new Uint8Array(byteArray));

            return plainText;
          },
          connectBleAndUiHandle() {
            return new Promise(async (resolve, reject) => {
              console.log('bleConnect');
              if (guid && window.peripheral && window.peripheral[guid]) {
                try {
                  $('.esp-access-bluetooth i').attr('ref', '2');
                  await window.peripheral[guid].connect();
                  $('.esp-access-bluetooth i').attr('ref', '1');
                  resolve();
                } catch (error) {
                  $('.esp-access-bluetooth i').attr('ref', '0');
                  app.dialog.alert(_(erp.get_log_description(error)));
                  reject();
                }
              } else {
                $('.esp-access-bluetooth i').attr('ref', '0');
                app.dialog.alert(_('Device not found'));
                reject();
              }
            });
          },
          deleteSchedule(name) {
            this.scheduleList = this.scheduleList.filter((item) => item.name != name);
          },
          async testKey() {
            //confirm the
            if (window.peripheral[guid].prop.connected) {
              await window.peripheral[guid].disconnect();
            } else {
              await window.peripheral[guid].connect();
            }
            this.$getKeyCardId = (data) => {
              console.log('data', data);
              if (data.rs.length >= 20) {
                this.keyCardId = data.rs.slice(-8);
                if (this.accessType == 4) {
                  this.keyCardSecret = '832227680083';
                }
              }
            };
            if (this.$getKeyCardId) {
              emitter.off('key_card_id', this.$getKeyCardId);
            }
            emitter.on('key_card_id', this.$getKeyCardId);
            // await ble.startNotification(this.uuid, 'ff80', 'ff82', (rs) => {
            //   console.log('rs', rs);
            //   if (rs.length >= 20) {
            //     this.keyCardId = rs.slice(-8);
            //     if (this.accessType == 4) {
            //       this.keyCardSecret = '832227680083';
            //     }
            //   }
            // },(error)=>{
            //   console.log('error', error);
            // });
            setTimeout(async () => {
              let command = `9931000001${this.accessType == 3 ? '00' : '01'}`;
              await window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: command.toLocaleLowerCase(),
                },
              ]);
            }, 200);
            app.dialog.alert(
              _('Align your card (e.g., access card) with the D-card reader. Keep it steady until the device completes recognition.')
            );
          },
          startQrcodeSetTimer() {
            if (this.$qrcodeSetTimer) {
              clearInterval(this.$qrcodeSetTimer);
            }
            this.$qrcodeSetTimer = setInterval(() => {
              this.checkGuestEmail();
            }, 10 * 1000);
          },
          checkGuestEmail() {
            console.log('checkGuestEmail', this.guestEmail);
            let md_str = md5(md5(this.guestEmail) + this.guestEmail + 'yoswit');
            let date_time = DateFormatter.format(new Date(), 'YmdHis');
            let str = `${md_str}${date_time}`;
            let checksum = md5(`${md5(str) + str + 'yoswit'}`);
            let qr_str = `{{${md_str}${checksum}${date_time}}}`;
            console.log('qr_str', qr_str);
            this.generateQRCode(qr_str);
          },
          generateQRCode(value) {
            cordova.plugins.qrcodejs.encode(
              'TEXT_TYPE',
              value,
              (base64EncodedQRImage) => {
                this.qr_code_base64 = base64EncodedQRImage;
              },
              (err) => {
                console.error('qrcode js error: ' + err);
              },
              {
                correctLevel: 0,
              }
            );
          },
          activeStep() {
            this.stepList.forEach((item) => {
              if (item.id == this.index) {
                item.isActive = true;
              } else {
                item.isActive = false;
              }
            });
          },
          //sync to device with ble or wifi
          syncToDevice() {
            if (this.postType == 1) {
              //wifi
              this.syncToDeviceWithWifi();
            } else {
              //ble
              this.syncToDeviceWithBle();
            }
          },
          completeDeviceAccess() {
            console.log('completeDeviceAccess');
            //此处需要判断一下，如果是选择的是door management，则不需要生成一条access的记录
            if (this.accessType != 0) {
              emitter.emit('saveDeviceAccess', this.deviceAccessMap);
            }else{
              emitter.emit('saveDeviceAccess', [{
                access_type: 'Door Management',
                blocking_schedule : []
              }]);
            }
            mainView.router.back();
          },
          //发送后开始监听蓝牙的notify,通过emitter来监听
          /*
          options = {
             require9900: true/false, // 是否需要等待 9900 响应
             require9901: true/false  // 是否需要等待 9901 响应
          }
          */
          startListenBleNotify(options = { require9900: true, require9901: true }) {
            return new Promise((resolve, reject) => {
              /*
              这里又两个逻辑需要处理
              1. 理论上是要获取990000000164和990100000164两个值，只是有收到这两个值才能算是全部同步成功
              2. 是通过最后一个字节来判断的，转成10进制后，如果是100，则算同步成功，否者需要截取减掉100后的值为错误码；
              3. 这是一个总体的监听，需要设置1分钟的超时，如果1分钟后没有收到这两个值，则算同步失败，并弹出错误码；
              4. 需要首先对收到的数据进行长度判断，如果长度少于12，则直接过滤；
              */
              const ERROR_CODES = {
                1: _('Offline Mode'),
                2: _('HTTP Request Failed'),
                3: _('IP Disconnected'),
                4: _('HTTP Status Error'),
                5: _('JSON Parse Error'),
                6: _('Get Result Error'),
                7: _('Database Open Failed'),
                8: _('Database Run Error'),
                9: _('Database Not Found'),
                10: _('Prepare Statement Failed'),
                11: _('JSON Print Error'),
                12: _('Invalid Parameter'),
                13: _('Unsupported Access Type'),
                14: _('Key Card Timeout'),
                15: _('Key Card Encrypted'),
                16: _('Key Card Parse Error'),
                17: _('Unknown Access Type'),
                18: _('Blocking Schedule Error'),
                155: _('Device Access Failed')
              };

              // 初始化接收状态，如果不需要接收某个指令，则默认设为 true
              let received9900 = !options.require9900;
              let received9901 = !options.require9901;

              const cleanup = () => {
                if (this.listenBleNotify) {
                  emitter.off('upload/notify', this.listenBleNotify);
                  this.listenBleNotify = null;
                }
                if (this.listenBleNotifyTimeout) {
                  clearTimeout(this.listenBleNotifyTimeout);
                  this.listenBleNotifyTimeout = null;
                }
              };
              
              cleanup();

              this.listenBleNotifyTimeout = setTimeout(() => {
                cleanup();
                reject(new Error(_('Sync Timeout')));
              }, 60000);

              this.listenBleNotify = (data) => {
                let res = data.rs;
                console.log('upload/notify res', res);
                if (!res || res.length < 12) return;

                const prefix = res.substring(0, 4);
                // 只处理我们关心的指令
                if (prefix !== '9900' && prefix !== '9901') return;
                // 如果收到了不需要关心的指令，也直接返回，避免逻辑干扰（虽然上面已经初始化为true）
                if (prefix === '9900' && !options.require9900) return;
                if (prefix === '9901' && !options.require9901) return;

                const statusHex = res.substring(res.length - 2);
                const status = parseInt(statusHex, 16);

                if (status >= 0 && status < 100) {
                  // Ignore, maybe log it
                  console.log('Status ignored (0-99):', status);
                  return;
                }

                if (status === 100) {
                  if (prefix === '9900') received9900 = true;
                  if (prefix === '9901') received9901 = true;
                  
                  if (received9900 && received9901) {
                    cleanup();
                    resolve(true);
                  }
                } else if (status > 100) {
                  const code = status - 100;
                  const msg = ERROR_CODES[code] || _('Unknown Error');
                  cleanup();
                  reject(new Error(msg));
                }
              };

              emitter.on('upload/notify', this.listenBleNotify);
            });
          },
          async syncToDeviceWithWifi() {
            //判断如果选择的是door management，则只需要同步device
            if (this.accessType == 0) {
              try{
                app.dialog.preloader(_('Syncing to device...'));
                let settings = await this.upDateDeviceSettings();
                await window.peripheral[guid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: '9901',
                  },
                ]);
                let status = await this.startListenBleNotify({ require9900: false, require9901: true });
                debugger
                if(status){
                  app.dialog.close();
                  app.dialog.alert(_('Sync to device success.'));
                  this.isSyncSetting = true;
                }else{
                  app.dialog.close();
                  app.dialog.alert(_('Sync to device failed.'));
                  this.isSyncSetting = false;
                }
              }catch(error){
                app.dialog.close();
                app.dialog.alert(erp.get_log_description(error));
              }
              return;
            }
            app.dialog.preloader(_('Getting device access...'));
            try {
              let result = await http2.request({
                url: encodeURI('/api/method/appv6.getDeviceAccessByDevice'),
                responseType: 'json',
                debug: true,
                method: 'POST',
                serializer: 'json',
                data: {
                  device: guid,
                  access_type: this.getAccessTypeTitle(this.accessType),
                },
              });
              console.log('result', result);
              app.dialog.close();
              if (result.status == 200) {
                let data = result.data.data;
                let postScheduleList = [];
                this.scheduleList.forEach((item) => {
                  postScheduleList.push({
                    schedule: item.schedule,
                    from_time: item.from_time,
                    to_time: item.to_time,
                    whole_day: item.whole_day,
                  });
                });
                if (data.length == 0) {
                  //erp have no record
                  let deviceAccessMap = {
                    device: guid,
                    access_type: this.getAccessTypeTitle(this.accessType),
                    status: 'Pending',
                    device_button_group: button_group,
                    one_time_access: '',
                    guest_email: this.guestEmail,
                    valid_from: this.totalVailFrom,
                    valid_to: this.totalVailTo,
                    blocking_schedule: postScheduleList,
                    access_level: this.accessGroup,
                    qr_code: this.qrcode_random_16,
                    key_card_id: this.keyCardId,
                    key_card_secret: this.keyCardSecret,
                    octopus_card_id: this.octopusCardId,
                    blocking_schedule: postScheduleList,
                    access_level: this.accessGroup,
                  };
                  try {
                    app.dialog.preloader(_('Saving device access...'));
                    let respone = await http2.request({
                      url: encodeURI('/api/resource/Device Access'),
                      responseType: 'json',
                      method: 'POST',
                      serializer: 'json',
                      debug: true,
                      data: deviceAccessMap,
                    });
                    console.log('respone', respone);
                    this.deviceAccessMap = respone.data.data;
                    app.dialog.close();
                    let settings = await this.upDateDeviceSettings();
                    await window.peripheral[guid].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: '9900',
                      },
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: '9901',
                      },
                    ]);
                    app.dialog.close();
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(error);
                  }
                } else {
                  let deviceAccessMap = data[0];
                  let accessType = this.getAccessTypeTitle(this.accessType);
                  deviceAccessMap.access_type = accessType;
                  deviceAccessMap.access_level = this.accessGroup;
                  deviceAccessMap.status = 'Pending';
                  deviceAccessMap.device_button_group = button_group;
                  deviceAccessMap.blocking_schedule = postScheduleList;
                  //send the ble data to the device
                  if (this.accessType == 1) {
                    //ble
                    deviceAccessMap.guest_email = this.guestEmail;
                    deviceAccessMap.valid_from = this.totalVailFrom;
                    deviceAccessMap.valid_to = this.totalVailTo;
                  } else if (this.accessType == 3) {
                    deviceAccessMap.key_card_id = this.keyCardId;
                  } else if (this.accessType == 4) {
                    deviceAccessMap.key_card_id = this.keyCardId;
                    deviceAccessMap.key_card_secret = this.keyCardSecret;
                  } else if (this.accessType == 5) {
                    deviceAccessMap.octopus_card_id = this.octopusCardId;
                  } else if (this.accessType == 6) {
                    deviceAccessMap.valid_from = this.totalVailFrom;
                    deviceAccessMap.valid_to = this.totalVailTo;
                  }
                  console.log('deviceAccessMap', deviceAccessMap);
                  try {
                    app.dialog.preloader(_('Saving device access...'));
                    let respone = await http2.request({
                      url: encodeURI('/api/resource/Device Access/' + deviceAccessMap.name),
                      responseType: 'json',
                      method: 'PUT',
                      serializer: 'json',
                      debug: true,
                      data: deviceAccessMap,
                    });
                    console.log('respone', respone);
                    //tindy the data
                    let json = { 'result': [] };
                    json.result.push(respone.data.data);
                    this.deviceAccessMap = respone.data.data;
                    let settings = await this.upDateDeviceSettings();
                    console.log('settings', settings);
                    await window.peripheral[guid].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: '9900',
                      },
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: '9901',
                      },
                    ]);
                    app.dialog.close();
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(error);
                  }
                }
              }
            } catch (error) {
              console.log('error', error);
            }
          },
          checkIfOnline(email){
            let mac = core_utils_get_mac_address_from_guid(guid, false);
            let topic_self = `${mac.toLowerCase()}-${email}`;
            let will_topic = `will/${md5(md5(topic_self))}`;
            return new Promise((resolve) => {
              const cleanup = () => {
                if(this.$checkIfOnlineTimeout){
                  clearTimeout(this.$checkIfOnlineTimeout);
                  this.$checkIfOnlineTimeout = null;
                }
                if(this.$checkOnlineInterval){
                  clearInterval(this.$checkOnlineInterval);
                  this.$checkOnlineInterval = null;
                }
                if (this.wifiTopicHandler) {
                  emitter.off(will_topic, this.wifiTopicHandler);
                  this.wifiTopicHandler = null;
                }
              };
              
              // 先清理可能存在的旧监听器和定时器
              cleanup();

              this.wifiTopicHandler = (res) => {
                console.log('res', res);
                if(res.message.toLowerCase().includes('online')){
                  cleanup(); // 收到消息后立即清理
                  console.log('wifiConnected', true);
                  this.wifiConnected = true;
                  resolve(true);
                }else{
                  // 收到offline或者其他消息，不立即resolve false，而是继续等待
                  // 配合定时器重新订阅来确保能收到最新状态
                  console.log('Received offline or other status, waiting...');
                }
              };
              
              core_mqtt_subscribe(will_topic, 0, false);
              emitter.on(will_topic, this.wifiTopicHandler);
              
              // 每10秒重新订阅一次，确保订阅状态活跃
              this.$checkOnlineInterval = setInterval(() => {
                console.log('Resubscribing to check online status...');
                core_mqtt_subscribe(will_topic, 0, false);
              }, 10000);

              this.$checkIfOnlineTimeout = setTimeout(() => {
                cleanup();
                resolve(false);
              }, 60 * 1000);
            });
          },
          async syncWifi() {
            let postStatus = true; //验证是否能下一步的状态
            //connect to the mqtt server
            if (!this.wifiStatus) {
              if (!this.ssid || !this.password) {
                postStatus = false;
              }
            }
            if (!postStatus) {
              app.dialog.alert(_('Please enter the wifi ssid and password.'));
              return;
            }
            //connect to the wifi
            const saveSsid = () => {
              let ssid_utf_8 = this.stringToUtf8Hex(this.ssid);
              const data = '932000' + (ssid_utf_8.length / 2).toString(16).pad('0000') + ssid_utf_8;
              return window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: data,
                },
              ]);
            };
            const saveSsidPassword = () => {
              const data = '932100' + this.password.length.toString(16).pad('0000') + this.password.convertToHex();

              return window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: data,
                },
              ]);
            };
            const saveEmail = () => {
              let email = this.email?this.email:users[users.current].usr.toLowerCase();
              const data = '932200' + email.length.toString(16).pad('0000') + email.convertToHex();

              return window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: data,
                },
              ]);
            };
            const savePort = () => {
              let port = erp.settings[erp.appId].mqtt_port;
              const data = '9301000002' + (port * 1).toString(16).pad('0000');

              return window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: data,
                },
              ]);
            };
            const saveServerUrl = () => {
              let server_url = erp.settings[erp.appId].mqtt_scheme
                ? erp.settings[erp.appId].mqtt_scheme + '://' + erp.settings[erp.appId].mqtt_server
                : 'mqtt://' + erp.settings[erp.appId].mqtt_server;
              const data = '930000' + server_url.length.toString(16).pad('0000') + server_url.convertToHex();

              return window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: data,
                },
              ]);
            };
            const restartDevice = () => {
              return window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: '810E',
                },
              ]);
            };
            const saveInErp = () => {
              return iot_device_setting_sync_server(guid, null, null, true, {
                'Wifi SSID': this.ssid,
                'Wifi Password': this.password,
                'Email Address': users[users.current].usr.toLowerCase() || 'null',
                'Server Port': erp.settings[erp.appId].mqtt_port || 'null',
                'Server URI': erp.settings[erp.appId].mqtt_scheme
                  ? erp.settings[erp.appId].mqtt_scheme + '://' + erp.settings[erp.appId].mqtt_server
                  : 'mqtt://' + erp.settings[erp.appId].mqtt_server || 'null',
              });
            };
            try {
              app.dialog.preloader(_('Bluetooth connection in progress.'));
              await window.peripheral[guid].connect();
              
              // 只有在未连接状态下，或者用户明确输入了 SSID 时才下发配置
              if(!this.wifiStatus){
                await saveSsid();
                await saveSsidPassword();
              }
              //如果已经连接了mqtt，则直接跳过
              debugger
              if(this.wifiConnected){
                this.toTab(2);
                return;
              }
              await saveEmail();
              await savePort();
              await saveServerUrl();
              await saveInErp();
              await restartDevice();
              app.dialog.close();
              app.dialog.preloader(_('Restarting...'));
              await this.sleep(10 * 1000);
              app.dialog.close();
              app.dialog.preloader(_('Checking connection...'));
              let status = await this.checkIfOnline(this.email?this.email:users[users.current].usr.toLowerCase());
              if(status){
                app.dialog.close();
                  this.wifiConnected = true;
                  app.toast.create({
                    text: _('Wi-Fi connected.'),
                    position: 'center',
                    closeTimeout: 3000,
                  });
                  this.toTab(2);
              }else{
                app.dialog.close();
                app.dialog.alert(_('Wi-Fi connection failed. Please check your Wi-Fi settings.'));
              }
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(erp.get_log_description(error));
            }
          },
          async syncToDeviceWithBle() {
            //判断如果选择的是door management，则只需要同步device
            if (this.accessType == 0) {
              try{
                let settings = await this.upDateDeviceSettings();
                await this.postBleData(settings, 0);
              }catch(error){
                app.dialog.alert(_(erp.get_log_description(error)));
              }
              return;
            }
            app.dialog.preloader(_('Getting device access...'));
            //send the ble data to the device
            try {
              let result = await http2.request({
                url: encodeURI('/api/method/appv6.getDeviceAccessByDevice'),
                responseType: 'json',
                debug: true,
                method: 'POST',
                serializer: 'json',
                data: {
                  device: guid,
                  access_type: this.getAccessTypeTitle(this.accessType),
                },
              });
              console.log('result', result);
              app.dialog.close();
              if (result.status == 200) {
                let data = result.data.data;
                let postScheduleList = [];
                this.scheduleList.forEach((item) => {
                  postScheduleList.push({
                    schedule: item.schedule,
                    from_time: item.from_time,
                    to_time: item.to_time,
                    whole_day: item.whole_day,
                  });
                });
                if (data.length == 0) {
                  //erp have no record
                  let deviceAccessMap = {
                    device: guid,
                    access_type: this.getAccessTypeTitle(this.accessType),
                    status: 'Registered',
                    device_button_group: button_group,
                    one_time_access: '',
                    guest_email: this.guestEmail,
                    valid_from: this.totalVailFrom,
                    valid_to: this.totalVailTo,
                    blocking_schedule: postScheduleList,
                    access_level: this.accessGroup,
                    qr_code: this.qrcode_random_16,
                    key_card_id: this.keyCardId,
                    key_card_secret: this.keyCardSecret,
                    octopus_card_id: this.octopusCardId,
                    guest_email: this.guestEmail,
                    blocking_schedule: postScheduleList,
                    access_level: this.accessGroup,
                  };
                  try {
                    app.dialog.preloader(_('Saving device access...'));
                    let respone = await http2.request({
                      url: encodeURI('/api/resource/Device Access'),
                      responseType: 'json',
                      method: 'POST',
                      serializer: 'json',
                      debug: true,
                      data: deviceAccessMap,
                    });
                    console.log('respone', respone);
                    let json = { 'result': [] };
                    json.result.push(respone.data.data);
                    this.deviceAccessMap = respone.data.data;
                    app.dialog.close();
                    await this.postBleData(json, 1);
                    await this.sleep(1000);
                    let settings = await this.upDateDeviceSettings();
                    await this.postBleData(settings, 0);
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(error);
                  }
                } else {
                  let deviceAccessMap = data[0];
                  let accessType = this.getAccessTypeTitle(this.accessType);
                  deviceAccessMap.access_type = accessType;
                  deviceAccessMap.access_level = this.accessGroup;
                  deviceAccessMap.status = 'Registered';
                  deviceAccessMap.device_button_group = button_group;
                  deviceAccessMap.blocking_schedule = postScheduleList;
                  //send the ble data to the device
                  if (this.accessType == 1) {
                    //ble
                    deviceAccessMap.guest_email = this.guestEmail;
                    deviceAccessMap.valid_from = this.totalVailFrom;
                    deviceAccessMap.valid_to = this.totalVailTo;
                  } else if (this.accessType == 3) {
                    deviceAccessMap.key_card_id = this.keyCardId;
                  } else if (this.accessType == 4) {
                    deviceAccessMap.key_card_id = this.keyCardId;
                    deviceAccessMap.key_card_secret = this.keyCardSecret;
                  } else if (this.accessType == 5) {
                    deviceAccessMap.octopus_card_id = this.octopusCardId;
                  } else if (this.accessType == 6) {
                    deviceAccessMap.valid_from = this.totalVailFrom;
                    deviceAccessMap.valid_to = this.totalVailTo;
                  }
                  console.log('deviceAccessMap', deviceAccessMap);
                  app.dialog.preloader(_('Saving device access...'));
                  try {
                    let respone = await http2.request({
                      url: encodeURI('/api/resource/Device Access/' + deviceAccessMap.name),
                      responseType: 'json',
                      method: 'PUT',
                      serializer: 'json',
                      debug: true,
                      data: deviceAccessMap,
                    });
                    console.log('respone', respone);
                    //tindy the data
                    let json = { 'result': [] };
                    json.result.push(respone.data.data);
                    this.deviceAccessMap = respone.data.data;
                    app.dialog.close();
                    await this.postBleData(json, 1);
                    //update the device settings
                    await this.sleep(1000);
                    let settings = await this.upDateDeviceSettings();
                    await this.postBleData(settings, 0);
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(error);
                  }
                }
              }
            } catch (error) {
              console.log('error', error);
            }
          },
          upDateDeviceSettings() {
            return new Promise(async (resolve, reject) => {
              try {
                let res = await http2.request({
                  url: encodeURI('/api/resource/Device/' + guid),
                  responseType: 'json',
                  method: 'GET',
                  debug: true,
                });
                console.log('res', res);
                //tindy the data
                let settingMap = res.data.data;
                settingMap.password = '000000';
                let settings = settingMap.settings;
                let haveButtonGroup = false;
                settings.forEach((item) => {
                  if (item.setting_type == button_group) {
                    haveButtonGroup = true;
                  }
                });
                if (!haveButtonGroup) {
                  settings.push({
                    parent: guid,
                    parentfield: 'settings',
                    parenttype: 'Device',
                    doctype: 'Device Settings',
                    setting_type: button_group,
                    setting: button_group_command,
                  });
                  let postRes = await http2.request({
                    url: encodeURI('/api/resource/Device/' + guid),
                    responseType: 'json',
                    method: 'PUT',
                    serializer: 'json',
                    debug: true,
                    data: {
                      settings: settings,
                    },
                  });
                }
                resolve({
                  'data': settingMap,
                });
              } catch (error) {
                //this means the device is not registered
                console.log('error', error);
                if (error.status == 404) {
                  let settings = [];
                  settings.push({
                    parent: guid,
                    parentfield: 'settings',
                    parenttype: 'Device',
                    doctype: 'Device Settings',
                    setting_type: 'default_password',
                    setting: '000000',
                  });
                  settings.push({
                    parent: guid,
                    parentfield: 'settings',
                    parenttype: 'Device',
                    doctype: 'Device Settings',
                    setting_type: button_group,
                    setting: button_group_command,
                  });
                  //post the device
                  try {
                    let res = await http2.request({
                      url: encodeURI('/api/resource/Device'),
                      responseType: 'json',
                      method: 'POST',
                      serializer: 'json',
                      debug: true,
                      data: {
                        guid: '12345',
                        password: '000000',
                        device_model: 'YO382',
                        device_mode: 'Device Access',
                        firmware: '13.126',
                        batch: 'YO0012',
                        settings: settings,
                      },
                    });
                    console.log('res', res);
                    resolve(res);
                  } catch (errors) {
                    reject(errors);
                  }
                }
              }
            });
          },
          getAccessTypeTitle(type) {
            if (type == 0) {
              return 'Door Management';
            } else if (type == 1) {
              return 'Dynamic QR Code';
            } else if (type == 2) {
              return 'QR Code';
            } else if (type == 3) {
              return 'Key Card';
            } else if (type == 4) {
              return 'Secure Key Card';
            } else if (type == 5) {
              return 'Octopus Card';
            } else if (type == 6) {
              return 'Auto Open';
            } else if (type == 7) {
              return 'Door Blocking Schedule';
            } else {
              return 'Unknown';
            }
          },
          toTab(index) {
            let postStatus = true;
            console.log('index', this.accessType);
            if (index == 2) {
              //save the time
              try {
                if (this.accessType != 0) {
                  this.totalVailFrom = this.formatDateTime($('#demo-calendar-date-time').val());
                  this.totalVailTo = this.formatDateTime($('#demo-calendar-date-time-to').val());
                }
              } catch (error) {
                postStatus = false;
                app.dialog.alert(_('Please select the time.'));
                return;
              }
              if (this.postType == 1 && !this.wifiConnected) {
                this.syncWifi();
                return;
              }
              if (this.accessType == 1) {
                if (!this.guestEmail) {
                  postStatus = false;
                  app.dialog.alert(_('Please enter the guest email.'));
                  return;
                }
              }
              if (this.accessType == 3 || this.accessType == 4) {
                if (!this.keyCardId) {
                  postStatus = false;
                  app.dialog.alert(_('Please get the key card id.'));
                  return;
                }
              }
              if (this.accessType == 5) {
                if (!this.octopusCardId) {
                  postStatus = false;
                  app.dialog.alert(_('Please get the octopus card id.'));
                  return;
                }
              }
              this.startQrcodeSetTimer();
            }
            if (postStatus) {
              this.index = index;
              this.activeStep();
            }
          },
          formatDateTime(inputStr) {
            const date = dayjs(inputStr, 'YYYY/M/D HH:mm', true);
            if (!date.isValid()) {
              throw new Error('Invalid date format');
            }
            return date.format('YYYY-MM-DD HH:mm:ss');
          },
          base64ToArrayBuffer(base64) {
            const binaryStr = atob(base64);
            return Uint8Array.from(binaryStr, (c) => c.charCodeAt(0)).buffer;
          },
          requestMtuForBle() {
            return new Promise(async (resolve, reject) => {
              if (deviceInfo.operatingSystem === 'ios') {
                resolve(true);
              } else {
                try {
                  await window.peripheral[guid].connect();
                } catch (error) {
                  console.log('error', error);
                  reject(error);
                  return;
                }
                //request mtu
                ble.requestMtu(
                  window.peripheral[guid].prop.id,
                  512,
                  () => {
                    console.log('request mtu success');
                    resolve(true);
                  },
                  (error) => {
                    if (error) {
                      reject(error);
                    }
                  }
                );
              }
            });
          },
          async postBleData(json, postHead) {
            if (postHead == 0) {
              app.dialog.close();
            }
            this.postBleDataList = [];
            let uploadTimer = setTimeout(
              () => {
                app.dialog.close();
                app.dialog.alert(_('Upload Data Failed'));
              },
              10000 * 60 * 5
            );
            return new Promise(async (resolve, reject) => {
              this.iot_attempt = 0;
              await core_load_script('https://dev.mob-mob.com/files/spark-md5.min.js');
              const jsonData = json;
              const encoder = new TextEncoder();
              const uint8Array = encoder.encode(JSON.stringify(jsonData));
              const fileString = arrayBufferToHex(uint8Array);
              let fileData = `990${postHead}000000${fileString}`;

              const bytestoString = bytesToString(fileData.convertToBytes());
              console.log('bytestoString', bytestoString);
              const md5str = SparkMD5.hashBinary(bytestoString);
              let sizeHex = iot_utils_to_little_endian_hex(fileData.length / 2, 4);
              debugger;
              let nameHex = convertToFixedSizeHex(`device_access`, 31);
              let readyData = `93330000340${'3'}${sizeHex}${md5str}${nameHex}`;
              let allData = `93330000340${'3'}${sizeHex}${fileData}${nameHex}`;
              try {
                let that = this;
                this.uuid = window.peripheral[guid].prop.id;
                app.dialog.preloader();
                ble.startNotification(
                  this.uuid,
                  'ff80',
                  'ff85',
                  (rs) => {
                    console.log('notification', rs);
                    // debugger
                    if (rs && that.iot_attempt == 0) {
                      that.iotProcessDataForEsp(this.uuid, fileData.convertToBytes());
                      that.iot_attempt++;
                    }
                    if (rs && that.iot_attempt > 0) {
                      let status = parseInt(rs.substring(10, 12), 16);
                      console.log('status', status);
                      if (status > 0 && status < 100) {
                        // this.this_dialog.setProgress(status);
                        // this.this_dialog.setText(`${_('Upload Data')}: ${status}%`);
                      }
                      if (status == 100) {
                        app.dialog.close();
                        clearTimeout(uploadTimer);
                        resolve(true);
                        window.uploadStatus[parseInt(window.iot_attempt) - 1] = true;
                        if (postHead == 0) {
                          this.isSyncSetting = true;
                          app.dialog.alert(_('Upload Data Success'));
                        }
                      }
                      //if status > 100?reject error
                      if (status > 100) {
                        //disconnect the device
                        app.dialog.close();
                        window.peripheral[guid].disconnect();
                        clearTimeout(uploadTimer);
                        console.log('disconnect');
                        reject(_('Upload Data Failed'));
                        // app.dialog.alert('Error: ' + status, runtime.appInfo.name, () => {});
                      }
                    }
                  },
                  function (error) {
                    console.log(error);
                  }
                );
                setTimeout(() => {
                  ble.writeWithoutResponse(
                    this.uuid,
                    'ff80',
                    'ff85',
                    readyData.convertToBytes(),
                    function (response) {
                      console.log(response);
                    },
                    function (error) {
                      console.log(error);
                    }
                  );
                }, 1000);
                return;
                try {
                  ble.connect(this.uuid, (peripheralData) => {
                    console.log('peripheralData', peripheralData);
                    if (Capacitor.getPlatform() === 'android') {
                      ble.requestMtu(
                        this.uuid,
                        512,
                        () => {
                          console.log('>>>> device request mtu success');
                          app.dialog.close();
                          this.this_dialog = app.dialog.progress(`${_('Upload Data')}`, 0);
                          setTimeout(() => {
                            ble.startNotification(
                              this.uuid,
                              'ff80',
                              'ff85',
                              (rs) => {
                                console.log('notification', rs);
                                // debugger
                                if (rs && that.iot_attempt == 0) {
                                  that.iotProcessDataForEsp(this.uuid, fileData.convertToBytes());
                                  that.iot_attempt++;
                                }
                                if (rs && that.iot_attempt > 0) {
                                  let status = parseInt(rs.substring(10, 12), 16);
                                  console.log('status', status);
                                  if (status > 0) {
                                    app.preloader.hide();
                                    this.this_dialog.setProgress(status);
                                    this.this_dialog.setText(`${_('Upload Data')}: ${status}%`);
                                  }
                                  if (status == 100) {
                                    app.preloader.hide();
                                    this.this_dialog.close();
                                    clearTimeout(uploadTimer);
                                    app.dialog.alert(_('Upload Data Success'));
                                    resolve(true);
                                    window.uploadStatus[parseInt(window.iot_attempt) - 1] = true;
                                  }
                                  //if status > 100?reject error
                                  if (status > 100) {
                                    //disconnect the device
                                    app.preloader.hide();
                                    app.dialog.close();
                                    ble.disconnect(this.uuid);
                                    clearTimeout(uploadTimer);
                                    console.log('disconnect');
                                    reject(_('Upload Data Failed'));
                                    // app.dialog.alert('Error: ' + status, runtime.appInfo.name, () => {});
                                  }
                                }
                              },
                              function (error) {
                                console.log(error);
                              }
                            );
                            ble.writeWithoutResponse(
                              this.uuid,
                              'ff80',
                              'ff85',
                              readyData.convertToBytes(),
                              function (response) {
                                console.log(response);
                              },
                              function (error) {
                                console.log(error);
                              }
                            );
                          }, 1000);
                        },
                        (err) => {
                          console.log('>>>> device request mtu fail: ' + err);
                          app.dialog.alert('>>>> device request mtu fail: ' + err);
                        }
                      );
                    } else {
                      app.dialog.close();
                      this.this_dialog = app.dialog.progress(`${_('Upload Data')}`, 0);
                      let that = this;
                      setTimeout(() => {
                        ble.startNotification(
                          this.uuid,
                          'ff80',
                          'ff85',
                          (rs) => {
                            console.log(rs);
                            if (rs && that.iot_attempt == 0) {
                              that.iotProcessDataForEsp(this.uuid, fileData.convertToBytes());
                              that.iot_attempt++;
                            }
                            if (rs && that.iot_attempt > 0) {
                              let status = parseInt(rs.substring(10, 12), 16);
                              console.log('status', status);
                              // this.checkSendBleIndex();
                              if (status > 0) {
                                app.preloader.hide();
                                this.this_dialog.setProgress(status);
                                this.this_dialog.setText(`${_('Upload Progress')}: ${status}%`);
                              }
                              if (status == 100) {
                                app.preloader.hide();
                                this.this_dialog.close();
                                window.uploadStatus[parseInt(that.iot_attempt) - 1] = true;
                                clearTimeout(uploadTimer);
                                app.dialog.alert(_('Upload Data Success'));
                                resolve(true);
                              }
                              //if status > 100?reject error
                              if (status > 100) {
                                //disconnect the device
                                app.preloader.hide();
                                app.dialog.close();
                                clearTimeout(uploadTimer);
                                ble.disconnect(this.uuid);
                                reject(_('Upload Data Failed'));
                              }
                            }
                          },
                          function (error) {
                            console.log(error);
                          }
                        );
                        ble.writeWithoutResponse(
                          this.uuid,
                          'ff80',
                          'ff85',
                          readyData.convertToBytes(),
                          function (response) {
                            console.log(response);
                          },
                          function (error) {
                            console.log(error);
                          }
                        );
                      }, 1000);
                    }
                  });
                } catch (error) {}
              } catch (err) {
                console.log('err', err);
              }
            });
          },
          async iotProcessDataForEsp(uuid, data) {
            console.log('uuid', uuid);
            console.log('data', data);
            let mainChunkSizeInBytes = 4096;
            //let negotiatedMTU = 502;
            let negotiatedMTU = 180;
            console.log('data.byteLength', data.byteLength);
            let newArray = [];
            for (let i = 0; i < data.byteLength; i += mainChunkSizeInBytes) {
              let subChunk = data.slice(i, Math.min(i + mainChunkSizeInBytes, data.byteLength));
              const fileString = arrayBufferToHex(subChunk);
              console.log('fileString2', fileString);
              console.log('subChunk', subChunk);
              const bytestoString = bytesToString(subChunk);
              console.log('bytestoString2', bytestoString);
              // const crc16 = core_util_calculate_crc16_modbus_for_doa(fileString);
              const md5str = SparkMD5.hashBinary(bytestoString);
              console.log('md5str2', md5str);
              const new_data = hexToBuffer(fileString + md5str);
              newArray.push(new_data);
              window.uploadStatus.push(false);
            }
            //debugger
            console.log('newArray', newArray);
            let this_index = 0;
            let subChunks = [];
            for (let j in newArray) {
              let obj = {
                index: j,
                subChunks: [],
                sendStatus: false,
              };
              const subChunkSizeInBytes = negotiatedMTU;
              let offsetItem = 0;
              for (let i = 0; i < newArray[j].byteLength; i += subChunkSizeInBytes) {
                const subChunk = newArray[j].slice(i, Math.min(i + subChunkSizeInBytes, newArray[j].byteLength));
                subChunks.push(subChunk);
                obj.subChunks.push({
                  item: subChunk,
                  index: this_index,
                  status: false,
                  offsetItem: offsetItem,
                });
                offsetItem += 502;
              }
              if (this_index > j) {
                subChunks.push(false);
              }
              this.postBleDataList.push(obj);
              this_index++;
            }
            console.log('postBleDataList', this.postBleDataList);
            console.log('subChunks', subChunks);
            let offset = 0;
            let postIndex = 0;
            let postBleDataList = cloneDeep(this.postBleDataList);
            // this.startPostBleData(0,0);
            for (let i in postBleDataList) {
              let list = postBleDataList[i].subChunks;
              let offsetItem = 0;
              console.log('startSend', postIndex);
              for (let j in list) {
                let hexString = arrayBufferToHex(list[j].item);
                let commandLength = (hexString.length / 2 + 4).toString(16);
                commandLength = commandLength.padStart(4, '0');
                let command = `933400${commandLength}${iot_utils_to_little_endian_hex(offsetItem, 4)}${hexString}`;
                console.log('startChunksIndex', j);
                // console.log('postBleDataListChunkIndex', this.postBleDataListChunkIndex);
                console.log('command', command);
                await ble.writeWithoutResponse(
                  this.uuid,
                  'ff80',
                  'ff85',
                  command.convertToBytes(),
                  function (response) {
                    console.log('response', response);
                  },
                  function (error) {
                    console.log('error', error);
                  }
                );
                await this.sleep(500);
                if (postIndex == this.postBleDataList.length - 1 && j == list.length - 1) {
                  console.log('9335');
                  setTimeout(() => {
                    ble.writeWithoutResponse(
                      this.uuid,
                      'ff80',
                      'ff85',
                      '9335'.convertToBytes(),
                      function (response) {
                        //resolve(response);
                      },
                      function (error) {
                        //reject(error);
                      }
                    );
                  }, 500);
                }
                offsetItem += negotiatedMTU;
              }
              postIndex++;
            }
          },
          addSchedule() {
            mainView.router.navigate(`/mobile-app/esp-choose-schedule`);
          },

          removeDuplicates(arr) {
            const seen = new Set();
            return arr.filter((item) => {
              const str = JSON.stringify(item);
              return seen.has(str) ? false : seen.add(str);
            });
          },
          async sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          },
          stringToUtf8Hex(str) {
            let utf8Bytes;
            if (typeof TextEncoder !== 'undefined') {
              // 现代浏览器和 Node.js
              const encoder = new TextEncoder();
              utf8Bytes = encoder.encode(str);
            } else {
              // 兼容旧环境（如旧版 IE）
              utf8Bytes = [];
              for (let i = 0; i < str.length; i++) {
                let code = str.charCodeAt(i);

                if (code < 0x80) {
                  // 单字节字符
                  utf8Bytes.push(code);
                } else if (code < 0x800) {
                  // 双字节字符
                  utf8Bytes.push(0xc0 | (code >> 6));
                  utf8Bytes.push(0x80 | (code & 0x3f));
                } else if (code < 0x10000) {
                  // 三字节字符（包括大部分中文字符）
                  utf8Bytes.push(0xe0 | (code >> 12));
                  utf8Bytes.push(0x80 | ((code >> 6) & 0x3f));
                  utf8Bytes.push(0x80 | (code & 0x3f));
                } else {
                  // 四字节字符
                  utf8Bytes.push(0xf0 | (code >> 18));
                  utf8Bytes.push(0x80 | ((code >> 12) & 0x3f));
                  utf8Bytes.push(0x80 | ((code >> 6) & 0x3f));
                  utf8Bytes.push(0x80 | (code & 0x3f));
                }
              }
              utf8Bytes = new Uint8Array(utf8Bytes);
            }
            // 转换为十六进制字符串
            return Array.from(utf8Bytes)
              .map((byte) => byte.toString(16).padStart(2, '0'))
              .join('');
          },
        },
        computed: {},
        beforeDestroy() {
          this.stopHeartbeat();
          if (this.$qrcodeSetTimer) {
            clearInterval(this.$qrcodeSetTimer);
          }
          if(this.$checkOnlineInterval){
            clearInterval(this.$checkOnlineInterval);
            this.$checkOnlineInterval = null;
          }
          if(this.listenBleNotifyTimeout){
            clearTimeout(this.listenBleNotifyTimeout);
            this.listenBleNotifyTimeout = null;
          }
          if (this.listenBleNotify) {
            emitter.off('upload/notify', this.listenBleNotify);
            this.listenBleNotify = null;
          }
          // 清理 Wifi 检测相关的资源
          if (this.wifiCheckTimeout) {
            clearTimeout(this.wifiCheckTimeout);
            this.wifiCheckTimeout = null;
          }
          if (this.wifiTopicHandler) {
            // 这里需要重新计算 topic 才能解绑，或者在 data 中保存 topic
            // 但由于 beforeDestroy 时 guid 可能还在，我们可以尝试解绑
            // 更稳妥的方式是保存 topic 或者 handler 本身就是关键
            // 由于 handler 引用保存在 this.wifiTopicHandler，只要 emitter.off 的时候传入同一个函数引用即可
            // 但是 emitter.off 需要 topic。为了简单起见，我们只清理定时器，handler 依赖 topic。
            // 如果 topic 变化了，旧的 handler 确实是个问题。
            // 更好的做法是在 data 中也保存当前的监听 topic
          }
          // 实际上，在 checkIfOnline 中闭包的 cleanup 只能在内部调用
          // 为了在组件销毁时也能清理，我们需要把 cleanup 逻辑或者相关引用挂载到 this 上
          // 上面的 search_replace 中我已经把 handler 和 timeout 挂载到 this 上了
          // 这里我们尝试清理
          if (this.wifiTopicHandler && guid && users[users.current]) {
            try {
              let mac = core_utils_get_mac_address_from_guid(guid, false);
              let topic_self = `${mac.toLowerCase()}-${users[users.current].usr.toLowerCase()}`;
              let will_topic = `will/${md5(md5(topic_self))}`;
              emitter.off(will_topic, this.wifiTopicHandler);
            } catch (e) {
              console.log('cleanup wifi handler error', e);
            }
          }
        },
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  .device-type-list {
    margin-top: 0px;
    margin-bottom: 0px;
  }

  .device-type-list-item {
    float: left;
    width: 50%;
    overflow: hidden;
    display: block;
    border-bottom: solid 1px #e6e6e6;
    overflow: hidden;
    background-repeat: no-repeat;
    padding: 30px 0px;
    background-color: #fff;
  }

  .device-type-list-item a {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .device-type-list-item img {
    height: 30px;
    background-repeat: no-repeat;
    background-size: auto 30px;
    display: block;
    margin-bottom: 10px;
  }

  .device-type-list-item span {
    color: #676767;
    text-align: center;
  }

  .device-type-list-item:nth-child(odd) {
    border-right: solid 1px #e6e6e6;
  }
  .autocomplete-dropdown-in {
    z-index: 10000 !important;
  }
  .do-not-find-flat {
    text-decoration: underline;
    font-size: 14px;
    font-weight: 400;
    color: #007bff;
    text-align: center;
    margin-top: 10px;
  }
  .list ul::before,
  .list ul::after {
    content: none;
  }
  .add-box {
    height: 70px;
    padding: 0px 15px;
    color: var(--f7-theme-color);
  }
</style>
