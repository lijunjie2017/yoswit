<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Scene Configuration') }}</div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="main-box">
          <div class="toolbar-box" style="padding: 0 15px; margin-top: 15px" v-if="stepList.length">
            <div class="toolbar tabbar tabbar-scrollable" style="height: 60px">
              <div class="toolbar-inner scene-toolbar-inner">
                <button v-for="(item,index) in stepList" :key="item.id" :class="item.isActive?'button-active button':'button'" v-on:click="toTab(item.relatedIndex)">{{_('Step')}} {{item.name}}</button>
              </div>
            </div>
          </div>
          <div class="tabs">
            <!--choose tempalte-->
            <div id="step-0" class="view tab view-main" :class="[index == 0 ? 'tab-active' : '']" v-if="index == 0">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Select one of the templates")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in templateList"
                    :key="index"
                    :style="{'background-color':item.color}"
                    v-on:click="chooseTemplate(item)"
                  >
                    <div class="scnen-template-title">
                      <span>{{_(item.name)}}</span>
                    </div>
                    <div class="scnen-template-icon display-flex justify-content-center align-items-center">
                      <i class="material-icons text-color-theme" style="font-size: 30px">{{item.icon}}</i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-0-1" class="view tab view-main" :class="[index == 0.5 ? 'tab-active' : '']" v-if="index == 0.5">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Choose Your Rcu Device")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in rcuList"
                    :key="item.guid"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>{{item.device_model}}</p>
                      <p>{{item.mac_address}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeRcuStatus(item)"
                        >check_box_outline_blank</i
                      >
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-else="item.ischeck"
                        v-on:click="changeRcuStatus(item)"
                        >check_box</i
                      >
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="chooseRcuDevice()">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 1 ? 'tab-active' : '']" v-if="index == 1">
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle'" class="card-header" style="font-weight: 500; font-size: 18px">{{_("Add The First Scene")}}</div>
                <div class="card-content card-content-padding">
                  <a
                    href="#"
                    func="core_get_photo"
                    ref="profile_room_form_banner"
                    ele="profile_room_form_banner"
                    style="
                      display: block;
                      overflow: hidden;
                      background-color: #eee;
                      height: 150px;
                      text-align: center;
                      background-size: cover;
                      background-position: center;
                    "
                    :style="{ backgroundImage: sceneImage }"
                    class="profile_room_form_banner mb-2 display-flex align-items-center justify-content-center"
                  >
                    <input
                      type="text"
                      name="banner"
                      class="_readable"
                      readonly="readonly"
                      placeholder="Banner"
                      style="display: none"
                      value=""
                    />
                    <span class="material-icons" style="font-size: 70px; color: #ddd">add_a_photo</span>
                  </a>
                  <div class="list card-content-padding">
                    <ul>
                      <li class="item-content item-input no-padding-left">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Scene Name")}}</div>
                          <div class="item-input-wrap">
                            <input type="text" name="sceneName" v-model="sceneName" :placeholder="SceneNameTip" required validate />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(1)">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 6 ? 'tab-active' : '']" v-if="index == 6">
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle'" class="card-header" style="font-weight: 500; font-size: 18px">{{_("Add The Second Scene")}}</div>
                <div class="card-content card-content-padding">
                  <a
                    href="#"
                    func="core_get_photo"
                    ref="profile_room_form_banner"
                    ele="profile_room_form_banner"
                    style="
                      display: block;
                      overflow: hidden;
                      background-color: #eee;
                      height: 150px;
                      text-align: center;
                      background-size: cover;
                      background-position: center;
                    "
                    :style="{ backgroundImage: sceneImage }"
                    class="profile_room_form_banner mb-2 display-flex align-items-center justify-content-center"
                  >
                    <input
                      type="text"
                      name="banner"
                      class="_readable"
                      readonly="readonly"
                      placeholder="Banner"
                      style="display: none"
                      value=""
                    />
                    <span class="material-icons" style="font-size: 70px; color: #ddd">add_a_photo</span>
                  </a>
                  <div class="list card-content-padding">
                    <ul>
                      <li class="item-content item-input no-padding-left">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Scene Name")}}</div>
                          <div class="item-input-wrap">
                            <input type="text" name="secondSceneName" v-model="secondSceneName" :placeholder="SceneNameTip" required validate />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(1)">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-2" class="view tab view-main" :class="[index == 2 ? 'tab-active' : '']" v-if="index == 2">
              <!-- this page is choose the action  -->
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle'" class="card-header" style="font-weight: 500; font-size: 18px">{{_("Add The First Scene Action")}}</div>
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in actionList" :key="item.name">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div
                              class="device-thumb item-media"
                              :style="{
                              'background-position': 'center',
                              'background-size': 'contain',
                              'position': 'relative',
                              'background-image': 'url('+item.imgUrl+')'}
                            "
                            ></div>
                            <div class="item-inner">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                              </div>
                              <div class="item-subtitle">{{ item.device_model }}-{{ item.mac_address }}</div>
                              <div class="signal-panel item-text height-21" style="">
                                {{tran(item.room_name)}}/
                                <span class="text-color-theme">{{_(dealwithRef(item))}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteActionItem(item.name)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-flex-start align-items-center"
                      v-on:click="toRoomList('Choose Action Device','2','1')"
                    >
                      <i class="material-icons">add_circle</i>
                      <div class="trigger-text margin-left">{{_("Add Actions")}}</div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(2)">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-2" class="view tab view-main" :class="[index == 7 ? 'tab-active' : '']" v-if="index == 7">
              <!-- this page is choose the action  -->
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle'" class="card-header" style="font-weight: 500; font-size: 18px">{{_("Add The Second Scene Action")}}</div>
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in actionList_2" :key="item.name">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div
                              class="device-thumb item-media"
                              :style="{
                              'background-position': 'center',
                              'background-size': 'contain',
                              'position': 'relative',
                              'background-image': 'url('+item.imgUrl+')'}
                            "
                            ></div>
                            <div class="item-inner">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                              </div>
                              <div class="item-subtitle">{{ item.device_model }}-{{ item.mac_address }}</div>
                              <div class="signal-panel item-text height-21" style="">
                                {{tran(item.room_name)}}/
                                <span class="text-color-theme">{{_(dealwithRef(item))}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteActionItem(item.name)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-flex-start align-items-center"
                      v-on:click="toRoomList('Choose Action Device','2','2')"
                    >
                      <i class="material-icons">add_circle</i>
                      <div class="trigger-text margin-left">{{_("Add Actions")}}</div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(8)">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-3" class="view tab view-main" :class="[index == 3 ? 'tab-active' : '']" v-if="index == 3">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px" v-if="!selfTriggeredClickStatus">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in trigger" :key="index" v-if="!item.isHidden">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div
                              class="device-thumb item-media"
                              :style="{
                              'background-position': 'center',
                              'background-size': 'contain',
                              'position': 'relative',
                              'background-image': 'url('+item.img_url+')'}
                            "
                            ></div>
                            <div class="item-inner">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                              </div>
                              <div class="item-subtitle">{{ item.model }}-{{ item.mac_address }}</div>
                              <div class="signal-panel item-text height-21" style="">
                                {{tran(item.room_title)}}/
                                <span class="text-color-theme">{{_(item.status)}}</span>
                                <span
                                  class="text-color-theme"
                                  v-if="item.mode == 'Radar Sensor' || item.button_group== 'SCENE MUTIWAY ONOFF GANG1'"
                                  >{{item.condition == 1?'/OR':'/AND'}}</span
                                >
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteTriggerItem(index)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-flex-start align-items-center"
                      v-on:click="toRoomList('Choose Trigger Device','1')"
                    >
                      <i class="material-icons">add_circle</i>
                      <div class="trigger-text margin-left">{{_("Add a trigger condition")}}</div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(3)">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-4" class="view tab view-main" :class="[index == 4 ? 'tab-active' : '']" v-if="index == 4">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in timerList" :key="index">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div class="item-inner" style="padding-top: 10px">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{computerTime(item)}}</div>
                              </div>
                              <div class="signal-panel item-text height-21" style="">
                                <span class="text-color-theme" style="font-size: 12px">{{computerWeek(item)}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteTimer(index)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-space-between align-items-center"
                      v-on:click="toRoomList('Effective time period','3')"
                    >
                      <div class="trigger-text">Effective time period</div>
                      <div class="trigger-right display-flex justify-content-space-between align-items-cente">
                        <span class="left-info"></span>
                        <i class="material-icons">chevron_right</i>
                      </div>
                    </div>
                  </div>
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">Run Once Only</div>
                      <div class="trigger-right display-flex justify-content-space-between align-items-cente" v-on:click="switchOneOnly">
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!oneOnly">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="oneOnly">toggle_on</i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(5)">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-5" class="view tab view-main" :class="[index == 5 ? 'tab-active' : '']" v-if="index == 5">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Button And Setting")}}</div>
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Virtual Button')}}</div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="changeVirtualStatus"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!virtualStatus">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="virtualStatus">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Hide Button')}}</div>
                      <div class="trigger-right display-flex justify-content-space-between align-items-cente" v-on:click="changeHideDevice">
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!hideDevice">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="hideDevice">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div class="list no-hairlines-md" style="margin: 10px 0" v-if="virtualStatus">
                    <ul>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div
                            class="item-title item-label"
                            style="font-size: var(--f7-block-title-font-size, inherit); color: var(--f7-block-title-text-color)"
                          >
                            {{ _("Virtual Button Name") }}
                          </div>
                          <div class="item-input-wrap">
                            <input
                              class="init-input"
                              name="title"
                              type="text"
                              :placeholder="_('This name will be displayed in smart home')"
                              required
                              v-model="actionName"
                            />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(6)">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- mutiway choose devices  -->
            <div id="step-8" class="view tab view-main" :class="[index == 8 ? 'tab-active' : '']" v-if="index == 8">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Choose Your Mapping Device")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in mappingDeviceList"
                    :key="item.guid"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>{{tran(item.title)}}</p>
                      <p style="font-size: 12px;">{{tran(item.room_name)}}/{{item.device_name}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeDeviceStatus(item)"
                        >check_box_outline_blank</i
                      >
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-else="item.ischeck"
                        v-on:click="changeDeviceStatus(item)"
                        >check_box</i
                      >
                    </div>
                  </div>
                  <!-- No devices -->
                  <div class="device-null" v-if="mappingDeviceList.length == 0">
                    <div class="block" style="text-align: center">
                      <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                      <p>${_('You don\'t have matching devices, to network?')}</p>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col" v-if="mappingDeviceList.length == 0">
                    <div class="button button-fill button-save" v-on:click="toNetwork()">{{_("to Network")}}</div>
                  </div>
                  <div class="col" v-if="mappingDeviceList.length > 0">
                    <div class="button button-fill button-save" v-on:click="mutiwayAction()">{{_("Next Step")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-9" class="view tab view-main" :class="[index == 9 ? 'tab-active' : '']" v-if="index == 9">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Move Closer To Device And Then Operate")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in otherMappingDeviceList"
                    :key="item.device"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>{{tran(item.title)}}</p>
                      <p style="font-size: 12px;">{{tran(item.room_name)}}/{{item.device_name}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeDeviceStatus(item)"
                        >check_box_outline_blank</i
                      >
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col" v-if="mappingDeviceList.length > 0">
                    <div class="button button-fill button-save" v-on:click="otherMutiwayAction()">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    let { name, sub_name } = $f7route.query;
    //let { guid, subdevice_name } = $f7route.query;
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          sceneList: [],
          SceneNameTip: _('Scene Name'),
          index: 0,
          actionGuid: '',
          subdeviceName: '',
          sheetMap: null,
          actionSheetMap: null,
          subdeviceMap: { title: '' },
          sceneImage: '',
          scene_tip: '',
          sceneName: '',
          secondSceneName : '',
          actionName: '',
          actionCurtainId_1 : '',
          actionCurtainId_2 : '',
          actionList: [],//first action list
          actionList_2 : [],//sconed action list 
          pickObj: null,
          virtualPick: null,
          rcuMacAddress: '',
          actionId: '',
          mutiwayStatus : 1,
          mainRcuId : '',
          attachRcuId : '',
          attachRcuGuid : '',
          trigger: [],//cutom trigger
          trigger_1 : [],//mapping actionList
          trigger_2 : [],//mapping actionList_2
          triggerActionId : '',
          timercommand: '',
          templateName: 'RCU Scene Button',
          actionMap: {},
          scenePostId: '',
          profileDeviceName: '',
          virtualList: [],
          virtualStatus: false,
          sceneDeviceLocation: [],
          uploadImage: '',
          triggerCondition: 2,
          rcuList: [],
          stepList : [],
          virtualIdList : {},//guid : id,
          overallVirtualId : '',
          overallSceneMap : {
            'trigger' : {},
            'action' : {
              actionList : [],
              actionList_2 : [],
              actionMap : {},
              actionMap_2 : {}
            },
            'scene_device_location':[],
            'ui_configuration' : {},
            'condition':{
              
            },
            'scene_template' : '',
            'profile_subdevice':'',
            'profile' : erp.info.profile.name,
          },
          scenePostMap_1:{
            'trigger' : {},
            'action' : {},
            'scene_device_location':[],
            'ui_configuration' : {
              'key' : 'first'
            },
            'condition':{
              
            },
            'scene_template' : '',
            'profile_subdevice':'',
            'profile' : erp.info.profile.name,
          },// if toggle scene have 3 scene setup
          scenePostMap_2:{
            'trigger' : {},
            'action' : {},
            'scene_device_location':[],
            'ui_configuration' : {
              'key' : 'second'
            },
            'condition':{
              
            },
            'scene_template' : '',
            'profile_subdevice':'',
            'profile' : erp.info.profile.name,
          },// if toggle scene have 3 scene setup
          scenePostMap_3:{
            'trigger' : {},
            'action' : {},
            'scene_device_location':[],
            'ui_configuration' : {
              'key' : 'third'
            },
            'condition':{
              
            },
            'scene_template' : '',
            'profile_subdevice':'',
            'profile' : erp.info.profile.name,
          },// if toggle scene have 3 scene setup
          templateConfig:{
            //type:1 choose tempalte,2 choose Rcu,3 
            rcu_scene_button: {
              name: 'RCU Scene Button',
              step:[{
                id : 1,
                relatedIndex : 0.5,
                name: '1',
              },{
                id : 2,
                relatedIndex : 1,
                name: '2',
              },{
                id : 3,
                relatedIndex : 2,
                name: '3',
              },{
                id : 4,
                relatedIndex : 3,
                name: '4',
              },{
                id : 5,
                relatedIndex : 4,
                name: '5',
              },{
                id : 5,
                relatedIndex : 5,
                name: '6',
              }]
            },
            rcu_scene_toggle:{
              name : 'RCU Scene Toggle',
              step:[{
                id : 1,
                relatedIndex : 0.5,
                name: '1',
              },{
                id : 2,
                relatedIndex : 1,
                name: '2',
              },{
                id : 3,
                relatedIndex : 2,
                name: '3',
              },{
                id : 5,
                relatedIndex : 7,
                name: '4',
              },{
                id : 6,
                relatedIndex : 3,
                name: '5',
              },{
                id : 7,
                relatedIndex : 4,
                name: '6',
              },{
                id : 8,
                relatedIndex : 5,
                name: '7',
              }]
            },
            rcu_randar:{
              name : 'RCU Radar',
              step:[{
                id : 1,
                relatedIndex : 0.5,
                name: '1',
              },{
                id : 2,
                relatedIndex : 1,
                name: '2',
              },{
                id : 3,
                relatedIndex : 2,
                name: '3',
              },{
                id : 4,
                relatedIndex : 3,
                name: '4',
              },{
                id : 5,
                relatedIndex : 4,
                name: '5',
              },{
                id : 5,
                relatedIndex : 5,
                name: '6',
              }]
            },
            rcu_click_and_stop:{
              name : 'RCU Click And Stop',
              step:[{
                id : 1,
                relatedIndex : 0.5,
                name: '1',
              },{
                id : 2,
                relatedIndex : 1,
                name: '2',
              },{
                id : 3,
                relatedIndex : 2,
                name: '3',
              },{
                id : 6,
                relatedIndex : 3,
                name: '4',
              },{
                id : 7,
                relatedIndex : 4,
                name: '5',
              },{
                id : 8,
                relatedIndex : 5,
                name: '6',
              }]
            },
            scene_button:{},
            multiway_switch:{
              name : 'Multiway Switch',
              step : [{
                id : 1,
                relatedIndex : 1,
                name: '1',
              },{
                id : 2,
                relatedIndex : 8,
                name: '2',
              },{
                id : 3,
                relatedIndex : 9,
                name: '3',
              }],
            },
            timmer : {}
          },
          templateList: [
            {
              name: 'RCU Scene Button',
              desription: '',
              icon: 'motion_photos_auto',
              color: '#5855e0',
            },
            {
              name: 'RCU Scene Toggle',
              desription: '',
              icon: 'touch_app',
              color: '#A85F32',
            },
            {
              name: 'RCU Radar',
              desription: '',
              icon: 'radar',
              color: '#3e3936',
            },
            {
              name: 'RCU Click And Stop',
              desription: '',
              icon: 'stop_circle',
              color: '#744020',
            },
            {
              name: 'Scene Button',
              desription: '',
              icon: 'autofps_select',
              color: '#f5c160',
            },
            {
              name: 'Multiway Switch',
              desription: '',
              icon: 'read_more',
              color: '#8fd1cb',
            },
            {
              name: 'Timer',
              desription: '',
              icon: 'snooze',
              color: '#b8bec5',
            },
          ], //
          oneOnly: false,
          timerList: [],
          hideDevice: false,
          conditionsMap: null,
          actionBleCommandList: [],
          actionLocation: {},
          randarActionCommand: {},
          extraActionList: [],
          extraTriggerList: [],
          isExtraStatus: false,
          isRelease: false,
          selfTriggered : false, //is trigger by self rcu
          selfTriggeredClickStatus : false,
          selfTriggeredButtonStatus : false,
          virtualTriggerList : [],
          subscribeMacadrress : '',
          //mutiway parameter
          mappingDeviceList : [],
          otherMappingDeviceList : [],
          mutiwayPostConfig:{
            //"guid" : {"mapping" : '',...}
          }
        },
        watch:{
          index:function(val){
            this.activeStepList();
          }
        },
        mounted() {
          this.init();
          this.initMutiwayDevices();
          emitter.on('trigger_save', (data) => {
            console.log(data);
            //if exist the same trigger, warn it
            let sameCheckStatus = false;
            this.trigger.forEach((item) => {
              if (item.title == data.display_name && item.button_group == data.button_group && item.guid === data.guid) {
                sameCheckStatus = true;
              }
            });
            if (sameCheckStatus) {
              app.dialog.alert(_('The trigger condition already exists. Please modify it.'));
              return;
            }
            const { button_group, display_name, mac_address, model, mode, img_url, room_name, guid, gateway, config } = data;
            let ref = data.value;
            let temp = data.temp;
            let hum = data.hum;
            let temp_less = data.temp_less;
            let hum_less = data.hum_less;
            let status = '';
            if (mode == 'RF Sensor' || mode == 'Radar Sensor' || button_group.startsWith('RCU INPUT')) {
              if (ref == 1) {
                status = 'Occupied';
              } else {
                status = 'Unoccupied';
              }
              //check if the tempalte is not rcu randar
              if (this.templateName != 'RCU Radar') {
                app.dialog.confirm(
                  _('The scene template is not a RCU Radar. Do you want to change?'),
                  () => {
                    this.templateName = 'RCU Radar';
                    this.index = 0;
                    this.trigger = [];
                  },
                  () => {}
                );
              }
              if (this.trigger.length > 0) {
                this.trigger[0].condition = this.triggerCondition;
              }
            } else if (mode == 'On Off Switch') {
              if (ref == 1) {
                status = 'ON';
              } else if (ref == 2) {
                status = 'CLICK';
              } else if (ref == 4) {
                status = 'CLICK AND STOP';
              } else if (ref == 3) {
                status = 'CLICK';
              } else {
                status = 'OFF';
              }
            } else if (mode == 'Thermostat') {
              if (temp) {
                status = `>${temp}℃/`;
              }
              if (temp_less) {
                status += `<${temp_less}℃/`;
              }
              if (hum) {
                status += `>${hum}%/`;
              }
              if (hum_less) {
                status += `<${hum_less}%/`;
              }
            } else if (mode == 'RCU Controller' && button_group == 'SCENE MUTIWAY ONOFF GANG1') {
              if (ref == 1) {
                status = 'ON';
              } else {
                status = 'OFF';
              }
            }
            if (gateway) {
              this.gateway = gateway;

              let gateway_mac = gateway.split('-')[0];
              this.gateway_mac = gateway_mac;
              //get guid of the gateway
              let list = erp.info.device;
              for (let i in list) {
                if (list[i].mac_address === gateway_mac) {
                  this.gateway_guid = i;
                }
              }
            }
            this.trigger.push({
              title: display_name,
              model: model,
              mode: mode,
              img_url: img_url,
              mac_address: mac_address,
              room_title: room_name,
              guid: guid,
              temp: temp,
              hum: hum,
              temp_less: temp_less,
              hum_less: hum_less,
              ref: ref,
              status: status,
              gateway: gateway,
              button_group: button_group,
              config: config,
              condition: this.triggerCondition,
            });
            if(mode == 'On Off Switch' && ref == 4){
              this.trigger.push({
                title: display_name,
                model: model,
                mode: mode,
                img_url: img_url,
                mac_address: mac_address,
                room_title: room_name,
                guid: guid,
                temp: temp,
                hum: hum,
                temp_less: temp_less,
                hum_less: hum_less,
                ref: 2,
                status: _('CLICK'),
                gateway: gateway,
                button_group: button_group,
                config: config,
                condition: this.triggerCondition,
                isHidden : true
              });
            }
            if (mode == 'On Off Switch' && ref == 3) {
              this.trigger.push({
                title: display_name,
                model: model,
                mode: mode,
                img_url: img_url,
                mac_address: mac_address,
                room_title: room_name,
                guid: guid,
                temp: temp,
                hum: hum,
                temp_less: temp_less,
                hum_less: hum_less,
                ref: 5,
                status: _('RELEASE'),
                gateway: gateway,
                button_group: button_group,
                config: config,
                condition: this.triggerCondition,
              });
            }
          });
          emitter.on('save_action', (data) => {
            console.log(data);
            let list = JSON.parse(data.data);
            //console.log(list);
            list.forEach((element) => {
              if(this.mutiwayStatus == 2){
                this.actionList_2.push(element);
              }else{
                this.actionList.push(element);
              }
            });
            console.log(this.actionList);
          });
          emitter.on('set_timmer', (data) => {
            console.log('set_timmer', data);
            this.timercommand = data.command;
            this.timerList = [];
            this.$set(this.timerList, 0, data);
            //this.timerList.push(data);
          });
        },
        methods: {
          async init() {
            let scenes = cloneDeep(erp.info.scene);
            this.loadErpData();
            //init the rcu data
            let devices = cloneDeep(erp.info.device);
            for (let i in devices) {
              if (devices[i].device_model.startsWith('YO780') && !devices[i].device_model.startsWith('YO780-Scene')) {
                //this.actionGuid = devices[i].guid;
                devices[i].ischeck = true;
                this.rcuList.push(devices[i]);
              }
            }
            //init the subdevice name
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            profile_devices.forEach((item) => {
              if (item.device == this.actionGuid) {
                this.profileDeviceName = item.name;
              }
            });
            profile_subdevices.forEach((item) => {
              if (item.device == this.actionGuid && item.device_button_group == 'ONOFF GANG1') {
                this.subdeviceName = item.name;
                this.subdeviceMap = item;
                console.log('subdeviceMap', this.subdeviceMap);
              }
            });
            //init the pick
            // this.pickObj = app.picker.create({
            //   inputEl: '#demo-picker-device',
            //   cols: [
            //     {
            //       textAlign: 'center',
            //       values: ['RCU Scene Button', 'RCU Radar', 'Multiway Switch', 'Scene Button', 'Timer'],
            //     },
            //   ],
            //   on: {
            //     change: (_, value) => {
            //       this.templateName = value[0];
            //     },
            //   },
            // });
            //this.pickObj.setValue(["RCU Scene Button"])
          },
          async initMutiwayDevices(){
            this.mappingDeviceList = [];
            let devices = cloneDeep(erp.info.profile.profile_device);
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let subdeviceMap;
            let deviceMap;
            subdevices.forEach(item=>{
              if(item.name == sub_name){
                subdeviceMap = item;
                this.subdeviceMap = item;
              }
            })
            const targetDevice = devices.find(kitem => kitem.name == subdeviceMap.profile_device);
            if (targetDevice) {
              const mappingDevices = devices.filter(kitem => 
                kitem.network_id != 0 && kitem.network_id == targetDevice.network_id && kitem.device_mode == 'Multiway Switch' && kitem.name != targetDevice.name);
              console.log("mappingDevices",mappingDevices)
              mappingDevices.forEach(item=>{
                subdevices.forEach(kitem=>{
                  if(item.name == kitem.profile_device){
                    kitem.device_name = item.device_name;

                    kitem.ischeck = false;
                    if(isset(this.mutiwayPostConfig[kitem.device])){
                      if(this.mutiwayPostConfig[this.subdeviceMap.device].mapping == kitem.name){
                        kitem.ischeck = true;
                      }
                    }
                    kitem.network_id = item.network_id;
                    this.mappingDeviceList.push(kitem);
                  }
                })
              })   
            }
          },
          postScene(postData){
            return new Promise((resolve,reject)=>{
              let url = encodeURI(`/api/resource/Scene`);
              let method = 'POST';
              if(this.scenePostId){
                url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                method = 'PUT';
              }
              http2.request(url, {
                method: method,
                serializer: 'json',
                responseType: 'json',
                debug: true,
                data: postData,
              }).then((rs)=>{
                resolve(1);
              }).catch((error)=>{
                reject(error)
              })
            })
          },
          async mutiwayAction(){
            app.dialog.preloader();
            this.otherMappingDeviceList = [];
            let devices = cloneDeep(erp.info.profile.profile_device);
            let this_gang = this.subdeviceMap.device_button_group.replace("ONOFF GANG","");
            let targetDevice;
            let profile_subdevice_data = {
              "mapping" : "",
              "virtual" : "",
              "pairing_guid" : ""
            };
            this.mappingDeviceList.forEach(item=>{
              if(item.ischeck){
                targetDevice = item;
              }
            })
            let command = ``;
            if(targetDevice){
              this.mutiwayPostConfig[this.subdeviceMap.device] = {}
              this.otherMappingDeviceList.push(targetDevice);
              let target_gang = targetDevice.device_button_group.replace("ONOFF GANG","");
              command = `02${core_utils_get_mac_address_from_guid(this.subdeviceMap.device,true)}81080${this_gang}fe${core_utils_get_mac_address_from_guid(targetDevice.device,true)}ff0${target_gang}00`;
              profile_subdevice_data["mapping"] = targetDevice.name;
              profile_subdevice_data["pairing_guid"] = targetDevice.device;
              this.mutiwayPostConfig[this.subdeviceMap.device]["mapping"] = targetDevice.name;
              this.mutiwayPostConfig[this.subdeviceMap.device]["pairing_guid"] = targetDevice.device;
            }else{
              command = `02${core_utils_get_mac_address_from_guid(this.subdeviceMap.device,true)}81080${this_gang}00`;              
            }
            try{
              await window.peripheral[this.subdeviceMap.device].write([{
                service: 'ff80',
                characteristic: 'ff81',
                data: command,
              }]);
              await iot_update_profile_subdevice_config(this.subdeviceMap.name,JSON.stringify(profile_subdevice_data));
              
              app.dialog.close();
              this.index = 9;
            }catch(error){
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          async otherMutiwayAction(){
            app.dialog.preloader();
            let profile_subdevice_data = {
              "mapping" : this.subdeviceMap.name,
              "virtual" : "",
              "pairing_guid" : this.subdeviceMap.device
            };
            this.mutiwayPostConfig[this.otherMappingDeviceList[0].device] = {};
            this.mutiwayPostConfig[this.otherMappingDeviceList[0].device]["mapping"] = this.subdeviceMap.name;
            this.mutiwayPostConfig[this.otherMappingDeviceList[0].device]["pairing_guid"] = this.subdeviceMap.device;
            let this_gang = this.otherMappingDeviceList[0].device_button_group.replace("ONOFF GANG","");
            let target_gang = this.subdeviceMap.device_button_group.replace("ONOFF GANG","");
            let command = `02${core_utils_get_mac_address_from_guid(this.otherMappingDeviceList[0].device,true)}81080${this_gang}fe${core_utils_get_mac_address_from_guid(this.subdeviceMap.device,true)}ff0${target_gang}00`;
            try{
              await window.peripheral[this.subdeviceMap.device].write([{
                service: 'ff80',
                characteristic: 'ff81',
                data: command,
              }]);
              await iot_update_profile_subdevice_config(this.otherMappingDeviceList[0].name,JSON.stringify(profile_subdevice_data));
              //post to the scene
              let post_scene_data = {
                title: this.sceneName,
                profile: erp.info.profile.name,
                profile_subdevice: isset(sub_name) && sub_name != 'undefined' ? sub_name : this.subdeviceName,
                scene_template : this.templateName,
                trigger : JSON.stringify({}),
                action : JSON.stringify({}),
                ui_configuration : JSON.stringify({}),
                condition : JSON.stringify(this.mutiwayPostConfig),
                image : this.uploadImage,
              }
              await this.postScene(post_scene_data);
              await ha_profile_ready();
              app.dialog.close();
              mainView.router.back();
            }catch(error){
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          toNetwork(){
            mainView.router.navigate(`/mobile-app/device-network-guid-list`);
          },
          async sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          },
          changeDeviceStatus(item){
            this.mappingDeviceList.forEach(kitem=>{
              if(item.name != kitem.name){
                kitem.ischeck = false;
              }
            })
            item.ischeck = !item.ischeck;
          },
          changeRcuStatus(item) {
            console.log('item', item);
            item.ischeck = !item.ischeck;
          },
          switchOneOnly() {
            this.oneOnly = !this.oneOnly;
            if (this.oneOnly) {
              //must be input the virtual button name
              this.virtualStatus = true;
            }
          },
          switchSelfTrigger(type){
            if(type ==1){
              this.selfTriggeredClickStatus = !this.selfTriggeredClickStatus;
              if(this.selfTriggeredClickStatus){
                //check if have some rcu
                this.trigger = [];
                this.rcuList.forEach((item) => {
                  if(item.ischeck){
                    this.trigger.push({
                      guid : item.guid,
                      button_group : 'SCENE MUTIWAY ONOFF GANG1',
                      ref : this.selfTriggeredButtonStatus?'01':'00',
                      img_url: 'https://my.yoswit.com/files/YO780.svg',
                      title : 'YO780',
                      mac_address : item.mac_address,
                      mode : item.device_mode,
                      model : item.device_model
                    })
                  }
                })
              }else{
                this.selfTriggeredButtonStatus = false;
              }
            }else{
              this.selfTriggeredButtonStatus = !this.selfTriggeredButtonStatus;
              this.trigger.forEach(item=>{
                item.ref = this.selfTriggeredButtonStatus?'01':'00';
              })
            }
          },
          activeStepList(){
            this.stepList.forEach(item=>{
              if(item.relatedIndex == this.index){
                item.isActive = true;
              }else{
                item.isActive = false;
              }
            })
          },
          async chooseTemplate(item) {
            this.templateName = item.name;
            let activeIndex = '';
            //change the template config
            for(let j in this.templateConfig){
              if(this.templateConfig[j].name == item.name){
                this.stepList = this.templateConfig[j].step;
              }
            }
            if(this.templateName == 'Multiway Switch'){
              this.index = 1;
            }else{
              this.index = 0.5;
            }
            this.activeStepList();
          },
          async chooseRcuDevice() {
            //must be handle any rcu
            app.dialog.preloader();
            let ischeckIndex = 0;
            this.rcuList.forEach((item) => {
              if (item.ischeck) {
                this.actionGuid = item.guid;
                ischeckIndex++;
              }
            });
            if(ischeckIndex>1){
              let subscribeMap = {};
              let postMap = {};
              let devices = cloneDeep(erp.info.device);
              this.rcuList.forEach((item) => {
                let guid = item.guid;
                if(isset(devices[guid])){
                  let settings = devices[guid].settings;
                  settings.forEach(kitem=>{
                    if(kitem.setting_type.startsWith("subscribe_")){
                      let keys = kitem.setting_type.split("_");
                      let value = kitem.setting;
                      subscribeMap[keys[1]] = value;
                    }
                  })
                }
                if(peripheral[guid].prop.is_mobmob == 1){
                  this.actionGuid = guid;
                }
              });
              //if rcu length > 1,should subscribe the address
              for(let i in subscribeMap){
                this.subscribeMacadrress = subscribeMap[i];
              }
              if(this.subscribeMacadrress == ''){
                //post to erp
                let obj = {};
                this.rcuList.forEach(item=>{
                  obj[item.guid] = {};
                  this.rcuList.forEach(kitem=>{
                    if(item.guid != kitem.guid){
                      obj[item.guid][`subscribe_${kitem.guid}`] = '00C0';
                    }
                  })
                })
                this.subscribeMacadrress = '00C0';
                //console.log(obj)
                for(let i in obj){
                  try{
                    await iot_device_setting_sync_server(i,Object.keys(obj[i])[0],obj[i][Object.keys(obj[i])[0]])
                  }catch(error){
                    app.dialog.close();
                    app.dialog.alert(error);
                  }
                }
              }
            }
            
            // if (ischeckIndex == 0 || ischeckIndex >= 1) {
            //   this.actionGuid = this.rcuList[0].guid;
            // }
            app.dialog.close();
            this.initActionSheet();
            //connect the rcu Device
            let rcuConnectStatus = true;
            for (let i in this.rcuList) {
              if (this.rcuList[i].ischeck) {
                let guid = this.rcuList[i].guid;
                try {
                  if(window.peripheral[guid].prop.connected){
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').addClass('text-color-green');
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').html('check_circle');
                  }else{
                    await window.peripheral[guid].connect();
                    //subscribe the address
                    //16 + 00(unsubscribe)/01(subscribe) + address
                    await window.peripheral[guid].write([{
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: `1601${this.subscribeMacadrress}`,
                    }])
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').addClass('text-color-green');
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').html('check_circle');
                  }
                } catch (error) {
                  console.log(error);
                  rcuConnectStatus = false;
                }
              }
            }
            if (rcuConnectStatus) {
              if (this.actionSheetMap) {
                this.actionSheetMap.close();
              }
              this.index = 1;
            } else {
              app.dialog.confirm(
                `Rcu connect failed,reconnect?`,
                async () => {
                  for (let i in this.rcuList) {
                    if (this.rcuList[i].ischeck) {
                      let guid = this.rcuList[i].guid;
                      try {
                        await window.peripheral[guid].disconnect();
                      } catch (error) {
                        console.log(error);
                      }
                    }
                  }
                  this.chooseRcuDevice();
                },
                () => {}
              );
            }
          },
          //defined the get secen Id Fun
          getDeviceBleId(guid){
            let sceneDeviceLocationList = [];
            let sceneObj = cloneDeep(erp.info.scene);
            let idList = [];
            for(let i in sceneObj){
              sceneObj[i].scene_device_location.forEach((item) => {
                sceneDeviceLocationList.push(item);
              });
            }
            sceneDeviceLocationList.forEach((kitem) => {
              if (kitem.device == guid) {
                idList.push(parseInt(kitem.storage_id));
              }
            });
            return this.findMissingNumber(idList);
          },
          async toTab(index) {
            return;
            this.scrollItem(120);

            this.index = index;
          },
          deleteVirtual(name) {
            this.virtualList.forEach((item) => {
              item.display = false;
            });
          },
          deleteTimer() {
            this.timerList = [];
            this.timercommand = '';
          },
          deleteActionItem(name) {
            console.log(this.actionList);
            console.log(name);
            const index = this.actionList.findIndex((item) => item.name === name);
            if (index >= 0) {
              this.actionList.splice(index, 1);
            }
          },
          deleteTriggerItem(index) {
            this.trigger.splice(index, 1);
          },
          async loadErpData() {
            this.scenePostId = name;
            let scenes = cloneDeep(erp.info.scene);
            for (let i in scenes) {
              if (name == i) {
                this.sceneName = scenes[i].title;
                this.scenePostId = name;
                this.templateName = scenes[i].scene_template;
                //init the action name and the list
                let actionMap = JSON.parse(scenes[i].action);
                this.actionId = actionMap.actionId;
                debugger
                this.actionName = actionMap.title;
                this.actionList = actionMap.actionList;
                this.trigger = JSON.parse(scenes[i].trigger);
                //del the connect status
                this.trigger.forEach(item=>{
                  item.isBle = false;
                })
                //this.virtualStatus = actionMap.isVirtual;
                if(this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Click And Stop'){
                  this.actionList = actionMap.actionList;
                  this.actionList_2 = actionMap.actionList_2;
                  
                  debugger
                }
                if (scenes[i].image) {
                  this.sceneImage = 'url(' + scenes[i].image + ')';
                  this.uploadImage = scenes[i].image;
                }
                if (isset(scenes[i].condition)) {
                  try {
                    let condition = JSON.parse(scenes[i].condition);
                    //if mutiway template
                    if(this.templateName == 'Multiway Switch'){
                      this.mutiwayPostConfig = condition;
                      return
                    }
                    //this.virtualList = condition;
                    this.conditionsMap = condition;
                    this.timerList = condition.timerList ? condition.timerList : [];
                    if (this.timerList.length) {
                      this.timercommand = this.timerList[0].command;
                    }
                    this.oneOnly = condition.only;
                  } catch (error) {
                    console.log(error);
                  }
                }
                if (isset(scenes[i].ui_configuration)) {
                  let uiConfiguration = JSON.parse(scenes[i].ui_configuration);
                  this.actionName = uiConfiguration.virtualButtonName;
                  this.isHidden = uiConfiguration.isHidden;
                  this.virtualStatus = uiConfiguration.virtualStatus;
                  //check is RCU Toggle Scene
                  // if(uiConfiguration.key == 'first'){
                  //   let this_name = name;
                  //   this.sceneName = scenes[i].title;
                  //   let actionMaps = JSON.parse(scenes[i].action);
                  //   this.actionList = actionMaps.actionList;
                  //   //find 
                  //   for (let j in scenes){
                  //     if(isset(scenes[j].ui_configuration)){
                  //       let uiConfig = JSON.parse(scenes[j].ui_configuration);
                  //       if(uiConfig.mapping == this_name){
                  //         if(uiConfig.key == 'second'){
                  //           this.secondSceneName = scenes[j].title;
                  //           let actionMapss = JSON.parse(scenes[j].action);
                  //           this.actionList_2 = actionMapss.actionList;
                  //         }
                  //         if(uiConfig.key == 'third'){
                  //           let actionMapss = JSON.parse(scenes[j].trigger);
                  //           this.trigger = actionMapss.trigger;
                  //         }
                  //       }
                  //     }
                  //   }
                  // }
                  // if(uiConfiguration.key == 'second'){
                  //   let this_name = name;
                  //   this.secondSceneName = scenes[i].title;
                  //   let actionMaps = JSON.parse(scenes[i].action);
                  //   this.actionList_2 = actionMaps.actionList;
                  //   //find 
                  //   for (let j in scenes){
                  //     if(isset(scenes[j].ui_configuration)){
                  //       let uiConfig = JSON.parse(scenes[j].ui_configuration);
                  //       if(uiConfig.mapping == this_name){
                  //         if(uiConfig.key == 'first'){
                  //           this.sceneName = scenes[j].title;
                  //           let actionMapss = JSON.parse(scenes[j].action);
                  //           this.actionList = actionMapss.actionList;
                  //         }
                  //         if(uiConfig.key == 'third'){
                  //           let actionMapss = JSON.parse(scenes[j].trigger);
                  //           this.trigger = actionMapss.trigger;
                  //         }
                  //       }
                  //     }
                  //   }
                  // }
                  // if(uiConfiguration.key == 'third'){
                  //   let this_name = name;
                  //   //find 
                  //   for (let j in scenes){
                  //     if(isset(scenes[j].ui_configuration)){
                  //       let uiConfig = JSON.parse(scenes[j].ui_configuration);
                  //       if(uiConfig.mapping == this_name){
                  //         if(uiConfig.key == 'first'){
                  //           this.sceneName = scenes[j].title;
                  //           let actionMapss = JSON.parse(scenes[j].action);
                  //           this.actionList = actionMapss.actionList;
                  //         }
                  //         if(uiConfig.key == 'second'){
                  //           this.secondSceneName = scenes[j].title;
                  //           let actionMapss = JSON.parse(scenes[j].action);
                  //           this.actionList_2 = actionMapss.actionList;
                  //         }
                  //       }
                  //     }
                  //   }
                  // }   
                }
                // console.log("actionMap.isVirtual",actionMap);
                // if(isset(actionMap.isVirtual) && actionMap.isVirtual){
                //   $(`input[name="virtual_button"]`).trigger('click');
                // }
              }
            }
            //if subdevice name is scene-gang
          },
          getVirtualButtonId(guid){
            //virtual button id is same to the some rcu status
            let sceneDeviceLocationList = [];
            let sceneObj = cloneDeep(erp.info.scene);
            let idList = [];
            for(let i in sceneObj){
              if(isset(sceneObj[i].scene_virtual_button)){
                sceneObj[i].scene_virtual_button.forEach((item) => {
                  sceneDeviceLocationList.push(item);
                });
              }
            }
            sceneDeviceLocationList.forEach((kitem) => {
              if (kitem.device == guid) {
                idList.push(parseInt(kitem.virtual_button_id));
              }
            });
            debugger
            return this.findMissingNumber(idList);
            //how to handle if del the scene
            // let scenes = cloneDeep(erp.info.scene);
            // let virtualIdList = [];
            // for(let i in scenes){
            //   if(isset(scenes[i].ui_configuration) && scenes[i].ui_configuration){
            //     let ui_config = JSON.parse(scenes[i].ui_configuration);
            //     if(isset(ui_config.virtualId)){
            //       //1,2,3,.....
            //       virtualIdList.push(ui_config.virtualId);
            //     }
            //   }
            // }
            // return this.findMissingNumber(virtualIdList);
          },
          changeVirtualStatus() {
            if (this.oneOnly) {
              app.dialog.alert(_('Since you have selected to run only once, this option cannot be modified'));
              return;
            }
            this.virtualStatus = !this.virtualStatus;
          },
          changeHideDevice() {
            this.hideDevice = !this.hideDevice;
          },
          async buttonAndSetting() {
            // showPick() {
            // this.pickObj.open();
           app.dialog.preloader();
            console.log("overallSceneMap",this.overallSceneMap)
            if(this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Click And Stop'){
              let url = encodeURI(`/api/resource/Scene`);
              let method = 'POST';
              if(this.scenePostId){
                url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                method = 'PUT';
              }
              let scene_virtual_button = [];
              for(let i in this.virtualIdList){
                scene_virtual_button.push({
                  device : i,
                  virtual_button_id : this.virtualIdList[i]
                })
              }
              
              let post_data = {
                title: this.sceneName,
                profile: erp.info.profile.name,
                profile_subdevice: isset(sub_name) && sub_name != 'undefined' ? sub_name : this.subdeviceName,
                scene_template : this.templateName,
                trigger : JSON.stringify(this.overallSceneMap['trigger']),
                action : JSON.stringify(this.overallSceneMap['action']),
                condition : JSON.stringify(this.overallSceneMap['condition']),
                image : this.uploadImage,
                ui_configuration : JSON.stringify(this.overallSceneMap['ui_configuration']),
                scene_device_location : this.overallSceneMap['scene_device_location'],
                scene_virtual_button : scene_virtual_button
              }
              if(this.scenePostId){
                delete post_data.scene_device_location;
                delete post_data.scene_virtual_button;
              }
              let postStatus = await http2.request(url, {
                method: method,
                serializer: 'json',
                responseType: 'json',
                debug: true,
                data: post_data,
              });
              await ha_profile_ready();
            }
            debugger;
            //save the virtual button and the hide setting
            if (this.oneOnly) {
              let postStatus = true;
              let gang = this.actionId;
              let $command = `972103${gang.toString(16).pad('00')}${'01'}`;
              let strList = this.actionMap.actioncommand.split('');
              let $thisLength = $command.length / 2;
              let $totalLength = parseInt(strList.slice(8, 10).join(''), 16);
              let newLength = ($totalLength + $thisLength + 1).toString(16).pad('00');
              strList[8] = newLength[0];
              strList[9] = newLength[1];
              this.actionMap.actioncommand = `${strList.join('')}${$thisLength.toString(16).pad('00')}${$command}`;
              //save to rcu ble
              try {
                await window.peripheral[this.actionGuid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: this.actionMap.actioncommand,
                  },
                ]);
              } catch (error) {
                postStatus = false;
                app.dialog.close();
                app.dialog.confirm(
                  `${_('Connection failed,reconnect?')}`,
                  async () => {
                    if (window.peripheral[this.actionGuid].prop.connected) {
                      await peripheral[this.actionGuid].disconnect();
                      this.buttonAndSetting();
                    } else {
                      this.buttonAndSetting();
                    }
                  },
                  () => {}
                );
              }
              if (postStatus) {
                let url = `/api/resource/Scene/${this.scenePostId}`;
                let method = 'PUT';
                let postStatus = await http.request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: {
                    action: JSON.stringify(this.actionMap),
                  },
                });
              }
            }
            //post the data to the erp
            try {
              if (this.virtualStatus) {
                if (this.actionName == '' || !this.actionName) {
                  app.dialog.close();
                  app.dialog.alert(_('Please enter the virtual button name'));
                  return;
                }
                let devices = cloneDeep(erp.info.device);
                let deviceObj = devices[this.actionGuid];
                let subUrl = `/api/resource/Profile Subdevice`;
                let subMethod = 'POST';
                if (this.scenePostId) {
                  let config = parseInt(this.actionId);
                  let this_sub_name = '';
                  let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                  profile_subdevices.forEach((item) => {
                    if (
                      item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1' &&
                      item.device == this.actionGuid &&
                      item.config &&
                      parseInt(item.config) == config
                    ) {
                      this_sub_name = item.name;
                    }
                  });
                  if (this_sub_name) {
                    subUrl = `/api/resource/Profile Subdevice/${this_sub_name}`;
                    subMethod = 'PUT';
                  }
                }
                let profile_devices = cloneDeep(erp.info.profile.profile_device);
                profile_devices.forEach((item) => {
                  if (item.device == this.actionGuid) {
                    this.profileDeviceName = item.name;
                  }
                });
                let post_data = {
                  parenttype: 'Profile',
                  parent: erp.info.profile.name,
                  parentfield: 'profile_subdevice',
                  profile_room: erp.info.profile.profile_room[0].name,
                  profile_device: this.profileDeviceName,
                  device: this.actionGuid,
                  title: this.actionName,
                  device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                  device_mode: deviceObj.device_mode,
                  config: `${this.actionId}`,
                  hidden: this.hideDevice ? 1 : 0,
                };
                debugger
                await http.request(encodeURI(subUrl), {
                  method: subMethod,
                  serializer: 'json',
                  responseType: 'json',
                  data: post_data,
                  debug: true,
                });
                for(let j in this.actionLocation){
                  if(j !== this.actionGuid){
                    let post_device_name = '';
                    profile_devices.forEach((item) => {
                      if (item.device == j) {
                        post_device_name = item.name;
                      }
                    });
                    let post_data = {
                      parenttype: 'Profile',
                      parent: erp.info.profile.name,
                      parentfield: 'profile_subdevice',
                      profile_room: erp.info.profile.profile_room[0].name,
                      profile_device: post_device_name,
                      device: j,
                      title: this.actionName,
                      device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                      device_mode: deviceObj.device_mode,
                      config: `${this.actionId}`,
                      hidden: this.hideDevice ? 1 : 0,
                    };
                    await http.request(encodeURI(`/api/resource/Profile Subdevice`), {
                      method: 'POST',
                      serializer: 'json',
                      responseType: 'json',
                      data: post_data,
                      debug: true,
                    });
                  }
                }
                //post to the scene
                let ui_url = `/api/resource/Scene/${this.scenePostId}`;
                let ui_method = 'PUT';
                let postStatus = await http.request(ui_url, {
                  method: ui_method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: {
                    ui_configuration: JSON.stringify({
                      virtualButtonName: this.actionName,
                      isHidden: this.hideDevice,
                      virtualStatus: this.virtualStatus,
                    }),
                  },
                });
                await ha_profile_ready();
                setTimeout(() => {
                  mainView.router.back();
                  app.dialog.close();
                }, 1500);
              } else {
                mainView.router.back();
                app.dialog.close();
              }
            } catch (error) {
              console.log(error);
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          //this is the save RCU scene toggle logic
          async saveRcuTrigger(){
            return new Promise(async(resolve,reject)=>{
              //type is control the virtual button on/off,1 on,0 off
              if(this.templateName == 'RCU Scene Toggle'){
                //save the RCU trigger
                let actualActionList = this.strucActionList(this.actionList);
                let actionCommandList = this.postActionBle(actualActionList);
                let postBleStatus = true;
                let errorLog = '';
                let mainRcuId = '';
                let rcuIndex = 0;
                for(let i in actionCommandList){
                  //composition the rcu trigger command
                  debugger
                  // if(i != this.actionGuid){
                  //   continue;
                  // }
                  let type = 1;
                  if(this.mutiwayStatus == 2){
                    type = 0;
                  }
                  let guid = i;
                  let mac = core_utils_get_mac_address_from_guid(i,true);
                  let typeIndex = '1f';
                  let ref = parseInt(type).toString(16).pad("00");
                  let opcode = '00';
                  let gang = this.actionLocation[i];
                  // alert(i)
                  // alert(gang);
                  let virtualGang = this.virtualIdList[i]?this.virtualIdList[i]:this.getVirtualButtonId(i);
                  //alert(virtualGang);
                  if(!this.virtualIdList[i]){
                    this.virtualIdList[i] = virtualGang;
                  }
                  // if(rcuIndex == 0){
                  //   mainRcuId = gang
                  // }
                  let pre_command = `8F2000${parseInt(gang).toString(16).pad("00")}${parseInt(gang).toString(16).pad("00")}`;
                  let $thisCommand = `${opcode}${typeIndex}${mac}00${ref}13${parseInt(virtualGang).toString(16).pad('00')}`;
                  $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                  let totalCommand = `${pre_command}${$thisCommand}`;
                  console.log("$thisCommand",$thisCommand);
                  rcuIndex++;
                  if(this.templateName == 'RCU Scene Toggle'){
                    if(!isset(this.overallSceneMap['action'][i])){
                      this.overallSceneMap['action'][i] = {}
                    }
                    this.overallSceneMap['action'][i]['trigger'] = totalCommand;
                  }
                  //post to the ble 
                  try{
                    await window.peripheral[i].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: totalCommand,
                    },
                  ]);
                  }catch(error){
                    postBleStatus = false;
                    errorLog = error;
                  }
                }
                if(postBleStatus){
                  resolve(1);
                }else{
                  reject(errorLog);
                }
              }else{
                resolve(1);
              }
            })
          },
          //create a toggle scene action
          createVirtualAction(type){
            return new Promise(async(resolve,reject)=>{
              if(this.templateName == 'RCU Scene Toggle'){
                let gang = this.actionLocation[this.actionGuid];
                debugger
                let sceneId = this.getDeviceBleId(this.actionGuid);
                let mac = core_utils_get_mac_address_from_guid(this.actionGuid,true);
                let this_data = `972103${gang.toString(16).pad('00')}02`;
                let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                let actioncommand_pre = `8F1000${parseInt(sceneId).toString(16).pad('00')}`;
                let totalActionCommand = `${actioncommand_pre}${($command.length/2).toString(16).pad("00")}${$command}`;
                console.log('totalActionCommand',totalActionCommand);
                this.triggerActionId = sceneId;
                debugger
                try {
                  await window.peripheral[this.actionGuid].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: totalActionCommand,
                    },
                  ]);
                  this.scenePostMap_1['action']['virtualAction']= totalActionCommand;
                  resolve(1)
                }catch(error){
                  reject(error);
                }
              }else{
                resolve(1)
              }
            })
          },
          //simulate the post scene data.in order to case the scene id repeat
          simulateScenePostId(guid,id){
            debugger
            let sceneDeviceLocationList = [];
            let sceneObj = cloneDeep(erp.info.scene);
            let key = new Date().getTime();
            sceneObj[`${key}`] = {
              'scene_device_location' : [],
              'is_enabled' : 0
            };
            sceneObj[`${key}`]['scene_device_location'].push({
              device : guid,
              storage_id : id
            });
            erp.info.scene = sceneObj;
          },
          async saveActionInRcu() {
            let list = this.actionList;
            // if(this.mutiwayStatus == 2){
            //   list = this.actionList_2;
            // }
            // if (!this.actionName) {
            //   app.dialog.alert(`${tran('Please input the action name.')}`);
            //   return;
            // }
            let virtual_button_check = $(`input[name="virtual_button"]:checked`).val();
            app.dialog.preloader();
            let timer = setTimeout(() => {
              app.dialog.close();
            }, 10000);
            // let sceneObj = erp.info.scene;
            // let sceneId = this.actionId ? this.actionId : this.getDeviceBleId(idList);
            // this.actionId = sceneId;
            try {
              await this.saveActionOnBle();
              await this.saveRcuTrigger(1);
              //await this.createVirtualAction()
              this.actionMap.actionList = this.actionList;
              this.actionMap.actionId = this.actionId;
              this.actionMap.title = this.actionName;
              this.actionMap.isVirtual = isset(virtual_button_check) ? true : false;
              if (isset(virtual_button_check)) {
                await this.addSubdeviceInErp(sceneId);
              }
              if(timer){
                clearTimeout(timer)
              }
              if(this.templateName == 'RCU Scene Toggle' && this.mutiwayStatus == 1){
                this.index = 7;
                this.mutiwayStatus = 2;
              }else if(this.templateName == 'RCU Click And Stop'){
                if(this.mutiwayStatus == 2){
                  this.index = 3;
                }else{
                  this.mutiwayStatus = 2;
                  //change the action list
                  let thisList = cloneDeep(this.actionList);
                  //change the ref to the pause
                  thisList.forEach(kitem=>{
                    if(kitem.device_model == 'YO121-AC-R2W'){
                      let command = `02${core_utils_get_mac_address_from_guid(kitem.device,true)}860255fefe030338e5`;
                      kitem.action_command = command
                    }else{
                      let command = `02${core_utils_get_mac_address_from_guid(kitem.device,true)}55AA050101036DDC`;
                      kitem.action_command = command;
                    }
                  })
                  this.actionList_2 = thisList;
                  this.saveActionInRcu();
                }
              }else{
                this.index = 3;
              }
              if(this.templateName == 'RCU Scene Toggle'){
                this.scrollItem(110);
                app.dialog.close();
                return
              }else if(this.templateName == 'RCU Click And Stop'){
                //run again
                if(this.mutiwayStatus == 2){
                  this.scrollItem(110);
                  app.dialog.close();
                  return
                }
              }else{
                let url = ``;
                let method = 'POST';
                if (this.scenePostId) {
                  url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                  method = 'PUT';
                } else {
                  url = encodeURI(`/api/resource/Scene`);
                }
                let scene_device_location = [];
                for (let i in this.actionLocation) {
                  scene_device_location.push({
                    device: i,
                    storage_id: this.actionLocation[i],
                  });
                }
                let post_data = {
                  title: this.sceneName,
                  profile: erp.info.profile.name,
                  profile_subdevice: isset(sub_name) && sub_name != 'undefined' ? sub_name : this.subdeviceName,
                  scene_template: this.templateName,
                  trigger: JSON.stringify(this.trigger),
                  action: JSON.stringify(this.actionMap),
                  condition: JSON.stringify(this.conditionsMap),
                  image: this.uploadImage,
                  ui_configuration: JSON.stringify({}),
                  scene_device_location: scene_device_location,
                };
                if (this.scenePostId) {
                  delete post_data.scene_device_location;
                }
                let postStatus = await http.request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: post_data,
                });
                console.log('postStatus', postStatus);
                if (isset(postStatus.data.data.name)) {
                  this.scenePostId = postStatus.data.data.name;
                  this.sceneDeviceLocation = postStatus.data.data.scene_device_location;
                }
                this.index = 3;
                app.dialog.close();
                this.scrollItem(110);
              }
            } catch (error) {
              console.log(error);
              this.index = 2;
              if (error == 6007) {
                //try to disconnect and the connect the rcu data
                app.dialog.confirm(
                  `${_('Connection experienced some issues, would you like to retry connecting?')}`,
                  async () => {
                    for (let i in this.rcuList) {
                      let guid = this.rcuList[i].guid;
                      if (window.peripheral[guid].prop.connected) {
                        await window.peripheral[guid].disconnect();
                      }
                    }
                    this.saveActionInRcu();
                  },
                  () => {}
                );
              } else {
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            }
          },
          async saveTriggerOnErp(list) {
            return new Promise(async (resolve, reject) => {
              // list.forEach(item=>{
              //   this.sceneDeviceLocation.push(item)
              // })
              this.trigger.forEach((item) => {
                delete item.isBle;
              });
              this.sceneDeviceLocation = this.mergeAndDeduplicateByProperties(this.sceneDeviceLocation, list, 'device', 'storage_id');
              console.log('this.sceneDeviceLocation', this.sceneDeviceLocation);
              //filter the condotion
              let conditionList = [];
              // this.virtualList.forEach((item) => {
              //   if (item.display) {
              //     conditionList.push(item);
              //   }
              // });
              let conditionMap = {};
              conditionMap['timerList'] = this.timerList;
              conditionMap['only'] = this.oneOnly;
              let post_data = {
                trigger: JSON.stringify(this.trigger),
                condition: JSON.stringify(conditionMap),
                scene_device_location: this.sceneDeviceLocation,
              };

              if (list.length == 0) {
                delete post_data.scene_device_location;
              }
              let url = `/api/resource/Scene/${this.scenePostId}`;
              let method = 'PUT';
              try {
                let postStatus = await http.request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: post_data,
                });
                resolve();
              } catch (error) {
                console.log(error);
                reject(error);
                //app.dialog.alert(error)
              }
            });
          },
          mergeAndDeduplicateByProperties(array1, array2, prop1, prop2) {
            let map = new Map();
            let mergedArray = [...array1, ...array2];
            mergedArray.forEach((item) => {
              if (item[prop1] && item[prop2]) {
                const key = `${item[prop1]}-${item[prop2]}`;
                if (!map.has(key)) {
                  map.set(key, item);
                } else {
                  // 检查是否满足两个属性都相同的条件
                  let existingItem = map.get(key);
                  if (existingItem[prop1] === item[prop1] && existingItem[prop2] === item[prop2]) {
                    // 符合条件则进行合并，覆盖旧值
                    map.set(key, item);
                  }
                }
              }
            });
            let deduplicatedArray = Array.from(map.values());
            return deduplicatedArray;
          },
          loadingDeviceConnect(guid, button_group) {
            console.log('dom', $(`.manufacturing-steps[guid="${guid}"][button_group="${button_group}"]`).find('.item-after i'));
            $(`.manufacturing-steps[guid="${guid}"][button_group="${button_group}"]`).find('.item-after i').addClass('text-color-green');
            $(`.manufacturing-steps[guid="${guid}"][button_group="${button_group}"]`).find('.item-after i').html('check_circle');
          },
          initActionSheet() {
            let sheetItem = ``;
            this.rcuList.forEach((item, index) => {
              if (!item.ischeck) {
                return;
              }
              sheetItem += `
              <li class="manufacturing-steps scenes-item-step-${index + 1}" guid="${item.guid}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">RCU${index + 1}: ${item.mac_address}
                      </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>
              `;
            });
            let sheetContent = /*html*/ `
            <div class="sheet-modal" style="height:auto">
            	<div class="sheet-modal-inner">
            		<div class="swipe-handler"></div>
            		<div class="page-content">
            			<div class="list list-strong list-outline list-dividers-ios">
            				<ul>
                      ${sheetItem}
            				</ul>
            			</div>
            			<div class="block scene-retry device-hidden" style="text-align:center;padding-left:15px;padding-right:15px;">
            				<div class="button button-fill button-save" style="padding:15px;" v-on:click="nextStep(1)">${_('Retry')}</div>
            			</div>
            		</div>
            	</div>
            </div>
            `;
            if (isset(this.actionSheetMap)) {
              this.actionSheetMap.open();
              return;
            }
            this.actionSheetMap = app.sheet.create({
              content: `${sheetContent}`,
              on: {
                closed: function () {},
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.actionSheetMap.open();
          },
          //show the trigger connecting UI
          initSheetTriggerContent() {
            let sheetItem = ``;
            this.trigger.forEach((item, index) => {
              if(isset(item.isHidden)){
                return
              }
              sheetItem += `
              <li class="manufacturing-steps scenes-item-step-${index + 1}" guid="${item.guid}" button_group="${item.button_group}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">设备${index + 1}: ${item.title}
                      <span class="text-muted" style="font-size:12px;">(${tran(item.room_title)}/${item.mac_address})</span>
                      </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>
              `;
            });
            let sheetContent = /*html*/ `
            <div class="sheet-modal" style="height:auto">
            	<div class="sheet-modal-inner">
            		<div class="swipe-handler"></div>
            		<div class="page-content">
            			<div class="list list-strong list-outline list-dividers-ios">
            				<ul>
                      ${sheetItem}
            				</ul>
            			</div>
            			<div class="block scene-retry device-hidden" style="text-align:center;padding-left:15px;padding-right:15px;">
            				<div class="button button-fill button-save" style="padding:15px;" v-on:click="nextStep(1)">${_('Retry')}</div>
            			</div>
            		</div>
            	</div>
            </div>
            `;
            if (isset(this.sheetMap)) {
              this.sheetMap.open();
              return;
            }
            this.sheetMap = app.sheet.create({
              content: `${sheetContent}`,
              on: {
                closed: function () {},
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.sheetMap.open();
          },
          scrollItem(num) {
            const scrollContainer = document.querySelector('.scene-toolbar-inner');
            scrollContainer.scrollBy({
              top: 0,
              left: num,
              behavior: 'instant',
            });
          },
          async saveErrorTriggerOnble(list) {},
          async saveTriggerOnble() {
            //app.dialog.preloader();
            let sceneObj = erp.info.scene;
            let sceneDeviceLocationList = [];
            let postStatus = true;
            //get exist scene id
            for (let i in sceneObj) {
              sceneObj[i].scene_device_location.forEach((item) => {
                sceneDeviceLocationList.push(item);
              });
            }
            let postIdList = [];
            if (this.templateName == 'RCU Radar') {
              app.dialog.preloader();
              //handle any rcu
              let rcuGuid = '';
              for (let i in this.actionBleCommandList) {
                //should be know whats rcu input
                let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                subdevices.forEach((item) => {
                  if (item.name == sub_name) {
                    rcuGuid = item.device;
                  }
                });
              }
              if (!rcuGuid) {
                app.dialog.close();
                app.dialog.alert(_('Unable to identify RCU input port.'));
                return;
              }
              let guid = rcuGuid;
              let this_mac = core_utils_get_mac_address_from_guid(rcuGuid, true);
              let this_sceneId = this.actionLocation[rcuGuid];
              let last_command = ``;
              if (this.timercommand.length) {
                last_command = `${this.randarCommand(this_sceneId.toString(16).pad('00'), this_sceneId.toString(16).pad('00'))}${(
                  this.timercommand.length / 2
                )
                  .toString(16)
                  .pad('00')}${this.timercommand}`;
              } else {
                last_command = `${this.randarCommand(this_sceneId.toString(16).pad('00'), this_sceneId.toString(16).pad('00'))}`;
              }
              this.trigger[0].triggercommand = last_command;
              let bleList = [
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: last_command,
                },
              ];
              try {
                await window.peripheral[guid].write(bleList);
                await window.peripheral[guid].disconnect();
                
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            } else {
              this.initSheetTriggerContent();
              let checkIndex = 0;
              let errorTriggerList = [];
              for (let i in this.trigger) {
                let mac = core_utils_get_mac_address_from_guid(this.trigger[i].guid, true);
                let rcuMac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                let guid = this.trigger[i].guid;
                let idList = [];
                sceneDeviceLocationList.forEach((kitem) => {
                  if (kitem.device == this.trigger[i].guid) {
                    idList.push(parseInt(kitem.storage_id));
                  }
                });
                let gang = 1;
                if (this.trigger[i].button_group.startsWith('ONOFF GANG')) {
                  gang = this.trigger[i].button_group.replace('ONOFF GANG', '') * 1;
                  if (this.trigger[i].model == 'YO780-Scene-4G') {
                    if (gang == 2) {
                      gang = 3;
                    }
                    if (gang == 3) {
                      gang = 4;
                    }
                    if (gang == 4) {
                      gang = 6;
                    }
                  }
                }
                let sceneId = isset(this.trigger[i].triggerId) ? this.trigger[i].triggerId : this.getDeviceBleId(this.trigger[i].guid);
                //if have same trigger
                // if (!isset(this.trigger[i].triggerId) && i > 0 && this.trigger[i].guid == this.trigger[i - 1].guid) {
                //   sceneId = parseInt(sceneId) + 1;
                //   //must be add the actionId,get the rcuActionId
                //   this.trigger[i].isExtra = true;
                //   debugger
                // }
                //if randar sensor input on the rcu
                if (
                  this.trigger[i].button_group.startsWith('4in1 Sensor') &&
                  (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')
                ) {
                  sceneId = this.actionId;
                  guid = this.actionGuid;
                }else if(this.trigger[i].button_group.startsWith('RCU INPUT') && (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')){
                  sceneId = this.actionId;
                  guid = this.actionGuid;
                }else if(this.trigger[i].button_group.startsWith('SCENE MUTIWAY ONOFF GANG')){
                  sceneId = this.actionLocation[this.trigger[i].guid];
                  debugger
                } else {
                  postIdList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId,
                  });
                  sceneDeviceLocationList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId,
                  });
                }
                if (this.trigger[i].isBle) {
                  continue;
                }
                //alert(sceneId)
                let last_command = ``;
                if (this.timercommand.length) {
                  last_command = `${this.tidyCommand(sceneId.toString(16).pad('00'), sceneId.toString(16).pad('00'), this.trigger[i], 0)}${(
                    this.timercommand.length / 2
                  )
                    .toString(16)
                    .pad('00')}${this.timercommand}`;
                } else {
                  last_command = `${this.tidyCommand(sceneId.toString(16).pad('00'), sceneId.toString(16).pad('00'), this.trigger[i], 0)}`;
                }
                console.log('last_command', last_command);
                //set the antion and trigger the virtual
                let thisActionCommand = '';
                let actionItemCommand = '';
                let z = i;
                //handle any rcu
                for (let i in this.actionBleCommandList) {
                  debugger
                  // if(i == this.actionGuid){
                  //   let this_mac = core_utils_get_mac_address_from_guid(i, true);
                  //   let this_sceneId = this.mainRcuId;
                  //   actionItemCommand += `0b02${this_mac}8f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                  // }
                  let this_mac = core_utils_get_mac_address_from_guid(i, true);
                  let this_sceneId = this.actionLocation[i];
                  if(isset(this.trigger[z].isExtra) && this.trigger[z].isExtra){
                    this_sceneId = parseInt(this_sceneId)+1;
                  }
                  actionItemCommand += `0b02${this_mac}8f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                }
                thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}${actionItemCommand}`;
                if(this.mutiwayStatus == 2){
                  if(this.templateName == 'RCU Click And Stop'){
                    let this_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                    if(this.trigger[i].ref == 2){
                      actionItemCommand = `0b02${this_mac}8f0200${parseInt(this.actionCurtainId_1).toString(16).pad('00')}`;
                      thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}${actionItemCommand}`;
                    }else if(this.trigger[i].ref == 4){
                      actionItemCommand = `0b02${this_mac}8f0200${parseInt(this.actionCurtainId_2).toString(16).pad('00')}`;
                      thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}${actionItemCommand}`;
                    }
                  }else{
                    //change the virtual
                    let this_command_data= '';
                    //this case,if choose the toggle template,the virtual id must be same;
                    for (let i in this.actionBleCommandList) {
                      let this_mac = core_utils_get_mac_address_from_guid(i, true);
                      let this_sceneId = this.virtualIdList[i];
                      //check if one rcu 
                      if(this.subscribeMacadrress){
                        this_command_data = `0f02${mac}17${this.subscribeMacadrress}972103${parseInt(this_sceneId).toString(16).pad('00')}02`;
                      }else{
                        this_command_data += `0c02${this_mac}972103${parseInt(this_sceneId).toString(16).pad('00')}02`;
                      }
                    }
                    thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}${this_command_data}`;
                  }
                  //alert(thisActionCommand)
                  //thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}0b02${core_utils_get_mac_address_from_guid(this.actionGuid,true)}8f0200${parseInt(this.triggerActionId).toString(16).pad('00')}`;
                }
                let triggerStatus = false;
                let virtualSceneId = '';
                let this_ref = 0;
                this.virtualList.forEach((item) => {
                  if (item.display) {
                    triggerStatus = true;
                    virtualSceneId = item.config;
                    this_ref = item.ref;
                  }
                });
                if (triggerStatus) {
                  thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}1302${rcuMac}13048f0200${parseInt(this.actionId)
                    .toString(16)
                    .pad('00')}05972103${parseInt(virtualSceneId).toString(16).pad('00')}${parseInt(this_ref).toString(16).pad('00')}`;
                }
                //if input rcu command
                if (
                  this.trigger[i].button_group.startsWith('4in1 Sensor') &&
                  (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')
                ) {
                  thisActionCommand = ``;
                }
                if(this.trigger[i].button_group.startsWith('RCU INPUT') &&
                (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')){
                  thisActionCommand = ``;
                }
                //if trigger by self
                if(this.trigger[i].button_group.startsWith('SCENE MUTIWAY ONOFF GANG')){
                  thisActionCommand = ``;
                }
                //let thisActionCommand = `8f0200${parseInt(this.actionId).toString(16).pad("00")}02${rcuMac}${parseInt(this.actionId).toString(16).pad("00")}`;
                let settingCommand = ``;
                if (isset(virtualSceneId) && virtualSceneId) {
                  settingCommand = `8f32${gang.toString(16).pad('00')}00${rcuMac}13${parseInt(virtualSceneId).toString(16).pad('00')}00`;
                }
                //let toggleVirtualCommand = `8f1000${sceneId.toString(16).pad("00")}0c02${rcuMac}972103${parseInt(this.actionId).toString(16).pad("00")}02`;
                console.log('thisActionCommand', thisActionCommand);
                console.log('settingCommand', settingCommand);
                //console.log("toggleVirtualCommand",toggleVirtualCommand);
                this.trigger[i].triggercommand = last_command;
                //this.trigger[i].list = this.trigger;
                this.trigger[i].actionCommand = thisActionCommand;
                this.trigger[i].settingCommand = settingCommand;
                this.trigger[i].triggerId = sceneId;

                try {
                  let bleList = [
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: last_command,
                    },
                  ];
                  if (thisActionCommand) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: thisActionCommand,
                    });
                  }
                  if (isset(virtualSceneId) && virtualSceneId) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: settingCommand,
                    });
                  }
                  console.log('bleList',bleList);
                  console.log("guid is:",guid);
                  //alert(JSON.stringify(bleList))
                  await window.peripheral[guid].write(bleList);
                  await window.peripheral[guid].disconnect();
                  this.trigger[i].isBle = true;
                  this.simulateScenePostId(guid,sceneId);
                  this.loadingDeviceConnect(guid, this.trigger[i].button_group);
                  this.overallSceneMap['scene_device_location'].push({
                    device: guid,
                    storage_id: sceneId,
                  })
                  checkIndex++;
                  //app.dialog.close();
                } catch (error) {
                  app.dialog.close();
                  console.log(error);
                  postStatus = false;
                  //alert(checkIndex);
                  this.trigger[i].isBle = false;
                  errorTriggerList.push(this.trigger[i]);
                  //app.dialog.alert(error);
                  this.index = 4;
                  continue;
                }
              }
            }
            try {
              console.log('postIdList', postIdList);
              //debugger
              if (!postStatus) {
                app.dialog.confirm(
                  `${_('Connection failed,reconnect?')}`,
                  async () => {
                    //must be disconnect the device and then retry connect it
                    app.dialog.preloader(`${_('Reconnecting,please wait a moment')}...`);
                    setTimeout(() => {
                      app.dialog.close();
                    }, 15*1000);
                    if (this.templateName == 'RCU Scene Button') {
                      for (let i in this.trigger) {
                        await window.peripheral[this.trigger[i].guid].disconnect();
                      }
                    }
                    setTimeout(() => {
                      this.saveTriggerOnble();
                    }, 3000);
                  },
                  () => {}
                );
                return;
              }
              if (this.sheetMap) {
                this.sheetMap.close();
              }
              app.dialog.close();
              this.index = 5;
              if(this.mutiwayStatus == 2){
                this.overallSceneMap['trigger'] = this.trigger;
              }else{
                await this.saveTriggerOnErp(postIdList);
                await ha_profile_ready();
                this.saveExtraTriggerAndAction();
              }
              return
              app.dialog.close();
              if (this.sheetMap) {
                this.sheetMap.close();
              }
              this.index = 5;
              // setTimeout(() => {
              //   app.dialog.close();
              //   mainView.router.back();
              // }, 1500);
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          async saveTimer() {
            app.dialog.preloader();
            try {
            } catch (error) {}
          },
          async addSubdeviceInErp(sceneId) {
            let hide_device = $(`input[name="hide_device"]:checked`).val();
            let devices = cloneDeep(erp.info.device);
            let deviceObj = devices[this.actionGuid];
            let url = `/api/resource/Profile Subdevice`;
            let method = 'POST';
            // if(isset(this.subdeviceName) && this.subdeviceName != ''){
            //   url = `/api/resource/Profile Subdevice/${this.subdeviceName}`
            //   method = 'PUT'
            // }
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            subdevices.forEach((subItem) => {
              if (subItem.name == sub_name) {
                this.actionGuid = subItem.device;
              }
            });
            try {
              //let device_batch = erp.doctype.device_batch[peripheral[this.actionGuid].getProp().hexBatch.toUpperCase()];
              let post_data = {
                parenttype: 'Profile',
                parent: erp.info.profile.name,
                parentfield: 'profile_subdevice',
                profile_room: erp.info.profile.profile_room[0].name,
                profile_device: this.profileDeviceName,
                device: this.actionGuid,
                title: this.actionName,
                device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                device_mode: deviceObj.device_mode,
                config: `${sceneId}`,
                hidden: isset(hide_device) ? 1 : 0,
              };
              debugger
              // let post_data = {
              //   title:this.actionName,
              //   guid : this.actionGuid,
              //   peripheral : deviceObj.mac_address.replace(/:/g, '').toLowerCase(),
              //   model:deviceObj.device_model,
              //   device_mode:deviceObj.device_mode,
              //   device_button_group : 'SCENE MUTIWAY ONOFF GANG1',
              //   parent : erp.info.profile.name,
              //   batch : isset(device_batch)?device_batch.batch_id:'YO0012',
              //   firmware : peripheral[this.actionGuid].getProp().firmware || 0,
              //   profile_room : erp.info.profile.profile_room[0].name,
              //   password : peripheral[this.actionGuid].getProp().password || '000000',
              //   mac_address: core_utils_get_mac_address_from_guid(this.actionGuid),
              //   subdevice_name : isset(subdevice_name) && subdevice_name != 'undefined'?subdevice_name:''
              // }
              let postStatus = await http.request(encodeURI(url), {
                method: method,
                serializer: 'json',
                responseType: 'json',
                data: post_data,
                debug: true,
              });
              console.log('postStatus', postStatus);
              await ha_profile_ready();
            } catch (error) {
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          //change the structure of the action List
          strucActionList(list) {
            let targetList = [];
            if (list.length == 0) {
              return targetList;
            }
            //filter the differ mac device
            let macMap = {};
            list.forEach((item) => {
              if (!isset(macMap[item.device])) {
                macMap[item.device] = {};
                macMap[item.device]['device_mode'] = item.device_mode;
              }
            });
            for (let i in macMap) {
              macMap[i]['list'] = [];
              list.forEach((kitem) => {
                if (kitem.device === i) {
                  macMap[i]['list'].push(kitem);
                }
              });
            }
            return macMap;
          },
          postActionBle(actualActionList) {
            let controlIndex = 0;
            let postList = cloneDeep(actualActionList);
            for (let guidItem in postList) {
              let guid = guidItem;
              let list = postList[guidItem]['list'];
              postList[guidItem]['actionCommand'] = '';
              let start_length = 0;
              let actioncommand = '';
              let actioncommand_length = list.length;
              list.forEach((item, index) => {
                let mode = item.mode || item.device_mode;
                let button_group = item.button_group || item.device_button_group;
                let mac = core_utils_get_mac_address_from_guid(guid, true);
                let ref = item.ref;
                let data = ``;
                //different mode need to handle
                if (mode == 'On Off Switch' || mode == 'Multiway Switch') {
                  if (button_group.startsWith('RCU')) {
                    let button_group_gang = parseInt(button_group.replace('RCU ONOFF GANG', '') * 1);
                    let gang = button_group_gang - 4 * (parseInt(item.config) - 1);
                    let onoff_data = '1100';
                    if(gang == 1){
                      if(ref == 1){
                        onoff_data = '1100'
                      }else{
                        onoff_data = '1000'
                      }
                    }else if(gang == 2){
                      if(ref == 1){
                        onoff_data = '2200'
                      }else{
                        onoff_data = '2000'
                      }
                    }else if(gang == 3){
                      if(ref == 1){
                        onoff_data = '4400'
                      }else{
                        onoff_data = '4000'
                      }
                    }else if(gang == 4){
                      if(ref == 1){
                        onoff_data = '8800'
                      }else{
                        onoff_data = '8000'
                      }
                    }
                    let this_data = `971f${item.config}8000${onoff_data}`;
                    if(ref == 2){
                      this_data = `8f31${item.config}0${gang}${'01'}01`;
                    }
                    //let this_data = `8f31${item.config}0${gang}${'01'}${ref == 1 ? '00' : '01'}`;
                    let this_length = this_data.length / 2;
                    if (index == 0) {
                      data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                    } else {
                      data = `${this_length.toString(16).pad('00')}${this_data}`;
                    }
                  } else {
                    let gang = button_group.replace('ONOFF GANG', '') * 1;
                    data = jinja2.render(window[(ref == '1' ? 'ON' : 'OFF') + gang].toString(), { mackey: mac }).toLowerCase();
                    if (this.rcuMacAddress) {
                      let $command = data.substring(2, data.length);
                      let $ac_command = `15${mac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                      //if the second ,have no 13
                      if (index == 0) {
                        data = `13${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                      } else {
                        data = `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                      }
                    } else {
                      data = item.action_command;
                    }
                  }
                } else if (mode == 'RCU Controller') {
                  if (item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1') {
                    let gang = parseInt(item.config);
                    if (index == 0) {
                      let this_data = `972103${gang.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                      data = `${$command}`;
                    } else {
                      let $command = `972103${gang.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                    }
                  }else if(item.device_button_group == 'DOOR SIGN'){
                    let ref = item.ref;
                    let onoff_satus = '00';
                    let val_led = '';
                    let attach_command = '';
                    //31 CLEAR ON 32 DND ON //34 CLEAR OFF //35 DND OFF 
                    if(ref == 31){
                      onoff_satus = '01';//should off the dnd
                      val_led = 31;
                      //attach_command = `9721012000`;
                    }else if(ref == 32){
                      onoff_satus = '01'; //should off the clear
                      val_led = 32;
                      //attach_command = `9721011f00`;
                    }else if(ref == 34){
                      onoff_satus = '00';
                      val_led = 31;
                    }else if(ref == 35){
                      onoff_satus = '00';
                      val_led = 32;
                    }
                    if (index == 0) {
                      let this_data = `972101${val_led.toString(16).pad('00')}${onoff_satus}`;
                      let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}${attach_command?'05':''}${attach_command}`;
                      data = `${$command}`;
                    } else {
                      let $command = `972101${val_led.toString(16).pad('00')}${onoff_satus}`;
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}${attach_command?'05':''}${attach_command}`;
                    }
                  } else {
                    let val_led = button_group.replaceAll('RCU OUTPUT', '') * 1;
                    if (val_led == 33) {
                      val_led = 98;
                    }
                    let ref = item.ref;

                    //actioncommand += `${($command.length/2).toString(16).pad("00")}${$command}`;
                    if (index == 0) {
                      let this_data = `972101${val_led.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                      data = `${$command}`;
                    } else {
                      let $command = `972101${val_led.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                    }
                  }
                } else if (mode == 'Triac Dimming' || mode == '0-10v Dimming') {
                  if (button_group.startsWith('RCU')) {
                    let light = item.turnlight ? parseInt(item.turnlight).toString(16).pad('00') : '02';
                    let button_group_gang = parseInt(button_group.replace('RCU DIMMING', '') * 1);
                    let gang = button_group_gang - 2 * (parseInt(item.config) - 1);
                    //find the triger setting
                    //let triger_status = !this.isRelease ? `01` : '00';
                    let triger_status = '02';
                    if (item.turnlight != 4 && item.turnlight != 5) {
                      //4 on ,5 off ,2 toggle ,3 Brighten, 1 Dim
                      let this_data = `8f31${item.config}0${gang}${light}${triger_status}01`;
                      if(item.turnlight == 2){
                        this_data = `8f31${item.config}0${gang}${light}${triger_status}`
                      }
                      let this_length = this_data.length / 2;
                      if (index == 0) {
                        data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                      } else {
                        data = `${this_length.toString(16).pad('00')}${this_data}`;
                      }
                    } else if (item.turnlight == 4) {
                      //let range_value = ref.toString(16).pad('00');
                      let range_value = `${parseInt(item.ref).toString(16).pad('00')}`;
                      let this_data = `971f${item.config}892${gang == 1 ? 0 : 1}${range_value}`;
                      let this_length = this_data.length / 2;
                      if (index == 0) {
                        data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                      } else {
                        data = `${this_length.toString(16).pad('00')}${this_data}`;
                      }
                    } else if (item.turnlight == 5) {
                      let this_data = `971f${item.config}892${gang == 1 ? 0 : 1}${`00`}`;
                      let this_length = this_data.length / 2;
                      if (index == 0) {
                        data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                      } else {
                        data = `${this_length.toString(16).pad('00')}${this_data}`;
                      }
                    }
                  } else {
                    let range_value = ref.toString(16).pad('00');
                    data = jinja2.render(window.DIM.toString(), { mackey: mac, dim_value: range_value }).toLowerCase();
                  }
                } else if (item.device_button_group.startsWith('OPENCLOSE UART')) {
                  if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Click And Stop') {
                    let $command = item.action_command.substring(2, item.action_command.length);
                    let devices = cloneDeep(erp.info.profile.profile_device);
                    let gatewayMac = '';
                    devices.forEach(zitem=>{
                      if(zitem.device_model == 'YO105'){
                        gatewayMac = core_utils_get_mac_address_from_guid(zitem.device,true)
                      }
                    })
                    
                    let $ac_command = `15${gatewayMac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                    if (controlIndex == 0) {
                      data = `13${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    } else {
                      data = `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    }
                  }
                }
                if (
                  data.length &&
                  !button_group.startsWith('RCU') &&
                  this.templateName != 'RCU Scene Button' &&
                  this.templateName != 'RCU Radar' && this.templateName != 'RCU Scene Toggle' && this.templateName != 'RCU Click And Stop'
                ) {
                  start_length = data.length / 2;
                  actioncommand += `${start_length.toString(16).pad('00')}${data}`;
                } else if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Click And Stop') {
                  actioncommand += data;
                } else if (button_group.startsWith('RCU')) {
                  if (index == actioncommand_length - 1) {
                    actioncommand += `${data}`;
                    let this_lengths = actioncommand.length / 2;
                    actioncommand = `${this_lengths.toString(16).pad('00')}${actioncommand}`;
                  } else {
                    actioncommand += `${data}`;
                  }
                }
                if (mode == 'Thermostat') {
                  if (item.action_command) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar') {
                      let $command = item.action_command.substring(2, item.action_command.length);
                      let $ac_command = `15${mac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                      if (controlIndex == 0) {
                        actioncommand += `13${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                      } else {
                        actioncommand += `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                      }
                    } else {
                      actioncommand += `${(item.action_command.length / 2).toString(16).pad('00')}${item.action_command}`;
                    }
                  }
                  if (item.thermostat_fan) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar') {
                      let $command = item.thermostat_fan.substring(2, item.thermostat_fan.length);
                      let $ac_command = `15${mac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                      actioncommand += `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    } else {
                      actioncommand += `${(item.thermostat_fan.length / 2).toString(16).pad('00')}${item.thermostat_fan}`;
                    }
                  }
                  if (item.thermostat_mode) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar') {
                      let $command = item.thermostat_mode.substring(2, item.thermostat_mode.length);
                      let $ac_command = `15${mac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                      actioncommand += `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    } else {
                      actioncommand += `${(item.thermostat_mode.length / 2).toString(16).pad('00')}${item.thermostat_mode}`;
                    }
                  }
                  if (item.thermostat_temp) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar') {
                      let $command = item.thermostat_temp.substring(2, item.thermostat_temp.length);
                      let $ac_command = `15${mac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                      actioncommand += `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    } else {
                      actioncommand += `${(item.thermostat_temp.length / 2).toString(16).pad('00')}${item.thermostat_temp}`;
                    }
                  }
                }
              });
              postList[guidItem]['actionCommand'] = actioncommand;
              controlIndex++;
            }
            console.log('postList', postList);
            //merge the command this.actionGuid
            let totalCommand = '';
            //first tindy the
            let thisCommandMap = {};
            //if only choose the curtain and the another gateway devices
            let haveRcu = false;
            //check if have gateway
            let gatewayActionGuid;
            this.rcuList.forEach((rcuItem) => {
              let guid = rcuItem.guid;
              let ismobmob = window.peripheral[guid].prop.is_mobmob;
              if (ismobmob == 1) {
                gatewayActionGuid = guid;
                return;
              }
            });
            for (let i in postList) {
              if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Click And Stop') {
                if (
                  postList[i].device_mode == 'Triac Dimming' ||
                  postList[i].device_mode == '0-10v Dimming' ||
                  postList[i].device_mode == 'RCU Controller' || 
                  postList[i].device_mode == 'On Off Switch'
                ) {
                  haveRcu = true;
                  let this_data = postList[i].actionCommand;
                  if (i == gatewayActionGuid) {
                    for (let j in postList) {
                      if (postList[j].device_mode == 'Thermostat' || postList[j].device_mode.startsWith('Curtain Moto')) {
                        this_data += `${postList[j].actionCommand}`;
                      }
                    }
                  }
                  //console.log('this_data.length',(this_data.length/2));
                  let this_post_data = `${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                  //totalCommand += this_post_data;
                  thisCommandMap[i] = this_post_data;
                }
              }
            }
            //alert(haveRcu)
            if (!haveRcu) {
              let anotherCommand = '';
              //only have curtain or thermostat

              let this_data = '';
              for (let i in postList) {
                this_data += postList[i].actionCommand;
              }
              let $command = `02${core_utils_get_mac_address_from_guid(gatewayActionGuid, true)}${this_data}`;
              anotherCommand = `${($command.length / 2).toString(16).pad('00')}${$command}`;
              thisCommandMap[gatewayActionGuid] = anotherCommand;
            }
            return thisCommandMap;
          },
          saveActionOnBle(extraStaus) {
            return new Promise(async (resolve, reject) => {
              let actualActionList = this.strucActionList(this.actionList);
              this.overallSceneMap['action']['actionList'] = this.actionList;
              if(this.mutiwayStatus == 2){
                actualActionList = this.strucActionList(this.actionList_2);
                this.overallSceneMap['action']['actionList_2'] = this.actionList_2;
              }
              console.log('actualActionList', actualActionList);
              let actionCommandList = this.postActionBle(actualActionList);
              this.actionBleCommandList = actionCommandList;
              console.log('actionCommandList', actionCommandList);
              let sceneObj = erp.info.scene;
              let sceneMap;
              let errorStatus = true;
              let errorMap;
              //in order to get the attach rcu id
              for (let i in actionCommandList){
                let existId;
                for (let i in sceneObj) {
                  if (this.scenePostId == sceneObj[i].name && isset(sceneObj[i].name)) {
                    sceneMap = sceneObj[i];
                  }
                }
                if (isset(sceneMap)) {
                  let list = sceneMap.scene_device_location;
                  let thisRcuIdList = [];
                  list.forEach((zitem) => {
                    if (zitem.device == i) {
                      thisRcuIdList.push(zitem)
                    }
                  });
                  if(this.mutiwayStatus == 2){
                    existId = thisRcuIdList[1].storage_id;
                  }else{
                    existId = thisRcuIdList[0].storage_id;
                  }
                }
                //alert(existId);
                let sceneId = isset(existId) ? existId : this.getDeviceBleId(i);
                if(i != this.actionGuid){
                  this.attachRcuId = sceneId;
                  this.attachRcuGuid = i;
                }
                this.overallSceneMap['scene_device_location'].push({
                  device: i,
                  storage_id : sceneId
                });
              }
              for (let i in actionCommandList) {
                let existId;
                let actionItem = actionCommandList[i];
                let idList = [];
                let sceneDeviceLocationList = [];
                let isClickRcuStatus = false;
                let isClickRcuGuid = '';
                let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                subdevices.forEach((subItem) => {
                  if (subItem.name == sub_name && (subItem.device_button_group.startsWith('ONOFF GANG') && subItem.device_mode == 'RCU Controller')) {
                    //filter the randar prop
                    isClickRcuStatus = true;
                    isClickRcuGuid = subItem.device;
                    this.actionGuid = subItem.device;
                  }
                });
                for (let i in sceneObj) {
                  if (this.scenePostId == sceneObj[i].name && isset(sceneObj[i].name)) {
                    sceneMap = sceneObj[i];
                  }
                }
                if (isset(sceneMap)) {
                  let list = sceneMap.scene_device_location;
                  let thisRcuIdList = [];
                  list.forEach((zitem) => {
                    if (zitem.device == i) {
                      thisRcuIdList.push(zitem)
                    }
                  });
                  //if scene toggle button,can not get the single id
                  if(this.templateName == 'RCU Scene Toggle'){
                    // if(isset(sceneMap.action) && sceneMap.action){
                    //   let thisActionMap = JSON.parse(sceneMap.action);
                    //   if(this.mutiwayStatus == 2){
                    //     //secoend
                    //     let secoendActionMap = thisActionMap.actionMap_2;
                    //     existId = secoendActionMap[i];
                    //   }else{
                    //     let firstActionMap = thisActionMap.actionMap;
                    //     existId = firstActionMap[i];
                    //   }
                    // }
                    if(this.mutiwayStatus == 2){
                      existId = thisRcuIdList[1].storage_id;
                    }else{
                      existId = thisRcuIdList[0].storage_id;
                    }

                  }else{
                    list.forEach((zitem) => {
                      if (zitem.device == i) {
                        existId = zitem.storage_id;
                        return;
                      }
                    });
                  }
                }
                
                let sceneId = isset(existId) ? existId : this.getDeviceBleId(i);
                if(extraStaus){
                  sceneId = parseInt(sceneId) + 1
                }
                if(i == this.actionGuid){
                  this.mainRcuId = sceneId;
                }else{
                  this.attachRcuId = sceneId;
                }
                if (!isset(this.actionLocation[i])) {
                  this.actionLocation[i] = sceneId;
                }else{
                  this.actionLocation[i] = sceneId;
                }
                //click and stop
                if(this.templateName == 'RCU Click And Stop'){
                  if(this.mutiwayStatus == 2){
                    this.actionCurtainId_2 = sceneId;
                  }else{
                    this.actionCurtainId_1 = sceneId;
                  }
                }
                console.log('sceneId', sceneId);
                let actioncommand_pre = `8F1000${parseInt(sceneId).toString(16).pad('00')}`;
                let totalActionCommand = `${actioncommand_pre}${actionItem}`;
                // if(i == this.actionGuid && Object.keys(actionCommandList).length>1){
                //   totalActionCommand = `${totalActionCommand}0b02${core_utils_get_mac_address_from_guid(this.attachRcuGuid,true)}8f0200${parseInt(this.attachRcuId).toString(16).pad('00')}`
                // }
                console.log('totalActionCommand', totalActionCommand);
                debugger
                if (isClickRcuStatus && isClickRcuGuid == i) {
                  this.randarActionCommand['guid'] = i;
                  this.randarActionCommand['command'] = totalActionCommand;
                }
                try {
                  await window.peripheral[i].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: totalActionCommand,
                    },
                  ]);
                  if(extraStaus){
                    this.actionMap[`extra_${i}`] = totalActionCommand;
                  }else{
                    this.actionMap[i] = totalActionCommand;
                  }
                  if(!isset(this.overallSceneMap['action'][i])){
                    this.overallSceneMap['action'][i] = {}
                  }
                  this.overallSceneMap['action'][i]['actionCommand'] = totalActionCommand;
                  //save id

                  this.simulateScenePostId(i,sceneId);
                } catch (error) {
                  errorStatus = false;
                  errorMap = error;
                }
              }
              if (!errorStatus) {
                reject(errorMap);
              } else {
                //if randar should save the command to the randar rcu
                if (this.templateName == 'RCU Radar') {
                  if (Object.keys(this.actionBleCommandList).length <= 1) {
                    resolve(1);
                  } else {
                    let anotherRcuSecenIdList = [];
                    let guid = this.randarActionCommand['guid'];
                    for (let i in this.actionBleCommandList) {
                      if (i != guid) {
                        anotherRcuSecenIdList.push({
                          guid: i,
                          id: this.actionLocation[i],
                        });
                      }
                    }
                    let anotherCommand = '';
                    for (let i in anotherRcuSecenIdList) {
                      let sceneId = anotherRcuSecenIdList[i].id;
                      let guid = anotherRcuSecenIdList[i].guid;
                      anotherCommand += `0b02${core_utils_get_mac_address_from_guid(guid, true)}8f0200${parseInt(sceneId).toString(16).pad('00')}`;
                    }
                    let postCommand = this.randarActionCommand['command'];
                    postCommand = `${postCommand}${anotherCommand}`;
                    console.log('postCommand', postCommand);
                    try {
                      await window.peripheral[guid].write([
                        {
                          service: 'ff80',
                          characteristic: 'ff81',
                          data: postCommand,
                        },
                      ]);
                      this.actionMap[guid] = postCommand;
                      if(!isset(this.overallSceneMap['action'][guid])){
                        this.overallSceneMap['action'][guid] = {}
                      }
                      this.overallSceneMap['action'][guid]['actionCommand'] = postCommand;
                      resolve(1);
                    } catch (error) {
                      reject(error);
                    }
                  }
                } else {
                  resolve(1);
                }
              }
            });
            //change the actionList to {guid : '',list:[]}
            return;
            actioncommand = `${actioncommand_pre}${this.postActionBle(actualActionList)}`;
          },
          getCurrentSceneId(guid) {
            let sceneObj = erp.info.scene;
            let sceneMap;
            let existId;
            for (let i in sceneObj) {
              if (this.scenePostId == sceneObj[i].name) {
                sceneMap = sceneObj[i];
              }
            }
            if (isset(sceneMap)) {
              let list = sceneMap.scene_device_location;
              list.forEach((zitem) => {
                if (zitem.device == guid) {
                  existId = zitem.storage_id;
                }
              });
            }
            return existId;
          },
          async nextStep(index) {
            if (index == 1) {
              //want to next to step 2
              //verifiy the scene name
              if (!this.sceneName) {
                app.dialog.alert(`${_('Scene name must be filled in')}`);
                return;
              } else {
                //app.dialog.preloader(`${_("Rcu Connecting")}`);
                if(this.templateName == 'Multiway Switch'){
                  this.index = 8;
                  return;
                }
                let postPleStatus = true;
                try {
                  if ($('input[name="banner"]').val()) {
                    this.uploadImage = this.uploadImage ? this.uploadImage : `${erp.setting.app_api_url}${$('input[name="banner"]').val()}`;
                  }
                  // for(let i in this.rcuList){
                  //   if(this.rcuList[i].ischeck){
                  //     let guid = this.rcuList[i].guid;
                  //     if (peripheral[guid].prop.connected) {
                  //       await peripheral[guid].disconnect();
                  //       await this.sleep(1000);
                  //     }
                  //     await peripheral[guid].connect();
                  //     app.dialog.close();
                  //   }
                  // }
                  if (this.virtualStatus) {
                    setTimeout(() => {
                      $(`input[name="virtual_button"]`).trigger('click');
                    }, 500);
                  }
                } catch (error) {
                  app.dialog.close();
                  console.log('error', error);
                  postPleStatus = false;
                  this.index = 1;
                  app.dialog.confirm(
                    `${_('Rcu connect failed,reconnect?')}`,
                    () => {
                      this.nextStep(1);
                    },
                    () => {}
                  );
                  //app.dialog.alert(_("Rcu connect failed"))
                }
                if (postPleStatus == true) {
                  if(this.templateName == 'RCU Scene Toggle' && this.index > 2){
                    this.index = 7;
                  }else{
                    this.index = 2;
                  }
                  //this.scrollItem(110 * 3);
                }
              }
            } else if (index == 2) {
              if (this.actionList.length == 0) {
                app.dialog.alert('Action must be filled in');
                return;
              } else {
                this.saveActionInRcu();
              }
            } else if (index == 3) {
              if (this.trigger.length == 0) {
                app.dialog.alert('Trigger must be filled in');
                return;
              } else {
                this.index = 4;
                this.scrollItem(110*2);
              }
            } else if (index == 5) {
              this.saveTriggerOnble();
            } else if (index == 6) {
              this.buttonAndSetting();
            }else if(index == 7){
              //second scene name
              if (!this.secondSceneName) {
                app.dialog.alert(`${_('Scene name must be filled in')}`);
                return;
              }else{
                this.index = 7;
                this.scrollItem(110*2);
              }
            }else if(index == 8){
              if (this.actionList_2.length == 0) {
                app.dialog.alert('Action must be filled in');
                return;
              } else {
                this.saveActionInRcu();
              }
            }
          },
          toRoomList(title, type,mutiwayStatus) {
            if (type == 4) {
              let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
              this.virtualList = [];
              profile_subdevices.forEach((item) => {
                if (item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1') {
                  item.display = false;
                  item.ref = 0;
                  item.img_url = `https://my.yoswit.com/files/YO780.svg`;
                  this.virtualList.push(item);
                }
              });
              if (this.virtualList.length == 0) {
                app.dialog.alert(_('No option for that condition'));
                return;
              }
              this.virtualPick = app.picker.create({
                inputEl: 'demo-picker-describe',
                rotateEffect: true,
                cols: [
                  {
                    textAlign: 'left',
                    values: this.virtualList.map((item) => item.title),
                  },
                  {
                    values: ['ON', 'OFF', 'TOGGLE'],
                  },
                ],
                on: {
                  change: (_, value) => {
                    console.log(value);
                    let title = value[0];
                    let ref = value[1];
                    this.virtualList.forEach((item) => {
                      if (item.title == title) {
                        item.display = true;
                        item.ref = ref == 'ON' ? 1 : 0;
                      } else {
                        item.display = false;
                      }
                    });
                  },
                },
              });
              this.virtualPick.open();
            } else if (type == 1) {
              let that = this;
              console.log('Choose Condition');
              if (this.trigger.length > 0 && this.templateName == 'RCU Radar') {
                let dialogBox = app.dialog.create({
                  title: 'Choose Condition',
                  buttons: [{ text: 'Or' }, { text: 'And' }],
                  onClick: (dialog, index) => {
                    that.triggerCondition = index == 0 ? 1 : 2;
                    mainView.router.navigate(`/mobile-app/scene-room-device?type=${type}`);
                  },
                  verticalButtons: true,
                });
                dialogBox.open();
              } else {
                mainView.router.navigate(`/mobile-app/scene-room-device?type=${type}`);
              }
            } else if (type == 3) {
              mainView.router.navigate(`/mobile-app/timer-picker-page?title=${tran(title)}&type=${type}`);
            } else {
              mainView.router.navigate(
                `/mobile-app/scene-room-device?type=${type}&title=${encodeURIComponent(tran(title))}&target_guid=${
                  this.actionGuid
                }&template_name=${encodeURIComponent(this.templateName)}`
              );
            }
          },
          findMissingNumber(arr) {
            if (arr.length === 0) {
              return 1;
            }
            arr.sort((a, b) => a - b);
            for (let i = 0; i < arr.length - 1; i++) {
              if (arr[i + 1] - arr[i] > 1) {
                return this.formatNumber(arr[i] + 1);
              }
            }
            return this.formatNumber(arr[arr.length - 1] + 1);
          },
          formatNumber(num) {
            //in case format anther way
            return num;
          },
          //save extra trigger and action
          saveExtraTriggerAndAction() {
            return new Promise((resolve, reject) => {
              app.dialog.preloader(`${_('Checking...')}`)
              //save the action
              if (this.isExtraStatus) {
                this.isRelease = true;
                this.saveActionOnBle(true).then(()=>{
                  let url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                  for (let i in this.actionLocation) {
                    this.sceneDeviceLocation.push({
                      device: i,
                      storage_id: parseInt(this.actionLocation[i])+1,
                    })
                  }
                  return http2.request(url,{
                    method: 'PUT',
                    serializer: 'json',
                    responseType: 'json',
                    debug: true,
                    data: {
                      scene_device_location : this.sceneDeviceLocation
                    },
                  })
                }).then(()=>{
                  app.dialog.close()
                  resolve(1)
                }).catch(error=>{
                  app.dialog.close()
                  reject(error);
                })
              } else {
                app.dialog.close()
                resolve(1)
              }
            });
          },
          randarCommand(scene_id, listIndex) {
            let typeIndex = '02';
            let randarList = [];
            let triggerCommand = ``;
            let pre_command = `8F2000${scene_id}${listIndex}`;
            let total_command = ``;
            let virtualCommand = ``;
            let totalVirtualCommand = ``;
            this.trigger.forEach((item) => {
              if (isset(item.condition) && item.condition && item.condition == 1) {
                this.triggerCondition = 1;
              }
              if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor' || item.button_group.startsWith("RCU INPUT")) {
                randarList.push(item);
              }
            });
            randarList.forEach((item, index) => {
              let guid = item.guid;
              let mac = core_utils_get_mac_address_from_guid(guid, true);
              let ref = item.ref;
              let this_command = '';
              //in that distinguish the value and the other value(temp,templess,hum,hum_less)
              if (isset(ref)) {
                if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor' || item.button_group.startsWith("RCU INPUT")) {
                  typeIndex = `22`; //34 is SCENE TYPE BUTTON V3
                  let opcode = '00';
                  if (this.triggerCondition == 1 && index != randarList.length - 1) {
                    opcode = 'tt';
                  }
                  let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                  let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                  if(item.button_group.startsWith("RCU INPUT")){
                    gang = item.button_group.replace("RCU INPUT",'');
                  }
                  triggerCommand = `${opcode}${typeIndex}${rcu_mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                }
              }
            });
            console.log('total_command', total_command);

            this.trigger.forEach((item) => {
              let guid = item.guid;
              let mac = core_utils_get_mac_address_from_guid(guid, true);
              let ref = item.ref;
              if (item.button_group == 'SCENE MUTIWAY ONOFF GANG1') {
                typeIndex = '1f';
                let opcode = '00';
                let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                virtualCommand = `${opcode}${typeIndex}${rcu_mac}00${ref.toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
                virtualCommand = `${(virtualCommand.length / 2).toString(16).pad('00')}${virtualCommand}`;
                totalVirtualCommand += virtualCommand;
              }
            });
            if (this.oneOnly) {
              typeIndex = '1f';
              let opcode = '00';
              let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
              let gang = parseInt(this.actionId);
              let ref = 0;
              virtualCommand = `${opcode}${typeIndex}${rcu_mac}00${ref.toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
              virtualCommand = `${(virtualCommand.length / 2).toString(16).pad('00')}${virtualCommand}`;
              totalVirtualCommand += virtualCommand;
            }
            return `${pre_command}${this.replaceTTWithLength(total_command)}${totalVirtualCommand}`;
          },
          tidyCommand(scene_id, listIndex, item, index) {
            let typeIndex = '02';
            let triggerCommand = ``;
            let pre_command = `8F2000${scene_id}${listIndex}`;
            let total_command = ``;
            let guid = item.guid;
            let mac = core_utils_get_mac_address_from_guid(guid, true);
            let ref = item.ref;
            let this_command = '';
            let virtualCommand = ``;
            let totalVirtualCommand = ``;
            //in that distinguish the value and the other value(temp,templess,hum,hum_less)
            if (isset(ref)) {
              let sensor_command = ``;
              if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor') {
                if (this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Button') {
                  typeIndex = `01`;
                  let opcode = '00';
                  if (this.triggerCondition == 1 && index != this.trigger.length - 1) {
                    opcode = 'tt';
                  }
                  let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                  let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                  triggerCommand = `${opcode}${typeIndex}${rcu_mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                } else {
                  typeIndex = `02`;
                  let opcode = '00';
                  if (this.triggerCondition == 1 && index != this.trigger.length - 1) {
                    opcode = 'tt';
                  }
                  triggerCommand = `${opcode}${typeIndex}${mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                }
              }
              if (item.button_group.startsWith('ONOFF GANG')) {
                let gang = item.button_group.replace('ONOFF GANG', '') * 1;
                if (item.model == 'YO780-Scene-4G') {
                  if (gang == 2) {
                    gang = 3;
                  } else if (gang == 3) {
                    gang = 4;
                  } else if (gang == 4) {
                    gang = 6;
                  }
                }
                typeIndex = `01`;
                let this_ref = '00';
                let runTime = '';
                if (ref) {
                  //this_ref = Math.pow(2, gang*1 - 1).toString(16).pad('00');
                  if (ref == 1 || ref == 2) {
                    this_ref = '01';
                  } else if (ref == 4) {
                    this_ref = '04';
                    typeIndex = '21';
                    runTime = '0f';
                  } else if (ref == 3) {
                    this_ref = '01';
                    //add a new trigger in list
                    let newJson = cloneDeep(item);
                    newJson.ref = 5;
                    this.extraTriggerList.push(newJson);
                  } else if (ref == 5) {
                    this.isExtraStatus = true;
                    this_ref = '00';
                  } else {
                    this_ref = '00';
                  }
                }
                let opcode = '00'; //this params used check "or" condition,must be set data length after it;
                if (this.triggerCondition == 1 && index != this.trigger.length - 1) {
                  opcode = 'tt';
                }
                triggerCommand = `${opcode}${typeIndex}${mac}${parseInt(gang).toString(16).pad('00')}${this_ref}${runTime}`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
              if(item.button_group.startsWith('SCENE MUTIWAY ONOFF GANG')){
                typeIndex = `1f`;
                let this_ref = item.ref;
                let opcode = '00';
                let gang = isset(item.config)?item.config:parseInt(this.actionLocation[item.guid]);
                debugger
                let $thisCommand = `${opcode}${typeIndex}${mac}00${parseInt(this_ref).toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
                $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                total_command += $thisCommand;
              }
              if (item.button_group.startsWith('DIMMING')) {
                typeIndex = `1a`;
                let this_ref = '00';
                if (ref) {
                  this_ref = `02`;
                }
                triggerCommand = `${typeIndex}${mac}${this_ref}00`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
              if (item.button_group.startsWith('Door Open')) {
                typeIndex = `04`;
                let this_ref = '00';
                if (ref) {
                  this_ref = `01`;
                }
                triggerCommand = `${typeIndex}${mac}${this_ref}`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
            }
            if (item.temp || item.temp_less) {
              typeIndex = '05';
              if (item.temp) {
                let temp_command = `${typeIndex}${mac}02${core_utils_float_ieee_convert(item.temp)}`;
                this_command = `${(temp_command.length / 2).toString(16).pad('00')}${temp_command}`;
                triggerCommand += this_command;
              }
              if (item.temp_less) {
                let temp_less_command = `${typeIndex}${mac}01${core_utils_float_ieee_convert(item.temp_less)}`;
                this_command = `${(temp_less_command.length / 2).toString(16).pad('00')}${temp_less_command}`;
                triggerCommand += this_command;
              }
              total_command += triggerCommand;
            }
            if (item.hum || item.hum_less) {
              let hum_command = ``;
              typeIndex = '06';
              if (item.hum) {
                let this_hum_command = `${typeIndex}${mac}02${core_utils_float_ieee_convert(item.hum)}`;
                hum_command = `${(this_hum_command.length / 2).toString(16).pad('00')}${this_hum_command}`;
                triggerCommand += hum_command;
              }
              if (item.hum_less) {
                let this_hum_less_command = `${typeIndex}${mac}01${core_utils_float_ieee_convert(item.hum_less)}`;
                hum_command = `${(this_hum_less_command.length / 2).toString(16).pad('00')}${this_hum_less_command}`;
                triggerCommand += hum_command;
              }
              total_command += triggerCommand;
            }
            console.log('total_command', total_command);
            if (this.oneOnly) {
              typeIndex = '1f';
              let opcode = '00';
              let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
              let gang = parseInt(this.actionId);
              let ref = 0;
              virtualCommand = `${opcode}${typeIndex}${rcu_mac}00${ref.toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
              virtualCommand = `${(virtualCommand.length / 2).toString(16).pad('00')}${virtualCommand}`;
              totalVirtualCommand += virtualCommand;
            }
            return `${pre_command}${this.replaceTTWithLength(total_command)}${totalVirtualCommand}`;
          },
          replaceTTWithLength(str) {
            let list = str.split('tt');
            console.log('list', list);
            if (list.length == 1) {
              return str;
            }
            let command = ``;
            let total = 0;
            let $length = list.length - 1;
            for (let i = $length; i >= 0; i--) {
              if (i == $length) {
                let index = (list[i].length / 2).toString(16).pad('00');
                command = `${index}${list[i]}`;
              } else if (i == 0) {
                command = `${list[i]}${command}`;
              } else {
                let index = ((list[i].length + command.length) / 2).toString(16).pad('00');
                command = `${index}${list[i]}${command}`;
              }
            }
            return command;
          },
        },
        computed: {
          dealwithRef() {
            return function (item) {
              let mode = item.mode || item.device_mode;
              let ref = item.ref;
              let status = '';
              let device_button_group = item.device_button_group;
              if (mode == 'On Off Switch') {
                if (ref == 1) {
                  status = 'ON';
                }else if(ref == 2){
                  status = 'TOGGLE';
                } else {
                  status = 'OFF';
                }
              } else if (mode == 'RCU Controller') {
                if (ref == 1) {
                  status = 'ON';
                } else if (ref == 2) {
                  status = 'TOGGLE';
                }else if(ref == 31){
                  status = 'CLEAR ON';
                }else if(ref == 32){
                  status = 'DND ON';
                }else if(ref == 34){
                  status = 'CLEAR OFF';
                }else if(ref == 35){
                  status = 'DND OFF';
                } else {
                  status = 'OFF';
                }
              } else if (mode == 'RF Sensor' || mode == 'Radar Sensor') {
                if (ref == 1) {
                  status = 'OCCUPIED';
                } else {
                  status = 'UNOCCUPIED';
                }
              } else if (mode == 'Triac Dimming' || mode == '0-10v Dimming') {
                if (item.turnlight == 4) {
                  status = 'ON/100%';
                  if (ref > 1) {
                    status = `ON/${parseInt((ref / 255) * 100)}%`;
                  }
                } else if (item.turnlight == 5) {
                  status = 'OFF';
                } else if (item.turnlight == 2) {
                  status = 'TOGGLE';
                } else if (item.turnlight == 3) {
                  status = 'BRIGHTEN';
                } else if (item.turnlight == 1) {
                  status = 'DIM';
                }
              } else if (device_button_group.startsWith('OPENCLOSE UART')) {
                if (ref > 1 && ref != 2) {
                  status = 'OPEN';
                } else if (ref == 2) {
                  status = 'PAUSE';
                } else {
                  status = 'CLOSE';
                }
              } else if (mode == 'Thermostat') {
                if (item.temperature) {
                  console.log(item.ref == '0');
                  let mode_text = item.modeStr == 2 ? 'COOL' : item.modeStr == 1 ? 'HOT' : item.modeStr == 0 ? 'AUTO' : 'UNSET';
                  let fan_text =
                    item.speedVaule == 4 ? '3 SPEED' : item.speedVaule == 3 ? '2 SPEED' : item.speedVaule == 2 ? '1 SPEED' : 'AUTO';
                  status = `${item.ref == '0' ? 'Off' : 'On'}/${item.temperature}℃`;
                }
              } else if (mode == 'IR' || mode == 'On Off IR') {
                if (item.ir_temp) {
                  console.log(item.ref == '0');
                  status = `${item.ir_ref == '0' ? 'OFF' : 'ON'}/${item.ir_mode_text}/${item.ir_fan_text}/${item.ir_swing_text}/${
                    item.ir_temp_text
                  }℃`;
                }
              }
              return status;
            };
          },
          computerWeek() {
            return function (item) {
              let weekText = ``;
              let showText = [];
              let list = item.weeks;
              let allDayStatus = false;
              let weekTextList = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
              list.forEach((item) => {
                if (item == '') {
                  allDayStatus = true;
                } else {
                  showText.push(_(weekTextList[parseInt(item)]));
                }
              });
              if (allDayStatus) {
                weekText = _(`Every day`);
              } else {
                weekText = showText.join(',');
              }
              return weekText;
            };
          },
          computerTime() {
            return function (item) {
              let timeText = '';
              if (item.typetime == 1) {
                timeText = _(`All day`);
              } else {
                if (item.start_time >= item.end_time) {
                  timeText = `${item.start_time} - ${item.end_time}(${_('Next Day')})`;
                } else {
                  timeText = `${item.start_time} - ${item.end_time}`;
                }
              }
              return timeText;
            };
          },
        },
        beforeDestroy() {
          emitter.off('trigger_save');
          emitter.off('save_action');
          this.actionSheetMap = null;
          //emitter.off('set_timmer');
        },
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  .device-hidden {
    display: none;
  }
  .template-info {
    font-size: 12px;
    text-align: right;
    margin-bottom: 10px;
  }
  .radio-box {
    height: 75px;
    background-color: #fff;
    margin-bottom: 10px;
  }
  .item-radio {
    height: 100%;
  }
  .timer-item {
    height: 100%;
    padding-right: 10px;
  }
  .list ul::before,
  .list ul::after {
    content: none;
  }
  .add-box {
    height: 70px;
    padding: 0px 15px;
    color: var(--f7-theme-color);
  }
  .dialog-buttons .dialog-button {
    width: 100% !important;
  }
  .scnen-template {
    height: 80px;
    margin-bottom: 15px;
    border-radius: 15px;
    padding: 10px 15px;
  }
  .scnen-template-title span {
    color: #fff;
    font-size: 16px;
  }
  .scnen-template-title p {
    color: #fff;
  }
  .scnen-template-icon {
    width: 60px;
    height: 60px;
    background-color: #fff;
    z-index: 99;
    border-radius: 50%;
  }
  .check-box {
  }
  .toolbar-inner .button {
    min-width: 110px;
    border-radius: inherit;
  }
</style>
