<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Scene Configuration') }}</div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="main-box">
          <div class="toolbar-box" style="padding: 0 15px; margin-top: 15px" v-if="stepList.length">
            <div class="toolbar tabbar tabbar-scrollable" style="height: 60px">
              <div class="toolbar-inner scene-toolbar-inner">
                <button
                  v-for="(item,index) in stepList"
                  :key="item.id"
                  :class="item.isActive?'button-active button':'button'"
                  v-on:click="toTab(item.relatedIndex)"
                >
                  {{_('Step')}} {{item.name}}
                </button>
              </div>  
            </div>
          </div>
          <div class="tabs">
            <!--choose tempalte-->
            <div id="step-0" class="view tab view-main" :class="[index == 0 ? 'tab-active' : '']" v-if="index == 0">
              <div class="card" v-for="(kitem,index) in templateList">
                <div class="card-header" style="font-weight: 500; font-size: 18px">
                  {{_(kitem.title)}}
                  <div class="scnen-template-intro" style="font-weight: 300; font-size: 14px">{{_(kitem.des)}}</div>
                </div>
                <div class="card-content card-content-padding">
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in kitem.list"
                    :key="index"
                    :style="{'background-color':item.color}"
                    v-on:click="chooseTemplate(item)"
                  >
                    <div class="scnen-template-title">
                      <span>{{_(item.name)}}</span>
                    </div>
                    <div class="scnen-template-icon display-flex justify-content-center align-items-center">
                      <i class="material-icons text-color-theme" style="font-size: 30px">{{item.icon}}</i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-0-1" class="view tab view-main" :class="[index == 0.5 ? 'tab-active' : '']" v-if="index == 0.5">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Choose Your Rcu Device")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in rcuList"
                    :key="item.guid"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>
                        {{item.device_model}}
                        <span v-if="item.asMain" style="font-size: 12px"> {{'('+_('Main RCU')+')'}} </span>
                      </p>
                      <p>{{item.mac_address}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeRcuStatus(item)"
                        >check_box_outline_blank</i
                      >
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-else="item.ischeck"
                        v-on:click="changeRcuStatus(item)"
                        >check_box</i
                      >
                    </div>
                  </div>
                  <div class="block" style="text-align: center; margin: 30px 0" v-if="rcuList.length == 0">
                    <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                    <p>${_('You do not have any rcu devices.')}</p>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px" v-if="rcuList.length != 0">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="chooseRcuDevice()">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 1 ? 'tab-active' : '']" v-if="index == 1">
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle' || templateName == 'RCU Scene Toggle - Save Status'" class="card-header" style="font-weight: 500; font-size: 18px">
                  {{_("Add The First Scene")}}
                </div>
                <div class="card-content card-content-padding">
                  <a
                    href="#"
                    func="core_get_photo"
                    ref="profile_room_form_banner"
                    ele="profile_room_form_banner"
                    style="
                      display: block;
                      overflow: hidden;
                      background-color: #eee;
                      height: 150px;
                      text-align: center;
                      background-size: cover;
                      background-position: center;
                    "
                    :style="{ backgroundImage: sceneImage }"
                    class="profile_room_form_banner mb-2 display-flex align-items-center justify-content-center"
                  >
                    <input
                      type="text"
                      name="banner"
                      class="_readable"
                      readonly="readonly"
                      placeholder="Banner"
                      style="display: none"
                      value=""
                    />
                    <span class="material-icons" style="font-size: 70px; color: #ddd">add_a_photo</span>
                  </a>
                  <div class="list card-content-padding">
                    <ul>
                      <li class="item-content item-input no-padding-left">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">
                            {{_("Scene Name")}}
                            <span class="text-color-red" style="font-size: 14px" v-if="templateName == 'Room Scene Button'">
                              {{_('(Only three letters or characters)')}}</span
                            >
                          </div>
                          <div class="item-input-wrap">
                            <input type="text" name="sceneName" v-model="sceneName" :placeholder="SceneNameTip" required validate />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(1)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 6 ? 'tab-active' : '']" v-if="index == 6">
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle' || templateName == 'RCU Scene Toggle - Save Status'" class="card-header" style="font-weight: 500; font-size: 18px">
                  {{_("Add The Second Scene")}}
                </div>
                <div class="card-content card-content-padding">
                  <a
                    href="#"
                    func="core_get_photo"
                    ref="profile_room_form_banner"
                    ele="profile_room_form_banner"
                    style="
                      display: block;
                      overflow: hidden;
                      background-color: #eee;
                      height: 150px;
                      text-align: center;
                      background-size: cover;
                      background-position: center;
                    "
                    :style="{ backgroundImage: sceneImage }"
                    class="profile_room_form_banner mb-2 display-flex align-items-center justify-content-center"
                  >
                    <input
                      type="text"
                      name="banner"
                      class="_readable"
                      readonly="readonly"
                      placeholder="Banner"
                      style="display: none"
                      value=""
                    />
                    <span class="material-icons" style="font-size: 70px; color: #ddd">add_a_photo</span>
                  </a>
                  <div class="list card-content-padding">
                    <ul>
                      <li class="item-content item-input no-padding-left">
                        <div class="item-inner no-padding-right">
                          <div class="item-title item-label" lang="en" style="font-size: 16px">{{_("Scene Name")}}</div>
                          <div class="item-input-wrap">
                            <input
                              type="text"
                              name="secondSceneName"
                              v-model="secondSceneName"
                              :placeholder="SceneNameTip"
                              required
                              validate
                            />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(1)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-2" class="view tab view-main" :class="[index == 2 ? 'tab-active' : '']" v-if="index == 2">
              <!-- this page is choose the action  -->
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle' || templateName == 'RCU Scene Toggle - Save Status'" class="card-header" style="font-weight: 500; font-size: 18px">
                  {{_("Add The First Scene Action")}}
                </div>
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device swipeout" v-for="(item,index) in actionList" :key="item.name">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div
                              class="device-thumb item-media"
                              :style="{
                              'background-position': 'center',
                              'background-size': 'contain',
                              'position': 'relative',
                              'background-image': 'url('+item.imgUrl+')'}
                            "
                            ></div>
                            <div class="item-inner">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                              </div>
                              <div class="item-subtitle" v-if="item.mainType != 16">{{ item.device_model }}-{{ item.mac_address }}</div>
                              <div class="item-subtitle" v-else>{{ item.scene_template }}</div>
                              <div class="signal-panel item-text height-21" style="" v-if="item.mainType != 16">
                                {{tran(item.room_name)}}/
                                <span v-if="item.virtualId && item.virtualId != 0" class="text-color-theme"
                                  >{{_('V-ID ')}}{{item.virtualId}}/{{item.virtualIdType == 1?'Rcu':item.virtualIdType ==
                                  2?'Led':'Both'}}/</span
                                >
                                <span class="text-color-theme" v-if="item.mainType != 16">{{_(dealwithRef(item))}}</span>
                              </div>
                              <div class="signal-panel item-text height-21" style="" v-else>
                                <span class="text-color-theme">{{_('V-ID ')}}{{item.v_id}}</span>
                                <span>/{{item.ref == 1?_('ON'):_("OFF")}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteActionItem(item.name)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                          <div class="swipeout-actions-right"> 
                            <a :class="item.isCheck ? 'text-color-theme' : 'bg-color-gray'" v-on:click="changeActionDeviceStatus(item)">
                              <i class="material-icons text-color-white">check</i>
                            </a>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-space-between align-items-center"
                      
                    >
                      <div class="trigger-icon display-flex justify-content-flex-start align-items-center" v-on:click="toRoomList('Choose Action Device','2','1')">
                        <i class="material-icons">add_circle</i>
                        <div class="trigger-text margin-left">{{_("Add Actions")}}</div>
                      </div>
                      <div class="trigger-icon display-flex justify-content-flex-start align-items-center" v-on:click="toSceneList('Choose Scene','7','1')">
                        <i class="material-icons">add_circle</i>
                        <div class="trigger-text margin-left">{{_("Add Scene")}}</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(2)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-2" class="view tab view-main" :class="[index == 7 ? 'tab-active' : '']" v-if="index == 7">
              <!-- this page is choose the action  -->
              <div class="card">
                <div v-if="templateName == 'RCU Scene Toggle' || templateName == 'RCU Scene Toggle - Save Status'" class="card-header" style="font-weight: 500; font-size: 18px">
                  {{_("Add The Second Scene Action")}}
                </div>
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in actionList_2" :key="item.name">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div
                              class="device-thumb item-media"
                              :style="{
                              'background-position': 'center',
                              'background-size': 'contain',
                              'position': 'relative',
                              'background-image': 'url('+item.imgUrl+')'}
                            "
                            ></div>
                            <div class="item-inner">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                              </div>
                              <div class="item-subtitle" v-if="item.mainType != 16">{{ item.device_model }}-{{ item.mac_address }}</div>
                              <div class="item-subtitle" v-else>{{ item.scene_template }}</div>
                              <div class="signal-panel item-text height-21" style="" v-if="item.mainType != 16">
                                {{tran(item.room_name)}}/
                                <span v-if="item.virtualId && item.virtualId != 0" class="text-color-theme"
                                  >{{_('V-ID ')}}{{item.virtualId}}/{{item.virtualIdType == 1?'Rcu':item.virtualIdType ==
                                  2?'Led':'Both'}}/</span
                                >
                                <span class="text-color-theme">{{_(dealwithRef(item))}}</span>
                              </div>
                              <div class="signal-panel item-text height-21" style="" v-else>
                                <span class="text-color-theme">{{_('V-ID ')}}{{item.v_id}}</span>
                                <span>/{{item.ref == 1?_('ON'):_("OFF")}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteActionItem(item.name,2)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-space-between align-items-center"
                      
                    >
                      <div class="trigger-icon display-flex justify-content-flex-start align-items-center" v-on:click="toRoomList('Choose Action Device','2','2')">
                        <i class="material-icons">add_circle</i>
                        <div class="trigger-text margin-left">{{_("Add Actions")}}</div>
                      </div>
                      <div class="trigger-icon display-flex justify-content-flex-start align-items-center" v-on:click="toSceneList('Choose Scene','7','1')">
                        <i class="material-icons">add_circle</i>
                        <div class="trigger-text margin-left">{{_("Add Scene")}}</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(8)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-3" class="view tab view-main" :class="[index == 3 ? 'tab-active' : '']" v-if="index == 3">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px" v-if="!selfTriggeredClickStatus">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in trigger" :key="index" v-if="!item.isHidden">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div
                              class="device-thumb item-media"
                              :style="{
                              'background-position': 'center',
                              'background-size': 'contain',
                              'position': 'relative',
                              'background-image': 'url('+item.img_url+')'}
                            "
                            ></div>
                            <div class="item-inner">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                              </div>
                              <div class="item-subtitle">{{ item.model }}-{{ item.mac_address }}</div>
                              <div class="signal-panel item-text height-21" style="">
                                {{tran(item.room_title)}}/
                                <span class="text-color-theme">{{_(item.status)}}</span>
                                <span
                                  class="text-color-theme"
                                  v-if="item.mode == 'Radar Sensor' || item.button_group== 'SCENE MUTIWAY ONOFF GANG1' || item.button_group.startsWith('RCU INPUT')"
                                  >{{item.condition == 1?'/OR':'/AND'}}</span
                                >
                                <span class="text-color-theme" v-if="templateName == 'Radar Sensor' || templateName == 'Welcome Scene'">{{isset(item.is_close_to_door) && item.is_close_to_door ? '/Near' : isset(item.is_close_to_door) && !item.is_close_to_door ? '/Far' : ''}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteTriggerItem(index)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-flex-start align-items-center"
                      v-on:click="toRoomList('Choose Trigger Device','1')"
                    >
                      <i class="material-icons">add_circle</i>
                      <div class="trigger-text margin-left">{{_("Add a trigger condition")}}</div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(3)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-4" class="view tab view-main" :class="[index == 4 ? 'tab-active' : '']" v-if="index == 4">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="action-list list media-list no-margin">
                      <ul>
                        <li class="device" v-for="(item,index) in timerList" :key="index">
                          <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                            <div class="item-inner" style="padding-top: 10px">
                              <div class="item-title-row">
                                <div class="item-title ellipsis" lang="en" style="width: 200px">{{computerTime(item)}}</div>
                              </div>
                              <div class="signal-panel item-text height-21" style="">
                                <span class="text-color-theme" style="font-size: 12px">{{computerWeek(item)}}</span>
                              </div>
                            </div>
                            <div class="margin-right" style="" v-on:click="deleteTimer(index)">
                              <i class="material-icons text-color-gray">delete</i>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <div
                      class="add-box add-action display-flex justify-content-space-between align-items-center"
                      v-on:click="toRoomList('Effective time period','3')"
                    >
                      <div class="trigger-text">{{_('Effective time period')}}</div>
                      <div class="trigger-right display-flex justify-content-space-between align-items-cente">
                        <span class="left-info"></span>
                        <i class="material-icons">chevron_right</i>
                      </div>
                    </div>
                  </div>
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 40px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Run Once Only')}}</div>
                      <div class="trigger-right display-flex justify-content-space-between align-items-cente" v-on:click="switchOneOnly">
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!oneOnly">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="oneOnly">toggle_on</i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(5)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-5" class="view tab view-main" :class="[index == 5 ? 'tab-active' : '']" v-if="index == 5">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Button And Setting")}}</div>
                <div class="card-content card-content-padding">
                  <!-- <div
                    class="action-box card"
                    style="margin-left: 0; margin-right: 0; margin-top: 10px"
                    v-if="this.templateName != 'RCU Scene Toggle'"
                  >
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Virtual Button')}}</div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="changeVirtualStatus"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!virtualStatus">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="virtualStatus">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div
                    class="action-box card"
                    style="margin-left: 0; margin-right: 0; margin-top: 10px"
                    v-if="this.templateName != 'RCU Scene Toggle'"
                  >
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Hide Button')}}</div>
                      <div class="trigger-right display-flex justify-content-space-between align-items-cente" v-on:click="changeHideDevice">
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!hideDevice">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="hideDevice">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div class="list no-hairlines-md" style="margin: 10px 0; display: none" v-if="virtualStatus">
                    <ul>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div
                            class="item-title item-label"
                            style="font-size: var(--f7-block-title-font-size, inherit); color: var(--f7-block-title-text-color)"
                          >
                            {{ _("Virtual Button Name") }}
                          </div>
                          <div class="item-input-wrap">
                            <input
                              class="init-input"
                              name="title"
                              type="text"
                              :placeholder="_('This name will be displayed in smart home.')"
                              required
                              v-model="actionName"
                            />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div> -->
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Display In Home Banner')}}</div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="showInHome = !showInHome"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!showInHome">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="showInHome">toggle_on</i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(6)">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- mutiway choose devices  -->
            <div id="step-8" class="view tab view-main" :class="[index == 8 ? 'tab-active' : '']" v-if="index == 8">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Choose Your Mapping Device")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in mappingDeviceList"
                    :key="item.guid"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>{{tran(item.title)}}</p>
                      <p style="font-size: 12px">{{tran(item.room_name)}}/{{item.device_name}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeDeviceStatus(item)"
                        >check_box_outline_blank</i
                      >
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-else="item.ischeck"
                        v-on:click="changeDeviceStatus(item)"
                        >check_box</i
                      >
                    </div>
                  </div>
                  <!-- No devices -->
                  <div class="device-null" v-if="mappingDeviceList.length == 0">
                    <div class="block" style="text-align: center">
                      <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                      <p>${_('You do not have matching devices, to network?')}</p>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col" v-if="mappingDeviceList.length == 0">
                    <div class="button button-fill button-save" v-on:click="toNetwork()">{{_("to Network")}}</div>
                  </div>
                  <div class="col" v-if="mappingDeviceList.length > 0">
                    <div class="button button-fill button-save" v-on:click="mutiwayAction()">{{_("Next Step")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-9" class="view tab view-main" :class="[index == 9 ? 'tab-active' : '']" v-if="index == 9">
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Move Closer To Device And Then Operate")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in otherMappingDeviceList"
                    :key="item.device"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>{{tran(item.title)}}</p>
                      <p style="font-size: 12px">{{tran(item.room_name)}}/{{item.device_name}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeDeviceStatus(item)"
                        >check_box_outline_blank</i
                      >
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col" v-if="mappingDeviceList.length > 0">
                    <div class="button button-fill button-save" v-on:click="otherMutiwayAction()">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-11" class="view tab view-main" :class="[index == 11 ? 'tab-active' : '']" v-if="index == 11"></div>
            <div id="step-12" class="view tab view-main" :class="[index == 12 ? 'tab-active' : '']" v-if="index == 12">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in roomList"
                    :key="item.name"
                    :style="{'background-color':'#253b4f'}"
                    v-if="!item.isHidden"
                  >
                    <div class="scnen-template-title">
                      <p>{{tran(item.title)}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeRoomStatus(item)"
                        >check_box_outline_blank</i
                      >
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-else="item.ischeck"
                        v-on:click="changeRoomStatus(item)"
                        >check_box</i
                      >
                    </div>
                  </div>
                  <div class="block" style="text-align: center; margin: 30px 0" v-if="roomList.length == 0">
                    <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                    <p>${_('You do not have any rooms.')}</p>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px" v-if="roomList.length != 0">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="chooseRoom()">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-10" class="view tab view-main" :class="[index == 10 ? 'tab-active' : '']" v-if="index == 10">
              <div class="card">
                <div class="card-content">
                  <div
                    class="list media-list no-margin"
                    :id="'room-'+roomItem.idx+'-div'"
                    :room="roomItem.name"
                    v-for="(roomItem,roomIndex) in roomList"
                    :key="roomItem.name"
                    v-if="!roomItem.isHidden"
                  >
                    <ul>
                      <li :id="'room-'+roomItem.idx+'-div-title'" class="swipeout room">
                        <div class="item-content swipeout-content">
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div
                                class="item-title"
                                lang="en"
                                :lang-packet="roomItem.title"
                                v-on:click="controller_common_home_collapse(roomItem.idx)"
                              >
                                <i class="room-collapse material-icons" :id="'collapse-'+roomItem.idx"> expand_more </i>
                                {{ tran(roomItem.title) }}
                              </div>
                            </div>
                          </div>
                        </div>
                      </li>
                      <div class="scene-room-device-item">
                        <div
                          class="li-item"
                          v-for="(subItem,subIndex) in subdevices"
                          :key="subItem.name"
                          v-if="subItem.profile_room == roomItem.name && !subItem.isHidden"
                        >
                          <li class="device swipeout" :guid="subItem.device">
                            <div class="item-content swipeout-content">
                              <a class="item-link item-content no-chevron no-ripple no-active-state" style="width: 100%">
                                <div style="margin-top: 10px">
                                  <i
                                    class="material-icons text-color-gray"
                                    style="font-size: 60px"
                                    v-if="!subItem.chooseStatus"
                                    v-on:click="showButton(subItem)"
                                    >toggle_off</i
                                  >
                                  <i
                                    class="material-icons text-color-theme"
                                    style="font-size: 60px"
                                    v-if="subItem.chooseStatus"
                                    v-on:click="showButton(subItem)"
                                    >toggle_on</i
                                  >
                                </div>
                                <div
                                  class="device-thumb item-media"
                                  :style="{
                          'background-image' : 'url('+subItem.imgUrl+')',
                          'background-position' : 'center',
                          'background-size' : 'contain',
                          'position' : 'relative'
                        }"
                                ></div>
                                <div class="item-inner">
                                  <div class="item-title-row">
                                    <div class="item-title ellipsis" lang="en" style="width: 180px">{{tran(subItem.title)}}</div>
                                  </div>
                                  <div class="item-subtitle">{{ subItem.device_model }}-{{ subItem.mac_address.substring(0,12) }}</div>
                                  <div class="signal-panel item-text height-21" style="width: 120%">
                                    <div>
                                      <div class="status-info text-color-primary">{{subItem.firmware}}</div>
                                    </div>
                                  </div>
                                </div>
                              </a>
                              <div class="control-panel-right" style="">
                                <a class="right" v-on:click="${()=>toScene(subItem)}" v-if="subItem.mainType == 0">
                                  <div class="button button-raised button-big circle rf-sensor">
                                    <i class="material-icons" style="line-height: 25px !important">block</i>
                                  </div>
                                </a>
                                <div class="button button-raised button-big circle" v-if="subItem.mainType == 1">
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">block</i>
                                  </div>
                                </div>
                                <a
                                  :class="subItem.ref == 0?'off_flag':'on_flag'"
                                  :onoff="subItem.ref"
                                  v-if="subItem.mainType == 2"
                                  v-on:click="onOffItem(subItem)"
                                >
                                  <div class="button button-raised button-big onoff"></div>
                                </a>
                                <div class="button button-raised button-big circle" v-if="subItem.mainType == 4">
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">touch_app</i>
                                  </div>
                                </div>
                                <div class="button button-raised button-big circle" v-if="subItem.mainType == 5">
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important"
                                      >brightness_low</i
                                    >
                                  </div>
                                </div>
                                <div class="button button-raised button-big circle" v-if="subItem.mainType == 6">
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important"
                                      >brightness_high</i
                                    >
                                  </div>
                                </div>
                                <div
                                  class="button button-raised button-big circle"
                                  v-if="subItem.mainType == 7"
                                  v-on:click="openCloseItem(subItem)"
                                >
                                  <div>
                                    <img
                                      :src="'https://my.yoswit.com/files/app/'+(subItem.ref === 0 ? 'close' : 'open') +'-curtain.svg'"
                                      alt=""
                                      style="width: 20px; height: 20px; margin-top: 20px"
                                    />
                                  </div>
                                </div>
                                <div class="button button-raised button-big circle" v-if="subItem.mainType == 9">
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">pause</i>
                                  </div>
                                </div>
                                <div
                                  class="button button-raised button-big circle"
                                  v-if="subItem.mainType == 10"
                                  style="background-color: var(--f7-theme-color)"
                                  v-on:click="chooseTemplate(subItem)"
                                >
                                  <div>
                                    <i
                                      class="material-icons text-color-white"
                                      style="line-height: 70px !important; font-size: 25px !important"
                                      >cleaning_services</i
                                    >
                                  </div>
                                </div>
                                <div
                                  class="button button-raised button-big circle"
                                  v-if="subItem.mainType == 12"
                                  v-on:click="chooseTemplate(subItem)"
                                >
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important"
                                      >cleaning_services</i
                                    >
                                  </div>
                                </div>
                                <div
                                  class="button button-raised button-big circle"
                                  v-if="subItem.mainType == 11"
                                  style="background-color: var(--f7-theme-color)"
                                  v-on:click="chooseTemplate(subItem)"
                                >
                                  <div>
                                    <i
                                      class="material-icons text-color-white"
                                      style="line-height: 70px !important; font-size: 25px !important"
                                      >notifications_off</i
                                    >
                                  </div>
                                </div>
                                <div
                                  class="button button-raised button-big circle"
                                  v-if="subItem.mainType == 13"
                                  v-on:click="chooseTemplate(subItem)"
                                >
                                  <div>
                                    <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important"
                                      >notifications_off</i
                                    >
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="swipeout-actions-right">
                              <a v-on:click="cancelTemplate(subItem)" class="link color-red">
                                <i class="icon material-icons">cancel</i>
                              </a>
                            </div>
                          </li>
                          <!-- subdevice bottom box start -->
                          <li
                            class="device subdevice"
                            :class="{'device-hidden':subItem.buttonBoxType == 0?true:false,'display-flex':subItem.buttonBoxType == 0?false:true}"
                            :style="{'height': subItem.buttonBoxType == 3?'77px':'67px'}"
                          >
                            <div class="row padding-tb flex-direction-column justify-content-center" v-if="subItem.buttonBoxType == 1">
                              <div class="col-100 medium-100 large-100">
                                <div class="content display-flex justify-content-center" style="margin-left: 15px; margin-right: 15px">
                                  <div class="tip-title"><i class="icon material-icons" style="margin-right: 8px">brightness_low</i></div>
                                  <div
                                    class="range-slider range-slider-scene"
                                    :guid="subItem.device"
                                    :button_group="subItem.device_button_group"
                                    :name="subItem.name"
                                  ></div>
                                  <div class="tip-title"><i class="icon material-icons" style="margin-left: 8px">brightness_high</i></div>
                                </div>
                              </div>
                            </div>
                            <div class="row padding-tb flex-direction-column justify-content-center" v-if="subItem.buttonBoxType == 2">
                              <div class="col-100 medium-100 large-100">
                                <div class="content display-flex justify-content-center" style="margin-left: 15px; margin-right: 15px">
                                  <div class="tip-title">
                                    <img
                                      src="https://my.yoswit.com/files/app/close-curtain.svg"
                                      alt=""
                                      style="width: 20px; height: 20px; margin-right: 8px; margin-top: 5px"
                                    />
                                  </div>
                                  <div
                                    class="range-slider range-slider-scene"
                                    :guid="subItem.device"
                                    :button_group="subItem.device_button_group"
                                    :name="subItem.name"
                                  ></div>
                                  <div class="tip-title">
                                    <img
                                      src="https://my.yoswit.com/files/app/open-curtain.svg"
                                      alt=""
                                      style="width: 20px; height: 20px; margin-left: 8px; margin-top: 5px"
                                    />
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="item-content" style="width: 100%" v-if="subItem.buttonBoxType == 3">
                              <div class="item-inner">
                                <div
                                  class="display-flex justify-content-space-between align-content-center align-items-center"
                                  style="--f7-grid-gap: 3px"
                                >
                                  <a
                                    href="#"
                                    class="col"
                                    v-on:click="clickThermostatChange(subItem,'mode')"
                                    command-type="mode"
                                    :guid="subItem.device"
                                  >
                                    <div class="button button-raised button-big stop" style="width: 70px">
                                      <img
                                        style="width: 25px; height: 25px"
                                        :src="'style/img/air_condition/icon-mode-'+dealWithThermostat(subItem.modeStr)+'.png'"
                                      />
                                    </div>
                                  </a>
                                  <a
                                    href="#"
                                    class="col"
                                    v-on:click="clickThermostatChange(subItem,'fan')"
                                    command-type="fan"
                                    :guid="subItem.device"
                                  >
                                    <div class="button button-raised button-big stop" style="width: 70px">
                                      <img
                                        style="width: 25px; height: 25px"
                                        :src="'style/img/air_condition/icon-speed-'+(subItem.speedVaule?subItem.speedVaule:0)+'.png'"
                                      />
                                    </div>
                                  </a>
                                  <a
                                    href="#"
                                    class="col"
                                    v-on:click="clickThermostatChange(subItem,'reduce')"
                                    command-type="reduce"
                                    :guid="subItem.device"
                                  >
                                    <div class="button button-raised button-big stop" style="width: 70px; font-size: 25px">-</div>
                                  </a>
                                  <a
                                    href="#"
                                    class="col set-temp"
                                    style="line-height: 60px; margin-top: 8px; text-align: center"
                                    button-signal="5"
                                  >
                                    <span>{{subItem.temperature}}</span>
                                  </a>
                                  <a
                                    href="#"
                                    class="col"
                                    v-on:click="clickThermostatChange(subItem,'add')"
                                    command-type="reduce"
                                    :guid="subItem.device"
                                  >
                                    <div class="button button-raised button-big stop" style="width: 70px; font-size: 25px">+</div>
                                  </a>
                                </div>
                              </div>
                            </div>
                          </li>
                        </div>
                        <!-- subdevice bottom box end -->
                      </div>
                    </ul>
                  </div>
                  <!-- room list end -->
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="tindyCommandAndPostErp()">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- index == 13 -->
            <div id="step-13" class="view tab view-main" :class="[index == 13 ? 'tab-active' : '']" v-if="index == 13">
              <!-- choose the gateway -->
              <div class="card">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Choose Your Gateway")}}</div>
                <div class="card-content card-content-padding">
                  <div class="scnen-template-intro"></div>
                  <div
                    class="scnen-template display-flex justify-content-space-between align-content-center align-items-center"
                    v-for="(item,index) in gatewayList"
                    :key="item.device"
                    :style="{'background-color':'#253b4f'}"
                  >
                    <div class="scnen-template-title">
                      <p>{{item.title}}</p>
                      <p>{{item.roomTitle}}</p>
                    </div>
                    <div class="check-box display-flex justify-content-center align-items-center">
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-if="!item.ischeck"
                        v-on:click="changeGatewayStatus(item)"
                        >check_box_outline_blank</i
                      >
                      <i
                        class="material-icons text-color-white"
                        style="font-size: 30px"
                        v-else="item.ischeck"
                        v-on:click="changeGatewayStatus(item)"
                        >check_box</i
                      >
                    </div>
                  </div>
                  <div class="block" style="text-align: center; margin: 30px 0" v-if="gatewayList.length == 0">
                    <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
                    <p>${_('You do not have any gateway devices.')}</p>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px" v-if="gatewayList.length != 0">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="chooseGatewayDevice()">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- index == 14 -->
            <div id="step-14" class="view tab view-main" :class="[index == 14 ? 'tab-active' : '']" v-if="index == 14">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div
                    class="action-box card"
                    style="margin-left: 0; margin-right: 0; margin-top: 10px"
                    v-if="this.templateName == 'Welcome Scene'"
                  >
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Save Device Status')}}</div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="changeRadarEnterUnmannedModeStatus"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!radarEnterUnmannedModeStatus">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="radarEnterUnmannedModeStatus">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div
                    class="action-box card"
                    style="margin-left: 0; margin-right: 0; margin-top: 10px"
                    v-if="this.templateName == 'Welcome Scene'"
                  >
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Restore Device Status')}}</div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="changeRadarExitUnmannedModeStatus"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!radarExitUnmannedModeStatus">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="radarExitUnmannedModeStatus">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div
                    class="action-box card"
                    style="margin-left: 0; margin-right: 0; margin-top: 10px"
                    v-if="this.templateName == 'Welcome Scene' || this.templateName == 'RCU Scene Button'"
                  >
                  <div class="action-list list media-list no-margin">
                    <ul>
                      <li class="device" v-for="(item,index) in deviceStatusList" :key="index" v-if="!item.isHidden">
                        <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                          <div
                            class="device-thumb item-media"
                            :style="{
                            'background-position': 'center',
                            'background-size': 'contain',
                            'position': 'relative',
                            'background-image': 'url('+item.imgUrl+')'}
                          "
                          ></div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                            </div>
                            <div class="item-subtitle">{{ item.device_model }}-{{ item.mac_address }}</div>
                            <div class="signal-panel item-text height-21" style="">
                              {{tran(item.room_name)}}/
                              <span class="text-color-theme">{{_('Maintain Status')}}</span>
                            </div>
                          </div>
                          <div class="margin-right" style="" v-on:click="deleteStatusItem(item.name)">
                            <i class="material-icons text-color-gray">delete</i>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                    <div class="add-box add-action display-flex justify-content-flex-start align-items-center" v-on:click="toRoomList('Choose Device Status',5)">
                      <i class="material-icons">add_circle</i>
                      <div class="trigger-text margin-left">{{_("Maintain Device Status")}}</div>
                      
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(14)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-15" class="view tab view-main" :class="[index == 15 ? 'tab-active' : '']" v-if="index == 15">
              <div class="card">
                <div class="card-content card-content-padding">
                  <div
                    class="action-box card"
                    style="margin-left: 0; margin-right: 0; margin-top: 10px"
                    v-if="this.templateName == 'Welcome Scene' || this.templateName == 'RCU Scene Button'"
                  >
                  <div class="action-list list media-list no-margin">
                    <ul>
                      <li class="device" v-for="(item,index) in deviceStatusList" :key="index" v-if="!item.isHidden">
                        <div class="item-content swipeout-content display-flex justify-content-space-between align-items-center">
                          <div
                            class="device-thumb item-media"
                            :style="{
                            'background-position': 'center',
                            'background-size': 'contain',
                            'position': 'relative',
                            'background-image': 'url('+item.imgUrl+')'}
                          "
                          ></div>
                          <div class="item-inner">
                            <div class="item-title-row">
                              <div class="item-title ellipsis" lang="en" style="width: 200px">{{item.title}}</div>
                            </div>
                            <div class="item-subtitle">{{ item.scene_template }}</div>
                            <div class="signal-panel item-text height-21" style="">
                              {{'V-ID:'+item.virtualId}}/
                              <span class="text-color-theme">{{_('Maintain Status')}}</span>
                            </div>
                          </div>
                          <div class="margin-right" style="" v-on:click="deleteStatusItem(item.name)">
                            <i class="material-icons text-color-gray">delete</i>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                    <div class="add-box add-action display-flex justify-content-flex-start align-items-center" v-on:click="toSceneList('Choose Scene','8','1')">
                      <i class="material-icons">add_circle</i>
                      <div class="trigger-text margin-left">{{_("Maintain Scene Status")}}</div>
                      
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(15)">{{_("NEXT")}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    let { name, sub_name, type } = $f7route.query;
    //let { guid, subdevice_name } = $f7route.query;
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          SCENE_TRIGGER_TYPE: [
            113, //0 DEVICE_SCENE_KEY_SELECT_KEYUP
            114, //1 DEVICE_SCENE_KEY_SELECT_KEYDOWN
            115, //2 DEVICE_SCENE_KEY_UP_KEYUP
            116, //3 DEVICE_SCENE_KEY_UP_KEYDOWN
            117, //4 DEVICE_SCENE_KEY_DOWN_KEYUP
            118, //5 DEVICE_SCENE_KEY_DOWN_KEYDOWN
            119, //6 DEVICE_SCENE_KEY_LEFT_KEYUP
            120, //7 DEVICE_SCENE_KEY_LEFT_KEYDOWN
            121, //8 DEVICE_SCENE_KEY_RIGHT_KEYUP
            122, //9 DEVICE_SCENE_KEY_RIGHT_KEYDOWN
            123, //10 DEVICE_SCENE_KEY_CENTER_KEYUP (Door Close)
            124, //11 DEVICE_SCENE_KEY_CENTER_KEYDOWN (Door Open)
            125, //12 DEVICE_SCENE_KWH_ON
            126, //13 DEVICE_SCENE_KWH_OFF
            141, //14 DEVICE_SCENE_KEYS_KEYUP
            142, //15 DEVICE_SCENE_KEYS_KEYDOWN
            143, //16 DEVICE_SCENE_KEYS_KEYUP_DELAY
            145, //17 DEVICE_SCENE_KEYS_KEYDOWN_DELAY
          ],
          sceneList: [],
          SceneNameTip: _('Scene Name'),
          index: 0,
          actionGuid: '',
          subdeviceName: '',
          sheetMap: null,
          actionSheetMap: null,
          subdeviceMap: { title: '' },
          sceneImage: '',
          scene_tip: '',
          sceneName: '',
          secondSceneName: '',
          actionName: '',
          actionCurtainId_1: '',
          actionCurtainId_2: '',
          actionList: [], //first action list
          actionList_2: [], //sconed action list
          pickObj: null,
          virtualPick: null,
          rcuMacAddress: '',
          actionId: '',
          mutiwayStatus: 1,
          mainRcuId: '',
          attachRcuId: '',
          attachRcuGuid: '',
          trigger: [], //cutom trigger
          trigger_1: [], //mapping actionList
          trigger_2: [], //mapping actionList_2
          triggerActionId: '',
          timercommand: '',
          templateName: 'RCU Scene Button',
          actionMap: {},
          scenePostId: '',
          profileDeviceName: '',
          virtualList: [],
          virtualStatus: false,
          sceneDeviceLocation: [],
          uploadImage: '',
          triggerCondition: 2,
          rcuList: [],
          stepList: [],
          virtualIdList: {}, //guid : id,
          overallVirtualId: '',
          overallSceneMap: {
            'trigger': {},
            'action': {
              actionList: [],
              actionList_2: [],
              actionMap: {},
              actionMap_2: {},
            },
            'scene_device_location': [],
            'ui_configuration': {},
            'condition': {},
            'scene_template': '',
            'profile_subdevice': '',
            'profile': erp.info.profile.name,
          },
          scenePostMap_1: {
            'trigger': {},
            'action': {},
            'scene_device_location': [],
            'ui_configuration': {
              'key': 'first',
            },
            'condition': {},
            'scene_template': '',
            'profile_subdevice': '',
            'profile': erp.info.profile.name,
          }, // if toggle scene have 3 scene setup
          scenePostMap_2: {
            'trigger': {},
            'action': {},
            'scene_device_location': [],
            'ui_configuration': {
              'key': 'second',
            },
            'condition': {},
            'scene_template': '',
            'profile_subdevice': '',
            'profile': erp.info.profile.name,
          }, // if toggle scene have 3 scene setup
          scenePostMap_3: {
            'trigger': {},
            'action': {},
            'scene_device_location': [],
            'ui_configuration': {
              'key': 'third',
            },
            'condition': {},
            'scene_template': '',
            'profile_subdevice': '',
            'profile': erp.info.profile.name,
          }, // if toggle scene have 3 scene setup
          templateConfig: {
            //type:1 choose tempalte,2 choose Rcu,3
            rcu_scene_button: {
              name: 'RCU Scene Button',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 15,
                  name: '3',
                },
                {
                  id: 4,
                  relatedIndex: 2,
                  name: '4',
                },
                {
                  id: 5,
                  relatedIndex: 3,
                  name: '5',
                },
                {
                  id: 6,
                  relatedIndex: 4,
                  name: '6',
                },
                {
                  id: 7,
                  relatedIndex: 5,
                  name: '7',
                },
              ],
            },
            rcu_scene_new_toggle: {
              name: 'RCU Scene New Toggle',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 15,
                  name: '3',
                },
                {
                  id: 4,
                  relatedIndex: 2,
                  name: '4',
                },
                {
                  id: 5,
                  relatedIndex: 3,
                  name: '5',
                },
                {
                  id: 6,
                  relatedIndex: 4,
                  name: '6',
                },
                {
                  id: 7,
                  relatedIndex: 5,
                  name: '7',
                },
              ],
            },
            rcu_scene_toggle: {
              name: 'RCU Scene Toggle',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 2,
                  name: '3',
                },
                {
                  id: 5,
                  relatedIndex: 7,
                  name: '4',
                },
                {
                  id: 6,
                  relatedIndex: 3,
                  name: '5',
                },
                {
                  id: 7,
                  relatedIndex: 4,
                  name: '6',
                },
                {
                  id: 8,
                  relatedIndex: 5,
                  name: '7',
                },
              ],
            },
            rcu_scene_toggle_save_status: {
              name: 'RCU Scene Toggle - Save Status',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 2,
                  name: '3',
                },
                {
                  id: 5,
                  relatedIndex: 7,
                  name: '4',
                },
                {
                  id: 6,
                  relatedIndex: 3,
                  name: '5',
                },
                {
                  id: 7,
                  relatedIndex: 4,
                  name: '6',
                },
                {
                  id: 8,
                  relatedIndex: 5,
                  name: '7',
                },
              ],
            },
            rcu_randar: {
              name: 'RCU Radar',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 2,
                  name: '3',
                },
                {
                  id: 4,
                  relatedIndex: 3,
                  name: '4',
                },
                {
                  id: 5,
                  relatedIndex: 4,
                  name: '5',
                },
                {
                  id: 5,
                  relatedIndex: 5,
                  name: '6',
                },
              ],
            },
            rcu_click_and_stop: {
              name: 'RCU Curtain',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 2,
                  name: '3',
                },
                {
                  id: 6,
                  relatedIndex: 3,
                  name: '4',
                },
                {
                  id: 7,
                  relatedIndex: 4,
                  name: '5',
                },
                {
                  id: 8,
                  relatedIndex: 5,
                  name: '6',
                },
              ],
            },
            welcome_scene: {
              name: 'Welcome Scene',
              step: [
                {
                  id: 1,
                  relatedIndex: 0.5,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 9,
                  relatedIndex: 14,
                  name: '3',
                },
                {
                  id: 3,
                  relatedIndex: 2,
                  name: '4',
                },
                {
                  id: 4,
                  relatedIndex: 3,
                  name: '5',
                },
                {
                  id: 5,
                  relatedIndex: 4,
                  name: '6',
                },
                {
                  id: 5,
                  relatedIndex: 5,
                  name: '7',
                },
              ],
            },
            room_scene_button: {
              name: 'Room Scene Button',
              step: [
                {
                  id: 1,
                  relatedIndex: 1,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 12,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 10,
                  name: '3',
                },
              ],
            },
            room_scene_button: {
              name: 'Favorite Scene',
              step: [
                {
                  id: 1,
                  relatedIndex: 1,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 10,
                  name: '2',
                },
              ],
            },
            gateway_scene: {
              name: 'Gateway Scene',
              step: [
                {
                  id: 1,
                  relatedIndex: 13,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 1,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 2,
                  name: '3',
                },
                {
                  id: 4,
                  relatedIndex: 3,
                  name: '4',
                },
                {
                  id: 5,
                  relatedIndex: 4,
                  name: '5',
                },
                {
                  id: 6,
                  relatedIndex: 5,
                  name: '6',
                },
              ],
            },
            timer: {
              name: 'Timer',
              step: [
                {
                  id: 1,
                  relatedIndex: 1,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 11,
                  name: '2',
                },
              ],
            },
            scene_button: {},
            normal_scene: {
              name: 'Scene Banner',
              step: [
                {
                  id: 1,
                  relatedIndex: 1,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 10,
                  name: '2',
                },
              ],
            },
            multiway_switch: {
              name: 'Multiway Switch',
              step: [
                {
                  id: 1,
                  relatedIndex: 1,
                  name: '1',
                },
                {
                  id: 2,
                  relatedIndex: 8,
                  name: '2',
                },
                {
                  id: 3,
                  relatedIndex: 9,
                  name: '3',
                },
              ],
            },
            timmer: {},
          },
          templateList: [
            {
              title: 'Mobile App',
              icon: 'phone_iphone',
              des: 'Scene store in mobile app.',
              list: [
                {
                  name: 'Scene Banner',
                  desription: '',
                  icon: 'batch_prediction',
                  color: '#7aB2d3',
                },
                {
                  name: 'Room Scene Button',
                  desription: '',
                  icon: 'bed',
                  color: '#BC7C7C',
                },
              ],
            },
            {
              title: 'Device',
              icon: 'phone_iphone',
              des: 'Scene stores in the device.',
              list: [
                {
                  name: 'Multiway Switch',
                  desription: '',
                  icon: 'read_more',
                  color: '#8fd1cb',
                },
              ],
            },
            // {
            //   title: 'Gateway',
            //   icon: 'wifi',
            //   des: 'Scene stores in the gateway.',
            //   list: [
            //     {
            //       name: 'Gateway Scene',
            //       desription: '',
            //       icon: 'network_check',
            //       color: '#ff9500',
            //     },
            //   ],
            // },
            {
              title: 'RCU',
              icon: 'phone_iphone',
              des: 'Scene store in RCU.',
              list: [
                {
                  name: 'RCU Scene Button',
                  desription: '',
                  icon: 'motion_photos_auto',
                  color: '#5855e0',
                },
                {
                  name: 'RCU Scene Toggle',
                  desription: '',
                  icon: 'touch_app',
                  color: '#A85F32',
                },
                {
                  name: 'RCU Scene New Toggle',
                  desription: '',
                  icon: 'touch_app',
                  color: '#CA6924',
                },
                // {
                //   name: 'RCU Scene Toggle - Save Status',
                //   desription: '',
                //   icon: 'touch_app',
                //   color: '#CA6924',
                // },
                {
                  name: 'RCU Radar',
                  desription: '',
                  icon: 'radar',
                  color: '#3e3936',
                },
                {
                  name: 'Welcome Scene',
                  desription: '',
                  icon: 'sentiment_satisfied',
                  color: '#ff9500',
                },
                {
                  name: 'RCU Curtain',
                  desription: '',
                  icon: 'stop_circle',
                  color: '#744020',
                },
              ],
            },
          ],
          // templateList: [
          //   {
          //     name: 'RCU Scene Button',
          //     desription: '',
          //     icon: 'motion_photos_auto',
          //     color: '#5855e0',
          //   },
          //   {
          //     name: 'RCU Scene Toggle',
          //     desription: '',
          //     icon: 'touch_app',
          //     color: '#A85F32',
          //   },
          //   {
          //     name: 'RCU Radar',
          //     desription: '',
          //     icon: 'radar',
          //     color: '#3e3936',
          //   },
          //   {
          //     name: 'Click And Stop',
          //     desription: '',
          //     icon: 'stop_circle',
          //     color: '#744020',
          //   },
          //   // {
          //   //   name: 'Scene Button',
          //   //   desription: '',
          //   //   icon: 'autofps_select',
          //   //   color: '#f5c160',
          //   // },
          //   {
          //     name: 'Normal Scene',
          //     desription: '',
          //     icon: 'batch_prediction',
          //     color: '#7aB2d3',
          //   },
          //   {
          //     name: 'Multiway Switch',
          //     desription: '',
          //     icon: 'read_more',
          //     color: '#8fd1cb',
          //   },
          //   // {
          //   //   name: 'Timer',
          //   //   desription: '',
          //   //   icon: 'snooze',
          //   //   color: '#b8bec5',
          //   // },
          // ], //
          oneOnly: false,
          timerList: [],
          hideDevice: false,
          conditionsMap: {},
          actionBleCommandList: [], 
          actionLocation: {},
          randarActionCommand: {},
          extraActionList: [],
          extraTriggerList: [],
          isExtraStatus: false,
          isRelease: false,
          selfTriggered: false, //is trigger by self rcu
          selfTriggeredClickStatus: false,
          selfTriggeredButtonStatus: false,
          virtualTriggerList: [],
          subscribeMacadrress: '',
          //mutiway parameter
          mappingDeviceList: [],
          otherMappingDeviceList: [],
          mutiwayPostConfig: {
            //"guid" : {"mapping" : '',...}
          },
          showInHome: false,
          mainRcuGuid: '',
          subdevices: [],
          roomList: [],
          gatewayList: [], //profile gateway list
          subName: 0,
          gatewayTopic: '', //like mac-userId
          gatewayMapGuid: '',
          radarEnterUnmannedModeStatus: false,
          radarExitUnmannedModeStatus: true,
          deviceActionCommandList: [],
          deviceStatusList : [],//choose the device save status
          rcuTempList : [],//save the rcu temp list
          
        },
        watch: {
          index: function (val) {
            this.activeStepList();
          },
        },
        mounted() {
          this.init();
          emitter.on('trigger_save', (data) => {
            console.log(data);
            //if exist the same trigger, warn it
            let sameCheckStatus = false;
            this.trigger.forEach((item) => {
              if (item.title == data.display_name && item.button_group == data.button_group && item.guid === data.guid) {
                sameCheckStatus = true;
              }
            });
            if (sameCheckStatus) {
              app.dialog.alert(_('The trigger condition already exists. Please modify it.'));
              return;
            }
            const { button_group, display_name, mac_address, model, mode, img_url, room_name, guid, gateway, config } = data;
            let ref = data.value;
            let temp = data.temp;
            let hum = data.hum;
            let temp_less = data.temp_less;
            let hum_less = data.hum_less;
            let status = '';
            if (mode == 'RF Sensor' || mode == 'Radar Sensor' || button_group.startsWith('RCU INPUT')) {
              if (ref == 1) {
                status = 'Occupied';
              } else {
                status = 'Unoccupied';
              }
              //check if the tempalte is not rcu randar
              if (this.templateName != 'RCU Radar' && this.templateName != 'Welcome Scene') {
                app.dialog.confirm(
                  _('The scene template is not a RCU Radar. Do you want to change?'),
                  () => {
                    this.templateName = 'RCU Radar';
                    this.index = 0;
                    this.trigger = [];
                  },
                  () => {}
                );
              }
              if (this.trigger.length > 0) {
                this.trigger[0].condition = this.triggerCondition;
              }
            } else if (mode == 'On Off Switch' || mode == 'RCU Scene Button') {
              if (ref == 1) {
                status = 'ON';
              } else if (ref == 2) {
                status = 'CLICK';
              } else if (ref == 4) {
                status = 'CLICK AND STOP';
              } else if (ref == 3) {
                status = 'CLICK';
              } else {
                status = 'OFF';
              }
            } else if (mode == 'Thermostat') {
              if (temp) {
                status = `>${temp}/`;
              }
              if (temp_less) {
                status += `<${temp_less}/`;
              }
              if (hum) {
                status += `>${hum}%/`;
              }
              if (hum_less) {
                status += `<${hum_less}%/`;
              }
            } else if (mode == 'RCU Controller' && button_group == 'SCENE MUTIWAY ONOFF GANG1') {
              if (ref == 1) {
                status = 'ON';
              } else {
                status = 'OFF';
              }
            } else if (mode == 'Door Sensor') {
              debugger;
              if (ref == 1) {
                status = 'OPEN';
              } else {
                status = 'CLOSE';
              }
            }
            if (gateway) {
              this.gateway = gateway;

              let gateway_mac = gateway.split('-')[0];
              this.gateway_mac = gateway_mac;
              //get guid of the gateway
              let list = erp.info.device;
              for (let i in list) {
                if (list[i].mac_address === gateway_mac) {
                  this.gateway_guid = i;
                }
              }
            }
            this.trigger.push({
              title: display_name,
              model: model,
              mode: mode,
              img_url: img_url,
              mac_address: mac_address,
              room_title: room_name,
              guid: guid,
              temp: temp,
              hum: hum,
              temp_less: temp_less,
              hum_less: hum_less,
              ref: ref,
              is_close_to_door: data.is_close_to_door,
              status: status,
              gateway: gateway,
              button_group: button_group,
              config: config,
              condition: this.triggerCondition,
            });
            if ((mode == 'On Off Switch' || mode == 'RCU Scene Button') && ref == 4) {
              this.trigger.push({
                title: display_name,
                model: model,
                mode: mode,
                img_url: img_url,
                mac_address: mac_address,
                room_title: room_name,
                guid: guid,
                temp: temp,
                hum: hum,
                temp_less: temp_less,
                hum_less: hum_less,
                ref: 2,
                status: _('CLICK'),
                gateway: gateway,
                button_group: button_group,
                config: config,
                condition: this.triggerCondition,
                isHidden: true,
              });
            }
            if ((mode == 'On Off Switch' || mode == 'RCU Scene Button') && ref == 3) {
              this.trigger.push({
                title: display_name,
                model: model,
                mode: mode,
                img_url: img_url,
                mac_address: mac_address,
                room_title: room_name,
                guid: guid,
                temp: temp,
                hum: hum,
                temp_less: temp_less,
                hum_less: hum_less,
                ref: 5,
                status: _('RELEASE'),
                gateway: gateway,
                button_group: button_group,
                config: config,
                condition: this.triggerCondition,
              });
            }
          });
          //save_device_status
          emitter.on('save_device_status', (data) => {
            console.log(data);
            let list = JSON.parse(data.data);
            //console.log(list);
            list.forEach((element) => {
              this.deviceStatusList.push(element);
            });
          });
          emitter.on('save_scene_status', (data) => {
            console.log(data);
            let list = JSON.parse(data.data);
            //console.log(list);
            list.forEach((element) => {
              this.deviceStatusList.push(element);
            });
          });

          emitter.on('save_scene_action', (data) => {
            console.log(data);
            debugger 
            let list = JSON.parse(data.data);
            //console.log(list);
            list.forEach((element) => {
              if(this.mainRcuGuid){ 
                element.guid = this.mainRcuGuid;
                element.device = this.mainRcuGuid;
              }
              if (this.mutiwayStatus == 2) {
                this.actionList_2.push(element);
              } else {
                element.isCheck = false;
                this.actionList.push(element);
              }
            });
            console.log(this.actionList);
          });
          emitter.on('save_action', (data) => {
            console.log(data);
            let list = JSON.parse(data.data);
            //console.log(list);
            list.forEach((element) => {
              if (this.mutiwayStatus == 2) {
                this.actionList_2.push(element);
              } else {
                element.isCheck = true;
                this.actionList.push(element);
              }
            });
            console.log(this.actionList);
          });
          emitter.on('set_timmer', (data) => {
            console.log('set_timmer', data);
            this.timercommand = data.command;
            this.timerList = [];
            this.$set(this.timerList, 0, data);
            //this.timerList.push(data);
          });
        },
        methods: {
          async init() {
            let scenes = cloneDeep(erp.info.scene);
            if (type == 'favorite') {
              this.loadFavoriteErpData();
              return;
            } else {
              this.loadErpData();
            }
            //init the rcu data,init the mianRcuConfig
            let devices = cloneDeep(erp.info.device);
            for (let i in devices) {
              if (devices[i].device_model.startsWith('YO780') && !devices[i].device_model.startsWith('YO780-Scene')) {
                //this.actionGuid = devices[i].guid;
                devices[i].ischeck = true;
                let asMain = false;
                let settings = devices[i].settings;
                settings.forEach((settingItem) => {
                  if (settingItem.setting_type.startsWith('main_rcu')) {
                    if (settingItem.setting == 1) {
                      asMain = true;
                      this.mainRcuGuid = i;
                    }
                  }
                });
                devices[i].asMain = asMain;
                this.rcuList.push(devices[i]);
              }
            }

            //init the subdevice name
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            profile_devices.forEach((item) => {
              if (item.device == this.actionGuid) {
                this.profileDeviceName = item.name;
              }
            });
            profile_subdevices.forEach((item) => {
              if (item.device == this.actionGuid && item.device_button_group == 'ONOFF GANG1') {
                this.subdeviceName = item.name;
                this.subdeviceMap = item;
                console.log('subdeviceMap', this.subdeviceMap);
              }
            });
            //init the pick
            // this.pickObj = app.picker.create({
            //   inputEl: '#demo-picker-device',
            //   cols: [
            //     {
            //       textAlign: 'center',
            //       values: ['RCU Scene Button', 'RCU Radar', 'Multiway Switch', 'Scene Button', 'Timer'],
            //     },
            //   ],
            //   on: {
            //     change: (_, value) => {
            //       this.templateName = value[0];
            //     },
            //   },
            // });
            //this.pickObj.setValue(["RCU Scene Button"])
          },
          initGatewayList() {
            let thisGatewayList = [];
            let list = cloneDeep(erp.info.profile.profile_device);
            //pass device model is gateway check
            let models = cloneDeep(erp.doctype.device_model);
            list.forEach((item) => {
              let model = item.device_model;
              //model is Object json
              let modelMap;
              for (let i in models) {
                if (models[i].model_code == model) {
                  modelMap = models[i];
                }
              }
              if (modelMap && modelMap.gateway) {
                thisGatewayList.push(item);
              }
            });
            //find the gateway name
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            thisGatewayList.forEach((item) => {
              item.roomTitle = '';
              item.title = '';
              item.ischeck = false;
              subdevices.forEach((subdevice) => {
                if (subdevice.device == item.device) {
                  item.title = tran(subdevice.title);
                  item.roomTitle = tran(subdevice.room_name);
                }
              });
              if (item.device == this.gatewayMapGuid) {
                item.ischeck = true;
              }
            });
            this.gatewayList = thisGatewayList;
          },
          initRoomDevices() {
            let devices = cloneDeep(erp.info.profile.profile_subdevice);
            let scenes = cloneDeep(erp.info.scene);
            let sceneMap;
            let tem_devices = [];
            for (let i in scenes) {
              if (scenes[i].name == this.scenePostId) {
                sceneMap = scenes[i];
              }
            }
            //init the profile_device
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            devices.forEach((item) => {
              let device_name = item.profile_device;
              profile_devices.forEach((kitem) => {
                if (device_name === kitem.name) {
                  item.device_model = kitem.device_model;
                  item.mac_address = kitem.device_name.substring(0, 12);
                  console.log('kitem.device', kitem.device);
                  if (isset(window.peripheral[kitem.device])) {
                    let firmware = window.peripheral[kitem.device].prop.firmware;
                    item.firmware = firmware ? firmware : 0;
                  }
                }
              });
            });
            //init the modelList
            let models = cloneDeep(erp.doctype.device_model);
            if (sceneMap) {
              tem_devices = JSON.parse(sceneMap.action);
            }
            devices.forEach((item) => {
              item.isload = false;
              tem_devices.forEach((kitem) => {
                if (kitem.name == item.name) {
                  Object.assign(item, kitem);
                  item.isload = true;
                  console.log('item.mainType', item.mainType);
                  if (item.mainType == 7 || item.mainType == 2) {
                    this.initRangeBar(item.device, item.device_button_group, item.ref);
                  }
                }
              });
              if (item.isload) return;
              item.mainType = 0;
              item.buttonBoxType = 0;
              item.ref = 1;
              if (
                item.device_button_group.startsWith('OPENCLOSE UART') ||
                item.device_button_group.startsWith('DIMMING') ||
                item.device_button_group.startsWith('OPENCLOSE WIFI UART')
              ) {
                item.ref = 100;
              }
              item.chooseStatus = false;
              //filter the device not show in the page
              item.isHidden = false;
              //YO780,YO780-Scene-12G,YO780-Scene-6G,YO105,YO790DC,YO205DC,YO203DC,YO202DS,YO201,YO161-H,YO161
              let fliterList = [
                'YO780',
                'YO780-Scene-12G',
                'YO780-Scene-6G',
                'YO780-Scene-4G',
                'YO780-Scene-1G',
                'YO105',
                'YO790DC',
                'YO205DC',
                'YO203DC',
                'YO202DS',
                'YO201',
                'YO161-H',
                'YO161',
                'YO380DC',
                'YO381DC',
              ];
              let fliterButtonGroup = ['RCU INPUT', 'ONOFF GANG'];
              //check if the button group is in the fliterButtonGroup
              if (fliterList.indexOf(item.device_model) > -1) {
                item.isHidden = true;
              }
              // if(type == 2){
              //   if(fliterList.indexOf(item.device_model) > -1){
              //     item.isHidden = true;
              //     //check if the button group is in the fliterButtonGroup
              //     if(item.device_model == 'YO780'){
              //       if(item.device_button_group != 'ONOFF GANG1'){
              //         item.isHidden = false;
              //       }
              //     }
              //   }
              // }
              let triggerFliterList = ['YO105', 'YO121-BLE-LE', 'YO121-AC'];
              // if(type == 1){
              //   if(triggerFliterList.indexOf(item.device_model) > -1){
              //     item.isHidden = true;
              //   }
              //   if(item.device_model == 'YO780' && item.device_button_group != 'SCENE MUTIWAY ONOFF GANG1' && !item.device_button_group.startsWith('RCU INPUT')){
              //     item.isHidden = true;
              //   }
              // }
              //rcu
              if (item.device_model == 'YO780' && item.device_button_group == 'ONOFF GANG1') {
                item.isHidden = true;
              }
              //choose status
              item.chooseStatus = false;
              let model = item.device_model;
              if (model == 'YO360') {
                item.modeStr = 2;
                item.speedVaule = 4;
                item.temperature = 26;
              }
              for (let i in models) {
                if (models[i].model_code === model) {
                  if (isset(models[i].image)) {
                    item.imgUrl = models[i].image;
                  } else {
                    item.imgUrl = 'https://my.yoswit.com/files/products/YO815.svg';
                  }
                }
              }
            });
            this.subdevices = devices;
            return devices;
          },
          initDevices() {
            let roomList = cloneDeep(erp.info.profile.profile_room);
            //check if have the room check
            let roomName;

            if (this.scenePostId) {
              this.conditionsMap.forEach((item) => {
                if (item.ischeck) {
                  roomName = item.name;
                }
              });
            }
            roomList.forEach((roomItem) => {
              if (roomName == roomItem.name) {
                roomItem.ischeck = true;
                roomItem.isHidden = false;
              } else {
                roomItem.ischeck = false;
                //roomItem.isHidden = true;
              }
            });
            this.roomList = roomList;
            let devices = this.initRoomDevices();
            //filter the room devices
            let roomMap = {};
            this.roomList.forEach((item) => {
              roomMap[item.name] = 0;
              item.isHidden = false;
            });
            devices.forEach((item) => {
              for (let i in roomMap) {
                if (item.profile_room == i && !item.isHidden) {
                  roomMap[i]++;
                }
              }
            });
            this.roomList.forEach((item) => {
              if (roomMap[item.name] == 0) {
                item.isHidden = true;
              }
            });
          },
          async initMutiwayDevices() {
            this.mappingDeviceList = [];
            let devices = cloneDeep(erp.info.profile.profile_device);
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let subdeviceMap;
            let deviceMap;
            subdevices.forEach((item) => {
              if (item.name == sub_name) {
                subdeviceMap = item;
                this.subdeviceMap = item;
              }
            });
            const targetDevice = devices.find((kitem) => kitem.name == subdeviceMap.profile_device);
            if (targetDevice) {
              const mappingDevices = devices.filter(
                (kitem) =>
                  kitem.network_id != 0 &&
                  kitem.network_id == targetDevice.network_id &&
                  kitem.device_mode == 'Multiway Switch' &&
                  kitem.name != targetDevice.name
              );
              console.log('mappingDevices', mappingDevices);
              mappingDevices.forEach((item) => {
                subdevices.forEach((kitem) => {
                  if (item.name == kitem.profile_device) {
                    kitem.device_name = item.device_name;

                    kitem.ischeck = false;
                    if (isset(this.mutiwayPostConfig[kitem.device])) {
                      if (this.mutiwayPostConfig[this.subdeviceMap.device].mapping == kitem.name) {
                        kitem.ischeck = true;
                      }
                    }
                    kitem.network_id = item.network_id;
                    this.mappingDeviceList.push(kitem);
                  }
                });
              });
            }
          },
          postScene(postData) {
            return new Promise((resolve, reject) => {
              let url = encodeURI(`/api/resource/Scene`);
              let method = 'POST';
              if (this.scenePostId) {
                url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                method = 'PUT';
              }
              http2
                .request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: postData,
                })
                .then((rs) => {
                  resolve(1);
                })
                .catch((error) => {
                  reject(error);
                });
            });
          },
          async mutiwayAction() {
            app.dialog.preloader();
            this.otherMappingDeviceList = [];
            let devices = cloneDeep(erp.info.profile.profile_device);
            let this_gang = this.subdeviceMap.device_button_group.replace('ONOFF GANG', '');
            let targetDevice;
            let profile_subdevice_data = {
              'mapping': '',
              'virtual': '',
              'pairing_guid': '',
              'be_pairing': '1',
            };
            this.mappingDeviceList.forEach((item) => {
              if (item.ischeck) {
                targetDevice = item;
              }
            });
            let command = ``;
            if (targetDevice) {
              this.mutiwayPostConfig[this.subdeviceMap.device] = {};
              this.otherMappingDeviceList.push(targetDevice);
              let target_gang = targetDevice.device_button_group.replace('ONOFF GANG', '');
              command = `02${core_utils_get_mac_address_from_guid(this.subdeviceMap.device, true)}81080${this_gang}fe${core_utils_get_mac_address_from_guid(targetDevice.device, true)}ff0${target_gang}00`;
              profile_subdevice_data['mapping'] = targetDevice.name;
              profile_subdevice_data['pairing_guid'] = targetDevice.device;
              this.mutiwayPostConfig[this.subdeviceMap.device]['mapping'] = targetDevice.name;
              this.mutiwayPostConfig[this.subdeviceMap.device]['pairing_guid'] = targetDevice.device;
            } else {
              command = `02${core_utils_get_mac_address_from_guid(this.subdeviceMap.device, true)}81080${this_gang}00`;
            }
            try {
              await window.peripheral[this.subdeviceMap.device].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: command,
                },
              ]);
              await iot_update_profile_subdevice_config(this.subdeviceMap.name, JSON.stringify(profile_subdevice_data));
              await ha_profile_ready();
              app.dialog.close();
              this.index = 9;
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          async otherMutiwayAction() {
            app.dialog.preloader();
            let profile_subdevice_data = {
              'mapping': this.subdeviceMap.name,
              'virtual': '',
              'pairing_guid': this.subdeviceMap.device,
              'is_pairing': '1',
            };
            this.mutiwayPostConfig[this.otherMappingDeviceList[0].device] = {};
            this.mutiwayPostConfig[this.otherMappingDeviceList[0].device]['mapping'] = this.subdeviceMap.name;
            this.mutiwayPostConfig[this.otherMappingDeviceList[0].device]['pairing_guid'] = this.subdeviceMap.device;
            let this_gang = this.otherMappingDeviceList[0].device_button_group.replace('ONOFF GANG', '');
            let target_gang = this.subdeviceMap.device_button_group.replace('ONOFF GANG', '');
            let command = `02${core_utils_get_mac_address_from_guid(this.otherMappingDeviceList[0].device, true)}81080${this_gang}fe${core_utils_get_mac_address_from_guid(this.subdeviceMap.device, true)}ff0${target_gang}00`;
            try {
              await window.peripheral[this.subdeviceMap.device].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: command,
                },
              ]);
              await iot_update_profile_subdevice_config(this.otherMappingDeviceList[0].name, JSON.stringify(profile_subdevice_data));
              //post to the scene
              let post_scene_data = {
                title: this.sceneName,
                profile: erp.info.profile.name,
                profile_subdevice: isset(sub_name) && sub_name != 'undefined' ? sub_name : this.subdeviceName,
                scene_template: this.templateName,
                trigger: JSON.stringify({}),
                action: JSON.stringify({}),
                ui_configuration: JSON.stringify({}),
                condition: JSON.stringify(this.mutiwayPostConfig),
                image: this.uploadImage,
              };
              await this.postScene(post_scene_data);
              await ha_profile_ready();
              window.globalUpdate = true;
              app.dialog.close();
              mainView.router.back();
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          toNetwork() {
            mainView.router.navigate(`/mobile-app/device-network-guid-list`);
          },
          async sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          },
          changeDeviceStatus(item) {
            this.mappingDeviceList.forEach((kitem) => {
              if (item.name != kitem.name) {
                kitem.ischeck = false;
              }
            });
            item.ischeck = !item.ischeck;
          },
          changeGatewayStatus(item) {
            this.gatewayList.forEach((kitem) => {
              kitem.ischeck = false;
            });
            item.ischeck = true;
          },
          changeRcuStatus(item) {
            console.log('item', item);
            item.ischeck = !item.ischeck;
          },
          changeRoomStatus(item) {
            this.roomList.forEach((kitem) => {
              kitem.ischeck = false;
            });
            item.ischeck = true;
          },
          chooseRoom() {
            //hide the other room,show choose room
            let roomItem;
            let checkIsClick = false;
            this.roomList.forEach((kitem) => {
              if (kitem.ischeck) {
                roomItem = kitem;
                checkIsClick = true;
              } else {
                kitem.isHidden = true;
              }
            });
            if (!checkIsClick) {
              app.dialog.alert(_('Please choose a room.'));
              return;
            }
            this.subdevices.forEach((kitem) => {
              if (kitem.profile_room != roomItem.name) {
                kitem.isHidden = true;
              }
            });
            this.index = 10;
            this.initRoomDevices();
            this.activeStepList();
          },
          switchOneOnly() {
            this.oneOnly = !this.oneOnly;
            if (this.oneOnly) {
              //must be input the virtual button name
              this.virtualStatus = true;
            }
          },
          switchSelfTrigger(type) {
            if (type == 1) {
              this.selfTriggeredClickStatus = !this.selfTriggeredClickStatus;
              if (this.selfTriggeredClickStatus) {
                //check if have some rcu
                this.trigger = [];
                this.rcuList.forEach((item) => {
                  if (item.ischeck) {
                    this.trigger.push({
                      guid: item.guid,
                      button_group: 'SCENE MUTIWAY ONOFF GANG1',
                      ref: this.selfTriggeredButtonStatus ? '01' : '00',
                      img_url: 'https://my.yoswit.com/files/YO780.svg',
                      title: 'YO780',
                      mac_address: item.mac_address,
                      mode: item.device_mode,
                      model: item.device_model,
                    });
                  }
                });
              } else {
                this.selfTriggeredButtonStatus = false;
              }
            } else {
              this.selfTriggeredButtonStatus = !this.selfTriggeredButtonStatus;
              this.trigger.forEach((item) => {
                item.ref = this.selfTriggeredButtonStatus ? '01' : '00';
              });
            }
          },
          activeStepList() {
            this.stepList.forEach((item) => {
              if (item.relatedIndex == this.index) {
                item.isActive = true;
              } else {
                item.isActive = false;
              }
            });
          },
          async chooseTemplate(item) {
            this.templateName = item.name;
            console.log(item);
            let activeIndex = '';
            //change the template config
            for (let j in this.templateConfig) {
              if (this.templateConfig[j].name == item.name) {
                this.stepList = this.templateConfig[j].step;
              }
            }
            if (this.templateName == 'Multiway Switch') {
              this.index = 1;
            } else if (this.templateName == 'Scene Banner' || this.templateName == 'Room Scene Button') {
              this.index = 1;
            } else if (this.templateName == 'Gateway Scene') {
              this.index = 13;
              this.initGatewayList();
            } else {
              this.index = 0.5;
            }
            this.activeStepList();
          },
          async chooseGatewayDevice() {
            //check if no chhoose
            let chooseIndex = 0;
            this.gatewayList.forEach((item) => {
              if (item.ischeck) {
                chooseIndex++;
                this.gatewayTopic = item.gateway;
                this.gatewayMapGuid = item.device;
              }
            });
            if (chooseIndex == 0) {
              app.dialog.alert(_('Please choose a gateway device.'));
              return;
            }
            if (!this.gatewayTopic) {
              app.dialog.alert(_('Sorry, this gateway has not been configured yet.'));
              return;
            }
            this.index = 1;
            this.activeStepList();
          },
          async chooseRcuDevice() {
            //alert(123)
            //must be handle any rcu
            app.dialog.preloader();
            let ischeckIndex = 0;
            this.rcuList.forEach((item) => {
              if (item.ischeck) {
                this.actionGuid = item.guid;
                ischeckIndex++;
              }
            });
            if (ischeckIndex > 1) {
              let subscribeMap = {};
              let postMap = {};
              let devices = cloneDeep(erp.info.device);
              this.rcuList.forEach((item) => {
                let guid = item.guid;
                if (isset(devices[guid])) {
                  let settings = devices[guid].settings;
                  settings.forEach((kitem) => {
                    if (kitem.setting_type.startsWith('subscribe_')) {
                      let keys = kitem.setting_type.split('_');
                      let value = kitem.setting;
                      subscribeMap[keys[1]] = value;
                    }
                  });
                }
                if (peripheral[guid].prop.is_mobmob == 1) {
                  this.actionGuid = guid;
                }
              });
              //if rcu length > 1,should subscribe the address
              for (let i in subscribeMap) {
                this.subscribeMacadrress = subscribeMap[i];
              }
              if (this.subscribeMacadrress == '') {
                //post to erp
                let obj = {};
                this.rcuList.forEach((item) => {
                  obj[item.guid] = {};
                  this.rcuList.forEach((kitem) => {
                    if (item.guid != kitem.guid) {
                      obj[item.guid][`subscribe_${kitem.guid}`] = '00C0';
                    }
                  });
                });
                this.subscribeMacadrress = '00C0';
                //console.log(obj)
                for (let i in obj) {
                  try {
                    await iot_device_setting_sync_server(i, Object.keys(obj[i])[0], obj[i][Object.keys(obj[i])[0]]);
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(error);
                  }
                }
              }
            }

            // if (ischeckIndex == 0 || ischeckIndex >= 1) {
            //   this.actionGuid = this.rcuList[0].guid;
            // }
            app.dialog.close();
            if(this.templateName != 'Welcome Scene'){
              this.radarExitUnmannedModeStatus = false;
              this.radarEnterUnmannedModeStatus = false;
            }
            this.initActionSheet();
            //connect the rcu Device
            let rcuConnectStatus = true;
            debugger;
            for (let i in this.rcuList) {
              if (this.rcuList[i].ischeck) {
                let guid = this.rcuList[i].guid;
                try {
                  if (window.peripheral[guid].prop.connected) {
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').addClass('text-color-green');
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').html('check_circle');
                  } else {
                    await window.peripheral[guid].connect();
                    //subscribe the address
                    //16 + 00(unsubscribe)/01(subscribe) + address
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').addClass('text-color-green');
                    $(`.manufacturing-steps[guid="${guid}"]`).find('.item-after i').html('check_circle');
                  }
                  if(this.subscribeMacadrress){
                    await window.peripheral[guid].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: `1601${this.subscribeMacadrress}`,
                    },
                  ]);
                  }
                } catch (error) {
                  console.log(error);
                  rcuConnectStatus = false;
                }
              }
            }
            if (rcuConnectStatus) {
              if (this.$actionSheetMap) {
                this.$actionSheetMap.close();
              }
              this.index = 1;
            } else {
              app.dialog.confirm(
                _('Rcu connect failed,reconnect?'),
                async () => {
                  for (let i in this.rcuList) {
                    if (this.rcuList[i].ischeck) {
                      let guid = this.rcuList[i].guid;
                      try {
                        await window.peripheral[guid].disconnect();
                      } catch (error) {
                        console.log(error);
                      }
                    }
                  }
                  this.chooseRcuDevice();
                },
                () => {}
              );
            }
          },
          //defined the get secen Id Fun
          getDeviceBleId(guid) {
            let sceneDeviceLocationList = [];
            let sceneObj = cloneDeep(erp.info.scene);
            let idList = [];
            for (let i in sceneObj) {
              sceneObj[i].scene_device_location.forEach((item) => {
                sceneDeviceLocationList.push(item);
              });
            }
            sceneDeviceLocationList.forEach((kitem) => {
              if (kitem.device == guid) {
                idList.push(parseInt(kitem.storage_id));
              }
            });
            return this.findMissingNumber(idList);
          },
          async toTab(index) {
            return;
            this.scrollItem(120);

            this.index = index;
          },
          deleteVirtual(name) {
            this.virtualList.forEach((item) => {
              item.display = false;
            });
          },
          deleteTimer() {
            this.timerList = [];
            this.timercommand = '';
          },
          deleteStatusItem(name){
            const index = this.deviceStatusList.findIndex((item) => item.name === name);
            console.log(index)
            this.deviceStatusList.splice(index, 1);
          },
          deleteActionItem(name, type) {
            console.log(this.actionList);
            console.log(name);
            if (type) {
              const index = this.actionList_2.findIndex((item) => item.name === name);
              if (index >= 0) {
                this.actionList_2.splice(index, 1);
              }
            } else {
              const index = this.actionList.findIndex((item) => item.name === name);
              if (index >= 0) {
                this.actionList.splice(index, 1);
              }
            }
          },
          deleteTriggerItem(index) {
            //if is save in the ble,should warn the user, can not delete
            let deviceMap = this.trigger[index];
            let guid = deviceMap.guid;
            let deviceInfo = window.peripheral[guid].prop;
            //check if the device can not scan
            let rssi = deviceInfo.rssilv;
            if (rssi) {
              //check if the device is save in the ble,delete the scene
              if (this.scenePostId && this.templateName != 'RCU Radar' && this.templateName != 'Welcome Scene') {
                app.dialog.alert(_('This scene has been saved in the ble, can not delete.If you want to delete, please delete the scene.'));
                return;
              }
              this.trigger.splice(index, 1);
            } else {
              this.trigger.splice(index, 1);
            }
          },
          changeActionDeviceStatus(item){
            console.log(item);
            item.isCheck = !item.isCheck;
            this.actionList.forEach((kitem)=>{
              if(kitem.name == item.name){
                kitem.isCheck = item.isCheck;
              }
            })
            console.log(this.actionList);
          },
          async loadFavoriteErpData() {
            this.templateName = 'Favorite Scene';
            for (let j in this.templateConfig) {
              if (this.templateConfig[j].name == this.templateName) {
                this.stepList = this.templateConfig[j].step;
              }
            }
            this.index = 1;
            this.activeStepList();
            //load the usersetting data
            let url = `/api/resource/User Settings/${users[users.current].app_id}-${users[users.current].user_id}`;
            let userSetting = await http2.request(encodeURI(url), {
              method: 'GET',
              serializer: 'json',
              responseType: 'json',
              debug: true,
            });
            console.log('userSetting', userSetting);
            let user_data = userSetting.data.data.favour_scene ? JSON.parse(userSetting.data.data.favour_scene) : {};
            let favorite_list = user_data.favorite_list ? user_data.favorite_list : [];
            console.log('favorite_list', favorite_list);
          },
          async loadErpData() {
            this.scenePostId = name;
            let scenes = cloneDeep(erp.info.scene);
            for (let i in scenes) {
              if (name == i) {
                this.sceneName = scenes[i].title;
                this.showInHome = scenes[i].is_enabled == 1 ? false : true;
                this.scenePostId = name;
                this.templateName = scenes[i].scene_template;
                //init the action name and the list
                let actionMap = JSON.parse(scenes[i].action);
                this.actionId = actionMap.actionId;
                this.actionName = actionMap.title;
                this.actionList = this.renderActioonAndTriggerDevice(actionMap.actionList) ;
                this.trigger = this.renderActioonAndTriggerDevice(JSON.parse(scenes[i].trigger) || []);
                //del the connect status
                if (Object.keys(this.trigger).length != 0) {
                  this.trigger.forEach((item) => {
                    item.isBle = false;
                  });
                }
                //this.virtualStatus = actionMap.isVirtual;
                if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain') {
                  this.actionList = this.renderActioonAndTriggerDevice(actionMap.actionList);
                  this.actionList_2 = this.renderActioonAndTriggerDevice(actionMap.actionList_2);
                  let scene_virtual_button = scenes[i].scene_virtual_button;
                  scene_virtual_button.forEach((item) => {
                    if (!this.virtualIdList[item.device]) {
                      this.virtualIdList[item.device] = parseInt(item.virtual_button_id);
                    }
                  });
                  debugger;
                }
                if(this.templateName == 'RCU Scene New Toggle'){
                  this.actionList = this.renderActioonAndTriggerDevice(actionMap.actionList);
                  let scene_virtual_button = scenes[i].scene_virtual_button;
                  scene_virtual_button.forEach((item) => {
                    if (!this.virtualIdList[item.device]) {
                      this.virtualIdList[item.device] = parseInt(item.virtual_button_id);
                    }
                  });
                }
                if (this.templateName == 'RCU Scene Button') {
                  let scene_virtual_button = scenes[i].scene_virtual_button;
                  scene_virtual_button.forEach((item) => {
                    if (!this.virtualIdList[item.device]) {
                      this.virtualIdList[item.device] = parseInt(item.virtual_button_id);
                    }
                  });
                }
                if (scenes[i].image) {
                  this.sceneImage = 'url(' + scenes[i].image + ')';
                  this.uploadImage = scenes[i].image;
                  $('input[name="banner"]').val(scenes[i].image);
                }
                if (isset(scenes[i].condition)) {
                  try {
                    let condition = JSON.parse(scenes[i].condition);
                    //if mutiway template
                    if (this.templateName == 'Multiway Switch') {
                      this.mutiwayPostConfig = condition;
                      //return;
                    }
                    //this.virtualList = condition;
                    this.conditionsMap = condition;
                    this.timerList = condition.timerList ? condition.timerList : [];
                    if (this.timerList.length) {
                      this.timercommand = this.timerList[0].command;
                    }
                    this.oneOnly = condition.only;
                    //this render the new action and trigger name
                    this.renderActioonAndTriggerDevice();
                  } catch (error) {
                    console.log(error);
                  }
                }
                if (isset(scenes[i].ui_configuration) && scenes[i].scene_template != 'Gateway Scene') {
                  let uiConfiguration = JSON.parse(scenes[i].ui_configuration);
                  this.actionName = uiConfiguration.virtualButtonName;
                  this.isHidden = uiConfiguration.isHidden;
                  this.virtualStatus = uiConfiguration.virtualStatus;
                  if(this.templateName == 'Welcome Scene'){
                    this.deviceStatusList = isset(uiConfiguration.deviceStatusList)?uiConfiguration.deviceStatusList : [] ;
                    this.radarEnterUnmannedModeStatus = isset(uiConfiguration.radarEnterUnmannedModeStatus)?uiConfiguration.radarEnterUnmannedModeStatus:false;
                    this.radarExitUnmannedModeStatus = isset(uiConfiguration.radarExitUnmannedModeStatus)?uiConfiguration.radarExitUnmannedModeStatus:true;
                    //check if radarEnterUnmannedModeStatus,change the radarExitMannedModeStatus
                    debugger
                    if(this.radarEnterUnmannedModeStatus){
                      this.radarExitUnmannedModeStatus = false;//radarExitUnmannedModeStatus
                    }
                  }else if(this.templateName == 'RCU Scene Button'){
                    this.deviceStatusList = isset(uiConfiguration.deviceStatusList)?uiConfiguration.deviceStatusList : [] ;
                  }
                }
                if (isset(scenes[i].ui_configuration) && scenes[i].scene_template == 'Gateway Scene') {
                  let uiConfiguration = JSON.parse(scenes[i].ui_configuration);
                  this.gatewayMapGuid = uiConfiguration.isCheckGateway;
                  this.gatewayTopic = uiConfiguration.gatewayTopic;
                }
                for (let j in this.templateConfig) {
                  if (this.templateConfig[j].name == this.templateName) {
                    this.stepList = this.templateConfig[j].step;
                  }
                }
                if (this.templateName == 'Multiway Switch') {
                  this.index = 1;
                } else if (this.templateName == 'Scene Banner' || this.templateName == 'Room Scene Button') {
                  this.index = 1;
                } else if (this.templateName == 'Gateway Scene') {
                  this.index = 13;
                  this.initGatewayList();
                } else {
                  this.index = 0.5;
                }
                this.activeStepList();
              }
            }
            this.initMutiwayDevices();
            //if subdevice name is scene-gang
          },
          renderActioonAndTriggerDevice(list){
            let newList = cloneDeep(list);
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            if(newList){
              newList.forEach((item)=>{
                subdevices.forEach(kitem=>{
                  if(kitem.name === item.name){
                    item.title = kitem.title;
                    item.profile_room = kitem.profile_room;
                    item.room_name = kitem.room_name
                  }
                })
              })
            }
            return newList
          },
          getVirtualButtonId(guid) {
            //virtual button id is same to the some rcu status
            let sceneDeviceLocationList = [];
            let sceneObj = cloneDeep(erp.info.scene);
            let idList = [];
            for (let i in sceneObj) {
              if (isset(sceneObj[i].scene_virtual_button)) {
                sceneObj[i].scene_virtual_button.forEach((item) => {
                  sceneDeviceLocationList.push(item);
                });
              }
            }
            sceneDeviceLocationList.forEach((kitem) => {
              if (kitem.device == guid) {
                idList.push(parseInt(kitem.virtual_button_id));
              }
            });
            debugger;
            return this.findMissingNumber(idList);
            //how to handle if del the scene
            // let scenes = cloneDeep(erp.info.scene);
            // let virtualIdList = [];
            // for(let i in scenes){
            //   if(isset(scenes[i].ui_configuration) && scenes[i].ui_configuration){
            //     let ui_config = JSON.parse(scenes[i].ui_configuration);
            //     if(isset(ui_config.virtualId)){
            //       //1,2,3,.....
            //       virtualIdList.push(ui_config.virtualId);
            //     }
            //   }
            // }
            // return this.findMissingNumber(virtualIdList);
          },
          getSameVirtualId() {
            //list_1 is first rcu,list_2 is second rcu
            let guid_1 = this.rcuList[0].guid;
            let guid_2 = this.rcuList[1].guid;
            let list_1 = [];
            let list_2 = [];
            let sceneObj = cloneDeep(erp.info.scene);
            for (let i in sceneObj) {
              if (isset(sceneObj[i].scene_virtual_button)) {
                sceneObj[i].scene_virtual_button.forEach((item) => {
                  if (item.device == guid_1) {
                    list_1.push(parseInt(item.virtual_button_id));
                  }
                  if (item.device == guid_2) {
                    list_2.push(parseInt(item.virtual_button_id));
                  }
                });
              }
            }
            let allNumbers = Array.from({ length: 32 }, (_, i) => i + 1);
            const usedNumbers = new Set([...list_1, ...list_2]);
            let missingNumbers = allNumbers.filter((number) => !usedNumbers.has(number));
            debugger;
            console.log('list_1', list_1);
            console.log('list_2', list_2);
            console.log('missingNumbers', missingNumbers);
            return missingNumbers[0];
          },
          changeRadarEnterUnmannedModeStatus() {
            this.radarEnterUnmannedModeStatus = !this.radarEnterUnmannedModeStatus;
            this.radarExitUnmannedModeStatus = false;
          },
          changeRadarExitUnmannedModeStatus() {
            this.radarExitUnmannedModeStatus = !this.radarExitUnmannedModeStatus;
            this.radarEnterUnmannedModeStatus = false;
          },
          async changeVirtualStatus() {
            app.dialog.preloader();
            if (this.oneOnly) {
              app.dialog.close();
              app.dialog.alert(_('Since you have selected to run only once, this option cannot be modified.'));
              return;
            }
            this.virtualStatus = !this.virtualStatus;
            //if click this button,show the virtual button and save in the rcu and in device
            // if(this.virtualStatus){
            //   //get the virtual button id
            //   //first get the trigger device,if radar,can not create the virtual
            //   //pay attention,all devices should append to the rcu virtual button
            //   /*
            //   1.get the rcu virtual button,if main rcu and only choose one
            //   2.post the ble virtual id to the trigger device
            //   3.append to the virtual id ...
            //   */
            //   let thisRcuGuid = '';
            //   if(this.mainRcuGuid){
            //     thisRcuGuid = this.mainRcuGuid
            //   }else{
            //     //check if have rcu connect
            //     for(let i in this.actionBleCommandList){
            //       thisRcuGuid = i;
            //     }
            //   }
            //   if(isset(this.virtualIdList[thisRcuGuid])){
            //     this.virtualIdList[thisRcuGuid] = this.getVirtualButtonId(thisRcuGuid);
            //   }
            //   alert(this.virtualIdList[thisRcuGuid])
            //   //save the virtual in the trigger device
            //   if(this.templateName != 'RCU Radar'){
            //     for(let i in this.trigger){
            //       let mac = core_utils_get_mac_address_from_guid(this.trigger[i].guid, true);
            //       let rcuMac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
            //       let guid = this.trigger[i].guid;
            //       let gang = 1;
            //       if (this.trigger[i].button_group.startsWith('ONOFF GANG')) {
            //         gang = this.trigger[i].button_group.replace('ONOFF GANG', '') * 1;
            //       }
            //       //write the virtual
            //     }
            //   }
            // }
          },
          changeHideDevice() {
            this.hideDevice = !this.hideDevice;
          },
          async buttonAndSetting() {
            // showPick() {
            // this.pickObj.open();
            app.dialog.preloader();
            console.log('overallSceneMap', this.overallSceneMap);
            if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain' || this.templateName == 'RCU Scene New Toggle') {
              let url = encodeURI(`/api/resource/Scene`);
              let method = 'POST';
              if (this.scenePostId) {
                url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                method = 'PUT';
              }
              let scene_virtual_button = [];
              for (let i in this.virtualIdList) {
                if(i){
                  scene_virtual_button.push({
                    device: i,
                    virtual_button_id: this.virtualIdList[i],
                  });
                }
              } 
              const devices = this.overallSceneMap['scene_device_location'];

              const uniqueDevices = devices.filter((device, index, self) => 
                index === self.findIndex((d) => d.device === device.device && d.storage_id === device.storage_id)
              );
              // 
              this.overallSceneMap['scene_device_location'] = uniqueDevices;
              let post_data = {
                title: this.sceneName,
                profile: erp.info.profile.name,
                profile_subdevice: isset(sub_name) && sub_name != 'undefined' ? sub_name : this.subdeviceName,
                scene_template: this.templateName,
                trigger: JSON.stringify(this.overallSceneMap['trigger']),
                action: JSON.stringify(this.overallSceneMap['action']),
                condition: JSON.stringify(this.overallSceneMap['condition']),
                image: this.uploadImage,
                ui_configuration: JSON.stringify(this.overallSceneMap['ui_configuration']),
                scene_device_location: this.overallSceneMap['scene_device_location'],
                scene_virtual_button: scene_virtual_button,
                is_enabled: this.showInHome ? 0 : 1,
              };
              if (this.scenePostId) {
                //delete post_data.scene_device_location;
                delete post_data.scene_virtual_button;
              }
              debugger
              try {
                let postStatus = await http2.request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: post_data,
                });
                console.log('postStatus', postStatus);
                this.scenePostId = postStatus.data.data.name;
                await ha_profile_ready();
                window.globalUpdate = true;
                setTimeout(() => {
                  mainView.router.back();
                  app.dialog.close();
                }, 1500);
                return;
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(error);
              }
            }
            debugger;
            //save the virtual button and the hide setting
            if (this.oneOnly) {
              let postStatus = true;
              let actualActionList = this.strucActionList(this.actionList);
              let actionCommandList = this.postActionBle(actualActionList);
              for (let i in actionCommandList) {
                let guid = i;
                let mac = core_utils_get_mac_address_from_guid(i, true);
                let typeIndex = '1f';
                let ref = '00';
                let opcode = '00';
                let gang = this.actionLocation[i];
                let virtualGang = this.virtualIdList[i] ? this.virtualIdList[i] : this.getVirtualButtonId(i);
                if (!this.virtualIdList[i]) {
                  this.virtualIdList[i] = virtualGang;
                }
                let pre_command = `8F2000${parseInt(gang).toString(16).pad('00')}${parseInt(gang).toString(16).pad('00')}`;
                let $thisCommand = `${opcode}${typeIndex}${mac}00${ref}13${parseInt(virtualGang).toString(16).pad('00')}`;
                $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                let totalCommand = `${pre_command}${$thisCommand}`;
                //add the toggle virtual button command
                let addActionCommand = this.actionMap[i];
                let $command = `972103${virtualGang.toString(16).pad('00')}${'01'}`;
                let newActionCommand = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                addActionCommand = `${addActionCommand}${newActionCommand}`;
                this.actionMap[i] = addActionCommand;
                rcuIndex++;
                if (isset(this.actionMap['trigger'])) {
                  this.actionMap['trigger'] = {};
                  this.actionMap['trigger'][`${i}`] = totalCommand;
                } else {
                  this.actionMap['trigger'][`${i}`] = totalCommand;
                }
                //post to the ble
                try {
                  await window.peripheral[i].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: totalCommand,
                    },
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: addActionCommand,
                    },
                  ]);
                } catch (error) {
                  postBleStatus = false;
                  app.dialog.close();
                  app.dialog.confirm(
                    `${_('Connection failed,reconnect?')}`,
                    async () => {
                      if (window.peripheral[i].prop.connected) {
                        await peripheral[i].disconnect();
                        this.buttonAndSetting();
                      } else {
                        this.buttonAndSetting();
                      }
                    },
                    () => {}
                  );
                }
              }
              if (postStatus) {
                let url = `/api/resource/Scene/${this.scenePostId}`;
                let method = 'PUT';
                try {
                  let postStatus = await http.request(url, {
                    method: method,
                    serializer: 'json',
                    responseType: 'json',
                    debug: true,
                    data: {
                      action: JSON.stringify(this.actionMap),
                    },
                  });
                } catch (error) {
                  app.dialog.close();
                  app.dialog.alert(error);
                }
              }
            }
            //post the data to the erp
            try {
              if (this.virtualStatus) {
                if (this.actionName == '' || !this.actionName) {
                  app.dialog.close();
                  app.dialog.alert(_('Please enter the virtual button name.'));
                  return;
                }
                let devices = cloneDeep(erp.info.device);
                let deviceObj = devices[this.actionGuid];
                let subUrl = `/api/resource/Profile Subdevice`;
                let subMethod = 'POST';
                if (this.scenePostId) {
                  let config = parseInt(this.actionId);
                  let this_sub_name = '';
                  let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                  if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                    for (let i in this.virtualIdList) {
                      let post_sub_name = '';
                      profile_subdevices.forEach((item) => {
                        if (
                          item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1' &&
                          item.device == i &&
                          item.config &&
                          parseInt(item.config) == this.virtualIdList[i]
                        ) {
                          post_sub_name = item.name;
                        }
                      });
                      let this_url = `/api/resource/Profile Subdevice`;
                      let this_method = 'POST';
                      if (post_sub_name) {
                        this_url = `/api/resource/Profile Subdevice/${post_sub_name}`;
                        this_method = 'PUT';
                      }
                      let profile_device_id = '';
                      let profile_devices = cloneDeep(erp.info.profile.profile_device);
                      profile_devices.forEach((item) => {
                        if (item.device == i) {
                          profile_device_id = item.name;
                        }
                      });
                      let this_data = {
                        parenttype: 'Profile',
                        parent: erp.info.profile.name,
                        parentfield: 'profile_subdevice',
                        profile_room: erp.info.profile.profile_room[0].name,
                        profile_device: profile_device_id,
                        device: i,
                        title: this.actionName,
                        device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                        device_mode: deviceObj.device_mode,
                        config: `${this.virtualIdList[i]}`,
                        hidden: this.hideDevice ? 1 : 0,
                      };
                      try {
                        await http.request(encodeURI(subUrl), {
                          method: this_method,
                          serializer: 'json',
                          responseType: 'json',
                          data: this_data,
                          debug: true,
                        });
                      } catch (error) {
                        app.dialog.close();
                        app.dialog.alert(error);
                      }
                    }
                  } else {
                    profile_subdevices.forEach((item) => {
                      if (
                        item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1' &&
                        item.device == this.actionGuid &&
                        item.config &&
                        parseInt(item.config) == config
                      ) {
                        this_sub_name = item.name;
                      }
                    });
                    if (this_sub_name) {
                      subUrl = `/api/resource/Profile Subdevice/${this_sub_name}`;
                      subMethod = 'PUT';
                    }
                    let profile_devices = cloneDeep(erp.info.profile.profile_device);
                    profile_devices.forEach((item) => {
                      if (item.device == this.actionGuid) {
                        this.profileDeviceName = item.name;
                      }
                    });
                    let post_data = {
                      parenttype: 'Profile',
                      parent: erp.info.profile.name,
                      parentfield: 'profile_subdevice',
                      profile_room: erp.info.profile.profile_room[0].name,
                      profile_device: this.profileDeviceName,
                      device: this.actionGuid,
                      title: this.actionName,
                      device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                      device_mode: deviceObj.device_mode,
                      config: `${this.actionMap.actionId}`,
                      hidden: this.hideDevice ? 1 : 0,
                    };
                    debugger;
                    try {
                      await http.request(encodeURI(subUrl), {
                        method: subMethod,
                        serializer: 'json',
                        responseType: 'json',
                        data: post_data,
                        debug: true,
                      });
                    } catch (error) {
                      app.dialog.close();
                      app.dialog.alert(error);
                    }
                  }
                }
                // for (let j in this.actionLocation) {
                //   if (j !== this.actionGuid) {
                //     let post_device_name = '';
                //     profile_devices.forEach((item) => {
                //       if (item.device == j) {
                //         post_device_name = item.name;
                //       }
                //     });
                //     let post_data = {
                //       parenttype: 'Profile',
                //       parent: erp.info.profile.name,
                //       parentfield: 'profile_subdevice',
                //       profile_room: erp.info.profile.profile_room[0].name,
                //       profile_device: post_device_name,
                //       device: j,
                //       title: this.actionName,
                //       device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                //       device_mode: deviceObj.device_mode,
                //       config: `${this.actionId}`,
                //       hidden: this.hideDevice ? 1 : 0,
                //     };
                //     await http.request(encodeURI(`/api/resource/Profile Subdevice`), {
                //       method: 'POST',
                //       serializer: 'json',
                //       responseType: 'json',
                //       data: post_data,
                //       debug: true,
                //     });
                //   }
                // }
                debugger;
                //post to the scene
                let ui_url = `/api/resource/Scene/${this.scenePostId}`;
                let ui_method = 'PUT';
                try {
                  let postStatus = await http.request(ui_url, {
                    method: ui_method,
                    serializer: 'json',
                    responseType: 'json',
                    debug: true,
                    data: {
                      ui_configuration: JSON.stringify({
                        virtualButtonName: this.actionName,
                        isHidden: this.hideDevice,
                        virtualStatus: this.virtualStatus,
                      }),
                      is_enabled: this.showInHome ? 0 : 1,
                    },
                  });
                  await ha_profile_ready();
                  setTimeout(() => {
                    mainView.router.back();
                    app.dialog.close();
                  }, 1500);
                } catch (error) {
                  app.dialog.close();
                  app.dialog.alert(error);
                }
              } else {
                let scene_virtual_button = [];
                for (let i in this.virtualIdList) {
                  scene_virtual_button.push({
                    device: i,
                    virtual_button_id: this.virtualIdList[i],
                  });
                }
                let ui_url = `/api/resource/Scene/${this.scenePostId}`;
                let ui_method = 'PUT';
                let post_data = {
                  is_enabled: this.showInHome ? 0 : 1,
                  scene_virtual_button: scene_virtual_button,
                }
                if(this.templateName == 'Welcome Scene' || this.templateName == 'RCU Scene Button'){
                  post_data['ui_configuration'] = JSON.stringify(this.overallSceneMap['ui_configuration'])
                }
                try {
                  let postStatus = await http.request(ui_url, {
                    method: ui_method,
                    serializer: 'json',
                    responseType: 'json',
                    debug: true,
                    data: post_data,
                  });
                  await ha_profile_ready();
                  window.globalUpdate = true;
                  mainView.router.back();
                  app.dialog.close();
                } catch (error) {
                  app.dialog.close();
                  app.dialog.alert(error);
                }
              }
            } catch (error) {
              console.log(error);
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          checkIsAnyRcu(actionCommandList){
            let isCheckAnyRcu = true;
            let chooseRcuList = [];
            for (let i in actionCommandList) {
              let device_model = erp.info.device[i].device_model;
              if (device_model == 'YO780') {
                chooseRcuList.push(i);
              }
            }  
            if (chooseRcuList.length < 2) {
              isCheckAnyRcu = false;
              this.subscribeMacadrress = '';
            }
            return isCheckAnyRcu;
          },
          //this is the save RCU scene toggle logic
          async saveRcuTrigger() {
            return new Promise(async (resolve, reject) => {
              //type is control the virtual button on/off,1 on,0 off
              if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                //save the RCU trigger
                let actualActionList = this.strucActionList(this.actionList);
                let actionCommandList = this.postActionBle(actualActionList);
                let postBleStatus = true;
                let errorLog = '';
                let mainRcuId = '';
                let rcuIndex = 0;
                
                for (let i in actionCommandList) {
                  //composition the rcu trigger command
                  debugger;
                  // if(i != this.actionGuid){
                  //   continue;
                  // }
                  let type = 1;
                  if (this.mutiwayStatus == 2) {
                    type = 0;
                  }
                  let guid = i;
                  let mac = core_utils_get_mac_address_from_guid(i, true);
                  let typeIndex = '1f';
                  let ref = parseInt(type).toString(16).pad('00');
                  let opcode = '00';
                  let gang = this.actionLocation[i];
                  // alert(i)
                  // alert(gang);
                  let virtualGang = '';
                  if (this.checkIsAnyRcu(actionCommandList)) {
                    virtualGang = this.virtualIdList[i] ? this.virtualIdList[i] : this.getSameVirtualId();
                  } else {
                    virtualGang = this.virtualIdList[i] ? this.virtualIdList[i] : this.getVirtualButtonId(i);
                  }
                  //alert(virtualGang);
                  debugger;
                  if (!this.virtualIdList[i]) {
                    this.virtualIdList[i] = virtualGang;
                  }
                  // if(rcuIndex == 0){
                  //   mainRcuId = gang
                  // }
                  //alert(virtualGang);
                  let pre_command = `8F2000${parseInt(gang).toString(16).pad('00')}${parseInt(gang).toString(16).pad('00')}`;
                  let $thisCommand = `${opcode}${typeIndex}${mac}00${ref}13${parseInt(virtualGang).toString(16).pad('00')}`;
                  $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                  let totalCommand = `${pre_command}${$thisCommand}`;
                  console.log('$thisCommand', $thisCommand);
                  rcuIndex++;
                  if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                    if (!isset(this.overallSceneMap['action'][i])) {
                      this.overallSceneMap['action'][i] = {};
                    }
                    this.overallSceneMap['action'][i]['trigger'] = totalCommand;
                  }
                  //this tindy the restore status command
                  let restoreStatusCommand = '';
                  if(this.templateName == 'RCU Scene Toggle - Save Status'){
                    //check the action list 
                    for(let j in actualActionList){
                      let command = ``;
                      let this_list = actualActionList[j].list;
                      for(let k in this_list){
                        let device_button_group = this_list[k].device_button_group;
                        if(device_button_group.startsWith('RCU ONOFF GANG')){
                          //find the gangs
                          let solt = this_list[k].config;
                          let gang = device_button_group.replace('RCU ONOFF GANG','')*1;
                          let target_gang = gang%4;
                          if(target_gang == 0){
                            target_gang = 4;
                          }
                          let _command = `971f${solt}${parseInt(target_gang).toString(16).pad('00')}`;
                          command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                        }else if(device_button_group.startsWith('RCU DIMMING')){
                          //find the gangs
                          let solt = this_list[k].config;
                          let gang = device_button_group.replace('RCU DIMMING','')*1;
                          let target_gang = gang%2;
                          if(target_gang == 0){
                            target_gang = 2;
                          }
                          let _command = `971f${solt}${parseInt(target_gang).toString(16).pad('00')}`;
                          command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                        }else if(device_button_group.startsWith('RCU OUTPUT')){
                          let target_gang = device_button_group.replace('RCU OUTPUT','')*1;
                          let _command = `972101${target_gang.toString(16).pad('00')}`;
                          command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                        }else if(device_button_group.startsWith('SCENE VIRTUAL ONOFF GANG')){
                          let target_gang = this_list[j].config;
                          let _command = `972103${target_gang.toString(16).pad('00')}`;
                          command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                        }else if(isset(this_list[k].scene_virtual_button)){
                          let virtualId = this_list[k].virtualId;
                          let _command = `972103${parseInt(virtualId).toString(16).pad('00')}`;
                          command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                        }
                      }
                      restoreStatusCommand = `8f1302${(parseInt(virtualGang)+2).toString(16).pad('00')}${command}` ;
                    }
                  }
                  //post to the ble
                  try {
                    await window.peripheral[i].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: totalCommand,
                      },
                    ]);
                    //alert(restoreStatusCommand);
                    if(restoreStatusCommand){
                      await window.peripheral[i].write([
                        {
                          service: 'ff80',
                          characteristic: 'ff81',
                          data: restoreStatusCommand,
                        },
                      ]);
                    }
                  } catch (error) {
                    postBleStatus = false;
                    errorLog = error;
                  }
                }
                this.rcuTempList = actualActionList;
                if (postBleStatus) {
                  resolve(1);
                } else {
                  reject(errorLog);
                }
              } else {
                resolve(1);
              }
            });
          },
          //create a toggle scene action
          createVirtualAction(type) {
            return new Promise(async (resolve, reject) => {
              if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                let gang = this.actionLocation[this.actionGuid];
                debugger;
                let sceneId = this.getDeviceBleId(this.actionGuid);
                let mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                let this_data = `972103${gang.toString(16).pad('00')}02`;
                let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                let actioncommand_pre = `8F1000${parseInt(sceneId).toString(16).pad('00')}`;
                let totalActionCommand = `${actioncommand_pre}${($command.length / 2).toString(16).pad('00')}${$command}`;
                console.log('totalActionCommand', totalActionCommand);
                this.triggerActionId = sceneId;
                debugger;
                try {
                  await window.peripheral[this.actionGuid].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: totalActionCommand,
                    },
                  ]);
                  this.scenePostMap_1['action']['virtualAction'] = totalActionCommand;
                  resolve(1);
                } catch (error) {
                  reject(error);
                }
              } else {
                resolve(1);
              }
            });
          },
          //simulate the post scene data.in order to case the scene id repeat
          simulateScenePostId(guid, id) {
            debugger;
            let sceneDeviceLocationList = [];
            let sceneObj = cloneDeep(erp.info.scene);
            let key = new Date().getTime();
            sceneObj[`${key}`] = {
              'scene_device_location': [],
              'is_enabled': 0,
            };
            sceneObj[`${key}`]['scene_device_location'].push({
              device: guid,
              storage_id: id,
            });
            erp.info.scene = sceneObj;
          },
          getSceneIdByApi(guid) {
            return new Promise(async (resolve, reject) => {
              try {
                let url = `/api/method/appv6.getSceneId?guid=${guid}`;
                let res = await http2.request(encodeURI(url), {
                  method: 'GET',
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                });
                let id = res.data.data ? parseInt(res.data.data.storage_id) + 1 : 2;
                resolve(id);
              } catch (error) {
                reject(id);
              }
            });
          },
          checkIsRcu(guid){
            let devices = cloneDeep(erp.info.device);
            if(isset(devices[guid]) && devices[guid].device_model == 'YO780'){
              return true;
            }else{
              return false;
            }
          },
          saveWelcomeMode(){
            app.dialog.preloader();
            let list = cloneDeep(this.deviceStatusList);
            //tindy the same guid device
            return new Promise(async (resolve, reject) => {
              let statusList = this.strucActionList(list);
              
              for(let i in statusList){
                let command = ``;
                let this_list = statusList[i].list;
                for(let j in this_list){
                  let device_button_group = this_list[j].device_button_group;
                  if(device_button_group.startsWith('RCU ONOFF GANG')){
                    //find the gangs
                    let solt = this_list[j].config;
                    let gang = device_button_group.replace('RCU ONOFF GANG','')*1;
                    let target_gang = gang%4;
                    if(target_gang == 0){
                      target_gang = 4;
                    }
                    let _command = `971f${solt}${parseInt(target_gang).toString(16).pad('00')}`;
                    command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                  }else if(device_button_group.startsWith('RCU DIMMING')){
                    //find the gangs
                    let solt = this_list[j].config;
                    let gang = device_button_group.replace('RCU DIMMING','')*1;
                    let target_gang = gang%2;
                    if(target_gang == 0){
                      target_gang = 2;
                    }
                    let _command = `971f${solt}${parseInt(target_gang).toString(16).pad('00')}`;
                    command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                  }else if(device_button_group.startsWith('RCU OUTPUT')){
                    let target_gang = device_button_group.replace('RCU OUTPUT','')*1;
                    let _command = `972101${parseInt(target_gang).toString(16).pad('00')}`;
                    command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                  }else if(device_button_group.startsWith('SCENE VIRTUAL ONOFF GANG')){
                    let target_gang = this_list[j].config;
                    let _command = `972103${target_gang.toString(16).pad('00')}`;
                    command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                  }else if(device_button_group.startsWith('OPENCLOSE WIFI UART') || device_button_group.startsWith('OPENCLOSE UART')){
                    command += `028900`;
                  }else if(device_button_group.startsWith('Thermostat')){
                    command += `029403029404029405029406`;
                  }else if(device_button_group.startsWith('Hdmicec')){
                    command += `0a972102016b6120312030`;
                  }
                }
                statusList[i].command = command;
              }
              //select all the scene and save the scene command
              for(let i in statusList){
                if(this.checkIsRcu(i)){
                  let scenes = cloneDeep(erp.info.scene);
                  let virtual_button_list = [];
                  // 
                  const sortedScenes = Object.values(scenes)
                    .sort((a, b) => {
                      const aIsToggle = a.scene_template === "RCU Scene Toggle" || a.scene_template === "RCU Scene Toggle - Save Status" || a.scene_template === "RCU Scene New Toggle";
                      const bIsToggle = b.scene_template === "RCU Scene Toggle" || b.scene_template === "RCU Scene Toggle - Save Status" || b.scene_template === "RCU Scene New Toggle";
                      
                      const aHasMaster = !(isset(a.title) && a.title.toLowerCase().includes("master"));
                      const bHasMaster = !(isset(b.title) && b.title.toLowerCase().includes("master"));

                      // masterToggle
                      if (aIsToggle && aHasMaster && !(bIsToggle && bHasMaster)) return -1;
                      if (bIsToggle && bHasMaster && !(aIsToggle && aHasMaster)) return 1;
                      
                      // masterToggle
                      if (aIsToggle && !bIsToggle) return -1;
                      if (bIsToggle && !aIsToggle) return 1;
                      
                      return 0; // 
                    });
                    // 
                    debugger
                    for (const scene of sortedScenes) {
                      const scene_virtual_button = scene.scene_virtual_button || [];
                      for (const button of scene_virtual_button) {
                        if (button.device == i) {
                          virtual_button_list.push(
                            parseInt(button.virtual_button_id)
                              .toString(16)
                              .pad('00') // 16
                          );
                        }
                      }
                    }
                  if(virtual_button_list.length){
                    const scene_command = `8f130101${
                      virtual_button_list.map(vb => `04972103${vb}`).join('')
                    }`;
                    statusList[i].scene_command = scene_command;
                  }
                }
              }
              console.log("statusList",statusList)
              let postStatus = true
              for(let i in statusList){
                let command = statusList[i].command;
                let scene_command = statusList[i].scene_command;
                let ble_command = `8F13${'01'}${'01'}${command}`;
                if(this.checkIsRcu(i)){
                  ble_command = `8F13${'02'}${'02'}${command}`;
                }
                console.log('ble_command', ble_command);
                let ble_list = [];
                ble_list.push({
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: ble_command,
                })
                if(scene_command){
                  ble_list.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: scene_command,
                  })
                }
                try {
                  await window.peripheral[i].write(ble_list);
                  await window.peripheral[i].disconnect();
                } catch (error) {
                  postStatus = false;
                }
              }
              if(postStatus){
                if(isset(this.overallSceneMap['ui_configuration'])){
                  this.overallSceneMap['ui_configuration']['deviceStatusList'] = this.deviceStatusList;
                }else{
                  this.overallSceneMap['ui_configuration'] = {}
                  this.overallSceneMap['ui_configuration']['deviceStatusList'] = this.deviceStatusList;
                }
                app.dialog.close();
                resolve(1)
              }else{
                app.dialog.close();
                app.dialog.confirm(`${_('Save failed, please try again.')}`,()=>{
                  // this.saveWelcomeMode();
                  resolve(1)
                },()=>{})
              }
            });
          },
          async saveActionInRcu() {
            let list = this.actionList;
            // if(this.mutiwayStatus == 2){
            //   list = this.actionList_2;
            // }
            // if (!this.actionName) {
            //   app.dialog.alert(`${tran('Please input the action name.')}`);
            //   return;
            // }
            let virtual_button_check = $(`input[name="virtual_button"]:checked`).val();
            app.dialog.preloader();
            let timer = setTimeout(() => {
              app.dialog.close();
            }, 10000);
            // let sceneObj = erp.info.scene;
            // let sceneId = this.actionId ? this.actionId : this.getDeviceBleId(idList);
            // this.actionId = sceneId;
            try {
              if(this.templateName == 'RCU Scene New Toggle'){
                await this.saveActionForNewToggle();
                app.dialog.close();
                this.index = 3;
                return; 
              }else{
                await this.saveActionOnBle();
                await this.saveRcuTrigger(1);
                //await this.createVirtualAction()
                this.actionMap.actionList = this.actionList;
                this.actionMap.actionId = this.actionId;
                this.actionMap.title = this.actionName;
                this.actionMap.isVirtual = isset(virtual_button_check) ? true : false;
                if (isset(virtual_button_check)) {
                  await this.addSubdeviceInErp(sceneId);
                }
              }
              if (timer) {
                clearTimeout(timer);
              }
              if ((this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') && this.mutiwayStatus == 1) {
                this.index = 7;
                this.mutiwayStatus = 2;
              } else if (this.templateName == 'RCU Curtain') {
                if (this.mutiwayStatus == 2) {
                  this.index = 3;
                } else {
                  this.mutiwayStatus = 2;
                  //change the action list
                  let thisList = cloneDeep(this.actionList);
                  //change the led status

                  //change the ref to the pause
                  thisList.forEach((kitem) => {
                    //check if have the virtual button id is on,change the status
                    if (kitem.device_mode == 'RCU Controller' && isset(kitem.virtualId) && kitem.ref == 1) {
                      kitem.ref = 0;
                    }
                    if (kitem.device_model == 'YO121-AC-R2W') {
                      let command = `02${core_utils_get_mac_address_from_guid(kitem.device, true)}8930`;
                      kitem.action_command = command;
                    } else {
                      let command = `02${core_utils_get_mac_address_from_guid(kitem.device, true)}860255AA050101036DDC`;
                      kitem.action_command = command;
                    }
                  });
                  this.actionList_2 = thisList;
                  this.saveActionInRcu();
                }
              } else {
                this.index = 3;
              }
              if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                this.scrollItem(110);
                app.dialog.close();
                return;
              } else if (this.templateName == 'RCU Curtain') {
                //run again
                if (this.mutiwayStatus == 2) {
                  this.scrollItem(110);
                  app.dialog.close();
                  return;
                }
              } else {
                let url = ``;
                let method = 'POST';
                if (this.scenePostId) {
                  url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                  method = 'PUT';
                } else {
                  url = encodeURI(`/api/resource/Scene`);
                }
                let scene_device_location = [];
                for (let i in this.actionLocation) {
                  scene_device_location.push({
                    device: i,
                    storage_id: this.actionLocation[i],
                  });
                }
                let ui_configuration = {};
                if (this.templateName == 'Gateway Scene') {
                  ui_configuration = {
                    isCheckGateway: this.gatewayMapGuid,
                    gatewayTopic: this.gatewayTopic,
                  };
                }
                let post_data = {
                  title: this.sceneName,
                  profile: erp.info.profile.name,
                  profile_subdevice: isset(sub_name) && sub_name != 'undefined' ? sub_name : this.subdeviceName,
                  scene_template: this.templateName,
                  trigger: JSON.stringify(this.trigger),
                  action: JSON.stringify(this.actionMap),
                  condition: JSON.stringify(isset(this.conditionsMap) ? this.conditionsMap : {}),
                  image: this.uploadImage,
                  ui_configuration: JSON.stringify(ui_configuration),
                  scene_device_location: scene_device_location,
                };
                if (this.scenePostId) {
                  delete post_data.scene_device_location;
                }
                let postStatus = await http.request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: post_data,
                });
                console.log('postStatus', postStatus);
                if (isset(postStatus.data.data.name)) {
                  this.scenePostId = postStatus.data.data.name;
                  this.sceneDeviceLocation = postStatus.data.data.scene_device_location;
                }
                this.index = 3;
                app.dialog.close();
                this.scrollItem(110);
              }
            } catch (error) {
              console.log(error);
              this.index = 2;
              if (error == 6007) {
                //try to disconnect and the connect the rcu data
                app.dialog.confirm(
                  `${_('Connection experienced some issues, would you like to retry connecting?')}`,
                  async () => {
                    for (let i in this.rcuList) {
                      let guid = this.rcuList[i].guid;
                      if (window.peripheral[guid].prop.connected) {
                        await window.peripheral[guid].disconnect();
                      }
                    }
                    this.saveActionInRcu();
                  },
                  () => {}
                );
              } else {
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            }
          },
          async saveTriggerOnErp(list) {
            return new Promise(async (resolve, reject) => {
              // list.forEach(item=>{
              //   this.sceneDeviceLocation.push(item)
              // })
              this.trigger.forEach((item) => {
                delete item.isBle;
              });
              this.sceneDeviceLocation = this.mergeAndDeduplicateByProperties(this.sceneDeviceLocation, list, 'device', 'storage_id');
              console.log('this.sceneDeviceLocation', this.sceneDeviceLocation);
              //filter the condotion
              let conditionList = [];
              // this.virtualList.forEach((item) => {
              //   if (item.display) {
              //     conditionList.push(item);
              //   }
              // });
              let conditionMap = {};
              conditionMap['timerList'] = this.timerList;
              conditionMap['only'] = this.oneOnly;
              let post_data = {
                trigger: JSON.stringify(this.trigger),
                condition: JSON.stringify(conditionMap),
                scene_device_location: this.sceneDeviceLocation,
              };

              if (list.length == 0) {
                delete post_data.scene_device_location;
              }
              let url = `/api/resource/Scene/${this.scenePostId}`;
              let method = 'PUT';
              try {
                let postStatus = await http.request(url, {
                  method: method,
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: post_data,
                });
                resolve();
              } catch (error) {
                console.log(error);
                reject(error);
                //app.dialog.alert(error)
              }
            });
          },
          mergeAndDeduplicateByProperties(array1, array2, prop1, prop2) {
            let map = new Map();
            let mergedArray = [...array1, ...array2];
            mergedArray.forEach((item) => {
              if (item[prop1] && item[prop2]) {
                const key = `${item[prop1]}-${item[prop2]}`;
                if (!map.has(key)) {
                  map.set(key, item);
                } else {
                  // 
                  let existingItem = map.get(key);
                  if (existingItem[prop1] === item[prop1] && existingItem[prop2] === item[prop2]) {
                    // 
                    map.set(key, item);
                  }
                }
              }
            });
            let deduplicatedArray = Array.from(map.values());
            return deduplicatedArray;
          },
          loadingDeviceConnect(guid, button_group) {
            console.log('dom', $(`.manufacturing-steps[guid="${guid}"][button_group="${button_group}"]`).find('.item-after i'));
            $(`.manufacturing-steps[guid="${guid}"][button_group="${button_group}"]`).find('.item-after i').addClass('text-color-green');
            $(`.manufacturing-steps[guid="${guid}"][button_group="${button_group}"]`).find('.item-after i').html('check_circle');
          },
          initActionSheet() {
            let sheetItem = ``;
            this.rcuList.forEach((item, index) => {
              if (!item.ischeck) {
                return;
              }
              sheetItem += `
              <li class="manufacturing-steps scenes-item-step-${index + 1}" guid="${item.guid}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">RCU${index + 1}: ${item.mac_address}
                      </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>
              `;
            });
            let sheetContent = /*html*/ `
            <div class="sheet-modal" style="height:auto">
            	<div class="sheet-modal-inner">
            		<div class="swipe-handler"></div>
            		<div class="page-content">
            			<div class="list list-strong list-outline list-dividers-ios">
            				<ul>
                      ${sheetItem}
            				</ul>
            			</div>
            			<div class="block scene-retry device-hidden" style="text-align:center;padding-left:15px;padding-right:15px;">
            				<div class="button button-fill button-save" style="padding:15px;" v-on:click="nextStep(1)">${_('Retry')}</div>
            			</div>
            		</div>
            	</div>
            </div>
            `;
            if (isset(this.$actionSheetMap)) {
              this.$actionSheetMap.open();
              return;
            }
            this.$actionSheetMap = app.sheet.create({
              content: `${sheetContent}`,
              on: {
                closed: function () {},
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.$actionSheetMap.open();
          },
          //show the trigger connecting UI
          initSheetTriggerContent() {
            let sheetItem = ``;
            this.trigger.forEach((item, index) => {
              if (isset(item.isHidden)) {
                return;
              }
              sheetItem += `
              <li class="manufacturing-steps scenes-item-step-${index + 1}" guid="${item.guid}" button_group="${item.button_group}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">${index + 1}: ${item.title}
                      <span class="text-muted" style="font-size:12px;">(${tran(item.room_title)}/${item.mac_address})</span>
                      </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>
              `;
            });
            let sheetContent = /*html*/ `
            <div class="sheet-modal" style="height:auto">
            	<div class="sheet-modal-inner">
            		<div class="swipe-handler"></div>
            		<div class="page-content">
            			<div class="list list-strong list-outline list-dividers-ios">
            				<ul>
                      ${sheetItem}
            				</ul>
            			</div>
            			<div class="block scene-retry device-hidden" style="text-align:center;padding-left:15px;padding-right:15px;">
            				<div class="button button-fill button-save" style="padding:15px;" v-on:click="nextStep(1)">${_('Retry')}</div>
            			</div>
            		</div>
            	</div>
            </div>
            `;
            if (isset(this.$sheetMap)) {
              this.$sheetMap.open();
              return;
            }
            this.$sheetMap = app.sheet.create({
              content: `${sheetContent}`,
              on: {
                closed: function () {},
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.$sheetMap.open();
          },
          scrollItem(num) {
            const scrollContainer = document.querySelector('.scene-toolbar-inner');
            scrollContainer.scrollBy({
              top: 0,
              left: num,
              behavior: 'instant',
            });
          },
          async saveErrorTriggerOnble(list) {},
          processInstruction(originalStr) {
            // 
            const header = originalStr.slice(0, 8);

            // 
            const segments = [];
            let remaining = originalStr.slice(8);
            while (remaining.length > 0) {
              const prefix = remaining.slice(0, 4); // 0cXX
              const mac = remaining.slice(4, 16);
              const cmdEnd = remaining.indexOf('0c', 4) > 0 ? remaining.indexOf('0c', 4) : remaining.length;
              const command = remaining.slice(16, cmdEnd);

              segments.push({
                type: prefix.slice(2, 4),
                mac: mac,
                command: command,
              });

              remaining = remaining.slice(cmdEnd);
            }

            // MAC
            const macGroups = segments.reduce((acc, cur) => {
              acc[cur.mac] = acc[cur.mac] || [];
              acc[cur.mac].push({
                type: cur.type,
                command: cur.command,
              });
              return acc;
            }, {});

            // 
            let result = header;
            for (const [mac, commands] of Object.entries(macGroups)) {
              let controlPart = '';
              commands.forEach((cmd) => {
                const cmdLength = (cmd.command.length / 2).toString(16).padStart(2, '0');
                controlPart += cmdLength + cmd.command;
              });

              const totalLength = (
                1 + // type
                6 + // MAC
                1 + // 13
                controlPart.length / 2
              ) // 
                .toString(16)
                .padStart(2, '0');

              result +=
                totalLength + // 
                commands[0].type + // 
                mac + // MAC
                '13' + // 
                controlPart; // 
            }

            return result;
          },
          async saveTriggerOnble() {
            //app.dialog.preloader();
            let sceneObj = erp.info.scene;
            let sceneDeviceLocationList = [];
            let postStatus = true;
            //get exist scene id
            for (let i in sceneObj) {
              sceneObj[i].scene_device_location.forEach((item) => {
                sceneDeviceLocationList.push(item);
              });
            }
            let postIdList = [];
            if (this.templateName == 'RCU Radar' || this.templateName == 'Welcome Scene') {
              app.dialog.preloader();
              //handle any rcu
              let rcuGuid = '';
              for (let i in this.actionBleCommandList) {
                //should be know whats rcu input
                let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                subdevices.forEach((item) => {
                  if (item.name == sub_name) {
                    rcuGuid = item.device;
                  }
                });
              }
              if (!rcuGuid) {
                app.dialog.close();
                app.dialog.alert(_('Unable to identify RCU input port.'));
                return;
              }
              let guid = rcuGuid;
              let this_mac = core_utils_get_mac_address_from_guid(rcuGuid, true);
              let this_sceneId = this.actionLocation[rcuGuid];
              let last_command = ``;
              if (this.timercommand.length) {
                last_command = `${this.radarNewCommand(parseInt(this_sceneId).toString(16).pad('00'), parseInt(this_sceneId).toString(16).pad('00'))}${(
                  this.timercommand.length / 2
                )
                  .toString(16)
                  .pad('00')}${this.timercommand}`;
              } else {
                last_command = `${this.radarNewCommand(parseInt(this_sceneId).toString(16).pad('00'), parseInt(this_sceneId).toString(16).pad('00'))}`;
              }
              debugger;
              this.trigger[0].triggercommand = last_command;
              let bleList = [
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: last_command,
                },
              ];
              try {
                await window.peripheral[guid].write(bleList);
                await window.peripheral[guid].disconnect();
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            } else {
              this.initSheetTriggerContent();
              let checkIndex = 0;
              let errorTriggerList = [];
              for (let i in this.trigger) {
                let mac = core_utils_get_mac_address_from_guid(this.trigger[i].guid, true);
                let rcuMac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                let guid = this.trigger[i].guid;
                let idList = [];
                sceneDeviceLocationList.forEach((kitem) => {
                  if (kitem.device == this.trigger[i].guid) {
                    idList.push(parseInt(kitem.storage_id));
                  }
                });
                let gang = 1;
                if (this.trigger[i].button_group.startsWith('ONOFF GANG')) {
                  gang = this.trigger[i].button_group.replace('ONOFF GANG', '') * 1;
                  if (this.trigger[i].model == 'YO780-Scene-4G') {
                    if (gang == 2) {
                      gang = 3;
                    }
                    if (gang == 3) {
                      gang = 4;
                    }
                    if (gang == 4) {
                      gang = 6;
                    }
                  }
                }
                let sceneId = isset(this.trigger[i].triggerId) ? this.trigger[i].triggerId : this.getDeviceBleId(this.trigger[i].guid);
                let sceneId_2 =
                  isset(this.trigger[i].triggerId_2) && this.trigger[i].triggerId_2
                    ? this.trigger[i].triggerId_2
                    : await this.getSceneIdByApi(this.trigger[i].guid);
                let sceneId_3 =
                  isset(this.trigger[i].triggerId_3) && this.trigger[i].triggerId_3
                    ? this.trigger[i].triggerId_3
                    : parseInt(await this.getSceneIdByApi(this.trigger[i].guid)) + 1;
                //check if have the same scene id
                if(sceneId_2 == sceneId){
                  //means the first time 
                  sceneId_2 = sceneId+1;
                  sceneId_3 = sceneId+2;
                }
                // alert(sceneId)
                // alert(sceneId_2)
                // alert(sceneId_3)
                //if have same trigger
                // if (!isset(this.trigger[i].triggerId) && i > 0 && this.trigger[i].guid == this.trigger[i - 1].guid) {
                //   sceneId = parseInt(sceneId) + 1;
                //   //must be add the actionId,get the rcuActionId
                //   this.trigger[i].isExtra = true;
                //   debugger
                // }
                //check if have the led status action
                let changeLedStatus_1 = false;
                let ledActionCommand_1 = '';
                let changeLedStatus_2 = false;
                let ledActionCommand_2 = '';
                debugger;
                this.actionList.forEach((actionItem) => {
                  if (actionItem.device_mode == 'RCU Controller' && actionItem.device_button_group == 'ONOFF GANG1') {
                    changeLedStatus_1 = true;
                    let virtualId = actionItem.virtualId;
                    let virtualIdType = actionItem.virtualIdType;
                    if (virtualIdType == 2) {
                      //ledActionCommand_1 += `0c02${mac}972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                      ledActionCommand_1 +=   `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                    } else {
                      //ledActionCommand_1 += `0c02${mac}972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}0c02${rcuMac}972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                      ledActionCommand_1 +=   `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                    }
                  }
                });
                this.actionList_2.forEach((actionItem) => {
                  if (
                    actionItem.device_mode == 'RCU Controller' &&
                    actionItem.device_button_group == 'ONOFF GANG1' &&
                    this.templateName != 'RCU Curtain'
                  ) {
                    changeLedStatus_2 = true;
                    let virtualId = actionItem.virtualId;
                    let virtualIdType = actionItem.virtualIdType;
                    if (virtualIdType == 2) {
                      ledActionCommand_2 += `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                    } else {
                      //ledActionCommand_2 += `0c02${mac}972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}0c02${rcuMac}972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                      ledActionCommand_2 += `05972103${parseInt(virtualId).toString(16).pad('00')}${actionItem.ref == 1 ? '01' : '00'}`;
                    }
                  }
                  //RCU Curtain
                  if(this.templateName == 'RCU Curtain' && actionItem.device_mode == 'RCU Controller' && actionItem.device_button_group == 'ONOFF GANG1'){
                    changeLedStatus_2 = true; 
                    let virtualId = actionItem.virtualId;
                    ledActionCommand_2 += `05972103${parseInt(virtualId).toString(16).pad('00')}00`;
                  }
                });
                if (!changeLedStatus_1) {
                  sceneId_2 = '';
                }
                if (!changeLedStatus_2) {
                  sceneId_3 = '';
                }
                //if randar sensor input on the rcu
                if (
                  this.trigger[i].button_group.startsWith('4in1 Sensor') &&
                  (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')
                ) {
                  sceneId = this.actionId;
                  guid = this.actionGuid;
                } else if (
                  this.trigger[i].button_group.startsWith('RCU INPUT') &&
                  (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')
                ) {
                  sceneId = this.actionId;
                  guid = this.actionGuid;
                } else if (this.trigger[i].button_group.startsWith('SCENE MUTIWAY ONOFF GANG')) {
                  sceneId = this.actionLocation[this.trigger[i].guid];
                  debugger;
                } else {
                  postIdList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId,
                  });
                  postIdList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId_2,
                  });
                  postIdList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId_3,
                  });
                  sceneDeviceLocationList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId,
                  });
                  sceneDeviceLocationList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId_2,
                  });
                  sceneDeviceLocationList.push({
                    device: this.trigger[i].guid,
                    storage_id: sceneId_3,
                  });
                }
                if (this.trigger[i].isBle) {
                  continue;
                }
                //alert(sceneId)
                let last_command = ``;
                if (this.timercommand.length) {
                  last_command = `${this.tidyCommand(parseInt(sceneId).toString(16).pad('00'), parseInt(sceneId).toString(16).pad('00'), this.trigger[i], 0)}${(
                    this.timercommand.length / 2
                  )
                    .toString(16)
                    .pad('00')}${this.timercommand}`;
                } else {
                  last_command = `${this.tidyCommand(parseInt(sceneId).toString(16).pad('00'), parseInt(sceneId).toString(16).pad('00'), this.trigger[i], 0)}`;
                }
                console.log('last_command', last_command);
                //set the antion and trigger the virtual
                let thisActionCommand = '';
                let actionItemCommand = '';
                let settingCommandList = [];
                let z = i;
                //handle any rcu,should check if have the main Rcu,trigger the main rcu action
                if (this.mainRcuGuid) {
                  let this_mac = core_utils_get_mac_address_from_guid(this.mainRcuGuid, true);
                  let this_sceneId = this.actionLocation[this.mainRcuGuid];
                  debugger;
                  //actionItemCommand = `0b02${this_mac}8f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                  actionItemCommand = `0d02${this_mac}13048f0200${parseInt(this_sceneId).toString(16).pad('00')}`
                  settingCommandList.push(`8f0c00${this_mac}`);
                  if(this.actionMap[this.mainRcuGuid]['settingCommand']){
                    settingCommandList.push(this.actionMap[this.mainRcuGuid]['settingCommand']);
                  }
                } else {
                  for (let i in this.actionBleCommandList) {
                      debugger;
                      // if(i == this.actionGuid){
                      //   let this_mac = core_utils_get_mac_address_from_guid(i, true);
                      //   let this_sceneId = this.mainRcuId;
                      //   actionItemCommand += `0b02${this_mac}8f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                      // }
                      let this_mac = core_utils_get_mac_address_from_guid(i, true);
                      let this_sceneId = this.actionLocation[i];
                      if (isset(this.trigger[z].isExtra) && this.trigger[z].isExtra) {
                        this_sceneId = parseInt(this_sceneId) + 1;
                      }
                      //actionItemCommand += `0b02${this_mac}8f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                      actionItemCommand = `0d02${this_mac}13048f0200${parseInt(this_sceneId).toString(16).pad('00')}`;
                      //this is connect the rcu
                      settingCommandList.push(`8f0c00${this_mac}`);
                      if(this.actionMap[i]['pannelCommand']){
                        settingCommandList.push(this.actionMap[i]['pannelCommand']);
                      }
                      if(this.actionMap[i]['defaultOnCommand']){
                        settingCommandList.push(this.actionMap[i]['defaultOnCommand']);
                        settingCommandList.push(this.actionMap[i]['defaultOffCommand']);
                      }
                    }
                }
                thisActionCommand = `8f1000${parseInt(sceneId).toString(16).pad('00')}${actionItemCommand}`;

                //have the two scene
                if (this.mutiwayStatus == 2) {
                  if (this.templateName == 'RCU Curtain') {
                    let this_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);

                    //if choose the main RCU,should trigger the main rcu
                    let this_virtualId = '';
                    if (this.mainRcuGuid) {
                      if (!isset(this.virtualIdList[this.mainRcuGuid])) {
                        this.virtualIdList[this.mainRcuGuid] = this.getVirtualButtonId(this.mainRcuGuid);
                      }
                      this_virtualId = this.virtualIdList[this.mainRcuGuid];
                      this_mac = core_utils_get_mac_address_from_guid(this.mainRcuGuid, true);
                    } else {
                      for (let i in this.actionBleCommandList) {
                        if (!isset(this.virtualIdList[i])) {
                          this.virtualIdList[i] = this.getVirtualButtonId(i);
                        }
                        this_virtualId = this.virtualIdList[i];
                      }
                    }
                    if (this.trigger[i].ref == 2) {
                      let $command = `02${this_mac}8f0200${parseInt(this.actionCurtainId_1).toString(16).pad('00')}`;
                      actionItemCommand = `${parseInt($command.length /2).toString(16).pad("00")}${$command}`;
                      if (ledActionCommand_1) {
                        let $command = `02${mac}13${ledActionCommand_1}`;
                        if(gang == 12){
                          $command = `02${mac}13${ledActionCommand_1}048f0f010d`;
                        }else if(gang == 13){
                          $command = `02${mac}13${ledActionCommand_1}048f0f010c`;
                        }else if(gang == 14){
                          $command = `02${mac}13${ledActionCommand_1}048f0f010f`;
                        }else if(gang == 15){
                          $command = `02${mac}13${ledActionCommand_1}048f0f010e`;
                        }
                        actionItemCommand = `${actionItemCommand}${parseInt($command.length /2).toString(16).pad("00")}${$command}`;
                      }
                      thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}${actionItemCommand}`;
                    } else if (this.trigger[i].ref == 4) {
                      let $command_1 = `02${this_mac}8f0200${parseInt(this.actionCurtainId_2).toString(16).pad('00')}`;
                      actionItemCommand = `${parseInt($command_1.length /2).toString(16).pad("00")}${$command_1}`;
                      if (ledActionCommand_2) {
                        let $command = `02${mac}13${ledActionCommand_2}`
                        actionItemCommand = `${actionItemCommand}${parseInt($command.length /2).toString(16).pad("00")}${$command}`;
                      }
                      thisActionCommand = `8f1000${sceneId.toString(16).pad('00')}${actionItemCommand}`;
                    }
                    //setting self virtual id
                    settingCommandList.push(
                      `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(this_virtualId).toString(16).pad('00')}00`
                    );
                  } else {
                    //toggle scene logic
                    //if have the mainRcu,should trigger the main rcu virtual id
                    if (this.mainRcuGuid) {
                      let this_command_data = '';
                      let this_mac = core_utils_get_mac_address_from_guid(this.mainRcuGuid, true);
                      let this_virtualId = this.virtualIdList[this.mainRcuGuid]; //virtual id;
                      let actionCommandItem = `02${mac}1305972103${parseInt(this_virtualId).toString(16).pad('00')}02`;
                      this_command_data += `02${this_mac}972103${parseInt(this_virtualId).toString(16).pad('00')}02`;
                      if (sceneId_2 && !sceneId_3) {
                        //only one action
                        actionCommandItem += ledActionCommand_1;
                      }
                      this_command_data = `${(this_command_data.length/2).toString(16).pad("00")}${this_command_data}${(actionCommandItem.length/2).toString(16).pad("00")}${actionCommandItem}}`;
                      thisActionCommand = `8f1000${parseInt(sceneId).toString(16).pad('00')}${this_command_data}`;
                      settingCommandList.push(
                        `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(this_virtualId).toString(16).pad('00')}00`
                      );
                    } else {
                      //change the virtual
                      let this_command_data = '';
                      let post_id = '';
                      //this case,if choose the toggle template,the virtual id must be same;
                      for (let i in this.actionBleCommandList) {
                        let this_mac = core_utils_get_mac_address_from_guid(i, true);
                        let this_sceneId = this.virtualIdList[i];
                        post_id = this_sceneId;
                        //check if one rcu
                        if (this.subscribeMacadrress) {
                          this_command_data = `0f02${mac}17${this.subscribeMacadrress}972103${parseInt(this_sceneId).toString(16).pad('00')}020c02${mac}972103${parseInt(this_sceneId).toString(16).pad('00')}02`;
                        } else {
                          //this_command_data += `0c02${this_mac}972103${parseInt(this_sceneId).toString(16).pad('00')}020c02${mac}972103${parseInt(this_sceneId).toString(16).pad('00')}02`;
                          let _command = ``;
                          //this_command_data = `0e02${this_mac}1305972103${parseInt(this_sceneId).toString(16).pad('00')}020c02${mac}972103${parseInt(this_sceneId).toString(16).pad('00')}02`;
                          this_command_data = `02${this_mac}972103${parseInt(this_sceneId).toString(16).pad('00')}02`;
                        }
                      }
                      let actionCommandItem = `02${mac}1305972103${parseInt(post_id).toString(16).pad('00')}02`;
                      if (sceneId_2 && !sceneId_3) {
                        //only one action
                        actionCommandItem += ledActionCommand_1;
                      }
                      this_command_data = `${parseInt(this_command_data.length /2).toString(16).pad("00")}${this_command_data}${parseInt(actionCommandItem.length /2).toString(16).pad("00")}${actionCommandItem}`;
                      thisActionCommand = `8f1000${parseInt(sceneId).toString(16).pad('00')}${this_command_data}`;
                      settingCommandList.push(
                        `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(post_id).toString(16).pad('00')}00`
                      );
                      //alert("thisActionCommand:"+thisActionCommand)
                      debugger;
                    }
                  }
                } else {
                  //should bind the virtual to the button
                  let thisRcuGuid = '';
                  if (this.mainRcuGuid) {
                    thisRcuGuid = this.mainRcuGuid;
                  } else {
                    //check if have rcu connect
                    for (let i in this.actionBleCommandList) {
                      thisRcuGuid = i;
                    }
                  }
                  debugger;
                  if (!isset(this.virtualIdList[thisRcuGuid])) {
                    this.virtualIdList[thisRcuGuid] = this.getVirtualButtonId(thisRcuGuid);
                  }
                  //link the virtual id
                  let virtualGang = this.virtualIdList[thisRcuGuid];

                  //setting self virtual id
                  settingCommandList.push(
                    `8f32${parseInt(gang).toString(16).pad('00')}00${mac}13${parseInt(virtualGang).toString(16).pad('00')}00`
                  );
                  //if action list have the rcu virtual status,should change self action
                  //thisActionCommand += `0c02${mac}972103${parseInt(virtualGang).toString(16).pad('00')}01`;
                  //thisActionCommand += `02${mac}1305972103${parseInt(virtualGang).toString(16).pad('00')}01`;
                  let _commands = `02${mac}1305972103${parseInt(virtualGang).toString(16).pad('00')}01`
                  if (changeLedStatus_1 && !changeLedStatus_2) {
                    _commands += ledActionCommand_1;
                  }
                  if(this.templateName == 'RCU Scene Button'){
                    if(this.deviceStatusList.length > 0){
                      this.deviceStatusList.forEach(item => {
                        let virtualId = item.virtualId;
                        let set_index = `${parseInt(virtualId) + 2}`;
                        _commands += `048f1700${parseInt(set_index).toString(16).pad('00')}`;                 
                      });
                    }
                  }
                  if(this.templateName == 'RCU Scene New Toggle'){
                    _commands = `02${mac}1305972103${parseInt(virtualGang).toString(16).pad('00')}02`;
                    //thisActionCommand = `${thisActionCommand}${parseInt(_commands.length /2).toString(16).pad("00")}${_commands}`;
                  }
                  thisActionCommand = `${thisActionCommand}${parseInt(_commands.length /2).toString(16).pad("00")}${_commands}`;
                }
                
                let triggerStatus = false;
                let virtualSceneId = '';
                let this_ref = 0;
                this.virtualList.forEach((item) => {
                  if (item.display) {
                    triggerStatus = true;
                    virtualSceneId = item.config;
                    this_ref = item.ref;
                  }
                });
                if (triggerStatus) {
                  thisActionCommand = `8f1000${parseInt(sceneId).toString(16).pad('00')}1302${rcuMac}13048f0200${parseInt(this.actionId)
                    .toString(16)
                    .pad('00')}05972103${parseInt(virtualSceneId).toString(16).pad('00')}${parseInt(this_ref).toString(16).pad('00')}`;
                }
                let ledTriggerOn = '';
                let ledTriggerOff = '';
                let ledActionOn = '';
                let ledActionOff = '';
                let ledRawSettingCommand = ``;
                if (sceneId_2 && sceneId_3 && this.templateName != 'RCU Curtain') {
                  let thisRcuGuid = '';
                  if (this.mainRcuGuid) {
                    thisRcuGuid = this.mainRcuGuid;
                  } else {
                    //check if have rcu connect
                    for (let i in this.actionBleCommandList) {
                      thisRcuGuid = i;
                    }
                  }
                  let virtualGang = this.virtualIdList[thisRcuGuid];
                  let pre_command = `8F2000${parseInt(sceneId_2).toString(16).pad('00')}${parseInt(sceneId_2).toString(16).pad('00')}`;
                  let $thisCommand = `${'00'}${'1f'}${mac}00${'01'}13${parseInt(virtualGang).toString(16).pad('00')}`;
                  $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                  ledTriggerOn = `${pre_command}${$thisCommand}`;

                  let pre_command_3 = `8F2000${parseInt(sceneId_3).toString(16).pad('00')}${parseInt(sceneId_3).toString(16).pad('00')}`;
                  let $thisCommand_3 = `${'00'}${'1f'}${mac}00${'00'}13${parseInt(virtualGang).toString(16).pad('00')}`;
                  $thisCommand_3 = `${($thisCommand_3.length / 2).toString(16).pad('00')}${$thisCommand_3}`;
                  ledTriggerOff = `${pre_command_3}${$thisCommand_3}`;
                  //alert('ledTriggerOn :' + ledTriggerOn);
                  //alert('ledTriggerOff :' + ledTriggerOff);
                  let _this_command_1 = `02${mac}13${ledActionCommand_1}`;
                  let _this_command_2 = `02${mac}13${ledActionCommand_2}`;
                  if(this.templateName == 'RCU Scene Toggle - Save Status'){
                    //select the scene virtual id 
                    let set_index = parseInt(virtualGang) +2;
                    _this_command_1 = `02${mac}13048f1701${parseInt(set_index).toString(16).pad('00')}${ledActionCommand_1}`;
                    _this_command_2 = `02${mac}13${ledActionCommand_2}`;
                    debugger
                    for(let i in this.rcuTempList){
                      let this_list = this.rcuTempList[i].list;
                      let command = ``;
                      for(let j in this_list){
                        if(isset(this_list[j].scene_virtual_button)){
                          let virtualId = this_list[j].virtualId;
                          let _command = `972103${parseInt(virtualId).toString(16).pad('00')}`;
                          command += `${(_command.length/2).toString(16).pad('00')}${_command}`;
                        }
                      }
                      ledRawSettingCommand = `8f1302${parseInt(set_index).toString(16).pad('00')}${command}`;
                    }
                  }
                  ledActionOn = `8f1000${parseInt(sceneId_2).toString(16).pad('00')}${parseInt(_this_command_1.length /2).toString(16).pad("00")}${_this_command_1}`;
                  ledActionOff = `8f1000${parseInt(sceneId_3).toString(16).pad('00')}${parseInt(_this_command_2.length /2).toString(16).pad("00")}${_this_command_2}`;
                  //alert('ledActionOn :' + ledActionOn);
                  //alert('ledActionOff :' + ledActionOff);
                  if(this.templateName == 'RCU Scene Toggle - Save Status'){
                    //select the scene virtual id 

                  }
                }
                //if input rcu command
                if (
                  this.trigger[i].button_group.startsWith('4in1 Sensor') &&
                  (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')
                ) {
                  thisActionCommand = ``;
                }
                if (
                  this.trigger[i].button_group.startsWith('RCU INPUT') &&
                  (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar')
                ) {
                  thisActionCommand = ``;
                }
                //if trigger by self
                if (this.trigger[i].button_group.startsWith('SCENE MUTIWAY ONOFF GANG')) {
                  thisActionCommand = ``;
                }
                //let thisActionCommand = `8f0200${parseInt(this.actionId).toString(16).pad("00")}02${rcuMac}${parseInt(this.actionId).toString(16).pad("00")}`;
                let settingCommand = ``;
                if (isset(virtualSceneId) && virtualSceneId) {
                  //settingCommand = `8f32${parseInt(gang).toString(16).pad('00')}00${rcuMac}13${parseInt(virtualSceneId).toString(16).pad('00')}00`;
                }
                for (let i in this.actionBleCommandList) {
                  let this_mac = core_utils_get_mac_address_from_guid(i, true);
                  let this_sceneId = this.virtualIdList[i];
                  //check if one rcu
                  //settingCommand = `8f32${parseInt(gang).toString(16).pad('00')}00${this_mac}13${parseInt(this_sceneId).toString(16).pad('00')}00`;
                }
                if (this.mainRcuGuid) {
                  debugger;
                  let this_mac = core_utils_get_mac_address_from_guid(this.mainRcuGuid, true);
                  let this_sceneId = this.virtualIdList[this.mainRcuGuid];
                  //settingCommand = `8f32${parseInt(gang).toString(16).pad('00')}00${this_mac}13${parseInt(this_sceneId).toString(16).pad('00')}00`;
                }
                if (this.trigger[i].button_group.startsWith('Door Open')) {
                  thisActionCommand = ``;
                }
                if (this.templateName == 'RCU Curtain' || this.templateName == 'RCU Scene Button') {
                  settingCommand = ``;
                }

                //let toggleVirtualCommand = `8f1000${sceneId.toString(16).pad("00")}0c02${rcuMac}972103${parseInt(this.actionId).toString(16).pad("00")}02`;
                console.log('thisActionCommand', thisActionCommand);
                // thisActionCommand = this.processInstruction(thisActionCommand);
                // console.log('thisActionCommand_2', thisActionCommand);
                console.log('settingCommand', settingCommand);
                if (settingCommand) {
                  settingCommandList.push(settingCommand);
                }
                //console.log("toggleVirtualCommand",toggleVirtualCommand);
                this.trigger[i].triggercommand = last_command;
                //this.trigger[i].list = this.trigger;
                this.trigger[i].actionCommand = thisActionCommand;
                this.trigger[i].settingCommand = settingCommand;
                this.trigger[i].triggerId = sceneId;
                this.trigger[i].triggerId_2 = sceneId_2;
                this.trigger[i].triggerId_3 = sceneId_3;
                this.trigger[i].ledTriggerOn = ledTriggerOn;
                this.trigger[i].ledTriggerOff = ledTriggerOff;
                this.trigger[i].ledActionOn = ledActionOn;
                this.trigger[i].ledActionOff = ledActionOff;
                this.trigger[i].ledRawSettingCommand = ledRawSettingCommand;
                this.trigger[i].settingCommandList = settingCommandList;
                try {
                  let bleList = [
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: last_command,
                    },
                  ];
                  if (last_command.includes('&&')) {
                    let $command_1 = last_command.split('&&')[0];
                    let $command_2 = last_command.split('&&')[1];
                    bleList = [];
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: $command_1,
                    });
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: $command_2,
                    });
                  }
                  if (ledTriggerOn) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: ledTriggerOn,
                    });
                  }
                  if (ledActionOn) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: ledActionOn,
                    });
                  }
                  if (ledTriggerOff) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: ledTriggerOff,
                    });
                  }
                  if (ledActionOff) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: ledActionOff,
                    });
                  }
                  if (thisActionCommand) {
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: thisActionCommand,
                    });
                  }
                  if(ledRawSettingCommand){
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: ledRawSettingCommand,
                    });
                  }
                  // if (isset(virtualSceneId) && virtualSceneId) {
                  //   bleList.push({
                  //     service: 'ff80',
                  //     characteristic: 'ff81',
                  //     data: settingCommand,
                  //   });
                  // }
                  if (this.templateName != 'RCU Scene Toggle' && this.templateName != 'RCU Scene Toggle - Save Status' && this.templateName != 'RCU Radar') {
                    for (let z in settingCommandList) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: settingCommandList[z],
                      });
                    }
                  }
                  if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                    for (let z in settingCommandList) {
                      bleList.push({
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: settingCommandList[z],
                      });
                    }
                  }
                  console.log('bleList', bleList);
                  console.log('guid is:', guid);
                  //alert(JSON.stringify(bleList))
                  await window.peripheral[guid].write(bleList);
                  await window.peripheral[guid].disconnect();
                  this.trigger[i].isBle = true;
                  this.simulateScenePostId(guid, sceneId);
                  this.loadingDeviceConnect(guid, this.trigger[i].button_group);
                  this.overallSceneMap['scene_device_location'].push({
                    device: guid,
                    storage_id: sceneId,
                  });
                  if (sceneId_2 && sceneId_3) {
                    //alert('comming')
                    this.overallSceneMap['scene_device_location'].push({
                      device: guid,
                      storage_id: sceneId_2,
                    });
                    this.overallSceneMap['scene_device_location'].push({
                      device: guid,
                      storage_id: sceneId_3,
                    });
                  }

                  checkIndex++;
                  //app.dialog.close();
                } catch (error) {
                  app.dialog.close();
                  console.log(error);
                  postStatus = false;
                  //alert(checkIndex);
                  this.trigger[i].isBle = false;
                  errorTriggerList.push(this.trigger[i]);
                  //app.dialog.alert(error);
                  this.index = 4;
                  continue;
                }
              }
              //if the toggle have the M86-DP,means should subscribe the M86-DP led
              let check_m_86_dp_status = false;
              let check_door_dnd = false;
              let check_door_clear = false;
              let m_86_dp_list = [];
              this.actionList.forEach((item) => {
                //31 CLEAR ON 32 DND ON //34 CLEAR OFF //35 DND OFF
                if (item.ref == 32 || item.ref == 35) {
                  check_door_dnd = true;
                }
                if (item.ref == 31 || item.ref == 34) {
                  check_door_clear = true;
                }
              });
              //check the profile if have the m86-dp
              if (check_door_dnd || check_door_clear) {
                let this_profile_device = cloneDeep(erp.info.profile.profile_device);
                this_profile_device.forEach((item) => {
                  if (item.device_model.startsWith('M86-DP')) {
                    check_m_86_dp_status = true;
                    m_86_dp_list.push(item.device);
                  }
                });
                for (let i in m_86_dp_list) {
                  let this_mac = core_utils_get_mac_address_from_guid(m_86_dp_list[i], true);
                  let gang = check_door_dnd ? 1 : check_door_clear ? 3 : 0;
                  let this_virtual_gang = '';
                  let rcu_mac = '';
                  for (let i in this.actionBleCommandList) {
                    rcu_mac = core_utils_get_mac_address_from_guid(i, true);
                    this_virtual_gang = this.virtualIdList[i];
                  }
                  let this_command = `8f32${gang.toString(16).pad('00')}00${rcu_mac}13${parseInt(this_virtual_gang).toString(16).pad('00')}00`;
                  try {
                    console.log('this_command', this_command);
                    app.dialog.preloader(_('Setting the M86-DP led,please wait a moment.'));
                    await window.peripheral[m_86_dp_list[i]].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: this_command,
                      },
                    ]);
                    await window.peripheral[m_86_dp_list[i]].disconnect();
                    app.dialog.close();
                  } catch (error) {
                    app.dialog.close();
                    console.log('dnd biling' + error);
                    app.dialog.alert(_('M86-DP') + _('led setting failed') + _(erp.get_log_description(error)));
                  }
                }
              }
              //save the scene in the curtain
              // if(this.templateName == 'RCU Curtain'){
              //   await this.savesceneInCurtain();
              // }
            }
            try {
              console.log('postIdList', postIdList);
              //debugger
              if (!postStatus) {
                app.dialog.confirm(
                  `${_('Connection failed,reconnect?')}`,
                  async () => {
                    //must be disconnect the device and then retry connect it
                    app.dialog.preloader(`${_('Reconnecting,please wait a moment')}...`);
                    setTimeout(() => {
                      app.dialog.close();
                    }, 15 * 1000);
                    if (this.templateName == 'RCU Scene Button') {
                      for (let i in this.trigger) {
                        await window.peripheral[this.trigger[i].guid].disconnect();
                      }
                    }
                    setTimeout(() => {
                      this.saveTriggerOnble();
                    }, 3000);
                  },
                  () => {}
                );
                return;
              }
              if (this.$sheetMap) {
                this.$sheetMap.close();
              }
              app.dialog.close();
              this.index = 5;
              if (this.mutiwayStatus == 2 || this.templateName == 'RCU Scene New Toggle') {
                this.overallSceneMap['trigger'] = this.trigger;
              } else {
                await this.saveTriggerOnErp(postIdList);
                await ha_profile_ready();
                this.saveExtraTriggerAndAction();
              }
              return;
              app.dialog.close();
              if (this.$sheetMap) {
                this.$sheetMap.close();
              }
              this.index = 5;
              // setTimeout(() => {
              //   app.dialog.close();
              //   mainView.router.back();
              // }, 1500);
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          async saveTimer() {
            app.dialog.preloader();
            try {
            } catch (error) {}
          },
          async addSubdeviceInErp(sceneId) {
            let hide_device = $(`input[name="hide_device"]:checked`).val();
            let devices = cloneDeep(erp.info.device);
            let deviceObj = devices[this.actionGuid];
            let url = `/api/resource/Profile Subdevice`;
            let method = 'POST';
            // if(isset(this.subdeviceName) && this.subdeviceName != ''){
            //   url = `/api/resource/Profile Subdevice/${this.subdeviceName}`
            //   method = 'PUT'
            // }
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            subdevices.forEach((subItem) => {
              if (subItem.name == sub_name) {
                this.actionGuid = subItem.device;
              }
            });
            try {
              //let device_batch = erp.doctype.device_batch[peripheral[this.actionGuid].getProp().hexBatch.toUpperCase()];
              let post_data = {
                parenttype: 'Profile',
                parent: erp.info.profile.name,
                parentfield: 'profile_subdevice',
                profile_room: erp.info.profile.profile_room[0].name,
                profile_device: this.profileDeviceName,
                device: this.actionGuid,
                title: this.actionName,
                device_button_group: 'SCENE MUTIWAY ONOFF GANG1',
                device_mode: deviceObj.device_mode,
                config: `${sceneId}`,
                hidden: isset(hide_device) ? 1 : 0,
              };
              debugger;
              // let post_data = {
              //   title:this.actionName,
              //   guid : this.actionGuid,
              //   peripheral : deviceObj.mac_address.replace(/:/g, '').toLowerCase(),
              //   model:deviceObj.device_model,
              //   device_mode:deviceObj.device_mode,
              //   device_button_group : 'SCENE MUTIWAY ONOFF GANG1',
              //   parent : erp.info.profile.name,
              //   batch : isset(device_batch)?device_batch.batch_id:'YO0012',
              //   firmware : peripheral[this.actionGuid].getProp().firmware || 0,
              //   profile_room : erp.info.profile.profile_room[0].name,
              //   password : peripheral[this.actionGuid].getProp().password || '000000',
              //   mac_address: core_utils_get_mac_address_from_guid(this.actionGuid),
              //   subdevice_name : isset(subdevice_name) && subdevice_name != 'undefined'?subdevice_name:''
              // }
              let postStatus = await http.request(encodeURI(url), {
                method: method,
                serializer: 'json',
                responseType: 'json',
                data: post_data,
                debug: true,
              });
              console.log('postStatus', postStatus);
              await ha_profile_ready();
            } catch (error) {
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          //change the structure of the action List
          strucActionList(list) {
            let targetList = [];
            if (list.length == 0) {
              return targetList;
            }
            //filter the differ mac device
            let macMap = {};
            list.forEach((item) => {
              if (!isset(macMap[item.device])) {
                macMap[item.device] = {};
                macMap[item.device]['device_mode'] = item.device_mode;
              }
            });
            for (let i in macMap) {
              macMap[i]['list'] = [];
              list.forEach((kitem) => {
                if (kitem.device === i) {
                  macMap[i]['list'].push(kitem);
                }
              });
            }
            return macMap;
          },
          postActionBle(actualActionList) {
            let controlIndex = 0;
            let postList = cloneDeep(actualActionList);
            debugger;
            for (let guidItem in postList) {
              let guid = guidItem;
              let list = postList[guidItem]['list'];
              postList[guidItem]['actionCommand'] = '';
              let start_length = 0;
              let actioncommand = '';
              let actioncommand_length = list.length;
              list.forEach((item, index) => {
                let mode = item.mode || item.device_mode;
                let button_group = item.button_group || item.device_button_group;
                let mac = core_utils_get_mac_address_from_guid(guid, true);
                let ref = item.ref;
                let data = ``;
                debugger;
                //different mode need to handle
                if (mode == 'On Off Switch' || mode == 'Multiway Switch' || mode == 'RCU Scene Button') {
                  if (button_group.startsWith('RCU')) {
                    let button_group_gang = parseInt(button_group.replace('RCU ONOFF GANG', '') * 1);
                    let gang = button_group_gang - 4 * (parseInt(item.config) - 1);
                    let onoff_data = '1100';
                    if (gang == 1) {
                      if (ref == 1) {
                        onoff_data = '1100';
                      } else {
                        onoff_data = '1000';
                      }
                    } else if (gang == 2) {
                      if (ref == 1) {
                        onoff_data = '2200';
                      } else {
                        onoff_data = '2000';
                      }
                    } else if (gang == 3) {
                      if (ref == 1) {
                        onoff_data = '4400';
                      } else {
                        onoff_data = '4000';
                      }
                    } else if (gang == 4) {
                      if (ref == 1) {
                        onoff_data = '8800';
                      } else {
                        onoff_data = '8000';
                      }
                    }
                    let this_data = `971f${item.config}8000${onoff_data}`;
                    if (ref == 2) {
                      this_data = `8f31${item.config}0${gang}${'01'}01`;
                    }
                    //let this_data = `8f31${item.config}0${gang}${'01'}${ref == 1 ? '00' : '01'}`;
                    let this_length = this_data.length / 2;
                    if (index == 0) {
                      data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                    } else {
                      data = `${this_length.toString(16).pad('00')}${this_data}`;
                    }
                  } else {
                    let gang = button_group.replace('ONOFF GANG', '') * 1;
                    data = jinja2.render(window[(ref == '1' ? 'ON' : 'OFF') + gang].toString(), { mackey: mac }).toLowerCase();
                    if (this.rcuMacAddress) {
                      let $command = data.substring(2, data.length);
                      let $ac_command = `15${mac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                      //if the second ,have no 13
                      if (index == 0) {
                        data = `13${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                      } else {
                        data = `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                      }
                    } else {
                      //data = item.action_command;
                    }
                  }
                } else if (mode == 'RCU Controller') {
                  if (item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1') {
                    let gang = parseInt(item.config);
                    if (index == 0 && controlIndex == 0) {
                      let this_data = `972103${gang.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                      data = `${$command}`;
                    } else {
                      let $command = `972103${gang.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                    }
                  } else if (item.device_button_group == 'ONOFF GANG1' && item.virtualIdType != 2) {
                    //if led,do not change this gang
                    let gang = parseInt(item.virtualId);
                    let $command = `972103${gang.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                    if (index == 0 && controlIndex == 0) {
                      let this_data = `972103${gang.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                      data = `${$command}`;
                    } else {
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                    }
                  } else if (item.device_button_group == 'DOOR SIGN') {
                    let ref = item.ref;
                    let onoff_satus = '00';
                    let val_led = '';
                    let attach_command = '';
                    //31 CLEAR ON 32 DND ON //34 CLEAR OFF //35 DND OFF
                    if (ref == 31) {
                      onoff_satus = '01'; //should off the dnd
                      val_led = 31;
                      //attach_command = `9721012000`;
                    } else if (ref == 32) {
                      onoff_satus = '01'; //should off the clear
                      val_led = 32;
                      //attach_command = `9721011f00`;
                    } else if (ref == 34) {
                      onoff_satus = '00';
                      val_led = 31;
                    } else if (ref == 35) {
                      onoff_satus = '00';
                      val_led = 32;
                    }
                    if (index == 0) {
                      let this_data = `972101${val_led.toString(16).pad('00')}${onoff_satus}`;
                      let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}${attach_command ? '05' : ''}${attach_command}`;
                      data = `${$command}`;
                    } else {
                      let $command = `972101${val_led.toString(16).pad('00')}${onoff_satus}`;
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}${attach_command ? '05' : ''}${attach_command}`;
                    }
                  } else {
                    let val_led = button_group.replaceAll('RCU OUTPUT', '') * 1;
                    if (val_led == 33) {
                      val_led = 98;
                    }
                    let ref = item.ref;

                    //actioncommand += `${($command.length/2).toString(16).pad("00")}${$command}`;
                    if (index == 0) {
                      let this_data = `972101${val_led.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      let $command = `02${mac}13${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                      data = `${$command}`;
                    } else {
                      let $command = `972101${val_led.toString(16).pad('00')}${ref == 0 ? '00' : ref == 1 ? '01' : '02'}`;
                      data = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                    }
                  }
                } else if (mode == 'Triac Dimming' || mode == '0-10v Dimming' || mode == '1-10v Dimming') {
                  if (button_group.startsWith('RCU')) {
                    let light = item.turnlight ? parseInt(item.turnlight).toString(16).pad('00') : '02';
                    let button_group_gang = parseInt(button_group.replace('RCU DIMMING', '') * 1);
                    let gang = button_group_gang - 2 * (parseInt(item.config) - 1);
                    //find the triger setting
                    //let triger_status = !this.isRelease ? `01` : '00';
                    let triger_status = '02';
                    if (item.turnlight != 4 && item.turnlight != 5) {
                      //4 on ,5 off ,2 toggle ,3 Brighten, 1 Dim
                      let this_data = `8f31${item.config}0${gang}${light}${triger_status}01`;
                      if (item.turnlight == 2) {
                        this_data = `8f31${item.config}0${gang}${light}${triger_status}`;
                      }
                      let this_length = this_data.length / 2;
                      if (index == 0) {
                        data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                      } else {
                        data = `${this_length.toString(16).pad('00')}${this_data}`;
                      }
                    } else if (item.turnlight == 4) {
                      //let range_value = ref.toString(16).pad('00');
                      let range_value = `${parseInt(item.ref).toString(16).pad('00')}`;
                      let this_data = `971f${item.config}892${gang == 1 ? 0 : 1}${range_value}`;
                      let this_length = this_data.length / 2;
                      if (index == 0) {
                        data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                      } else {
                        data = `${this_length.toString(16).pad('00')}${this_data}`;
                      }
                    } else if (item.turnlight == 5) {
                      let this_data = `971f${item.config}892${gang == 1 ? 0 : 1}${`00`}`;
                      let this_length = this_data.length / 2;
                      if (index == 0) {
                        data = `02${mac}13${this_length.toString(16).pad('00')}${this_data}`;
                      } else {
                        data = `${this_length.toString(16).pad('00')}${this_data}`;
                      }
                    }
                  } else {
                    let range_value = ref.toString(16).pad('00');
                    data = jinja2.render(window.DIM.toString(), { mackey: mac, dim_value: range_value }).toLowerCase();
                  }
                } else if (
                  item.device_button_group.startsWith('OPENCLOSE UART') ||
                  item.device_button_group.startsWith('OPENCLOSE WIFI UART')
                ) {
                  debugger;
                  if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Curtain' || this.templateName == 'Welcome Scene') {
                    let $command = item.action_command.substring(14, item.action_command.length);
                    let devices = cloneDeep(erp.info.profile.profile_device);
                    let gatewayMac = '';
                    let gatewayName = '';
                    //get the gateway mac address
                    devices.forEach((zitem) => {
                      if (zitem.device == item.device) {
                        if(zitem.gateway){
                          //the gateway is same as 3c:84:27:ee:b9:86-bruce.huang@yoswit.com
                          let gatewayStr = zitem.gateway.split('-')[0];
                          //3c:84:27:ee:b9:86 is change to 3c8427eeb986
                          gatewayName = gatewayStr.replaceAll(':', '');
                        }
                      }
                    });
                    gatewayMac = core_utils_get_mac_address_from_guid(devices.find(item=>item.device_name.toLowerCase().trim() == gatewayName.toLowerCase().trim()).device, true);
                    if(!gatewayMac){
                      gatewayMac = core_utils_get_mac_address_from_guid(item.device, true);
                    }
                    let $ac_command = '';
                    if(this.radarExitUnmannedModeStatus || this.radarEnterUnmannedModeStatus){
                      let _command = `${gatewayMac}13048f17${this.radarExitUnmannedModeStatus?'01':'00'}01${($command.length / 2).toString(16).pad('00')}${$command}`
                      //`15${mac}${(_command.length / 2).toString(16).pad('00')}${_command}`;
                      $ac_command += _command;
                    }else{
                      $ac_command += `${gatewayMac}13${($command.length / 2).toString(16).pad('00')}${$command}`;
                    }
                    if (controlIndex == 0) {
                      let _command_item = `15${gatewayMac}${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`
                      data = `13${(_command_item.length / 2).toString(16).pad('00')}${_command_item}`;
                    } else {
                      let _command_item = `15${gatewayMac}${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`
                      data = `${(_command_item.length / 2).toString(16).pad('00')}${_command_item}`;
                    }
                    
                  }
                }else if(item.device_button_group.startsWith("Hdmicec")){
                  debugger
                  if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Curtain' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'Welcome Scene') {
                    let devices = cloneDeep(erp.info.profile.profile_device);
                    let gatewayMac = '';
                    let gatewayName = '';
                    //get the gateway mac address
                    devices.forEach((zitem) => {
                      if (zitem.device == item.device) {
                        if(zitem.gateway){
                          //the gateway is same as 3c:84:27:ee:b9:86-bruce.huang@yoswit.com
                          let gatewayStr = zitem.gateway.split('-')[0];
                          //3c:84:27:ee:b9:86 is change to 3c8427eeb986
                          gatewayName = gatewayStr.replaceAll(':', '');
                        }
                      }
                    });
                    gatewayMac = core_utils_get_mac_address_from_guid(devices.find(item=>item.device_name.toLowerCase().trim() == gatewayName.toLowerCase().trim()).device, true);
                    if(!gatewayMac){
                      gatewayMac = core_utils_get_mac_address_from_guid(item.device, true);
                    }
                    let pre_command = `972102016B61203120`;
                    let ref = item.ref;
                    let $command = `${core_utils_get_mac_address_from_guid(item.device,true)}130c${pre_command}30${ref == 1?'31':'30'}0D`;
                    let $ac_command = '';
                    let delay_command_item = `${core_utils_get_mac_address_from_guid(item.device,true)}8f1f01d0070000${pre_command}30${ref == 1?'31':'30'}0D`;
                    let delay_command = '';
                    //if cec,should send the delay command 2s
                    if(this.radarExitUnmannedModeStatus || this.radarEnterUnmannedModeStatus){
                      $command = `${core_utils_get_mac_address_from_guid(item.device,true)}13048f17${this.radarExitUnmannedModeStatus?'01':'00'}010c${pre_command}30${ref == 1?'31':'30'}0D`;
                    }
                    $ac_command = `15${gatewayMac}${($command.length / 2).toString(16).pad('00')}${$command}`;
                    if(controlIndex == 0){
                        data = `13${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    }else{
                      data = `${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`;
                    }
                    //alert(data)
                    // if(ref == 1){
                    //   data = `${data}${(delay_command.length /2).toString(16).pad('00')}${delay_command}`;
                    // }
                    
                  }
                }
                if (
                  data.length &&
                  !button_group.startsWith('RCU') &&
                  this.templateName != 'RCU Scene Button' &&
                  this.templateName != 'RCU Radar' &&
                  this.templateName != 'RCU Scene Toggle' &&
                  this.templateName != 'RCU Scene Toggle - Save Status' &&
                  this.templateName != 'RCU Curtain' &&
                  this.templateName != 'Welcome Scene'
                ) {
                  start_length = data.length / 2;
                  actioncommand += `${start_length.toString(16).pad('00')}${data}`;
                } else if (
                  this.templateName == 'RCU Scene Button' ||
                  this.templateName == 'RCU Radar' ||
                  this.templateName == 'RCU Scene Toggle' ||
                  this.templateName == 'RCU Scene Toggle - Save Status' ||
                  this.templateName == 'RCU Curtain' ||
                  this.templateName == 'Welcome Scene'
                ) {
                  actioncommand += data;
                } else if (button_group.startsWith('RCU')) {
                  if (index == actioncommand_length - 1) {
                    actioncommand += `${data}`;
                    let this_lengths = actioncommand.length / 2;
                    actioncommand = `${this_lengths.toString(16).pad('00')}${actioncommand}`;
                  } else {
                    actioncommand += `${data}`;
                  }
                }
                if (mode == 'Thermostat') {
                  debugger;
                  let $ac_command = '';
                  if (item.action_command) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain' || this.templateName == 'Welcome Scene') {
                      let $command = item.action_command.substring(14, item.action_command.length);
                      //let $ac_command = `15${mac}13${($command.length / 2).toString(16).pad('00')}${$command}`;
                      if(this.radarExitUnmannedModeStatus || this.radarEnterUnmannedModeStatus){
                        let _command = `${mac}13048f17${this.radarExitUnmannedModeStatus?'01':'00'}01${($command.length / 2).toString(16).pad('00')}${$command}`
                        //`15${mac}${(_command.length / 2).toString(16).pad('00')}${_command}`;
                        $ac_command += _command;
                      }else{
                        $ac_command += `${mac}13${($command.length / 2).toString(16).pad('00')}${$command}`;
                      }
                      
                    } else {
                      actioncommand += `${(item.action_command.length / 2).toString(16).pad('00')}${item.action_command}`;
                    }
                  }
                  if (item.thermostat_fan) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain' || this.templateName == 'Welcome Scene') {
                      let $command = item.thermostat_fan.substring(14, item.thermostat_fan.length);
                      $ac_command += `${($command.length / 2).toString(16).pad("00")}${$command}`;
                    } else {
                      actioncommand += `${(item.thermostat_fan.length / 2).toString(16).pad('00')}${item.thermostat_fan}`;
                    }
                  }
                  if (item.thermostat_mode) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain' || this.templateName == 'Welcome Scene') {
                      let $command = item.thermostat_mode.substring(14, item.thermostat_mode.length);
                      $ac_command += `${($command.length / 2).toString(16).pad("00")}${$command}`;
                    } else {
                      actioncommand += `${(item.thermostat_mode.length / 2).toString(16).pad('00')}${item.thermostat_mode}`;
                    }
                  }
                  if (item.thermostat_temp) {
                    if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain' || this.templateName == 'Welcome Scene') {
                      let $command = item.thermostat_temp.substring(14, item.thermostat_temp.length);
                      $ac_command += `${($command.length / 2).toString(16).pad("00")}${$command}`;
                    } else {
                      actioncommand += `${(item.thermostat_temp.length / 2).toString(16).pad('00')}${item.thermostat_temp}`;
                    }
                  }
                  if(this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'RCU Curtain' || this.templateName == 'Welcome Scene'){
                    if (controlIndex == 0) {
                      let _command_item = `15${mac}${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`
                        actioncommand = `13${(_command_item.length / 2).toString(16).pad('00')}${_command_item}`;
                      } else {
                        let _command_item = `15${mac}${($ac_command.length / 2).toString(16).pad('00')}${$ac_command}`
                        actioncommand = `${(_command_item.length / 2).toString(16).pad('00')}${_command_item}`;
                      }
                  }
                  //alert(actioncommand)
                }
              });
              //check if have radarExitUnmannedModeStatus
              debugger
              //alert(this.checkIsRcu(guidItem))
              if(this.templateName == 'Welcome Scene' && this.checkIsRcu(guidItem)){
                //021a4a094aec241307971f0180001100
                let strList = actioncommand.split('');
                
                if(this.radarExitUnmannedModeStatus){
                  //check if have 13 in actioncommand
                  let _command = `048f170101048f170102`;
                  strList.splice(16, 0, `${_command}`);
                  actioncommand = strList.join('');
                }
                if(this.radarEnterUnmannedModeStatus){
                  let _command = `048f170001048f170002`;
                  strList.splice(16, 0, `${_command}`);
                  actioncommand = strList.join('');
                }
              }
              //if toggle scene
              if(this.templateName == 'RCU Scene Toggle - Save Status' && this.checkIsRcu(guidItem)){
                let virtualGang = '';
                virtualGang = this.virtualIdList[guidItem] ? this.virtualIdList[guidItem] : this.getVirtualButtonId(guidItem);
                let set_index = `${parseInt(virtualGang) + 2}`;
                let strList = actioncommand.split('');
                let _command = `048f1701${parseInt(set_index).toString(16).pad('00')}`;
                if(this.mutiwayStatus == 2){
                  _command = ``;
                } 
                strList.splice(16, 0, `${_command}`);
                actioncommand = strList.join('');
              }
              if(this.templateName == 'RCU Scene Button' && this.checkIsRcu(guidItem)){
                if(this.deviceStatusList.length > 0){
                  let _command = '';
                  this.deviceStatusList.forEach(item => {
                    let virtualId = item.virtualId;
                    let set_index = `${parseInt(virtualId) + 2}`;
                    _command += `048f1700${parseInt(set_index).toString(16).pad('00')}`;                 
                  });
                  actioncommand = `${actioncommand}${_command}`;
                }
              }
              postList[guidItem]['actionCommand'] = actioncommand;
              controlIndex++;
            }
            console.log('postList', postList);
            this.deviceActionCommandList = postList;
            //merge the command this.actionGuid
            let totalCommand = '';
            //first tindy the
            let thisCommandMap = {};
            //if only choose the curtain and the another gateway devices
            let haveRcu = false;
            //check if have gateway
            let gatewayActionGuid;
            this.rcuList.forEach((rcuItem) => {
              let guid = rcuItem.guid;
              let ismobmob = window.peripheral[guid].prop.is_mobmob;
              if (ismobmob == 1 && rcuItem.ischeck) {
                gatewayActionGuid = guid;
                return;
              }
            });
            for (let i in postList) {
              if (this.templateName == 'RCU Scene Button' || this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status' || this.templateName == 'Welcome Scene') {
                if (
                  postList[i].device_mode == 'Triac Dimming' ||
                  postList[i].device_mode == '0-10v Dimming' ||
                  postList[i].device_mode == '1-10v Dimming' ||
                  postList[i].device_mode == 'RCU Controller' ||
                  postList[i].device_mode == 'On Off Switch'
                ) {
                  haveRcu = true;
                  let this_data = postList[i].actionCommand;
                  //rcu
                  if (i == gatewayActionGuid) {
                    for (let j in postList) {
                      if (postList[j].device_mode == 'Thermostat' || postList[j].device_mode.startsWith('Curtain Moto') || postList[j].device_mode.startsWith('Hdmicec')) {
                        //13
                        // if(postList[j].actionCommand.substring(0,2) == '13'){
                        //   this_data = `${postList[j].actionCommand}${this_data}`;
                        // }else{
                        //   this_data = `${this_data}${postList[j].actionCommand}`;
                        // }
                        this_data += `${postList[j].actionCommand}`;
                      }
                    }
                  }
                  //console.log('this_data.length',(this_data.length/2));
                  let this_post_data = `${(this_data.length / 2).toString(16).pad('00')}${this_data}`;
                  //totalCommand += this_post_data;
                  thisCommandMap[i] = this_post_data;
                }
              }
              //
              if (this.templateName == 'RCU Curtain') {
                //rcu
                let this_data = '';
                haveRcu = true;
                for (let i in postList) {
                  this_data += postList[i].actionCommand;
                }
                let $command = `02${core_utils_get_mac_address_from_guid(gatewayActionGuid, true)}${this_data}`;
                anotherCommand = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                thisCommandMap[gatewayActionGuid] = anotherCommand;
              }
            }
            //alert(haveRcu)
            if (!haveRcu) {
              let anotherCommand = '';
              //only have curtain or thermostat

              let this_data = '';
              for (let i in postList) {
                this_data += postList[i].actionCommand;
              }
              if (this.templateName == 'Gateway Scene') {
                gatewayActionGuid = this.gatewayMapGuid;
                thisCommandMap[gatewayActionGuid] = this_data;
              } else {
                let $command = `02${core_utils_get_mac_address_from_guid(gatewayActionGuid, true)}${this_data}`;
                anotherCommand = `${($command.length / 2).toString(16).pad('00')}${$command}`;
                thisCommandMap[gatewayActionGuid] = anotherCommand;
              }
            }
            return thisCommandMap;
          },
          checkIsMainRcu(guid){
            let isMainRcu = false;
            let devices = cloneDeep(erp.info.device);
            for (let i in devices) {
              let settings = devices[i].settings;
                settings.forEach((settingItem) => {
                  if (settingItem.setting_type.startsWith('main_rcu')) {
                    if (settingItem.setting == 1) {
                      isMainRcu = true;
                    }
                  }
                });
            }
            return isMainRcu;
          },
          getRcuOnOffCommand(solt,gang,ref){
            let command = ``;
            let onoff_data = `1100`;
            if (gang == 1) {
              if (ref == 1) {
                onoff_data = '1100';
              } else {
                onoff_data = '1000';
              }
            } else if (gang == 2) {
              if (ref == 1) {
                onoff_data = '2200';
              } else {
                onoff_data = '2000';
              }
            } else if (gang == 3) {
              if (ref == 1) {
                onoff_data = '4400';
              } else {
                onoff_data = '4000';
              }
            } else if (gang == 4) {
              if (ref == 1) {
                onoff_data = '8800';
              } else {
                onoff_data = '8000';
              }
            }
            command = `07971f${parseInt(solt).toString(16).pad('00')}8000${onoff_data}`;
            return command;
          },
          saveActionForNewToggle(){
            const getThisSceneId = (guid) =>{
              let existId;
              let sceneObj = erp.info.scene;
              let sceneMap;
              for (let i in sceneObj) {
                if (this.scenePostId == sceneObj[i].name && isset(sceneObj[i].name)) {
                  sceneMap = sceneObj[i];
                }
              }
              if(sceneMap){
                let list = sceneMap.scene_device_location;
                let thisRcuIdList = [];
                list.forEach((zitem) => {
                  if(zitem.device == guid){
                    thisRcuIdList.push(zitem);
                  }
                });
                existId = thisRcuIdList[0].storage_id;
              }
              return existId;
            }
            return new Promise(async (resolve, reject) => {
              let actualActionList = this.strucActionList(this.actionList);
              this.overallSceneMap['action']['actionList'] = this.actionList;
              console.log('actualActionList', actualActionList);
              //post the command
              let postStatus = true;
              let errorStr = '';
              this.actionBleCommandList = this.postActionBle(actualActionList);
              for(let guid in actualActionList){
                let list = actualActionList[guid].list;
                actualActionList[guid]['actionCommand'] = '';
                actualActionList[guid]['settingCommand'] = '';
                actualActionList[guid]['sceneId'] = '';
                if(!isset(this.actionMap)){
                  this.actionMap = {};
                }
                if(!isset(this.actionMap[guid])){
                  this.actionMap[guid] = {};
                } 
                this.actionMap[guid]['actionCommand'] = '';
                this.actionMap[guid]['settingCommand'] = '';
                this.actionMap[guid]['sceneId'] = '';
                this.actionMap[guid]['pannelCommand'] = '';
                let toggle_setting_item = ``;
                let toggle_default_on_item = '';
                let toggle_default_off_item = '';
                let pannel_setting_item = ``;
                let settingVirtualList = [];
                let firstSceneFlag = '';
                for(let i in list){
                  //972103+index+00/01/02
                  let device_button_group = list[i].device_button_group;
                  if(device_button_group.startsWith('RCU ONOFF GANG')){
                    let solt = list[i].config;
                    let gang = device_button_group.replace('RCU ONOFF GANG','')*1;
                    let target_gang = gang%4;
                    if(target_gang == 0){
                      target_gang = 4;
                    }
                    let on_command = this.getRcuOnOffCommand(solt, target_gang, 1);
                    let off_command = this.getRcuOnOffCommand(solt, target_gang, 0);
                    toggle_setting_item += `04971f${parseInt(solt).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                    
                    toggle_default_on_item += `${on_command}`;
                    toggle_default_off_item += `${off_command}`;
                  }else if(device_button_group.startsWith('RCU DIMMING')){
                    let solt = list[i].config;
                    let gang = device_button_group.replace('RCU DIMMING','')*1;
                    let target_gang = gang%2;
                    if(target_gang == 0){
                      target_gang = 2;
                    }
                    toggle_setting_item += `04971f${parseInt(solt).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                    toggle_default_on_item += `06971f${parseInt(solt).toString(16).pad('00')}892${target_gang == 1?0:1}ff`;
                    toggle_default_off_item += `06971f${parseInt(solt).toString(16).pad('00')}892${target_gang == 1?0:1}00`;
                  }else if(device_button_group.startsWith('RCU OUTPUT')){
                    let target_gang = device_button_group.replace('RCU OUTPUT','')*1;
                    toggle_setting_item += `04972101${parseInt(target_gang).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                    toggle_default_on_item += `05972101${parseInt(target_gang).toString(16).pad('00')}01`;
                    toggle_default_off_item += `05972101${parseInt(target_gang).toString(16).pad('00')}00`;
                  }else if(device_button_group.startsWith('ONOFF GANG1') && isset(list[i].virtualId)){
                    settingVirtualList.push({
                      virtualId: list[i].virtualId,
                      ref: list[i].ref
                    });
                    if(list[i].ref == 1){
                      toggle_setting_item += `04972103${parseInt(list[i].virtualId).toString(16).pad('00')}`;
                      //toggle_default_on_item += `05972103${parseInt(list[i].virtualId).toString(16).pad('00')}01`;
                    }
                    //toggle_default_off_item += `05972103${parseInt(list[i].virtualId).toString(16).pad('00')}00`;
                    
                    pannel_setting_item += `04972103${parseInt(list[i].virtualId).toString(16).pad('00')}`;
                  }
                }
                
                //get the virtual id
                //check if main rcu
                // let isMainRcu = this.checkIsMainRcu(guid);
                debugger;
                let virtualGang = '';
                if(this.checkIsAnyRcu(actualActionList)){
                  virtualGang = this.virtualIdList[guid] ? this.virtualIdList[guid] : this.getSameVirtualId(guid);
                }else{
                  virtualGang = this.virtualIdList[guid] ? this.virtualIdList[guid] : this.getVirtualButtonId(guid);
                }
                let bleList = [];
                let defaultOnCommand = '';
                let defaultOffCommand = '';
                if(virtualGang){
                  let command = `972003${parseInt(virtualGang).toString(16).pad('00')}02${toggle_setting_item}`;
                  //set the default toggle on and the toggle off
                  let pannelCommand = ''; 
                  if(pannel_setting_item){
                    pannelCommand = `972003${parseInt(virtualGang).toString(16).pad('00')}02${pannel_setting_item}`;
                  }
                  if(settingVirtualList.length){
                    //first is on and thore is off
                    let firstOne = settingVirtualList[0].virtualId;
                    toggle_default_on_item += `05972103${parseInt(firstOne).toString(16).pad('00')}01`;
                    defaultOnCommand = `972003${parseInt(virtualGang).toString(16).pad('00')}0105972103${parseInt(firstOne).toString(16).pad('00')}01`;
                    let defaultoffCommandItem = '';
                    let defaultOnCommandItem = '';
                    //if master , all on 
                    if(this.sceneName.toLowerCase().includes('master')){
                      toggle_default_on_item = '';
                      defaultOnCommand = '';
                    }
                    settingVirtualList.forEach((item, index) => {
                      toggle_default_off_item += `05972103${parseInt(item.virtualId).toString(16).pad('00')}00`;
                      if(item.ref == 1){
                        toggle_default_on_item += `05972103${parseInt(item.virtualId).toString(16).pad('00')}01`;
                      }
                      defaultoffCommandItem += `05972103${parseInt(item.virtualId).toString(16).pad('00')}00`;
                    });
                    defaultOffCommand = `972003${parseInt(virtualGang).toString(16).pad('00')}00${defaultoffCommandItem}`;
                    if(this.sceneName.toLowerCase().includes('master')){
                      defaultOnCommand = `972003${parseInt(virtualGang).toString(16).pad('00')}01${toggle_default_on_item}`;
                    }
                  }
                  if(toggle_default_on_item){
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: `972003${parseInt(virtualGang).toString(16).pad('00')}01${toggle_default_on_item}`,
                    })
                  }
                  if(toggle_default_off_item){
                    bleList.push({
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: `972003${parseInt(virtualGang).toString(16).pad('00')}00${toggle_default_off_item}`,
                    })
                  }
                  // alert(toggle_default_on_item)
                  // alert(toggle_default_off_item)
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: command,
                  })
                  //action command
                  let sceneId = isset(getThisSceneId(guid)) ? getThisSceneId(guid) : this.getDeviceBleId(guid);
                  let actionCommandItem = `02${core_utils_get_mac_address_from_guid(guid, true)}1305972103${parseInt(virtualGang).toString(16).pad('00')}02`;
                  let actionCommand = `8F1000${parseInt(sceneId).toString(16).pad('00')}${parseInt(actionCommandItem.length/2).toString(16).pad('00')}${actionCommandItem}`;
                  actualActionList[guid]['actionCommand'] = actionCommand;
                  actualActionList[guid]['settingCommand'] = command;
                  actualActionList[guid]['sceneId'] = sceneId;
                  this.actionMap[guid]['actionCommand'] = actionCommand;
                  this.actionMap[guid]['settingCommand'] = command;
                  this.actionMap[guid]['pannelCommand'] = pannelCommand;
                  this.actionMap[guid]['defaultOnCommand'] = defaultOnCommand;
                  this.actionMap[guid]['defaultOffCommand'] = defaultOffCommand;
                  this.actionMap[guid]['sceneId'] = sceneId;
                  if(!isset(this.overallSceneMap['action']['actionList'])){
                    this.overallSceneMap['action']['actionList'] = [];
                  }
                  this.overallSceneMap['action']['actionList'] = this.actionList;
                  if(!isset(this.overallSceneMap['scene_device_location'])){
                    this.overallSceneMap['scene_device_location'] = [];
                  }
                  this.overallSceneMap['scene_device_location'].push({
                    device: guid,
                    storage_id: sceneId,
                  });
                  if (!this.virtualIdList[guid]) {
                    this.virtualIdList[guid] = virtualGang;
                  }
                  if (!isset(this.actionLocation[guid])) { 
                    this.actionLocation[guid] = sceneId;
                  } else {
                    this.actionLocation[guid] = sceneId;
                  }
                  bleList.push({
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: actionCommand,
                  });
                  
                  try{
                    await window.peripheral[guid].write(bleList);
                  }catch(error){
                    postStatus = false;
                    errorStr = error
                  }
                }else{
                  reject(_('no virtual gang'));
                }
              }
              if(postStatus){
                this.actionMap.actionList = this.actionList;
                this.actionMap.title = this.actionName;
                
                resolve(1)
              }else{
                reject(0);
              }
            })
          },
          saveActionOnBle(extraStaus) {
            return new Promise(async (resolve, reject) => {
              let actualActionList = this.strucActionList(this.actionList);
              this.overallSceneMap['action']['actionList'] = this.actionList;
              if (this.mutiwayStatus == 2) {
                actualActionList = this.strucActionList(this.actionList_2);
                this.overallSceneMap['action']['actionList_2'] = this.actionList_2;
              }
              console.log('actualActionList', actualActionList);
              
              let actionCommandList = this.postActionBle(actualActionList);
              //have this case,485 connect the rcu,but the action is not have main rcu
              if (this.mainRcuGuid && !isset(actionCommandList[this.mainRcuGuid])) {
                actionCommandList[this.mainRcuGuid] = '';
              }
              this.actionBleCommandList = actionCommandList;
              console.log('actionCommandList', actionCommandList);
              let sceneObj = erp.info.scene;
              let sceneMap;
              let errorStatus = true;
              let errorMap;
              //in order to get the attach rcu id
              //have this case,485 connect the rcu,but the action is not have main rcu
              for (let i in actionCommandList) {
                let existId;
                for (let i in sceneObj) {
                  if (this.scenePostId == sceneObj[i].name && isset(sceneObj[i].name)) {
                    sceneMap = sceneObj[i];
                  }
                }
                if (isset(sceneMap)) {
                  let list = sceneMap.scene_device_location;
                  let thisRcuIdList = [];
                  list.forEach((zitem) => {
                    if (zitem.device == i) {
                      thisRcuIdList.push(zitem);
                    }
                  });
                  if (this.mutiwayStatus == 2) {
                    existId = thisRcuIdList[1].storage_id;
                  } else {
                    existId = thisRcuIdList[0].storage_id;
                  }
                }
                //alert(existId);
                let sceneId = isset(existId) ? existId : this.getDeviceBleId(i);
                if (i != this.mainRcuGuid) {
                  this.attachRcuId = sceneId;
                  this.attachRcuGuid = i;
                }
                
                this.overallSceneMap['scene_device_location'].push({
                  device: i,
                  storage_id: sceneId,
                });
              }
              for (let i in actionCommandList) {
                let existId;
                let actionItem = actionCommandList[i];
                let idList = [];
                let sceneDeviceLocationList = [];
                let isClickRcuStatus = false;
                let isClickRcuGuid = '';
                let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                subdevices.forEach((subItem) => {
                  if (
                    subItem.name == sub_name &&
                    subItem.device_button_group.startsWith('ONOFF GANG') &&
                    subItem.device_mode == 'RCU Controller'
                  ) {
                    //filter the randar prop
                    isClickRcuStatus = true;
                    isClickRcuGuid = subItem.device;
                    this.actionGuid = subItem.device;
                  }
                });
                for (let i in sceneObj) {
                  if (this.scenePostId == sceneObj[i].name && isset(sceneObj[i].name)) {
                    sceneMap = sceneObj[i];
                  }
                }
                if (isset(sceneMap)) {
                  let list = sceneMap.scene_device_location;
                  let thisRcuIdList = [];
                  list.forEach((zitem) => {
                    if (zitem.device == i) {
                      thisRcuIdList.push(zitem);
                    }
                  });
                  //if scene toggle button,can not get the single id
                  if (this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') {
                    // if(isset(sceneMap.action) && sceneMap.action){
                    //   let thisActionMap = JSON.parse(sceneMap.action);
                    //   if(this.mutiwayStatus == 2){
                    //     //secoend
                    //     let secoendActionMap = thisActionMap.actionMap_2;
                    //     existId = secoendActionMap[i];
                    //   }else{
                    //     let firstActionMap = thisActionMap.actionMap;
                    //     existId = firstActionMap[i];
                    //   }
                    // }
                    if (this.mutiwayStatus == 2) {
                      existId = thisRcuIdList[1].storage_id;
                    } else {
                      existId = thisRcuIdList[0].storage_id;
                    }
                  } else if (this.templateName == 'RCU Curtain') {
                    if (this.mutiwayStatus == 2) {
                      existId = thisRcuIdList[1].storage_id;
                    } else {
                      existId = thisRcuIdList[0].storage_id;
                    }
                  } else {
                    list.forEach((zitem) => {
                      if (zitem.device == i) {
                        existId = zitem.storage_id;
                        return;
                      }
                    });
                  }
                }

                let sceneId = isset(existId) ? existId : this.getDeviceBleId(i);
                if (extraStaus) {
                  sceneId = parseInt(sceneId) + 1;
                }
                // if (this.mainRcuGuid && i == this.mainRcuGuid) {
                //   this.mainRcuId = sceneId;
                // } else if (i == this.actionGuid) {
                //   this.mainRcuId = sceneId;
                // } else {
                //   //this.attachRcuId = sceneId;
                // }
                if (!isset(this.actionLocation[i])) {
                  this.actionLocation[i] = sceneId;
                } else {
                  this.actionLocation[i] = sceneId;
                }
                //click and stop
                if (this.templateName == 'RCU Curtain') {
                  if (this.mutiwayStatus == 2) {
                    this.actionCurtainId_2 = sceneId;
                  } else {
                    this.actionCurtainId_1 = sceneId;
                  }
                }
                console.log('sceneId', sceneId);
                let actioncommand_pre = `8F1000${parseInt(sceneId).toString(16).pad('00')}`;
                let totalActionCommand = `${actioncommand_pre}${actionItem}`;
                if (i == this.mainRcuGuid && Object.keys(actionCommandList).length > 1) {
                  debugger;
                  totalActionCommand = `${totalActionCommand}0b02${core_utils_get_mac_address_from_guid(this.attachRcuGuid, true)}8f0200${parseInt(this.attachRcuId).toString(16).pad('00')}`;
                }
                //if radarExitUnmannedModeStatus
                if(this.templateName == 'Welcome Scene'){
                  //totalActionCommand = this.tindyRadarUnmanedModeCommand(totalActionCommand,i);
                }
                //if the action length more than 240 bytes,should warn the user
                if(totalActionCommand.length > (240+4)*2){
                  app.dialog.alert(`${_('Action length is too long,please check the action.')}`);
                  break;
                }
                console.log('totalActionCommand', totalActionCommand);
                //alert(totalActionCommand);
                if (isClickRcuStatus && isClickRcuGuid == i) {
                  this.randarActionCommand['guid'] = i;
                  this.randarActionCommand['command'] = totalActionCommand;
                }
                try {
                  await window.peripheral[i].write([
                    {
                      service: 'ff80',
                      characteristic: 'ff81',
                      data: totalActionCommand,
                    },
                  ]);
                  if (extraStaus) {
                    this.actionMap[`extra_${i}`] = totalActionCommand;
                  } else {
                    this.actionMap[i] = totalActionCommand;
                  }
                  if (!isset(this.overallSceneMap['action'][i])) {
                    this.overallSceneMap['action'][i] = {};
                  }
                  this.overallSceneMap['action'][i]['actionCommand'] = totalActionCommand;
                  //save id

                  this.simulateScenePostId(i, sceneId);
                } catch (error) {
                  errorStatus = false;
                  errorMap = error;
                }
              }
              if (!errorStatus) {
                reject(errorMap);
              } else {
                //if randar should save the command to the randar rcu
                if (this.templateName == 'RCU Radar') {
                  if (Object.keys(this.actionBleCommandList).length <= 1) {
                    resolve(1);
                  } else {
                    let anotherRcuSecenIdList = [];
                    let guid = this.randarActionCommand['guid'];
                    for (let i in this.actionBleCommandList) {
                      if (i != guid) {
                        anotherRcuSecenIdList.push({
                          guid: i,
                          id: this.actionLocation[i],
                        });
                      }
                    }
                    let anotherCommand = '';
                    for (let i in anotherRcuSecenIdList) {
                      let sceneId = anotherRcuSecenIdList[i].id;
                      let guid = anotherRcuSecenIdList[i].guid;
                      anotherCommand += `0b02${core_utils_get_mac_address_from_guid(guid, true)}8f0200${parseInt(sceneId).toString(16).pad('00')}`;
                    }
                    let postCommand = this.randarActionCommand['command'];
                    postCommand = `${postCommand}${anotherCommand}`;
                    console.log('postCommand', postCommand);
                    try {
                      await window.peripheral[guid].write([
                        {
                          service: 'ff80',
                          characteristic: 'ff81',
                          data: postCommand,
                        },
                      ]);
                      this.actionMap[guid] = postCommand;
                      if (!isset(this.overallSceneMap['action'][guid])) {
                        this.overallSceneMap['action'][guid] = {};
                      }
                      this.overallSceneMap['action'][guid]['actionCommand'] = postCommand;
                      resolve(1);
                    } catch (error) {
                      reject(error);
                    }
                  }
                } else {
                  resolve(1);
                }
              }
            });
            //change the actionList to {guid : '',list:[]}
            return;
            actioncommand = `${actioncommand_pre}${this.postActionBle(actualActionList)}`;
          },
          tindyRadarUnmanedModeCommand(actioncommand,rcuGuid){
            debugger
            let returnCommand = actioncommand;
            if(this.mainRcuGuid && rcuGuid != this.mainRcuGuid){
              return returnCommand;
            }
            if(this.templateName == 'Welcome Scene'){
              //let _command = `1304972106${this.radarExitUnmannedModeStatus ? '00' : '01'}`;
              // 8F1700+index
              let _command = `13048f17${this.radarExitUnmannedModeStatus ? '01' : '00'}${'01'}`;
              //find the mqtt device 
              let profile_devices = cloneDeep(erp.info.profile.profile_device);
              let mqttDevice = [];
              for(let i in this.deviceActionCommandList){
                profile_devices.forEach(item=>{
                  if(item.device == i && item.gateway && item.device_model != 'YO780'){
                    mqttDevice.push(item);
                  }
                })
              }
              //contact the list 
              let rcu_mac = core_utils_get_mac_address_from_guid(rcuGuid,true);
              mqttDevice.forEach(item=>{
                let device_mac = core_utils_get_mac_address_from_guid(item.device,true);
                let _command_item = `02${rcu_mac}15${device_mac}${(_command.length/2).toString(16).pad('00')}${_command}`;
                returnCommand += `${(_command_item.length/2).toString(16).pad('00')}${_command_item}`;
              })
            }
            return returnCommand;
          },
          getCurrentSceneId(guid) {
            let sceneObj = erp.info.scene;
            let sceneMap;
            let existId;
            for (let i in sceneObj) {
              if (this.scenePostId == sceneObj[i].name) {
                sceneMap = sceneObj[i];
              }
            }
            if (isset(sceneMap)) {
              let list = sceneMap.scene_device_location;
              list.forEach((zitem) => {
                if (zitem.device == guid) {
                  existId = zitem.storage_id;
                }
              });
            }
            return existId;
          },
          async nextStep(index) {
            if (index == 1) {
              //want to next to step 2
              //verifiy the scene name
              if (!this.sceneName) {
                app.dialog.alert(`${_('Scene name must be filled in.')}`);
                return;
              } else {
                console.log($('input[name="banner"]').val());
                if ($('input[name="banner"]').val()) {
                  this.uploadImage = this.uploadImage ? this.uploadImage : `${erp.setting.app_api_url}${$('input[name="banner"]').val()}`;
                }
                //app.dialog.preloader(`${_("Rcu Connecting")}`);
                if (this.templateName == 'Multiway Switch') {
                  this.index = 8;
                  return;
                } else if (this.templateName == 'Scene Banner' || this.templateName == 'Favorite Scene') {
                  this.index = 10;
                  this.initDevices();
                  return;
                } else if (this.templateName == 'Room Scene Button') {
                  //check the name length
                  if (this.sceneName.length > 3) {
                    app.dialog.alert(`${_('Scene name can only be three letters or characters.')}`);
                    return;
                  }
                  this.index = 12;
                  this.initDevices();
                  return;
                } else if (this.templateName == 'Gateway Scene') {
                  this.index = 2;
                  return;
                } else if (this.templateName == 'Welcome Scene') {
                  this.index = 14;
                  this.scrollItem(110 * 2);
                  return;
                }
                let postPleStatus = true;
                try {
                  if ($('input[name="banner"]').val()) {
                    this.uploadImage = this.uploadImage ? this.uploadImage : `${erp.setting.app_api_url}${$('input[name="banner"]').val()}`;
                  }
                  // for(let i in this.rcuList){
                  //   if(this.rcuList[i].ischeck){
                  //     let guid = this.rcuList[i].guid;
                  //     if (peripheral[guid].prop.connected) {
                  //       await peripheral[guid].disconnect();
                  //       await this.sleep(1000);
                  //     }
                  //     await peripheral[guid].connect();
                  //     app.dialog.close();
                  //   }
                  // }
                  if (this.virtualStatus) {
                    setTimeout(() => {
                      $(`input[name="virtual_button"]`).trigger('click');
                    }, 500);
                  }
                } catch (error) {
                  app.dialog.close();
                  console.log('error', error);
                  postPleStatus = false;
                  this.index = 1;
                  app.dialog.confirm(
                    `${_('Rcu connect failed,reconnect?')}`,
                    () => {
                      this.nextStep(1);
                    },
                    () => {}
                  );
                  //app.dialog.alert(_("Rcu connect failed"))
                }
                if (postPleStatus == true) {
                  if ((this.templateName == 'RCU Scene Toggle' || this.templateName == 'RCU Scene Toggle - Save Status') && this.index > 2) {
                    this.index = 7;
                  }else if(this.templateName == 'RCU Scene Button'){
                    this.index = 15;
                    return;
                  }else if(this.templateName == 'RCU Scene New Toggle'){
                    this.scrollItem(110 * 3);
                    this.index = 2; 
                    return;
                  } else {
                    this.index = 2;
                  }
                  //this.scrollItem(110 * 3);
                }
              }
            } else if (index == 2) {
              if (this.actionList.length == 0) {
                app.dialog.alert(_('Action must be filled in.'));
                return;
              } else {
                this.saveActionInRcu();
              }
            } else if (index == 3) {
              if (this.trigger.length == 0) {
                app.dialog.alert(_('Trigger must be filled in.'));
                return;
              } else {
                this.index = 4;
                this.scrollItem(110 * 2);
              }
            } else if (index == 5) {
              this.saveTriggerOnble();
            } else if (index == 6) {
              this.buttonAndSetting();
            } else if (index == 7) {
              //second scene name
              if (!this.secondSceneName) {
                app.dialog.alert(`${_('Scene name must be filled in.')}`);
                return;
              } else {
                this.index = 7;
                this.scrollItem(110 * 2);
              }
            } else if (index == 8) {
              if (this.actionList_2.length == 0) {
                app.dialog.alert(_('Action must be filled in.'));
                return;
              } else {
                this.saveActionInRcu();
              }
            }else if(index == 14){
              //save the check
              //check if no choose
              if(!this.radarEnterUnmannedModeStatus && !this.radarExitUnmannedModeStatus){
                app.dialog.alert(_('Missing required options.'));
                return
              }
              if(isset(this.overallSceneMap['ui_configuration'])){
                this.overallSceneMap['ui_configuration']['radarEnterUnmannedModeStatus'] = this.radarEnterUnmannedModeStatus;
                this.overallSceneMap['ui_configuration']['radarExitUnmannedModeStatus'] = this.radarExitUnmannedModeStatus;
              }
              //save the device setting
              await this.saveWelcomeMode();              
              this.index = 2;
              //this.scrollItem(110 * 2);
            }else if(index == 15){
              //save the scene status
              if(isset(this.overallSceneMap['ui_configuration'])){
                this.overallSceneMap['ui_configuration']['deviceStatusList'] = this.deviceStatusList;
              }else{
                this.overallSceneMap['ui_configuration'] = {}
                this.overallSceneMap['ui_configuration']['deviceStatusList'] = this.deviceStatusList;
              }
              this.index = 2;
              this.scrollItem(110 * 3); 
            }
          },
          toSceneList(title, type, operateType) {
            let url = `/mobile-app/choose-scene-page?type=${type}&title=${encodeURIComponent(tran(title))}`;
            mainView.router.navigate(url);
          },
          toRoomList(title, type, mutiwayStatus) {
            if (type == 4) {
              let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
              this.virtualList = [];
              profile_subdevices.forEach((item) => {
                if (item.device_button_group == 'SCENE MUTIWAY ONOFF GANG1') {
                  item.display = false;
                  item.ref = 0;
                  item.img_url = `https://my.yoswit.com/files/YO780.svg`;
                  this.virtualList.push(item);
                }
              });
              if (this.virtualList.length == 0) {
                app.dialog.alert(_('No option for that condition.'));
                return;
              }
              this.virtualPick = app.picker.create({
                inputEl: 'demo-picker-describe',
                rotateEffect: true,
                cols: [
                  {
                    textAlign: 'left',
                    values: this.virtualList.map((item) => item.title),
                  },
                  {
                    values: ['ON', 'OFF', 'TOGGLE'],
                  },
                ],
                on: {
                  change: (_, value) => {
                    console.log(value);
                    let title = value[0];
                    let ref = value[1];
                    this.virtualList.forEach((item) => {
                      if (item.title == title) {
                        item.display = true;
                        item.ref = ref == 'ON' ? 1 : 0;
                      } else {
                        item.display = false;
                      }
                    });
                  },
                },
              });
              this.virtualPick.open();
            } else if (type == 1) {
              let that = this;
              console.log('Choose Condition');
              if (this.trigger.length > 0 && this.templateName == 'RCU Radar') {
                let dialogBox = app.dialog.create({
                  title: 'Choose Condition',
                  buttons: [{ text: 'Or' }, { text: 'And' }],
                  onClick: (dialog, index) => {
                    that.triggerCondition = index == 0 ? 1 : 2;
                    mainView.router.navigate(`/mobile-app/scene-room-device?type=${type}`);
                  },
                  verticalButtons: true,
                });
                dialogBox.open();
              } else {
                mainView.router.navigate(`/mobile-app/scene-room-device?type=${type}`);
              }
            } else if (type == 3) {
              mainView.router.navigate(`/mobile-app/timer-picker-page?title=${tran(title)}&type=${type}`);
            } else {
              //if gateway scene
              let url = `/mobile-app/scene-room-device?type=${type}&title=${encodeURIComponent(tran(title))}&target_guid=${this.actionGuid}&template_name=${encodeURIComponent(this.templateName)}`;
              if (this.templateName == 'Gateway Scene') {
                url += `&gateway_topic=${this.gatewayTopic}`;
              }
              mainView.router.navigate(url);
            }
          },
          findMissingNumber(arr) {
            if (arr.length === 0) {
              return 1;
            }
            arr.sort((a, b) => a - b);
            for (let i = 0; i < arr.length - 1; i++) {
              if (arr[i + 1] - arr[i] > 1) {
                return this.formatNumber(arr[i] + 1);
              }
            }
            return this.formatNumber(arr[arr.length - 1] + 1);
          },
          formatNumber(num) {
            //in case format anther way
            return num;
          },
          //save extra trigger and action
          saveExtraTriggerAndAction() {
            return new Promise((resolve, reject) => {
              app.dialog.preloader(`${_('Checking...')}`);
              //save the action
              if (this.isExtraStatus) {
                this.isRelease = true;
                this.saveActionOnBle(true)
                  .then(() => {
                    let url = encodeURI(`/api/resource/Scene/${this.scenePostId}`);
                    for (let i in this.actionLocation) {
                      this.sceneDeviceLocation.push({
                        device: i,
                        storage_id: parseInt(this.actionLocation[i]) + 1,
                      });
                    }
                    return http2.request(url, {
                      method: 'PUT',
                      serializer: 'json',
                      responseType: 'json',
                      debug: true,
                      data: {
                        scene_device_location: this.sceneDeviceLocation,
                      },
                    });
                  })
                  .then(() => {
                    app.dialog.close();
                    resolve(1);
                  })
                  .catch((error) => {
                    app.dialog.close();
                    reject(error);
                  });
              } else {
                app.dialog.close();
                resolve(1);
              }
            });
          },
          //this is the new radar command
          radarNewCommand(scene_id, listIndex) {
            let typeIndex = '02';
            let randarList = [];
            let triggerCommand = ``;
            let pre_command = `8F2000${scene_id}${listIndex}`;
            let total_command = ``;
            let virtualCommand = ``;
            let totalVirtualCommand = ``;
            this.trigger.forEach((item) => {
              if (isset(item.condition) && item.condition && item.condition == 1) {
                this.triggerCondition = 1;//or condition is 2,and condition is 1
              }
              if (item.button_group == '4in1 Sensor' || item.button_group.startsWith('RCU INPUT')) {
                randarList.push(item);
              }
            });
            //fliter the randarList,close to the door should be the first one
            let newRandarList = randarList.sort((a, b) => {
              if (a.is_close_to_door) {
                return -1;
              }
              return 1;
            });
            let item_command = '';
            let pre_item_command = `002c000000000000`;
            newRandarList.forEach((item, index) => {
              let guid = item.guid;
              let mac = core_utils_get_mac_address_from_guid(guid, true);
              let ref = item.ref;
              let radar_type = '01';
              let gang = 1;
              let is_close_to_door = item.is_close_to_door;
              if (item.button_group.startsWith('RCU INPUT')) {
                gang = item.button_group.replace('RCU INPUT', '');
                if(!ref){
                  radar_type = '00';
                }
                pre_item_command = `002c000000000000${radar_type}`;
                item_command += `${parseInt(gang).toString(16).pad('00')}${is_close_to_door ? '01' : '00'}`;
              }
              //total_command += this_command;
            });
            let _length_command = `${pre_item_command}${item_command}`;
            total_command = `${pre_command}${parseInt(_length_command.length / 2).toString(16).pad('00')}${_length_command}`;
            return total_command;
          },
          //this is the old radar command
          randarCommand(scene_id, listIndex) {
            let typeIndex = '02';
            let randarList = [];
            let triggerCommand = ``;
            let pre_command = `8F2000${scene_id}${listIndex}`;
            let total_command = ``;
            let virtualCommand = ``;
            let totalVirtualCommand = ``;
            this.trigger.forEach((item) => {
              if (isset(item.condition) && item.condition && item.condition == 1) {
                this.triggerCondition = 1;
              }
              if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor' || item.button_group.startsWith('RCU INPUT')) {
                randarList.push(item);
              }
            });
            randarList.forEach((item, index) => {
              let guid = item.guid;
              let mac = core_utils_get_mac_address_from_guid(guid, true);
              let ref = item.ref;
              let this_command = '';
              //in that distinguish the value and the other value(temp,templess,hum,hum_less)
              if (isset(ref)) {
                if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor' || item.button_group.startsWith('RCU INPUT')) {
                  typeIndex = `22`; //34 is SCENE TYPE BUTTON V3
                  let opcode = '00';
                  if (this.triggerCondition == 1 && index != randarList.length - 1) {
                    opcode = 'tt';
                  }
                  let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                  let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                  if (item.button_group.startsWith('RCU INPUT')) {
                    gang = item.button_group.replace('RCU INPUT', '');
                  }
                  triggerCommand = `${opcode}${typeIndex}${rcu_mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                }
              }
            });
            console.log('total_command', total_command);

            this.trigger.forEach((item) => {
              let guid = item.guid;
              let mac = core_utils_get_mac_address_from_guid(guid, true);
              let ref = item.ref;
              if (item.button_group == 'SCENE MUTIWAY ONOFF GANG1') {
                typeIndex = '1f';
                let opcode = '00';
                let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                virtualCommand = `${opcode}${typeIndex}${rcu_mac}00${ref.toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
                virtualCommand = `${(virtualCommand.length / 2).toString(16).pad('00')}${virtualCommand}`;
                totalVirtualCommand += virtualCommand;
              }
            });
            if (this.oneOnly) {
              typeIndex = '1f';
              let opcode = '00';
              let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
              let gang = parseInt(this.actionId);
              let ref = 0;
              virtualCommand = `${opcode}${typeIndex}${rcu_mac}00${ref.toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
              virtualCommand = `${(virtualCommand.length / 2).toString(16).pad('00')}${virtualCommand}`;
              totalVirtualCommand += virtualCommand;
            }
            return `${pre_command}${this.replaceTTWithLength(total_command)}${totalVirtualCommand}`;
          },
          tidyCommand(scene_id, listIndex, item, index) {
            let isOldChip = false;
            let typeIndex = '02';
            let triggerCommand = ``;
            let pre_command = `8F2000${scene_id}${listIndex}`;
            let total_command = ``;
            let guid = item.guid;
            let mac = core_utils_get_mac_address_from_guid(guid, true);
            let ref = item.ref;
            let this_command = '';
            let virtualCommand = ``;
            let totalVirtualCommand = ``;
            //in that distinguish the value and the other value(temp,templess,hum,hum_less)
            if (isset(ref)) {
              let sensor_command = ``;
              if (item.mode == 'RF Sensor' || item.mode == 'Radar Sensor') {
                if (this.templateName == 'RCU Radar' || this.templateName == 'RCU Scene Button') {
                  typeIndex = `01`;
                  let opcode = '00';
                  if (this.triggerCondition == 1 && index != this.trigger.length - 1) {
                    opcode = 'tt';
                  }
                  let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
                  let gang = parseInt(item.config && item.config != 'undefined' ? item.config : 1);
                  triggerCommand = `${opcode}${typeIndex}${rcu_mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                } else {
                  typeIndex = `02`;
                  let opcode = '00';
                  if (this.triggerCondition == 1 && index != this.trigger.length - 1) {
                    opcode = 'tt';
                  }
                  triggerCommand = `${opcode}${typeIndex}${mac}${parseInt(gang).toString(16).pad('00')}${ref.toString(16).pad('00')}`;
                  triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                  total_command += triggerCommand;
                }
              }
              if (item.button_group.startsWith('ONOFF GANG')) {
                let gang = item.button_group.replace('ONOFF GANG', '') * 1;
                if (item.model == 'YO780-Scene-4G') {
                  if (gang == 2) {
                    gang = 3;
                  } else if (gang == 3) {
                    gang = 4;
                  } else if (gang == 4) {
                    gang = 6;
                  }
                }
                typeIndex = `01`;
                let this_ref = '00';
                let runTime = '';
                if (ref) {
                  //this_ref = Math.pow(2, gang*1 - 1).toString(16).pad('00');
                  if (ref == 1 || ref == 2) {
                    this_ref = '01';
                  } else if (ref == 4) {
                    this_ref = '04';
                    typeIndex = '21';
                    runTime = '0f';
                  } else if (ref == 3) {
                    this_ref = '01';
                    //add a new trigger in list
                    let newJson = cloneDeep(item);
                    newJson.ref = 5;
                    this.extraTriggerList.push(newJson);
                  } else if (ref == 5) {
                    this.isExtraStatus = true;
                    this_ref = '00';
                  } else {
                    this_ref = '00';
                  }
                }
                let opcode = '00'; //this params used check "or" condition,must be set data length after it;
                if (this.triggerCondition == 1 && index != this.trigger.length - 1) {
                  opcode = 'tt';
                }
                triggerCommand = `${opcode}${typeIndex}${mac}${parseInt(gang).toString(16).pad('00')}${this_ref}${runTime}`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
              if (item.button_group.startsWith('SCENE MUTIWAY ONOFF GANG')) {
                typeIndex = `1f`;
                let this_ref = item.ref;
                let opcode = '00';
                let gang = isset(item.config) ? item.config : parseInt(this.actionLocation[item.guid]);
                debugger;
                let $thisCommand = `${opcode}${typeIndex}${mac}00${parseInt(this_ref).toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
                $thisCommand = `${($thisCommand.length / 2).toString(16).pad('00')}${$thisCommand}`;
                total_command += $thisCommand;
              }
              if (item.button_group.startsWith('DIMMING')) {
                typeIndex = `1a`;
                let this_ref = '00';
                if (ref) {
                  this_ref = `02`;
                }
                triggerCommand = `${typeIndex}${mac}${this_ref}00`;
                triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                total_command += triggerCommand;
              }
              if (item.button_group.startsWith('Door Open')) {
                //if the ti chip,the command is like
                //8f01008d010200053e49168d3a0802
                //only support 8c8d8e8f
                //typeIndex = `04`;
                typeIndex = `05`;
                isOldChip = true;
                let opcode = '00';
                //let this_ref = '00';
                let this_ref = '7b';
                if (ref) {
                  //this_ref = `01`;
                  this_ref = '7c';
                }
                let this_id = '';
                if (scene_id == '01') {
                  this_id = '8c';
                } else if (scene_id == '02') {
                  this_id = '8d';
                } else if (scene_id == '03') {
                  this_id = '8e';
                } else if (scene_id == '04') {
                  this_id = '8f';
                }
                // triggerCommand = `${opcode}${typeIndex}${mac}${this_ref}`;
                // triggerCommand = `${(triggerCommand.length / 2).toString(16).pad('00')}${triggerCommand}`;
                // total_command += triggerCommand;
                triggerCommand = `8f0100${this_id}010200${typeIndex}${core_utils_get_mac_address_from_guid(this.gatewayMapGuid, true)}${parseInt(this.actionLocation[this.gatewayMapGuid]).toString(16).pad('00')}`;
                total_command = `${triggerCommand}&&8f0300${this_ref}${this_id}`;
              }
            }
            if (item.temp || item.temp_less) {
              typeIndex = '05';
              if (item.temp) {
                let temp_command = `${typeIndex}${mac}02${core_utils_float_ieee_convert(item.temp)}`;
                this_command = `${(temp_command.length / 2).toString(16).pad('00')}${temp_command}`;
                triggerCommand += this_command;
              }
              if (item.temp_less) {
                let temp_less_command = `${typeIndex}${mac}01${core_utils_float_ieee_convert(item.temp_less)}`;
                this_command = `${(temp_less_command.length / 2).toString(16).pad('00')}${temp_less_command}`;
                triggerCommand += this_command;
              }
              total_command += triggerCommand;
            }
            if (item.hum || item.hum_less) {
              let hum_command = ``;
              typeIndex = '06';
              if (item.hum) {
                let this_hum_command = `${typeIndex}${mac}02${core_utils_float_ieee_convert(item.hum)}`;
                hum_command = `${(this_hum_command.length / 2).toString(16).pad('00')}${this_hum_command}`;
                triggerCommand += hum_command;
              }
              if (item.hum_less) {
                let this_hum_less_command = `${typeIndex}${mac}01${core_utils_float_ieee_convert(item.hum_less)}`;
                hum_command = `${(this_hum_less_command.length / 2).toString(16).pad('00')}${this_hum_less_command}`;
                triggerCommand += hum_command;
              }
              total_command += triggerCommand;
            }
            console.log('total_command', total_command);
            if (this.oneOnly) {
              typeIndex = '1f';
              let opcode = '00';
              let rcu_mac = core_utils_get_mac_address_from_guid(this.actionGuid, true);
              let gang = parseInt(this.actionId);
              let ref = 0;
              virtualCommand = `${opcode}${typeIndex}${rcu_mac}00${ref.toString(16).pad('00')}13${parseInt(gang).toString(16).pad('00')}`;
              virtualCommand = `${(virtualCommand.length / 2).toString(16).pad('00')}${virtualCommand}`;
              totalVirtualCommand += virtualCommand;
            }
            if (isOldChip) {
              return `${total_command}`;
            } else {
              return `${pre_command}${this.replaceTTWithLength(total_command)}${totalVirtualCommand}`;
            }
          },
          replaceTTWithLength(str) {
            let list = str.split('tt');
            console.log('list', list);
            if (list.length == 1) {
              return str;
            }
            let command = ``;
            let total = 0;
            let $length = list.length - 1;
            for (let i = $length; i >= 0; i--) {
              if (i == $length) {
                let index = (list[i].length / 2).toString(16).pad('00');
                command = `${index}${list[i]}`;
              } else if (i == 0) {
                command = `${list[i]}${command}`;
              } else {
                let index = ((list[i].length + command.length) / 2).toString(16).pad('00');
                command = `${index}${list[i]}${command}`;
              }
            }
            return command;
          },
          //defalut scene
          showButton(item) {
            item.chooseStatus = !item.chooseStatus;
            if (!item.chooseStatus) {
              item.mainType = 1;
              item.buttonBoxType = 0;
              return;
            }
            //depend on differ mode show differ template
            let button_group = item.device_button_group;
            if (button_group.startsWith('ONOFF GANG') || button_group.startsWith('RCU ONOFF GANG')) {
              item.mainType = 2;
            } else if (button_group.startsWith('DIMMING') || button_group.startsWith('RCU DIMMING')) {
              item.mainType = 2;
              item.buttonBoxType = 1;
              this.initRangeBar(item.device, item.device_button_group);
            } else if (
              button_group.startsWith('OPENCLOSE UART') ||
              button_group.startsWith('OPENCLOSE UART REVERSE') ||
              button_group.startsWith('OPENCLOSE WIFI UART') ||
              button_group.startsWith('OPENCLOSE WIFI UART REVERSE')
            ) {
              item.mainType = 7;
              item.buttonBoxType = 2;
              this.initRangeBar(item.device, item.device_button_group, 100);
            } else if (button_group.startsWith('OPENCLOSE GANG') || button_group.startsWith('RCU OPENCLOSE GANG')) {
              item.mainType = 7;
              item.buttonBoxType = 2;
              this.initRangeBar(item.device, item.device_button_group, 100);
            } else if (button_group.startsWith('TOGGLE GANG')) {
              item.mainType = 4;
            } else if (button_group.startsWith('Thermostat')) {
              item.mainType = 2;
              item.buttonBoxType = 3;
            } else if (button_group.startsWith('Air Conditioner')) {
            }
          },
          onOffItem(item) {
            console.log(item);
            let barStatus = false;
            let barValue = 0;
            let hideBottomBar = null;
            if (item.ref == 0) {
              item.ref = 1;
              barValue = 100;
              if (isset(hideBottomBar)) hideBottomBar = false;
            } else {
              item.ref = 0;
              barValue = 0;
              if (isset(hideBottomBar)) hideBottomBar = true;
            }
            if (item.device_button_group.startsWith('DIMMING') || item.device_button_group.startsWith('RCU DIMMING')) {
              barStatus = true;
              if (item.ref == 1) {
                item.ref = barValue;
              }
            }
            if (item.device_button_group.startsWith('Thermostat') && item.ref == 0) {
              hideBottomBar = true;
            } else if (item.device_button_group.startsWith('Thermostat') && item.ref == 1) {
              hideBottomBar = false;
            }
            if (barStatus) {
              this.changeBarUI(item.device, item.device_button_group, barValue);
            }
            if (isset(hideBottomBar)) {
              if (hideBottomBar) {
                item.buttonBoxType = 0;
              } else {
                item.buttonBoxType = 3;
              }
            }
          },
          openCloseItem(item) {
            if (item.ref == 0) {
              barValue = 100;
              item.ref = barValue;
            } else {
              item.ref = 0;
              barValue = 0;
            }
            this.changeBarUI(item.device, item.device_button_group, barValue);
          },
          changeBarUI(guid, device_button_group, present_value) {
            $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`)
              .find('.range-bar-active')
              .css({
                width: present_value + '%',
              });
            $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`)
              .find('.range-knob-wrap')
              .css({
                left: present_value + '%',
              });
            if (present_value > 1) {
              $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`).removeClass('range-slider-min');
            } else {
              $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`).addClass('range-slider-min');
            }
          },
          initRangeBar(guid, button_group, value) {
            setTimeout(() => {
              console.log($(`.range-slider-scene[guid="${guid}"][button_group="${button_group}"]`));
              let range_silder = app.range.create({
                el: `.range-slider-scene[guid="${guid}"][button_group="${button_group}"]`,
                value: isset(value) ? value : 100,
                min: 0,
                max: 100,
                draggableBar: false,
                label: true,
                step: 1,
                scale: true,
                scaleSteps: 5,
                scaleSubSteps: 4,
                on: {
                  changed: this.rangeChangeFunDimming,
                },
              });
            }, 300);
          },
          rangeChangeFunDimming(element) {
            console.log(element);
            let value = element.value;
            let el = element.$el;
            let subName = $(el).attr('name');
            console.log(subName);
            this.subdevices.forEach((kitem) => {
              if (kitem.name === subName) {
                kitem.ref = value;
              }
            });
          },
          clickThermostatChange(item, click_type) {
            console.log(item, click_type);
            let data = '';
            let post_value = ``;
            switch (click_type) {
              case 'mode':
                if (item.modeStr == 1) {
                  item.modeStr = 0;
                } else if (item.modeStr == 2) {
                  let devices = cloneDeep(erp.info.device);
                  let device = devices[item.device];
                  let mode_seetting = '';
                  if (isset(device)) {
                    let list = device.settings;
                    list.forEach((item) => {
                      if (item.setting_type === 'mode_selection') {
                        mode_seetting = item.setting;
                      }
                    });
                  }
                  if (mode_seetting == 'Cooling') {
                    item.modeStr = 0;
                  } else {
                    item.modeStr = 1;
                  }
                } else if (item.modeStr == 0) {
                  item.modeStr = 2;
                }
                data = '9404000001' + parseInt(item.modeStr).toString(16).pad('00');
                post_value = item.modeStr;
                break;
              case 'fan':
                if (item.speedVaule == 4) {
                  if (item.modeStr == 0) {
                    item.speedVaule = 2;
                  } else {
                    item.speedVaule = 1;
                  }
                } else {
                  item.speedVaule++;
                }
                data = '9405000001' + parseInt(item.speedVaule).toString(16).pad('00');
                post_value = item.speedVaule;
                break;
              case 'reduce':
                if (item.temperature != 5) {
                  item.temperature--;
                }
                data = '9406000001' + parseInt(item.temperature).toString(16).pad('00');
                post_value = item.temperature;
                break;
              case 'add':
                if (item.temperature != 32) {
                  item.temperature++;
                }
                data = '9406000001' + parseInt(item.temperature).toString(16).pad('00');
                post_value = item.temperature;
                break;
            }
          },
          async tindyCommandAndPostErp() {
            //tindy the command and save in erp
            app.dialog.preloader();
            if (this.templateName == 'Favorite Scene') {
              let url = `/api/resource/User Settings/${users[users.current].app_id}-${users[users.current].user_id}`;
              let dataList = [];
              dataList.push({
                favour_scene: this.subdevices,
                id: 1,
                title: this.sceneName,
              });
              try {
                let userSetting = await http2.request(encodeURI(url), {
                  method: 'PUT',
                  serializer: 'json',
                  responseType: 'json',
                  debug: true,
                  data: {
                    favour_scene: JSON.stringify(dataList),
                  },
                });
              } catch (error) {
                app.dialog.close();
                app.dialog.alert(error);
                return;
              }
              app.dialog.close();
              mainView.router.back();
              return;
            }
            let devices = this.subdevices.filter((item) => item.chooseStatus);
            // devices.forEach(item=>{
            //   let { device_button_group, name, device, ref,device_mode ,device_model} = item;
            //   let mackey = core_utils_get_mac_address_from_guid(device, true);
            //   let command = ``;
            //   //on off and the rcu on off

            // })
            //save in the action
            debugger;
            try {
              let post_scene_data = {
                title: this.sceneName,
                profile: erp.info.profile.name,
                profile_subdevice: '',
                scene_template: this.templateName,
                trigger: JSON.stringify({}),
                action: JSON.stringify(devices),
                ui_configuration: JSON.stringify({}),
                condition: JSON.stringify(this.roomList),
                image: this.uploadImage,
                is_enabled: this.templateName == 'Room Scene Button' ? 1 : 0,
              };
              await this.postScene(post_scene_data);
              await ha_profile_ready();
              window.globalUpdate = true;
              app.dialog.close();
              mainView.router.back();
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(error);
            }
          },
          //tindy the old devce command,this case only for the gateway scene
          tindyOldDeviceCommand(list) {
            //list is the trigger list
            //attention:the gateway must be network with the door senser
          },
        },
        computed: {
          dealwithRef() {
            return function (item) {
              let mode = item.mode || item.device_mode;
              let ref = item.ref;
              let status = '';
              let device_button_group = item.device_button_group;
              if (mode == 'On Off Switch' || mode == 'RCU Scene Button' || mode == 'Hdmicec') {
                if (ref == 1) {
                  status = 'ON';
                } else if (ref == 2) {
                  status = 'TOGGLE';
                } else {
                  status = 'OFF';
                }
              } else if (mode == 'RCU Controller') {
                if (ref == 1) {
                  status = 'ON';
                } else if (ref == 2) {
                  status = 'TOGGLE';
                } else if (ref == 31) {
                  status = 'CLEAR ON';
                } else if (ref == 32) {
                  status = 'DND ON';
                } else if (ref == 34) {
                  status = 'CLEAR OFF';
                } else if (ref == 35) {
                  status = 'DND OFF';
                } else {
                  status = 'OFF';
                }
              } else if (mode == 'RF Sensor' || mode == 'Radar Sensor') {
                if (ref == 1) {
                  status = 'OCCUPIED';
                } else {
                  status = 'UNOCCUPIED';
                }
              } else if (device_button_group.includes('DIMMING')) {
                if (item.turnlight == 4) {
                  status = 'ON/100%';
                  if (ref > 1) {
                    status = `ON/${parseInt((ref / 255) * 100)}%`;
                  }
                } else if (item.turnlight == 5) {
                  status = 'OFF';
                } else if (item.turnlight == 2) {
                  status = 'TOGGLE';
                } else if (item.turnlight == 3) {
                  status = 'BRIGHTEN';
                } else if (item.turnlight == 1) {
                  status = 'DIM';
                }
              } else if (device_button_group.startsWith('OPENCLOSE UART') || device_button_group.startsWith('OPENCLOSE WIFI UART')) {
                if (ref > 1 && ref != 2) {
                  status = 'OPEN';
                } else if (ref == 2) {
                  status = 'PAUSE';
                } else {
                  status = 'CLOSE';
                }
              } else if (mode == 'Thermostat') {
                if (item.temperature) {
                  console.log(item.ref == '0');
                  let mode_text = item.modeStr == 2 ? 'COOL' : item.modeStr == 1 ? 'HOT' : item.modeStr == 0 ? 'AUTO' : 'UNSET';
                  let fan_text =
                    item.speedVaule == 4 ? '3 SPEED' : item.speedVaule == 3 ? '2 SPEED' : item.speedVaule == 2 ? '1 SPEED' : 'AUTO';
                  status = `${item.ref == '0' ? 'Off' : 'On'}/${item.temperature}`;
                }
              } else if (mode == 'IR' || mode == 'On Off IR') {
                if (item.ir_temp) {
                  console.log(item.ref == '0');
                  status = `${item.ir_ref == '0' ? 'OFF' : 'ON'}/${item.ir_mode_text}/${item.ir_fan_text}/${item.ir_swing_text}/${
                    item.ir_temp_text
                  }`;
                }
              }
              return status;
            };
          },
          dealWithType() {
            return function (item) {
              let showStr = '';
              if (!item.mainType) {
                showStr = 'UNSELECTED';
              } else if (item.mainType == 2) {
                showStr = 'TYPE/ONOFF';
              } else if (item.mainType == 4) {
                showStr = 'TYPE/TOGGLE';
              } else if (item.mainType == 5) {
                showStr = 'TYPE/BRIGHTEN';
              } else if (item.mainType == 6) {
                showStr = 'TYPE/DIM';
              } else if (item.mainType == 7) {
                showStr = 'TYPE/OPENCLOSE';
              }
              return showStr;
            };
          },
          dealWithThermostat() {
            return function (modeStr) {
              let showStr = '';
              if (modeStr == 0) {
                showStr = 4;
              } else if (modeStr == 2) {
                showStr = 2;
              } else if (modeStr == 1) {
                showStr = 5;
              }
              return showStr;
            };
          },
          computerWeek() {
            return function (item) {
              let weekText = ``;
              let showText = [];
              let list = item.weeks;
              let allDayStatus = false;
              let weekTextList = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
              list.forEach((item) => {
                if (item == '') {
                  allDayStatus = true;
                } else {
                  showText.push(_(weekTextList[parseInt(item)]));
                }
              });
              if (allDayStatus) {
                weekText = _(`Every Day`);
              } else {
                weekText = showText.join(',');
              }
              return weekText;
            };
          },
          computerTime() {
            return function (item) {
              let timeText = '';
              if (item.typetime == 1) {
                timeText = _(`All Day`);
              } else {
                if (item.start_time >= item.end_time) {
                  timeText = `${item.start_time} - ${item.end_time}(${_('Next Day')})`;
                } else {
                  timeText = `${item.start_time} - ${item.end_time}`;
                }
              }
              return timeText;
            };
          },
        },
        beforeDestroy() {
          emitter.off('trigger_save');
          emitter.off('save_action');
          emitter.off('save_device_status');
          this.$actionSheetMap = null;
          //emitter.off('set_timmer');
        },
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  .device-hidden {
    display: none;
  }
  .template-info {
    font-size: 12px;
    text-align: right;
    margin-bottom: 10px;
  }
  .radio-box {
    height: 75px;
    background-color: #fff;
    margin-bottom: 10px;
  }
  .item-radio {
    height: 100%;
  }
  .timer-item {
    height: 100%;
    padding-right: 10px;
  }
  .list ul::before,
  .list ul::after {
    content: none;
  }
  .add-box {
    height: 70px;
    padding: 0px 15px;
    color: var(--f7-theme-color);
  }
  .dialog-buttons .dialog-button {
    width: 100% !important;
  }
  .scnen-template {
    height: 80px;
    margin-bottom: 15px;
    border-radius: 15px;
    padding: 10px 15px;
  }
  .scnen-template-title span {
    color: #fff;
    font-size: 16px;
  }
  .scnen-template-title p {
    color: #fff;
  }
  .scnen-template-icon {
    width: 60px;
    height: 60px;
    background-color: #fff;
    z-index: 99;
    border-radius: 50%;
  }
  .check-box {
  }
  .toolbar-inner .button {
    min-width: 110px;
    border-radius: inherit;
  }
  .off_flag > .button.onoff {
    background-color: var(--f7-block-strong-bg-color);
    color: #8e8d93;
    border-color: #8e8d93;
  }
  .off_flag > .button.onoff:after {
    content: 'OFF';
  }
</style>
