<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Rcu Active Configuration') }}</div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="main-box">
          <div class="toolbar-box" style="padding: 0 15px; margin-top: 15px" v-if="stepList.length">
            <div class="toolbar tabbar tabbar-scrollable" style="height: 60px">
              <div class="toolbar-inner scene-toolbar-inner">
                <button
                  v-for="(item,index) in stepList"
                  :key="item.id"
                  :class="item.isActive?'button-active button':'button'"
                  v-on:click="toTab(item.relatedIndex)"
                >
                  {{_('Step')}} {{item.name}}
                </button>
              </div>
            </div>
          </div>
          <div class="tabs">
            <div id="step-1" class="view tab view-main" :class="[index == 1 ? 'tab-active' : '']" v-if="index == 1">
              <div class="card data-table" v-if="!deviceSettingStatus">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Activate Rcu Slot")}}</div>
                <div class="card-content card-content-padding">
                  <table>
                    <thead>
                      <tr>
                        <th class="numeric-cell" style="text-align: center">Slot</th>
                        <th class="numeric-cell" style="text-align: center">Mode</th>
                        <th class="numeric-cell" style="text-align: center">Operate</th>
                      </tr>
                      <tr v-for="item in slotlist" :key="item.name">
                        <td class="numeric-cell" style="text-align: center">
                          <span style="font-size: 14px">{{item.name}}</span>
                        </td>
                        <td class="actions-cell" style="text-align: center">
                          <span
                            >{{dealWithMode(item)}}</span
                          >
                        </td>
                        <td class="actions-cell" style="text-align: center">
                          <a href="#" class="link icon-only text-color-theme" v-on:click="activeSlot(item)">
                            <i class="material-icons text-color-gray" style="font-size: 35px">edit_note</i>
                          </a>
                          <!--<a href="#" class="link icon-only text-color-theme" v-on:click="changeDeviceSetting(item)">
                            <i class="material-icons text-color-gray" style="font-size: 30px">settings</i>
                          </a>-->
                        </td>
                      </tr>
                    </thead>
                  </table>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="saveRcuModeConfig">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
              <div class="card data-table" v-if="deviceSettingStatus">
                <div v-for="item in slotItemConfig" :key="item.id" v-if="item.slot == rcuItem.name">
                  <div class="card-header" style="font-weight: 500; font-size: 18px">{{_(item.name)}}</div>
                  <div class="card-content card-content-padding">
                    <div class="auto-init card margin-bottom-half mx-0 my-3" v-for="kitem in item.config" :key="kitem.name">
                      <div class="card-content card-content-padding">
                        <div class="row">
                          <div class="col-auto">
                            <div class="avatar avatar-44 elevation-2 rounded-10 bg-color-gray text-color-white">
                              <i class="material-icons">{{kitem.icon}}</i>
                            </div>
                          </div>
                          <div class="col align-self-center no-padding-left">
                            <h5 class="no-margin-bottom">{{ _(kitem.title) }}</h5>
                            <p class="setting-value text-muted size-12">{{ _(kitem.value) }}</p>
                          </div>
                          <div class="col-auto">
                            <a id="action" href="#" class="button button-fill button-44 color-theme button-raised">
                              <i class="material-icons">navigate_next</i>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="deviceSettingStatus = false">{{_("back")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 2 ? 'tab-active' : '']" v-if="index == 2">
              <input name="per_press_brightness_init" type="hidden" value="" />
              <div class="card data-table">
                <div v-for="item in slotItemConfig" :key="item.name" v-if="item.mode != 1">
                  <div class="card-header" style="font-weight: 500; font-size: 18px">{{_(item.name)}}</div>
                  <div class="card-content card-content-padding">
                    <div class="auto-init card margin-bottom-half mx-0 my-3" v-for="kitem in item.config" :key="md5(item.name)">
                      <div class="card-content card-content-padding">
                        <div class="row">
                          <div class="col-auto">
                            <div class="avatar avatar-44 elevation-2 rounded-10 bg-color-gray text-color-white">
                              <i class="material-icons">{{kitem.icon}}</i>
                            </div>
                          </div>
                          <div class="col align-self-center no-padding-left">
                            <h5 class="no-margin-bottom">{{ _(kitem.title) }}</h5>
                            <p class="setting-value text-muted size-12">{{ _(kitem.value) }}</p>
                          </div>
                          <div class="col-auto">
                            <a id="action" v-on:click="chooseInitSlotSetting(item,kitem)" class="button button-fill button-44 color-theme button-raised">
                              <i class="material-icons">navigate_next</i>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(1)">{{_("previous")}}</div>
                  </div>
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="saveDeviceSetting()">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="step-1" class="view tab view-main" :class="[index == 4 ? 'tab-active' : '']" v-if="index == 4">
              <div class="card data-table">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Activate Output/Input Port")}}</div>
                <div class="card-content card-content-padding">
                  <table>
                    <thead>
                      <tr>
                        <th class="numeric-cell" style="text-align: center">Gpio</th>
                        <th class="numeric-cell" style="text-align: center">Input</th>
                        <th class="numeric-cell" style="text-align: center">Output</th>
                      </tr>
                      <tr v-for="item in ioList" :key="item.name">
                        <td class="numeric-cell" style="text-align: center">
                          <span style="font-size: 14px">{{item.name}}</span>
                        </td>
                        <td class="actions-cell" style="text-align: center">
                          <a href="#" class="link icon-only text-color-theme" v-on:click="switchInputStatus(item)" v-if="!item.isNone">
                            <i
                              class="material-icons text-color-gray"
                              style="font-size: 50px; position: relative; top: -10px; left: -10px"
                              v-if="!item.inputStatus"
                              >toggle_off</i
                            >
                            <i
                              class="material-icons text-color-theme"
                              style="font-size: 50px; position: relative; top: -10px; left: -10px"
                              v-if="item.inputStatus"
                              >toggle_on</i
                            >
                          </a>
                          <span style="font-size: 18px" v-else>/</span>
                        </td>
                        <td class="actions-cell" style="text-align: center">
                          <a href="#" class="link icon-only text-color-theme" v-on:click="switchStatus(item)">
                            <i
                              class="material-icons text-color-gray"
                              style="font-size: 50px; position: relative; top: -10px; left: -10px"
                              v-if="!item.status"
                              >toggle_off</i
                            >
                            <i
                              class="material-icons text-color-theme"
                              style="font-size: 50px; position: relative; top: -10px; left: -10px"
                              v-if="item.status"
                              >toggle_on</i
                            >
                          </a>
                        </td>
                      </tr>
                    </thead>
                  </table>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(3)">{{_("previous")}}</div>
                  </div>
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="activeRcu()">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- <div id="step-2" class="view tab view-main" :class="[index == 3 ? 'tab-active' : '']" v-if="index == 3">
              <div class="card data-table">
                <div class="card-header" style="font-weight: 500; font-size: 18px">{{_("Activate Output/Input Port")}}</div>
                <div class="card-content card-content-padding">
                  <table>
                    <thead>
                      <tr>
                        <th class="numeric-cell" style="text-align: center">Device</th>
                        <th class="numeric-cell" style="text-align: center">Input</th>
                        <th class="numeric-cell" style="text-align: center">Operate</th>
                      </tr>
                      <tr v-for="item in deviceList" :key="item.name">
                        <td class="numeric-cell" style="text-align: center">
                          <span style="font-size: 14px">{{tran(item.title)}}</span>
                        </td>
                        <td class="actions-cell" style="text-align: center">
                          <span style="font-size: 12px">{{item.config?'IO '+item.config:'/'}}</span>
                        </td>
                        <td class="actions-cell" style="text-align: center">
                          <a href="#" class="link icon-only text-color-theme" v-on:click="editInputConfig(item)">
                            <i class="material-icons text-color-gray" style="font-size: 35px">edit_note</i>
                          </a>
                        </td>
                      </tr>
                    </thead>
                  </table>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(2)">{{_("previous")}}</div>
                  </div>
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="saveDevice()">{{_("COMPLETE")}}</div>
                  </div>
                </div>
              </div>
            </div>-->
            <div id="step-2" class="view tab view-main" :class="[index == 3 ? 'tab-active' : '']" v-if="index == 3">
              <div class="card data-table">
                <div class="card-content card-content-padding">
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">{{_('Door Bell Enable')}}</div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="doorBellStatus = !doorBellStatus"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!doorBellStatus">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="doorBellStatus">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">
                        <span>{{_('Clean And Dnd Enable')}}</span>
                      </div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="cleanAndDndStatus = !cleanAndDndStatus"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!cleanAndDndStatus">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="cleanAndDndStatus">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <p class="tips text-color-gray">{{_('This configuration uses IO ports 31 and 32.')}}</p>
                  <div class="action-box card" style="margin-left: 0; margin-right: 0; margin-top: 10px">
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">
                        <span>{{_('Main RCU Enable')}}</span>
                      </div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="mainRcuConfig = !mainRcuConfig"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!mainRcuConfig">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="mainRcuConfig">toggle_on</i>
                      </div>
                    </div>
                    <div class="add-box add-action display-flex justify-content-space-between align-items-center">
                      <div class="trigger-text">
                        <span>{{_('485 Enable')}}</span>
                      </div>
                      <div
                        class="trigger-right display-flex justify-content-space-between align-items-cente"
                        v-on:click="viaConfig = !viaConfig"
                      >
                        <i class="material-icons text-color-gray" style="font-size: 50px" v-if="!viaConfig">toggle_off</i>
                        <i class="material-icons text-color-theme" style="font-size: 50px" v-if="viaConfig">toggle_on</i>
                      </div>
                    </div>
                  </div>
                  <p class="tips text-color-gray">{{_('This configuration is suitable for multiple RCUs connected via 485 wiring.')}}</p>
                </div>
                <div class="row" style="margin-bottom: 15px; margin-top: 15px">
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="nextStep(2)">{{_("previous")}}</div>
                  </div>
                  <div class="col">
                    <div class="button button-fill button-save" v-on:click="ioConfigDisplay()">{{_("NEXT STEP")}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- popup list start -->
          <div class="popup demo-popup-swipe-handler" v-show="clickStatus">
            <div class="view view-init">
              <div class="page page-with-navbar-large">
                <div class="navbar navbar-large navbar-transparent">
                  <div class="navbar-bg"></div>
                  <div class="navbar-inner">
                    <div class="title"></div>
                    <div class="right">
                      <a class="link popup-close"><i class="material-icons" style="font-size: 40px">cancel</i></a>
                    </div>
                    <div class="title-large">
                      <div class="title-large-text"></div>
                    </div>
                  </div>
                </div>
                <div class="page-content">
                  <div class="block block-strong-ios block-outline-ios" style="padding: 15px">
                    <div class="list list-strong-ios list-dividers-ios">
                      <ul class="operate-box" style="margin-top: 15px">
                        <li class="radio-box card" style="opacity: 0">
                          <label class="item-radio item-radio-icon-end item-content">
                            <input type="radio" name="demo-radio-light" checked value="100" />
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                              <div class="item-title">On</div>
                            </div>
                          </label>
                        </li>
                        <li class="radio-box card" v-for="(labelItem,labelIndex) in labelList" :key="labelItem.value">
                          <div v-on:click="home_ui_click_touch_app_save(labelItem)" style="width: 100%; padding: 15px">
                            {{labelItem.text}}
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- popup list end -->
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    let { guid } = $f7route.query;
    //let guid = '3334383531383763323636321203461d';
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          stepList: [
            {
              id: 1,
              name: 1,
              relatedIndex : 1,
              isActive: true,
            },
            {
              id: 2,
              name: 2,
              relatedIndex : 2,
              isActive: false,
            },
            {
              id: 3,
              name: 3,
              relatedIndex : 3,
              isActive: false,
            },
            {
              id: 4,
              name: 4,
              relatedIndex : 4,
              isActive: false,
            },
          ],
          slotconfigList: [],
          slotlist: [],
          deviceSettingStatus: false,
          deviceList: [],
          index: 1,
          ioList: [],
          slotItemConfig: [
            {
              name: 'Slot 1-1',
              mode: 2,
              slot :1,
              config: [],
            },
          ],
          settingConfigList: [
            {
              id: 1,
              mode: 2,
              config: [
                {
                  name: 'config_1',
                  title: 'Per Brightness',
                  value: 5,
                  icon: 'cable',
                },
                {
                  name: 'config_2',
                  title: 'Minimum Trim',
                  value: 1,
                  icon: 'light',
                },
              ],
            },
            {
              id: 2,
              mode: 4,
              config: [
                {
                  name: 'config_1',
                  title: 'Per Brightness',
                  value: 5,
                  icon: 'cable',
                },
                {
                  name: 'config_2',
                  title: 'Minimum Trim',
                  value: 0,
                  icon: 'light',
                },
              ],
            },
            {
              id: 3,
              mode: 5,
              config: [
                {
                  name: 'config_1',
                  title: 'Per Brightness',
                  value: 5,
                  icon: 'cable',
                },
                {
                  name: 'config_2',
                  title: 'Minimum Trim',
                  value: 0,
                  icon: 'light',
                },
              ],
            },
          ],
          labelList: [
            {
              value: 0,
              text: 'No Set',
            },
            {
              value: 1,
              text: 'On Off Switch',
            },
            {
              value: 2,
              text: 'Triac Dimming',
            },
            {
              value: 3,
              text: 'Curtain Switch',
            },
            {
              value: 4,
              text: '0-10v Dimming',
            },
            {
              value: 5,
              text: '1-10v Dimming',
            },
          ],
          popupItem: null,
          clickStatus: false,
          rcuItem: {
            config: 1,
          },
          inputText: _('Output Name'),
          doorBellStatus: true,
          cleanAndDndStatus: true,
          mainRcuConfig : false,
          viaConfig : false
        },
        watch:{
          slotlist:{
            handler(){
              this.initSlotItemConfig();
            },
            deep : true,
            immediate : true
          }
        },
        computed:{
          
        },
        mounted() { 
          this.initIoList();
          this.initSetting();
          this.initDeviceList();
          this.initSlotlist();
          this.initSlotConfigList();
          this.initSlotItemConfig();
        },
        methods: {
          dealWithMode(item){
            let modeStr = '/';
            if(item.activeMode == 1){
              if(item.mode == 1){
                modeStr = 'On Off Switch'
              }else if(item.mode == 3){
                modeStr = 'Curtain Switch'
              }
            }
            if(item.activeMode == 2){
              if(item.mode == 2){
                modeStr = 'Triac Dimming'
              }else if(item.mode == 4){
                modeStr = '0-10v Dimming'
              }else if(item.mode == 5){
                modeStr = '1-10v Dimming'
              }
            }
            return modeStr;
          },
          toTab(index){
            this.index = index;
            this.activeStep();
          },
          activeStep() {
            this.stepList.forEach((item) => {
              if (item.id == this.index) {
                item.isActive = true;
              } else {
                item.isActive = false;
              }
            });
          },
          home_ui_click_touch_app_save(labelItem) {
            console.log(labelItem);
            this.rcuItem.mode = labelItem.value;
            //attention the user,get the profile mode and compare the data 
            let effectDeviceList = [];
            let originalMode = '';
            let profile_subdevice = cloneDeep(erp.info.profile.profile_subdevice);
            profile_subdevice.forEach((subItem)=>{
              if(subItem.config && subItem.device == guid && parseInt(subItem.config) == parseInt(this.rcuItem.name)){
                effectDeviceList.push(subItem);
                originalMode = subItem.device_mode;
              }
            })
            this.slotlist.forEach((item) => {
              if (item.name == this.rcuItem.name) {
                item.mode = parseInt(this.rcuItem.mode);
                if(this.rcuItem.mode == 0){
                  item.activeMode = 0;
                }else if(this.rcuItem.mode == 1 || this.rcuItem.mode == 3){
                  item.activeMode = 1;
                }else{
                  item.activeMode = 2;
                }
                
              }
            });
            console.log('this.popupItem', this.popupItem);
            this.popupItem.close();
            let text = ``;
              effectDeviceList.forEach(effectItem=>{
                text += `${tran(effectItem.title)} `;
              })
            if(originalMode == 'On Off Switch' && ([2,3,4,5].includes(parseInt(labelItem.value)))){
              
              app.dialog.alert(`${_("Please note that this conversion will delete the ")}${text}.${_('Please re-add it in the unassigned section.')}`)
            }
            if(['Triac Dimming','0-10v Dimming','1-10v Dimming'].includes(originalMode) && [1,3].includes(parseInt(labelItem.value))){
              app.dialog.alert(`${_("Please note that this conversion will delete the ")}${text}.${_('Please re-add it in the unassigned section.')}`)
            }
          },
          changeDeviceSetting(item) {
            this.rcuItem = item;
            this.deviceSettingStatus = true;
          },
          async saveDeviceSetting() {
            app.dialog.preloader();
            //this setting will set two gang
            let commandList = [];
            let valueList = [0,13,19,25,31,37,43,49,55,61];
            let postData = {};//{slot:brightness|min_trim|brightness|min_trim}
            console.log(this.slotItemConfig);
            let mapData = {};//{slot:{gang_1:{brightness:5,min_trim:1},gang_2:{brightness:5,min_trim:1}}}
            this.slotItemConfig.forEach(item=>{
              let slot = parseInt(item.slot).toString(16).pad("00");
              let mode = parseInt(item.mode);
              let list = item.config;
              if(isset(mapData[`${slot}`])){
                mapData[`${slot}`][`gang_${item.gang}`] = {};
              }else{
                mapData[`${slot}`] = {};
                mapData[`${slot}`][`gang_${item.gang}`] = {};
              }
              
              list.forEach(kitem=>{
                mapData[`${slot}`][`gang_${item.gang}`][`${kitem.title}`] = kitem.value;
              })
            });
            console.log("mapData",mapData);
            //post the ble command
            for(let i in mapData){
              //Minimum Trim,Per Brightness
              let slot = i;
              let $length = Object.keys(mapData[i]);
              let minData = `971f${slot}8905`;
              let perData = `971f${slot}8909`;
              if($length.length == 2){
                postData[`init_slot_${i}`] = {};
                let postStr = ``;
                for(let j in mapData[i]){
                  if(isset(mapData[i][j]['Per Brightness'])){
                    let value = parseInt(mapData[i][j]['Per Brightness']);
                    perData += `${parseInt(value*255/100).toString(16).pad("00")}`;
                    postStr += `${value}|`;
                  }
                  if(isset(mapData[i][j]['Minimum Trim'])){
                    let value = parseInt(mapData[i][j]['Minimum Trim']);
                    minData += `${parseInt(valueList[value]).toString(16).pad("00")}`;
                    postStr += `${value}|`;
                  }
                }
                postData[`init_slot_${i}`] = postStr;
                commandList.push(minData);
                commandList.push(perData);
              }else{

              }
            }
            console.log("commandList",commandList);
            console.log("postData",postData);
            try{
              //post to ble
              let bleList = [];
              for(let i in commandList){
                bleList.push({
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: commandList[i],
                })
              }
              await window.peripheral[guid].write(bleList);
              //post to the erp
              await iot_device_setting_sync_server(guid,null, null, true, postData);
              
              app.dialog.close();
              this.index = 3;
              this.activeStep();
            }catch(error){
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
            
          },
          chooseInitSlotSetting(item,kitem){
            console.log(item);
            console.log(kitem);
            let itemName = item.name;
            let values = [];
            let valueList = [0,13,19,25,31,37,43,49,55,61];
            let perList = [12,25,38,51,76,102,127]; //this only show this config
            if(kitem.title == 'Per Brightness'){
              values = [5, 10,15,20,30,40,50];
            }else if(kitem.title == 'Minimum Trim'){
              values = [0,1,2,3,4,5,6,7,8,9,10];
            }
            this.pickMap = null;
            let inputEl = $('input[name="per_press_brightness_init"]');
            this.pickMap = app.picker.create({
              inputEl : inputEl,
              cols : [
                {
                  textAlign: "center",
                  values: values,
                  displayValues: values
                }
              ],
              formatValue: function(values) {
                  return values[0];
              },
              renderToolbar : ()=>{
                return `
                <div class="toolbar">
                    <div class="toolbar-inner">
                        <div class="left"></div>
                        <div class="right">
                            <a href="#" class="link toolbar-save-link-init">${_("Save")}</a>
                        </div>
                    </div>
                </div>
                `;
              },
              on : {
                open : (picker)=>{
                  $(picker.$el.find(".toolbar-save-link-init")).on("click",()=>{
                    this.pickMap.close();
                    const selected = parseInt(inputEl.val());
                    //kitem.value = selected;
                    //console.log("selected",selected);
                    this.slotItemConfig.forEach(zitem=>{
                      if(zitem.name == itemName){
                        //zitem.name = `${selected}`;
                        let thisList = cloneDeep(zitem.config);
                        thisList.forEach(sitem=>{
                          if(sitem.title == kitem.title){
                            sitem.value = selected;
                          }
                         });
                         zitem.config = thisList;
                      }                         
                    })
                    // this.saveDeviceSetting(item,kitem);
                  })
                }
              }
            })
            this.pickMap.open();
          },
          initSlotItemConfig() {
            console.log("change")
            this.slotItemConfig = [];
            //init the rcu data
            this.slotlist.forEach((item) => {
              //1 on off 2 dimming 3 Curtain Switch 4 0-10v Dimming 5 1-10v Dimming
              if (item.mode == 2 || item.mode == 4 || item.mode == 5) {
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-1`,
                  gang : 1,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-2`,
                  gang : 2,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
              } else if (item.mode == 1) {
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-1`,
                  gang : 1,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-2`,
                  gang : 2,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-3`,
                  gang : 3,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-4`,
                  gang : 4,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
              } else if (item.mode == 3) {
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-1`,
                  gang : 1,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
                this.slotItemConfig.push({
                  name: `Slot ${item.name}-2`,
                  gang : 2,
                  slot: `${item.name}`,
                  mode: item.mode,
                  config: [],
                });
              }
            });
            this.slotItemConfig.forEach((item) => {
              this.settingConfigList.forEach((kitem) => {
                if (item.mode == kitem.mode) {
                  item.config = kitem.config;
                }
              });
            });
            //console.log('this.slotItemConfig', this.slotItemConfig);
            let devices = cloneDeep(erp.info.device);
            if (isset(devices[guid])) {
              let slotConfigList = [];
              let settings = devices[guid].settings;
              settings.forEach(item=>{
                if(item.setting_type.startsWith("init_slot_")){
                  slotConfigList.push({
                    slot : item.setting_type.replace("init_slot_",""),
                    value : item.setting
                  })
                }
              });
              this.slotItemConfig.forEach(item=>{
                slotConfigList.forEach(kitem=>{
                  let list = kitem.value.split("|");
                  if(parseInt(kitem.slot) == parseInt(item.slot)){
                    let thisList = cloneDeep(item.config);
                    thisList.forEach(zitem=>{
                      if(item.gang == 1){
                        if(zitem.title == 'Per Brightness'){
                          zitem.value = list[0];
                        }
                        if(zitem.title == 'Minimum Trim'){
                          zitem.value = list[1];
                        }
                      }else if(item.gang == 2){
                        if(zitem.title == 'Per Brightness'){
                          zitem.value = list[2];
                        }
                        if(zitem.title == 'Minimum Trim'){
                          zitem.value = list[3];
                        }
                      }
                    })
                    item.config = thisList;
                  }
                })
              })
              //get the erp data

            }
          },
          initSetting() {
            let devices = cloneDeep(erp.info.device);
            if (isset(devices[guid])) {
              let settings = devices[guid].settings;
              settings.forEach((item) => {
                if (item.setting_type == 'door_bell') {
                  if (item.setting == 0) {
                    this.doorBellStatus = false;
                  } else {
                    this.doorBellStatus = true;
                  }
                }
                if (item.setting_type == 'clean_dnd') {
                  if (item.setting == 0) {
                    this.cleanAndDndStatus = false;
                  } else {
                    this.cleanAndDndStatus = true;
                  }
                }
                if(item.setting_type == 'main_rcu'){
                  if(item.setting == 0){
                    this.mainRcuConfig = false;
                  }else{
                    this.mainRcuConfig = true
                  }
                  
                }
                if(item.setting_type == 'via_485'){
                  if(item.setting == 0){
                    this.viaConfig = false;
                  }else{
                    this.viaConfig = true
                  }
                }
              });
            }
          },
          initSlotConfigList() {
            //this.slotconfigList
            this.slotlist.forEach((item) => {});
          },
          async initSlotlist() {
            let devices = cloneDeep(erp.info.device);
            let modeList = [2,2,2,2,2];
            if(isset(devices[guid])){
              let settingsList = devices[guid].settings;
              settingsList.forEach((item) => {
                if(item.setting_type == 'mode_list'){
                  modeList = item.setting.split(",");
                }
              })
            }
            for (let i = 1; i <= 5; i++) {
              let indexItem = ['2','4','5'].indexOf(modeList[i-1]);
              this.slotlist.push({
                name: i,
                mode: modeList[i-1],
                activeMode : indexItem != -1?2:1
              });
            }
            //get the rcu manual slot list
            let data = `9701`;
            await peripheral[guid].connect();
            try {
              ble.startNotification(
                peripheral[guid].prop.id,
                'ff80',
                'ff82',
                (rs) => {
                  console.log(rs);
                  if (rs.startsWith('9711')) {
                    // let index_one = rs.substr(6, 2);
                    // let index_two = rs.substr(10, 2);
                    // let index_three = rs.substr(14, 2);
                    // let index_four = rs.substr(18, 2);
                    // let index_five = rs.substr(22, 2);
                    // this.slotlist.forEach((kitem) => {
                    //   if (kitem.name == 1) {
                    //     kitem.activeMode = parseInt(index_one);
                    //   } else if (kitem.name == 2) {
                    //     kitem.activeMode = parseInt(index_two);
                    //   } else if (kitem.name == 3) {
                    //     kitem.activeMode = parseInt(index_three);
                    //   } else if (kitem.name == 4) {
                    //     kitem.activeMode = parseInt(index_four);
                    //   } else if (kitem.name == 5) {
                    //     kitem.activeMode = parseInt(index_five);
                    //   }
                    // });
                    let obj = class_test_rcu(rs);
                    console.log("obj",obj);
                    this.slotlist.forEach(item=>{
                      if(isset(obj[parseInt(item.name).toString(16).pad('00')])){
                        let value = obj[parseInt(item.name).toString(16).pad('00')];
                        if(value.length == 2){
                          item.activeMode = '00';
                        }else{
                          item.activeMode = parseInt(value.substr(0,2));
                          let mode = parseInt(value.substr(2,2));
                          if(mode == 5){
                            item.mode = 3;
                          }else if(mode == 3){
                            item.mode = 4;
                          }else if(mode == 4){
                            item.mode = 5;
                          }else{
                            item.mode = mode;
                          }
                          //item.mode = parseInt(value.substr(2,2));
                        }
                      }
                    })
                    console.log("this.slotlist",this.slotlist);
                  } else if (rs.startsWith('9714')) {
                  }
                },
                (err) => {
                  //reject(err);
                }
              );
              await window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: data,
                },
              ]);
              await window.peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: `931F`,
                },
              ]);
            } catch (error) {}
          },
          activeSlot(item) {
            this.clickStatus = true;
            this.rcuItem = item;
            //open the pop
            this.popupItem = app.popup
              .create({
                el: '.demo-popup-swipe-handler',
                swipeToClose: true,
                push: true,
              })
              .open();
          },
          initDeviceList() {
            this.deviceList = [];
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            subdevices.forEach((item) => {
              if (item.device_button_group == '4in1 Sensor') {
                this.deviceList.push(item);
              }
            });
          },
          initIoList() {
            let settingList = [];
            let deviceMap = erp.info.device;
            if (isset(deviceMap[guid])) {
              let thisDeviceMap = deviceMap[guid];
              let settings = thisDeviceMap.settings;
              settings.forEach((item) => {
                if (item.setting_type.startsWith('active_io')) {
                  settingList.push({
                    name: item.setting_type.replace('active_io_', ''),
                    inputStatus: item.setting == 'input' ? true : false,
                    status: item.setting == 'output' ? true : false,
                  });
                }
              });
            }
            console.log('settingList', settingList);
            for (let i = 1; i <= 32; i++) {
              let status = false;
              let inputStatus = false;
              let title = '';
              let isNone = false;
              if (i == 33) {
                status = true;
                inputStatus = false;
                isNone = true;
                //title = 'Door Bell'
              }
              settingList.forEach((kitem) => {
                if (kitem.name == i) {
                  if (kitem.inputStatus) {
                    inputStatus = true;
                  }
                  if (kitem.status) {
                    status = true;
                  }
                }
              });
              this.ioList.push({
                name: i,
                title: title,
                status: status,
                inputStatus: inputStatus,
                isNone: isNone,
              });
            }
          },
          switchInputStatus(item) {
            item.inputStatus = !item.inputStatus;
            if (item.inputStatus) {
              item.status = false;
            }
          },
          switchStatus(item) {
            item.status = !item.status;
            if (item.status) {
              item.inputStatus = false;
            }
          },
          editInputConfig(item) {
            app.dialog.prompt(`${_('Link the device input port,1-32')}`, (name) => {
              const regex = /^(2[0-9]|[1-9]|1[0-9]|32)$/;
              if (regex.test(name)) {
                //check if the input port can not active
                let canActive = false;
                this.ioList.forEach((kitem) => {
                  if (kitem.name == name) {
                    if (kitem.inputStatus) {
                      canActive = true;
                    }
                  }
                });
                if (canActive) {
                  item.config = name;
                } else {
                  app.dialog.alert(_('Sorry, this input port has not been activated yet'));
                }
              } else {
                app.dialog.alert(_('Please enter a valid input port number'));
              }
            });
          },
          async saveRcuModeConfig(){
            app.dialog.preloader();
            //1 on off 2 dimming 3 Curtain Switch 4 0-10v Dimming 5 1-10v Dimming
            let postData = {};
            let list = [];
            let commandList = [];
            for(let i in this.slotlist){
              let this_mode = this.slotlist[i].mode;
              let slotIndex = parseInt(this.slotlist[i].name).toString(16).pad('00');
              list.push(this_mode);
              //dimming should set the minimum trim to 13,0-10v should set the minimum trim to 0
              if(this_mode == 1){
                commandList.push(`9711${slotIndex}01`);
                commandList.push(`971f${slotIndex}810500`);
              }else if(this_mode == 2){
                commandList.push(`9711${slotIndex}02`);
                commandList.push(`971f${slotIndex}89070101`);
                commandList.push(`971f${slotIndex}89050d0d`);
                commandList.push(`971f${slotIndex}89068a8a`);
              }else if(this_mode == 3){
                commandList.push(`9711${slotIndex}01`);
                commandList.push(`971f${slotIndex}810501`);
              }else if(this_mode == 4){
                commandList.push(`9711${slotIndex}02`);
                commandList.push(`971f${slotIndex}89070202`);
                commandList.push(`971f${slotIndex}89050000`);
                commandList.push(`971f${slotIndex}8906ffff`);
              }else if(this_mode == 5){
                commandList.push(`9711${slotIndex}02`);
                commandList.push(`971f${slotIndex}89070303`);
                commandList.push(`971f${slotIndex}89050000`);
                commandList.push(`971f${slotIndex}8906ffff`);
              }
            }
            postData['mode_list'] = list.join(",");
            //save in erp device setting
            try{
              let bleList = [];
              for(let i in commandList){
                bleList.push({
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: commandList[i],
                })
              }
              await window.peripheral[guid].write(bleList);
              await iot_device_setting_sync_server(guid,'mode_list',list.join(","));
              //save in the profile device 
              await this.sync_profile_subdevice();
              app.dialog.close();
              this.index = 2;
              this.activeStep();
            }catch(error){
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          async sync_profile_subdevice(){
            let list = cloneDeep(this.slotlist);
            let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let mapSubdevices = [];
            let addSubList = [];
            let addConfigMap = {};
            //1 on off 2 dimming 3 Curtain Switch 4 0-10v Dimming 5 1-10v Dimming
            list.forEach(item=>{
              subdevices.forEach(subItem=>{
                if(isset(subItem.config)){
                  if(parseInt(item.name) == parseInt(subItem.config) && subItem.device == guid){
                    //check the mode is nor check
                    let device_mode = subItem.device_mode;
                    let profile_room = subItem.profile_room;
                    let device_name = subItem.profile_device;
                    //rcu confirm device mode is : Triac Dimming,0-10v Dimming,1-10v Dimming,On Off Switch,Curtain Switch
                    if(item.mode == 2){
                      //in case on off gang change to the dimming
                      if(device_mode == 'On Off Switch' || device_mode == 'Curtain Switch'){
                        subItem.isDel = true;
                      }else{
                        subItem.device_mode = 'Triac Dimming';
                      }
                    }else if(item.mode == 4){
                      if(device_mode == 'On Off Switch' || device_mode == 'Curtain Switch'){
                        subItem.isDel = true;
                      }else{
                        subItem.device_mode = '0-10v Dimming';
                      }
                    }else if(item.mode == 5){
                      if(device_mode == 'On Off Switch' || device_mode == 'Curtain Switch'){
                        subItem.isDel = true;
                      }else{
                        subItem.device_mode = '1-10v Dimming';
                      }
                    }else if(item.mode == 1){
                      //if no On Off Switch,del this subdevice device
                      if(device_mode != 'On Off Switch'){
                        subItem.isDel = true;
                        // for(let i=1;i<=4;i++){
                        //   let gang = (parseInt(item.name)-1)*4+i;
                        //   let device_button_group = `RCU ONOFF GANG${gang}`;
                        //   let pushStatus = true;
                        //   addSubList.forEach(zitem=>{
                        //     if(zitem.device_button_group == device_button_group){
                        //       pushStatus = false;
                        //     }
                        //   })
                        //   if(!pushStatus){
                        //     continue;
                        //   }
                        //   //check if addSubList is ex
                        //   addSubList.push({
                        //     parenttype: 'Profile',
                        //     parent: erp.info.profile.name,
                        //     parentfield: 'profile_subdevice',
                        //     profile_room: profile_room,
                        //     profile_device: device_name,
                        //     device: guid,
                        //     title: `YO780 4G ${parseInt(item.name)}-${i}`,
                        //     device_button_group: device_button_group,
                        //     device_mode: 'On Off Switch',
                        //     config: `0${parseInt(item.name)}`,
                        //   })
                        // }
                      }
                    }else if(item.mode == 3){
                      if(device_mode != 'Curtain Switch'){
                        subItem.isDel = true;
                        // let device_button_group_1 = `RCU OPENCLOSE GANG${(parseInt(item.name)-1)*4+1}_${(parseInt(item.name)-1)*4+2}`;
                        // let device_button_group_2 = `RCU OPENCLOSE GANG${(parseInt(item.name)-1)*4+3}_${(parseInt(item.name)-1)*4+4}`;
                        // let pushStatus_1 = true;
                        // let pushStatus_2 = true;
                        // addSubList.forEach(zitem=>{
                        //   if(zitem.device_button_group == device_button_group_1){
                        //     pushStatus = false;
                        //   };
                        //   if(zitem.device_button_group == device_button_group_2){
                        //     pushStatus_2 = false;
                        //   }
                        // })
                        // if(pushStatus_1){
                        //   addSubList.push({
                        //     parenttype: 'Profile',
                        //     parent: erp.info.profile.name,
                        //     parentfield: 'profile_subdevice',
                        //     profile_room: profile_room,
                        //     profile_device: device_name,
                        //     device: guid,
                        //     title: `YO780 2GK ${parseInt(item.name)}-1`,
                        //     device_button_group: `RCU OPENCLOSE GANG${(parseInt(item.name)-1)*4+1}_${(parseInt(item.name)-1)*4+2}`,
                        //     device_mode: 'Curtain Switch',
                        //     config: `0${parseInt(item.name)}`,
                        //   })
                        // }
                        // if(pushStatus_2){
                        //   addSubList.push({
                        //     parenttype: 'Profile',
                        //     parent: erp.info.profile.name,
                        //     parentfield: 'profile_subdevice',
                        //     profile_room: profile_room,
                        //     profile_device: device_name,
                        //     device: guid,
                        //     title: `YO780 2GK ${parseInt(item.name)}-1`,
                        //     device_button_group: `RCU OPENCLOSE GANG${(parseInt(item.name)-1)*4+3}_${(parseInt(item.name)-1)*4+4}`,
                        //     device_mode: 'Curtain Switch',
                        //     config: `0${parseInt(item.name)}`,
                        //   })
                        // }
                      }
                      //subItem.device_mode = 'Curtain Switch';
                    }
                  }
                }
              })
            });
            mapSubdevices = subdevices.filter(item=>!item.isDel);
            try{
              
              let url = `/api/resource/Profile/${erp.info.profile.name}`;
              await http2.request(encodeURI(url), {
                method: 'PUT',
                serializer: 'json',
                responseType: 'json',
                data: {
                  profile_subdevice: mapSubdevices,
                },
                debug: true,
              });
              // for(let i in addSubList){
              //   let subUrl = `/api/resource/Profile Subdevice`;
              //   await http2.request(encodeURI(subUrl), {
              //     method: 'POST',
              //     serializer: 'json',
              //     responseType: 'json',
              //     data: addSubList[i],
              //     debug: true,
              //   });
              // }
              //get the new subdevice 
              let profileData = await http2.request(encodeURI(`/api/resource/Profile/${erp.info.profile.name}`), {
                method: 'GET',
                serializer: 'json',
                responseType: 'json',
                data: {},
                debug: true,
              });
              console.log("profileData",profileData);
              if(isset(profileData.data)){
                erp.info.profile = profileData.data.data;
                //refresh the samrt home
                //emitter.emit('refresh/init',{});
                //should update the device list
                window.globalUpdate = true;
              }
            }catch(error){
              app.dialog.close();
              app.dialog.alert(error);
            }
          },
          editOutputName(item) {
            app.dialog.prompt(`${_('IO ' + item.name + ' Output Name')}`, (name) => {
              item.title = name;
            });
            setTimeout(() => {
              let text = $(`.title-io-${item.name}`).text();
              console.log('text', text);
              $('.dialog-input-field input').val(text);
            }, 50);
          },
          async saveDevice() {
            app.dialog.preloader();
            let sudevices = cloneDeep(erp.info.profile.profile_subdevice);
            sudevices.forEach((item) => {
              this.deviceList.forEach((kitem) => {
                if (item.name == kitem.name) {
                  item.config = kitem.config;
                }
              });
            });
            //post to erp
            let url = `/api/resource/Profile/${erp.info.profile.name}`;
            try {
              await http2.request(encodeURI(url), {
                method: 'PUT',
                serializer: 'json',
                responseType: 'json',
                data: {
                  profile_subdevice: sudevices,
                },
                debug: true,
              });
              app.dialog.close();
              erp.info.profile.profile_subdevice = sudevices;
              app.dialog.confirm(
                `${_('Save Successfully.Would you like to back?')}`,
                () => {
                  mainView.router.back();
                },
                () => {}
              );
            } catch (error) {
              app.dialog.alert(error);
            }
          },
          async ioConfigDisplay() {
            app.dialog.preloader();
            let erpObj = {
              'door_bell': this.doorBellStatus ? '1' : '0',
              'clean_dnd': this.cleanAndDndStatus ? '1' : '0',
              'main_rcu' : this.mainRcuConfig?'1':'0',
              'via_485' : this.viaConfig?'1':'0'
            };
            //change the ioList status
            this.ioList.forEach((item) => {
              if (item.name == 31 || item.name == 32) {
                item.status = this.cleanAndDndStatus;
                item.inputStatus = !this.cleanAndDndStatus;
              }
            });
            //init via_485
            try{
              let list = [];
              if(this.viaConfig){
                list.push({
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: `972002010400000100c20100`,
                })
              }else{
                list.push({
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: `972002010000000100c20100`,
                })
              }
              await window.peripheral[guid].write(list);
            }catch(error){ 
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
            try {
              console.log(erpObj);
              await iot_device_setting_sync_server(guid, null, null, true, erpObj);
              app.dialog.close();
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(error);
            }
            this.index = 4;
            this.activeStep();
          },
          async activeRcu() {
            //active the output
            let commandList = [];
            let erpObj = {};
            for (let i in this.ioList) {
              let gang = this.ioList[i].name;
              let commandData = '';
              if (this.ioList[i].status) {
                erpObj[`active_io_${gang}`] = `output`;
                if (gang == 33) {
                  gang = 98;
                }
                let data = `972001${gang.toString(16).pad('00')}02`;
                commandData = data;
              }
              if (this.ioList[i].inputStatus) {
                erpObj[`active_io_${gang}`] = `input`;
                let data = `972001${gang.toString(16).pad('00')}01`;
                commandData = data;
              }
              if (!this.ioList[i].status && !this.ioList[i].inputStatus) {
                erpObj[`active_io_${gang}`] = `inactive`;
                if (gang == 33) {
                  gang = 98;
                }
                let data = `972001${gang.toString(16).pad('00')}00`;
                commandData = data;
              }
              commandList.push({
                service: 'ff80',
                characteristic: 'ff81',
                data: commandData,
              });
            }
            commandList.push({
                service: 'ff80',
                characteristic: 'ff81',
                data: `810e`,
              });
            app.dialog.preloader();
            try {
              for (let i in commandList) {
                let list = [];
                list.push(commandList[i]);
                await window.peripheral[guid].write(list);
              }
              await iot_device_setting_sync_server(guid, null, null, true, erpObj);
              await ha_profile_ready();
              app.dialog.close();
              app.dialog.confirm(
                `${_('Save Successfully.Would you like to back?')}`,
                () => {
                  mainView.router.back();
                },
                () => {}
              );
            } catch (error) {
              app.dialog.close();
              app.dialog.alert(_(erp.get_log_description(error)));
            }
          },
          nextStep(sindex) {
            this.index = sindex;
            this.activeStep();
          },
        },
        computed: {},
        beforeDestroy() {},
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  .list ul::before,
  .list ul::after {
    content: none;
  }
  .add-box {
    height: 70px;
    padding: 0px 15px;
    color: var(--f7-theme-color);
  }
  .tips {
    padding: 0px 15px;
    font-size: 12px;
  }
</style>
