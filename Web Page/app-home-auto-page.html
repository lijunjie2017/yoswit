<template>
	<div class="page">
		<div class="navbar active">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				${(isHomePage) ? $h`
				<div class="left">
					<a href="#" class="button button-fill text-color-theme bg-color-white button-44 panel-open" data-panel="left">
						<i class="icon material-icons">menu</i>
					</a>
				</div>
				<div class="title sliding">
					<div class="logo-small">
						<img src="{{ frappe.get_url(nav_app_logo_image) if nav_app_logo_image else appSetting.iconImageUri }}" />
						<a href="/mobile-app/profile-list" class="link">
							${erp.info.profile ? $h`
							<font class="profile_title" style="text-overflow: ellipsis; max-width: 110px; overflow: hidden">
								${ erp.info.profile.flat ? tran(erp.info.profile.flat) + '-' : '' }${ tran(erp.info.profile.profile_name) }
							</font>
							` : $h`
							<font class="profile_title" style="text-overflow: ellipsis; max-width: 110px; overflow: hidden"> ${ tran('Default') } </font>
							`}
							<div class="home-title-profile-popover" style="margin-left: 5px">
								<i class="icon f7-icons" style="font-size: 14px">chevron_down</i>
							</div>
						</a>
					</div>
				</div>
				<a class="button button-fill text-color-theme bg-color-white button-44" href="#" func="open_accounts">
					<i class="icon material-icons">settings</i>
				</a>
				` :  $h`
				<div class="left">
					<a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">${title}</div>
				<div class="right">
					<a link icon-only>
						${mobileAsHubStatus && $h`
            <div class="device-mobile-as-hub" @click="${()=>clickForMobile()}"></div>
						`}
          </a>
					${listCssStatus == 'List' && $h`
					<a link icon-only @click="${()=>changeListCss(2)}">
						<i class="icon material-icons md-only">list</i>
          </a>
					`}
				</div>
				`}
			</div>
		</div>
	
		<div class="page-content ptr-content" style="height: 100%" @ptr:refresh="${refresh}" id="container">
			<div class="ptr-preloader"><div class="preloader"></div><div class="ptr-arrow"></div></div>
			<div class="room-box">
					<!-- home scene banner -->
					<div class="banner-swiper-container swiper-container-auto swiper-container home-swiper" style="z-index: 5; position: fixed">
						<div class="swiper-wrapper">
							${scenes.map((sceneItem)=> $h`
								<div class="swiper-slide home-swiper-slide" key="${sceneItem.name}" style="height: 100%;background-position: center;background-image: url(${sceneItem.image?sceneItem.image:'https://dev.mob-mob.com/files/scene.jpg'});background-size: cover;">
									<div class="home-swiper-slide-inner">
										<div style="margin: 8px 16px 8px 30px">
											<div style="text-align: left; float: left; width: 50%; line-height: 29px; padding-top: 5px">
												<b style="font-size: 25px; text-shadow: 1px 2px 3px #000; color: #fff">${ tran(sceneItem.title) }</b>
											</div>
											<div style="text-align: right; float: right; width: 50%; display: none">
												<a
													class="button right"
													href=""
												>
													<i class="material-icons">settings</i>
												</a>
											</div>
											<br />
											<div style="text-align: right; float: right; width: 50%; margin-top: -20px; margin-bottom: 20px">
												<!-- <label
													class="switch"
													style="
														margin-top: 10px;
														margin-bottom: 20px;"
												>
													<input type="checkbox" scene-name="${sceneItem.name}" />
													<span class="slider round"></span>
												</label>-->
												<yo-f7-button
													href="#"
													tag="span"
													@tap="${()=>{home_auto_click_scene(sceneItem)}}"
													sceneref="${sceneItem.name}"
													class="right off_flag"
												>
													<div
														class="button button-small button-raised button-round button-fill"
														style="
															width: 60px;
															height: 60px;
															content: '';
															-webkit-border-radius: 50%;
															-moz-border-radius: 50%;
															border-radius: 50%;
														"
													>
														<i class="material-icons">touch_app</i>
													</div>
												</yo-f7-button>
											</div>
										</div>
									</div>
								</div>
							`)}
						</div>
					</div>
				
					<!-- profile change -->
					<div class="popover popover-filter-button">
						<div class="popover-angle"></div>
						<div class="popover-inner">
							<div class="list">
								<ul>
									<li><a class="list-button popover-close" @click="${()=>changeFilter(-40)}">-40</a></li>
									<li><a class="list-button popover-close" @click="${()=>changeFilter(-50)}">-50</a></li>
									<li><a class="list-button popover-close" @click="${()=>changeFilter(-60)}">-60</a></li>
									<li><a class="list-button popover-close" @click="${()=>changeFilter(-70)}">-70</a></li>
									<li><a class="list-button popover-close" @click="${()=>changeFilter(-80)}">-80</a></li>
								</ul>
							</div>
						</div>
					</div>
					${fixedTop != 0 && $h`
					<div class="toolbar title sliding display-flex justify-content-space-between align-items-center" style="padding:10px 0 ;background: var(--f7-bars-bg-color);position: fixed;height: 60px;">
						<!-- <div class="logo-small display-flex justify-content-center align-items-center" style="width: 50%;text-align: center;height: 100%;">
							<img style="margin-right: 8px;" src="{{ frappe.get_url(nav_app_logo_image) if nav_app_logo_image else appSetting.iconImageUri }}" />
							<a href="/mobile-app/profile-list" class="link">
								${erp.info.profile ? $h`
								<font class="profile_title" style="text-overflow: ellipsis; max-width: 250px; overflow: hidden;font-size: 16px;font-weight: 500;">
									${ erp.info.profile.flat ? tran(erp.info.profile.flat) + '-' : '' }${ tran(erp.info.profile.profile_name) }
								</font>
								` : $h`
								<font class="profile_title" style="text-overflow: ellipsis; max-width: 250px; overflow: hidden;font-size: 16px;font-weight: 500;"> ${ tran('Default') } </font>
								`}
								<div class="home-title-profile-popover" style="margin-left: 5px">
									<i class="icon f7-icons" style="font-size: 14px">chevron_down</i>
								</div>
							</a>
						</div> -->
						<div class="logo-big display-flex justify-content-center align-items-center" style="width: 100%;">
							<a class="link popover-open" data-popover=".popover-filter-button">
								<font class="profile_title" style="text-overflow: ellipsis; max-width: 250px; overflow: hidden;font-size: 16px;font-weight: 500;">
									${_('RSSI: ')+filter_value}
								</font>
								<div class="home-title-profile-popover" style="margin-left: 5px">
									<i class="icon f7-icons" style="font-size: 14px">chevron_down</i>
								</div>
							</a>
							${(engineerMode && engineerModeStatus == true) && $h`
								<a link icon-only @click="${()=>EngineerModeCheck()}" style="margin-right: 10px;">
									<i class="icon material-icons md-only text-color-gray" style="font-size: 25px;">construction</i>
								</a>
								<a link icon-only @click="${()=>EngineerModeCheck(true)}" style="margin-right: 10px;">
									<i class="icon material-icons md-only text-color-gray" style="font-size: 25px;">browser_updated</i>
								</a>
							`}
							${(engineerMode && engineerModeStatus == false) && $h`
							<a link icon-only @click="${()=>changeEngineerModeStatus(true)}" style="margin-right: 10px;">
								<i class="icon material-icons md-only text-color-gray" style="font-size: 40px;">toggle_off</i>
							</a>
							`}
							${(engineerMode && engineerModeStatus == true) && $h`
								<a link icon-only @click="${()=>changeEngineerModeStatus(false)}" style="margin-right: 10px;">
									<i class="icon material-icons md-only text-color-theme" style="font-size: 40px;">toggle_on</i>
								</a>
								`}
						</div>
					</div> 
					`}
					<!-- profile change end -->
					
					<!-- home room toolbar -->
				${subdevices.length > 0 && $h`
				<div
					class="toolbar tabbar tabbar-scrollable toolbar-home-room"
					style="
						z-index: 5;
						position: fixed;
						${page_margin_top>100?'margin-top:104px;':''}
						${show_noroom?'display:none;':''}
						${show_nosubdevice?'display:none;':''}
						${fixedTop != 0?'margin-top:60px;':''}
					"
				>
					<div class="toolbar-inner" style="padding-right:40px">
						<a
							ref="0"
							id="room-bar-title-0"
							@click="${()=>show_room(0,1)}"
							class="tab-link tab-link-active"
						>
							<i class="material-icons">home</i>
						</a>
						${rooms.map((item)=> $h`
							${item.subdevices_count > 0? $h`
										<a
											ref="${item.idx}"
											id="room-bar-title-${item.name}"
											@click="${()=>show_room(item.name,item.subdevices_count)}"
											class="tab-link"
											key="${item.name}"
										>
											${tran(item.title)}
										</a>
							`: $h`
									<a></a>
							`}
						`)}
					</div>
					${profilePermision && $h`
					<div class="room-more-icon-box" style="background-color: var(--f7-theme-color);">
						<a href="/mobile-app/ha-room-list?page_type=2" class="button" style="color: #fff;">
							<i class="material-icons">more_vert</i>
						</a>
					</div>
					`}
				</div>
				`}
				<!-- for rooms switch -->
				<div class="tabs" style="display: none">
					<div id="tab-hidden-0" class="page-content tab tab-active"></div>
					${rooms.map((item)=> $h`
					<div id="tab-hidden-${item.idx}" class="page-content tab"></div>
					`)}
				</div>
					
					<!-- no room show -->
					<div style="${show_noroom?'':'display:none;'}${show_nosubdevice?'display:none;':''}">
						<div class="block" style="text-align: center;">
							<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
							<p>${_('You don\'t have any room, create one')}</p>
						</div>
						<div class="block block-strong">
							<p class="row">
								<a class="col button button-large" href="/mobile-app/app-room-detail-page?roomTitle=${_('New Room')}"
									>${ _('Create Room') }</a
								>
							</p>
						</div>
				</div>
				
				<!-- no device show -->
					<div style="${show_nosubdevice?'':'display:none;'}">
						<div class="block" style="text-align: center">
							<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
							<p>${_('You don\'t have any devices, create one.')}</p>
						</div>
						<div class="block block-strong">
							<p class="row">
								<a class="col button button-large" href="/mobile-app/yoswit-device-type"
									>${ _('Create Device') }</a
								>
							</p>
						</div>
					</div>
				
					${subdevices.length > 0 && $h`
						<div style="height: ${page_margin_top+fixedTop}px;"></div>
				`}
				
				<!-- rooms -->
				${rooms.map((item)=> $h`
						${item.subdevices_count > 0? $h`
								<div id="room-${item.name}-div" key="${item.name}" class="list media-list no-margin">
									<ul>
										<li id="room-${item.name}-div-title" room="${tran(item.name)}" class="swipeout room" ref="${item.idx}">
											<div class="item-content swipeout-content">
												<div class="item-inner">
													<div class="item-title-row">
														<!-- title text -->
														<div
															class="item-title"
															lang="en"
															lang-packet="${item.title}"
															@click="${()=>collapse_room(item.name)}"
															ref="${item.name}"
														>
															<i class="room-collapse material-icons" id="collapse-${item.idx}"> expand_more </i>
															${ tran(item.title) }
														</div>
														
														<!-- click to turn on all device in room -->
														<div class="item-after">
															<p class="segmented segmented-raised segmented-round" style="display: none">
																<button class="button button-round link" func="controller_common_home_click_room_onoff" ref="1">Off</button>
																<button class="button button-round link" func="controller_common_home_click_room_onoff" ref="0">On</button>
															</p>
														</div>
													</div>
												</div>
												<div class="control-panel-right" style="width: 240px;overflow: hidden;">
													${roomScenes.map((sceneItem)=> $h`
														${sceneItem.profile_room == item.name? $h`
													<a class="right" @click="${()=>home_auto_click_scene(sceneItem)}">
														<div class="button button-raised button-big rf-sensor" style="width: 70px;height: 50px;margin-top: 3px;border-radius: 10px;background-color: #fff;margin-left: 5px;">
															<span class="icons" style="line-height: 50px !important;font-size: 14px;color:var(--f7-tabbar-link-inactive-color);">${sceneItem.title}</span>
														</div>
													</a>
													`: $h`
													<a style="display: none;"></a>
														`}
													`)}
												</div>
											</div>
											<div class="swipeout-actions-right">
												<a
												href="/mobile-app/app-room-detail-page?roomName=${item.name}&roomTitle=${_('Edit')}${tran(item.title)}"
													class="link color-orange"
												>
													<i class="icon material-icons">settings</i>
												</a>
												<a
												@click="${()=>toFavorite()}"
													class="link color-yellow"
													style="display: none;"
												>
													<i class="icon material-icons">favorite</i>
												</a>
												<a
												@click="${()=>applyFavoriteRoom(item.name)}"
													class="link color-blue"
													style="display: none;"
												>
													<i class="icon material-icons">save</i>
												</a>
											</div>
										</li>
										<div class="room-item ${listCssStatus == 'Card'?'display-flex justify-content-space-between':''}" style="${listCssStatus == 'Card'?'flex-wrap: wrap;padding: 15px;':''}">
										${subdevices.map((kitem)=> $h`
											<div class="${kitem.profile_room === item.name && kitem.hidden == 0 && listCssStatus == 'Card'?'show-item':''}" style="${(kitem.device_button_group == 'Thermostat' || kitem.device_button_group == 'DIMMING' || kitem.device_button_group.startsWith('RCU DIMMING') || kitem.device_button_group.startsWith('OPENCLOSE GANG') || kitem.device_button_group.startsWith('OPENCLOSE UART') || kitem.device_button_group.startsWith('OPENCLOSE WIFI UART') || kitem.device_button_group.startsWith('Air Conditioner') || kitem.device_button_group.startsWith('IR-DIY') || kitem.device_button_group.startsWith('IAQ')  || listCssStatus == 'List') && (screen.availWidth < 500 || listCssStatus == 'List')?'width: 100%;':'width: 49%;'}${kitem.profile_room === item.name && kitem.hidden == 0?'':'display:none;'}">
												${kitem.profile_room === item.name && kitem.hidden == 0? $h`
														
														<li
															style="${listCssStatus == 'Card'?'min-height : 150px;':''}"
																class="device home-scanned-peripheral swipeout swipeout-delete-manual home-scanned-peripheral-smart grid grid-cols-2 medium-grid-cols-4 grid-gap"
															@swipeout:deleted="${()=>onDeleted(kitem)}" guid="${kitem.device}" is-input="${kitem.device_button_group.startsWith('RCU INPUT')?1:0}" button_group="${kitem.device_button_group}" config="${kitem.config}" subdevice_name="${kitem.name}" key="${kitem.name}${md5(kitem.device_attachment_status)}"
														>
															<div class="item-content swipeout-content">
																<a class="item-link item-content no-chevron no-ripple no-active-state" style="${listCssStatus == 'Card'?'flex-wrap: wrap;':''}">
																	<div
																		class="priority-thumb device-thumb item-media display-flex justify-content-center flex-direction-row align-content-center"
																		style="
																			background-position: center;
																			background-size: contain;
																			position: relative;
																			background-image: url('${kitem.thumb}');
																		"
																		@click="${()=>testFun(kitem)}"
																	>
																			${(kitem.device_model && kitem.device_model.includes('YO360')) && $h`
																			<span class="thermostat-current-temp" style="font-size: 12px;display:none;">${kitem.device_attachment_status && kitem.device_attachment_status.split(",")[4]>0?parseInt(kitem.device_attachment_status.split(",")[4]):''}</span><span class="${kitem.device_attachment_status && kitem.device_attachment_status.split(',')[4]>0?'':'device-none'}" style="font-size: 12px;display:none;" >℃</span>
																			`}
																			<!--<i class="prioritysss icon material-icons text-color-red device-none" style="font-size: 35px;">priority_high</i>-->
																			<!--<i class="priorityss icon material-icons text-color-orange ${kitem.mac_error_status?'':'device-none'}" style="font-size: 35px;">priority_high</i>-->
																			<i class="prioritys icon material-icons text-color-yellow ${kitem.guid_status?'device-none':''}" style="font-size: 35px;">priority_high</i>
																			<i class="priority icon material-icons text-color-orange ${kitem.scene_status || !kitem.guid_status?'device-none':''}" style="font-size: 35px;">priority_high</i>
																			<!--<i class="priority icon material-icons text-color-red device-none" style="font-size: 35px;">priority_high</i>-->
																		</div>
																	<div class="item-inner" style="${listCssStatus == 'Card'?'width: 100%;margin-left: 0;':''}">
																		<div class="item-title-row">
																			<div class="item-title ellipsis" lang="en" style="width: 190px" title="${kitem.title}">${tran(kitem.title)}</div>
																		</div>
																		<div class="item-subtitle">${ kitem.device_model }-${ kitem.device_name.toLowerCase() }</div>
																		${profilePermision && $h`
																		<div class="signal-panel item-text height-21" style="width: 120%">
																				<${renderSignalItem} kitem="${kitem}" key="${kitem.signalRfresh}${kitem.mn_head_connected}${kitem.mn_tail_set}${kitem.mn_head_set}${kitem.mn_tail_connected}${kitem.device_attachment_status}"/>
																		</div>
																		`}
																	</div>
																</a>
																${profilePermision && $h`
																<${renderSwipeLeftPanel} kitem="${kitem}" leftMenuPermision="${leftMenuPermision}"/>
																<${renderSwipeRightPanel} kitem="${kitem}" leftMenuPermision="${leftMenuPermision}" />
																<${renderMainButton} kitem="${kitem}" key="${md5(JSON.stringify(kitem))}"/>
																`}
															</div>
														</li>
														<${renderBottomButton} kitem="${kitem}" key="${md5(kitem.device_attachment_status)}${md5(kitem.config?kitem.config:'')}${md5(kitem.device_config?kitem.device_config:'')}${md5(md5(updateTime+''))}"/>
																			`  : $h`
																					<a style="display: none;"></a>
																			`}
													</div>
										`)}
															</div>
													</ul>
											</div>
					` : $h`
							<div id="room-${item.name}-div" class="room-device-null"></div>
					`}
							`)}
				</div>
				${!engineerModeStatus && $h`	
				<div id="room-0-div" class="list media-list no-margin ${show_unassigned?'':'device-none'}">
					<ul>
						<li class="room">
							<div class="item-content">
								<div class="item-inner">
									<div class="item-title-row">
										<div class="item-title" lang="en" lang-packet="Unassigned" func="controller_common_home_collapse" ref="0">
											<i class="room-collapse material-icons" id="collapse-0"> expand_more </i>
											{{ _('Unassigned') }}
										</div>
									</div>
								</div>
							</div>
						</li>
						<div class="unassigned-box ${listCssStatus == 'Card'?'display-flex justify-content-space-between':''}" style="${listCssStatus == 'Card'?'flex-wrap: wrap;padding: 15px;':''}">
									${unassigned_subdevices.map((kitem)=> $h`
							<div class="${listCssStatus == 'Card'?'show-item':''}" style="${(kitem.device_button_group == 'Thermostat' || kitem.device_button_group == 'DIMMING' || kitem.device_button_group.startsWith('RCU DIMMING') || kitem.device_button_group.startsWith('OPENCLOSE GANG') || kitem.device_button_group.startsWith('OPENCLOSE UART') || kitem.device_button_group.startsWith('OPENCLOSE WIFI UART') || kitem.device_button_group.startsWith('Air Conditioner') || kitem.device_button_group.startsWith('IR-DIY') || kitem.device_button_group.startsWith('IAQ') || listCssStatus == 'List') && (screen.availWidth < 500 || listCssStatus == 'List')?'width: 100%;':'width: 49%;'}">
							<li 
								class="device home-scanned-peripheral home-scanned-peripheral-smart swipeout swipeout-delete-manual"
								style="${kitem.disappear?'display:none;':''}${listCssStatus == 'Card'?'min-height : 150px;':''}"
								guid="${kitem.device}"
								button_group="${kitem.device_button_group}"
								is-input="${kitem.device_button_group.startsWith('RCU INPUT')?1:0}"
								display-name="${tran(kitem.name.substring(0, 16))}"
							>
								<div class="item-content swipeout-content">
									<a class="item-link item-content no-chevron no-ripple no-active-state" func="ble_load_to_device_form_auto" style="${listCssStatus == 'Card'?'flex-wrap: wrap;':''}">
										<div
											class="device-thumb item-media"
											style="
												background-position: center;
												background-size: contain;
												position: relative;
															background-image: url('${kitem.thumb}');
											"
										></div>
										<div class="item-inner" style="${listCssStatus == 'Card'?'width: 100%;margin-left: 0;':''}">
											<div class="item-title-row">
												<div class="item-title ellipsis" lang="en" style="width: 190px" title="${tran(kitem.name)}">
													<i class="material-icons text-muted" style="position: relative; top: 5px">settings</i>
													${kitem.name.substring(0, 16)}
												</div>
											</div>
											<div class="item-subtitle">${kitem.device_model }-${ kitem.device_name.substring(0, 12).toLowerCase() }</div>
											<div class="signal-panel item-text height-21" style="width: 120%">
													<${renderSignalItem} kitem="${kitem}" key="${kitem.signalRfresh}"/>
											</div>
										</div>
									</a>
												<${renderMainButton} kitem="${kitem}" render_type="unassigned" key="${md5(JSON.stringify(kitem))}"/>
								</div>
							</li>
							<${renderBottomButton} kitem="${kitem}" />
							</div>
											`)}
							
						</div>
					</ul>
				</div>
				`}
		</div>
	</div>
</template>

<script>
let filter_value = -60;
let engineerMode = false;
//defined components
const renderSignalItem = (props, {
	$h
}) => {
	let device_models = erp.doctype.device_model ? JSON.parse(JSON.stringify(erp.doctype.device_model)) : {};
	let wifiModel = [];
	for(let device_model in device_models){
		if(device_models[device_model].mode_type == 'Wifi'){
			wifiModel.push(device_models[device_model].model_code);
		}
	}
	//defined the wifi model
	//let wifiModel = ['YO360','M360s', 'YO360-R2W','YO121-AC','YO304','YO780-Scene-6G', 'YO780-Scene-12G','YO780-Scene-4G',,'YO780-Scene-3G','YO780-Scene-2G','YO780-Scene-1G', 'YO780', 'YO105','YO790DC','YO121-AC-R2W'];
	let this_model = props.kitem.device_model;
	let wifiIndex = wifiModel.indexOf(this_model);
	let wifiShowStatus = wifiIndex > -1 ? true : false;
	let devices = cloneDeep(erp.info.device);
	let wifiSetStatus = false;
	if(props.kitem.device){
		let deviceMap = devices[props.kitem.device];
		if(deviceMap){
			let settings = deviceMap.settings;
			settings.forEach(item=>{
				if(item.setting_type == 'Wifi Password' && item.setting!= ''){
					wifiSetStatus = true;
					
				}
			})
		}
	}
	//thermosta config,if yo360-r2w,should show the humidity
	let thermostaHumStatus = false;
	let humidityText = 0;
	let thermostaTempStatus = false;
	let thermostaTempText = 26;
	if(this_model == 'YO360-R2W' || this_model == 'M360s'){
		thermostaHumStatus = true;
		console.log("device_attachment_status",props.kitem.device_attachment_status);
		humidityText = props.kitem.device_attachment_status.split(",")[5];
		
	}
	if(this_model.includes('360')){
		thermostaTempStatus = true;
		thermostaTempText = props.kitem.device_attachment_status.split(",")[4]>0?props.kitem.device_attachment_status.split(",")[4]:26;
	}
	//mutiway config
	let multiwayConfig = {};
	let pairStatus = false; 
	if(props.kitem.device_mode == "Multiway Switch"){
		multiwayConfig = props.kitem.config?JSON.parse(props.kitem.config):{};
		pairStatus = multiwayConfig.mapping?true:false;
	}
	const fixNetwork = (kitem,is_mesh_status)=>{
		if(!kitem.network_id){
			return
		}
		if(is_mesh_status){
			return
		}
		if(kitem.rssilv == 0){
			app.dialog.alert(`${_('Device is not here')}`);
			return
		}
		app.dialog.preloader(`${_('Network Repair In Progress')}`)
		let network_id = kitem.network_id;
		let network_position = kitem.network_position;
		let devices = cloneDeep(erp.info.profile.profile_device);
		let networkIdList = devices.filter((e)=>e.network_id == network_id && e.network_id != 0).sort((a,b)=>{
			return a.network_position-b.network_position;
		})
		let headBytes = '';
		let tailBytes = '';
		if(network_position == 0){
			headBytes= `8500010000000000000000000000`;
			tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)+1].device,true).toLowerCase()}0100000000`;
		}else if(network_position == networkIdList.length-1){
			headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)-1].device,true).toLowerCase()}0000000000`;
			tailBytes = `8500010000000000000100000000`;
		}else{
			headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)-1].device,true).toLowerCase()}0000000000`;
			tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)+1].device,true).toLowerCase()}0100000000`;
		}
		let meshCommands = ['85000000', '850200', tailBytes, '850201', headBytes, '850200'];
		let bleList = [];
		meshCommands.forEach(zitem=>{
			bleList.push({
				service: 'ff80',
				characteristic: 'ff81',
				data: zitem,
			})
		})
		bleList.push({
			service: 'ff80',
			characteristic: 'ff81',
			data: '810e',
		})
		try{
			console.log('bleList',bleList)
			peripheral[kitem.device].write(bleList);
			app.dialog.close();
			app.dialog.alert(`${_('Repair completed. The device networking will take some time. Please pay attention to the changes in the networking status.')}`)
		}catch(error){
			app.dialog.close()
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	const definedDeviceNetworkStatus = (network_id,head_connected,head_set,tail_connected,tail_set,is_mobmob,rssilv) =>{
		let is_mesh = false;
		if(network_id){
			is_mesh = true
			if(rssilv){
				if(head_set){
					if(!head_connected){
						is_mesh = false;
					}
				}
				if(tail_set){
					if(!tail_connected){
						is_mesh = false;
					}
				}
			}
		}
		return is_mesh;
	}
	let is_mesh_status = definedDeviceNetworkStatus(props.kitem.network_id,props.kitem.mn_head_connected,props.kitem.mn_head_set,props.kitem.mn_tail_connected,props.kitem.mn_tail_set,props.kitem.mobmob,props.kitem.rssilv);
	if(props.kitem.device == '30346565303331666337376212012e1d'){
		debugger
		console.log("is_mesh_status",is_mesh_status)
	}
	return () => $h`
			<div class="signal-view-main" signal="${isset(props.kitem.rssilv)?props.kitem.rssilv:0}" mn-size="${props.kitem.mn_size}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob}" mesh="${(props.kitem.network_id>0 && props.kitem.mn_size > 0 && props.kitem.device)?1:0}" mobilehub="${props.kitem.is_mobile_gateway?props.kitem.is_mobile_gateway:0}">
			<div class="signal"></div>
			<div class="bluetooth">${props.kitem.bluetooth_count && props.kitem.bluetooth_count > 0?props.kitem.bluetooth_count:''}</div>
			<div class="mesh" guid="${props.kitem.device}" @click="${()=>fixNetwork(props.kitem,is_mesh_status)}">
				${(props.kitem.network_id>0 && !is_mesh_status) && $h`
				<i class="prioritys icon material-icons text-color-red" style="font-size: 20px;position: relative;top: -6px;">priority_high</i>
				`}
			</div>
			<div class="mobmob">
				${props.kitem.mobmob == 2 && $h`
				<i class="prioritys icon material-icons text-color-red" style="font-size: 20px;position: relative;top: -3px;">priority_high</i>
				`}
			</div>
			<div class="wifiicon ${wifiShowStatus?'':'device-none'}" guid="${props.kitem.device}" button_grou="${props.kitem.device_button_group}" style="float:left;">
            <i class="material-icons ${props.kitem.mobmob && wifiSetStatus?'text-color-green':'text-color-red'}" style="font-size:22px;">${props.kitem.mobmob && wifiSetStatus?'wifi':"wifi_off"}</i>
						<i class="prioritys icon material-icons text-color-red device-none" style="font-size: 20px;position: relative;top: -8px;left: -21px;">priority_high</i>
      </div>
			<div class="thermostat-humidity ${thermostaHumStatus?'':'device-none'}" style="float:left;width:50px;">
				<i class="material-icons text-color-green" style="font-size:22px;">water_drop</i>
				<span class="thermostat-humidity-text" style="color:#gray;position:relative;top:-5px;font-size:12px;">${humidityText}%</span>
			</div>
			<div class="thermostat-temp ${thermostaTempStatus && thermostaTempText > 0?'':'device-none'}" style="float:left;width:50px;">
				<i class="material-icons text-color-green" style="font-size:22px;">thermostat</i>
				<span class="thermostat-temp-text" style="color:#gray;position:relative;top:-5px;font-size:12px;">${parseInt(thermostaTempText)}℃</span>
			</div>
			<div class="iostatus"></div>
			${(props.kitem.device_mode == 'Parking Lock' || props.kitem.device_mode == 'Geomagnetic') && $h`
			<div class="battery" mode="${props.kitem.device_mode}" battery="${props.kitem.battery?props.kitem.battery:5}"><i class="material-icons text-color-green">${props.kitem.battery == 5?'battery_full':props.kitem.battery == 4?'battery_6_bar':props.kitem.battery == 3?'battery_5_bar':props.kitem.battery == 2?'battery_4_bar':props.kitem.battery == 1?'battery_2_bar':'battery_full'}</i></div>
			`}
			${pairStatus && $h`
			<div class="ir-signal-cooker" mode="${props.kitem.device_mode}" ref="${
        props.kitem.device_status > 0 ? 1 : 0
      }"><i class="material-icons radio-button-unchecked" style="font-size:22px;color:#cbcbcb;">radio_button_unchecked</i><i class="material-icons circles" style="font-size:22px;">circle</i>
      </div>
			`}
			<div class="rcu-virtual-button ${props.kitem.device_mode == 'RCU Controller' && props.kitem.device_button_group == 'SCENE MUTIWAY ONOFF GANG1'?'':'device-none'}"  ref="${props.kitem.device_status?1:0}">
				<i class="material-icons radio-button-unchecked" style="font-size:22px;color:#cbcbcb;">radio_button_unchecked</i><i class="material-icons circles" style="font-size:22px;">circle</i>
			</div>
			
			</div>
		`;
};

const renderSwipeLeftPanel = (props, {
	$h,
	$update
}) => {
	let leftMenuPermision = props['leftmenupermision'];
	let deviceTimerPermision = true;
	let deviceTimerNoSupportMode = ['Gateway','IAQ Sensor','Parking Lock','RCU Controller','Music Player','Hdmicec','Access Controller','Door Sensor'];
	if(deviceTimerNoSupportMode.indexOf(props.kitem.device_mode) > -1){
		deviceTimerPermision = false;
	}
	const click_toggle_connect = (kitem) => { 
		if (!isset(peripheral[kitem.device])) {
			// invalid guid
		}
		//check if bg000 device ,this must be ble connect
		let checkBgStatus = false
		// for(let deviceMap in peripheral){
		// 	if(!isset(peripheral[deviceMap].prop.hexModel)){
		// 		continue;
		// 	}
		// 	if((peripheral[deviceMap].prop.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[peripheral[deviceMap].prop.hexModel]) && !isset(peripheral[kitem.device].prop.rssi) && peripheral[deviceMap].prop.id == peripheral[kitem.device].prop.id){
		// 		//debugger
		// 		checkBgStatus = true;
		// 	}
		// }
		if(checkBgStatus){
			app.dialog.confirm(`${_('Detected an abnormal device. Would you like to repair it?')}`,()=>{
				kitem.id = peripheral[kitem.device].prop.id;
				manufacturing_device(kitem);
			},()=>{})
			return;
		};
		let prop = peripheral[kitem.device].getProp();
		if (prop.connected || prop.connecting) {
			peripheral[kitem.device].disconnect().then((rs) => {
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",0);
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.signal-view-main').attr("bluetooth",0);
				$update();
			}, (error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
			});
		} else {
			peripheral[kitem.device].connect().then((rs) => {
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find(".signal-view-main").attr("bluetooth",1);
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
				$update();
				if(isset(window.deviceDebugMap) && isset(window.deviceDebugMap[props.kitem.device])){
					const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
					window.deviceDebugMap[kitem.device]['logList'].push({
						timestamp:now,
						operate:'Connect',
						control_source:`bluetooth`, //MobMob,Bluetooth,Network,Http
						connectStatus : true,
						errorCode : 0
					})
			}
			}, (error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(kitem.device).then(()=>{
						$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}
				const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
				if(isset(window.deviceDebugMap) && isset(window.deviceDebugMap[props.kitem.device])){
					window.deviceDebugMap[kitem.device]['logList'].push({
						timestamp:now,
						operate:'Connect',
						control_source:`BLUETOOTH`, //MobMob,Bluetooth,Network,Http
						connectStatus : true,
						errorCode : erp.get_log_description(error)
					})
				}
			});
		}
	};
	const toScene = async (item) => {
		//delete undefined values
		for (let i in item) {
			if (!isset(item[i])) {
				delete item[i]
			}
		}
		//mainView.router.navigate(`/mobile-app/scene-list?sceneitem=${encodeURIComponent(JSON.stringify(item))}`);
		mainView.router.navigate(`/mobile-app/scene-guid-list?subdevice_name=${item.name}`)
	};
	const openDebug = (item)=>{
		if(isset(window.deviceDebugMap)){
			if(!window.deviceDebugMap[item.device]){
				window.deviceDebugMap[item.device] = {};
				window.deviceDebugMap[item.device]['debug'] = true;
				window.deviceDebugMap[item.device]['logList'] = [];
			}
		}else{
			window.deviceDebugMap = {};
			window.deviceDebugMap[item.device] = {}
			window.deviceDebugMap[item.device]['debug'] = true;
			window.deviceDebugMap[item.device]['logList'] = [];
		}
		let title = `${tran(item.title)} ${_('Log Debug Mode Opened')}`;
		app.dialog.alert(`${title}`);
	}
	return () => $h`
			<div class="swipeout-actions-left">
				<a
					href="/mobile-app/ha-device-setting-connections?guid=${props.kitem.device}&subdevice_name=${props.kitem.name}"
					class="link color-orange"
					><i class="icon material-icons">integration_instructions</i></a
				>
				<a @click="${()=>toScene(props.kitem)}" class="link color-cust-green"
					><i class="icon material-icons">motion_photos_auto</i></a
				>
				<a
					href="/mobile-app/timer-guid-list?guid=${props.kitem.device}&subdevice_name=${props.kitem.name}"
					class="link color-cust-blue ${deviceTimerPermision?'':'device-none'}"
					><i class="icon material-icons">alarm</i></a
				>
				<a
					@click="${()=>openDebug(props.kitem)}"
					class="link color-orange ${leftMenuPermision?'':'device-none'}"
					><i class="icon material-icons">adb</i></a
				>
				<a class="link color-cust-purple" @click="${()=>click_toggle_connect(props.kitem)}"
					><i class="icon material-icons">settings_bluetooth</i></a
				>
			</div>
		`;
};


const renderSwipeRightPanel = (props, {
	$h
}) => {
	const kitem = props.kitem;
	let leftMenuPermision = props['leftmenupermision'];
	let deviceControlLogPermision = true;
	//let deviceControlLogNoSupportMode = ['Gateway','IAQ Sensor','Parking Lock','RCU Controller','Radar Sensor','Music Player','Hdmicec','Geomagnetic','Access Controller','RF Sensor','Door Sensor'];
	deviceControlLogNoSupportMode = ['Gateway'];
	if(deviceControlLogNoSupportMode.indexOf(props.kitem.device_mode) > -1){
		deviceControlLogPermision = false;
	}
	let deviceRefreshPermision = false;
	if(props.kitem.device_mode == 'Geomagnetic' || props.kitem.device_mode == 'Radar Sensor' || props.kitem.device_mode == 'IAQ Sensor' || props.kitem.device_mode == 'Parking Lock' || props.kitem.device_mode == 'Door Sensor'){
		deviceRefreshPermision = true;
	}
	/**
 * function description
 *
 * @param 
 * @param 
 * @param 
 * @return 
 */
	const deviceReplaceSearchDevice = ()=>{
		
	};
	const refreshDevice = (kitem)=>{
		app.dialog.preloader(_('Refreshing...'));
		let guid = kitem.device;
		let data_1 = '9380';//sensor data
		let data_2 = '9381';//control data
		try{
			window.peripheral[guid].write([{
				service: 'ff80',
				characteristic: 'ff81',
				data: data_1,
			},{
				service: 'ff80',
				characteristic: 'ff81',
				data: data_2,
			}]);
			app.dialog.close();
			// Create toast
      if (!window.toastBottom) {
        window.toastBottom = app.toast.create({
          text: _('Refresh Successfully'),
          closeTimeout: 2000,
        });
      }
      // Open it
      window.toastBottom.open();
		}catch(error){
			app.dialog.close();
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	return () => $h`
			<div class="swipeout-actions-right">
				<a
					class="link color-cust-purple ${engineerModeStatus?'':'device-none'}"
					guid="${kitem.device}"
					profile-device-name="${kitem.profile_device}"
					profile-subdevice-name="${kitem.name}"
					ref="${kitem.device}|${kitem.mac_address}|${kitem.device_model}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					func="iot_check_all_settings"
					><i class="icon material-icons">construction</i></a
				>
				<a
					href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(kitem.title))}&guid=${ kitem.device }&name=${kitem.name}&profile_device_name=${kitem.profile_device}&device_mode=${kitem.device_mode}&slot_index=${kitem.config?kitem.config:''}"
					class="link color-orange"
					><i class="icon material-icons">settings</i></a
				>
				<a
					class="link color-cust-green"
					ref="${kitem.device}|${kitem.device_name?kitem.device_name.substring(0,12):''}|${kitem.device_mode}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					href="/mobile-app/device-replace-page?guid=${ kitem.device?kitem.device:'' }&title=${_('Replace')} ${encodeURIComponent(tran(kitem.title))}&name=${kitem.name}&filter_value=${filter_value}"
					><i class="icon material-icons">download</i></a
				>
				<a
					class="link color-cust-purple ${deviceRefreshPermision?'':'device-none'}"
					guid="${kitem.device}"
					@click="${()=>refreshDevice(kitem)}"
					><i class="icon material-icons">refresh</i></a
				>
				<a
					class="link color-cust-grey ${deviceControlLogPermision?'':'device-none'}"
					guid="${kitem.device}"
					ref="${kitem.device}|${kitem.mac_address}|${kitem.device_model}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					func="iot_reset_password"
					><i class="icon material-icons">restart_alt</i></a
				>
				<a
					href="/mobile-app/device-control-log?profile_subdevice=${kitem.name}&guid=${kitem.device}"
					class="link color-cust-blue ${deviceControlLogPermision?'':'device-none'}"
					><i class="icon material-icons">content_paste_go</i></a
				>
				<!-- <a func="app_set_device_hidden" ref="${kitem.name}" class="link color-cust-green"
					><i class="icon material-icons">visibility</i></a
				>-->
				<a href="#" data-confirm="${_('Are you sure you want to delete this item?')}" class="link swipeout-delete"
					><i class="icon material-icons">delete</i></a
				>
			</div>
		`;
};

let engineerModeStatus = false;
let wifiInfoMap = {
	ssid : '',
	password : ''
}
const renderMainButton = (props, {
	$h,
	$update
}) => {
	//console.log(props.render_type);
	const mode = props.kitem.device_mode;
	window.dealwithBleCommand = async(uuid,commandList)=>{
		let writeStatus = true;
		let bleWriteCount = 0;
		for(let commands in commandList){
			try{
				await ble.withPromises.write(uuid,'ff80','ff81',commands.toLocaleLowerCase().convertToBytes());
				bleWriteCount++;
			}catch(error){
				writeStatus = false;
			}
		}
		return new Promise((resolve,reject)=>{
			if(writeStatus && bleWriteCount == commandList.length){
				resolve(1)
			}else{
				reject(0)
			}
		})
	}
	window.manufacturing_device = async(kitem)=>{
		console.log(kitem);
		app.dialog.preloader(_('Connecting...'));
		//get the device info pass the mac_address
		//get the mac_address
		let uuid = kitem.id;
		try{
			ble.connect(uuid,(rs)=>{
				//read mac
				let service="180a", characteristic="2a23";
				ble.read(uuid, service, characteristic,(data)=>{
					let macaddress = data.toLowerCase();
					let iot_macaddress = '';
					while (macaddress.length < 16) macaddress = macaddress + "0";
					if (macaddress.substring(6, 10) === "0000") {
							let i = macaddress.length - 2;
							while (i >= 0) {
								if ((i >= 10 || i <= 4) && i > 0) {
									iot_macaddress += macaddress.substring(i, i + 2) + ":";
								}
								if (i === 0) {
									iot_macaddress += macaddress.substring(i, i + 2);
								}
								i = i - 2;
							}
						} else {
							let i = macaddress.length - 6;
							while (i >= 0) {
								if (i > 0) {
									iot_macaddress += macaddress.substring(i, i + 2) + ":";
								}
								if (i === 0) {
									iot_macaddress += macaddress.substring(i, i + 2);
								}
								i = i - 2;
							}
						}
						console.log(iot_macaddress);
						let macs = iot_macaddress.split(":");
						//compare to the erp data
						http2.request(`${encodeURI(`/api/method/appv6.getDeviceByMac?mac_address=${iot_macaddress}`)}`, {
                method: 'GET',
                serializer: 'json',
                responseType: 'json',
								debug:true
              }).then((resData)=>{
								let devices = resData.data.data;
								console.log("devices",devices);
								if(devices.length > 0){
									let this_guid = devices[0].guid;
									//wirte the guid in device 
									let numbers_data = `88014B${macs[3]}${macs[0]}A16E95`;
									// write super password 
									let paw_data = `880083${macs[2]}${macs[5]}543e15`;
									let this_data = `8100${this_guid}`;
									debugger
									return new Promise((resolve,reject)=>{
										ble.write(uuid,"ff80", "ff81",numbers_data.toLocaleLowerCase().convertToBytes(),()=>{
											ble.write(uuid,"ff80", "ff81",paw_data.toLocaleLowerCase().convertToBytes(),()=>{
												ble.write(uuid,"ff80", "ff81",this_data.convertToBytes(),()=>{
													resolve(1);
												},(writeError)=>{
													reject(writeError);
												})
											},()=>{});
										},()=>{

										})
									})
								}else{
									return new Promise((resolve,reject)=>{
										reject('The device has not been initialized. Please contact the relevant personnel.')
									})
								}
							}).then(()=>{
								let this_data = `810E`;
								return new Promise((resolve,reject)=>{
										ble.write(uuid,"ff80", "ff81",this_data.convertToBytes(),()=>{
											resolve(1);
										},(writeError)=>{
											reject(writeError);
										})
									})
							}).then(()=>{
								setTimeout(()=>{
									ble.connect(uuid,(rs)=>{
										debugger
										ble.disconnect(uuid,(res)=>{
											debugger
											ble.connect(uuid,(rs)=>{
												debugger
												ble.read(uuid, "180a", "2a29",(data)=>{
													debugger
													ble.disconnect(uuid,(res)=>{
														debugger
														ble.connect(uuid,(rs)=>{
															debugger
															ble.read(uuid, "180a", "2a29",(data)=>{
																debugger
															ble.disconnect(uuid,(res)=>{
																//refresh
																app.dialog.close();
																debugger
																//del the device 
																for(let deviceMap in peripheral){
																	if((peripheral[deviceMap].prop.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[peripheral[deviceMap].prop.hexModel]) && peripheral[deviceMap].prop.id == uuid){
																		delete peripheral[deviceMap]
																	}
																}
																//cancel the dvice show status
																// for(let deviceMap in unassigned_subdevices){
																// 	if(unassigned_subdevices[deviceMap].name == 'BG000' && unassigned_subdevices[deviceMap].id == uuid){
																// 		unassigned_subdevices[deviceMap].disappear = true;
																// 	}
																// }
																mainView.router.refreshPage();
															},(err3)=>{
																console.log("err3",err3)
															})
															},()=>{})
														},(err2)=>{
															console.log(err2);
														})
													},()=>{})
												},()=>{

												})
											},(err1)=>{
												console.log("err1",err1)
											})
										},(disconnectError)=>{
											console.log("disconnectError",disconnectError);
											app.dialog.close();
											app.dialog.alert(disconnectError)
										})
									},(connectError)=>{
										console.log("connectError",connectError)
										setTimeout(()=>{
											app.dialog.close();
											mainView.router.refreshPage();
										},6000)
										// app.dialog.close();
										// app.dialog.alert(connectError)
									})
								},6000)
							}).catch(errorss=>{
								app.dialog.close();
								console.log("errorss",errorss)
								app.dialog.alert(_(errorss))
							})
				},(errors)=>{
					app.dialog.close();
					app.dialog.alert(_('Failed to read Mac Address'));
				})
			},(err0)=>{
				console.log("err0",err0)
				// app.dialog.close();
				// app.dialog.alert(err0);
			})
		}catch(error){
			app.dialog.close();
			app.dialog.alert(_('Failed to connect'));
		}
	};
	const click_connect = (kitem) => {
		setTimeout(function() {
			//check if bg000 device ,this must be ble connect
			let checkBgStatus = false
			// for(let deviceMap in peripheral){
			// 	if(!isset(peripheral[deviceMap].prop.hexModel)){
			// 		continue;
			// 	}
			// 	if((peripheral[deviceMap].prop.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[peripheral[deviceMap].prop.hexModel]) && peripheral[deviceMap].prop.id == peripheral[kitem.device].prop.id){
			// 		checkBgStatus = true;
			// 	}
			// }
			if(checkBgStatus){
				app.dialog.confirm(`${_('Detected an abnormal device. Would you like to repair it?')}`,()=>{
					//manufacturing_device(kitem);
				},()=>{})
				return;
			};
			if (peripheral[kitem.device]) {
				peripheral[kitem.device].connect().then((rs) => {
					debugger;
					$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
					$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.signal-view-main').attr("bluetooth",1)
					update_ble_iaq_data(kitem);
					//test connect log 
					const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
					let url = encodeURI('/api/resource/Device Log');
					http2.request(url, {
							method: "POST",
							responseType: "json",
							serializer: 'json',
							data: {
								device : kitem.device,
								owner : users[users.current].usr,
								timestamp : now,
								log_type : '7001',
								details : JSON.stringify({
									description : 'Bluetooth connection timed out'
								})
							}
					})
					$update();
				}).catch((error) => {
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(kitem.device).then(()=>{
							$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
            })
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				});
			}
		}, 1);
	};
	const update_ble_iaq_data = (kitem)=>{
		if(kitem.device_button_group.startsWith("IAQ")){
			//should mtu
			if(deviceInfo.operatingSystem === 'ios'){
				peripheral[kitem.device].write([{
					service: 'ff80',
					characteristic: 'ff81',
					data: `9380`,
				}])
			}else{
				ble.requestMtu(
					peripheral[kitem.device].prop.id,
					512,
					() => {
						console.log('>>>> device request mtu success');
						peripheral[kitem.device].write([{
								service: 'ff80',
                characteristic: 'ff81',
                data: `9380`,
						}])
					},
					(err) => {
						console.log('>>>> device request mtu fail: ' + err);
					}
				)
			}
		}else{
			return
		}
	}
	const click_curtain_switch = (kitem,type)=>{
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},10000)
		if(kitem.device_status == 0){
			props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
		}else{
			props.kitem.device_status = 0;
		}
		$(`.range-slider[guid="${kitem.device}"]`).find(".range-bar-active").css({
			width: props.kitem.device_status + '%'
		})
		$(`.range-slider[guid="${kitem.device}"]`).find(".range-knob-wrap").css({
			left: props.kitem.device_status + '%'
		})
		if (props.kitem.device_status > 1) {
			$(`.page-current .range-slider-home-auto[guid="${kitem.device}"][button_group="${kitem.device_button_group}"]`).removeClass('range-slider-min')
		} else {
			$(`.page-current .range-slider-home-auto[guid="${kitem.device}"][button_group="${kitem.device_button_group}"]`).addClass('range-slider-min')
		}
		if(kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')){
			peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {

			}).catch((error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
						
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}
			});
		}else{
			peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {


			}).catch((error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
						
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}

			});
		}
	}
	const click_curtain_motor = (kitem, type) => {
		//console.log("click_curtain_motor");
		kitem['click_status'] = true;
		kitem['click_button'] = true;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},50000)
		let otherModelStatus = false;
		if(kitem.device_model == 'YO121-AC-R2W') otherModelStatus = true;
		let reverse = kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') || kitem.device_button_group.startsWith('OPENCLOSE WIFI UART REVERSE') ? true : false;
		let bar_value = 0;
		let data = ``;
		if (type) {
			data = "55AA050101036DDC";
			//this have differ model command
			if(otherModelStatus){
				data = '55fefe0303';
				//kitem['pause_status'] = true;
				setTimeout(()=>{
					kitem['click_status'] = null;
				},1000*1)
			}
			kitem['click_button'] = null;
			
		} else {
			//alert(kitem.device_status)
			if (kitem.device_status == 0 || kitem.device_status == 1 || kitem.device_status <0) {
				//props.kitem.device_status = 1;
				//alert(peripheral[kitem.device].getLastOnStatus(kitem.device_button_group))
				props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
				// if (isset(window.dimmingRecord[props.kitem.name]) && window.dimmingRecord[props.kitem.name]['lastref'] > 0) {
				// 	bar_value = window.dimmingRecord[props.kitem.name]['lastref'];
				// } else {
				// 	bar_value = 100;
				// }
			} else {
				props.kitem.device_status = 0;
			}
			//alert(props.kitem.device_status)
			let key = `${kitem.device}_${kitem.device_button_group}`;
			if(isset(range_silder_list[key])){
				range_silder_list[key].setValue(props.kitem.device_status);
				kitem['click_button'] = null;
			}
			// $(`.range-slider[guid="${kitem.device}"]`).find(".range-bar-active").css({
			// 	width: props.kitem.device_status + '%'
			// })
			// $(`.range-slider[guid="${kitem.device}"]`).find(".range-knob-wrap").css({
			// 	left: props.kitem.device_status + '%'
			// })
			// if (props.kitem.device_status > 1) {
			// 	$(`.page-current .range-slider-home-auto[guid="${kitem.device}"]`).removeClass('range-slider-min')
			// } else {
			// 	$(`.page-current .range-slider-home-auto[guid="${kitem.device}"]`).addClass('range-slider-min')
			// }
			if (reverse) {
				data = `55AA060102${(100-props.kitem.device_status*1).toString(16).pad("00")}FF`;
				if(otherModelStatus){
					data = `55fefe0304${(100-props.kitem.device_status*1).toString(16).pad("00")}`;
				}
			} else {
				data = `55AA060102${props.kitem.device_status.toString(16).pad("00")}FF`;
				if(otherModelStatus){
					data = `55fefe0304${props.kitem.device_status.toString(16).pad("00")}`;
				}
			}
		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		let command = "8602" + data.toLowerCase();
		console.log("command",command);
		window.peripheral[props.kitem.device].curtainmotor([{
			gang: bleHelper.getGangId(kitem.device_button_group),
			value: props.kitem.device_status,
			command: command,
			type : isset(type) ? true : false
		}]).then(async()=>{
			//get the device control_source
			let control_source = await bleHelper.getControlSource(kitem.device);
			if(isset(type)){
				let device_type_map = {
					command_type : 'PAUSE',
					device_type : kitem.device_model,
					command : command
				}
				window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name,device_type_map);
			}else{
				window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name);
			}
		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
		$update();
	}
	const click_onoff_thermostat = (kitem) => {
		if (kitem.device_status == 0) {
			props.kitem.device_status = 1;
		} else {
			props.kitem.device_status = 0;
		}
		let data = '9403000001' + parseInt(kitem.device_status).toString(16).pad('00');
		window.peripheral[props.kitem.device].thermostat([{
			gang: bleHelper.getGangId(kitem.device_button_group),
			value: props.kitem.device_status,
			command: data
		}]).then(async()=>{
			let control_source = await bleHelper.getControlSource(kitem.device);
			let device_type_map = {
				command_type : 'ONOFF',
				device_type : kitem.device_model,
				command : data
			}
			window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name,device_type_map);
		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
		//emitter.off(`thermostat_${props.kitem.device}`);
		emitter.emit(`thermostat_${props.kitem.device}`, {
			guid: props.kitem.device,
			ref: props.kitem.device_status
		})
		$update();
	}
	const click_onoff = async(kitem) => {
		let oldStatus = kitem.device_status;
		// try{
		// 	await iot_ble_check_enable();
		// }catch(error){
		// 	app.dialog.alert(error);
		// 	return;
		// }
		kitem['click_status'] = true;
		kitem['click_button'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},1000)
		if (kitem.device_status == 0) {
			if (
				kitem.device_button_group.startsWith('RCU DIMMING') ||
				kitem.device_button_group.startsWith('DIMMING') ||
				kitem.device_button_group.startsWith('GV DIMMING')
			) {
				props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
			} else {
				props.kitem.device_status = 1;
			}
		} else {
			props.kitem.device_status = 0;
		}
		$update();
		setTimeout(function() {
			if (peripheral[kitem.device]) {
				if (kitem.device_button_group.startsWith('RCU ONOFF GANG')) {
					peripheral[kitem.device].rcuOnoff([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then(async()=>{
						let control_source = await bleHelper.getControlSource(kitem.device);
						window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name);
					}).catch((error) => {
						if(error == 7200){
							erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
								
							})
						}else{
							app.dialog.alert(_(erp.get_log_description(error)));
						}
					});
				} else if (kitem.device_button_group.startsWith('DIMMING') || kitem.device_button_group.startsWith('RCU DIMMING') || kitem.device_button_group.startsWith('GV DIMMING')) {
					
					const v = Math.ceil((props.kitem.device_status*1.0 / 255.0) * 100.0) || 0;
					let key = `${props.kitem.device}_${kitem.device_button_group}`;
					if(isset(range_silder_list[key])){
						range_silder_list[key].setValue(v);
						kitem['click_button'] = null;
					}
					// if($(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).length){
					// 		$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`)
					// 			.find('.range-bar-active')
					// 			.css({
					// 				width: v + '%',
					// 			});
					// 		$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`)
					// 			.find('.range-knob-wrap')
					// 			.css({
					// 				left: v + '%',
					// 			});
					// 		if (v > 1) {
					// 			$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).removeClass('range-slider-min');
					// 		} else {
					// 			$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).addClass('range-slider-min');
					// 		}
					// 	}
						if(kitem.device_button_group.startsWith('RCU DIMMING')){
							peripheral[props.kitem.device].rcuDimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(async()=>{
								let control_source = await bleHelper.getControlSource(kitem.device);
								window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name);
							}).catch(error=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}else if(kitem.device_button_group.startsWith('GV DIMMING')){
							peripheral[props.kitem.device].gvDimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(async()=>{
								let control_source = await bleHelper.getControlSource(kitem.device);
								window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name);
							}).catch((error)=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}else{
							peripheral[props.kitem.device].dimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(async()=>{
								let control_source = await bleHelper.getControlSource(props.kitem.device);
								window.upload_device_control_log(props.kitem.device,props.kitem.device_status,control_source,kitem.name);
							}).catch((error)=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}
					
				}else if(kitem.device_model == 'M86-DP'){
					peripheral[kitem.device].doDnd([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then(async()=>{
						let control_source = await bleHelper.getControlSource(kitem.device);
						window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name);
					}).catch(error=>{
						app.dialog.alert(_(erp.get_log_description(error)));
					})

				} else {
					let service = "ff80", characteristic = "ff81";
					let data = [0,0,0,0,0,0,0,0];
					let this_gang = bleHelper.getGangId(kitem.device_button_group);
					data[(4-this_gang)] = 1;
					if(props.kitem.device_status){
						data[(8-this_gang)] = 1;
					}
					data = parseInt(data.join(""), 2).toString(16).toUpperCase().pad("00");
					data = `8000${data}00`;
					peripheral[kitem.device].onoff([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then(async(rs) => {
						let control_source = await bleHelper.getControlSource(kitem.device);
						window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name);
						if(isset(window.deviceDebugMap) && isset(window.deviceDebugMap[props.kitem.device]) && isset(window.deviceDebugMap[props.kitem.device]['logList'])){
							window.deviceDebugMap[props.kitem.device]['logList'].push({
								timestamp:now,
								operate:props.kitem.device_status,
								control_source:`${await peripheral[props.kitem.device].findRoute()}`, //MobMob,Bluetooth,Network,Http
								connectStatus : true,
								command : data,
								service : service,
								characteristic : characteristic,
								button_group : kitem.device_button_group,
								errorCode : 0
							})
						}
					}).catch(async(error) => {
						//if error change the old status
						//check if paw error
						if(error == 7200){
							erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
								
							})
						}else{
							props.kitem.device_status = oldStatus;
							app.dialog.alert(_(erp.get_log_description(error)));
							const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
							if(isset(window.deviceDebugMap) && isset(window.deviceDebugMap[props.kitem.device]) && isset(window.deviceDebugMap[props.kitem.device]['logList'])){
								window.deviceDebugMap[props.kitem.device]['logList'].push({
									timestamp:now,
									operate:props.kitem.device_status,
									control_source:`${await peripheral[props.kitem.device].findRoute()}`, //MobMob,Bluetooth,Network,Http
									connectStatus : false,
									command : data,
									service : service,
									characteristic : characteristic,
									button_group : kitem.device_button_group,
									errorCode : erp.get_log_description(error)
								})
							}
							
							$update();
						}
					});
				}
			}
		}, 1);
	};
	//this bacnet flow
	const bacnet_click_onoff = (kitem)=>{
		let configString = kitem.config;
		if(kitem.device_status == 0){
			kitem.device_status = 1;
		}else{
			kitem.device_status = 0;
		}
		if(configString){
			let config = configString.split("|");
			let airconfig = config[5].split(",");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			temp = tagCode.split("_");
			let roomCode = temp[0];
			let message = [];
			console.log("airconfig[0]",airconfig[0])
			if(airconfig[0] == "1"){
				
				airconfig[0] = "0";
			}else{
				kitem.device_status = 1;
				airconfig[0] = "1";
			}
			config[5] = airconfig.join(",");
			kitem.config = config.join("|");
			message.push({
				"operate": "write",
				"deviceCode": deviceCode,
				"tagCode": roomCode + "_ONOFF_CTRL",
				"val": `${airconfig[0]}`
			});
			message = JSON.stringify(message);
			console.log("message",message)
			core_mqtt_publish(config[1], message, 0, false, false, true);
			try{
				let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
				subdevices.forEach(item=>{
						if(item.name == kitem.name){
								item.config = config.join("|")
						}
				})
				http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
							profile_subdevice : subdevices
					}
			})
			}catch(error){
				console.log(error);
			}
			$update();
			// cordova.plugin.innocow.mqtt.execute({
			// 	command: "publish",
			// 	id: (Math.floor(Math.random() * 100000) + 1),
			// 	topic: config[1],
			// 	msg: message,
			// 	qos: 0,
			// 	retained: false
			// }, function() {}, function() {});
		}

	}
	const bacnet_light_scene_click_onoff = (kitem,type)=>{
		let configString = kitem.config;
		if(configString){
			let config = configString.split("|");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			let message = [];
			message.push({
					"operate":"write",
					"deviceCode":deviceCode,
					"tagCode":tagCode,
					"val":`${type}`
			});
			message = JSON.stringify(message);
			console.log("message",message)
			core_mqtt_publish(config[1], message, 0, false, false, true);
			$update();
		}
	}
	const iot_rcu_output_change = (kitem,type)=>{
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		//let config = kitem.config?JSON.parse(kitem.config):{};
		//let {dnd,clear} = config;
		let dnd = 32;
		let clear = 31;
		let dnd_virtual_button_group = `RCU OUTPUT${dnd}`;
		let clear_virtual_button_group = `RCU OUTPUT${clear}`;
		let dndOldStatus = isset(kitem.dnd)?kitem.dnd:0;
		let clearOldStatus = isset(kitem.clear)?kitem.clear:0;
		if(type == 'dnd'){
			if(kitem.dnd == 0 || !isset(kitem.dnd)){
				props.kitem.dnd = 1;
				//if click this status,change other status
				props.kitem.clear = 0;
			}else{
				props.kitem.dnd = 0;
			}
		}else if(type == 'clear'){
			if(kitem.clear == 0 || !isset(kitem.dnd)){
				props.kitem.clear = 1;
				props.kitem.dnd = 0;
			}else{
				props.kitem.clear = 0;
			}
		}
		peripheral[kitem.device].rcuOutput([{
			gang: bleHelper.getGangId(dnd_virtual_button_group),
			value: props.kitem.dnd
		}]).then((rs) => {

		}).catch((error) => {
			props.kitem.dnd = dndOldStatus;
			props.kitem.clear = clearOldStatus;
			$update();
			app.dialog.alert(_(erp.get_log_description(error)));
		});
		peripheral[kitem.device].rcuOutput([{
			gang: bleHelper.getGangId(clear_virtual_button_group),
			value: props.kitem.clear
		}]).then((rs) => {

		}).catch((error) => {
			//app.dialog.alert(error)
			//props.kitem.dnd = dndOldStatus;
			props.kitem.clear = clearOldStatus;
			$update();
			app.dialog.alert(_(erp.get_log_description(error)));
		});
		$update();
	}
	const click_onoff_start = (kitem,event) => {
		if(event){
			event.preventDefault();
			event.stopPropagation();
		}
		if (kitem.device_model.startsWith("YO780")) {
			if (kitem.device_status == 1) {
				props.kitem.device_status = 0;
			} else {
				props.kitem.device_status = 1;
			}
			peripheral[kitem.device].rcuOutput([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				value: props.kitem.device_status
			}]).then(async(rs) => {
				let control_source = await bleHelper.getControlSource(kitem.device);
				window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name);
			}).catch((error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
				//app.dialog.alert(error)
			});
		} else {
			kitem.device_status = 1;
			peripheral[kitem.device].onoff([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				on: true
			}]).then(async()=>{
				let control_source = await bleHelper.getControlSource(kitem.device);
				window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name);
			}).catch((error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
				//app.dialog.alert(error)
			});
		}
	}
	const click_onoff_end = (kitem,event) => {
		if(event){
			event.preventDefault();
			event.stopPropagation();
		}
		console.log("click_onoff_end",kitem)
		kitem.device_status = 0;
		if (kitem.device_model.startsWith("YO780")) {
			peripheral[kitem.device].rcuOutput([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				value: kitem.device_status
			}]).then((rs) => {

			}).catch((error) => {
				//app.dialog.alert(error)
			});
		} else {
			peripheral[kitem.device].onoff([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				on: false
			}]).then(async()=>{
				let control_source = await bleHelper.getControlSource(kitem.device);
				window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name);
			}).catch((error) => {
				//app.dialog.alert(error)
			});
		}
	}
	const click_ir = (kitem)=>{
		//let { device_button_group, guid, id, device_command, password, name, network_id,device } = kitem;
// 		let irConfig = peripheral[kitem.device].prop.config;//{}
// 		let configStr = 'ir|0|25,1,2,1,0,1'; //ir|0|tem,speed,direction,swing,onoff,mode
// 		if(isset(irConfig[kitem.name])){
// 			configStr = irConfig[kitem.name]
// 		}
		let configStr = kitem.device_config;
		let this_config = configStr.split("|");
		let airconfig = isset(this_config[2]) && this_config[2] != ',,,,NaN' ? this_config[2].split(',') : '25,1,2,1,0,1'.split(',');
		kitem['click_status'] = true;
		//let config = configStr.split('|');
		let onoffRef = configStr.substring(14,15);
		if(onoffRef == 0){
			onoffRef = 1
		}else{
			onoffRef = 0;
		}
		configStr =`${configStr.substring(0,14)}${onoffRef}${configStr.substring(15,configStr.length)}`;
// 		peripheral[kitem.device].prop.config[kitem.name] = configStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, configStr);
		props.kitem.device_status = onoffRef;
		props.kitem.device_config = configStr;
		props.kitem.config = configStr;
		
		
		let command = kitem.device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,"ARC_ON_OFF",configStr.substring(5,configStr.length));
		peripheral[kitem.device].sendIR(ref_command);
		//peripheral[kitem.device].onPropChanged();
		$update();
	}
	const press_openclose = (kitem, direction, press) => {
		console.log("press_openclose",direction)
		setTimeout(function() {
			if (peripheral[kitem.device]) {
				if (kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
					peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then(async()=>{
						let control_source = await bleHelper.getControlSource(kitem.device);
						let device_type_map = {
							command_type : direction,
							device_type : kitem.device_model
						}
						window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name,device_type_map);
					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));
					});
				} else {
					peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then(async()=>{
						let control_source = await bleHelper.getControlSource(kitem.device);
						let device_type_map = {
							command_type : direction,
							device_type : kitem.device_model
						}
						window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name,device_type_map);
					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));

					});
				}
			}
		}, 1);
	};
	
	const iot_get_music_player_password = (item) => {
		//if not in profile ,false
		//app.dialog.preloader();
		if (!item.name) {
			//app.dialog.close();
			app.dialog.alert(`${_('You do not have permission to use this device.')}`);
			return false;
		}
		//first get the unique key form the function;
		//1.get time form the device setting,if have time,use it,else input the time
		let deviceObj = cloneDeep(erp.info.device);
		let settings = [];
		let deviceTime = [];
		let erp_keys = '';
		if (deviceObj[item.device] && deviceObj[item.device].settings) {
			settings = deviceObj[item.device].settings;
		}
		settings.forEach(item => {
			if (item.setting_type == "TimeStream") {
				let time = JSON.parse(item.setting);
				deviceTime = time;
			}
			if (item.setting_type == "ConnectKey") {
				erp_keys = item.setting;
			}
		});
		//verify the time check now > the device time
		let status = compareTimeToMusicPlayer(deviceTime);
		if (!status) {
			//update the time of the music player
			//app.dialog.close();
			//input the time
			app.dialog.prompt('Please enter the length of stay in days', async (days) => {
				app.dialog.preloader();
				const regex = /^\d+(\.\d+)?$/;
				if (!regex.test(days)) {
					app.dialog.alert('Please enter the correct value');
					return false
				} else {
					//get the timeList 
					const currentDate = dayjs();
					const futureDate = currentDate.add(days, 'day');
					let list = [currentDate.format('YYYY-MM-DD HH:mm:ss'), futureDate.format('YYYY-MM-DD HH:mm:ss')];
					let this_password = getRandomNumbers().join("");
					try {
						//await window.peripheral[props.kitem.device].doConnect();
						//get the years and months and the days and the hours and the seconds
						let this_time_list = calculateFutureTime(days);
						let this_year = this_time_list[0];
						let this_month = this_time_list[1];
						let this_day = this_time_list[2];
						let this_hour = this_time_list[3];
						let this_minute = this_time_list[4];
						let this_second = this_time_list[5];
						let data = `9800000008${this_password.convertToHex()}${this_second.toString(16).pad('00')}${this_minute.toString(16).pad('00')}${this_hour.toString(16).pad('00')}${this_day.toString(16).pad('00')}${this_month.toString(16).pad('00')}${iot_utils_to_little_endian_hex(this_year,2)}`;
						await window.peripheral[props.kitem.device].doMusicPlayer([{
							service: 'ff80',
							characteristic: 'ff81',
							command: data,
						}]);
						// await window.peripheral[props.kitem.device].write([{
						// 	service: 'ff80',
						// 	characteristic: 'ff81',
						// 	data: data,
						// }]);
						await iot_device_setting_sync_server(item.device, 'TimeStream', JSON.stringify(list));
						await iot_device_setting_sync_server(item.device, 'ConnectKey', this_password);
						erp.music_player_sheet = app.sheet.create({
							content: `\
									<div class="sheet-modal" style="height:370px;">\
										<div class="toolbar">\
											<div class="toolbar-inner justify-content-space-between">\
												<a  class="icon material-icons" ref="${item.device}" func="reset_music_player_password">refresh</a>\
												<a  class="link sheet-close">Close</a>\
											</div>\
										</div>\
										<div class="sheet-modal-inner" style="height:150px;">\
											<div class="list list-strong-ios list-dividers-ios inset-ios">\
												<ul>\
													<li class="code-block" style="padding: 5px 15px; font-size: 18px">\
														<div class="item-content">\
															<div class="item-media">${_('Check-in Time')}</div>\
															<div class="item-inner">\
																<div class="item-after">${list[0]}</div>\
															</div>\
														</div>\
													</li>\
													<li class="code-block" style="padding: 5px 15px; font-size: 18px">\
														<div class="item-content">\
															<div class="item-media">${_('Check-out Time')}</div>\
															<div class="item-inner">\
																<div class="item-after">${list[1]}</div>\
															</div>\
														</div>\
													</li>\
												</ul>\
											</div>\
										</div>\
										<div style="height:170px;" class="sheet-modal-inner display-flex justify-content-center align-content-center align-items-center">\
											<div class="circle-password">${this_password[0]}</div>\
											<div class="circle-password">${this_password[1]}</div>\
											<div class="circle-password">${this_password[2]}</div>\
											<div class="circle-password">${this_password[3]}</div>\
										</div>\
									</div>\
								`
						});
						app.dialog.close();
						erp.music_player_sheet.open();
						//app.dialog.alert(`${tran('Connection Key: ')}${this_password}`, runtime.appInfo.name, () => {});
					} catch (error) {
						app.dialog.close();
						app.dialog.alert(`${_('Get the music player password failed')}`);
					}
				}
			}, () => {
				while (true) {
						try {
							const dialog = app.dialog.close();
							if (!dialog) {
								break;
							}
						} catch (e) {
							break;
						}
					}
			})
		} else {
			if (erp_keys) {
				app.dialog.close();
				erp.music_player_sheet = app.sheet.create({
					content: `\
							<div class="sheet-modal" style="height:370px;">\
								<div class="toolbar">\
									<div class="toolbar-inner justify-content-space-between">\
										<a  class="link icon material-icons" ref="${item.device}" func="reset_music_player_password">refresh</a>\
										<a  class="link sheet-close">Close</a>\
									</div>\
								</div>\
								<div class="sheet-modal-inner" style="height:150px;">\
									<div class="list list-strong-ios list-dividers-ios inset-ios">\
										<ul>\
											<li class="code-block" style="padding: 5px 15px; font-size: 18px">\
												<div class="item-content">\
													<div class="item-media">${_('Check-in Time')}</div>\
													<div class="item-inner">\
														<div class="item-after">${deviceTime[0]}</div>\
													</div>\
												</div>\
											</li>\
											<li class="code-block" style="padding: 5px 15px; font-size: 18px">\
												<div class="item-content">\
													<div class="item-media">${_('Check-out Time')}</div>\
													<div class="item-inner">\
														<div class="item-after">${deviceTime[1]}</div>\
													</div>\
												</div>\
											</li>\
										</ul>\
									</div>\
								</div>\
								<div style="height:170px;" class="sheet-modal-inner display-flex justify-content-center align-content-center align-items-center">\
									<div class="circle-password">${erp_keys[0]}</div>\
									<div class="circle-password">${erp_keys[1]}</div>\
									<div class="circle-password">${erp_keys[2]}</div>\
									<div class="circle-password">${erp_keys[3]}</div>\
								</div>\
							</div>\
						`
				});
				erp.music_player_sheet.open();
				//app.dialog.alert(`${tran('Connection Key: ')}${erp_keys}`, runtime.appInfo.name, () => {});
			}
		}
	}
	const compareTimeToMusicPlayer = (timeRange) => {
		if (timeRange.length == 0 || timeRange.length == 1) {
			return false;
		}
		const startTimeStr = timeRange[0];
		const endTimeStr = timeRange[1];
		const currentTime = dayjs();
		const startTime = dayjs(startTimeStr);
		const endTime = dayjs(endTimeStr);
		if (currentTime.isAfter(startTime) && currentTime.isBefore(endTime) || currentTime.isSame(startTime) || currentTime.isSame(endTime)) {
			return true;
		} else {
			return false;
		}
	}
	const getRandomNumbers = () => {
		let numbers = new Set();
		while (numbers.size < 4) {
			const randomNum = Math.floor(Math.random() * 10);
			numbers.add(randomNum);
		}
		return Array.from(numbers);
	}
	const calculateFutureTime = (days) => {
		const futureDate = dayjs().add(days, 'day');
		const futureTimeArray = [
			futureDate.year(),
			futureDate.month() + 1,
			futureDate.date(),
			futureDate.hour(),
			futureDate.minute(),
			futureDate.second()
		];
		return futureTimeArray;
	}
	const iot_music_player_change_source = async(kitem)=>{
		let subdevice_name = kitem.name;
		let command = `9809000001`;
		try{
			if(kitem.config == 'phone_iphone'){
				kitem.config = 'tv';
				command = `980900000101`;
			}else{
				kitem.config = 'phone_iphone';
				command = `980900000100`;
			}
			await window.peripheral[kitem.device].doMusicPlayer([{
				service: 'ff80',
				characteristic: 'ff81',
				command: command,
			}]);
			//update profile
			let this_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
			this_subdevices.forEach(item=>{
				if(item.name == kitem.name){
					item.config = kitem.config;
				}
			})
			try{
				http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
							profile_subdevice : this_subdevices
					}
			})
			}catch(error){
				console.log(error);
			}
			//app.dialog.alert(`Audio Source Switched Successfully`);
		}catch(error){
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	//virtual Button click
	const clickSceneVirtualButton = (kitem)=>{
		console.log(kitem);
		//command
		let config = kitem.config;
		let guid = kitem.device;
		if(!config){
			app.dialog.alert(`${_('Error')}`);
			return 
		}
		let command = `8f0200${parseInt(config).toString(16).pad('00')}`;
		try{
			window.peripheral[guid].write([{
				service: 'ff80',
				characteristic: 'ff81',
				data: command,
			}])
		}catch(error){
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	const click_scene_virtual_button = (kitem)=>{
		console.log(kitem)
		let config = kitem.config;
		let guid = kitem.device;
		if(!config){
			app.dialog.alert(`${_('Error')}`);
			return 
		}
		if(kitem.device_virtual_status == 0){
			kitem.device_virtual_status = 1;
		}else{
			kitem.device_virtual_status = 0;
		}
		$update();
		let command = `972103${config}${kitem.device_virtual_status == 1?'01':'00'}`;
		try{
			window.peripheral[guid].rcuDoScene([{
				gang : 1,
				command: command,
			}]).then(()=>{
				//update the erp obj
				let list = erp.info.profile.profile_subdevice;
				list.forEach(item=>{
					if(item.name == kitem.name){
						item.status = kitem.device_virtual_status;
					}
				})
				//update the status
				let saveUrl = app_core_encode_link(`/api/method/appv6.updateSubdeviceStatus`);
				debugger
				return http.request(saveUrl, {
						method: "POST",
						responseType: "json",
						serializer: 'json',
						debug:true,
						data: {
							status: kitem.device_virtual_status,
							device : kitem.device,
							subdevice_name : kitem.name
						}
				})
			})
		}catch(error){
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	if (
		props.kitem.device_button_group.startsWith('OPENCLOSE GANG') ||
		props.kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')
	) {	
		let ref = props.kitem.device_status;
		let curtainCloseIcon = `close-curtain.svg`;
		let curtainOpenIcon = `open-curtain.svg`;
		let imgurl = `${'https://my.yoswit.com/'}/files/app/${ref > 0?curtainOpenIcon:curtainCloseIcon}`;
		return () => $h`
			<div class="control-panel-right" type-box='Dimming' bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
				<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
					<div class="button button-raised button-big circle">
						<i class="material-icons">bluetooth_connected</i>
					</div>
				</a>
				<a class="left off_flag" @touchstart="${()=>press_openclose(props.kitem, 'close', true)}"  @touchend="${()=>press_openclose(props.kitem, 'close', false)}">
					<div class="button button-raised button-big openclose cl" style="width:57px"><div class="rotate-90" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;">unfold_less</i></div></div>
				</a>
				<a class="left on_flag" @touchstart="${()=>press_openclose(props.kitem, 'open', true)}"  @touchend="${()=>press_openclose(props.kitem, 'open', false)}">
					<div class="button button-raised button-big openclose op" style="width:57px"><div class="rotate-90" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;">unfold_more</i></div></div>
				</a>
			</div>
		`;
	} else if (
		props.kitem.device_button_group.startsWith('RCU ONOFF GANG') ||
		props.kitem.device_button_group.startsWith('ONOFF GANG')
	) {
		if (props.kitem.device_model == 'YO790DC') {
			let music_config = props.kitem.config;
			return () => $h`
					<a class="control-panel-right">
						<div class="left button button-raised button-big circle key-button" ref="${props.kitem.device}"  @click="${()=>iot_get_music_player_password(props.kitem)}">
								<i class="material-icons">key</i>
						</div>
						<div class="left button button-raised button-big circle"  @click="${()=>iot_music_player_change_source(props.kitem)}">
								<i class="material-icons" style="font-size:30px!important;line-height:30px!important;">${music_config?music_config:'phone_iphone'}</i>
						</div>
					</a>
					`;
		}else if(props.kitem.device_mode == 'Multiway Switch'){
			//start the mutiway logic
			//shoud check if have the config on the profile
			//console.log("props.kitem.light_ref",props.kitem.light_ref);
			//console.log("update ref",isset(props.kitem.light_ref)?props.kitem.light_ref:0)
			let config = props.kitem.config;
			let be_pairing = true;
			let is_pairing = false;
			if(config){
				let configMap = JSON.parse(props.kitem.config);
				be_pairing = configMap.be_pairing == 1?true:false;
				is_pairing = configMap.is_pairing == 1?true:false;
			}
			if(be_pairing){
				return () => $h`
				<div class="control-panel-right" style="">
					<a class="on_flag off_flag" ref="${isset(props.kitem.light_ref)?props.kitem.light_ref:props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}">
						<div class="button button-raised button-big onoff"></div>
					</a>
				</div>
			`;
			}else if(is_pairing){
				return () => $h`
					<div>
					</div>
				`;
			}else{
				return () => $h`
					<div>
					</div>
				`;
			}
		}else if(props.kitem.device_model == 'YO780-Scene-6G' || props.kitem.device_model == 'YO780-Scene-12G' || props.kitem.device_model == 'YO780-Scene-4G' || props.kitem.device_model == 'YO780-Scene-2G' || props.kitem.device_model == 'YO780-Scene-3G' || props.kitem.device_model == 'YO780-Scene-1G'){
			return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
		}else if(props.kitem.device_mode == 'RCU Scene Button'){
			//should check if the model is the M86-DP
			if(props.kitem.device_model == 'M86-DP'){
				return () => $h`
					<div class="control-panel-right" style="">
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
			}
			return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
			`;
		} else if (props.kitem.device_mode == 'RCU Controller' && props.kitem.device_model == 'YO780') {
			return () => $h`
        <div class="control-panel-right">
            <a href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;">settings</i></div></div>
            </a>
        </div>
        `;
		}else if(props.kitem.device_mode == 'Parking Lock'){
			return () => $h`
        <div class="control-panel-right">
            <a ref="${props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}" class="right park-lock" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;"></i></div></div>
            </a>
        </div>
        `;
		}else if(props.kitem.device_mode == 'Geomagnetic'){
			return () => $h`
        <div class="control-panel-right">
            <a ref="${isset(props.kitem.dc_status) && props.kitem.dc_status>0?1:0}" class="right geomagnetic" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;"></i></div></div>
            </a>
        </div>
        `;
		} else {
			return () => $h`
					<div class="control-panel-right" style="">
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
		}
	}else if(props.kitem.device_button_group.startsWith('Hdmicec')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/hdmicec-page?guid=${props.kitem.device}&subdevice=${props.kitem.name}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">view_sidebar</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('Geomagnetic')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/hdmicec-page?guid=${props.kitem.device}&subdevice=${props.kitem.name}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">view_sidebar</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('Door Open')){
		return () => $h`
			<div class="control-panel-right">
				<a href="#" class="right">
					<div class="button button-raised button-big circle" style="background-color: grey;" ref="${props.kitem.device_status}">
              <img src="${
                props.kitem.device_status == 1 ? 'https://my.yoswit.com/' + '/files/app/door_open.svg' : 'https://my.yoswit.com/' + '/files/app/door_close.svg'
              }" style="width:25px;height:25px" alt=""/>
          </div>
				</a>
			</div>
		`;
  }else if(props.kitem.device_button_group.startsWith('DOOR SIGN')){
		return () => $h`
					<a class="control-panel-right">
						<div class="left button button-raised button-big circle rcu-output" ref="${isset(props.kitem.dnd)?props.kitem.dnd:0}"  @click="${()=>iot_rcu_output_change(props.kitem,'dnd')}">
								<i class="material-icons">notifications_off</i>
						</div>
						<div class="left button button-raised button-big circle rcu-output" ref="${isset(props.kitem.clear)?props.kitem.clear:0}"  @click="${()=>iot_rcu_output_change(props.kitem,'clear')}">
								<i class="material-icons">cleaning_services</i>
						</div>
					</a>
					`;
	}else if(props.kitem.device_button_group.startsWith('RCU INPUT')){
		//cable block
		//this ui can not be change by the ble
		let input_status = props.kitem['input']?props.kitem['input']:0;
		return ()=> $h`
			<a class="control-panel-right">
				<div class="left button button-raised button-big circle rcu-output" guid="${props.kitem.device}" device_button_group="${props.kitem.device_button_group}">
						<i class="material-icons">${input_status?'cable':'block'}</i>
				</div>
			</a>
		`;
	} else if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING') || props.kitem.device_button_group.startsWith('GV DIMMING')) {
		return () => $h`
					<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
						<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
							<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
							</div>
						</a>
						<a href="#" class="on_flag off_flag" ref="${props.kitem.device_status>0?1:0}" @click="${() => click_onoff(props.kitem)}">
								<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	} else if (props.kitem.device_mode === 'Access Controller') {
		if (props.kitem.device_button_group == 'TOGGLE GANG1') {
			return () => $h`
				<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
					<a class="iot-connect" @click="${()=>click_connect(props.kitem)}">
						<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
						</div>
					</a>
					<a class="on_flag off_flag touch-button-group" ref="${props.kitem.device_status}" @pointerdown="${() => click_onoff_start(props.kitem)}" @pointerup="${() => click_onoff_end(props.kitem)}">
							<div class="button button-raised button-big circle" style="border-radius:50%;">
								<div class="" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;margin-left:1px;margin-top:1px;">touch_app</i></div>
							</div>
					</a>
				</div>
				`;
		}
	} else if (props.kitem.device_button_group.startsWith('RCU OUTPUT')) {
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff_start(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	} else if (props.kitem.device_button_group.startsWith('OPENCLOSE UART') || props.kitem.device_button_group.startsWith('OPENCLOSE WIFI UART')) {
		let ref = isset(peripheral[props.kitem.device].getGangStatus(props.kitem.device_button_group))?peripheral[props.kitem.device].getGangStatus(props.kitem.device_button_group):props.kitem.device_status;
		let curtainCloseIcon = `close-curtain.svg`;
		let curtainOpenIcon = `open-curtain.svg`;
		
		if(props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') || props.kitem.device_button_group.startsWith('OPENCLOSE WIFI UART REVERSE')){
			console.log("props.kitem['click_status']",props.kitem['click_status'])
			ref = peripheral[props.kitem.device].prop.status.control[0][48];
			// if(!props.kitem['click_status']){
			// 	//debugger
			// 	console.log("click_status",ref)
			// 	console.log("peripheral",peripheral[props.kitem.device].prop.status)
			// 	ref = 100 - ref*1;
			// }else{
			// 	ref = peripheral[props.kitem.device].prop.status.control[0][48];
			// 	ref = ref*1;
			// }
		}
		console.log("ref",ref);
		let imgurl = `${'https://my.yoswit.com/'}/files/app/${ref > 1?curtainOpenIcon:curtainCloseIcon}`;
		return () => $h`
			<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
				<a class="iot-connect" @click="${()=>click_connect(props.kitem)}">
					<div class="button button-raised button-big circle">
							<i class="material-icons">bluetooth_connected</i>
					</div>
				</a>
				<a class="left on_flag" ref="2" @click="${()=>click_curtain_motor(props.kitem,'pause')}" button_group="${props.kitem.device_button_group}" command-type="Bluetooth" command="">
						<div class="button button-raised button-big openclose cl" style="width:57px"><div style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;margin-top:6px;">pause</i></div></div>
				</a>
				<a class="left on_flag" ref="${ref}" direction="${props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') || props.kitem.device_button_group.startsWith('OPENCLOSE WIFI UART REVERSE') ?'reverse':'standard'}" @click="${()=>click_curtain_motor(props.kitem)}" button_group="${props.kitem.device_button_group}" command-type="Bluetooth" command="">
						<div class="button button-raised button-big openclose op" style="width:57px"><div style="height:100%;width:100%;"><img src="${imgurl}" alt="" style="width:20px;height:20px;margin-top:5px;" /></div></div>
				</a>
			</div>
			`;
	} else if (props.kitem.device_button_group.startsWith('Thermostat')) {
		return () => $h`
					<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
						<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
							<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
							</div>
						</a>
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff_thermostat(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('BACNET AIR CONDITIONER')){
		let configString = props.kitem.config;
		if(configString){
			let config = configString.split("|");
			let airconfig = config[5].split(",");
			props.kitem.device_status = airconfig[0];
		}
		// if(!isset(props.kitem.device_status) && props.kitem.device_status != 0){
		// 	props.kitem.device_status = 1;
		// }
		console.log("props.kitem.device_status",props.kitem.device_status)
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="${isset(props.kitem.device_status)?props.kitem.device_status:0}" @click="${() => bacnet_click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	}else if(props.kitem.device_button_group.startsWith('BACNET LIGHTING SCENE')){
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="0" @click="${() => bacnet_light_scene_click_onoff(props.kitem,1)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	} else if (mode == 'RF Sensor' || mode == '4in1 Sensor' || mode == 'Radar Sensor') {
		return () => $h`
      <div class="control-panel-right">
          <a class="right">
              <div class="button button-raised button-big circle rf-sensor">
                  <i class="material-icons">block</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group == 'IR-DIY-no_model'){
		return () => $h`
      <div class="control-panel-right">
          <a class="right" href="/mobile-app/device-ir-diy-panel?subdevice=${props.kitem.name}">
              <div class="button button-raised button-big circle">
                  <i class="material-icons" style="line-height: 25px !important;">view_sidebar</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group_type == 'Air Conditioner'){
		return () => $h`
    		<div class="control-panel-right"  bluetooth="${props.kitem.bluetooth}">
                <a class="right" @click="${() =>
                    click_ir(props.kitem)}" button-signal="ARC_ON_OFF" command="${
                        props.kitem.device_command
                    }">
                    <div class="button button-raised button-big circle">
                        <i class="material-icons">power_settings_new</i>
                    </div>
                </a>
    		</div>
        `;
	} else if (
		props.kitem.device_button_group_type == 'Television' ||
		props.kitem.device_button_group_type == 'Set-top boxes' ||
		props.kitem.device_button_group_type == 'Audio' ||
		props.kitem.device_button_group_type == 'Projector' ||
		props.kitem.device_button_group_type == 'Fan' ||
		props.kitem.device_button_group_type == 'IPTV' ||
		props.kitem.device_button_group_type == 'Air Purifier' ||
		props.kitem.device_button_group_type == 'Camera' ||
		props.kitem.device_button_group_type == 'Dehumidifier' ||
		props.kitem.device_button_group_type == 'Robot'
	) {
		return () => $h`
      <div class="control-panel-right">
          <a class="right" func="controller_iot_device_ir_full_panel_click" guid="${props.kitem.device}" button-signal="5"  command="0141BE02FD0DF209F603FC52AD53AC00FF10EF11EE13EC14EB15EA17E818E719E6FF001BE4FF000AF54AB547B849B64BB44DB248B720DF0000" command-type="Bluetooth">
              <div class="button button-raised button-big circle">
                  <i class="material-icons">power_settings_new</i>
              </div>
          </a>
          <a class="right" func="iot_device_goto_ir_panel" button-signal="ARC_ON_OFF"  command="0141BE02FD0DF209F603FC52AD53AC00FF10EF11EE13EC14EB15EA17E818E719E6FF001BE4FF000AF54AB547B849B64BB44DB248B720DF0000" command-type="Bluetooth">
              <div class="button button-raised button-big circle">
                  <i class="material-icons" style="line-height: 25px !important;">view_sidebar</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group.startsWith('Yoswit Gateway')){
		let renderGatewayStatus = true;
		if(isset(props.render_type)){
			renderGatewayStatus = false;
		}
		if(renderGatewayStatus){
			return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/gateway-wifi-config?guid=${props.kitem.device}&device_name=${props.kitem.profile_device}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="f7-icons" style="font-size:50px;position:relative;top:5px;">wand_stars</i></div></div>
					</a>
				</div>
				`;
		}else{
			return () => $h`
				<div class="control-panel-right" style="">
					<a func="ble_load_to_device_form_auto" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
		}
	}else if(props.kitem.device_button_group.startsWith("SCENE MUTIWAY ONOFF GANG1")){
		return () => $h`
				<div class="control-panel-right" style="">
					<a class="right" @click="${()=>clickSceneVirtualButton(props.kitem)}">
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">power_settings_new</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith("SCENE VIRTUAL ONOFF GANG1")){
		return () => $h`
					<div class="control-panel-right" style="">
						<a class="on_flag off_flag" ref="${props.kitem.device_virtual_status}" @click="${() => click_scene_virtual_button(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	}else if(props.kitem.device_button_group.startsWith("IAQ")){
		// if(props.kitem.device_model == 'YO161'){

		// }else if(props.kitem.device_model == 'YO161-H'){

		// }
		return () => $h`
      <div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
          <a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
              <div class="button button-raised button-big circle">
                  <i class="material-icons">bluetooth_connected</i>
              </div>
          </a>
          <a class="right iaq-button-score-a">
              <div class="button iaq-button-score button-raised button-big circle display-flex flex-direction-column justify-content-center align-content-center align-items-center" style="background-color:green;line-height:18px;padding-top:10px;color:#fff;">
                  <span class="score text-color-white" style="height:29px;font-size:23px;">${props.kitem.ref}</span>
                  <div class="score-desc text-color-white" style="font-size: 12px;height:29px;line-height:29px;">Good</div>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_model == 'BG000'){
		return () => $h` 
				<div class="control-panel-right" style="">
					<a href="#" @click="${()=>manufacturing_device(props.kitem)}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}else {
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="#" func="ble_load_to_device_form_auto" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}
};
//vervify the password
const iotEntryPasswordVerify = () => {

}
window.reset_music_player_password = (dom)=>{
		//clean the data and send the data to erp
		console.log("dom",dom)
		let deviceObj = cloneDeep(erp.info.device);
		//delet the device data
		let settings = [];
		if(deviceObj[dom.ref] && deviceObj[dom.ref].settings){
			settings = deviceObj[dom.ref].settings;
		}
		let targetList = [];
		settings.forEach(item => {
			if (item.setting_type != "TimeStream" && item.setting_type != "ConnectKey") {
				targetList.push(item);
			}
		});
		console.log("targetList",targetList)
		deviceObj[dom.ref].settings = targetList;
		erp.info.device[dom.ref] = deviceObj[dom.ref];
		console.log("erp.info.device",erp.info.device[dom.ref])
		app.sheet.close();
		//trigger the event
		$(`.key-button[ref="${dom.ref}"]`).trigger("click");
		//iot_get_music_player_password(item);
	}
//fixed the mac issue
const fixedMacRever = (kitem)=>{
	app.dialog.confirm(`${_('Device configuration has some issues, do you want to fix them?')}`,()=>{
		let scan_mac_address = erp.info.device[kitem.device]['mac_address'];
		let init_mac_address = '';
		if(scan_mac_address){
			init_mac_address = scan_mac_address.replace(/:/g, '').toLowerCase();
		}else{
			init_mac_address = kitem.mac_address;
		}
		let this_guid = macToGuid(init_mac_address,kitem.model);
		try{
			
		}catch(error){

		}
	},()=>{})
}
//render the bottom button ex.air and the dimming bar
let range_silder_list = {};
erp.trigger_thermostat_defined_fun = {};
window.dimmingRecord = {};
const renderBottomButton = (props, {
	$h,
	$onMounted,
	$update
}) => {
	let mode = props.kitem.device_mode;
	let device_button_group = props.kitem.device_button_group
	let key = `dimer_slidebar_${props.kitem.device}`;
	let guid = props.kitem.device || props.kitem.guid;
	//thie function control the Dimming mode bar change 
	const range_change_fun_dimming = (element) => {
		if(isset(props.kitem['click_button']) || window.peripheral[guid].prop.click_button){
			return;
		}  
			debugger
	    props.kitem.device_status = element.value;
	    let range_value = parseInt((element.value*1.0 / 100.0) * 255.0);
	    
	    if(props.kitem.disableControl){
	        props.kitem.disableControl = null;
	        delete props.kitem.disableControl;
	        return;
	    }
	    
	    
	    try {
			if (device_button_group.startsWith("DIMMING")) {
				peripheral[props.kitem.device].dimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(async()=>{
					let control_source = await bleHelper.getControlSource(props.kitem.device);
					window.upload_device_control_log(props.kitem.device,props.kitem.device_status,control_source,props.kitem.name);
				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			}else if(device_button_group.startsWith('GV DIMMING')){
				peripheral[props.kitem.device].gvDimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(async()=>{
					let control_source = await bleHelper.getControlSource(props.kitem.device);
					window.upload_device_control_log(props.kitem.device,props.kitem.device_status,control_source,props.kitem.name);
				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			} else if (device_button_group.startsWith("RCU DIMMING")) {
				// debugger
				peripheral[props.kitem.device].rcuDimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(async()=>{
					let control_source = await bleHelper.getControlSource(props.kitem.device);
					window.upload_device_control_log(props.kitem.device,props.kitem.device_status,control_source,props.kitem.name);
				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			}
		} catch (error) {
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	const curtain_switch_custom = (kitem,direction)=>{
		//type 0-left 1-right 2-right
		if(peripheral[kitem.device]){
			if (kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
					peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, true).then(async(rs) => {
						let control_source = await bleHelper.getControlSource(kitem.device);
						let device_type_map = {
							command_type : direction,
							device_type : kitem.device_model
						}
						window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name,device_type_map);
					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));
					});
				} else {

					peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, true).then(async(rs) => {
						let control_source = await bleHelper.getControlSource(kitem.device);
						let device_type_map = {
							command_type : direction,
							device_type : kitem.device_model
						}
						window.upload_device_control_log(kitem.device,kitem.device_status,control_source,kitem.name,device_type_map);

					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));

					});
				}
		}
	}
	const range_change_fun_switch_curtain = (element)=>{
		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},10000)
		let parentElemt = $(element.el).parents('.device').prev();
		let thisvalue = element.value;
		const now = DateFormatter.format(new Date(), 'Y-m-d H:i:s');
	}
	const range_change_fun_curtain = (element) => {
		if(isset(props.kitem['click_button'])){
			return;
		}
		props.kitem['click_status'] = true;
		if(props.kitem['timeout']){
			clearTimeout(props.kitem['timeout']);
		}
		console.log("element",element);
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},50000)
		let otherModelStatus = false;
		if(props.kitem.device_model == 'YO121-AC-R2W') otherModelStatus = true;
		let parentElemt = $(element.el).parents('.device').prev();
		let thisvalue = element.value;
		const now = DateFormatter.format(new Date(), 'Y-m-d H:i:s');
		let reverse = props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') || props.kitem.device_button_group.startsWith('OPENCLOSE WIFI UART REVERSE') ? true : false;
		if (thisvalue > 0) {
			props.kitem.device_status = thisvalue;
		} else {
			props.kitem.device_status = 0;
		}
		if (reverse) {
			data = `55AA060102${(100-thisvalue).toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${(100-props.kitem.device_status*1).toString(16).pad("00")}`;
			}
		} else {
			data = `55AA060102${thisvalue.toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${props.kitem.device_status.toString(16).pad("00")}`;
			}
		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		let command = "8602" + data.toLowerCase();
		console.log('command',command)
		window.peripheral[props.kitem.device].curtainmotor([{
			gang: bleHelper.getGangId(props.kitem.device_button_group),
			value: thisvalue,
			command: command
		}]).then(async()=>{
			let control_source = await bleHelper.getControlSource(props.kitem.device);
			
			window.upload_device_control_log(props.kitem.device,props.kitem.device_status,control_source,props.kitem.name);
		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
	}
	const bacnet_light_scene_click_change = (kitem,type)=>{
		let configString = kitem.config;
		if(configString){
			let config = configString.split("|");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			let message = [];
			message.push({
					"operate":"write",
					"deviceCode":deviceCode,
					"tagCode":tagCode,
					"val":`${type}`
			});
			message = JSON.stringify(message);
			core_mqtt_publish(config[1], message, 0, false, false, true);
			$update();
		}
	}
	// bacnet change flow
	const click_bacnet_change = (kitem, click_type) => {
		//mode-1 auto mode-2 cool mode-3 dry model-4 fan model-5 heat
		let configStr = props.kitem.config;
		let config = configStr.split('|');
		let airconfig = isset(config[5]) && config[5] != ',,,,NaN'?config[5].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[1]; //thermostat mode
		let speed_vaule = airconfig[2]; //thermostat speed
		// let swing_value = airconfig[3];
		// let direction_value = airconfig[2];
		let temperature = airconfig[3]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		let temp = config[0].split(".");
		let deviceCode = temp[0];
		let tagCode = temp[1];
		temp = tagCode.split("_");
		let roomCode = temp[0];
		let message = [];
		switch (click_type) {
			case "ARC_MODE":
				if (mode_value == 2) {
					mode_value = 4;
				} else if (mode_value == 4) {
					mode_value = 8
				} else if (mode_value == 8) {
					mode_value = 16;
				}else if (mode_value == 16) {
					mode_value = 2;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_MODE_CTRL",
					"val": mode_value + ""
				});
				break;
			case "ARC_SPEED":
				if(speed_vaule == 2){
					speed_vaule = 8;
				}else if(speed_vaule == 4){
					speed_vaule = 2;
				}else if(speed_vaule == 8){
					speed_vaule = 4;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_SPEED_CTRL",
					"val": speed_vaule + ""
				});
				break;
			case "ARC_REDUCE_TEMP":
				if (temperature != 5) {
					temperature--;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_CONTROL_ROOM_TEMP_SETPOINT",
					"val": temperature + ""
				});
				break;
			case "ARC_ADD_TEMP":
				if (temperature != 32) {
					temperature++;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_CONTROL_ROOM_TEMP_SETPOINT",
					"val": temperature + ""
				});
				break;
		}
		//ir|0|tem,speed,direction,swing,onoff,mode
		config[5] = `1,${mode_value},${speed_vaule},${temperature}`;
		const newConfigStr = config.join("|");
// 		peripheral[kitem.device].prop.config[kitem.name] = newConfigStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, newConfigStr);
		//props.kitem.device_status = 1;
		//props.kitem.device_config = newConfigStr;
		props.kitem.config = newConfigStr;
		message = JSON.stringify(message);
		console.log("message",message);
		core_mqtt_publish(config[1], message, 0, false, false, true);
		try{
			let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
			subdevices.forEach(item=>{
					if(item.name == kitem.name){
							item.config = newConfigStr
					}
			})
			http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
				serializer: "json",
				responseType: "json",
				method: "PUT",
				data: {
						profile_subdevice : subdevices 
				}
		})
		}catch(error){
			console.log(error);
		}
		//iot_update_profile_subdevice_config(kitem.name,JSON.stringify({config : newConfigStr}));
		//let command = kitem.device_command['function'];
		//let ref_command = iot_ble_generate_ir_code(command,click_type,`${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`);
		//peripheral[kitem.device].sendIR(ref_command);
		//debugger
		$update();
	}
	const click_ir_diy_change = async(code)=>{
		const TAG = 'iot_ir_test';
    console.log(TAG);
		let bytes_string = code;
		let bytes_array = [];
		let this_data = `3003${bytes_string.substring(2, bytes_string.length)}`;
		let count_string = `${this_data}${addChecksum(iotConvertHexToData(this_data))}`;
		let handle_data = iot_ir_learned_init(this_data);
		let ref = `${handle_data}${count_string.toString(16).pad('00')}`;
		console.log('ref', ref);
		try {
			await window.peripheral[props.kitem.device].sendIR(ref);
			} catch (err) {
				app.dialog.alert(_(erp.get_log_description(err)));
			}
	}
	//this is the thermostat click function
	
	const click_thermostat_change = (kitem, click_type) => {
		let value_list = kitem.device_attachment_status.split(',');
		let mode_value = value_list[1];
		let speed_vaule = value_list[2]; //thermostat speed
		let temperature = parseInt(value_list[3]); //temperature
		let room_temperature = value_list[4];
		let data = "";
		let this_gang = 42;
		let post_value = ``;
		let devices = cloneDeep(erp.info.device);
		let device = devices[guid];
		let mode_seetting = '';
		let speed_setting = '';
		let setpoint_limit_lower_cooling = '';
		let setpoint_limit_upper_cooling = '';
		let setpoint_limit_lower_heat = '';
		let setpoint_limit_upper_heat = '';
		if (isset(device)) {
			let list = device.settings;
			list.forEach(item => {
				if (item.setting_type === 'mode_selection') {
					mode_seetting = item.setting;
				}
				if (item.setting_type === 'fan_speed') {
					speed_setting = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_lower'){
					setpoint_limit_lower_cooling = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_upper'){
					setpoint_limit_upper_cooling = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_lower_heat'){
					setpoint_limit_lower_heat = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_upper_heat'){
					setpoint_limit_upper_heat = item.setting;
				}
			})
		}
		//init the lastClickTime 
		if(!isset(window.lastClickTime[props.kitem.device])){
			window.lastClickTime[props.kitem.device] = 0;
		};
		const currentTime = Date.now();

		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},10000)
		//props.kitem.device_attachment_status = [0,0,0,26,26,Math.random()].join(',');
		switch (click_type) {
			case "mode":
				this_gang = 43;
				
				if (mode_value == 1) {
					mode_value = 0
					$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
					$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-4.png');
				} else if (mode_value == 2) {
					if (mode_seetting == 'Cooling') {
						mode_value = 0;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-4.png');
					}else {
						mode_value = 1
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-5.png');
					}
				} else if (mode_value == 0) {
					if(mode_seetting == 'Heating'){
						mode_value = 1;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-5.png');
					} else{
						mode_value = 2;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-2.png');
					}
				}
				data = "9404000001" + parseInt(mode_value).toString(16).pad("00");
				post_value = mode_value;
				break;
			case "fan":
				this_gang = 44;
				if(speed_setting){
					// Disable ,1 Speed ,2 Speed, 3 Speed
				}
				if (speed_vaule == 4) {
					if (mode_value == 0) {
						//mode fan 
						speed_vaule = 2;
					} else {
						speed_vaule = 1;
					}
				}else if(speed_vaule == 3){
					if(speed_setting == '2 Speed'){
						if (mode_value == 0) {
							//mode fan 
							speed_vaule = 2;
						} else {
							speed_vaule = 1;
						}
					}else{
						speed_vaule++
					}
				}else if(speed_vaule == 2){
					if(speed_setting == '1 Speed'){
						speed_vaule = 1;
					}else{
						speed_vaule++
					}
				} else {
					speed_vaule++
				}
				$('li.device[guid="' + guid + '"] a[command-type="fan"]').attr('ref', speed_vaule);
				$('li.device[guid="' + guid + '"] a[command-type="fan"] img').attr('src', 'style/img/air_condition/icon-speed-' + speed_vaule + '.png');
				data = "9405000001" + parseInt(speed_vaule).toString(16).pad("00");
				post_value = speed_vaule;
				break;
			case "reduce":
				this_gang = 45;
				if(mode_value == 2){
					//cooling
					if(setpoint_limit_lower_cooling){
						if (temperature != setpoint_limit_lower_cooling && temperature > setpoint_limit_lower_cooling) {
							temperature--;
						}
					}else{
						if (temperature != 5 && temperature > 5) {
							temperature--;
						}
					}
				}else if(mode_value == 1){
					//heating
					if(setpoint_limit_lower_heat){
						if (temperature != setpoint_limit_lower_heat && temperature > setpoint_limit_lower_heat) {
							temperature--;
						}
					}else{
						if (temperature != 5 && temperature > 5) {
							temperature--;
						}
					}
				}else if(mode_value == 0){
					if (temperature != 5 && temperature > 5) {
							temperature--;
						}
				}
				$('li.device[guid="' + guid + '"] a[button-signal="5"] span').text(temperature);
				$('li.device[guid="' + guid + '"] a[command-type="add"]').attr('ref', temperature);
				$('li.device[guid="' + guid + '"] a[command-type="reduce"]').attr('ref', temperature);
				data = "9406000001" + parseInt(temperature).toString(16).pad("00");
				post_value = temperature;
				break;
			case "add":
				this_gang = 45;
				if(mode_value == 2){
					//cooling
					if(setpoint_limit_upper_cooling){
						if (temperature != setpoint_limit_upper_cooling && temperature < setpoint_limit_upper_cooling) {
							temperature++;
						}
					}else{
						if (temperature != 32 && temperature < 32) {
							temperature++;
						}
					}
				}else if(mode_value == 1){
					//heating
					if(setpoint_limit_upper_heat){
						if (temperature != setpoint_limit_upper_heat && temperature < setpoint_limit_upper_heat) {
							temperature++;
						}
					}else{
						if (temperature != 32 && temperature < 32) {
							temperature++;
						}
					}
				}else if(mode_value == 0){
					if (temperature != 32 && temperature < 32) {
						temperature++;
					}
				}
				$('li.device[guid="' + guid + '"] a[button-signal="5"] span').text(temperature);
				$('li.device[guid="' + guid + '"] a[command-type="add"]').attr('ref', temperature);
				$('li.device[guid="' + guid + '"] a[command-type="reduce"]').attr('ref', temperature);
				data = "9406000001" + parseInt(temperature).toString(16).pad("00");
				post_value = temperature;
				break;
		}
		props.kitem.device_status = 1;
		window.peripheral[props.kitem.device].prop.status['control'][0][42] = 1;
		props.kitem.device_attachment_status = [1, mode_value, speed_vaule, temperature, room_temperature, 0].join(',');
		console.log(currentTime - window.lastClickTime[props.kitem.device])
		if ((currentTime - window.lastClickTime[props.kitem.device] < window.clickInterval) || window.lastClickTime[props.kitem.device] == 0) {
			console.log("post_value",post_value);
			$update();
			window.lastClickTime[props.kitem.device] = currentTime;
			if (timeoutId) {
				window.peripheral[props.kitem.device].prop.status.control[0][this_gang] = post_value;
				window.peripheral[props.kitem.device].prop.status.control[1] = DateFormatter.format((new Date(new Date().getTime() + 15000)), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");
				clearTimeout(timeoutId);
			}
			timeoutId = setTimeout(() => {
				window.peripheral[props.kitem.device].thermostat([{
					gang: this_gang,
					value: post_value,
					command: data
				}]).then(async()=>{
					let control_source = await bleHelper.getControlSource(kitem.device);
					let device_type_map = {
						command_type : click_type,
						device_attachment_status : props.kitem.device_attachment_status,
						device_type : kitem.device_model,
						command : data
					}
					window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name,device_type_map);
				})
				$update();
			}, window.clickInterval);
			return; // 间隔小于设定时间，忽略此点击
		}
		console.log("posting")
		window.peripheral[props.kitem.device].thermostat([{
			gang: this_gang,
			value: post_value,
			command: data
		}]).then(async()=>{
			let control_source = await bleHelper.getControlSource(kitem.device);
			let device_type_map = {
					command_type : click_type,
					device_attachment_status : props.kitem.device_attachment_status,
					device_type : kitem.device_model,
					command : data
				}
				window.upload_device_control_log(kitem.device,props.kitem.device_status,control_source,kitem.name,device_type_map);
			})
		$update();
		window.lastClickTime[props.kitem.device] = currentTime;
	}
	const click_ir_change = (kitem, click_type)=>{
// 		let configStr = peripheral[kitem.device].prop.config[kitem.name];
		let configStr = kitem.device_config;
		if(!isset(configStr)){
			app.dialog.alert('error');
			return
		}
		
		let config = configStr.split('|');
		let airconfig = isset(config[2]) && config[2] != ',,,,NaN'?config[2].split(','):'25,1,2,1,0,1'.split(',')
		let mode_value = airconfig[5]>=0 ? airconfig[5] : 1; //thermostat mode
		let speed_vaule = airconfig[1]; //thermostat speed
		let swing_value = airconfig[3];
		let direction_value = airconfig[2];
		let temperature = airconfig[0]; //temperature
		let devices = cloneDeep(erp.info.device);
		let deviceMap = devices[kitem.device];
		let deviceSettings = isset(deviceMap)?deviceMap.settings:[];
		//debugger
		switch (click_type) {
			case "ARC_MODE":
				if (mode_value == 5) {
					mode_value = 4
				} else if (mode_value == 2) {
					mode_value = 5
				} else if (mode_value == 4) {
					mode_value = 2;
				}else if(mode_value == 0){
					mode_value = 4;
				}else if(mode_value == 1){
					mode_value = 2;
				}
				break;
			case "ARC_SPEED":
				if(speed_vaule == 4){
					speed_vaule = 1;
				}else{
					speed_vaule++
				}
				break;
			case "ARC_SWING":
				swing_value = swing_value*1-1;
				if(swing_value < 0){
					swing_value = 1;
				}
				break;
			case "ARC_REDUCE_TEMP":
				//if fan mode ,can not reduce temperature
				if(mode_value == 4){
					return;
				}
				//get the limit temperature
				//mode_value 2cool 5heat
				let limitValue = 5;
				
				if(mode_value == 2){
					deviceSettings.forEach(item=>{
						if(item.setting_type == 'cool_setpoint_limit'){
							limitValue = item.setting;
						}
					})
				}
				if(mode_value == 5){
					deviceSettings.forEach(item=>{
						if(item.setting_type == 'heat_setpoint_limit'){
							limitValue = item.setting;
						}
					})
				}
				if (temperature > limitValue) {
					temperature--;
				}
				break;
			case "ARC_ADD_TEMP":
			if(mode_value == 4){
					return;
				}
				let uppertValue = 35;
				if(mode_value == 2){
					deviceSettings.forEach(item=>{
						if(item.setting_type == 'cool_setpoint_upper'){
							uppertValue = item.setting;
						}
					})
				}
				if(mode_value == 5){
					deviceSettings.forEach(item=>{
						if(item.setting_type == 'heat_setpoint_upper'){
							uppertValue = item.setting;
						}
					})
				}
				if (temperature < uppertValue) {
					temperature++;
				}
				break;
		}
		//ir|0|tem,speed,direction,swing,onoff,mode
		const newConfigStr = `ir|0|${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`;
// 		peripheral[kitem.device].prop.config[kitem.name] = newConfigStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, newConfigStr);
		props.kitem.device_status = 1;
		props.kitem.device_config = newConfigStr;
		props.kitem.config = newConfigStr;
		
		let command = kitem.device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,click_type,`${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`);
		peripheral[kitem.device].sendIR(ref_command);
		//debugger
		$update();
	}
	erp.trigger_thermostat_defined_fun[props.kitem.device] = (kitem) => {
		//this function can change the ui
		if (isset(kitem.device_attachment_status)) {
			props.kitem.device_attachment_status = kitem.device_attachment_status;
			$update();
		}
	}
	$onMounted(() => {
		let element = $(`.curtain-subdevice .range-slider[data-id="${key}"]`);
		setTimeout(() => {
			if (props.kitem.device_button_group.startsWith('OPENCLOSE UART') || props.kitem.device_button_group.startsWith('OPENCLOSE WIFI UART')) {
				let reverse_flag = props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') || props.kitem.device_button_group.startsWith('OPENCLOSE WIFI UART REVERSE');
				let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
				// console.log(props.kitem.title)
				// console.log('props.kitem.device_status',props.kitem.device_status);
				//debugger
				if(!isset(range_silder_list[range_key])){
					range_silder_list[range_key] = app.range.create({
						el: `.range-slider[guid="${props.kitem.device?props.kitem.device:props.kitem.name}"]`,
						value: reverse_flag ? peripheral[props.kitem.device].prop.status.control[0][48] : props.kitem.device_status || 0,
						min: 0,
						max: 100,
						draggableBar: false,
						label: true,
						step: 1,
						scale: true,
						scaleSteps: 5,
						scaleSubSteps: 4,
						on: {
							changed: range_change_fun_curtain,
						},
					});
				}
				
			}else if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING') || props.kitem.device_button_group.startsWith('GV DIMMING')) {
				const v = Math.ceil((props.kitem.device_status*1.0 / 255.0) * 100.0) || 0;
						// console.log("v",v)
				    let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
						//console.log("range_silder_list[range_key]",range_silder_list[range_key]);
				    if(!isset(range_silder_list[range_key])){
							setTimeout(()=>{
								//console.log($(`.range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`));
									range_silder_list[range_key] = app.range.create({
									el: `.range-slider-home-auto[guid="${props.kitem.device?props.kitem.device:props.kitem.name}"][button_group="${props.kitem.device_button_group}"]`,
									value: v,
									min: 0,
									max: 100,
									draggableBar: false,
									label: true,
									step: 1,
									scale: true,
									scaleSteps: 5,
									scaleSubSteps: 4,
									on: {
										changed: range_change_fun_dimming,
									},
								});
							},500)
				    }
			}else if(props.kitem.device_button_group.startsWith('OPENCLOSE GANG') || props.kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
				let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
				    if(!isset(range_silder_list[range_key])){
    				    range_silder_list[range_key] = app.range.create({
    						el: `.range-slider[guid="${props.kitem.device?props.kitem.device:props.kitem.name}"][button_group="${props.kitem.device_button_group}"]`,
    						value: 0,
    						min: 0,
    						max: 100,
    						draggableBar: false,
    						label: true,
    						step: 1,
    						scale: true,
    						scaleSteps: 5,
    						scaleSubSteps: 4,
    						on: {
    							changed: range_change_fun_switch_curtain,
    						},
    					});
				    }
			}
		}, 0)
	});
	if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING') || props.kitem.device_button_group.startsWith('GV DIMMING')) {

		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex dimming-subdevice" style="" guid="${
					props.kitem.guid
				}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" config="${props.kitem.config}" mesh="${props.kitem.network_id>0?1:0}" button_group="${props.kitem.device_button_group}">
						<div class="row padding-tb flex-direction-column justify-content-center">
								<div class="col-100 medium-100 large-100">
										<div class="content display-flex justify-content-center" style="margin-left: 15px;margin-right:15px;">
												<div class="tip-title"><i class="icon material-icons" style="margin-right:8px;">brightness_low</i></div>
												<div class="range-slider range-slider-home-auto range-slider-init"
														button_group="${props.kitem.device_button_group}"
														guid="${props.kitem.device?props.kitem.device:props.kitem.name}"
														subdevice-name="${props.kitem.name}"
												></div>
												<div class="tip-title"><i class="icon material-icons" style="margin-left:8px;">brightness_high</i></div>
										</div>
										<div></div>
								</div>
						</div>
				</li>
				`;
	} else if (device_button_group.startsWith("OPENCLOSE UART") || device_button_group.startsWith("OPENCLOSE WIFI UART")) {
		
		return () => $h`
				<li class="device home-scanned-peripheral home-scanned-peripheral-smart display-flex curtain-subdevice" direction="standard" style="" guid="${
					props.kitem.device
				}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
						<div class="row padding-tb flex-direction-column justify-content-center">
								<div class="col-100 medium-100 large-100">
										<div class="content display-flex justify-content-center" style="margin-left: 15px;margin-right:15px;">
												<div class="tip-title"><img src="${
													'https://my.yoswit.com/'
												}/files/app/close-curtain.svg" alt="" style="width:20px;height:20px;margin-right:8px;margin-top:5px;" /></div>
												<div class="range-slider range-slider-home-auto range-slider-init"
														button_group="${props.kitem.device_button_group}"
														guid="${props.kitem.device?props.kitem.device:props.kitem.name}"
														subdevice-name="${props.kitem.name}"
												></div>
												<div class="tip-title"><img src="${
													'https://my.yoswit.com/'
												}/files/app/open-curtain.svg" alt="" style="width:20px;height:20px;margin-left:8px;margin-top:5px;" /></div>
										</div>
										<div></div>
								</div>
						</div>
				</li>
			`;
	}else if(device_button_group.startsWith("OPENCLOSE GANG") || device_button_group.startsWith("RCU OPENCLOSE GANG")){
		return () => $h`
      <li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob}" mesh="${props.kitem.network_id>0?1:0}" slot-index="${props.kitem.config}" style="height:auto;">
          <div class="item-content subdevice-item-content" style="min-height: 0px;">
              <div class="item-inner" style="min-height: 0px;">
                  <div class="row" style="--f7-grid-gap:3px;padding-left:20px;padding-right:15px;">
                      <button class="col on_flag off_flag button button-large button-raised openclose cl" ref="0" @click="${()=>curtain_switch_custom(props.kitem,'close')}" command-type="Bluetooth" command="">
                          <div style="margin-left:-5px;"><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_right</i><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_left</i></div>
                      </button>
                      <button class="col on_flag off_flag button button-large button-raised stop" ref="n" @click="${()=>curtain_switch_custom(props.kitem,'stop')}" command-type="Bluetooth" command="">
                          <div><i class="material-icons" style="line-height:65px;font-size:18px!important;">pause</i></div>
                      </button>
                      <button class="col on_flag off_flag button button-large button-raised openclose op" ref="1" @click="${()=>curtain_switch_custom(props.kitem,'open')}" command-type="Bluetooth" command="">
                          <div style="margin-left:-7px;"><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_left</i><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_right</i></div>
                      </button>
                  </div>
              </div>
          </div>
      </li>
      `;
	}else if(props.kitem.device_mode == 'Multiway Switch'){
		let configStr = props.kitem.config;
		let is_pairing = false;
		if(configStr){
			let configMap = JSON.parse(configStr);
			
			if(isset(configMap.is_pairing)){
				is_pairing = configMap.is_pairing == 1?true:false;
			}
		}
		if(is_pairing){
			return () => $h`
        <div class="pair-box-connect">
          <i class="icon material-icons" style="margin-left:8px;">link</i>
        </div>
        `;
		}else{
			return () => $h`
        <a></a>
        `;
		}
	}else if (device_button_group.startsWith('Thermostat')) {
		emitter.on(`thermostat_${props.kitem.device}`, (data) => {
			$update();
		})
		if (!isset(props.kitem.device_attachment_status)) {
			props.kitem.device_attachment_status = [0, 0, 0, 26, 26, 0].join(',');
		}else if(props.kitem.device_attachment_status.startsWith('0,0,0,0,0,0')){
			props.kitem.device_attachment_status = [0, 0, 0, 26, 26, 0].join(',');
		}
		let this_list = props.kitem.device_attachment_status.split(',')
		let mode_value = this_list[1]; //thermostat mode
		let speed_vaule = this_list[2]; //thermostat speed
		let temperature = this_list[3] == 0 ? 26 : this_list[3]; //temperature
		let room_temperature = this_list[4]; //room_temperature
		let humidity = this_list[5]; //humidity
		let mode_str = 4;
		let mode_ref = 0;
		if (mode_value == 1) {
			mode_ref = 1;
			mode_str = 5;
		} else if (mode_value == 2) {
			mode_ref = 2;
			mode_str = 2;
		}
		if (speed_vaule == 0) {
			speed_vaule = 1;
		}
		if (!temperature) {
			temperature = 26;
		}
		//render the mode、fan、temperature
		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex thermostat-subdevice" style="height:80px;" ref="${props.kitem.device_status}" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center" style="--f7-grid-gap:3px;">
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'mode')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'fan')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'reduce')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>℃
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'add')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith('BACNET LIGHTING SCENE')){
		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex thermostat-subdevice" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,2)}" command-type="mode" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 1</div>
								</a>
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,3)}" command-type="fan" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 2</div>
								</a>
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,4)}" command-type="reduce" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 3</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if (device_button_group.startsWith('BACNET AIR CONDITIONER')) {
		let configStr = props.kitem.config;
		let config = configStr.split('|');
		console.log("config[5]",props.kitem)
		let airconfig = isset(config[5]) && config[5] != ',,,,NaN'?config[5].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[1]; //thermostat mode
		let speed_vaule = airconfig[2]; //thermostat speed
		// let swing_value = airconfig[3];
		// let direction_value = airconfig[2];
		let temperature = airconfig[3]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		props.kitem.device_status = airconfig[4];
		if (mode_value == 2) {
			mode_ref = 1;
			mode_str = 2;
		} else if (mode_value == 4) {
			mode_ref = 2;
			mode_str = 3;
		}else if (mode_value == 8) {
			mode_ref = 2;
			mode_str = 1;
		}else if (mode_value == 16) {
			mode_ref = 2;
			mode_str = 4;
		}
		if (speed_vaule == 2) {
			speed_vaule = 4;
		}else if(speed_vaule == 4){
			speed_vaule = 3;
		}else if(speed_vaule == 8){
			speed_vaule = 2;
		}
		if (!temperature) {
			temperature = 26
		}
		//render the mode、fan、temperature
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice home-scanned-peripheral-smart" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center" style="--f7-grid-gap:3px;">
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_MODE')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_SPEED')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_REDUCE_TEMP')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>℃
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_ADD_TEMP')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(props.kitem.device_button_group_type == 'Air Conditioner'){
		let configStr = props.kitem.device_config;
		let config = configStr.split('|');
		let airconfig = isset(config[2]) && config[2] != ',,,,NaN'?config[2].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[5]>=0 ? airconfig[5] : 1; //thermostat mode
		let speed_vaule = airconfig[1]; //thermostat speed
		let swing_value = airconfig[3];
		let direction_value = airconfig[2];
		let temperature = airconfig[0]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 4;
		props.kitem.device_status = airconfig[4];
		if (mode_value == 5) {
			mode_ref = 5;
			mode_str = 5;
		} else if (mode_value == 2) {
			mode_ref = 2;
			mode_str = 2;
		}else if(mode_value == 4){
			mode_ref = 4;
			mode_str = 4;
		}
		if (speed_vaule == 0) {
			speed_vaule = 1;
		}
		if (!temperature) {
			temperature = 26
		}
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice home-scanned-peripheral-smart" style="height:80px;" ref="${airconfig[4]}" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" device_config="${props.kitem.device_config}" button_group="${props.kitem.device_button_group}" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.mesh || 0}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_MODE')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_SPEED')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_SWING')}" command-type="ARC_SWING" guid="${props.kitem.device}" ref="${swing_value}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-swing-${swing_value?swing_value:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_REDUCE_TEMP')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:60px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>℃
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_ADD_TEMP')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:60px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith('IR-DIY-no_model')){
		//DIY template
		let configStr = props.kitem.config;
		let configMap = JSON.parse(configStr);
		let configList = configMap.list;
		console.log("configStr",configList);
		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex thermostat-subdevice" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" @click="${()=>click_ir_diy_change(configList[0].code)}" command-type="mode" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[0].text)}</div>
								</a>
								<a href="#" @click="${()=>click_ir_diy_change(configList[1].code)}" command-type="fan" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[1].text)}</div>
								</a>
								<a href="#" @click="${()=>click_ir_diy_change(configList[2].code)}" command-type="reduce" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[2].text)}</div>
								</a>
								<a href="#" @click="${()=>click_ir_diy_change(configList[3].code)}" command-type="reduce" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[3].text)}</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith("IAQ")){
		return () => $h`
      <li class="device iaq-subdevice home-scanned-peripheral home-scanned-peripheral-smart device-none" gateway="${props.kitem.gateway}" guid="${
        props.kitem.device
      }" mobmob="${props.kitem.mobmob}" bluetooth="${props.kitem.bluetooth}" button_group="${
        device_button_group
      }" style="height:auto;">
        <div class="display-flex justify-content-start align-content-center align-items-center" style="flex-wrap:wrap;height:auto;width:100%;">
          <!-- Temperature -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center">
                    <div class="Temperature display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/Temperature_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">℃</span> 
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM1.0 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM1 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="PM1 box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM1.0_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">μg/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM2.5 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM2_5 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM2.5_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">μg/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM4 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM4 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM4.0_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">μg/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM10 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM10 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM10_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">μg/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Humidity -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="Humidity display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/Humidity_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- CO2 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="CO2 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/CO2_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">ppm</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- TVOCs -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="VOC display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/VOC_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span> 
                            <span class="unit">ppd</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Light -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="LUX display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/Light_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">lux</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- NOX_1 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="NOX display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/NOX_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">ppb</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- CO_1 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="CO display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/CO_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">ppm</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- O3_1 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="O3 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/O3_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">ppb</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- HCHO_1 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="HCHO display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/HCHO_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">ppm</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- NOISE_1 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="NOISE display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/NOISE_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">dB</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- PRESSURE_1 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PRESSURE display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PRESSURE_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">kpa</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </li>
      `;
	} else {
		return () => $h`<div></div>`;
	}
}



export default async (props, ctx) => {
	console.log("ctx",ctx);
	const $f7 = ctx.$f7,
		$f7route = ctx.$f7route,
		$update = ctx.$update,
		$on = ctx.$on,
		$onBeforeMount = ctx.$onBeforeMount,
		$onMounted = ctx.$onMounted,
		$onBeforeUpdate = ctx.$onBeforeUpdate,
		$onUpdated = ctx.$onUpdated,
		$onBeforeUnmount = ctx.$onBeforeUnmount,
		$onUnmounted = ctx.$onUnmounted;
		let networkChangeFun;
		let updateTime = 0;
		let fixedTop = 0;
		
	//if wifi failed change the wifi status
	if(networkChangeFun){
		emitter.off("onNetworkChange",networkChangeFun)
	}
	networkChangeFun = ()=>{
		if(window.http2.isDisconnect){
			$(`.room-box .signal-view-main`).each(function(element){
				$(this).find('.prioritys').removeClass('device-none');
			});
			// $(`.wifiicon`).each(function(element){
			// 	$(this).find("i").removeClass("text-color-green");
			// 	$(this).find("i").addClass("text-color-red");
			// 	$(this).find('i').text('wifi_off');
			// })
		}else{
			clearTimeout(idleTimer);
			if(mobileAsHubPopup){
				mobileAsHubPopup = null;
			}
			mobileAsHubStatus = false;
			mainView.router.refreshPage();
		}
	}
	emitter.on("onNetworkChange",networkChangeFun);
	
	emitter.off('device/reset');
	emitter.on('device/reset',async(data)=>{
		debugger
		if(data.guid){
			subdevices.forEach(item=>{
				if(item.device == data.guid){
					$(`li.device[guid="${data.guid}"]`).each(function(){
						$(this).find(".signal-view-main").attr("mobmob", "0");
						if($(this).find(".wifiicon i").length > 0){
							$(this).find(".wifiicon i").removeClass("text-color-green");
							$(this).find(".wifiicon i").addClass("text-color-red");
							$(this).find(".wifiicon i").text('wifi_off');
						}
					})
				}
			})
			$update();
		}
	})
	emitter.off('device/wifi/setup');
	emitter.on('device/wifi/setup',async(data)=>{
		if(data.guid){
			subdevices.forEach(item=>{
				if(item.device == data.guid){
					item.signalRfresh = true;
				}
			})
		}
		$update();
	})
	emitter.off('ha:device:firmware:upgrade');
	emitter.on('ha:device:firmware:upgrade',async(data)=>{
		if(data.guid){
			if(isset(peripheral[data.guid])){
				peripheral[data.guid].disconnect().then(()=>{

				}).catch(error=>{
					//if error, try to change the UI
					$(`.device[guid="${data.guid}"]`).find('.signal-view-main').attr('bluetooth',0);
				})
			}
		}
		$update();
	})
	// init variable,easy to seach ,initialization
	const title = $f7route.query.title ?_($f7route.query.title) : _('Smart Office');
	if(title == 'Engineering Mode'){
		fixedTop = 60;
		engineerMode = true;
		engineerModeStatus = true;
	}
	if(title == 'Installer'){
		fixedTop = 60;
		engineerMode = true;
		engineerModeStatus = true;
	}
	const isHomePage = !!$f7route.query.is_home_page;
	let listCssStatus = 'List';
	window.scanned_periperals = {};
	let page_margin_top = 48;
	let mobileAsHubStatus = false;
	let mobileAsHubPopup;
	//profile permission
	let profilePermision = true;
	
	
	let leftMenuPermision = false;
	let rooms = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_room)) : [];
	let subdevices = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_subdevice)) : [];
	let show_unassigned = false;
	let show_noroom = !rooms.length ? true : false;
	
	let devices = erp.info.device ? JSON.parse(JSON.stringify(erp.info.device)) : [];
	let device_models = erp.doctype.device_model ? JSON.parse(JSON.stringify(erp.doctype.device_model)) : {};

	let device_button_groups = erp.info.device_button_group || {};
	let device_button_commands = erp.info.device_command || {};
	for (let i in device_button_groups) {
		device_button_groups[i].device_command = {};
		if (isset(device_button_groups[i].button_group_sub_list[0])) {
			let command_name = device_button_groups[i].button_group_sub_list[0].device_command;
			device_button_groups[i].device_command = device_button_commands[command_name];
		}
	}


	device_models = Object.values(device_models).reduce((acc, obj) => {
		acc[obj.name] = obj;
		return acc;
	}, {});
	let unassigned_subdevices = [];
	let show_nosubdevice = (rooms.length && !subdevices.length && !Object.keys(peripheral).length) ? true : false;
	let profile_device = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_device)) : [];
	let scenesMap;
	let scenes = [];
	let roomScenes = [];
	let change_timers;// on_peripheral_changed setTimeout

	window.lastClickTime = {};
	window.clickInterval = 1500;
	window.timeoutId = null;
	let idleTimer;
	const IDLE_TIME = 20000;
	
	const changeFilter = (value)=>{
		$(`a.fliter-box[data-value="${filter_value}"]`).removeClass('fliter-bg-color');
		$(`a.fliter-box[data-value="${value}"]`).addClass('fliter-bg-color');
		filter_value = value;
		$update();
	}
	const resetIdleTimer = ()=>{
		//console.log("this_comming");
		clearTimeout(idleTimer);
		idleTimer = setTimeout(()=>{
			console.log("20s active");
			const debounce_init = core_utils_debounce(initPopup,2000,{
					leading: true,
					trailing: false
			});
			debounce_init();
		},IDLE_TIME)
	}
	const handleUserActivity = core_utils_debounce(resetIdleTimer,2000,{
        leading: true,
        trailing: false
    });
	document.removeEventListener("touchstart", handleUserActivity);
	document.removeEventListener("touchmove", handleUserActivity);
	document.removeEventListener("click", handleUserActivity);
	setTimeout(()=>{
		document.addEventListener("touchstart", handleUserActivity,{ passive: true });
		document.addEventListener("touchmove", handleUserActivity,{ passive: true });
		document.addEventListener("click", handleUserActivity,{ passive: true });
		//const container = document.getElementById('container');
		//console.log("container",container);
		// if(container){
		// 	//container.addEventListener('scroll',updateVisibleItems,{ passive: true });
		// }
	},500)
	const updateVisibleItems = (event)=>{
		const scrollTop = container.scrollTop;
		if(scrollTop > 1000.0){
			document.querySelectorAll('.page-current .home-scanned-peripheral-smart').forEach((el, index) => {
					if(index > 20 && index < 40){
						$(el).removeClass('device-none');
					}
			});
		}
		if(scrollTop > 1400.0){
			document.querySelectorAll('.page-current .home-scanned-peripheral-smart').forEach((el, index) => {
					if(index > 40){
						$(el).removeClass('device-none');
					}
			});
		}
	}
	const changeListCss = (type)=>{
		if(type == 1){
			listCssStatus = 'List';
		}else{
			listCssStatus = 'Card';
		}
		//save in local
		db.set('home_auto_listCssStatus',listCssStatus)
		$update();
	}
	const clickForMobile = ()=>{
		initPopup();
	}
	const initPopup = ()=>{
		if(!mobileAsHubStatus){
			return
		}
		if(!mobileAsHubPopup){
			mobileAsHubPopup = app.popup.create({
							content : /*html*/`
							<div class="popup">
								<div class="page">
									<div class="navbar">
										<div class="navbar-bg"></div>
										<div class="navbar-inner">
											<div class="title">${_('Mobile As Hub')}</div>
											<div class="right"><a  class="link popup-close"><i class="material-icons" style="font-size: 40px">cancel</i></a></div>
										</div>
									</div>
									<!-- style="background:rgba(0,0,0,.4);transition-duration:.4s;"  -->
									<div class="page-content" >
										<div class="block-title text-color-theme" style="overflow: initial;word-wrap: break-word;word-break: break-all;white-space: break-spaces;line-height: 32px;text-align: center;font-size:18px;">${_('This device is currently being used as hub.')}</div>
										<div class="block display-flex flex-direction-row align-items-center justify-content-center" style="height:80%;width:100%;">
											<div class="moblie-as-hub-icon signal-tower">
												<div class="signal-wave"></div>
												<div class="signal-wave"></div>
												<div class="signal-wave"></div>
												<div class="signal-wave"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
							`,
						})
						mobileAsHubPopup.open();
		}else{
			mobileAsHubPopup.close();
			setTimeout(()=>{
				mobileAsHubPopup.open();
			},100)
		}
	}
	if(Capacitor.platform !== 'ios'){
		app.dialog.preloader(_('Initializing the page, please wait...'))
	}
	let res = (await db.get('peripheral')) || null;
	console.log("init ready")
	if(Capacitor.platform !== 'ios'){
		
		while (true) {
			try {
				const dialog = app.dialog.close();
				if (!dialog) {
					break;
				}
			} catch (e) {
				break;
			}
		}
	}
	if (isset(res)) {
			const storedPeripheral = JSON.parse(res);
			const newStoredPeripheral = {};
			for(let guid in storedPeripheral){
					
					let exist = false;
					for(let i in profile_device){
							if(profile_device[i].device == guid){
									exist = true;
							}
					}
					if(!exist) continue;
					
					// alert("1"+JSON.stringify(storedPeripheral[guid]));
					newStoredPeripheral[guid] = storedPeripheral[guid];
					
					
					if (!isset(peripheral[guid])) {
						peripheral[guid] = new Peripheral(storedPeripheral[guid]);
					} else {
						peripheral[guid].update(storedPeripheral[guid]);
					}
			}
			await db.set('peripheral', JSON.stringify(storedPeripheral));
	}

	const initPage = async (pageType) => {
        // 	// please move these line to the very beginning if flow / page is changed.
        //     db.get('peripheral').then((data)=>{
        //         if(data){
        //             try{
        //                 // alert(data);
        //                 const storedPeripheral = JSON.parse(data);
        //                 for(let guid in storedPeripheral){
        //                     // alert("1"+JSON.stringify(storedPeripheral[guid]));
        //         			if (!isset(peripheral[guid])) {
        //         				peripheral[guid] = new Peripheral(storedPeripheral[guid]);
        //         			} else {
        // 						if(guid == '6630356563646662363330641201501d'){
        // 							console.log("storedPeripheral[guid]",storedPeripheral[guid])
        // 						}
        //         				peripheral[guid].update(storedPeripheral[guid]);
        //         			}
        //                 }
        //             }catch(e){
                        
        //             }
        //         }
        //     });
	  //get the profile permision
		rooms = [];
		subdevices = [];
		range_silder_list = {};
		rooms = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_room)) : [];
		subdevices = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_subdevice)) : [];
		profile_device = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_device)) : [];
		show_nosubdevice = (rooms.length && !subdevices.length && !Object.keys(peripheral).length) ? true : false;
		devices = erp.info.device ? JSON.parse(JSON.stringify(erp.info.device)) : [];
		scenesMap = cloneDeep(erp.info.scene);
		for(let i in scenesMap){
			if(!scenesMap[i].is_enabled){
				scenes.push(scenesMap[i])
			}
			//fliter the room Scene
			if(scenesMap[i].is_enabled && scenesMap[i].scene_template == "Room Scene Button"){
				//show the check room
				let configMap = JSON.parse(scenesMap[i].condition);
				if(configMap){
					let chooseRoomMap;
					configMap.forEach(configItem=>{
						if(configItem.ischeck){
							chooseRoomMap = configItem;
						}
					});
					scenesMap[i].profile_room = chooseRoomMap.name;
				}
				roomScenes.push(scenesMap[i]);
			}
		}
		if(scenes.length > 0){
			page_margin_top = 152;
			setTimeout(() => {
        const swiper = app.swiper.create('.swiper-container-auto', {
          speed: 200,
          spaceBetween: 20,
					autoplay : true
        });
      }, 1000);
		}
		profile_device = profile_device.reduce((acc, item) => {
			acc[item.name] = item;
			return acc;
		}, {});
		rooms.forEach(item => {
			let count = 0;
			subdevices.forEach(kitem => {
				if (kitem.profile_room === item.name) {
					count++;
				}
			})
			item.subdevices_count = count;
		});
		// init page data, start flow calculation
		subdevices.forEach(subdevice => {
			const vp = {};
			subdevice.signalRfresh = false;//refresh the signal item
			subdevice.device_virtual_status = isset(subdevice.status)? subdevice.status : 0;
			update_subdevice_by_device_button_group(subdevice, device_button_groups[subdevice['device_button_group']]);
			update_subdevice_by_subdevice_function(subdevice,subdevice.function);
			update_peripheral_by_subdevice(vp, subdevice);

			if (devices[subdevice.device]) {
				update_peripheral_by_device(vp, devices[subdevice.device])
				update_subdevice_by_device(subdevice, devices[subdevice.device]);
			}
			if (profile_device[subdevice.profile_device]) {
				update_peripheral_by_profile_device(vp, profile_device[subdevice.profile_device]);
				update_subdevice_by_profile_device(subdevice, profile_device[subdevice.profile_device]);

				if (device_models[profile_device[subdevice.profile_device].device_model]) {
					update_subdevice_by_device_model(subdevice, device_models[profile_device[subdevice.profile_device].device_model]);
				}
			}

			update_subdevice_by_peripheral(
				subdevice,
				peripheral[subdevice.device]?.getProp() || {}
			);

			if (!isset(peripheral[vp.guid])) {
				peripheral[vp.guid] = new Peripheral(vp);
			} else {
				peripheral[vp.guid].update(vp);
			}
		});
		//update the mutiway device
		subdevices.forEach((kitem,kindex)=>{
			if(isset(kitem.config) && kitem.config && kitem.device_mode == 'Multiway Switch'){
				let data = JSON.parse(kitem.config);
				kitem.pairing_guid = data.pairing_guid || '';
				kitem.mapping = data.mapping;
				if(kitem.mapping){
					subdevices.forEach((zitem,zindex)=>{
						if(zitem.name == kitem.mapping){
							let insert_params = zitem;
							subdevices.splice(zindex, 1);
							insert_params.profile_room = kitem.profile_room;
							insert_params.room_name = kitem.room_name;
							if(!insert_params.config){
                  return
              }
							insert_params.is_pairing = 1;
							let this_data = JSON.parse(insert_params.config);
							subdevices.splice(kindex, 0, insert_params);
						}
					})
				}
			}
		})
		$update();
		// init gateway list
		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway()));
		const gatewayMap = {};
		for (let i in profile_device) {
			if (!profile_device[i].gateway || profile_device[i].gateway.trim() == "") continue;

			const gatewayhash = md5(md5(profile_device[i].gateway));
			if (selfgatewayhash == gatewayhash) { // self gateway, need to listen to cmd
				if(!isset(gatewayMap[`${gatewayhash}`])){
					gatewayMap[`${gatewayhash}`] = true;
					const cmd_topic = `cmd/${gatewayhash}`;
					core_mqtt_subscribe(cmd_topic, 0, false);
					emitter.off(cmd_topic);
					emitter.on(cmd_topic, on_gateway_commands_received);
					//if find this mobile as hub,should update the UI page
					mobileAsHubStatus = true;
					const debounce_init = core_utils_debounce(initPopup,2000,{
							leading: true,
							trailing: false
					});
					if(pageType != 2){
						debounce_init();
					}
					//resetIdleTimer();
				}
			} else { // other gateway, need to listen to status and will
				if(!isset(gatewayMap[`${gatewayhash}`])){
					gatewayMap[`${gatewayhash}`] = true;
					//check if gateway is online / offline
					let will_topic = '';
					let gatewayhashList = profile_device[i].gateway.split('-');
					if(gatewayhashList.length > 2){
						will_topic = `will/${gatewayhash}`;
					}else{
						will_topic = `will/${md5(md5(profile_device[i].gateway.toLowerCase()))}`;
					}
					core_mqtt_subscribe(will_topic, 1, false);
					emitter.off(will_topic,on_gateway_will_changed);
					emitter.on(will_topic, on_gateway_will_changed);

					//get the devices' status from gateway
					const status_topic = `status/${gatewayhash}`;
					core_mqtt_subscribe(status_topic, 1, false);
					emitter.off(status_topic);
					emitter.on(status_topic, on_gateway_device_changed);
					
					//refresh gateway
					setTimeout(() => {
						core_mqtt_publish(`cmd/${gatewayhash}`, {
							"command": "Pubmsg",
							"function": "bleHelper.pubmsg",
							"params": "",
							"callback": "",
							"raw": ""
						}, 0, false, false, false).then(() => {

						}).catch(reject => {});
					}, 3000)
				}
			}
		}
		//the gateway will topic some time can not be change 
		setTimeout(()=>{
			refreshGateway();
		},1000)
		// init profile topic
		if(!isset(erp['checksum'])) erp['checksum'] = {};
		if(isset(erp.info.profile)){
    		const profilehash = md5(md5(erp.info.profile.name));
    
    		const cmd_topic = `status/${profilehash}`;
    		core_mqtt_subscribe(cmd_topic, 0, false);
    		emitter.off(cmd_topic);
    		emitter.on(cmd_topic, function(data){
    		  //  alert("Receive2 = "+JSON.stringify(data));
						
        		let message = data.message;
        		
        		if (isset(message) && message) {
        		    
        			let deviceObj = JSON.parse(message);
        		    if(isset(erp.checksum['profile_mqtt']) && erp.checksum['profile_mqtt']==md5(JSON.stringify(deviceObj))){
        		        return;
        		    }
        		    erp.checksum['profile_mqtt'] = md5(JSON.stringify(deviceObj));
        			
        			for(let guid in deviceObj.Device){
        			    let p = {
        				    guid:guid,
        				    mac_address:deviceObj.Device[guid].mac_address,
        				    status:{
        				        mqtt: deviceObj.Device[guid].status,
        				    }
        				};
            			if (!isset(peripheral[guid])) {
            				peripheral[guid] = new Peripheral(p);
            			} else {
            				if(peripheral[guid].getProp().status.mqtt[1] < p.status.mqtt[1]){
            				    peripheral[guid].update(p);
            				}
            			}
        			}
        			
        			for(let subdevice_name in deviceObj.Virtual){
        			    let guid = deviceObj.Virtual[subdevice_name].guid;
        				
        			    if (!isset(peripheral[guid])) {
        			    	continue;
            			}
            			
            			if(!isset(peripheral[guid].getProp().config[subdevice_name]) || !isset(peripheral[guid].getProp().config[subdevice_name].mqtt)){
            			    peripheral[guid].setMqttGangConfig(subdevice_name, deviceObj.Virtual[subdevice_name].config);
        				    continue;
            			}
            			
        				if(peripheral[guid].getProp().config[subdevice_name].mqtt[1] >= deviceObj.Virtual[subdevice_name].config[1]){
        			        continue;
        				}
        				
        				peripheral[guid].setMqttGangConfig(subdevice_name, deviceObj.Virtual[subdevice_name].config);
        				
        			 //   alert("deviceObj.Virtual[subdevice_name].config="+JSON.stringify(deviceObj.Virtual[subdevice_name].config));
        				// subdevices.forEach(subdevice => {
        				//     if(subdevice.name == subdevice_name){
        				//         subdevice.config = peripheral[guid].getGangConfig(subdevice_name);
        				//         alert(subdevice.config);
        				//     }
        				// });
        			}
        		}
    		});
		}
		//
		setTimeout(()=>{
			// $('.page-current .home-scanned-peripheral').each(function(indexsss){
			// 	console.log("indexsss",indexsss);
			// })
			// document.querySelectorAll('.page-current .home-scanned-peripheral-smart').forEach((el, index) => {
			// 	if(index > 20){
			// 		$(el).addClass('device-none');
			// 	}
			// });
		},500)
	}
	const home_auto_click_scene = async(item)=>{
		//excute the scene
		//mian excute the action command
		//first get the action guid ,compare the device to get the action command
		app.dialog.preloader();
		let tempalteName = item.scene_template;
		let filterList = ['RCU Scene Button','RCU Scene Toggle','RCU Radar','RCU Curtain','Gateway Scene'];
		let clearTime = setTimeout(()=>{
			app.dialog.close();
			//app.dialog.alert(`${_('Execution Successfully')}`);
		},3*1000);
		if(tempalteName == 'Scene Banner' || tempalteName == 'Room Scene Button'){
			let devices = JSON.parse(item.action);
			let errorList = [];
			
			//if have same device,group by one.
			//deviceMap is {"guid":[item1,item2]}
			let deviceMap = {};
			devices.forEach(deviceItem=>{
				if(isset(deviceMap[deviceItem.device])){
					deviceMap[deviceItem.device].push(deviceItem);
				}else{
					deviceMap[deviceItem.device] = [deviceItem];
				}
			})
			console.log("deviceMap",deviceMap);
			let bleDeviceMap = {};
			for(let guids in deviceMap){
				bleDeviceMap[guids] = {}
				let bleOnoffCommandList = [];
				let bleRcuOnoffCommandList = [];
				let bleDimmingCommandList = [];
				let bleRcuDimmingCommandList = [];
				let bleThermostatCommandList = [];
				let bleCurtainMotorCommandList = [];
				let bleOpenCloseCommandList = [];
				let toggleGang1CommandList = [];
				let deviceList = deviceMap[guids];
				for(let i in deviceList){
					let ref = deviceList[i].ref;
					let guid = deviceList[i].device;
					let button_group = deviceList[i].device_button_group;
					let gang = bleHelper.getGangId(button_group);
					if(button_group.startsWith("ONOFF GANG")){
						bleOnoffCommandList.push({
							gang : gang,
							on : ref
						})
					}else if(button_group.startsWith("RCU ONOFF GANG")){
						bleRcuOnoffCommandList.push({
							gang : gang,
							on : ref
						})
					}else if(button_group.startsWith("DIMMING")){
						bleDimmingCommandList.push({
							gang : gang,
							value : ref
						})
					}else if(button_group.startsWith("RCU DIMMING")){
						bleRcuDimmingCommandList.push({
							gang : gang,
							value : ref
						})
					}else if(button_group.startsWith("TOGGLE GANG1")){
						//default run 7s
						toggleGang1CommandList.push({
							gang : gang,
							on : 1
						})
					}else if(button_group.startsWith("Thermostat")){
						let device_attachment_status = `${deviceList[i].ref},${deviceList[i].modeStr},${deviceList[i].speedVaule},${deviceList[i].temperature},${deviceList[i].temperature},0`;
						let commandList = tindyThermostatCommand(device_attachment_status);
						if(ref){
							for(let j in commandList){
								bleThermostatCommandList.push({
									gang: commandList[j].gang,
									value: commandList[j].status,
									command : commandList[j].command
								})
							}
						}else{
							bleThermostatCommandList.push({
								gang: 42,
								value: 0,
								command : `940300000100`
							})
						}
					}else if(button_group.startsWith("OPENCLOSE UART REVERSE") || button_group.startsWith("OPENCLOSE WIFI UART REVERSE")){
						let command = tindyCurtainMotor(guid,button_group,parseInt(100-ref));
						bleCurtainMotorCommandList.push({
							gang: gang,
							value: ref,
							command: command
						})
					}else if(button_group.startsWith("OPENCLOSE UART") || button_group.startsWith("OPENCLOSE WIFI UART")){
						let command = tindyCurtainMotor(guid,button_group,ref);
						bleCurtainMotorCommandList.push({
							gang: gang,
							value: ref,
							command: command
						})
					}else if(button_group.startsWith("OPENCLOSE GANG") || button_group.startsWith.startsWith("RCU OPENCLOSE GANG")){
						let deviceSettings = cloneDeep(erp.info.device[guid].settings);
						let runTime = 10;
						deviceSettings.forEach(settingItem=>{
							if(settingItem.setting_type.includes("Delay Lastfor")){
								let settingButtonGroup = settingItem.setting_type.split("|");
								if(settingButtonGroup == button_group){
									let objMap = JSON.parse(settingItem.setting);
									runTime = parseInt(objMap["Run for (s)"]);
								}
							}
						});
						let direction = 'close';
						if(ref){
							direction = 'open';
						}
						bleOpenCloseCommandList.push({
							gang: gang,
							direction: direction
						})
					}
				}
				bleDeviceMap[guids] = {
					bleOnoffCommandList,
					bleRcuOnoffCommandList,
					bleRcuDimmingCommandList,
					bleDimmingCommandList,
					bleThermostatCommandList,
					bleCurtainMotorCommandList,
					bleOpenCloseCommandList,
					toggleGang1CommandList
				}
			}
			console.log("bleDeviceMap[guids]",bleDeviceMap);
			for(let guid in bleDeviceMap){
				try{
					if(bleDeviceMap[guid].bleOnoffCommandList.length){
						peripheral[guid].onoff(bleDeviceMap[guid].bleOnoffCommandList)
					}else if(bleDeviceMap[guid].bleRcuOnoffCommandList.length){
						peripheral[guid].rcuOnoff(bleDeviceMap[guid].bleRcuOnoffCommandList)
					}else if(bleDeviceMap[guid].bleDimmingCommandList.length){
						peripheral[guid].dimming(bleDeviceMap[guid].bleDimmingCommandList)
					}else if(bleDeviceMap[guid].bleRcuDimmingCommandList.length){
						peripheral[guid].rcuDimming(bleDeviceMap[guid].bleRcuDimmingCommandList)
					}else if(bleDeviceMap[guid].bleThermostatCommandList.length){
						peripheral[guid].thermostat(bleDeviceMap[guid].bleThermostatCommandList)
					}else if(bleDeviceMap[guid].bleCurtainMotorCommandList.length){
						peripheral[guid].curtainmotor(bleDeviceMap[guid].bleCurtainMotorCommandList)
					}else if(bleDeviceMap[guid].bleOpenCloseCommandList.length){
						for(let j in bleDeviceMap[guid].bleOpenCloseCommandList){
							peripheral[guid].openClose(bleDeviceMap[guid].bleOpenCloseCommandList[j].gang,bleDeviceMap[guid].bleOpenCloseCommandList[j].direction,true)
						}
					}else if(bleDeviceMap[guid].toggleGang1CommandList.length){
						peripheral[guid].onoff(bleDeviceMap[guid].toggleGang1CommandList);
						setTimeout(()=>{
							peripheral[guid].onoff([{
								gang : bleDeviceMap[guid].toggleGang1CommandList[0].gang,
								on : 0
							}]);
						},7*1000)
					}
				}catch(error){
					errorList.push({
						title : guid,
						error : _(erp.get_log_description(error))
					});
				}
				
			}
			return
			//tindy command
			for(let i in devices){
				let ref = devices[i].ref;
				let guid = devices[i].device;
				let button_group = devices[i].device_button_group;
				let gang = bleHelper.getGangId(button_group);
				try{
					if(button_group.startsWith("ONOFF GANG")){
						peripheral[guid].onoff([{
							gang : gang,
							on : ref
						}])
					}else if(button_group.startsWith("RCU ONOFF GANG")){
						peripheral[guid].rcuOnoff([{
							gang : gang,
							on : ref
						}])
					}else if(button_group.startsWith("DIMMING")){
						peripheral[guid].dimming([{
							gang: gang,
							value: ref
						}])
					}else if( button_group.startsWith("RCU DIMMING")){
						peripheral[guid].rcuDimming([{
							gang: gang,
							value: ref
						}])
					}else if(button_group.startsWith("Thermostat")){
						//"0,0,0,26,26,0"   onoff,mode_value,speed_vaule,temperature,room_temperature,hum
						let device_attachment_status = `${devices[i].ref},${devices[i].modeStr},${devices[i].speedVaule},${devices[i].temperature},${devices[i].temperature},0`;
						let commandList = tindyThermostatCommand(device_attachment_status);
						console.log("commandList",commandList);
						if(ref){
							for(let j in commandList){
								peripheral[guid].thermostat([{
									gang: commandList[j].gang,
									value: commandList[j].status,
									command : commandList[j].command
								}])
							}
						}else{
							peripheral[guid].thermostat([{
								gang: 42,
								value: 0,
								command : `940300000100`
							}])
						}
					}else if(button_group.startsWith("OPENCLOSE UART REVERSE") || button_group.startsWith("OPENCLOSE WIFI UART REVERSE")){
						debugger
						let command = tindyCurtainMotor(guid,button_group,parseInt(100-ref));
						peripheral[guid].curtainmotor([{
								gang: gang,
								value: ref,
								command: command
							}])
					}else if(button_group.startsWith("OPENCLOSE UART") || button_group.startsWith("OPENCLOSE WIFI UART")){
						let command = tindyCurtainMotor(guid,button_group,ref);
						debugger
						peripheral[guid].curtainmotor([{
								gang: gang,
								value: ref,
								command: command
							}])
					}else if(button_group.startsWith("OPENCLOSE GANG") || button_group.startsWith.startsWith("RCU OPENCLOSE GANG")){
						//get the run time 
						let deviceSettings = cloneDeep(erp.info.device[guid].settings);
						let runTime = 10;
						deviceSettings.forEach(settingItem=>{
							if(settingItem.setting_type.includes("Delay Lastfor")){
								let settingButtonGroup = settingItem.setting_type.split("|");
								if(settingButtonGroup == button_group){
									let objMap = JSON.parse(settingItem.setting);
									runTime = parseInt(objMap["Run for (s)"]);
								}
							}
						});
						let direction = 'close';
						if(ref){
							direction = 'open';
						}
						peripheral[guid].openClose(gang, direction, true)
					}
				}catch(error){
					errorList.push({
							title : tran(devices[i].title),
							error : _(erp.get_log_description(error))
						});
				}
			}
			app.dialog.close();
			clearTimeout(clearTime);
			//running and update
			//app.dialog.alert(`${_('Execution Successfully')}`);
		}else if(filterList.indexOf(tempalteName) > -1){
			//trigger the scene
			let list = item.scene_device_location;
			for(let i in list){
				let command = `8f0200${parseInt(list[i].storage_id).toString(16).pad("00") }`;
				console.log('command', command);
				try{
					await peripheral[list[i].device].write([
					{
						service: 'ff80',
						characteristic: 'ff81',
						data: command,
						},
					]);
				}catch(error){
					console.log(error);
				}
			}
			app.dialog.close();
			clearTimeout(clearTime);
		}
	}
	//check if rcu scene have wifi device and the mac address is not correct
	window.EngineerModeCheck = (onlyOta = false)=>{
		//find all the device 
		let profile_device = erp.info.profile.profile_device;
		let sceneMap = cloneDeep(erp.info.scene);
		let deviceDetailList = [];
		let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
		erp.deviceList = [];
		for(let i in profile_device){
			erp.deviceList.push(profile_device[i].device);
		}
		erp.deviceList.forEach((item) => {
			let titleList = [];
			let roomNameList = [];
			let obj = {
				titleList : [],
				roomNameList : [],
				device : item,
				device_model : '',
				device_name : '',
				connectStatus : 0, //0: not connect, 1: connected 2: connecting
				errorLog : '',
			}
			profile_subdevices.forEach((subdevice) => {
				if(subdevice.device == item){

					if(titleList.indexOf(subdevice.title) == -1){
						titleList.push(subdevice.title);
					}
					if(roomNameList.indexOf(subdevice.room_name) == -1){
						roomNameList.push(subdevice.room_name);
					}
				}
			});
			profile_device.forEach((device) => {
				if(device.device == item){
					obj.device_name = device.device_name;
					obj.device_model = device.device_model;
				}
			});
			obj.titleList = titleList;
			obj.roomNameList = roomNameList;
			deviceDetailList.push(obj);
		});
		console.log("deviceDetailList",deviceDetailList);
		generateSingleDeviceModel(deviceDetailList,onlyOta);
		//generate the device list
		//app.dialog.alert("Coming soon, Please wait for the update the mesh.");
	}
	const generateSingleDeviceModel =(list,onlyOta = false)=>{
		if(erp.deviceSheet){
			erp.deviceSheet.close();
		}
		let html = '';
		for(let i in list){
			if(!list[i].device_name){
				continue;
			}
			html += `<li class="manufacturing-steps manufacturing-step1" deviceName="${list[i].device_name}">
				<div class="item-content">
					<div class="item-inner">
						<div class="item-title">
							<span class="device-title">${list[i].device_model}</span>
							<span class="device-title">-</span>
							<span class="device-title">${list[i].device_name}</span>
							<span class="device-title firmware-version">(${isset(window.peripheral[list[i].device]) && window.peripheral[list[i].device].getProp().firmwareNo?window.peripheral[list[i].device].getProp().firmwareNo:''})</span>
							<p>
								<span class="room-title text-color-gray">${tran(list[i].roomNameList[0])}</span>
								<span class="room-title text-color-gray">/</span>
								<span class="room-title text-color-gray">${tran(list[i].titleList[0])}</span>
							</p>
							<p class="error-log text-color-red">${list[i].errorLog}</p>
						</div>
						<div class="item-after">
							<i class="icon material-icons">watch_later</i>
						</div>
					</div>
				</div>
			</li>`;
		}
		erp.deviceSheet = app.sheet.create({
			content: `
				<div class="sheet-modal" style="height:auto">
					<div class="sheet-modal-inner">
						<div class="swipe-handler"></div>
						<div class="page-content" style="height:600px;">
							<div class="list list-strong list-outline list-dividers-ios">
								<ul class="manufacturing-steps-list">
								${html}
								</ul>
							</div>
							<div class="block block-strong">
								<p class="row">
									<div class="col">
										<div class="button button-raised button-fill button-save" func="EngineerModeCheck">${ _('Retry') }</div>
									</div>
								</p>
							</div>
						</div>
					</div>
				</div>
			`,
			on: {
				closed: () => {
					console.log('closed');
					while (true) {
						try {
							const dialog = app.dialog.close();
							if (!dialog) {
								break;
							}
						} catch (e) {
							break;
						}
					}
					app.dialog.alert(_('Cancel the checking.'))
				},
			},
			swipeToClose: true,
			push: true,
			backdrop: true,
		});
		erp.deviceSheet.open();
		if(!onlyOta){
			startCheckDevice(list);
		}else{
			startBatchOta(list)
		}
	}
	window.retryCheckDevice = ()=>{
		app.toast.create({
			text: _('Retry'),
			position: 'center',
			closeTimeout: 2000,
		}).open();
	}
	const checkDeviceFirmware = (guid)=>{
		return new Promise(async(resolve,reject)=>{
			//get the erp device firmware
			let deviceMap = erp.info.device[guid];
			let deviceModel = deviceMap.device_model;
			if(!deviceModel){
				reject({
					error : 'Device Model Error',
					firmware : '',
				});
			}
			let deviceModelMap = null;
			let deviceModelList = erp.doctype.device_model;
			for(let i in deviceModelList){
				if(deviceModelList[i].name == deviceModel){
					deviceModelMap = deviceModelList[i];
					break;
				}
			}
			if(!deviceModelMap){
				reject({
					error : 'Device Model Error',
					firmware : '',
				});
			}
			if(!deviceModelMap.latest_firmware){
				resolve({
					firmware : '',
				});
			}
			let deviceFirmware = deviceModelMap.latest_firmware.replace(/[^0-9.]/g, '');
			deviceFirmware = deviceFirmware.split('.');
			deviceFirmware = deviceFirmware[0] + '.' + (deviceFirmware.length>1 ? deviceFirmware.slice(1).join('') : '0');
			let currentFirmware = window.peripheral[guid].getProp().firmware;
			
			if(!currentFirmware){
				reject({
					error : 'Current Firmware Error',
					firmware : '',
				});
			}
			currentFirmware = currentFirmware.replace(/[^0-9.]/g, '');
			currentFirmware = currentFirmware.split('.');
			currentFirmware = currentFirmware[0] + '.' + (currentFirmware.length>1 ? currentFirmware.slice(1).join('') : '0');
			console.log("deviceFirmware",deviceFirmware)
			console.log("currentFirmware",currentFirmware)
			if(currentFirmware < deviceFirmware){
				reject({
					error : 'The device firmware is not the latest version.',
					firmware : deviceModelMap.latest_firmware,
				});
			}else{
				resolve({
					firmware : deviceModelMap.latest_firmware,
				});
			}
		})
	}
	window.showPromptDialog = (title)=>{
		return new Promise(async(resolve,reject)=>{
			app.dialog.login(_(title),(username,password)=>{
				resolve({
					username : username,
					password : password,
				});
			},()=>{
				resolve(false);
			});
			//change the dialog to the wifi dialog
			setTimeout(()=>{
				$('.dialog-input-field input[name="dialog-username"]').attr('placeholder','Ssid');
				$('.dialog-input-field input[name="dialog-password"]').attr('type','text');
				$('.dialog-input-field input[name="dialog-password"]').attr('placeholder','Password');
				$('.dialog-input-field input[name="dialog-username"]').val(wifiInfoMap.ssid);
				$('.dialog-input-field input[name="dialog-password"]').val(wifiInfoMap.password);
			},200);
		})
	}
	window.showUpdateConfirm = (title)=>{
		return new Promise(async(resolve,reject)=>{ 
			app.dialog.confirm(_(title),()=>{
				resolve(true);
			},()=>{
				resolve(false);
			});
		})
	}
	const updateFirmware = (guid,firmware)=>{
		debugger
		return new Promise(async(resolve,reject)=>{
			app.dialog.preloader(_('Updating firmware, it may take 3-4 minutes.'));
			let wifiStatus = await checkWifiStatus(guid);
			debugger
			if(!wifiStatus){
				app.dialog.close();
				reject('Wi-Fi not connected.');
				return;
			}
			//find the device gateway
			let profile_device = cloneDeep(erp.info.profile.profile_device);
			let deviceMap = profile_device.find((item)=>item.device == guid);
			if(!deviceMap){
				app.dialog.close();
				reject('Device is not found.');
				return;
			}
			let gateway = deviceMap.gateway;
			if(!gateway){
				app.dialog.close();
				reject('Device gateway is not set.');
				return;
			}
			let topic = `cmd/${md5(md5(gateway.toLowerCase()))}`;
			let check_topic = `status/${md5(md5(gateway.toLowerCase()))}`;
			let full_firmware_name = firmware;
			// if(!(deviceMap.device_model.includes('YO105') || deviceMap.device_model.includes('YO161'))){
			// 	full_firmware_name = `https://dev.mob-mob.com/files/firmware/${firmware}.bin`;
			// }
			full_firmware_name = `${full_firmware_name}.bin`;
			let command = {
				command: "OTA",
				function: "bleHelper.ota",
				params: full_firmware_name,
				callback: "",
				raw: ""
			}
			console.log("command",command);
			//send to the mqtt topic
			try{
				await core_mqtt_publish(topic, command, 0, false, false, false);
				try{
					let result = await checkIsUpdateLatestFirmware(check_topic,guid,firmware);
					if(!result){
						reject('Update Failed');
					}else{
						await uploadFirmwareToServer(guid,firmware);
						resolve(true);
					}
				}catch(updateError){
					reject(updateError);
				}
				
			}catch(error){
				console.log("error",error);
			}
			app.dialog.close();
			resolve(true);
		})
	}
	const uploadFirmwareToServer = (guid,current_firmware)=>{
		return new Promise(async(resolve,reject)=>{
			try {
        await http.request(encodeURI('/api/resource/Device/' + guid), {
          method: 'PUT',
          responseType: 'json',
          serializer: 'json',
          data: {
            firmware: current_firmware,
          },
        });
				resolve(true);
      } catch (err) {
        // ignore
				reject(err);
      }
		})
	}
	const checkIsUpdateLatestFirmware = (check_topic,guid,firmware)=>{
		return new Promise(async(resolve,reject)=>{
			let timeoutId = null;
			let isOnline = false;
			let versionMatched = false;
			const cleanup = () => {
				clearTimeout(timeoutId);
				emitter.off(check_topic, handleStatusMessage);
			};
			const handleStatusMessage = (payload) => {
			console.log('handleStatusMessage: ',payload);
			try {
				const data = JSON.parse(payload.message); 
				if (data.Info.version.toLowerCase() === firmware.toLowerCase()) {
									debugger
									versionMatched = true;
									completeCheck(true);
							}
					} catch (e) {
							console.log(e)
					}
			};
			const completeCheck = (result) => {
					cleanup();
					resolve(result);
			};
			const checkVersionStatus = () => {
					if (versionMatched) {
							completeCheck(true);
							return;
					}
					// 主动请求设备状态
					core_mqtt_publish(`cmd/${check_topic}`, {
							command: "Pubmsg",
							function: "bleHelper.pubmsg",
							params: "",
							callback: "",
							raw: ""
					}, 0, false, false, false).catch(console.error);
			};
			core_mqtt_subscribe(check_topic, 1, false);
			emitter.on(check_topic, handleStatusMessage);
			timeoutId = setTimeout(() => {
					completeCheck(versionMatched);
			}, 60000*4);
			setTimeout(() => {
					checkVersionStatus()
			}, 500);
		})
	}
	const connectWifi = (ssid,password,guid)=>{
		return new Promise(async(resolve,reject)=>{
			app.dialog.preloader(_('Connect Wi-Fi...'));
			let wifiConnectTimmer = setTimeout(()=>{
				reject('Sorry, Wi-Fi is not connected yet.');
			},1000*60*2);
			if (ssid === '' || password === '') {
				clearTimeout(wifiConnectTimmer);
				reject('Please fill in the SSID and Password.');
				return;
			}else{
				const saveSsid = () => {
					const data = '932000' + ssid.length.toString(16).pad('0000') + ssid.convertToHex();
					return window.peripheral[guid].write([
						{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						},
					]);
				};
				const saveSsidPassword = () => {
					const data = '932100' + password.length.toString(16).pad('0000') + password.convertToHex();

					return window.peripheral[guid].write([
						{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						},
					]);
				};
				const saveEmail = () => {
					let email = users[users.current].usr.toLowerCase();
					const data = '932200' + email.length.toString(16).pad('0000') + email.convertToHex();

					return window.peripheral[guid].write([
						{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						},
					]);
				};
				const savePort = () => {
					let port = erp.settings[erp.appId].mqtt_port;
					const data = '9301000002' + (port * 1).toString(16).pad('0000');

					return window.peripheral[guid].write([
						{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						},
					]);
				};
				const saveServerUrl = () => {
					let server_url = 'mqtt://' + erp.settings[erp.appId].mqtt_server;
					const data = '930000' + server_url.length.toString(16).pad('0000') + server_url.convertToHex();

					return window.peripheral[guid].write([
						{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						},
					]);
				};
				const restartDevice = () => {
					return window.peripheral[guid].write([
						{
							service: 'ff80',
							characteristic: 'ff81',
							data: '810e',
						},
					]);
				};
				const sleep = (ms) => {
					return new Promise((resolve, reject) => {
						setTimeout(() => {
							resolve();
						}, ms);
					});
				};
				const checkIfOnline = () => {
					let mac = core_utils_get_mac_address_from_guid(guid, false);
					let topic_self = `${mac.toLowerCase()}-${users[users.current].usr.toLowerCase()}`;
					let will_topic = `will/${md5(md5(topic_self))}`;
					mqtt.subscribe(will_topic);
					window.$subscribeTimer = setTimeout(() => {
						mqtt.subscribe(will_topic);
					}, 10 * 1000);
					if (window.$wifiTopicFun) {
						emitter.off(will_topic, window.$wifiTopicFun);
					}
					window.$wifiTopicFun = async (res) => {
						console.log('component res', res);
						let message = res.message;
						if (message.includes('Online')) {
							clearTimeout(window.$subscribeTimer);
							clearTimeout(wifiConnectTimmer);
							//update profile_devices
							let thisMap = erp.info.profile.profile_device.find((item)=>item.device == guid);
							thisMap.gateway = topic_self;
							window.peripheral[guid].prop.is_mobmob = 1;
							app.dialog.close();
							resolve(true)
							//check the state of the connect status
						}
					};
					emitter.on(will_topic, window.$wifiTopicFun);
				};
				try{
					await saveSsid();
					await saveSsidPassword();
					await saveEmail();
					await savePort();
					await saveServerUrl();
					await restartDevice();
					await sleep(10 * 1000);
					await window.peripheral[guid].connect();
					checkIfOnline();
				}catch(error){
					reject(error)
				}
			}
		})
	}
	const checkWifiStatus = (guid)=>{
		return new Promise(async(resolve,reject)=>{
			//check if set the gateway
			let wifiStatus = false;
			let profile_devices = cloneDeep(erp.info.profile.profile_device);
			let deviceMap = {};
			deviceMap = profile_devices.find((item)=>item.device == guid);
			if(deviceMap){
				let gateway = deviceMap.gateway;
				if(gateway){
					wifiStatus = peripheral[guid].getProp().is_mobmob?true:false;
				}else{
					wifiStatus = false;
				}
			}
			resolve(wifiStatus);
		})
	}
	window.getDeviceNotificationForEngineerMode = (guid)=>{
		return new Promise(async(resolve,reject)=>{
			let sceneTimer = setTimeout(()=>{
				app.dialog.close();
				reject('Scene Check Timed Out')
			},1000*60)
			//check if not the mesh device
			let deviceMap = erp.info.device[guid];
			if(!deviceMap){
				reject('Device is not found.');
			}
			let deviceModel = deviceMap.device_model;
			if(!(deviceModel.includes('780') || deviceModel.includes('M146') || deviceModel.includes('M86'))){
				clearTimeout(sceneTimer);
				resolve([]);
			}
			let commandList = [];
			if(erp.script.getDeviceNotification){
				emitter.off('get/device/notification',erp.script.getDeviceNotification)
			}
			erp.script.getDeviceNotification = (data) => {
				// console.log("data",data);
				let rs = data.rs;
				commandList.push(rs);
				if ((rs.startsWith('8f20') || rs.startsWith('8f22')) && rs.length > 8){
					//trigger command
					let thisSceneId = rs.slice(6, 8);
					if (thisSceneId == '00') {
						return;
					}
					
				}else if((rs.startsWith('8f10') || rs.startsWith('8f12')) && rs.length > 8){
					//action command
					let thisSceneId = rs.slice(6, 8);
					if (thisSceneId == '00') {
						return;
					}
					
				}else if(rs.startsWith('972303') && rs.length > 10 && rs.substring(8,10) == '02'){
					//toggle setting command
					let thisSceneId = rs.slice(6, 8);		
					if (thisSceneId == '00') {
						return;
					}
					rs = rs.replace('972303','972003');
					commandList.push(rs);
					
				}else if(rs.startsWith('972303') && rs.length > 10 && rs.substring(8,10) == '01'){
					//toggle on command
					let thisSceneId = rs.slice(6, 8);
					if (thisSceneId == '00') {
						return;
					}
					rs = rs.replace('972303','972003');
					commandList.push(rs);
				}else if(rs.startsWith('972303') && rs.length > 10 && rs.substring(8,10) == '00'){
					//toggle off command
					let thisSceneId = rs.slice(6, 8);
					if (thisSceneId == '00') {
						return;
					}
					rs = rs.replace('972303','972003');
					commandList.push(rs);
				}else if(rs.startsWith('8f13') && rs.length > 8){
					//raw setting command
					let thisSceneId = rs.slice(6, 8);
					if (thisSceneId == '00') {
						return;
					}
				}else if(commandList.indexOf('8f1300ff') != -1 && 
								commandList.indexOf('8f200000ff') != -1 &&
								commandList.indexOf('972303ff02') != -1 &&
								commandList.indexOf('8f1000ff') != -1){
					//8f1000ff,972303ff02,8f1300ff,8f200000ff
					clearTimeout(sceneTimer);
					resolve(commandList);
				}
				
			}
			emitter.on('get/device/notification',erp.script.getDeviceNotification);
			try{
				let read_action_command = '8F1200FF';
				let read_trriger_command = `8F220000FF`;
				let read_scene_toggle_on_command = `972303ff01`;
				let read_scene_toggle_off_command = `972303ff00`;
				let read_scene_toggle_setting_command = `972303ff02`;
				let read_raw_setting_command = `8f1500ff`;
				let totalCommand = `1304${read_action_command}05${read_trriger_command}05${read_scene_toggle_on_command}05${read_scene_toggle_off_command}05${read_scene_toggle_setting_command}04${read_raw_setting_command}`;
				await peripheral[guid].connect();
				await peripheral[guid].write([
					{
						service: 'ff80',
						characteristic: 'ff81',
						data: totalCommand.toLocaleLowerCase(),
					}
				]);
			}catch(error){
				reject(error);
			}
			
		})
	}
	const get_device_setting_type = (guid,setting_type)=>{
    let settings = erp.info.device[guid].settings;
    if(settings && settings.length){
      let settingMap = settings.find((item)=>item.setting_type == setting_type);
      if(settingMap){
        return settingMap.setting;
      }else{
        return '';
      }
    }else{
      return '';
    }
  }
	const check_device_firmware_version_and_update = async(guid,device_name)=>{
		return new Promise(async(resolve,reject)=>{
			const self = this;
      const oldResolve = resolve;
      const oldReject = reject;
			try{
				refreshDeviceUi(device_name,'sync');
        //get the device gateway
				if(!guid){
					refreshDeviceUi(device_name,'error','Device not found.');
					reject('Device not found.');
					return;
				}
        let gateway = '';
        let profile_device = cloneDeep(erp.info.profile.profile_device);
        profile_device.forEach((item)=>{
          if(item.device == guid){
            gateway = item.gateway;
          }
        })
        let ssid = get_device_setting_type(guid,'Wifi SSID');
        let password = get_device_setting_type(guid,'Wifi Password');
        if(!ssid){
          //find the ssid from other device
          let devices = cloneDeep(erp.info.device);
          for(let i in devices){
            if(devices[i].device_model == 'YO780' || devices[i].device_mode == 'RCU Controller'){
              let rcu_ssid = get_device_setting_type(devices[i].guid,'Wifi SSID');
              let rcu_password = get_device_setting_type(devices[i].guid,'Wifi Password');
              if(rcu_ssid){
                ssid = rcu_ssid;
              }
              if(rcu_password){
                password = rcu_password;
              }
            }
          }
        }
        const otaInstance = new window.iotWifiOta({
          guid: guid,
          gateway: gateway,
          ssid: ssid,
          password: password,
          showUI: true  // 启用UI提示显示
        });
        otaInstance.setCallbacks({
          onProgress: (progress) => {
            console.log(`进度: ${progress}%`);
            if(progress > 100){
              //reject error
              reject(_('Abnormal progress Interruption'))
            }
          },
          onError: (error) => {
            refreshDeviceUi(device_name,'error',error);
						app.dialog.confirm(_(erp.get_log_description(error))+', '+_('would you like to try again?'),async()=>{
						try{
							await check_device_firmware_version_and_update(guid,device_name);
							oldResolve(true);
						}catch(error){
							oldReject(error);
						}
						},()=>{
							oldResolve(true);
						})
          },
          onSuccess: (message) => {
            console.log(`成功: ${message}`);
            // resolve(true);
          },
          onRetryPrompt: (error, retryCount, maxRetries, resolve) => {
            console.log(`失败原因: ${error}`);
            console.log(`重试次数: ${retryCount}/${maxRetries}`);
						
            app.dialog.confirm(_(erp.get_log_description(error))+'\n\n'+_('Would you like to try again?'),async()=>{
              try{
                await check_device_firmware_version_and_update(guid,device_name);
                oldResolve(true);
              }catch(error){
                oldReject(error);
              }
            },()=>{
              oldResolve(true);
            })
          }
        });
        await otaInstance.init();
        const status = otaInstance.getStatus();
        console.log('WiFi状态:', status.wifiStatus);
        console.log('需要连接WiFi:', status.needsWifiConnection);
        console.log('需要固件升级:', status.needsFirmwareUpgrade);
        //判断是否需要OTA升级
        if(status.needsFirmwareUpgrade){
          //需要OTA升级
          if(status.needsWifiConnection){
            console.log('开始连接WiFi...');
            await otaInstance.wifiConnect();
            console.log('WiFi连接成功');
            console.log('开始固件升级...');
            await otaInstance.fullUpgrade();
            console.log('固件升级成功');
						window.peripheral[guid].prop.firmware = status.latestFirmware;
						window.peripheral[guid].prop.firmwareNo = status.latestFirmware;
						//firmware
						refreshDeviceUi(device_name,'firmware',status.latestFirmware);
						refreshDeviceUi(device_name,'success');
            resolve(true);
          }else{
            console.log('WiFi连接成功');
            console.log('开始固件升级...');
            await otaInstance.fullUpgrade();
            console.log('固件升级成功');
						window.peripheral[guid].prop.firmware = status.latestFirmware;
						window.peripheral[guid].prop.firmwareNo = status.latestFirmware;
						//firmware
						refreshDeviceUi(device_name,'firmware',status.latestFirmware);
						refreshDeviceUi(device_name,'success');
            resolve(true);
          }
        }else{
          //不需要OTA升级
					window.peripheral[guid].prop.firmware = status.latestFirmware;
					window.peripheral[guid].prop.firmwareNo = status.latestFirmware;
					//firmware
					refreshDeviceUi(device_name,'firmware',status.latestFirmware);
					refreshDeviceUi(device_name,'success');
          resolve(true);
        }
      }catch(error){
				
        // reject(error);
      }
		})
	}
	const startBatchOta = async(list)=>{
		for(let i in list){
			let guid = list[i].device;
			if(!guid){
				refreshDeviceUi(list[i].device_name,'error','Device not found.');
				continue;
			}
			await check_device_firmware_version_and_update(guid,list[i].device_name);
		}
	}
	const refreshDeviceUi = (device_name,type='sync',error_log='')=>{
		if(type == 'sync'){
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').text('sync');
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').addClass('rotate-animation');
		}else if(type == 'error'){
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').text('error');
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.error-log').html(`${_(erp.get_log_description(error_log))}`);
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
		}else if(type == 'success'){
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').text('check');
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').addClass('text-color-green');
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
		}else if(type == 'firmware'){
			$(`.manufacturing-steps[deviceName="${device_name}"]`).find('.firmware-version').text(`(${error_log})`);
		}
	}
	const startCheckDevice = async(list)=>{

		const connectAndCheckWifi = () => {
			return new Promise(async (resolve, reject) => {
					while (true) {
							let wifiInfo = await showPromptDialog(_('Please enter the wifi information'));
							
							if (wifiInfo) {
									let ssid = wifiInfo.username;
									let password = wifiInfo.password;
									wifiInfoMap.ssid = ssid;
									wifiInfoMap.password = password;
									
									let confirmWifiInfo = await showUpdateConfirm(
											`Please confirm your ssid is (${ssid}) and the password is (${password}).`
									);
									
									if (confirmWifiInfo) {
											resolve(1);  // 用户确认，正确解析
											return;      // 退出循环和函数
									}
									// 用户不确认则继续循环
							} else {
									let cancelWifiStatus = await showUpdateConfirm(
											_('Are you sure you want to cancel the Wi-Fi connection and discard the firmware upgrade?')
									);
									
									if (cancelWifiStatus) {
											reject(0);  // 用户确认取消，拒绝Promise
											return;     // 退出循环和函数
									}
									// 用户不取消则继续循环
							}
					}
			});
		}

		/*
		1.check the device setting
	  1.1 chcek the wifi is connected
		1.2 if rcu check the model list
		1.3 check the input and output status
		2.check the device scene
		*/
		for(let i in list){
			let guid = list[i].device;
			if(!guid){
				list[i].device_status = 'Connect Error';
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('error');
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(`${_(erp.get_log_description(6300))}`);
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
				continue;
			}
			let settings = initSettingList(guid);
			console.log("settings",settings);
			let sceneList = await initSceneList(guid);
			console.log("sceneList",sceneList);
			$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('sync');
			$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('rotate-animation');
			//check settings
			let toast = app.toast.create({
					text: _('Checking ')+_(`${list[i].titleList[0]}`),
					position: 'center',
					closeTimeout: 2000,
				});
			toast.open();
			await new Promise(resolve => setTimeout(resolve, 2000));
			//check the device
			try{
				app.dialog.preloader(_('Connecting to the device'));
				await peripheral[guid].connect();
				app.dialog.close();
			}catch(error){
				app.dialog.close();
				console.log("connect error",error);
				list[i].device_status = 'Connect Error';
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('error');
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(`${_(erp.get_log_description(error))}`);
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
				continue;
			}
			let bleList = [];
			let progress = 0;
			let sceneProgress = 0;
			let dialog = null;
			if(settings.length > 0){
				dialog = await initDeterminedProgress(progress,'Checking Device Settings');
			}
			for(let i in settings){
				try{
					await peripheral[guid].write([{
						service: 'ff80',
						characteristic: 'ff81',
						data: settings[i].command.toLocaleLowerCase(),
					}]);
					progress++;
					let progressValue = parseInt(progress/settings.length*100);
					dialog.setProgress(progressValue);
					dialog.setText('Checking ' + (progress) + ' of ' + settings.length);
					if(progressValue == 100){
						dialog.close();
					}
				}catch(error){
					console.log("error",error);
					dialog.close();
				}
			}
			//check the device firmare
			// try{
			// 	let firmwareInfo = await checkDeviceFirmware(guid);
			// }catch(errorMap){
			// 	console.log("error",errorMap);
			// 	list[i].firmware_status = _(erp.get_log_description(errorMap.error));
			// 	$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('error');
			// 	$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
			// 	$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(`${_(errorMap.error)}`);
			// 	$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
			// 	//continue;
			// 	app.dialog.close();
			// 	let shouldUpdate = await showUpdateConfirm(_('The device firmware is not the latest version, do you want to update the firmware?'));
			// 	if (!shouldUpdate) continue;
			// 	try{
			// 		await updateFirmware(guid,errorMap.firmware);

			// 	}catch(error){
			// 		console.log("error",error);
			// 		list[i].firmware_status = _(erp.get_log_description(error));
			// 		$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('error');
			// 		$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
			// 		$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(`${_(error)}`);
			// 		$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
			// 		//if wifi is not connected, show the connect wifi dialog
			// 		if(error.includes('Wi-Fi not connected.')){
			// 			try{
			// 				let checkWifiStatus = await connectAndCheckWifi();
			// 			}catch(checkWifiStatusError){
			// 				continue;
			// 			}
			// 			debugger
			// 			let wifiConnectStatus = await connectWifi(wifiInfoMap.ssid,wifiInfoMap.password,guid);
			// 				if(wifiConnectStatus){
			// 					try{
			// 						await updateFirmware(guid,errorMap.firmware);
			// 					}catch(wifiUpdateError){
			// 						console.log("wifiUpdateError",wifiUpdateError);
			// 						app.dialog.alert(_(wifiUpdateError));
			// 						continue;
			// 					}
			// 				}
			// 		}else{
			// 			let confirmStatus = await showUpdateConfirm(_(error));
			// 		}
			// 	}
			// }
			let sceneCommandList = [];
			app.dialog.preloader(_('Checking Scene'));
			try{
				sceneCommandList = await getDeviceNotificationForEngineerMode(guid);

			}catch(error){
				sceneCommandList = [];
				list[i].scene_status = _(erp.get_log_description(error));
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('error');
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(erp.get_log_description(error));
				$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
				app.dialog.close();
				continue;
			}
			//checking the scene 
			if(sceneList.length > 0){
				dialog = await initDeterminedProgress(sceneProgress,'Checking Device Scene');
			}
			if(sceneList.length > 0){
				app.dialog.close();
				let errorSceneList = [];
				for(let j in sceneList){
					let item = sceneList[j];
					let scene_device_location = item.scene_device_location || [];
					let templateName = item.scene_template;
					let trigger = JSON.parse(item.trigger);
					let action = JSON.parse(item.action);
					let rcuGuid = getTheSceneRcu(item);
					let deviceMap = {};
					let deviceModel = '';
					let bleList = [];
					try {
						deviceMap = erp.info.device[guid];
						deviceModel = deviceMap.device_model;
					} catch (error) {}
					if (deviceModel == 'YO780') {
						let thisCommandList = await saveActionCommand(item);
						thisCommandList.forEach((item) => {
							bleList.push({
								service: 'ff80',
								characteristic: 'ff81',
								data: item.command,
							});
						});
					} else {
						bleList = bleList.concat(await saveTriggetCommand(item,guid));
					}
					sceneProgress++;
					let progressValue = parseInt(sceneProgress/sceneList.length*100);
					dialog.setProgress(progressValue);
					dialog.setText('Checking ' + (sceneProgress) + ' of ' + sceneList.length);
					if(progressValue == 100){
						dialog.close();
					}
					console.log("bleList",bleList);
					bleList.forEach((item)=>{
						item.checkStatus = true;
						let command = item.data;
						if(sceneCommandList.indexOf(command) == -1){
							errorSceneList.push(item);
							list[i].scene_status = 'Scene Error';
							$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('error');
							$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-red');
							$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(`${_('Scene Error')}`);
							$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
							item.checkStatus = false;
						}
					})
				}
				let checkSceneStatus = true;
				console.log("errorSceneList",errorSceneList)
				if(errorSceneList.length){
					let shouldUpdate = await showUpdateConfirm(_('The scene is not set correctly, do you want to fix the scene?'));
					if(!shouldUpdate){
						try{
							await window.peripheral[guid].disconnect();
						}catch(disconnectError){
							console.log("disconnectError",disconnectError);
						}
						continue;
					}
					app.dialog.preloader(_('Fixing Scene...'));
					for(let k in errorSceneList){
						let kitem = errorSceneList[k];
						try{
							await peripheral[guid].write([{
								service: 'ff80',
								characteristic: 'ff81',
								data: kitem.data,
							}]);
						}catch(error){
							console.log("error",error);
							app.dialog.close();
							app.dialog.alert(_(erp.get_log_description(error)));
							checkSceneStatus = false;
						}
					}
					if(checkSceneStatus){
						list[i].scene_status = '';
						app.dialog.close();
					}
				}
			}
			try{
				await window.peripheral[guid].disconnect();
				app.dialog.close();
				if(!list[i].scene_status){
					$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').html(`${_('Check Success')}`);
					$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.error-log').addClass('text-color-green');
					$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').text('check');
					$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').addClass('text-color-green');
					$(`.manufacturing-steps[deviceName="${list[i].device_name}"]`).find('.item-after').find('.icon').removeClass('rotate-animation');
				}
			}catch(error){
				app.dialog.close();
				console.log("error",error);
			}
			console.log("sceneCommandList",sceneCommandList);
		}

	}
	const initDeterminedProgress = (progress,title)=>{
		return new Promise(async(resolve,reject)=>{
			let dialog = app.dialog.progress(title,progress);
			resolve(dialog);
		})
	}
	const initSettingList = (guid)=>{
		let settings = [];
		try {
      settings = erp.info.device[guid] ? erp.info.device[guid].settings : [];
    } catch (error) {
      settings = [];
    }
		let thisList = [];
		settings.forEach((item) => {
      let list = iot_ble_device_setting_type_init(item.setting_type, item.setting, guid, guid);
      thisList = thisList.concat(list);
    });
		console.log('settings', thisList);
    return thisList;
	}
	const initSceneList = async(guid)=>{
		let sceneList = [];
    let scenes = cloneDeep(erp.info.scene);
    for (let scene in scenes) {
      let scene_item = scenes[scene];
      scene_item.writeStatus = false;
      let scene_device_location = scene_item.scene_device_location || [];
      let scene_location_map = scene_device_location.find((item) => item.device == guid);
      if (scene_location_map) {
        sceneList.push(scenes[scene]);
      }
    }
    console.log('sceneList', sceneList);
    // let sceneBleList = await replaceRcuSceneDeviceCommand(sceneList,guid);
    // console.log('sceneBleList', sceneBleList);
    return sceneList;
	}
	const replaceRcuSceneDeviceCommand = (sceneList,guid) => {
    return new Promise(async (resolve, reject) => {
      let scenes = cloneDeep(erp.info.scene);
      let postScene = [];
      let bleList = [];
      for (let i in sceneList) {
        let item = sceneList[i];
        let scene_device_location = item.scene_device_location || [];
        let templateName = item.scene_template;
        let trigger = JSON.parse(item.trigger);
        let action = JSON.parse(item.action);
        let rcuGuid = getTheSceneRcu(item);
        let deviceMap = {};
        let deviceModel = '';

        try {
          deviceMap = erp.info.device[guid];
          deviceModel = deviceMap.device_model;
        } catch (error) {}
        if (deviceModel == 'YO780') {
          let thisCommandList = await saveActionCommand(item);
          thisCommandList.forEach((item) => {
            bleList.push({
              service: 'ff80',
              characteristic: 'ff81',
              data: item.command,
            });
          });
        } else {
          bleList = bleList.concat(await saveTriggetCommand(item,guid));
        }
      }
      resolve(bleList);
    });
  };
	const saveTriggetCommand = (scenesMap,guid) => {
    return new Promise(async (resolve, reject) => {
      let triggerList = JSON.parse(scenesMap.trigger);
      let actionList = JSON.parse(scenesMap.action);
      let rcuGuid = getTheSceneRcu(scenesMap);
      let bleList = [];
      for (let i in triggerList) {
        if (triggerList[i].guid != guid) {
          continue;
        }
        let triggercommand = triggerList[i].triggercommand;
        let actionCommand = triggerList[i].actionCommand;
        let settingCommandList = triggerList[i].settingCommandList;
        let ledTriggerOn = triggerList[i].ledTriggerOn;
        let ledTriggerOff = triggerList[i].ledTriggerOff;
        let ledActionOn = triggerList[i].ledActionOn;
        let ledActionOff = triggerList[i].ledActionOff;
        let ledRawSettingCommand = triggerList[i].ledRawSettingCommand;
        if (triggercommand) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: triggercommand,
          });
        }
        if (actionCommand) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: actionCommand,
          });
        }
        if (settingCommandList && settingCommandList.length) {
          settingCommandList.forEach((item) => {
            bleList.push({
              service: 'ff80',
              characteristic: 'ff81',
              data: item,
            });
          });
        }
        if (ledTriggerOn) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: ledTriggerOn,
          });
        }
        if (ledTriggerOff) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: ledTriggerOff,
          });
        }
        if (ledActionOn) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: ledActionOn,
          });
        }
        if (ledActionOff) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: ledActionOff,
          });
        }
        if (ledRawSettingCommand) {
          bleList.push({
            service: 'ff80',
            characteristic: 'ff81',
            data: ledRawSettingCommand,
          });
        }
      }
      resolve(bleList);
    });
  };
	const saveActionCommand = (scenesMap) => {
    return new Promise(async (resolve, reject) => {
      let sceneTemplate = scenesMap.scene_template;
      let sceneName = scenesMap.title;
      let scene_device_location = scenesMap.scene_device_location || [];
      let scene_virtual_button = scenesMap.scene_virtual_button || [];
      let actionMap = JSON.parse(scenesMap.action);
      let triggerMap = JSON.parse(scenesMap.trigger);
      let rcuGuid = getTheSceneRcu(scenesMap);
      let commandList = [];
      if (sceneTemplate == 'RCU Radar' || sceneTemplate == 'Welcome Scene') {
        let triggerCommand = triggerMap[0].triggercommand;
        commandList.push({
          guid: rcuGuid,
          command: triggerCommand.toLocaleLowerCase(),
        });
      }
      if (actionMap[rcuGuid]) {
        if (typeof actionMap[rcuGuid] === 'string') {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['actionCommand']) && actionMap[rcuGuid]['actionCommand']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['actionCommand'].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['settingCommand']) && actionMap[rcuGuid]['settingCommand']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['settingCommand'].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['defaultOnCommand']) && actionMap[rcuGuid]['defaultOnCommand']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['defaultOnCommand'].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['defaultOffCommand']) && actionMap[rcuGuid]['defaultOffCommand']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['defaultOffCommand'].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['actionCommand_2']) && actionMap[rcuGuid]['actionCommand_2']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['actionCommand_2'].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['trigger']) && actionMap[rcuGuid]['trigger']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['trigger'].toLocaleLowerCase(),
          });
        }
        if (isset(actionMap[rcuGuid]['trigger_2']) && actionMap[rcuGuid]['trigger_2']) {
          commandList.push({
            guid: rcuGuid,
            command: actionMap[rcuGuid]['trigger_2'].toLocaleLowerCase(),
          });
        }
      }
      resolve(commandList);
    });
  };
	const getTheSceneRcu = (sceneMap) => {
    //select the profile rcu,and return the rcu guid
    let rcuGuid = '';
    let rcuList = [];
    let scene_device_location = sceneMap.scene_device_location || [];
    for (let i in scene_device_location) {
      let guid = scene_device_location[i].device;
      if (isset(erp.info.device[guid])) {
        let device_model = erp.info.device[guid].device_model;
        if (device_model == 'YO780') {
          if (rcuList.indexOf(guid) == -1) {
            rcuList.push(guid);
          }
        }
      }
    }
    //if have two rcu
    if (rcuList.length > 1) {
      rcuList.forEach((item) => {
        let setting = erp.info.device[item].settings;
        setting.forEach((kitem) => {
          if (kitem.setting_type == 'main_rcu' && kitem.setting == '1') {
            rcuGuid = item;
          }
        });
      });
    } else if (rcuList.length == 1) {
      rcuGuid = rcuList[0];
    }
    return rcuGuid;
  };
	const changeEngineerModeStatus = (status)=>{
		engineerModeStatus = status;
		console.log("engineerModeStatus",engineerModeStatus);
		$update();
	}
	//App Developer
	const getRolePermision = ()=>{
		let roleList = erp.info.user.roles || [];
		roleList.forEach(item=>{
			if(item.role == "App Developer" || item.role == "App Developer - Tier 1"){
				leftMenuPermision = true;
				// engineerMode = true;
			}
			if(item.role == "Engineer"){
				engineerMode = true;
			}
		})
	}

	const getProfilePermision = ()=>{
		return new Promise((resolve,reject)=>{
			// let url = `/api/method/appv6.getProfileUserPermision?name=${erp.info.profile.name}`;
			let url = `/api/method/get_user_permission_4_doctype?doctype=Profile&user=${users[users.current].usr}`;
			http2.request(
          encodeURI(url),
          {
            method: 'GET',
            serializer: 'json',
            responseType: 'json',
            timeout: 3,
          }
        ).then(res=>{
					let userList = [];
					let owner = '';
					console.log("res",res);
					if(res.data){
						resolve(res.data.message);
					}
					// if(res.data.permision){
					// 	userList = res.data.permision.shared;
					// 	owner = res.data.permision.owner;
					// 	let selfUser = users[users.current].usr;
					// 	userList.forEach(userItem=>{
					// 		if(userItem.user == selfUser && userItem.write == 1){
					// 			profilePermision = true
					// 		}
					// 	});
					// 	if(owner == selfUser){
					// 		profilePermision = true
					// 	}
					// 	resolve({allow : profilePermision});
					// 	//userList = userList.map((item)=>item.owner)
					// 	console.log("userList",userList);
					// }
				}).catch(error=>{
					reject(error);
				})
		})
	}
	const refreshGateway = ()=>{
		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway().toLowerCase()));
		for (let i in profile_device) {
			if (!profile_device[i].gateway || profile_device[i].gateway.trim() == "") continue;

			const gatewayhash = md5(md5(profile_device[i].gateway.toLowerCase()));
			if (selfgatewayhash == gatewayhash) { // self gateway, need to listen to cmd

				const cmd_topic = `cmd/${gatewayhash}`;
				core_mqtt_subscribe(cmd_topic, 0, false);
				emitter.off(cmd_topic);
				emitter.on(cmd_topic, on_gateway_commands_received);

			} else { // other gateway, need to listen to status and will

				//check if gateway is online / offline
				const will_topic = `will/${gatewayhash}`;
				core_mqtt_subscribe(will_topic, 1, false);
				emitter.off(will_topic,on_gateway_will_changed);
				emitter.on(will_topic, on_gateway_will_changed);

				//get the devices' status from gateway
				const status_topic = `status/${gatewayhash}`;
				core_mqtt_subscribe(status_topic, 1, false);
				emitter.off(status_topic,on_gateway_device_changed);
				emitter.on(status_topic, on_gateway_device_changed);

				//refresh gateway
				setTimeout(() => {
					core_mqtt_publish(`cmd/${gatewayhash}`, {
						"command": "Pubmsg",
						"function": "bleHelper.pubmsg",
						"params": "",
						"callback": "",
						"raw": ""
					}, 0, false, false, false).then(() => {

					}).catch(reject => {});
				}, 3000)
			}
		}
	}
	//ui functions
	const refresh = async (e, done) => {
		await ha_profile_ready();
		// init gateway list
		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway().toLowerCase()));
		for (let i in profile_device) {
			if (!profile_device[i].gateway || profile_device[i].gateway.trim() == "") continue;

			const gatewayhash = md5(md5(profile_device[i].gateway.toLowerCase()));
			if (selfgatewayhash == gatewayhash) { // self gateway, need to listen to cmd

				const cmd_topic = `cmd/${gatewayhash}`;
				core_mqtt_subscribe(cmd_topic, 0, false);
				emitter.off(cmd_topic);
				emitter.on(cmd_topic, on_gateway_commands_received);

			} else { // other gateway, need to listen to status and will

				//check if gateway is online / offline
				const will_topic = `will/${gatewayhash}`;
				core_mqtt_subscribe(will_topic, 1, false);
				emitter.off(will_topic,on_gateway_will_changed);
				emitter.on(will_topic, on_gateway_will_changed);

				//get the devices' status from gateway
				const status_topic = `status/${gatewayhash}`;
				core_mqtt_subscribe(status_topic, 1, false);
				emitter.off(status_topic);
				emitter.on(status_topic, on_gateway_device_changed);

				//refresh gateway
				setTimeout(() => {
					core_mqtt_publish(`cmd/${gatewayhash}`, {
						"command": "Pubmsg",
						"function": "bleHelper.pubmsg",
						"params": "",
						"callback": "",
						"raw": ""
					}, 0, false, false, false).then(() => {

					}).catch(reject => {});
				}, 3000)
			}
		}
		done();
	};
	const update_mesh_device = (p)=>{
		// defined the hexModel
		let model_map = cloneDeep(erp.doctype.device_model);
		let device_model = model_map[p.hexModel.toUpperCase()];
		if(device_model){
			let device_mode = device_model.mode;
			if(device_mode == 'RCU Scene Button'){
				let manufactureData = p.manufactureData;
				if(!manufactureData)return
				let networkSize = parseInt(manufactureData.slice(0,2),16);
				// console.log("networkSize",networkSize)
				if(networkSize){
					$(`.home-scanned-peripheral-smart[guid="${p.guid}"]`).attr("mesh",1);
					$(`.mesh[guid="${p.guid}"]`).text(networkSize);
				}else{
					$(`.home-scanned-peripheral-smart[guid="${p.guid}"]`).attr("mesh",0);
					$(`.mesh[guid="${p.guid}"]`).text('');
				}
			}
		}
	}
	const render_ui = () => {
		show_noroom = !rooms.length ? true : false;
		show_nosubdevice = (rooms.length && !subdevices.length && !Object.keys(peripheral).length) ? true : false;
		refresh_unassigned();

		$update();
	};
	const onDeleted = async (sudevice_item) => {
		$(`.curtain-subdevice[guid="${sudevice_item.guid}"]`).remove();
		$(`.subdevice[guid="${sudevice_item.guid}"]`).remove();
		$(`.iaq-subdevice[guid="${sudevice_item.guid}"]`).remove();
		let this_list = erp.info.profile.profile_subdevice;
		let profile_device = erp.info.profile ? erp.info.profile.profile_device : [];
		//have case:more sudevice mapping 1 profile device
		let count_list = this_list.filter((zitem) => zitem.profile_device === sudevice_item.profile_device);
		let del_record = [];
		let filteredList = this_list.filter(kitem => {
			if (sudevice_item.name == kitem.name) {
				del_record.push(sudevice_item);
				return false;
			}
			return true;
		})
		this_list = filteredList;
		erp.info.profile.profile_subdevice = filteredList;
		if (count_list.length == 1) {
			let profile_device_index = profile_device.findIndex((z) => z.name === sudevice_item.profile_device);
			profile_device.splice(profile_device_index, 1);
		}
		//update the filter of the profile_room_device list
		subdevices.forEach((item, index) => {
			del_record.forEach((kitem, kindex) => {
				if (kitem.name == item.name) {
					subdevices.splice(index, 1);
				}
			})
		})
		//update profile
		try {
			let status = await http.request(encodeURI(`/api/resource/Profile/${erp.info.profile.name}`), {
				method: 'PUT',
				serializer: 'json',
				responseType: 'json',
				data: {
					profile_device: profile_device,
					profile_subdevice: this_list,
				},
			});
		} catch (err) {
			const toast = app.toast.create({
				position: 'bottom',
				closeTimeout: 3000,
				text: err,
			});

			toast.open();
		}
		if(sudevice_item.device_mode == 'RCU Controller' && sudevice_item.device_button_group == 'ONOFF GANG1'){
			unassigned_subdevices = [];
			if(isset(erp.info.device[sudevice_item.device])){
				let lists = erp.info.device[sudevice_item.device].settings;
				lists.forEach(zitem=>{
					if(zitem.setting_type.startsWith("mode_list")){
						zitem.setting = '';
					}
				})
			}
		}
		//init();
		$update();
		mainView.router.refreshPage();
		//check subdevice length is null,delete the profile device
	};
	const refresh_unassigned = () => {
		//console.log("unassigned_subdevices",unassigned_subdevices)
		let _unassigned_subdevices = JSON.parse(JSON.stringify(unassigned_subdevices));
		for (let guid in peripheral) {
			let p = peripheral[guid].getProp();
			// if(p.guid && p.guid.includes(":")){
			// 	continue;
			// }
			if(guid == '37306238663638356464643212021b1d'){
				//debugger;
			}
			if (p.disappear || !p.rssi) { // hide subdevice in unassigned
				for (let i in _unassigned_subdevices) {
					if (_unassigned_subdevices[i].device != guid) continue;
					unassigned_subdevices[i].disappear = true;
				}
				continue;
			}
			//check the local rssi
			let local_rssi = erp.info.device_gateway ? erp.info.device_gateway.rssi_filter : -60;
			if (p.rssi < local_rssi) {
				continue;
			}
			// reshow subdevice in unassigned
			for (let i in _unassigned_subdevices) {
				if (_unassigned_subdevices[i].device != guid) continue;
				unassigned_subdevices[i].disappear = false;
			}
			//init the modelist
			let modeList = [];
			//check if device setting config
			let show_door_bell = true;
			let show_clean_dnd = true;
			if(isset(erp.info.device[guid])){
				let thisDeviceMap = cloneDeep(erp.info.device[guid]);
				let settings = thisDeviceMap.settings;
				let rcuSettings = [];
				let device_mode = thisDeviceMap.device_mode;
				let device_model = thisDeviceMap.device_model;
				settings.forEach(zitem=>{
					if(zitem.setting_type.startsWith('active_io')){
						let inputStatus = zitem.setting == 'input'?true:false;
						let status = zitem.setting == 'output'?true:false;
						if(inputStatus || status){
							rcuSettings.push({
								name: zitem.setting_type.replace("active_io_",""),
								inputStatus : inputStatus,
								status : status,
								device_mode : device_mode,
								device_model : device_model
							})
						}
					};
					if(zitem.setting_type.startsWith('mode_list')){
						modeList = zitem.setting.split(",");
					}
					if(zitem.setting_type.startsWith('clean_dnd')){
						show_clean_dnd = zitem.setting == 1?true:false;
					}
					if(zitem.setting_type.startsWith('door_bell')){
						show_door_bell = zitem.setting == 1?true:false;
					}
				});
				rcuSettings.forEach(kitem=>{
					let title = `RCU INPUT${kitem.name}`;
					let this_button_group = `RCU INPUT${kitem.name}`;
					//filter the gang of 33 32 31
					if(kitem.name == 33 || kitem.name == 32 || kitem.name == 31){
						return;
					}
					if(kitem.status){
						title = `RCU OUTPUT${kitem.name}`;
						this_button_group = `RCU OUTPUT${kitem.name}`
					}
					const u_subdevice = {
						lastDiscoverDate: p.lastDiscoverDate,
						rssilv: p.rssilv || 0,
						bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
						connected: p.connected,
						connecting: p.connecting,
						device: p.guid,
						device_button_group: this_button_group,
						device_mode: kitem.device_mode,
						device_model: kitem.device_model,
						device_name: p.name,
						name: title, //name is means device model and sort
						password: p.password,
						thumb: erp.doctype.device_model['0346'].image,
						device_status: 0,
						device_config: '',
						device_attachment_status: ''
					};
					let cont = false;
					for (let u_subdevice of _unassigned_subdevices) {
						if (u_subdevice.device != guid) continue;
						if (u_subdevice.device_button_group == this_button_group) {
							cont = true;
							break;
						}
					}
					for (let subdevice of subdevices) {
						if (subdevice.device != guid) continue;
						if (subdevice.device_button_group == this_button_group) {
							cont = true;
							break;
						}
					}
					if (cont) return;
					unassigned_subdevices.push(u_subdevice);
				})
			}
			//if have setting config,init the rcu device
			if(modeList.length){
				//1 on off 2 dimming 3 Curtain Switch 4 0-10v Dimming 5 1-10v Dimming
				let device_default_template_list = [];//this list use in rcu
				modeList.forEach((modeItem,modelIndex)=>{
					if(modeItem == 1){
							for(let i =1;i<=4;i++){
								device_default_template_list.push({
									device_button_group: `RCU ONOFF GANG${4*modelIndex+i}`,
									image : erp.doctype.device_model[p.hexModel].image,
									title : `YO780-4G ${modelIndex+1}-${i}`,
									mode : 'On Off Switch'
								})
							}
						}else if(modeItem == 2){
							for(let i=1;i<=2;i++){
								device_default_template_list.push({
									device_button_group: `RCU DIMMING${2*modelIndex+i}`,
									image : erp.doctype.device_model[p.hexModel].image,
									title : `YO780-2GD ${modelIndex+1}-${i}`,
									mode : `${modeItem == 2?'Triac Dimming':modeItem == 4?'0-10v Dimming':modeItem == 5?'1-10v Dimming':'Triac Dimming'}`
								})
							}
						}else if( modeItem == 4 || modeItem == 5){
							for(let i=1;i<=2;i++){
								device_default_template_list.push({
									device_button_group: `RCU DIMMING${2*modelIndex+i}`,
									image : erp.doctype.device_model[p.hexModel].image,
									title : `YO780-2GV ${modelIndex+1}-${i}`,
									mode : `${modeItem == 2?'Triac Dimming':modeItem == 4?'0-10v Dimming':modeItem == 5?'1-10v Dimming':'Triac Dimming'}`
								})
							}
						}else if(modeItem == 3){
							device_default_template_list.push({
									device_button_group: `RCU OPENCLOSE GANG${4*modelIndex+1}_${4*modelIndex+2}`,
									image : erp.doctype.device_model[p.hexModel].image,
									title : `YO780-2GK ${modelIndex+1} 1_2`,
									mode : `Curtain Switch`
								});
								device_default_template_list.push({
									device_button_group: `RCU OPENCLOSE GANG${4*modelIndex+3}${4*modelIndex+4}`,
									image : erp.doctype.device_model[p.hexModel].image,
									title : `YO780-2GK ${modelIndex+1} 3_4`,
									mode : `Curtain Switch`
								})
						}
				})
				if(show_door_bell){
					device_default_template_list.push({
						device_button_group: `RCU OUTPUT33`,
						image : erp.doctype.device_model[p.hexModel].image,
						title : `RCU OUTPUT33`,
						mode : `RCU Controller`
					})
				}
				if(show_clean_dnd){
					device_default_template_list.push({
						device_button_group: `DOOR SIGN`,
						image : erp.doctype.device_model[p.hexModel].image,
						title : `DOOR SIGN`,
						mode : `RCU Controller`
					})
				}
				let device_default_template_list_fliter = [];
				//console.log("device_default_template_list",device_default_template_list)
				device_default_template_list.forEach(defalutItem=>{
					//should fliter the subdevice in room
					let addStatus = true;
					for (let subdevice of subdevices) {
						if (subdevice.device != guid) continue;
						if(subdevice.device_button_group == defalutItem.device_button_group){
							addStatus = false;
						}
					}
					//if uncat have been create this device,should not display
					for (let u_subdevice of _unassigned_subdevices) {
						if (u_subdevice.device != guid) continue;
						if (u_subdevice.device_button_group == defalutItem.device_button_group) {
							//debugger
							addStatus = false;
						}
					}
						if(addStatus){
							const u_subdevice = {
							lastDiscoverDate: p.lastDiscoverDate,
							rssilv: p.rssilv || 0,
							bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
							connected: p.connected,
							connecting: p.connecting,
							device: p.guid,
							device_button_group: defalutItem.device_button_group,
							device_mode: defalutItem.mode,
							device_model: erp.doctype.device_model[p.hexModel].name,
							device_name: p.name,
							name: defalutItem.title, //name is means device model and sort
							password: p.password,
							thumb: defalutItem.image,
							device_status: peripheral[guid].getGangStatus(defalutItem.device_button_group),
							device_config: peripheral[guid].getGangConfig(defalutItem.device_button_group),
							device_attachment_status: peripheral[guid].getAttachmentStatus(defalutItem.device_button_group).join(',')
						};

						unassigned_subdevices.push(u_subdevice);
					}
				})
				//console.log("device_default_template_list_fliter",device_default_template_list_fliter);
				// device_default_template_list_fliter.forEach(fliteItem=>{
				// 	const u_subdevice = {
				// 		lastDiscoverDate: p.lastDiscoverDate,
				// 		rssilv: p.rssilv || 0,
				// 		bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
				// 		connected: p.connected,
				// 		connecting: p.connecting,
				// 		device: p.guid,
				// 		device_button_group: fliteItem.device_button_group,
				// 		device_mode: fliteItem.mode,
				// 		device_model: erp.doctype.device_model[p.hexModel].name,
				// 		device_name: p.name,
				// 		name: fliteItem.title, //name is means device model and sort
				// 		password: p.password,
				// 		thumb: fliteItem.image,
				// 		device_status: peripheral[guid].getGangStatus(fliteItem.device_button_group),
				// 		device_config: peripheral[guid].getGangConfig(fliteItem.device_button_group),
				// 		device_attachment_status: peripheral[guid].getAttachmentStatus(fliteItem.device_button_group).join(',')
				// 	};

				// 	//unassigned_subdevices.push(u_subdevice);
				// })
			}
			//console.log("modeList",modeList);
			//bg000
				//console.log(p.hexModel.toUpperCase())
				if(p.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[p.hexModel]){
					//show the bg000 message
					//alert(p.hexModel.toUpperCase())
					//console.log(p.id);
					let cont = false;
					for (let u_subdevice of _unassigned_subdevices) {
						if (u_subdevice.id != peripheral[guid].prop.id) continue;
						if (u_subdevice.id == peripheral[guid].prop.id) {
							//console.log(u_subdevice.id)
							cont = true;
							break;
						}
					}
					if (cont) continue;
					const u_subdevice = {
						lastDiscoverDate: p.lastDiscoverDate,
						id : p.id,
						rssilv: p.rssilv || 0,
						bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
						connected: p.connected,
						connecting: p.connecting,
						device: p.guid,
						device_button_group: '',
						device_mode: '',
						device_model: !erp.doctype.device_model[p.hexModel]?'BG000':erp.doctype.device_model[p.hexModel].name,
						device_name: p.name?(p.name.split("-").length>1?p.name.split("-")[1]:p.name.substring(0,12)):p.id.replace(/:/g, ''),
						name: 'BG000', //name is means device model and sort
						password: p.password,
						thumb: !erp.doctype.device_model[p.hexModel]?'https://my.yoswit.com/files/products/YO2086-1G.svg':erp.doctype.device_model[p.hexModel].image,
						device_status: 0,
						device_config: '',
						device_attachment_status: ''
					};

					unassigned_subdevices.push(u_subdevice);
				}
			if (erp.doctype.device_model[p.hexModel]) {
				
				for (let tp of erp.doctype.device_model[p.hexModel]['device_default_template']) {
					if (!tp.display_in_unassigned) continue;
					if(modeList.length) continue;
					//if 
					if(p.hexModel == '0346'){ 

					}else{
						if ((p.device_mode && p.device_mode != tp.mode) || !p.device_mode && tp.mode != erp.doctype.device_model[p.hexModel].mode) continue;
					}
					

					
					let cont = false;
					for (let subdevice of subdevices) {
						if (subdevice.device != guid) continue;
						if (subdevice.device_button_group == tp.device_button_group || subdevice.device_button_group == `${tp.device_button_group} REVERSE`) {
							cont = true;
							break;
						}
						if(tp.device_button_group.startsWith("RCU DIMMING")){
							let config = Math.ceil(parseInt(tp.device_button_group.replace("RCU DIMMING",""))/2);
							//console.log("config",config);
							if(parseInt(subdevice.config) == config && subdevice.device == guid && !subdevice.device_button_group.startsWith("RCU DIMMING")){
								//console.log("subdevice",subdevice)
								cont = true;
								break;
							}
						}
					}
					if (cont) continue;

					for (let u_subdevice of _unassigned_subdevices) {
						if (u_subdevice.device != guid) continue;
						if (u_subdevice.device_button_group == tp.device_button_group || u_subdevice.device_button_group == `${tp.device_button_group} REVERSE`) {
							cont = true;
							break;
						}
					}
					
					if (cont) continue;
					let this_gang = 1;
					if(tp.device_button_group.startsWith("ONOFF GANG")){
						this_gang = tp.device_button_group.replace("ONOFF GANG","");
					}else if(tp.device_button_group.startsWith("GV DIMMING")){
						this_gang = tp.device_button_group.replace("GV DIMMING","");
					}else if(tp.device_button_group.startsWith("IR Setup")){
						this_gang = "IR Setup";
					}else if(tp.device_button_group.startsWith("OPENCLOSE GANG")){
						this_gang = tp.device_button_group.replace("OPENCLOSE GANG","");
					}else if(tp.device_button_group.startsWith("Thermostat")){
						this_gang = "";
					}
					let title = `${erp.doctype.device_model[p.hexModel].name} ${this_gang}`;
					if(tp.device_button_group.startsWith("IR Setup")){
						title = `${this_gang}`;
					}
					if(tp.device_button_group.startsWith("RCU DIMMING")){
						let rcu_gang = tp.device_button_group.replace("RCU DIMMING","");
						let display_name = '';
						if(rcu_gang == 1){
							display_name = `YO780-2GD 1-1`;
						}else if(rcu_gang == 2){
							display_name = `YO780-2GD 1-2`;
						}else if(rcu_gang == 3){
							display_name = `YO780-2GD 2-1`;
						}else if(rcu_gang == 4){
							display_name = `YO780-2GD 2-2`;
						}else if(rcu_gang == 5){
							display_name = `YO780-2GD 3-1`;
						}else if(rcu_gang == 6){
							display_name = `YO780-2GD 3-2`;
						}else if(rcu_gang == 7){
							display_name = `YO780-2GD 4-1`;
						}else if(rcu_gang == 8){
							display_name = `YO780-2GD 4-2`;
						}else if(rcu_gang == 9){
							display_name = `YO780-2GD 5-1`;
						}else if(rcu_gang == 10){
							display_name = `YO780-2GD 5-2`;
						}
						title = display_name
					}
					if(tp.device_button_group.startsWith("RCU OUTPUT") || tp.device_button_group.startsWith("DOOR SIGN")){
						//should check if set unshow in device setting
						//console.log("erp.info.device[guid]",erp.info.device[guid]);
						if(isset(erp.info.device[guid])){
							let settings = erp.info.device[guid].settings;
							let doorBellStatus = true;
							let cleanDnd = true;
							settings.forEach(zitem=>{
								if(zitem.setting_type.startsWith('door_bell')){
								console.log("door_bell",zitem.setting)
									if(zitem.setting == 0){
										doorBellStatus = false;
									}
								}
								if(zitem.setting_type.startsWith('clean_dnd')){
									if(zitem.setting == 0){
										cleanDnd = false;
									}
								}
							})
							if(!doorBellStatus && tp.device_button_group.startsWith("RCU OUTPUT")){
								continue;
							}
							if(!cleanDnd && tp.device_button_group.startsWith("DOOR SIGN")){
								continue;
							}
						}
						title = tp.device_button_group;
					}
					const u_subdevice = {
						lastDiscoverDate: p.lastDiscoverDate,
						rssilv: p.rssilv || 0,
						bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
						connected: p.connected,
						connecting: p.connecting,
						device: p.guid,
						device_button_group: tp.device_button_group,
						device_mode: tp.mode,
						device_model: erp.doctype.device_model[p.hexModel].name,
						device_name: p.name,
						name: title, //name is means device model and sort
						password: p.password,
						thumb: erp.doctype.device_model[p.hexModel].image,
						device_status: peripheral[guid].getGangStatus(tp.device_button_group),
						device_config: peripheral[guid].getGangConfig(tp.device_button_group),
						device_attachment_status: peripheral[guid].getAttachmentStatus(tp.device_button_group).join(',')
					};

					unassigned_subdevices.push(u_subdevice);
				}
			}
		}

		show_unassigned = false;
		for (let i in unassigned_subdevices) {
			if (!unassigned_subdevices[i].disappear) {
				show_unassigned = true;
				break;
			}
		}
	};
	//save favoriteRoom
	const favoriteRoom = async(room_name)=>{
		//this option can save all room device config
		//this will show special device(air、thermostat、dimming、curtain motor so on)
		console.log('subdevices',subdevices);
		//return
		app.dialog.prompt(`${_('Input the title.')}`,(name)=>{
			if(name){

			}else{
				app.dialog.alert(`${_('Title can not be empty. ')}`)
			}
		});
		setTimeout(() => {
			$(`.dialog-input-field input[name="dialog-input"]`).attr('placeholder', _('Title'));
			
		}, 0);
		let postObj = {
			subdevices : subdevices,
			title : '',
			source : erp.info.profile.name,
			date : dayjs().format()
		}
		try{
			await	http2.request(encodeURI('/api/resource/User/' + users[users.current].user_id), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
						interest : JSON.stringify(postObj)
					}
			})
			app.dialog.alert(_('Save Successfully'));
			}catch(error){
				console.log(error);
			}
	}
	const toFavorite = ()=>{
		window.favoriteSubdevices = subdevices;
		mainView.router.navigate(`/mobile-app/favorite-profile-device-list`);
	}
	const applyFavoriteRoom =async()=>{
		//app.dialog.preloader();
		try{
			let resData = await http2.request(encodeURI('/api/resource/User/' + users[users.current].user_id), {
				responseType: "json",
				method: "GET",
			})
			let interest = resData.data.data.interest;
			
			if(interest){
				let interestMap = JSON.parse(interest);
				console.log("interest",interestMap);
				//change the apply record
				let applyForList = [];
				applyForList = cloneDeep(interestMap["applyFor"] || []) ;
				let applyMap = applyForList.find(item=>item.name == erp.info.profile.name);
				if(!applyMap){
					applyForList.push({
						name : erp.info.profile.name,
						title : erp.info.profile.profile_name
					})
				}
				interestMap["applyFor"] = applyForList;
				let favoriteSubdevices = interestMap.subdevices;
				let thisSubdevices = cloneDeep(subdevices);
				//compare the data and tindy the command
				let runCommand = [];
				favoriteSubdevices.forEach(item=>{
					let favortieStatus = item.device_status;
					let thisStatus = thisSubdevices.find(zitem=>tran(zitem.room_name) == tran(item.room_name) && zitem.title == item.title);
					//console.log("thisStatus",thisStatus)
					if(thisStatus){
						runCommand.push({
							room_title : tran(thisStatus.room_name),
							guid : thisStatus.device,
							device_mode : thisStatus.device_mode,
							title : tran(thisStatus.title),
							device_button_group : thisStatus.device_button_group,
							set_status : thisStatus.device_status,
							origin_status : item.device_status,
							config : item.config,
							device_config : item.device_config,
							device_command : item.device_command,
							device_attachment_status : item.device_attachment_status,
							name : thisStatus.name
						})
					}
				})
				console.log("runCommand",runCommand);
				//depend on the device button group and group the command
				let errorList = [];
				for(let i in runCommand){
					//onoff ([{gang: bleHelper.getGangId(kitem.device_button_group),on: true}])
					//rcuOnoff  ([{gang: bleHelper.getGangId(kitem.device_button_group),on: true}])
					//doMusicPlayer  
					//rcuOutput  ([{gang: bleHelper.getGangId(dnd_virtual_button_group),value: props.kitem.dnd}])
					//dimming  ([{gang: bleHelper.getGangId(props.kitem.device_button_group),value: range_value}])
					//rcuDimming  ([{gang: bleHelper.getGangId(props.kitem.device_button_group),value: range_value}])
					//thermostat  ([{gang: bleHelper.getGangId(props.kitem.device_button_group),value: post_value,command : data}])
					//curtainmotor  ([{gang: bleHelper.getGangId(kitem.device_button_group),value: value: props.kitem.device_status,command : command}])
					//sendIR  peripheral[kitem.device].sendIR(ref_command);
					//openClose  peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press)
					//rcuOpenClose  peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, true)
					const toast = app.toast.create({
            position: 'center',
            text: `${_('Update')} ${runCommand[i].title} <br /> ${runCommand[i].room_title}...`,
          });

          toast.open();
					
					try{
						if(runCommand[i].device_button_group.startsWith("ONOFF GANG")){
							if(runCommand[i].device_mode == "Music Player"){
								//if have differ config ,how to fixed?
								await peripheral[runCommand[i].guid].doMusicPlayer([{
									service: 'ff80',
									characteristic: 'ff81',
									command: '9807',
								}]);
							}else{
								await peripheral[runCommand[i].guid].onoff([{
									gang : bleHelper.getGangId(runCommand[i].device_button_group),
									on : runCommand[i].origin_status
								}])
							}
						}else if(runCommand[i].device_button_group.startsWith("RCU ONOFF GANG")){
							await peripheral[runCommand[i].guid].rcuOnoff([{
								gang : bleHelper.getGangId(runCommand[i].device_button_group),
								on : runCommand[i].origin_status
							}])
						}else if(runCommand[i].device_button_group.startsWith("RCU OUTPUT")){
							//dnd and clear
						}else if(runCommand[i].device_button_group.startsWith("DIMMING") || runCommand[i].device_button_group.startsWith("RCU DIMMING")){
							await peripheral[runCommand[i].guid].dimming([{
								gang: bleHelper.getGangId(runCommand[i].device_button_group),
								value: runCommand[i].origin_status
							}])
						}else if(runCommand[i].device_button_group.startsWith("Thermostat")){
							let commandList = tindyThermostatCommand(runCommand[i].device_attachment_status);
							//debugger
							for(let j in commandList){
								await peripheral[runCommand[i].guid].thermostat([{
									gang: commandList[j].gang,
									value: commandList[j].status,
									command : commandList[j].command
								}])
							}
						}else if(runCommand[i].device_button_group.startsWith("OPENCLOSE UART") || runCommand[i].device_button_group.startsWith("OPENCLOSE WIFI UART")){
							let command = tindyCurtainMotor(runCommand[i].guid,runCommand[i].device_button_group,runCommand[i].origin_status)
							await peripheral[runCommand[i].guid].curtainmotor([{
								gang: bleHelper.getGangId(runCommand[i].device_button_group),
								value: runCommand[i].origin_status,
								command: command
							}])
						}else if(runCommand[i].device_button_group.startsWith("OPENCLOSE GANG") || runCommand[i].device_button_group_type.startsWith("RCU OPENCLOSE GANG")){
							//this case can not find the device record,can not send the last command
							// if (runCommand[i].device_button_group.startsWith('RCU OPENCLOSE GANG')){
							// 	peripheral[runCommand[i].guid].rcuOpenClose(bleHelper.getGangId(runCommand[i].device_button_group), direction, true)
							// }else{

							// }
						}
						toast.close();
						disconnectDeviceInRoom();
					}catch(error){
						toast.close();
						errorList.push({
							title : tran(runCommand[i].title),
							error : _(erp.get_log_description(error))
						});
					}
				}
				console.log("errorList",errorList);
				await	http2.request(encodeURI('/api/resource/User/' + users[users.current].user_id), {
						serializer: "json",
						responseType: "json",
						method: "PUT",
						data: {
							interest : JSON.stringify(interestMap)
						}
				});
				app.dialog.close();
				app.dialog.alert(_('Apply Successfully'))
			}
		}catch(error){
			console.log("error",error);
		}
	}
	const disconnectDeviceInRoom = async()=>{
		//if connection more than 6 devices,connect will be failed
		let deviceList = cloneDeep(subdevices);
		for(let i in deviceList){
			//check if connect use the ble,should disconnect this device
			let connectStatus = peripheral[deviceList[i].device].prop.connected;
			try{
				if(connectStatus){
					peripheral[deviceList[i].device].disconnect();
				}
			}catch(error){
				console.log(error);
			}
		}
	}
	const solveBleCountLimit = ()=>{
		//if connection more than 6 devices,connect will be failed
		//if connection more than 6 devices,disconnect the other devices
		return new Promise(async(resolve,reject)=>{
			let connectCount = 0;
			let devices = cloneDeep(window.peripheral);
			for(let guid in devices){
				let connectStatus = devices[guid].prop.connected;
				if(connectStatus){
					connectCount++
				}
			};
			//check connect num
			if(connectCount > 5){
				//disconnect the devices
				for(let guid in devices){
					let connectStatus = devices[guid].prop.connected;
					if(connectStatus){
						await peripheral[guid].disconnect();
					}
				};
				resolve(1);
			}else{
				resolve(1);
			}
		})
	}
	const tindyAirCommand = (device_config,device_command,guid,name)=>{
		let configStr = kitem.device_config;
		let this_config = configStr.split("|");
		let airconfig = isset(this_config[2]) && this_config[2] != ',,,,NaN' ? this_config[2].split(',') : '25,1,2,1,0,1'.split(',');
		let onoffRef = configStr.substring(14,15);
		configStr =`${configStr.substring(0,14)}${onoffRef}${configStr.substring(15,configStr.length)}`;
		peripheral[guid].setLocalGangConfig(name, configStr);
		let command = device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,"ARC_ON_OFF",configStr.substring(5,configStr.length));
		return ref_command
	}
	const tindyCurtainMotor = (guid,device_button_group,thisvalue)=>{
		let hexid = peripheral[guid].prop.hexModel;
		let device_model = erp.doctype.device_model[hexid].name;
		let otherModelStatus = false;
		let data = '';
		let reverse = device_button_group.startsWith('OPENCLOSE UART REVERSE') || device_button_group.startsWith('OPENCLOSE WIFI UART REVERSE') ? true : false;
		if(device_model == 'YO121-AC-R2W'){
			otherModelStatus = true;
		}
		if (reverse) {
			data = `55AA060102${(100-thisvalue).toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${(100-thisvalue*1).toString(16).pad("00")}`;
			}
		} else {
			data = `55AA060102${thisvalue.toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${thisvalue.toString(16).pad("00")}`;
			}
		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		return `8602${data.toLowerCase()}`
	}
	const tindyThermostatCommand = (config)=>{
		let list = [];
		if(isset(config) && config){
			let value_list = config.split(',');
			let mode_value = value_list[1];
			let speed_vaule = value_list[2]; //thermostat speed
			let temperature = parseInt(value_list[3]); //temperature
			let room_temperature = value_list[4];
			let this_gang = 42;
			let post_value = ``;
			if(temperature < 5){
				temperature = 26
			}
			list.push({
				gang : 42,
				status : 1,
				command : `940300000101`,
			});
			list.push({
				gang : 43,
				status : mode_value,
				command : `9404000001${parseInt(mode_value).toString(16).pad("00")}`,
			});
			list.push({
				gang : 44,
				status : speed_vaule,
				command : `9405000001${parseInt(speed_vaule).toString(16).pad("00")}`,
			});
			list.push({
				gang : 45,
				status : temperature,
				command : `9406000001${parseInt(temperature).toString(16).pad("00")}`,
			});
		}
		return list
	}
	const collapse_room = (index) => {
		const id = `room-${index}-div-title`;
		const room_id = `room-${index}-div`;
		let icon_name = $(`#${id}`).find('i').text();
		if (icon_name == 'expand_more') {
			$(`#${room_id} .room-item`).hide();
			$(`#${id}`).find('i').text('chevron_right');
		} else {
			$(`#${room_id} .room-item`).show();
			$(`#${id}`).find('i').text('expand_more');
		}
	};

	const show_room = (index, count) => {
		let item_id = `room-bar-title-${index}`;
		let id = `room-${index}-div`;
		$('.tab-link').removeClass('tab-link-active');
		$(`#${item_id}`).addClass('tab-link-active');
		if (index == 0) {
			$('.room-null').addClass('device-none');
			$('.media-list').show();
		} else {
			$('.media-list').hide();
			$(`#${id}`).show();
			$(`#${id} .room-item .home-scanned-peripheral-smart`).each(function(el){
				$(el).removeClass('device-none');
			})
			if (count == 0) {
				$('.room-null').addClass('device-none');
				let html = `
						<div class="block room-null" style="text-align: center">
						<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
						<p>${_('You don\'t have any devices, create one.')}</p>
						</div>
						<div class="block block-strong room-null">
						<p class="row">
							<a class="col button button-large" href="/mobile-app/yoswit-device-type"
							>${ _('Create Device') }</a
							>
						</p>
						</div>
					`;
				$(`#${id}`).html(html);
			} else {
				$('.room-null').addClass('device-none');
			}
		}
	};
	// const clickRoomScene = (item)=>{
	// 	console.log("item",item);
	// 	app.dialog.preloader();
	// 	let devices = JSON.parse(item.action);
	// 	let errorList = [];
	// 	let clearTime = setTimeout(()=>{
	// 			app.dialog.close();
	// 			//app.dialog.alert(`${_('Execution Successfully')}`);
	// 		},3*1000)
	// 	for(let i in devices){
	// 		try{
	// 			let ref = devices[i].ref;
	// 			let guid = devices[i].device;
	// 			let button_group = devices[i].device_button_group;
	// 			let gang = bleHelper.getGangId(button_group);
	// 			if(button_group.startsWith("ONOFF GANG")){
	// 					peripheral[guid].onoff([{
	// 						gang : gang,
	// 						on : ref
	// 					}])
	// 				}else if(button_group.startsWith("RCU ONOFF GANG")){
	// 					peripheral[guid].rcuOnoff([{
	// 						gang : gang,
	// 						on : ref
	// 					}])
	// 				}else if(button_group.startsWith("DIMMING") || button_group.startsWith("RCU DIMMING")){
	// 					peripheral[guid].dimming([{
	// 							gang: gang,
	// 							value: ref
	// 						}])
	// 				}else if(button_group.startsWith("Thermostat")){
	// 					//"0,0,0,26,26,0"   onoff,mode_value,speed_vaule,temperature,room_temperature,hum
	// 					let device_attachment_status = `${devices[i].ref},${devices[i].modeStr},${devices[i].speedVaule},${devices[i].temperature},${devices[i].temperature},0`;
	// 					let commandList = tindyThermostatCommand(device_attachment_status);
	// 					console.log("commandList",commandList);
	// 					if(ref){
	// 						for(let j in commandList){
	// 							peripheral[guid].thermostat([{
	// 								gang: commandList[j].gang,
	// 								value: commandList[j].status,
	// 								command : commandList[j].command
	// 							}])
	// 						}
	// 					}else{
	// 						peripheral[guid].thermostat([{
	// 							gang: 42,
	// 							value: 0,
	// 							command : `940300000100`
	// 						}])
	// 					}
	// 				}else if(button_group.startsWith("OPENCLOSE UART REVERSE")){
	// 					let command = tindyCurtainMotor(guid,button_group,parseInt(100-ref));
	// 					peripheral[guid].curtainmotor([{
	// 							gang: gang,
	// 							value: ref,
	// 							command: command
	// 						}])
	// 				}else if(button_group.startsWith("OPENCLOSE UART")){
	// 					let command = tindyCurtainMotor(guid,button_group,ref);
	// 					peripheral[guid].curtainmotor([{
	// 							gang: gang,
	// 							value: ref,
	// 							command: command
	// 						}])
	// 				}else if(button_group.startsWith("OPENCLOSE GANG") || button_group.startsWith.startsWith("RCU OPENCLOSE GANG")){
	// 					//get the run time 
	// 					let deviceSettings = cloneDeep(erp.info.device[guid].settings);
	// 					let runTime = 10;
	// 					deviceSettings.forEach(settingItem=>{
	// 						if(settingItem.setting_type.includes("Delay Lastfor")){
	// 							let settingButtonGroup = settingItem.setting_type.split("|");
	// 							if(settingButtonGroup == button_group){
	// 								let objMap = JSON.parse(settingItem.setting);
	// 								runTime = parseInt(objMap["Run for (s)"]);
	// 							}
	// 						}
	// 					});
	// 					let direction = 'close';
	// 					if(ref){
	// 						direction = 'open';
	// 					}
	// 					peripheral[guid].openClose(gang, direction, true)
	// 				}
	// 		}catch(error){
	// 			app.dialog.alert(_(erp.get_log_description(error)));
	// 		}
	// 	}
	// }
	const changeRangeBarUi = (guid, device_button_group, present_value) => {
		$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`)
			.find('.range-bar-active')
			.css({
				width: present_value + '%',
			});
		$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`)
			.find('.range-knob-wrap')
			.css({
				left: present_value + '%',
			});
		if (present_value > 1) {
			$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`).removeClass('range-slider-min');
		} else {
			$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`).addClass('range-slider-min');
		}
	}
	//bluetooth functions
	const on_peripheral_changed = (p) => {
		if(p.guid == '3334383531383763323636321203461d'){
		}
		if(change_timers){
			clearTimeout(change_timers);
		}
		setTimeout(() => {
			//console.log('excute comming')
			for (let i in subdevices) {
				if (subdevices[i].device == p.guid) {
					update_subdevice_by_peripheral(subdevices[i], p);
				}
			}
			for (let i in unassigned_subdevices) {
				if (unassigned_subdevices[i].device == p.guid) {
					update_subdevice_by_peripheral(unassigned_subdevices[i], p);
				}
			}

			render_ui();
		}, 10);
	};
	emitter.off('on_peripheral_changed',on_peripheral_changed);
	emitter.on('on_peripheral_changed', on_peripheral_changed);

	const on_discovery = (p) => {
		if(p.id == '48:CA:43:98:81:FE'){
			//console.log(p)
		}
		setTimeout(() => {
			delete p.password;
			delete p.connected;
			delete p.connecting;
			scanned_periperals[p.id] = p;
			if (!isset(peripheral[p.guid]) && p.guid) {
				peripheral[p.guid] = new Peripheral(p);
			}else if(!p.guid){
				if(!isset(peripheral[p.id])){
					peripheral[p.id] = new Peripheral(p);
				}else{
					peripheral[p.id].update(p);
				}
			} else {
				peripheral[p.guid].update(p);
			}
			// if (!isset(peripheral[p.guid])) {
			// 	peripheral[p.guid] = new Peripheral(p);
			// }else {
			// 	peripheral[p.guid].update(p);
			// }
			//update the mesh device
			//update_mesh_device(p);
			render_ui();
		}, 10);
	};

	const scan = async () => {
		await bleManager.stopScan();
		await bleManager.wait(200);

        console.log("start scan")
		bleManager.scan(on_discovery, async (error) => {
		    //alert(error);
				//app.dialog.alert(_(erp.get_log_description(error)));
				$('.signal-view-main').each(function(element){
					$(this).attr('signal',0);
				})
				//mainView.router.refreshPage();
// 			await bleManager.wait(5000);
// 			scan();
		});
	};

	// helper function
	const update_subdevice_by_peripheral = async(s, p) => {
		let device_status = p.guid ? peripheral[p.guid].getGangStatus(s.device_button_group) : 0;
		let device_config = p.guid ? peripheral[p.guid].getGangConfig(s.name) : 'ir|0|25,1,2,1,0,1'; //ir|0|25,1,2,1,0,1
		
		if(p.guid == '6163346431363439306464371201431c'){
			//debugger
			//alert(`device_status:${device_status}`)
			console.log('device_status',device_status);
		}
		// if(p.guid == '39383037326434386233303312020c1d'){
		// 	console.log(peripheral[p.guid])
		// 	console.log('device_status',device_status);
		// }

		s['device_config'] = device_config;
		if(p.guid == '3334383531383763323636321203461d'){
			console.log("peripheral[p.guid].prop.rssilv",peripheral[p.guid].prop.rssilv)
			//debugger
		}
		s['rssilv'] = isset(peripheral[p.guid])?peripheral[p.guid].prop.rssilv:0;
		s['mn_head_set'] = p.mn_head_set || 0;
		s['mn_head_connected'] = p.mn_head_connected || 0;
		s['mn_tail_set'] = p.mn_tail_set || 0;
		s['mn_tail_connected'] = p.mn_tail_connected || 0;
		s['bluetooth'] = p.connected ? 1 : (p.connecting ? 2 : 0);
		s['mobmob'] = p.is_mobmob;
		s['is_mobile_gateway'] = p.is_mobile_gateway;
		s['connecting'] = p.connecting;
		s['connected'] = p.connected;
		s['device_attachment_status'] = `0,0,0,26,26,0`;
		s['bluetooth_count'] = p.bluetooth_count;
		s['mn_size'] = p.mnSize || 0;
		if(!s['click_status']){
			s['device_status'] = device_status;
		}
		s['device_virtual_status'] = isset(s['device_virtual_status'])?s['device_virtual_status']:0
		//battery_ref
		s['battery'] = p.guid ? peripheral[p.guid].getLatestStatus()[0][83]:0;
		s['dc_status'] = p.guid ? peripheral[p.guid].getLatestStatus()[0][84]:0;
		//console.log('dc_status',s['dc_status'])
		//if mutiway,should get the mapping status
		
		//s['device_status'] = device_status;
		let hexModel = p.hexModel;
		if (hexModel == '021B' || hexModel == '0363' || hexModel == '0375') {
			//thermostat
			//if clicking
			if(s['click_status']){
				//return
				s['device_attachment_status'] = peripheral[p.guid].getAttachmentStatus(s.device_button_group,true).join(',');
				console.log("s['device_attachment_status']",s['device_attachment_status'])
			}else{
				s['device_attachment_status'] = peripheral[p.guid].getAttachmentStatus(s.device_button_group).join(',');
			}
			//s['device_attachment_status'] = peripheral[p.guid].getAttachmentStatus(s.device_button_group).join(',');
			//let list = peripheral[p.guid].getAttachmentStatus(s.device_button_group);
			if (isset(erp.trigger_thermostat_defined_fun) && isset(erp.trigger_thermostat_defined_fun[p.guid])) {
				erp.trigger_thermostat_defined_fun[p.guid](s);
			}
		} else if (s.device_button_group.startsWith("DIMMING") || s.device_button_group.startsWith("RCU DIMMING")) {
			//dimming
			let range_key =  `${s.device}_${s.device_button_group}`;
			if(isset(range_silder_list[range_key])){
    			const v = Math.ceil((device_status*1.0 / 255.0) * 100.0) || 0;
					// console.log("subdevice",s.title);
					// console.log("peripheral[p.guid]",peripheral[p.guid].prop.status)
					// console.log("v",v)
            	if($(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`).length){
									$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`)
                		.find('.range-bar-active')
                		.css({
                			width: v + '%',
                		});
                	$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`)
                		.find('.range-knob-wrap')
                		.css({
                			left: v + '%',
                		});
                	if (v > 1) {
                		$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`).removeClass('range-slider-min');
                	} else {
                		$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`).addClass('range-slider-min');
                	}
                }
			}
		}else if(s.device_button_group.startsWith("OPENCLOSE UART") || s.device_button_group.startsWith("OPENCLOSE WIFI UART")){
			//debugger
			if(!s['click_status']){
				//revert
				if(s.device_button_group.startsWith("OPENCLOSE UART REVERSE") || s.device_button_group.startsWith("OPENCLOSE WIFI UART REVERSE")){
					if(device_status > 100){
						device_status = 0;
					}else{
						device_status = peripheral[p.guid].prop.status.control[0][48];
					}
					//s.device_status = device_status;
				}
				let key = `${p.guid}_${s.device_button_group}`;
				if(isset(range_silder_list[key])){
					s['click_button'] = true;
					range_silder_list[key].setValue(device_status);
					s['click_button'] = null;
				}
			}
			if(device_status > 100){
					device_status = 0;
			}
			// console.log("s['click_status']",s['click_status']);
			// console.log("device_status",device_status)
			//openclose uart
			
			// setTimeout(()=>{
			// 	changeRangeBarUi(p.guid, s.device_button_group, device_status);
			// },200)
		}else if(s.device_button_group.startsWith("4in1 Sensor")){
			//4in1 sensor
			//console.log("device_status",device_status);
			//console.log("p.guid",p.guid);
			if (device_status > 0) {
          //have people;
					setTimeout(()=>{
						$("li.device[guid='" + p.guid + "'] .rf-sensor i").html('directions_walk');
					},500)
					console.log($("li.device[guid='" + p.guid + "'] .rf-sensor i"));
        } else {
          //$("li.device[guid='" + p.guid + "'] .rf-sensor i").text('block');
        }
		}else if(s.device_button_group.startsWith("RCU INPUT")){
			//gateway input
			let gang = bleHelper.getGangId(s.device_button_group)*1;
			let gangs = peripheral[p.guid].prop.status.mobmob[0];
			// console.log("gangs",gangs)
			// console.log("RCU INPUT",gangs[gang]);
			s['input'] = gangs[gang];
		}else if(s.device_button_group.startsWith("DOOR SIGN")){
			//this must be check the 81(clear) and 82(dnd)
			let gangs = peripheral[p.guid].prop.status.control;
			//console.log("gangs",gangs)
			let clear = gangs[0][80];
			let dnd = gangs[0][81];
			s['dnd'] = dnd;
			s['clear'] = clear;
			// console.log("clear",clear);
			// console.log("dnd",dnd);
		}else if(s.device_mode == "Multiway Switch"){
			let config = s.config?JSON.parse(s.config):{};
			if(isset(config.mapping)){
				let subs = cloneDeep(erp.info.profile.profile_subdevice);
				subs.forEach(zitem=>{
					if(zitem.name == config.mapping){
						let this_device_button_group = zitem.device_button_group;
						let this_device_status = peripheral[zitem.device].getGangStatus(this_device_button_group);
						let thatConfig = zitem.config?JSON.parse(zitem.config):{}
						//compare the this_device_status
						console.log("device_status",device_status);
						console.log("this_device_status",this_device_status);
						let light_ref = '';
						if(device_status == this_device_status){
							light_ref = 0;
						}else if(device_status != this_device_status){
							light_ref = 1;
						}
						if(isset(thatConfig.be_pairing)){
							//zitem['light_ref'] = light_ref;
							$(`.home-scanned-peripheral[subdevice_name="${zitem.name}"]`).find(".on_flag").attr("ref",light_ref)
						}
						if(isset(thatConfig.is_pairing)){
							s["light_ref"] = light_ref;
						}
						//console.log("light_ref",s["light_ref"])
					}
				})
			}
		}
	};
	const update_subdevice_by_device = (s, p) => {};
	const update_subdevice_by_profile_device = (s, p) => {
		s['password'] = p.password;
		s['device_model'] = p.device_model;
		s['device_name'] = p.device_name.substring(0,12);
		s['network_id'] = p.network_id;
		s['network_position'] = p.network_position;
		//if have no guid,warning
		if(!s['device']){
			s['guid_status'] = false;
		}else{
			s['guid_status'] = true;
			s['scene_status'] = true;
		}
		
	};
	const update_subdevice_by_device_model = (s, p) => {
		s['thumb'] = p.image;
		s['device_mode'] = s.device_mode ? s.device_mode : p.device_mode;
	};
	const update_subdevice_by_subdevice_function = (s,config)=>{
		if(!isset(config))return;
		try{
			let configMap = JSON.parse(config);
			if(configMap['device_type']){
				s['device_button_group_type'] = configMap['device_type'];
			}
		}catch(error){
			console.log(error);
		}
	}
	const update_subdevice_by_device_button_group = (s, p) => {
		if(!isset(p)) return
		s['device_button_group_type'] = p?p.device_type:'';
		s['device_button_group_list'] = p?p.button_group_list:'';
		s['device_button_group_sub_list'] = p.button_group_sub_list;
		s['device_command'] = p.device_command;
	};


	const update_peripheral_by_subdevice = (s, p) => {
		s['gangs'] = [0, 0, 0, 0, 0, 0, 0, 0];
		if(isset(p.device) && p.device!=""){
    		s['guid'] = p.device;
    		s['hexModel'] = p.device.slice(-6, -2).toUpperCase();
    		s['hexBatch'] = p.device.slice(-2).toUpperCase();
    		s['device_mode'] = p.device_mode || 'Unknown';
		}
	};
	const update_peripheral_by_device = (s, p) => {
		s['device_mode'] = s['device_mode'] == 'Unknown' ? p.device_mode : s['device_mode'];
		s['mac_address'] = p.mac_address;
		s['firmware'] = p.firmware;
	};
	const update_peripheral_by_profile_device = (s, p) => {
		s['name'] = p.device_name;
		s['password'] = p.password;
		s['gateway'] = p.gateway;
		s['default_connect'] = p.default_connect;
		s['network_id'] = p.network_id;
		s['network_position'] = p.network_position;
	};

	// mqtt callback
	const on_gateway_will_changed = (data) => {
		console.log(data);
		let is_mobmob = 1;
		let is_mobile_gateway = 0;
		if (data.message.includes("Offline")) {
			is_mobmob = 0;
		}

		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway().toLowerCase()));
		for (let guid in peripheral) {
			let p = peripheral[guid].getProp();
			if (!p.gateway) {
				peripheral[guid].update({
					'is_mobmob': 0
				});
				continue;
			}
			if (p.gateway.trim() == "") {
				peripheral[guid].update({
					'is_mobmob': 0
				});
				continue;
			}
			let checkhash = '';
			//console.log('p.gateway.split',p.gateway.split('-').length)
			if(p.gateway.split('-').length <= 2 || (p.gateway.includes(erp.info.profile.name))){
				checkhash = `will/${md5(md5(p.gateway.toLowerCase()))}`
			}else{
				checkhash = `will/${md5(md5(p.gateway))}`;
				if(checkhash == data.topic){
					//debugger
					is_mobile_gateway = 1;
				}
			}
			//console.log('checkhash',checkhash)
			if (`will/${selfgatewayhash}` == checkhash) {
				
				peripheral[guid].update({
					'is_mobmob': 0,
				});
				continue;
			}

			if (checkhash != data.topic) continue;
			peripheral[guid].update({
				'is_mobmob': is_mobmob,
				'is_mobile_gateway' : is_mobile_gateway
			});
		}
	};

	const on_gateway_device_changed = (data) => {
		let message = data.message;
		console.log("message",JSON.parse(message))
		
		if (isset(message) && message) {
			let deviceObj = JSON.parse(message);
			let deviceInfo = deviceObj.Info;
			deviceInfo.retain = data.retain;
			let guid = deviceInfo.Guid;
			if (isset(guid) && guid) {
				let deviceItem = window.peripheral[guid].prop;
				let manufacturing_data = deviceInfo.manufacturing_data || deviceInfo.ctrl_data;
				if(isset(deviceObj.Thermostat)){
					if((deviceItem.rssi >= 0 || !isset(deviceItem.rssi)) && (isset(data.retain) && !data.retain)){
						//have no ble 
						let thermostat = deviceObj.Thermostat;
						window.peripheral[guid].prop.status.mobmob[0][42] = thermostat.power;
						window.peripheral[guid].prop.status.mobmob[0][43] = thermostat.mode;
						window.peripheral[guid].prop.status.mobmob[0][44] = thermostat.fan;
						window.peripheral[guid].prop.status.mobmob[0][45] = thermostat.set_temp;
						window.peripheral[guid].prop.status.mobmob[0][46] = thermostat.temp;
						window.peripheral[guid].prop.status.mobmob[0][47] = thermostat.rh;
						window.peripheral[guid].prop.status.mobmob[1] = DateFormatter.format((new Date(new Date().getTime())), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");		
						window.peripheral[guid].onPropChanged();
					}
				}
				if(isset(deviceObj.Sensor)){
					let sensor = deviceObj.Sensor;
					if(isset(peripheral[guid])){
						// peripheral[guid].onChangeGateway(deviceInfo)
						const iaqData = deviceObj.Sensor;
						let list = [];
						const Temperature = parseInt(iaqData.temp?iaqData.temp:iaqData.temperature?iaqData.temperature:26);
						const Humidity = parseInt(iaqData.rh?iaqData:iaqData.humidity?iaqData.humidity:0);
            const VOC =iaqData.voc?iaqData.voc:iaqData.VOC?iaqData.VOC:0;
            const CO2 = iaqData.eco2?iaqData.eco2:iaqData["CO2"]?iaqData["CO2"]:0;
            //const h2 = iaqData.h2;
            //const etoh = iaqData.etoh;
            const NOISE = (iaqData.db?iaqData.db:iaqData.noise?iaqData.noise:0).toFixed(1);
            const LUX = parseInt(iaqData.lux);
            const PM1 = iaqData.pm1.toFixed(1);
            const PM2_5 = iaqData['pm2.5'].toFixed(1);
            const PM4 = iaqData['pm4'].toFixed(1);
            const PM10 = iaqData['pm10'].toFixed(1);
            const PRESSURE = iaqData['pressure']?(iaqData['pressure']/1000).toFixed(1):'--';
            const HCHO = isset(iaqData['HCHO'])?iaqData['HCHO'].toFixed(1):'--';
            const O3 = isset(iaqData['O3'])?iaqData['O3'].toFixed(1):'--';
            const CO = isset(iaqData['CO'])?iaqData['CO'].toFixed(1):'--';
            const NOX = isset(iaqData['NOx'])?iaqData['NOx'].toFixed(1):'--';
            const score = iaqData['score'];
						list.push({type:"Temperature",value:Temperature},//
            {type:"Humidity",value:Humidity},//
            {type:"VOC",value:VOC},//
            {type:"CO2",value:CO2},//
            {type:"NOISE",value:NOISE},//
            {type:"LUX",value:LUX},//
            {type:"PM1",value:PM1},//
            {type:"PM2_5",value:PM2_5},
            {type:"PM4",value:PM4},
            {type:"PM10",value:PM10},
            {type:"NOX",value:NOX},
            {type:"PRESSURE",value:PRESSURE},
            {type:"HCHO",value:HCHO},
            {type:"O3",value:O3},
            {type:"CO",value:CO}
            )
						let score_data = window.iaq_evaluate_rule('score',score);
						$("li.device[guid='"+guid+"']").find(".iaq-button-score").css({'background-color':score_data.bgcolor})
            $("li.device[guid='"+guid+"']").find(".score").text(score);
            $("li.iaq-subdevice[guid='"+guid+"']").find(`.score`).hide();
            $("li.device[guid='"+guid+"']").find(".score-desc").text(score_data.levelname);
            for(let i in list){
                const this_data = iaq_evaluate_rule(list[i].type,list[i].value);
                if(isset(this_data)){
                    $("li.iaq-subdevice[guid='"+guid+"']").find(`.${list[i].type} .box-btn-img`).css({'background-color':this_data.bgcolor})
                }
                $("li.iaq-subdevice[guid='"+guid+"']").find(`.${list[i].type} .iaq-title-big`).text(list[i].value)
            }
            $("li.iaq-subdevice[guid='"+guid+"'] .main-btn").forEach((ele)=>{
                let this_value = $(ele).find(".iaq-title-big").text();
                if(this_value == '--'){
                    $(ele).hide()
                }
                if(this_value != '--'){
                    $(ele).show()
                }
            });
						setTimeout(()=>{
                let topic_self = `${deviceItem.gateway}`;
            core_mqtt_publish("cmd/"+md5(md5(topic_self.toLowerCase())), {
                "command":"Pubmsg",
                "function":"bleHelper.pubmsg",
                "params":"",
                "callback":"",
                "raw":""
            }, 0, false, false, false).then(() => {
                
            }).catch(reject=>{});
            },1000*60)
					}
				}
				if (isset(manufacturing_data) && manufacturing_data) {
					let hexModel = deviceItem.hexModel;
					if(hexModel == '0361' || hexModel == '0351'){
						//curtain motor
						//debugger
						if(isset(peripheral[guid])){
							peripheral[guid].onChangeGateway(deviceInfo)
						}
					}else if(hexModel == '0348'){
						//music player
						let commandData = manufacturing_data.substring(2,4);
						const decimal = parseInt(commandData, 16);
						let binary = decimal.toString(2);
						while (binary.length < 8) {
								binary = '0' + binary;
						}
						let iconStr = 'phone_iphone';
						if(binary[0] == 1){
							//tv
							iconStr = 'tv';
						}else{
							//phone
							iconStr = 'phone_iphone';
						}
						subdevices.forEach(zitem=>{
							if(zitem.device == guid){
								zitem.config = iconStr;
							}
						})
						$update();
					}else if (hexModel == '0346') {
						//RCU
						//return
						//check the num of connect
						if(deviceObj.Device){
							let deviceList = Object.keys(deviceObj.Device);
							if(deviceList.length > 0){
								//change the UI
								setTimeout(()=>{
									//console.log($(".home-scanned-peripheral[guid='"+guid+"'][button_group='ONOFF GANG1']").find(".signal-panel .signal-view-main"))
									$(".home-scanned-peripheral[guid='"+guid+"'][button_group='ONOFF GANG1']").find(".signal-panel .signal-view-main").attr('mesh',1);
									$(".home-scanned-peripheral[guid='"+guid+"'][button_group='ONOFF GANG1']").find(".signal-panel .signal-view-main .mesh").text(deviceList.length+1);
								},500)
							}else{
								setTimeout(()=>{
									$(".home-scanned-peripheral[guid='"+guid+"'][button_group='ONOFF GANG1']").find(".signal-panel .signal-view-main").attr('mesh',0);
									$(".home-scanned-peripheral[guid='"+guid+"'][button_group='ONOFF GANG1']").find(".signal-panel .signal-view-main .mesh").text('');
								},500)
							}
						}
						//update the virtual status
						//"97000101000201000302bfbf040200000502000011030400000000120401801305080010000000000000"
						//"97000101000201000302ffff0402000005020000110304000000001204018013051002006000000000000000000000000000"
						let virtualDataList = manufacturing_data.split("130510");
						let rcuStatus = virtualDataList[1];
						let statusByteList = splitBytesAndConvertToBinaryArray(rcuStatus);
						$(`.home-scanned-peripheral[guid="${guid}"][button_group="SCENE MUTIWAY ONOFF GANG1"]`).each(function(item){
							
							let config = $(this).attr("config")*1;
							$(this).find(".rcu-virtual-button").attr("ref",statusByteList[config-1]);
						})
						//randar
						let inputDataList = manufacturing_data.split("110304");
						let inputStatus = inputDataList[1].substring(0,8);
						//console.log("inputDataList",inputDataList)
						//console.log("inputStatus",inputStatus);
						let inputStatusByteList = splitBytesAndConvertToBinaryArray(inputStatus);
						//console.log("inputStatusByteList",inputStatusByteList);
						// $(`.home-scanned-peripheral[button_group="4in1 Sensor"]`).each(function(item){
						// 	let config = $(this).attr("config")*1;
						// 	let guid = $(this).attr("guid");
						// 	console.log("config",config);
						// 	//signal status,no ble 
						// 	if(!isset(window.peripheral[guid])) return false;
						// 	let thisDeviceMap = window.peripheral[guid].prop;
						// 	if((thisDeviceMap.rssi >= 0 || !isset(thisDeviceMap.rssi)) && (isset(data.retain) && !data.retain)){
						// 		window.peripheral[guid].prop.status.mobmob[0][49] = inputStatusByteList[config-1]>0?1:0;
						// 		window.peripheral[guid].prop.status.mobmob[1] = DateFormatter.format((new Date(new Date().getTime())), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");		
						// 		window.peripheral[guid].onPropChanged();
						// 	}
						// })
						//input status 
						if((isset(data.retain) && !data.retain)){
							//console.log("inputStatusByteList",inputStatusByteList)
							inputStatusByteList.forEach((item,index)=>{
								let this_status = item>0?1:0;
								window.peripheral[guid].prop.status.mobmob[0][50+index] = this_status;
							})
							window.peripheral[guid].prop.status.mobmob[1] = deviceInfo.date;
							window.peripheral[guid].onPropChanged();
						}
						// $(`.home-scanned-peripheral[guid="${guid}"][is-input="1"]`).each(function(item){
						// 	let button_group = $(this).attr("button_group");
						// 	let config = $(this).attr("button_group").replace("RCU INPUT","")*1;
						// 	let guid = $(this).attr("guid");
						// 	//signal status,no ble 
						// 	if(!isset(window.peripheral[guid])) return false;
						// 	let thisDeviceMap = window.peripheral[guid].prop;
						// 	//RCU cancel the ble scan

						// 	if((isset(data.retain) && !data.retain)){
						// 		let this_status = inputStatusByteList[config-1]>0?1:0;
						// 		if(this_status > 0){
						// 			//console.log($(this).find(".rcu-output i"))
						// 			$(this).find(".rcu-output i").text('cable');
						// 		}else{
						// 			$(this).find(".rcu-output i").text('block');
						// 		}
						// 		// console.log("inputStatusByteList",inputStatusByteList);
						// 		// window.peripheral[guid].prop.status.mobmob[0][50+config-1] = inputStatusByteList[config-1]>0?1:0;
						// 		// window.peripheral[guid].prop.status.mobmob[1] = DateFormatter.format((new Date(new Date().getTime())), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");		
						// 		// window.peripheral[guid].onPropChanged();
						// 	}
						// })
						let rcuDataList = tindyRcuData(manufacturing_data);
						
						//overflow the status
						const indexMap = {
								'01': [32, 33],
								'02': [34, 35],
								'03': [36, 37],
								'04': [38, 39],
								'05': [40, 41]
						};
						const indexOnoffMap = {
								'01': [12, 13,14,15],
								'02': [16,17,18,19],
								'03': [20,21,22,23],
								'04': [24,25,26,27],
								'05': [28,29,30,31]
						};
						rcuDataList.forEach(item=>{
							if (item.type === '02' && item.index in indexMap) {
									const [firstIndex, secondIndex] = indexMap[item.index];
									deviceItem.status['mobmob'][0][firstIndex] = parseInt(item.data.substring(0, 2), 16);
									deviceItem.status['mobmob'][0][secondIndex] = parseInt(item.data.substring(2, 4), 16);
							}
							if(item.type === '01' && item.index in indexMap){
								let this_ref = parseInt(item.data, 16).toString(2).pad("0000");
								//debugger
								const [firstIndex, secondIndex,thirdIndex,flourIndex] = indexOnoffMap[item.index];
								deviceItem.status['mobmob'][0][firstIndex] = this_ref[3];
								deviceItem.status['mobmob'][0][secondIndex] = this_ref[2];
								deviceItem.status['mobmob'][0][thirdIndex] = this_ref[1];
								deviceItem.status['mobmob'][0][flourIndex] = this_ref[0];
							}
						})
						// console.log("rcuDataList",rcuDataList)
						deviceItem.status['mobmob'][1] = deviceInfo.date;
						//if this gateway status date > contorl status date,overflow
						if(deviceItem.status['mobmob'][1] >= deviceItem.status['control'][1]){
							
							deviceItem.status['control'][0] = deviceItem.status['mobmob'][0];
							// deviceItem.status['control'][1] = deviceInfo.date;
							//update the last value
							for (let i = 0; i < deviceItem.status.last[0].length; i++) {
									if (deviceItem.status['mobmob'][0][i] > 0) {
										deviceItem.status.last[0][i] = deviceItem.status['mobmob'][0][i];
									}
							}
							
						//change ui
						rcuDataList.forEach(item => {
							subdevices.forEach(kitem => {
								let button_group = kitem.device_button_group;
								let slot_index = kitem.config;
								if (button_group.startsWith("RCU DIMMING") && item.type == '02' && item.index == slot_index && kitem.device == guid) {
									let this_gang = parseInt(button_group.replace("RCU DIMMING", ""));
									let dimming_gang = this_gang - (2 * (parseInt(slot_index) - 1));
									let this_ref = ``;
									this_ref = dimming_gang == 1 ? parseInt(item.data.substring(0, 2), 16) : parseInt(item.data.substring(2, 4), 16);
									let gangs = window.bleHelper.getGangId(button_group) * 1;
									// deviceItem.status['mobmob'][0][gangs] = this_ref;
									// //deviceItem.status['control'][0][gangs] = this_ref;
									// deviceItem.status['mobmob'][1] = deviceInfo.date;
									
									let device_status = window.peripheral[guid].getGangStatus(button_group);
									kitem.device_status = device_status;
									//console.log("device_status-----------------------------------------",device_status)
									
									$update();
									// if($(`.home-scanned-peripheral[guid="${guid}"][button_group="${button_group}"]`).length){
									// 	$(`.home-scanned-peripheral[guid="${guid}"][button_group="${button_group}"]`).find(".on_flag").attr("ref",device_status>0?1:0)
									// }
									let range_key = `${kitem.device}_${kitem.device_button_group}`;
									if(isset(range_silder_list[range_key])){
										deviceItem.click_button = true; 
										range_silder_list[range_key].setValue(device_status);
										deviceItem.click_button = null;
									}
									// if($(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`).length){
									// 	const v = Math.ceil((device_status*1.0 / 255.0) * 100.0) || 0;
									// 	$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`)
									// 	.find('.range-bar-active')
                	// 	.css({
                	// 		width: v + '%',
                	// 	});
									// 	$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`)
									// 	.find('.range-knob-wrap')
                	// 	.css({
                	// 		left: v + '%',
                	// 	});
									// 	if(v>0){
									// 		$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`).removeClass('range-slider-min');
									// 	}else{
									// 		$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`).addClass('range-slider-min');
									// 	}
									// }
									//changeRangeBarUi(guid, button_group, device_status);
									//emitter.emit('on_peripheral_changed', deviceItem);
								}else if(button_group.startsWith("RCU ONOFF GANG") && item.device == guid && item.type == '01' && item.index == slot_index){
									// let this_gang = parseInt(button_group.replace("RCU ONOFF GANG", ""));
									// let this_ref = ``;
									// let class_gang = bleHelper.getGangId(kitem.device_button_group);

									// this_ref =  parseInt(item.data, 16).toString(2).pad("00");
								}
							})
						});
						}
					}
				}
				//gateways device
				if(isset(deviceObj.Device)){
					let mobmobDevices = deviceObj.Device;
					for(let thisGuid in mobmobDevices){
						if(isset(peripheral[thisGuid])){
							//get the default connect
							let profile_devices = cloneDeep(erp.info.profile.profile_device);
							profile_devices.forEach((item)=>{
								if(item.device == thisGuid){
									mobmobDevices[thisGuid].default_connect = item.default_connect
								}
							})
							let deviceItme = peripheral[thisGuid].prop;
							let manufacturing_data = deviceItme.manufacturing_data;
							//if no manufacturing data,do not change the gateway
							if(!isset(mobmobDevices[thisGuid].manufacturing_data) || !mobmobDevices[thisGuid].manufacturing_data){
								//change the gatewat status
								for (let i in subdevices) { 
									if (subdevices[i].device == thisGuid && subdevices[i].device_mode != "RCU Controller") {
										//can not connect
										//subdevices[i].mobmob = 2;
									}
								}
							}
							//if old curtain motor,don't change the gateway
							if(mobmobDevices[thisGuid].hexModel == '0179'){
								continue;
							}
							peripheral[thisGuid].onChangeGateway(mobmobDevices[thisGuid])
						}
					}
				}
			}
		}
	};

	const on_gateway_commands_received = (data) => {
		let message = JSON.parse(data.message);
		if (message.data.command != 'Control') {
			return;
		}
		if (message.data.function != 'bleHelper.perform') {
			return;
		}
		// [{"action":"write","guid":"61343334663137396232663312015a10","mac_address":"a4:34:f1:79:b3:9d","service_id":"ff80","char_id":"ff81","value":"029db379f134a480001100"}]
		debugger
		let guidToWrite = {};
		for (let param of message.data.params) {
			if (param.action == 'write') {
				if (!isset(guidToWrite[param.guid])) {
					guidToWrite[param.guid] = [];
				}
				guidToWrite[param.guid].push({
					service: param.service_id,
					characteristic: param.char_id,
					data: param.value,
				})
			}
		}
		for (let guid in guidToWrite) {
			if (!isset(peripheral[guid])) continue;
			peripheral[guid].write(guidToWrite[guid]);
		}
	};
	const checkGatewayDeviceConnectStatus = (guid,manufacturing_data,devices_list)=>{
		//devices_list is the list of devices in the gateway
		//manufacturing_data is the manufacturing data of the gateway
		//return a obj like {headConnected,tailConnected,headSet,tailSet,isOnline}
	}
	const splitBytesAndConvertToBinaryArray = (character)=>{
		let bytes = character.match(/.{1,2}/g);
		let binaryArray = bytes.map(byte => {
        let binaryByte = (parseInt(byte, 16) >>> 0).toString(2).padStart(8, '0');
        return binaryByte.split('').map(Number);
    }).flat();
		return binaryArray;
	}
	const tindyRcuData = (str) => {
		let result = [];
		let i = 4;
		while (i < str.length) {
			let index = str.substring(i, i + 2);
			let type = str.substring(i + 2, i + 4);
			let dataLength = type === '01' ? 2 : type === '02' ? 4 : 0;
			let data = str.substring(i + 4, i + 4 + dataLength);

			result.push({
				index,
				type,
				data
			});

			if (index === '05') break;

			i += 4 + dataLength;
		}
		return result;
	}




	//events
	$on("pageAfterIn",()=>{
		//debugger
		//console.log(range_silder_list)
		for(let i in range_silder_list){
			//console.log(range_silder_list[i].getValue())
		}
		if(isset(window.globalUpdate)){
			mainView.router.refreshPage();
			window.globalUpdate = null;
		}
		//should open the scan 
		scan();
		//check if the wifi device is compelte
		window.iot_check_profile_device('rcu').then((is_check)=>{
			//check if scene all have been write the rcu device
			if(is_check && erp.info.profile.location != '1 write' && erp.info.profile.location != ''){
				//find the rcu device
				let rcu_device = erp.info.profile.profile_device.find((item)=>{
					return (item.device_mode == 'RCU Controller' || item.device_model == 'YO780') && item.device;
				});
				if(rcu_device){
					//find the device
					let rcu_sub_device = subdevices.find((item)=>{
						return item.profile_device == rcu_device.name;
					})	
					if(rcu_sub_device){
						//close all the dialog
						while (true) {
							try {
								const dialog = app.dialog.close();
								if (!dialog) {
									break;
								}
							} catch (e) {
								break;
							}
						}
						//find the device
						app.dialog.confirm(_('RCU-related devices are ready. Would you like to update the RCU?'),()=>{
							let url = `/mobile-app/device-replace-page?guid=${rcu_sub_device.device}&title=${_('Update')} ${encodeURIComponent(_('RCU Control Unit'))}&name=${rcu_sub_device.name}&filter_value=${filter_value}&update_scene=true`;
							mainView.router.navigate(url);
						})
					}
				}
			}
		})
	}) 
	$onBeforeMount(async() => {
		document.removeEventListener("touchstart", handleUserActivity);
		document.removeEventListener("touchmove", handleUserActivity);
		document.removeEventListener("click", handleUserActivity);
		clearTimeout(idleTimer);
		mobileAsHubStatus = false;
		// let data = await db.get('home_auto_listCssStatus');
		// listCssStatus = isset(data)?data:'List';
		console.log("onBeforeMount")
	});
	$onMounted(async() => {
		console.log("onMounted");
		try{
			getRolePermision();
			let permisionData = await getProfilePermision();
			console.log("permisionData",permisionData);
			if(permisionData['write']){
				profilePermision = true;
				engineerMode = true;
			}
			if(isset(permisionData['import']) && permisionData['import']){
				fixedTop = 60;
				engineerMode = true;
			}
			//console.log("permisionData",permisionData);
		}catch(error){
			console.log("permision_error",error)
		}
		initPage();
		scan();
		smartHomeFun = async(data)=>{
		//mainView.router.refreshPage();
		console.log("refresh");
		$update();
		setTimeout(async() => {
			debugger
			if(isset(data.page) && data.page == 'save_subdevice'){
				await bleManager.stopScan();
				// rooms = [];
				// subdevices = [];
				range_silder_list = {};//init the dimming bar
				updateTime = new Date().getTime();
        setTimeout(()=>{
					mainView.router.refreshPage();
				},50)
      }
			//initPage(2);
			//scan();
		}, 500)
	};
	smartHomeInitFun = async (data)=> {
		await bleManager.stopScan();
		rooms = [];
		subdevices = [];
		unassigned_subdevices = [];
		range_silder_list = {};
		$update();
		setTimeout(()=>{
			initPage();
			scan()
		},500)
	}
	if(smartHomeInitFun){
		emitter.off('refresh/init',smartHomeInitFun);
	}
	if(smartHomeFun){
		emitter.off('refresh',smartHomeFun);
	}
	emitter.on('refresh',smartHomeFun);
	emitter.on('refresh/init',smartHomeInitFun);
		emitter.on('cap:app:resume',()=>{
			let route = mainView.router.currentRoute;
			if(route.path == '/mobile-app/home-auto'){
				app.dialog.preloader();
				let resumeTimer = setTimeout(()=>{
					while (true) {
						try {
							const dialog = app.dialog.close();
							if (!dialog) {
								break;
							}
						} catch (e) {
							break;
						}
					}
				},1000*3)
			}
		})
	});	
	$onBeforeUnmount(() => {
		//emitter.off('on_peripheral_changed');
		console.log("onBeforeUnmount");
		emitter.off('refresh',smartHomeFun);
		emitter.off('refresh/init',smartHomeInitFun);
		emitter.off('cap:app:resume');
		emitter.off('on_peripheral_changed',on_peripheral_changed);
		bleManager.clear();
		clearTimeout(idleTimer);
		bleManager.stopScan();
		mobileAsHubStatus = false;
		//clear the timer
		console.log("erp.peripheral_timer_settimeout",erp.peripheral_timer_settimeout);
		if(erp.peripheral_timer_settimeout.length){
			for(const timeoutId of erp.peripheral_timer_settimeout){
				clearTimeout(timeoutId);
			}
			erp.peripheral_timer_settimeout = [];
		}
		// if(erp.peripheral_timer_settimeout){
		// 	clearTimeout(erp.peripheral_timer_settimeout);
		// }
		//emitter.off("onNetworkChange",networkChangeFun);
	});
	return $render;
};
</script>

<style>
		.device-hidden {
			display: none;
		}
		.battery[battery='5'] i{
			content: 'battery_full';
		}
		.battery[battery='4'] i{
			content: 'battery_6_bar';
		}
		.battery[battery='3'] i{
			content: 'battery_5_bar';
		}
		.battery[battery='2'] i{
			content: 'battery_4_bar';
		}
		.battery[battery='1'] i{
			content: 'battery_2_bar';
		}
		.geomagnetic[ref='1'] .circle{
			background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
			border-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
		}
		.geomagnetic[ref='1'] i::before{
			content: 'directions_car';
			font-size: 20px;
			color: #ffffff;
		}
		.geomagnetic[ref='0'] i::before{
			content: 'logout';
			font-size: 20px;
		}
		.park-lock[ref='1'] .circle{
			background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
			border-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
		}
		.park-lock[ref='1'] i::before{
			content: 'keyboard_capslock';
			font-size: 20px;
			color: #ffffff;
		}
		.park-lock[ref='0'] i::before{
			content: 'power_input';
			font-size: 20px;
		}
		.page-content .button.onoff {
				-webkit-border-radius: 50%;
				-moz-border-radius: 50%;
				border-radius: 50%;
				background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
				color: #ffffff;
				border-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
				width: 65px;
				height: 65px;
				margin-top: 5px;
				margin-bottom: 0px;
				line-height: 65px;
				font-size: 12px;
		}
		.tabbar .tab-link-active,
		.tabbar-labels .tab-link-active {
			background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
			color: #fff;
		}
		.page-content .rcu-output[ref='1']{
			background-color: var(--f7-theme-color);
    	color: #fff;
		}
		.page-content .rcu-output[ref='0']{
			background-color: var(--f7-block-strong-bg-color);
    	color: #8e8d93;
    	border-color: #8e8d93;
		}
		.room-box .device .swipeout-actions-right {
			transform: translateX(200%);
		}
		.room-box .device .swipeout-actions-left {
			transform: translateX(-200%);
		}
		.ir-signal-cooker i,.rcu-virtual-button i{
			display: none;
		}
		.room-box .ir-signal-cooker[ref='0'][mode='On Off IR'],
		.room-box .rcu-virtual-button[ref='0'],
		.room-box .ir-signal-cooker[ref='0'][mode='Multiway Switch'] {
			display: inline-block;
		}
		.room-box .ir-signal-cooker[ref='1'] .radio-button-unchecked,
		.room-box .rcu-virtual-button[ref='1'] .radio-button-unchecked
		{
			display: none;
		}
		.room-box .ir-signal-cooker[ref='0'][mode='On Off IR'] .radio-button-unchecked,
		.room-box .rcu-virtual-button[ref='0'] .radio-button-unchecked,
		.room-box .ir-signal-cooker[ref='0'][mode='Multiway Switch'] .radio-button-unchecked {
			display: inline-block;
		}
		.room-box .ir-signal-cooker[ref='1'] .circles,.room-box .rcu-virtual-button[ref='1'] .circles {
			display: inline-block;
			color: #3bb33b !important;
		}
		.control-panel-right[bluetooth='0'][mobmob='0'] .control-panel-right .iaq-button-score-a {
			display: none;
		}
		.control-panel-right[bluetooth='1'] .control-panel-right .iaq-button-score-a,
		.control-panel-right[mobmob='1'] .control-panel-right .iaq-button-score-a {
			display: inline-block;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='0'] .on_flag,
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='2'] .on_flag,
		.control-panel-right[type-box='Dimming'][bluetooth='2'][mobmob='0'] .on_flag {
			display: none;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='1'] a.iot-connect,
		.control-panel-right[type-box='Dimming'][mesh='1'] a.iot-connect,
		.control-panel-right[type-box='Dimming'][mobmob='1'] a.iot-connect{
			display: none !important;
		}
		.device .control-panel-right[type-box='Dimming'][bluetooth='1'] .on_flag,
		.device .control-panel-right[type-box='Dimming'][mobmob='1'] .on_flag,
		.device .control-panel-right[type-box='Dimming'][mesh='1'] .on_flag
		 {
			display: inline-block;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='0'][mesh='0'] a.iot-connect {
			display: inline-block;
		}
		.control-panel-right[bluetooth='0'][mobmob='0'] .iaq-button-score-a {
			display: none;
		}
		.thermostat-subdevice[ref="0"]{
			display: none !important;
		}
		.thermostat-subdevice[ref="1"][bluetooth="0"][mobmob='0'][mesh='0']{
			display: none !important;
		}
		/*.thermostat-subdevice[bluetooth="0"][mobmob='0'][mesh='0']*/
		/*{*/
		/*	display: none !important;*/
		/*}*/
		.thermostat-subdevice[bluetooth='1'][ref="1"],
		.thermostat-subdevice[mobmob='1'][ref="1"],
		.thermostat-subdevice[mesh='1'][ref="1"]
		{
			display: flex !important;
		}
		.control-panel-right[bluetooth='1'] .iaq-button-score-a,
		.iaq-button-score-a[mobmob='1'] .iaq-button-score-a {
			display: inline-block;
		}
		.iaq-subdevice[bluetooth='0'][mobmob='0'] {
			display: none !important;
		}
		.iaq-subdevice[bluetooth='1'],
		.iaq-subdevice[mobmob='1'] {
			display: flex !important;
		}
		.device-none {
			display: none !important;
		}
		.device-flex {
			display: flex;
		}
		.dimming-subdevice[bluetooth='0'][mobmob='0'],
		.dimming-subdevice[bluetooth='2'][mobmob='0']
		{
			/* opacity: 0.55 !important;
			pointer-events: none !important; */
			height:0px!important;
			overflow: hidden;
		}
		.curtain-subdevice[bluetooth='0'][mobmob='0'],
		.curtain-subdevice[bluetooth='2'][mobmob='0']
		{
			/* opacity: 0.55 !important;
			pointer-events: none !important; */
			height:0px!important;
			overflow: hidden;
		}
		.device.curtain-subdevice[bluetooth='1'],
		.device.curtain-subdevice[mobmob='1'],
		.device.curtain-subdevice[mesh='1'],
		.device.dimming-subdevice[bluetooth='1'],
		.device.dimming-subdevice[mesh='1'],
		.device.dimming-subdevice[mobmob='1'] {
			height:67px!important;
			display: flex;
		}
		.box-btn {
			margin-bottom: 7.5px;
			margin-top: 7.5px;
		}
		.box-left {
			border-left: 1px solid var(--f7-list-item-border-color);
		}
		.unit {
			font-size: 11px;
		}
		.title-btn {
			width: 100%;
			margin-left: 5px;
		}
		.iaq-title-big {
			font-size: 12px;
		}
		.main-btn .box-btn-img {
			background-color: #3bb33b;
		}
		.device[bluetooth='1'] .iot-connect {
			display: none !important;
		}
		.device[mobmob='1'] .iot-connect {
			display: none !important;
		}
		.device[mesh='1'] .iot-connect {
			display: none !important;
		}
		.device[bluetooth='0'][mobmob='0'][mesh='0'] .iot-connect {
			display: block !important;
		}
		.subdevice[bluetooth='0'][mobmob='0'][mesh="0"] {
			display: none;
		}
		.subdevice[bluetooth='1'],
		.subdevice[mobmob='1'] {
			display: block;
		}
		.home-signal-thermostat {
			display: none;
		}
		.arrow-downward-button[ref='1'] .button,
		.arrow-upward-button[ref='1'] .button {
			background-color: var(--f7-theme-color);
			color: #ffffff;
			border-color: var(--f7-theme-color);
		}
		@keyframes refresh {
			0% {
				opacity: 0;
			}
			50% {
				opacity: 1;
			}
			100% {
				opacity: 0;
			}
		}
		li.device .item-content .control-panel-right i.button-icons,
		li.device .item-content .control-panel-right i {
			line-height: 25px !important;
		}
		.tabbar .tab-link-highlight {
			bottom: 0;
			display: none;
		}
		.pair-box-connect {
			position: absolute;
			margin-top: -95px;
			margin-left: 35px;
			transform: rotate(90deg);
			color: var(--f7-theme-color);
		}
		.circle-password {
					width: 70px;
					height: 70px;
					border-radius: 50%;
					background-color: var(--f7-theme-color); /* 设置圆圈颜色为蓝色 */
					display: flex;
					justify-content: center;
					align-items: center;
					color: white;
					font-size: 24px;
					font-weight: bold;
					margin: 10px;
			}
		.device-mobile-as-hub{
			width: 30px;
			height : 30px;
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
			background-size: 100% auto;
			background-position: left top;
		}
		.moblie-as-hub-icon{
			position: relative;
			width: 100px;
			height : 100px;
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
			background-size: 100% auto;
			background-position: left top;
			display: flex;
      justify-content: center;
      align-items: center;
		}
		.page-content *[mobmob='1'][mobilehub='1'] .mobmob{
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
		}
    .signal-wave {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 0, 0, 0.5);
				will-change: transform, opacity; 
        animation: expand 2s infinite;
				transform: scale(1);
    }

    .signal-wave:nth-child(1) {
        animation-delay: 0s;
				background: rgba(255, 165, 0, 0.5);
    }

    .signal-wave:nth-child(2) {
        animation-delay: 0.5s;
				background: rgba(255, 255, 0, 0.5)
    }

    .signal-wave:nth-child(3) {
        animation-delay: 1s;
				background: rgba(0, 128, 0, 0.5)
    }

    .signal-wave:nth-child(4) {
        animation-delay: 1.5s;
				background: rgba(0, 0, 255, 0.5)
    }

    @keyframes expand {
        0% {
					transform: scale(1);
          opacity: 0.5;
        }
        100% {
					transform: scale(20);
          opacity: 0;
        }
    }
		.show-item{
			width: 49%;
			background: #fff;
			border-radius: 15px;
			overflow: hidden;
			min-height: 150px;
			margin-bottom: 15px;
		}
		.page-content *[mesh='1'] .mesh{
			color: grey;
		}
		@keyframes rotate {
			from {
				transform: rotate(0deg);
			}
			to {
				transform: rotate(360deg);
			}
		}
	.rotate-animation {
		animation: rotate 2s linear infinite;
		display: inline-block; /* 确保transform生效 */
	}
	.rotate-animation.paused {
		animation: none;
	}
	.fliter-bg-color{
		background-color: var(--f7-theme-color)!important;
		color: #fff!important;
	}
</style>
