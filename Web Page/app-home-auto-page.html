<template>
	<div class="page">
		<div class="navbar active">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				${isHomePage ? $h`
				<div class="left">
					<a href="#" class="button button-fill text-color-theme bg-color-white button-44 panel-open" data-panel="left">
						<i class="icon material-icons">menu</i>
					</a>
				</div>
				<div class="title sliding">
					<div class="logo-small">
						<img src="{{ frappe.get_url(nav_app_logo_image) if nav_app_logo_image else appSetting.iconImageUri }}" />
						<a href="/mobile-app/profile-list" class="link">
							${erp.info.profile ? $h`
							<font class="profile_title" style="text-overflow: ellipsis; max-width: 110px; overflow: hidden">
								${ erp.info.profile.flat ? tran(erp.info.profile.flat) + '-' : '' }${ tran(erp.info.profile.profile_name) }
							</font>
							` : $h`
							<font class="profile_title" style="text-overflow: ellipsis; max-width: 110px; overflow: hidden"> ${ tran('Default') } </font>
							`}
							<div class="home-title-profile-popover" style="margin-left: 5px">
								<i class="icon f7-icons" style="font-size: 14px">chevron_down</i>
							</div>
						</a>
					</div>
				</div>
				<a class="button button-fill text-color-theme bg-color-white button-44" href="#" func="open_accounts">
					<i class="icon material-icons">settings</i>
				</a>
				` : $h`
				<div class="left">
					<a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">${title}</div>
				<div class="right">
					<a link icon-only>
						${mobileAsHubStatus && $h`
            <div class="device-mobile-as-hub" @click="${()=>clickForMobile()}"></div>
						`}
          </a>
				</div>
				`}
			</div>
		</div>
	
		<div class="page-content ptr-content" style="height: 100%" @ptr:refresh="${refresh}">
			<div class="ptr-preloader"><div class="preloader"></div><div class="ptr-arrow"></div></div>
			
			
			<div class="room-box">
					<!-- home scene banner -->
					<div class="banner-swiper-container swiper-container-auto swiper-container home-swiper" style="z-index: 5; position: fixed">
						<div class="swiper-wrapper">
							${scenes.map((sceneItem)=> $h`
								<div class="swiper-slide home-swiper-slide" key="${sceneItem.name}" style="background-image: url('https://dev.mob-mob.com/files/scene.jpg');background-size: cover;">
									<div class="home-swiper-slide-inner">
										<div style="margin: 8px 16px 8px 30px">
											<div style="text-align: left; float: left; width: 50%; line-height: 29px; padding-top: 5px">
												<b style="font-size: 25px; text-shadow: 1px 2px 3px #000; color: #fff">${ tran(sceneItem.title) }</b>
											</div>
											<div style="text-align: right; float: right; width: 50%; display: none">
												<a
													class="button right"
													href=""
												>
													<i class="material-icons">settings</i>
												</a>
											</div>
											<br />
											<div style="text-align: right; float: right; width: 50%; margin-top: -20px; margin-bottom: 20px">
												<!-- <label
													class="switch"
													style="
														margin-top: 10px;
														margin-bottom: 20px;"
												>
													<input type="checkbox" scene-name="${sceneItem.name}" />
													<span class="slider round"></span>
												</label>-->
												<a
													href="#"
													@click="${()=>{home_auto_click_scene(sceneItem)}}"
													sceneref="${sceneItem.name}"
													class="right off_flag"
												>
													<div
														class="button button-small button-raised button-round button-fill"
														style="
															width: 60px;
															height: 60px;
															content: '';
															-webkit-border-radius: 50%;
															-moz-border-radius: 50%;
															border-radius: 50%;
														"
													>
														<i class="material-icons">touch_app</i>
													</div>
												</a>
											</div>
										</div>
									</div>
								</div>
							`)}
						</div>
					</div>
					
					<!-- home room toolbar -->
				${subdevices.length > 0 && $h`
				<div
					class="toolbar tabbar tabbar-scrollable toolbar-home-room"
					style="
						z-index: 5;
						position: fixed;
						${page_margin_top>100?'margin-top:104px;': ''}
						${show_noroom?'display:none;':''}
						${show_nosubdevice?'display:none;':''}
					"
				>
					<div class="toolbar-inner">
						<a
							ref="0"
							id="room-bar-title-0"
							@click="${()=>show_room(0,1)}"
							class="tab-link tab-link-active"
						>
							<i class="material-icons">home</i>
						</a>
						${rooms.map((item)=> $h`
							${item.subdevices_count > 0? $h`
										<a
											ref="${item.idx}"
											id="room-bar-title-${item.name}"
											@click="${()=>show_room(item.name,item.subdevices_count)}"
											class="tab-link"
											key="${item.name}"
										>
											${tran(item.title)}
										</a>
							`: $h`
									<a></a>
							`}
						`)}
					</div>
					${profilePermision && $h`
					<div class="room-more-icon-box">
						<a href="/mobile-app/ha-room-list?page_type=2" class="button">
							<i class="material-icons">more_vert</i>
						</a>
					</div>
					`}
				</div>
				`}
				<!-- for rooms switch -->
				<div class="tabs" style="display: none">
					<div id="tab-hidden-0" class="page-content tab tab-active"></div>
					${rooms.map((item)=> $h`
					<div id="tab-hidden-${item.idx}" class="page-content tab"></div>
					`)}
				</div>
					
					<!-- no room show -->
					<div style="${show_noroom?'':'display:none;'}${show_nosubdevice?'display:none;':''}">
						<div class="block" style="text-align: center;">
							<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
							<p>${_('You don\'t have any room, create one')}</p>
						</div>
						<div class="block block-strong">
							<p class="row">
								<a class="col button button-large" href="/frappe/form/${_('Create Room')}/APP_HA_Room_Form_V1/Profile Room/null/"
									>${ _('Create Room') }</a
								>
							</p>
						</div>
				</div>
				
				<!-- no device show -->
					<div style="${show_nosubdevice?'':'display:none;'}">
						<div class="block" style="text-align: center">
							<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
							<p>${_('You don\'t have any devices, create one')}</p>
						</div>
						<div class="block block-strong">
							<p class="row">
								<a class="col button button-large" href="/mobile-app/yoswit-device-type"
									>${ _('Create Device') }</a
								>
							</p>
						</div>
					</div>
				
					${subdevices.length > 0 && $h`
						<div style="height: ${page_margin_top}px;"></div>
				`}
				
				<!-- rooms -->
				${rooms.map((item)=> $h`
						${item.subdevices_count > 0? $h`
								<div id="room-${item.name}-div" key="${item.name}" class="list media-list no-margin">
									<ul>
										<li id="room-${item.name}-div-title" room="${tran(item.name)}" class="swipeout room" ref="${item.idx}">
											<div class="item-content swipeout-content">
												<div class="item-inner">
													<div class="item-title-row">
														<!-- title text -->
														<div
															class="item-title"
															lang="en"
															lang-packet="${item.title}"
															@click="${()=>collapse_room(item.name)}"
															ref="${item.name}"
														>
															<i class="room-collapse material-icons" id="collapse-${item.idx}"> expand_more </i>
															${ tran(item.title) }
														</div>
					
														<!-- click to turn on all device in room -->
														<div class="item-after">
															<p class="segmented segmented-raised segmented-round" style="display: none">
																<button class="button button-round link" func="controller_common_home_click_room_onoff" ref="1">Off</button>
																<button class="button button-round link" func="controller_common_home_click_room_onoff" ref="0">On</button>
															</p>
														</div>
													</div>
												</div>
											</div>
											<div class="swipeout-actions-right">
												<a
													href="/frappe/form/Edit ${ tran(item.title) }/APP_HA_Room_Form_V5/Profile Room/${ item.name }/"
													class="link color-orange"
												>
													<i class="icon material-icons">settings</i>
												</a>
											</div>
										</li>
										<div class="room-item">
										${subdevices.map((kitem)=> $h`
												${kitem.profile_room === item.name && kitem.hidden == 0? $h`
														<li
																class="device home-scanned-peripheral swipeout swipeout-delete-manual"
															@swipeout:deleted="${()=>onDeleted(kitem)}" guid="${kitem.device}" button_group="${kitem.device_button_group}" config="${kitem.config}" subdevice_name="${kitem.name}" key="${kitem.name}"
														>
															<div class="item-content swipeout-content">
																<a class="item-link item-content no-chevron no-ripple no-active-state">
																	<div
																		class="priority-thumb device-thumb item-media display-flex justify-content-center flex-direction-row align-content-center"
																		style="
																			background-position: center;
																			background-size: contain;
																			position: relative;
																			background-image: url('${kitem.thumb}');
																		"
																		@click="${()=>testFun(kitem)}"
																	>
																			<!--<i class="prioritysss icon material-icons text-color-red device-none" style="font-size: 35px;">priority_high</i>-->
																			<!--<i class="priorityss icon material-icons text-color-orange ${kitem.mac_error_status?'':'device-none'}" style="font-size: 35px;">priority_high</i>-->
																			<!--<i class="prioritys icon material-icons text-color-yellow ${kitem.guid_status?'device-none':''}" style="font-size: 35px;">priority_high</i>-->
																			<!--<i class="priority icon material-icons text-color-red device-none" style="font-size: 35px;">priority_high</i>-->
																		</div>
																	<div class="item-inner">
																		<div class="item-title-row">
																			<div class="item-title ellipsis" lang="en" style="width: 190px" title="${kitem.title}">${tran(kitem.title)}</div>
																		</div>
																		<div class="item-subtitle">${ kitem.device_model }-${ kitem.device_name }</div>
																		${profilePermision && $h`
																		<div class="signal-panel item-text height-21" style="width: 120%">
																				<${renderSignalItem} kitem="${kitem}" key="${kitem.signalRfresh}${kitem.mn_head_connected}${kitem.mn_tail_set}${kitem.mn_head_set}${kitem.mn_tail_connected}"/>
																		</div>
																		`}
																	</div>
																</a>
																${profilePermision && $h`
																<${renderSwipeLeftPanel} kitem="${kitem}" />
																<${renderSwipeRightPanel} kitem="${kitem}" />
																<${renderMainButton} kitem="${kitem}" key="${md5(JSON.stringify(kitem))}"/>
																`}
															</div>
														</li>
														<${renderBottomButton} kitem="${kitem}" key="${md5(kitem.device_attachment_status)}${md5(kitem.config?kitem.config:'')}${md5(kitem.device_config?kitem.device_config:'')}${md5(md5(updateTime+''))}"/>
																			`  : $h`
																					<a></a>
																			`}
										`)}
															</div>
													</ul>
											</div>
					` : $h`
							<div id="room-${item.name}-div" class="room-device-null"></div>
					`}
							`)}
				</div>
				${profilePermision && $h`	
				<div id="room-0-div" class="list media-list no-margin ${show_unassigned?'':'device-none'}">
					<ul>
						<li class="room">
							<div class="item-content">
								<div class="item-inner">
									<div class="item-title-row">
										<div class="item-title" lang="en" lang-packet="Unassigned" func="controller_common_home_collapse" ref="0">
											<i class="room-collapse material-icons" id="collapse-0"> expand_more </i>
											{{ _('Unassigned') }}
										</div>
									</div>
								</div>
							</div>
						</li>
						<div class="unassigned-box">
									${unassigned_subdevices.map((kitem)=> $h`
							<li 
								class="device home-scanned-peripheral swipeout swipeout-delete-manual"
								style="${kitem.disappear?'display:none;':''}"
								guid="${kitem.device}"
								button_group="${kitem.device_button_group}"
								display-name="${tran(kitem.name.substring(0, 16))}"
							>
								<div class="item-content swipeout-content">
									<a class="item-link item-content no-chevron no-ripple no-active-state" func="ble_load_to_device_form_auto">
										<div
											class="device-thumb item-media"
											style="
												background-position: center;
												background-size: contain;
												position: relative;
															background-image: url('${kitem.thumb}');
											"
										></div>
										<div class="item-inner">
											<div class="item-title-row">
												<div class="item-title ellipsis" lang="en" style="width: 190px" title="${tran(kitem.name)}">
													<i class="material-icons text-muted" style="position: relative; top: 5px">settings</i>
													${tran(kitem.name.substring(0, 16))}
												</div>
											</div>
											<div class="item-subtitle">${ tran(kitem.device_model) }-${ tran(kitem.device_name.substring(0, 12)) }</div>
											<div class="signal-panel item-text height-21" style="width: 120%">
													<${renderSignalItem} kitem="${kitem}" key="${kitem.signalRfresh}"/>
											</div>
										</div>
									</a>
												<${renderMainButton} kitem="${kitem}" key="${md5(JSON.stringify(kitem))}"/>
								</div>
							</li>
							<${renderBottomButton} kitem="${kitem}" />
											`)}
						</div>
					</ul>
				</div>
				`}
		</div>
	</div>
</template>

<script>
//defined components
const renderSignalItem = (props, {
	$h
}) => {
	//defined the wifi model
	let wifiModel = ['YO360', 'YO121-AC', 'YO780-Scene-6G', 'YO780-Scene-12G','YO780-Scene-4G',,'YO780-Scene-3G','YO780-Scene-2G','YO780-Scene-1G', 'YO780', 'YO105','YO790DC'];
	let this_model = props.kitem.device_model;
	let wifiIndex = wifiModel.indexOf(this_model);
	let wifiShowStatus = wifiIndex > -1 ? true : false;
	let devices = cloneDeep(erp.info.device);
	let wifiSetStatus = false;
	if(props.kitem.device){
		let deviceMap = devices[props.kitem.device];
		if(deviceMap){
			let settings = deviceMap.settings;
			settings.forEach(item=>{
				if(item.setting_type == 'Wifi Password' && item.setting!= ''){
					wifiSetStatus = true;
					
				}
			})
		}
	}
	const fixNetwork = (kitem,is_mesh_status)=>{
		if(!kitem.network_id){
			return
		}
		if(is_mesh_status){
			return
		}
		if(kitem.rssilv == 0){
			app.dialog.alert(`${_('Device is not here')}`);
			return
		}
		app.dialog.preloader(`${_('Network Repair In Progress')}`)
		let network_id = kitem.network_id;
		let network_position = kitem.network_position;
		let devices = cloneDeep(erp.info.profile.profile_device);
		let networkIdList = devices.filter((e)=>e.network_id == network_id && e.network_id != 0).sort((a,b)=>{
			return a.network_position-b.network_position;
		})
		let headBytes = '';
		let tailBytes = '';
		if(network_position == 0){
			headBytes= `8500010000000000000000000000`;
			tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)+1].device,true).toLowerCase()}0100000000`;
		}else if(network_position == networkIdList.length-1){
			headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)-1].device,true).toLowerCase()}0000000000`;
			tailBytes = `8500010000000000000100000000`;
		}else{
			headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)-1].device,true).toLowerCase()}0000000000`;
			tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)+1].device,true).toLowerCase()}0100000000`;
		}
		let meshCommands = ['85000000', '850200', tailBytes, '850201', headBytes, '850200'];
		let bleList = [];
		meshCommands.forEach(zitem=>{
			bleList.push({
				service: 'ff80',
				characteristic: 'ff81',
				data: zitem,
			})
		})
		bleList.push({
			service: 'ff80',
			characteristic: 'ff81',
			data: '810e',
		})
		try{
			console.log('bleList',bleList)
			peripheral[kitem.device].write(bleList);
			app.dialog.close();
			app.dialog.alert(`${_('Repair completed. The device networking will take some time. Please pay attention to the changes in the networking status.')}`)
		}catch(error){
			app.dialog.close()
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	const definedDeviceNetworkStatus = (network_id,head_connected,head_set,tail_connected,tail_set,is_mobmob,rssilv) =>{
		let is_mesh = false;
		if(network_id){
			is_mesh = true
			if(rssilv){
				if(head_set){
					if(!head_connected){
						is_mesh = false;
					}
				}
				if(tail_set){
					if(!tail_connected){
						is_mesh = false;
					}
				}
			}
		}
		return is_mesh;
	}
	let is_mesh_status = definedDeviceNetworkStatus(props.kitem.network_id,props.kitem.mn_head_connected,props.kitem.mn_head_set,props.kitem.mn_tail_connected,props.kitem.mn_tail_set,props.kitem.mobmob,props.kitem.rssilv);
	if(props.kitem.device == '30346565303331666337376212012e1d'){
		debugger
		console.log("is_mesh_status",is_mesh_status)
	}
	return () => $h`
			<div class="signal-view-main" signal="${props.kitem.rssilv}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob}" mesh="${props.kitem.network_id>0?1:0}" mobilehub="${props.kitem.is_mobile_gateway?props.kitem.is_mobile_gateway:0}">
			<div class="signal"></div>
			<div class="bluetooth"></div>
			<div class="mesh" @click="${()=>fixNetwork(props.kitem,is_mesh_status)}">
				${(props.kitem.network_id>0 && !is_mesh_status) && $h`
				<i class="prioritys icon material-icons text-color-red" style="font-size: 20px;position: relative;top: -6px;">priority_high</i>
				`}
			</div>
			<div class="mobmob">
				<i class="prioritys icon material-icons text-color-red device-none" style="font-size: 20px;position: relative;top: -3px;">priority_high</i>
			</div>
			<div class="iostatus"></div>
			<div class="rcu-virtual-button ${props.kitem.device_mode == 'RCU Controller' && props.kitem.device_button_group == 'SCENE MUTIWAY ONOFF GANG1'?'':'device-none'}"  ref="${props.kitem.device_status?1:0}">
				<i class="material-icons radio-button-unchecked" style="font-size:22px;color:#cbcbcb;">radio_button_unchecked</i><i class="material-icons circles" style="font-size:22px;">circle</i>
			</div>
			<div class="wifiicon ${wifiShowStatus?'':'device-none'}" guid="${props.kitem.device}" button_grou="${props.kitem.device_button_group}">
            <i class="material-icons ${props.kitem.mobmob && wifiSetStatus?'text-color-green':'text-color-red'}" style="font-size:22px;">${props.kitem.mobmob && wifiSetStatus?'wifi':"wifi_off"}</i>
						<i class="prioritys icon material-icons text-color-red device-none" style="font-size: 20px;position: relative;top: -8px;left: -21px;">priority_high</i>
      </div>
			</div>
		`;
};

const renderSwipeLeftPanel = (props, {
	$h,
	$update
}) => {
	const click_toggle_connect = (kitem) => { 
		if (!isset(peripheral[kitem.device])) {
			// invalid guid
		}
		let prop = peripheral[kitem.device].getProp();
		if (prop.connected || prop.connecting) {
			peripheral[kitem.device].disconnect().then((rs) => {
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",0);
				$update();
			}, (error) => {
				app.dialog.alert(erp.get_log_description(error));
			});
		} else {
			peripheral[kitem.device].connect().then((rs) => {
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
				$update();
			}, (error) => {
				app.dialog.alert(erp.get_log_description(error));
			});
		}
	};
	const toScene = async (item) => {
		//delete undefined values
		for (let i in item) {
			if (!isset(item[i])) {
				delete item[i]
			}
		}
		//mainView.router.navigate(`/mobile-app/scene-list?sceneitem=${encodeURIComponent(JSON.stringify(item))}`);
		mainView.router.navigate(`/mobile-app/scene-guid-list?subdevice_name=${item.name}`)
	};
	return () => $h`
			<div class="swipeout-actions-left">
				<a
					href="/mobile-app/ha-device-setting-connections?guid=${props.kitem.device}&subdevice_name=${props.kitem.name}"
					class="link color-orange"
					><i class="icon material-icons">integration_instructions</i></a
				>
				<a @click="${()=>toScene(props.kitem)}" class="link color-cust-green"
					><i class="icon material-icons">motion_photos_auto</i></a
				>
				<a
					href="/frappe/list/Timer/APP_HA_Device_Timer_V3/Profile Subdevice Timer/null/16/profile_subdevice=${props.kitem.name}/"
					class="link color-cust-blue"
					><i class="icon material-icons">alarm</i></a
				>
				<a class="link color-cust-purple" @click="${()=>click_toggle_connect(props.kitem)}"
					><i class="icon material-icons">settings_bluetooth</i></a
				>
			</div>
		`;
};


const renderSwipeRightPanel = (props, {
	$h
}) => {
	const kitem = props.kitem;
	return () => $h`
			<div class="swipeout-actions-right">
				<a
					href="/mobile-app/setting-page?title=Edit ${encodeURIComponent(tran(kitem.title))}&guid=${ kitem.device }&name=${kitem.name}&profile_device_name=${kitem.profile_device}&device_mode=${kitem.device_mode}&slot_index=${kitem.config?kitem.config:''}"
					class="link color-orange"
					><i class="icon material-icons">settings</i></a
				>
				<a
					class="link color-cust-green"
					ref="${kitem.device}|${kitem.device_name?kitem.device_name.substring(0,12):''}|${kitem.device_mode}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					func="core_device_replace_search_device"
					><i class="icon material-icons">download</i></a
				>
				<a
					class="link color-cust-purple"
					guid="${kitem.device}"
					ref="${kitem.device}|${kitem.mac_address}|${kitem.device_model}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					func="iot_reset_password"
					><i class="icon material-icons">restart_alt</i></a
				>
				<a
					href="/mobile-app/device-control-log?subdevice_name=${kitem.name}/"
					class="link color-cust-blue"
					><i class="icon material-icons">content_paste_go</i></a
				>
				<!-- <a func="app_set_device_hidden" ref="${kitem.name}" class="link color-cust-green"
					><i class="icon material-icons">visibility</i></a
				>-->
				<a href="#" data-confirm="Are you sure you want to delete this item?" class="link swipeout-delete"
					><i class="icon material-icons">delete</i></a
				>
			</div>
		`;
};


const renderMainButton = (props, {
	$h,
	$update
}) => {
	const mode = props.kitem.device_mode;
	const click_connect = (kitem) => {
		setTimeout(function() {
			if (peripheral[kitem.device]) {
				peripheral[kitem.device].connect().then((rs) => {
					$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
					$update();
				}).catch((error) => {
					app.dialog.alert(_(erp.get_log_description(error)));
				});
			}
		}, 1);
	};
	const click_curtain_switch = (kitem,type)=>{
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},10000)
		if(kitem.device_status == 0){
			props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
		}else{
			props.kitem.device_status = 0;
		}
		$(`.range-slider[guid="${kitem.device}"]`).find(".range-bar-active").css({
			width: props.kitem.device_status + '%'
		})
		$(`.range-slider[guid="${kitem.device}"]`).find(".range-knob-wrap").css({
			left: props.kitem.device_status + '%'
		})
		if (props.kitem.device_status > 1) {
			$(`.page-current .range-slider-home-auto[guid="${kitem.device}"][button_group="${kitem.device_button_group}"]`).removeClass('range-slider-min')
		} else {
			$(`.page-current .range-slider-home-auto[guid="${kitem.device}"][button_group="${kitem.device_button_group}"]`).addClass('range-slider-min')
		}
		if(kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')){
			peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {

			}).catch((error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
						
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}
			});
		}else{
			peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {


			}).catch((error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
						
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}

			});
		}
	}
	const click_curtain_motor = (kitem, type) => {
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},10000)
		let otherModelStatus = false;
		if(kitem.device_model == 'YO121-AC-R2W') otherModelStatus = true;
		let reverse = kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') ? true : false;
		let bar_value = 0;
		let data = ``;
		if (type) {
			data = "55AA050101036DDC";
			//this have differ model command
			if(otherModelStatus){
				data = '55fefe0303';
			}
		} else {
			if (kitem.device_status == 0) {
				//props.kitem.device_status = 1;
				props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
				// if (isset(window.dimmingRecord[props.kitem.name]) && window.dimmingRecord[props.kitem.name]['lastref'] > 0) {
				// 	bar_value = window.dimmingRecord[props.kitem.name]['lastref'];
				// } else {
				// 	bar_value = 100;
				// }
			} else {
				props.kitem.device_status = 0;
			}
			$(`.range-slider[guid="${kitem.device}"]`).find(".range-bar-active").css({
				width: props.kitem.device_status + '%'
			})
			$(`.range-slider[guid="${kitem.device}"]`).find(".range-knob-wrap").css({
				left: props.kitem.device_status + '%'
			})
			if (props.kitem.device_status > 1) {
				$(`.page-current .range-slider-home-auto[guid="${kitem.device}"]`).removeClass('range-slider-min')
			} else {
				$(`.page-current .range-slider-home-auto[guid="${kitem.device}"]`).addClass('range-slider-min')
			}
			if (reverse) {
				data = `55AA060102${(100-props.kitem.device_status*1).toString(16).pad("00")}FF`;
				if(otherModelStatus){
					data = `55fefe0304${(100-props.kitem.device_status*1).toString(16).pad("00")}`;
				}
			} else {
				data = `55AA060102${props.kitem.device_status.toString(16).pad("00")}FF`;
				if(otherModelStatus){
					data = `55fefe0304${props.kitem.device_status.toString(16).pad("00")}`;
				}
			}

		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		let command = "8602" + data.toLowerCase();
		console.log("command",command);
		window.peripheral[props.kitem.device].curtainmotor([{
			gang: bleHelper.getGangId(kitem.device_button_group),
			value: props.kitem.device_status,
			command: command
		}]).then(()=>{

		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
		$update();
	}
	const click_onoff_thermostat = (kitem) => {
		if (kitem.device_status == 0) {
			props.kitem.device_status = 1;
		} else {
			props.kitem.device_status = 0;
		}
		let data = '9403000001' + parseInt(kitem.device_status).toString(16).pad('00');
		window.peripheral[props.kitem.device].thermostat([{
			gang: bleHelper.getGangId(kitem.device_button_group),
			value: props.kitem.device_status,
			command: data
		}]).then(()=>{

		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
		//emitter.off(`thermostat_${props.kitem.device}`);
		emitter.emit(`thermostat_${props.kitem.device}`, {
			guid: props.kitem.device,
			ref: props.kitem.device_status
		})
		$update();
	}
	const click_onoff = async(kitem) => {
		let oldStatus = kitem.device_status;
		// try{
		// 	await iot_ble_check_enable();
		// }catch(error){
		// 	app.dialog.alert(error);
		// 	return;
		// }
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},10000)
		if (kitem.device_status == 0) {
			if (
				kitem.device_button_group.startsWith('RCU DIMMING') ||
				kitem.device_button_group.startsWith('DIMMING')
			) {
				props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
			} else {
				props.kitem.device_status = 1;
			}
		} else {
			props.kitem.device_status = 0;
		}
		$update();
		setTimeout(function() {
			if (peripheral[kitem.device]) {
				if (kitem.device_button_group.startsWith('RCU ONOFF GANG')) {
					peripheral[kitem.device].rcuOnoff([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then((rs) => {

					}).catch((error) => {
						if(error == 7200){
							erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
								
							})
						}else{
							app.dialog.alert(_(erp.get_log_description(error)));
						}
					});
				} else if (kitem.device_button_group.startsWith('DIMMING') || kitem.device_button_group.startsWith('RCU DIMMING')) {
					
					const v = Math.ceil((props.kitem.device_status*1.0 / 255.0) * 100.0) || 0;

					if($(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).length){
							$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`)
								.find('.range-bar-active')
								.css({
									width: v + '%',
								});
							$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`)
								.find('.range-knob-wrap')
								.css({
									left: v + '%',
								});
							if (v > 1) {
								$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).removeClass('range-slider-min');
							} else {
								$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).addClass('range-slider-min');
							}
						}
						if(kitem.device_button_group.startsWith('RCU DIMMING')){
							peripheral[props.kitem.device].rcuDimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(()=>{

							}).catch(error=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}else{
							peripheral[props.kitem.device].dimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(()=>{
								
							}).catch((error)=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}
					
				} else {
					peripheral[kitem.device].onoff([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then((rs) => {

					}).catch((error) => {
						//if error change the old status
						//check if paw error
						if(error == 7200){
							erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
								
							})
						}else{
							props.kitem.device_status = oldStatus;
							app.dialog.alert(_(erp.get_log_description(error)));
							$update();
						}
					});
				}
			}
		}, 1);
	};
	//this bacnet flow
	const bacnet_click_onoff = (kitem)=>{
		let configString = kitem.config;
		if(kitem.device_status == 0){
			kitem.device_status = 1;
		}else{
			kitem.device_status = 0;
		}
		if(configString){
			let config = configString.split("|");
			let airconfig = config[5].split(",");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			temp = tagCode.split("_");
			let roomCode = temp[0];
			let message = [];
			console.log("airconfig[0]",airconfig[0])
			if(airconfig[0] == "1"){
				
				airconfig[0] = "0";
			}else{
				kitem.device_status = 1;
				airconfig[0] = "1";
			}
			config[5] = airconfig.join(",");
			kitem.config = config.join("|");
			message.push({
				"operate": "write",
				"deviceCode": deviceCode,
				"tagCode": roomCode + "_ONOFF_CTRL",
				"val": `${airconfig[0]}`
			});
			message = JSON.stringify(message);
			console.log("message",message)
			core_mqtt_publish(config[1], message, 0, false, false, true);
			try{
				let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
				subdevices.forEach(item=>{
						if(item.name == kitem.name){
								item.config = config.join("|")
						}
				})
				http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
							profile_subdevice : subdevices
					}
			})
			}catch(error){
				console.log(error);
			}
			$update();
			// cordova.plugin.innocow.mqtt.execute({
			// 	command: "publish",
			// 	id: (Math.floor(Math.random() * 100000) + 1),
			// 	topic: config[1],
			// 	msg: message,
			// 	qos: 0,
			// 	retained: false
			// }, function() {}, function() {});
		}

	}
	const bacnet_light_scene_click_onoff = (kitem,type)=>{
		let configString = kitem.config;
		if(configString){
			let config = configString.split("|");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			let message = [];
			message.push({
					"operate":"write",
					"deviceCode":deviceCode,
					"tagCode":tagCode,
					"val":`${type}`
			});
			message = JSON.stringify(message);
			console.log("message",message)
			core_mqtt_publish(config[1], message, 0, false, false, true);
			$update();
		}
	}
	const iot_rcu_output_change = (kitem,type)=>{
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		//let config = kitem.config?JSON.parse(kitem.config):{};
		//let {dnd,clear} = config;
		let dnd = 32;
		let clear = 31;
		let dnd_virtual_button_group = `RCU OUTPUT${dnd}`;
		let clear_virtual_button_group = `RCU OUTPUT${clear}`;
		let dndOldStatus = isset(kitem.dnd)?kitem.dnd:0;
		let clearOldStatus = isset(kitem.clear)?kitem.clear:0;
		if(type == 'dnd'){
			if(kitem.dnd == 0 || !isset(kitem.dnd)){
				props.kitem.dnd = 1;
				//if click this status,change other status
				props.kitem.clear = 0;
			}else{
				props.kitem.dnd = 0;
			}
		}else if(type == 'clear'){
			if(kitem.clear == 0 || !isset(kitem.dnd)){
				props.kitem.clear = 1;
				props.kitem.dnd = 0;
			}else{
				props.kitem.clear = 0;
			}
		}
		peripheral[kitem.device].rcuOutput([{
			gang: bleHelper.getGangId(dnd_virtual_button_group),
			value: props.kitem.dnd
		}]).then((rs) => {

		}).catch((error) => {
			props.kitem.dnd = dndOldStatus;
			props.kitem.clear = clearOldStatus;
			$update();
			app.dialog.alert(erp.get_log_description(error));
		});
		peripheral[kitem.device].rcuOutput([{
			gang: bleHelper.getGangId(clear_virtual_button_group),
			value: props.kitem.clear
		}]).then((rs) => {

		}).catch((error) => {
			//app.dialog.alert(error)
			//props.kitem.dnd = dndOldStatus;
			props.kitem.clear = clearOldStatus;
			$update();
			app.dialog.alert(erp.get_log_description(error));
		});
		$update();
	}
	const click_onoff_start = (kitem) => {
		if (kitem.device_model.startsWith("YO780")) {
			if (kitem.device_status == 1) {
				props.kitem.device_status = 0;
			} else {
				props.kitem.device_status = 1;
			}
			peripheral[kitem.device].rcuOutput([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				value: props.kitem.device_status
			}]).then((rs) => {

			}).catch((error) => {
				app.dialog.alert(erp.get_log_description(error));
				//app.dialog.alert(error)
			});
		} else {
			kitem.device_status = 1;
			peripheral[kitem.device].onoff([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				on: true
			}]).then((rs) => {

			}).catch((error) => {
				app.dialog.alert(erp.get_log_description(error));
				//app.dialog.alert(error)
			});
		}
	}
	const click_onoff_end = (kitem) => {
		kitem.device_status = 0;
		if (kitem.device_model.startsWith("YO780")) {
			peripheral[kitem.device].rcuOutput([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				value: kitem.device_status
			}]).then((rs) => {

			}).catch((error) => {
				//app.dialog.alert(error)
			});
		} else {
			peripheral[kitem.device].onoff([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				on: true
			}]).then((rs) => {

			}).catch((error) => {
				//app.dialog.alert(error)
			});
		}
	}
	const click_ir = (kitem)=>{
		//let { device_button_group, guid, id, device_command, password, name, network_id,device } = kitem;
// 		let irConfig = peripheral[kitem.device].prop.config;//{}
// 		let configStr = 'ir|0|25,1,2,1,0,1'; //ir|0|tem,speed,direction,swing,onoff,mode
// 		if(isset(irConfig[kitem.name])){
// 			configStr = irConfig[kitem.name]
// 		}
		let configStr = kitem.device_config;
		let this_config = configStr.split("|");
		let airconfig = isset(this_config[2]) && this_config[2] != ',,,,NaN' ? this_config[2].split(',') : '25,1,2,1,0,1'.split(',');
		kitem['click_status'] = true;
		//let config = configStr.split('|');
		let onoffRef = configStr.substring(14,15);
		if(onoffRef == 0){
			onoffRef = 1
		}else{
			onoffRef = 0;
		}
		configStr =`${configStr.substring(0,14)}${onoffRef}${configStr.substring(15,configStr.length)}`;
// 		peripheral[kitem.device].prop.config[kitem.name] = configStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, configStr);
		props.kitem.device_status = onoffRef;
		props.kitem.device_config = configStr;
		props.kitem.config = configStr;
		
		
		let command = kitem.device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,"ARC_ON_OFF",configStr.substring(5,configStr.length));
		peripheral[kitem.device].sendIR(ref_command);
		//peripheral[kitem.device].onPropChanged();
		$update();
	}
	const press_openclose = (kitem, direction, press) => {
		setTimeout(function() {
			if (peripheral[kitem.device]) {

				if (kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
					peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {

					}).catch((error) => {
						app.dialog.alert(erp.get_log_description(error));
					});
				} else {
					peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {


					}).catch((error) => {
						app.dialog.alert(erp.get_log_description(error));

					});
				}
			}
		}, 1);
	};

	const iot_get_music_player_password = (item) => {
		//if not in profile ,false
		if (!item.name) {
			app.dialog.alert(`${tran('You do not have permission to use this device.')}`, runtime.appInfo.name, () => {});
			return false;
		}
		//first get the unique key form the function;
		//1.get time form the device setting,if have time,use it,else input the time
		let deviceObj = cloneDeep(erp.info.device);
		let settings = [];
		let deviceTime = [];
		let erp_keys = '';
		if (deviceObj[item.device] && deviceObj[item.device].settings) {
			settings = deviceObj[item.device].settings;
		}
		settings.forEach(item => {
			if (item.setting_type == "TimeStream") {
				let time = JSON.parse(item.setting);
				deviceTime = time;
			}
			if (item.setting_type == "ConnectKey") {
				erp_keys = item.setting;
			}
		});
		//verify the time check now > the device time
		let status = compareTimeToMusicPlayer(deviceTime);
		if (!status) {
			//update the time of the music player
			//input the time
			app.dialog.prompt('Please enter the length of stay in days', async (days) => {
				const regex = /^\d+(\.\d+)?$/;
				if (!regex.test(days)) {
					app.dialog.alert('Please enter the correct value', runtime.appInfo.name, () => {});
					return false
				} else {
					//get the timeList 
					const currentDate = dayjs();
					const futureDate = currentDate.add(days, 'day');
					let list = [currentDate.format('YYYY-MM-DD HH:mm:ss'), futureDate.format('YYYY-MM-DD HH:mm:ss')];
					let this_password = getRandomNumbers().join("");
					try {
						await window.peripheral[props.kitem.device].doConnect();
						//get the years and months and the days and the hours and the seconds
						let this_time_list = calculateFutureTime(days);
						let this_year = this_time_list[0];
						let this_month = this_time_list[1];
						let this_day = this_time_list[2];
						let this_hour = this_time_list[3];
						let this_minute = this_time_list[4];
						let this_second = this_time_list[5];
						let data = `9800000008${this_password.convertToHex()}${this_second.toString(16).pad('00')}${this_minute.toString(16).pad('00')}${this_hour.toString(16).pad('00')}${this_day.toString(16).pad('00')}${this_month.toString(16).pad('00')}${iot_utils_to_little_endian_hex(this_year,2)}`;
						
						await window.peripheral[props.kitem.device].write([{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						}]);
						await iot_device_setting_sync_server(item.device, 'TimeStream', JSON.stringify(list));
						await iot_device_setting_sync_server(item.device, 'ConnectKey', this_password);
						let sheet = app.sheet.create({
							content: `\
									<div class="sheet-modal">\
										<div class="toolbar">\
											<div class="toolbar-inner justify-content-flex-end">\
												<a  class="link sheet-close">Close</a>\
											</div>\
										</div>\
										<div class="sheet-modal-inner display-flex justify-content-center align-content-center align-items-center">\
											<div class="circle-password">${this_password[0]}</div>\
											<div class="circle-password">${this_password[1]}</div>\
											<div class="circle-password">${this_password[2]}</div>\
											<div class="circle-password">${this_password[3]}</div>\
										</div>\
									</div>\
								`
						});
						sheet.open();
						//app.dialog.alert(`${tran('Connection Key: ')}${this_password}`, runtime.appInfo.name, () => {});
					} catch (error) {
						app.dialog.alert(`${tran('Get the music player password failed')}`, runtime.appInfo.name, () => {});
					}
				}
			}, () => {})
		} else {
			if (erp_keys) {
				let sheet = app.sheet.create({
					content: `\
							<div class="sheet-modal">\
								<div class="toolbar">\
									<div class="toolbar-inner justify-content-flex-end">\
										<a  class="link sheet-close">Close</a>\
									</div>\
								</div>\
								<div class="sheet-modal-inner display-flex justify-content-center align-content-center align-items-center">\
									<div class="circle-password">${erp_keys[0]}</div>\
									<div class="circle-password">${erp_keys[1]}</div>\
									<div class="circle-password">${erp_keys[2]}</div>\
									<div class="circle-password">${erp_keys[3]}</div>\
								</div>\
							</div>\
						`
				});
				sheet.open();
				//app.dialog.alert(`${tran('Connection Key: ')}${erp_keys}`, runtime.appInfo.name, () => {});
			}
		}
	}
	const compareTimeToMusicPlayer = (timeRange) => {
		if (timeRange.length == 0 || timeRange.length == 1) {
			return false;
		}
		const startTimeStr = timeRange[0];
		const endTimeStr = timeRange[1];
		const currentTime = dayjs();
		const startTime = dayjs(startTimeStr);
		const endTime = dayjs(endTimeStr);
		if (currentTime.isAfter(startTime) && currentTime.isBefore(endTime) || currentTime.isSame(startTime) || currentTime.isSame(endTime)) {
			return true;
		} else {
			return false;
		}
	}
	const getRandomNumbers = () => {
		let numbers = new Set();
		while (numbers.size < 4) {
			const randomNum = Math.floor(Math.random() * 10);
			numbers.add(randomNum);
		}
		return Array.from(numbers);
	}
	const calculateFutureTime = (days) => {
		const futureDate = dayjs().add(days, 'day');
		const futureTimeArray = [
			futureDate.year(),
			futureDate.month() + 1,
			futureDate.date(),
			futureDate.hour(),
			futureDate.minute(),
			futureDate.second()
		];
		return futureTimeArray;
	}
	const iot_music_player_change_source = async(kitem)=>{
		let subdevice_name = kitem.name;
		app.dialog.preloader();
		try{
			let data = `9807`;
			await window.peripheral[kitem.device].write([{
				service: 'ff80',
				characteristic: 'ff81',
				data: data,
			}])
			app.dialog.close();
			if(kitem.config == 'phone_iphone'){
				kitem.config = 'tv';
			}else{
				kitem.config = 'phone_iphone';
			}
			//update profile
			let this_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
			this_subdevices.forEach(item=>{
				if(item.name == kitem.name){
					item.config = kitem.config;
				}
			})
			try{
				http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
							profile_subdevice : this_subdevices
					}
			})
			}catch(error){
				console.log(error);
			}
			//app.dialog.alert(`Audio Source Switched Successfully`);
		}catch(error){
			app.dialog.close();
			app.dialog.alert(erp.get_log_description(error));
		}
	}
	//virtual Button click
	const clickSceneVirtualButton = (kitem)=>{
		console.log(kitem);
		//command
		let config = kitem.config;
		let guid = kitem.device;
		if(!config){
			app.dialog.alert(`${_('Error')}`);
			return 
		}
		let command = `8f0200${parseInt(config).toString(16).pad('00')}`;
		try{
			window.peripheral[guid].write([{
				service: 'ff80',
				characteristic: 'ff81',
				data: command,
			}])
		}catch(error){
			app.dialog.alert(erp.get_log_description(error));
		}
	}
	if (
		props.kitem.device_button_group.startsWith('OPENCLOSE GANG') ||
		props.kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')
	) {	
		let ref = props.kitem.device_status;
		let curtainCloseIcon = `close-curtain.svg`;
		let curtainOpenIcon = `open-curtain.svg`;
		let imgurl = `${'https://my.yoswit.com/'}/files/app/${ref > 0?curtainOpenIcon:curtainCloseIcon}`;
		return () => $h`
			<div class="control-panel-right"  bluetooth="${props.kitem.bluetooth}">
				<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
					<div class="button button-raised button-big circle">
						<i class="material-icons">bluetooth_connected</i>
					</div>
				</a>
				<a class="left off_flag" @touchstart="${()=>press_openclose(props.kitem, 'close', true)}"  @touchend="${()=>press_openclose(props.kitem, 'close', false)}">
					<div class="button button-raised button-big openclose cl" style="width:57px"><div class="rotate-90" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;">unfold_less</i></div></div>
				</a>
				<a class="left on_flag" @touchstart="${()=>press_openclose(props.kitem, 'open', true)}"  @touchend="${()=>press_openclose(props.kitem, 'open', false)}">
					<div class="button button-raised button-big openclose op" style="width:57px"><div class="rotate-90" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;">unfold_more</i></div></div>
				</a>
			</div>
		`;
	} else if (
		props.kitem.device_button_group.startsWith('RCU ONOFF GANG') ||
		props.kitem.device_button_group.startsWith('ONOFF GANG')
	) {
		if (props.kitem.device_model == 'YO790DC') {
			let music_config = props.kitem.config;
			return () => $h`
					<a class="control-panel-right">
						<div class="left button button-raised button-big circle"  @click="${()=>iot_get_music_player_password(props.kitem)}">
								<i class="material-icons">key</i>
						</div>
						<div class="left button button-raised button-big circle"  @click="${()=>iot_music_player_change_source(props.kitem)}">
								<i class="material-icons" style="font-size:30px!important;line-height:30px!important;">${music_config?music_config:'phone_iphone'}</i>
						</div>
					</a>
					`;
		}else if(props.kitem.device_model == 'YO780-Scene-6G' || props.kitem.device_model == 'YO780-Scene-12G' || props.kitem.device_model == 'YO780-Scene-4G' || props.kitem.device_model == 'YO780-Scene-2G' || props.kitem.device_model == 'YO780-Scene-3G' || props.kitem.device_model == 'YO780-Scene-1G'){
			return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/setting-page?title=Edit ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
		} else if (props.kitem.device_mode == 'RCU Controller' && props.kitem.device_model == 'YO780') {
			return () => $h`
        <div class="control-panel-right">
            <a href="/mobile-app/setting-page?title=Edit ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;">settings</i></div></div>
            </a>
        </div>
        `;
		} else {
			return () => $h`
					<div class="control-panel-right" style="">
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
		}
	}else if(props.kitem.device_button_group.startsWith('Hdmicec')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/hdmicec-page?guid=${props.kitem.device}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">view_sidebar</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('DOOR SIGN')){
		return () => $h`
					<a class="control-panel-right">
						<div class="left button button-raised button-big circle rcu-output" ref="${isset(props.kitem.dnd)?props.kitem.dnd:0}"  @click="${()=>iot_rcu_output_change(props.kitem,'dnd')}">
								<i class="material-icons">notifications_off</i>
						</div>
						<div class="left button button-raised button-big circle rcu-output" ref="${isset(props.kitem.clear)?props.kitem.clear:0}"  @click="${()=>iot_rcu_output_change(props.kitem,'clear')}">
								<i class="material-icons">cleaning_services</i>
						</div>
					</a>
					`;
	} else if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING')) {
		return () => $h`
					<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
						<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
							<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
							</div>
						</a>
						<a href="#" class="on_flag off_flag" ref="${props.kitem.device_status>0?1:0}" @click="${() => click_onoff(props.kitem)}">
								<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	} else if (props.kitem.device_mode === 'Access Controller') {
		if (props.kitem.device_button_group == 'TOGGLE GANG1') {
			return () => $h`
				<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
					<a class="iot-connect" @click="${()=>click_connect(props.kitem)}">
						<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
						</div>
					</a>
					<a class="on_flag off_flag touch-button-group" ref="${props.kitem.device_status}" @touchstart="${() => click_onoff_start(props.kitem)}" @touchend="${() => click_onoff_end(props.kitem)}">
							<div class="button button-raised button-big circle" style="border-radius:50%;">
								<div class="" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;margin-left:1px;margin-top:1px;">touch_app</i></div>
							</div>
					</a>
				</div>
				`;
		}
	} else if (props.kitem.device_button_group.startsWith('RCU OUTPUT')) {
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff_start(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	} else if (props.kitem.device_button_group.startsWith('OPENCLOSE UART')) {
		let ref = props.kitem.device_status;
		let curtainCloseIcon = `close-curtain.svg`;
		let curtainOpenIcon = `open-curtain.svg`;
		
		if(props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE')){
			if(!props.kitem['click_status']){
				//debugger
				ref = 100 - ref*1;
			}
		}
		let imgurl = `${'https://my.yoswit.com/'}/files/app/${ref > 0?curtainOpenIcon:curtainCloseIcon}`;
		return () => $h`
			<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.mesh || 0}">
				<a class="iot-connect" @click="${()=>click_connect(props.kitem)}">
					<div class="button button-raised button-big circle">
							<i class="material-icons">bluetooth_connected</i>
					</div>
				</a>
				<a class="left on_flag" ref="2" @click="${()=>click_curtain_motor(props.kitem,'pause')}" button_group="${props.kitem.device_button_group}" command-type="Bluetooth" command="">
						<div class="button button-raised button-big openclose cl" style="width:57px"><div style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;margin-top:6px;">pause</i></div></div>
				</a>
				<a class="left on_flag" ref="${ref}" direction="${props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE')?'reverse':'standard'}" @click="${()=>click_curtain_motor(props.kitem)}" button_group="${props.kitem.device_button_group}" command-type="Bluetooth" command="">
						<div class="button button-raised button-big openclose op" style="width:57px"><div style="height:100%;width:100%;"><img src="${imgurl}" alt="" style="width:20px;height:20px;margin-top:5px;" /></div></div>
				</a>
			</div>
			`;
	} else if (props.kitem.device_button_group.startsWith('Thermostat')) {
		return () => $h`
					<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
						<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
							<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
							</div>
						</a>
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff_thermostat(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('BACNET AIR CONDITIONER')){
		let configString = props.kitem.config;
		if(configString){
			let config = configString.split("|");
			let airconfig = config[5].split(",");
			props.kitem.device_status = airconfig[0];
		}
		// if(!isset(props.kitem.device_status) && props.kitem.device_status != 0){
		// 	props.kitem.device_status = 1;
		// }
		console.log("props.kitem.device_status",props.kitem.device_status)
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="${isset(props.kitem.device_status)?props.kitem.device_status:0}" @click="${() => bacnet_click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	}else if(props.kitem.device_button_group.startsWith('BACNET LIGHTING SCENE')){
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="0" @click="${() => bacnet_light_scene_click_onoff(props.kitem,1)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	} else if (mode == 'RF Sensor' || mode == '4in1 Sensor' || mode == 'Radar Sensor') {
		return () => $h`
      <div class="control-panel-right">
          <a class="right">
              <div class="button button-raised button-big circle rf-sensor">
                  <i class="material-icons">block</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group_type == 'Air Conditioner'){
		return () => $h`
    		<div class="control-panel-right"  bluetooth="${props.kitem.bluetooth}">
                <a class="right" @click="${() =>
                    click_ir(props.kitem)}" button-signal="ARC_ON_OFF" command="${
                        props.kitem.device_command
                    }">
                    <div class="button button-raised button-big circle">
                        <i class="material-icons">power_settings_new</i>
                    </div>
                </a>
    		</div>
        `;
	} else if (
		props.kitem.device_button_group_type == 'Television' ||
		props.kitem.device_button_group_type == 'Set-top boxes' ||
		props.kitem.device_button_group_type == 'Audio' ||
		props.kitem.device_button_group_type == 'Projector' ||
		props.kitem.device_button_group_type == 'Fan' ||
		props.kitem.device_button_group_type == 'IPTV' ||
		props.kitem.device_button_group_type == 'Air Purifier' ||
		props.kitem.device_button_group_type == 'Camera' ||
		props.kitem.device_button_group_type == 'Dehumidifier' ||
		props.kitem.device_button_group_type == 'Robot'
	) {
		return () => $h`
      <div class="control-panel-right">
          <a class="right" func="controller_iot_device_ir_full_panel_click" guid="${props.kitem.device}" button-signal="5"  command="0141BE02FD0DF209F603FC52AD53AC00FF10EF11EE13EC14EB15EA17E818E719E6FF001BE4FF000AF54AB547B849B64BB44DB248B720DF0000" command-type="Bluetooth">
              <div class="button button-raised button-big circle">
                  <i class="material-icons">power_settings_new</i>
              </div>
          </a>
          <a class="right" func="iot_device_goto_ir_panel" button-signal="ARC_ON_OFF"  command="0141BE02FD0DF209F603FC52AD53AC00FF10EF11EE13EC14EB15EA17E818E719E6FF001BE4FF000AF54AB547B849B64BB44DB248B720DF0000" command-type="Bluetooth">
              <div class="button button-raised button-big circle">
                  <i class="material-icons" style="line-height: 25px !important;">view_sidebar</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group.startsWith('Yoswit Gateway')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/gateway-wifi-config?guid=${props.kitem.device}&device_name=${props.kitem.profile_device}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith("SCENE MUTIWAY ONOFF GANG1")){
		return () => $h`
				<div class="control-panel-right" style="">
					<a class="right" @click="${()=>clickSceneVirtualButton(props.kitem)}">
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">power_settings_new</i></div></div>
					</a>
				</div>
				`;
	} else {
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="#" func="ble_load_to_device_form_auto" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}
};
//vervify the password
const iotEntryPasswordVerify = () => {

}
//fixed the mac issue
const fixedMacRever = (kitem)=>{
	app.dialog.confirm(`${_('Device configuration has some issues, do you want to fix them?')}`,()=>{
		let scan_mac_address = erp.info.device[kitem.device]['mac_address'];
		let init_mac_address = '';
		if(scan_mac_address){
			init_mac_address = scan_mac_address.replace(/:/g, '').toLowerCase();
		}else{
			init_mac_address = kitem.mac_address;
		}
		let this_guid = macToGuid(init_mac_address,kitem.model);
		try{
			
		}catch(error){

		}
	},()=>{})
}
//render the bottom button ex.air and the dimming bar
let range_silder_list = {};
erp.trigger_thermostat_defined_fun = {};
window.dimmingRecord = {};
const renderBottomButton = (props, {
	$h,
	$onMounted,
	$update
}) => {
	let mode = props.kitem.device_mode;
	let device_button_group = props.kitem.device_button_group
	let key = `dimer_slidebar_${props.kitem.device}`;
	let guid = props.kitem.device || props.kitem.guid;
	console.log("renderBottomButton")
	//thie function control the Dimming mode bar change 
	const range_change_fun_dimming = (element) => {
			debugger
	    props.kitem.device_status = element.value;
	    let range_value = parseInt((element.value*1.0 / 100.0) * 255.0);
	    
	    if(props.kitem.disableControl){
	        props.kitem.disableControl = null;
	        delete props.kitem.disableControl;
	        return;
	    }
	    
	    
	    try {
			if (device_button_group.startsWith("DIMMING")) {
				peripheral[props.kitem.device].dimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(()=>{

				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			} else if (device_button_group.startsWith("RCU DIMMING")) {
				// debugger
				peripheral[props.kitem.device].rcuDimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(()=>{

				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			}
		} catch (error) {
			app.dialog.alert(erp.get_log_description(error));
		}
	}
	const curtain_switch_custom = (kitem,direction)=>{
		//type 0-left 1-right 2-right
		if(peripheral[kitem.device]){
			if (kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
					peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, true).then((rs) => {

					}).catch((error) => {
						app.dialog.alert(erp.get_log_description(error));
					});
				} else {

					peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, true).then((rs) => {


					}).catch((error) => {
						app.dialog.alert(erp.get_log_description(error));

					});
				}
		}
	}
	const range_change_fun_switch_curtain = (element)=>{
		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},10000)
		let parentElemt = $(element.el).parents('.device').prev();
		let thisvalue = element.value;
		const now = DateFormatter.format(new Date(), 'Y-m-d H:i:s');
	}
	const range_change_fun_curtain = (element) => {
		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},10000)
		let otherModelStatus = false;
		if(props.kitem.device_model == 'YO121-AC-R2W') otherModelStatus = true;
		let parentElemt = $(element.el).parents('.device').prev();
		let thisvalue = element.value;
		const now = DateFormatter.format(new Date(), 'Y-m-d H:i:s');
		let reverse = props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') ? true : false;
		if (thisvalue > 0) {
			props.kitem.device_status = thisvalue;
		} else {
			props.kitem.device_status = 0;
		}
		if (reverse) {
			data = `55AA060102${(100-thisvalue).toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${(100-props.kitem.device_status*1).toString(16).pad("00")}`;
			}
		} else {
			data = `55AA060102${thisvalue.toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${props.kitem.device_status.toString(16).pad("00")}`;
			}
		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		let command = "8602" + data.toLowerCase();
		console.log('command',command)
		window.peripheral[props.kitem.device].curtainmotor([{
			gang: bleHelper.getGangId(props.kitem.device_button_group),
			value: thisvalue,
			command: command
		}]).then(()=>{

		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
	}
	const bacnet_light_scene_click_change = (kitem,type)=>{
		let configString = kitem.config;
		if(configString){
			let config = configString.split("|");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			let message = [];
			message.push({
					"operate":"write",
					"deviceCode":deviceCode,
					"tagCode":tagCode,
					"val":`${type}`
			});
			message = JSON.stringify(message);
			core_mqtt_publish(config[1], message, 0, false, false, true);
			$update();
		}
	}
	// bacnet change flow
	const click_bacnet_change = (kitem, click_type) => {
		//mode-1 auto mode-2 cool mode-3 dry model-4 fan model-5 heat
		let configStr = props.kitem.config;
		let config = configStr.split('|');
		let airconfig = isset(config[5]) && config[5] != ',,,,NaN'?config[5].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[1]; //thermostat mode
		let speed_vaule = airconfig[2]; //thermostat speed
		// let swing_value = airconfig[3];
		// let direction_value = airconfig[2];
		let temperature = airconfig[3]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		let temp = config[0].split(".");
		let deviceCode = temp[0];
		let tagCode = temp[1];
		temp = tagCode.split("_");
		let roomCode = temp[0];
		let message = [];
		switch (click_type) {
			case "ARC_MODE":
				if (mode_value == 2) {
					mode_value = 4;
				} else if (mode_value == 4) {
					mode_value = 8
				} else if (mode_value == 8) {
					mode_value = 16;
				}else if (mode_value == 16) {
					mode_value = 2;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_MODE_CTRL",
					"val": mode_value + ""
				});
				break;
			case "ARC_SPEED":
				if(speed_vaule == 2){
					speed_vaule = 8;
				}else if(speed_vaule == 4){
					speed_vaule = 2;
				}else if(speed_vaule == 8){
					speed_vaule = 4;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_SPEED_CTRL",
					"val": speed_vaule + ""
				});
				break;
			case "ARC_REDUCE_TEMP":
				if (temperature != 5) {
					temperature--;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_CONTROL_ROOM_TEMP_SETPOINT",
					"val": temperature + ""
				});
				break;
			case "ARC_ADD_TEMP":
				if (temperature != 32) {
					temperature++;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_CONTROL_ROOM_TEMP_SETPOINT",
					"val": temperature + ""
				});
				break;
		}
		//ir|0|tem,speed,direction,swing,onoff,mode
		config[5] = `1,${mode_value},${speed_vaule},${temperature}`;
		const newConfigStr = config.join("|");
// 		peripheral[kitem.device].prop.config[kitem.name] = newConfigStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, newConfigStr);
		//props.kitem.device_status = 1;
		//props.kitem.device_config = newConfigStr;
		props.kitem.config = newConfigStr;
		message = JSON.stringify(message);
		console.log("message",message);
		core_mqtt_publish(config[1], message, 0, false, false, true);
		try{
			let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
			subdevices.forEach(item=>{
					if(item.name == kitem.name){
							item.config = newConfigStr
					}
			})
			http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
				serializer: "json",
				responseType: "json",
				method: "PUT",
				data: {
						profile_subdevice : subdevices
				}
		})
		}catch(error){
			console.log(error);
		}
		//iot_update_profile_subdevice_config(kitem.name,JSON.stringify({config : newConfigStr}));
		//let command = kitem.device_command['function'];
		//let ref_command = iot_ble_generate_ir_code(command,click_type,`${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`);
		//peripheral[kitem.device].sendIR(ref_command);
		//debugger
		$update();
	}
	//this is the thermostat click function
	const click_thermostat_change = (kitem, click_type) => {
		let value_list = kitem.device_attachment_status.split(',');
		let mode_value = value_list[1];
		let speed_vaule = value_list[2]; //thermostat speed
		let temperature = parseInt(value_list[3]); //temperature
		let room_temperature = value_list[4];
		let data = "";
		let this_gang = 42;
		let post_value = ``;
		//props.kitem.device_attachment_status = [0,0,0,26,26,Math.random()].join(',');
		switch (click_type) {
			case "mode":
				this_gang = 43;
				if (mode_value == 1) {
					mode_value = 0
					$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
					$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-4.png');
				} else if (mode_value == 2) {
					let devices = cloneDeep(erp.info.device);
					let device = devices[guid];
					let mode_seetting = '';
					if (isset(device)) {
						let list = device.settings;
						list.forEach(item => {
							if (item.setting_type === 'mode_selection') {
								mode_seetting = item.setting;
							}
						})
					}
					if (mode_seetting == 'Cooling') {
						mode_value = 0;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-4.png');
					} else {
						mode_value = 1
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-5.png');
					}
				} else if (mode_value == 0) {
					mode_value = 2;
					$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
					$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-2.png');
				}
				data = "9404000001" + parseInt(mode_value).toString(16).pad("00");
				post_value = mode_value;
				break;
			case "fan":
				this_gang = 44;
				if (speed_vaule == 4) {
					if (mode_value == 0) {
						speed_vaule = 2;
					} else {
						speed_vaule = 1;
					}
				} else {
					speed_vaule++
				}
				$('li.device[guid="' + guid + '"] a[command-type="fan"]').attr('ref', speed_vaule);
				$('li.device[guid="' + guid + '"] a[command-type="fan"] img').attr('src', 'style/img/air_condition/icon-speed-' + speed_vaule + '.png');
				data = "9405000001" + parseInt(speed_vaule).toString(16).pad("00");
				post_value = speed_vaule;
				break;
			case "reduce":
				this_gang = 45;
				if (temperature != 5) {
					temperature--;
				}
				$('li.device[guid="' + guid + '"] a[button-signal="5"] span').text(temperature);
				$('li.device[guid="' + guid + '"] a[command-type="add"]').attr('ref', temperature);
				$('li.device[guid="' + guid + '"] a[command-type="reduce"]').attr('ref', temperature);
				data = "9406000001" + parseInt(temperature).toString(16).pad("00");
				post_value = temperature;
				break;
			case "add":
				this_gang = 45;
				if (temperature != 32) {
					temperature++;
				}
				$('li.device[guid="' + guid + '"] a[button-signal="5"] span').text(temperature);
				$('li.device[guid="' + guid + '"] a[command-type="add"]').attr('ref', temperature);
				$('li.device[guid="' + guid + '"] a[command-type="reduce"]').attr('ref', temperature);
				data = "9406000001" + parseInt(temperature).toString(16).pad("00");
				post_value = temperature;
				break;
		}
		props.kitem.device_status = 1;
		window.peripheral[props.kitem.device].prop.status['control'][0][42] = 1;
		props.kitem.device_attachment_status = [1, mode_value, speed_vaule, temperature, room_temperature, 0].join(',');

		window.peripheral[props.kitem.device].thermostat([{
			gang: this_gang,
			value: post_value,
			command: data
		}]);
		$update();
	}
	const click_ir_change = (kitem, click_type)=>{
// 		let configStr = peripheral[kitem.device].prop.config[kitem.name];
		let configStr = kitem.device_config;
		if(!isset(configStr)){
			app.dialog.alert('error');
			return
		}
		
		let config = configStr.split('|');
		let airconfig = isset(config[2]) && config[2] != ',,,,NaN'?config[2].split(','):'25,1,2,1,0,1'.split(',')
		let mode_value = airconfig[5]>=0 ? airconfig[5] : 1; //thermostat mode
		let speed_vaule = airconfig[1]; //thermostat speed
		let swing_value = airconfig[3];
		let direction_value = airconfig[2];
		let temperature = airconfig[0]; //temperature
		switch (click_type) {
			case "ARC_MODE":
				if (mode_value == 1) {
					mode_value = 0
				} else if (mode_value == 2) {
					mode_value = 1
				} else if (mode_value == 0) {
					mode_value = 2;
				}
				break;
			case "ARC_SPEED":
				if(speed_vaule == 4){
					speed_vaule = 1;
				}else{
					speed_vaule++
				}
				break;
			case "ARC_SWING":
				swing_value = swing_value*1-1;
				if(swing_value < 0){
					swing_value = 1;
				}
				break;
			case "ARC_REDUCE_TEMP":
				if (temperature != 5) {
					temperature--;
				}
				break;
			case "ARC_ADD_TEMP":
				if (temperature != 32) {
					temperature++;
				}
				break;
		}
		//ir|0|tem,speed,direction,swing,onoff,mode
		const newConfigStr = `ir|0|${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`;
// 		peripheral[kitem.device].prop.config[kitem.name] = newConfigStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, newConfigStr);
		props.kitem.device_status = 1;
		props.kitem.device_config = newConfigStr;
		props.kitem.config = newConfigStr;
		
		let command = kitem.device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,click_type,`${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`);
		peripheral[kitem.device].sendIR(ref_command);
		//debugger
		$update();
	}
	erp.trigger_thermostat_defined_fun[props.kitem.device] = (kitem) => {
		//this function can change the ui
		if (isset(kitem.device_attachment_status)) {
			props.kitem.device_attachment_status = kitem.device_attachment_status;
			$update();
		}
	}
	$onMounted(() => {
		let element = $(`.curtain-subdevice .range-slider[data-id="${key}"]`);
		setTimeout(() => {
			if (props.kitem.device_button_group.startsWith('OPENCLOSE UART')) {
				let range_silder = app.range.create({
					el: `.range-slider[guid="${props.kitem.device}"]`,
					value: props.kitem.device_status || 0,
					min: 0,
					max: 100,
					draggableBar: false,
					label: true,
					step: 1,
					scale: true,
					scaleSteps: 5,
					scaleSubSteps: 4,
					on: {
						changed: range_change_fun_curtain,
					},
				});
			}else if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING')) {
				const v = Math.ceil((props.kitem.device_status*1.0 / 255.0) * 100.0) || 0;
				    let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
				    if(!isset(range_silder_list[range_key])){
    				    range_silder_list[range_key] = app.range.create({
    						el: `.range-slider[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`,
    						value: v,
    						min: 0,
    						max: 100,
    						draggableBar: false,
    						label: true,
    						step: 1,
    						scale: true,
    						scaleSteps: 5,
    						scaleSubSteps: 4,
    						on: {
    							changed: range_change_fun_dimming,
    						},
    					});
				    }
			}else if(props.kitem.device_button_group.startsWith('OPENCLOSE GANG') || props.kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
				let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
				    if(!isset(range_silder_list[range_key])){
    				    range_silder_list[range_key] = app.range.create({
    						el: `.range-slider[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`,
    						value: 0,
    						min: 0,
    						max: 100,
    						draggableBar: false,
    						label: true,
    						step: 1,
    						scale: true,
    						scaleSteps: 5,
    						scaleSubSteps: 4,
    						on: {
    							changed: range_change_fun_switch_curtain,
    						},
    					});
				    }
			}
		}, 0)
	});
	if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING')) {

		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex dimming-subdevice" style="height:67px!important;" guid="${
					props.kitem.guid
				}" gateway="${props.kitem.gateway}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
						<div class="row padding-tb flex-direction-column justify-content-center ${props.kitem.bluetooth== 0 && props.kitem.mobmob == 0 && !props.kitem.mesh?'disabled':''} ">
								<div class="col-100 medium-100 large-100">
										<div class="content display-flex justify-content-center" style="margin-left: 15px;margin-right:15px;">
												<div class="tip-title"><i class="icon material-icons" style="margin-right:8px;">brightness_low</i></div>
												<div class="range-slider range-slider-home-auto range-slider-init"
														button_group="${props.kitem.device_button_group}"
														guid="${props.kitem.device}"
														subdevice-name="${props.kitem.name}"
												></div>
												<div class="tip-title"><i class="icon material-icons" style="margin-left:8px;">brightness_high</i></div>
										</div>
										<div></div>
								</div>
						</div>
				</li>
				`;
	} else if (device_button_group.startsWith("OPENCLOSE UART")) {
		return () => $h`
				<li class="device home-scanned-peripheral display-flex curtain-subdevice" direction="standard" style="height:67px!important;" guid="${
					props.kitem.device
				}" bluetooth="${props.kitem.bluetooth_status}">
						<div class="row padding-tb flex-direction-column justify-content-center ${props.kitem.bluetooth== 0 && props.kitem.mobmob == 0 && !props.kitem.mesh?'disabled':''} ">
								<div class="col-100 medium-100 large-100">
										<div class="content display-flex justify-content-center" style="margin-left: 15px;margin-right:15px;">
												<div class="tip-title"><img src="${
													'https://my.yoswit.com/'
												}/files/app/close-curtain.svg" alt="" style="width:20px;height:20px;margin-right:8px;margin-top:5px;" /></div>
												<div class="range-slider range-slider-home-auto range-slider-init"
														button_group="${props.kitem.device_button_group}"
														guid="${props.kitem.device}"
														subdevice-name="${props.kitem.name}"
												></div>
												<div class="tip-title"><img src="${
													'https://my.yoswit.com/'
												}/files/app/open-curtain.svg" alt="" style="width:20px;height:20px;margin-left:8px;margin-top:5px;" /></div>
										</div>
										<div></div>
								</div>
						</div>
				</li>
			`;
	}else if(device_button_group.startsWith("OPENCLOSE GANG") || device_button_group.startsWith("RCU OPENCLOSE GANG")){
		return () => $h`
      <li class="device subdevice home-scanned-peripheral" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob}" slot-index="${props.kitem.config}" style="height:auto;">
          <div class="item-content subdevice-item-content" style="min-height: 0px;">
              <div class="item-inner" style="min-height: 0px;">
                  <div class="row" style="--f7-grid-gap:3px;padding-left:20px;padding-right:15px;">
                      <button class="col on_flag off_flag button button-large button-raised openclose cl" ref="0" @click="${()=>curtain_switch_custom(props.kitem,'close')}" command-type="Bluetooth" command="">
                          <div style="margin-left:-5px;"><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_right</i><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_left</i></div>
                      </button>
                      <button class="col on_flag off_flag button button-large button-raised stop" ref="n" @click="${()=>curtain_switch_custom(props.kitem,'stop')}" command-type="Bluetooth" command="">
                          <div><i class="material-icons" style="line-height:65px;font-size:18px!important;">pause</i></div>
                      </button>
                      <button class="col on_flag off_flag button button-large button-raised openclose op" ref="1" @click="${()=>curtain_switch_custom(props.kitem,'open')}" command-type="Bluetooth" command="">
                          <div style="margin-left:-7px;"><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_left</i><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_right</i></div>
                      </button>
                  </div>
              </div>
          </div>
      </li>
      `;
	}else if (device_button_group.startsWith('Thermostat')) {
		emitter.on(`thermostat_${props.kitem.device}`, (data) => {
			$update();
		})
		if (!isset(props.kitem.device_attachment_status)) {
			props.kitem.device_attachment_status = [0, 0, 0, 26, 26, 0].join(',');
		}
		let this_list = props.kitem.device_attachment_status.split(',')
		let mode_value = this_list[1]; //thermostat mode
		let speed_vaule = this_list[2]; //thermostat speed
		let temperature = this_list[3] == 0 ? 26 : this_list[3]; //temperature
		let room_temperature = this_list[4]; //room_temperature
		let humidity = this_list[5]; //humidity
		let mode_str = 4;
		let mode_ref = 0;
		if (mode_value == 1) {
			mode_ref = 1;
			mode_str = 5;
		} else if (mode_value == 2) {
			mode_ref = 2;
			mode_str = 2;
		}
		if (speed_vaule == 0) {
			speed_vaule = 1;
		}
		if (!temperature) {
			temperature = 26
		}
		//render the modefantemperature
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice" style="height:80px;" ref="${props.kitem.device_status}" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.mesh || 0}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center" style="--f7-grid-gap:3px;">
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'mode')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'fan')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'reduce')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'add')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith('BACNET LIGHTING SCENE')){
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,2)}" command-type="mode" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 1</div>
								</a>
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,3)}" command-type="fan" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 2</div>
								</a>
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,4)}" command-type="reduce" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 3</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if (device_button_group.startsWith('BACNET AIR CONDITIONER')) {
		let configStr = props.kitem.config;
		let config = configStr.split('|');
		console.log("config[5]",props.kitem)
		let airconfig = isset(config[5]) && config[5] != ',,,,NaN'?config[5].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[1]; //thermostat mode
		let speed_vaule = airconfig[2]; //thermostat speed
		// let swing_value = airconfig[3];
		// let direction_value = airconfig[2];
		let temperature = airconfig[3]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		props.kitem.device_status = airconfig[4];
		if (mode_value == 2) {
			mode_ref = 1;
			mode_str = 2;
		} else if (mode_value == 4) {
			mode_ref = 2;
			mode_str = 3;
		}else if (mode_value == 8) {
			mode_ref = 2;
			mode_str = 1;
		}else if (mode_value == 16) {
			mode_ref = 2;
			mode_str = 4;
		}
		if (speed_vaule == 2) {
			speed_vaule = 4;
		}else if(speed_vaule == 4){
			speed_vaule = 3;
		}else if(speed_vaule == 8){
			speed_vaule = 2;
		}
		if (!temperature) {
			temperature = 26
		}
		//render the modefantemperature
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center" style="--f7-grid-gap:3px;">
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_MODE')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_SPEED')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_REDUCE_TEMP')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_ADD_TEMP')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(props.kitem.device_button_group_type == 'Air Conditioner'){
		let configStr = props.kitem.device_config;
		let config = configStr.split('|');
		let airconfig = isset(config[2]) && config[2] != ',,,,NaN'?config[2].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[5]>=0 ? airconfig[5] : 1; //thermostat mode
		let speed_vaule = airconfig[1]; //thermostat speed
		let swing_value = airconfig[3];
		let direction_value = airconfig[2];
		let temperature = airconfig[0]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		props.kitem.device_status = airconfig[4];
		if (mode_value == 1) {
			mode_ref = 1;
			mode_str = 5;
		} else if (mode_value == 2) {
			mode_ref = 2;
			mode_str = 2;
		}
		if (speed_vaule == 0) {
			speed_vaule = 1;
		}
		if (!temperature) {
			temperature = 26
		}
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice" style="height:80px;" ref="${airconfig[4]}" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" device_config="${props.kitem.device_config}" button_group="${props.kitem.device_button_group}" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.mesh || 0}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_MODE')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_SPEED')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_SWING')}" command-type="ARC_SWING" guid="${props.kitem.device}" ref="${swing_value}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-swing-${swing_value?swing_value:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_REDUCE_TEMP')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:60px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_ADD_TEMP')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:60px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	} else {
		return () => $h`<div></div>`;
	}
}



export default async (props, ctx) => {
	const $f7 = ctx.$f7,
		$f7route = ctx.$f7route,
		$update = ctx.$update,
		$on = ctx.$on,
		$onBeforeMount = ctx.$onBeforeMount,
		$onMounted = ctx.$onMounted,
		$onBeforeUpdate = ctx.$onBeforeUpdate,
		$onUpdated = ctx.$onUpdated,
		$onBeforeUnmount = ctx.$onBeforeUnmount,
		$onUnmounted = ctx.$onUnmounted;
		let networkChangeFun;
		let updateTime = 0;
	emitter.off('refresh');
	emitter.on('refresh', async (data) => {
		//mainView.router.refreshPage();
		console.log("refresh");
		$update();
		setTimeout(() => {
			if(isset(data.page) && data.page == 'save_subdevice'){
				rooms = [];
				subdevices = [];
				range_silder_list = {};//init the dimming bar
				updateTime = new Date().getTime();
        setTimeout(()=>{
					mainView.router.refreshPage();
				},50)
      }
			initPage(2);
			scan();
		}, 500)
	});
	//if wifi failed change the wifi status
	if(networkChangeFun){
		emitter.off("onNetworkChange",networkChangeFun)
	}
	networkChangeFun = ()=>{
		if(window.http2.isDisconnect){
			$(`.room-box .signal-view-main`).each(function(element){
				$(this).find('.prioritys').removeClass('device-none');
			});
			// $(`.wifiicon`).each(function(element){
			// 	$(this).find("i").removeClass("text-color-green");
			// 	$(this).find("i").addClass("text-color-red");
			// 	$(this).find('i').text('wifi_off');
			// })
		}else{
			clearTimeout(idleTimer);
			if(mobileAsHubPopup){
				mobileAsHubPopup = null;
			}
			mobileAsHubStatus = false;
			mainView.router.refreshPage();
		}
	}
	emitter.on("onNetworkChange",networkChangeFun);
	
	emitter.off('device/reset');
	emitter.on('device/reset',async(data)=>{
		debugger
		if(data.guid){
			subdevices.forEach(item=>{
				if(item.device == data.guid){
					$(`li.device[guid="${data.guid}"]`).each(function(){
						$(this).find(".signal-view-main").attr("mobmob", "0");
						if($(this).find(".wifiicon i").length > 0){
							$(this).find(".wifiicon i").removeClass("text-color-green");
							$(this).find(".wifiicon i").addClass("text-color-red");
							$(this).find(".wifiicon i").text('wifi_off');
						}
					})
				}
			})
			$update();
		}
	})
	emitter.off('device/wifi/setup');
	emitter.on('device/wifi/setup',async(data)=>{
		if(data.guid){
			subdevices.forEach(item=>{
				if(item.device == data.guid){
					item.signalRfresh = true;
				}
			})
		}
		$update();
	})
	emitter.off('ha:device:firmware:upgrade');
	emitter.on('ha:device:firmware:upgrade',async(data)=>{
		if(data.guid){
			if(isset(peripheral[data.guid])){
				peripheral[data.guid].disconnect().then(()=>{

				}).catch(error=>{
					//if error, try to change the UI
					$(`.device[guid="${data.guid}"]`).find('.signal-view-main').attr('bluetooth',0);
				})
			}
		}
		$update();
	})
	// init variable,easy to seach ,initialization
	const title = $f7route.query.title ? $f7route.query.title : _('Smart Office');
	const isHomePage = !!$f7route.query.is_home_page;

	window.scanned_periperals = {};
	let page_margin_top = 48;
	let mobileAsHubStatus = false;
	let mobileAsHubPopup;
	//profile permission
	let profilePermision = true;
	let rooms = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_room)) : [];
	let subdevices = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_subdevice)) : [];
	let show_unassigned = false;
	let show_noroom = !rooms.length ? true : false;
	let show_nosubdevice = (rooms.length && !subdevices && !Object.keys(peripheral).length) ? true : false;
	let devices = erp.info.device ? JSON.parse(JSON.stringify(erp.info.device)) : [];
	let device_models = erp.doctype.device_model ? JSON.parse(JSON.stringify(erp.doctype.device_model)) : {};

	let device_button_groups = erp.info.device_button_group || {};
	let device_button_commands = erp.info.device_command || {};
	for (let i in device_button_groups) {
		device_button_groups[i].device_command = {};
		if (isset(device_button_groups[i].button_group_sub_list[0])) {
			let command_name = device_button_groups[i].button_group_sub_list[0].device_command;
			device_button_groups[i].device_command = device_button_commands[command_name];
		}
	}


	device_models = Object.values(device_models).reduce((acc, obj) => {
		acc[obj.name] = obj;
		return acc;
	}, {});
	let unassigned_subdevices = [];

	let profile_device = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_device)) : [];
	let scenesMap;
	let scenes = [];
	
	let idleTimer;
	const IDLE_TIME = 20000;
	const resetIdleTimer = ()=>{
		//console.log("this_comming");
		clearTimeout(idleTimer);
		idleTimer = setTimeout(()=>{
			console.log("20s active");
			const debounce_init = core_utils_debounce(initPopup,2000,{
					leading: true,
					trailing: false
			});
			debounce_init();
		},IDLE_TIME)
	}
	const handleUserActivity = core_utils_debounce(resetIdleTimer,2000,{
        leading: true,
        trailing: false
    });
	document.removeEventListener("touchstart", handleUserActivity);
	document.removeEventListener("touchmove", handleUserActivity);
	document.removeEventListener("click", handleUserActivity);
	setTimeout(()=>{
		document.addEventListener("touchstart", handleUserActivity);
		document.addEventListener("touchmove", handleUserActivity);
		document.addEventListener("click", handleUserActivity);
	},500)
	const clickForMobile = ()=>{
		initPopup();
	}
	const initPopup = ()=>{
		if(!mobileAsHubStatus){
			return
		}
		if(!mobileAsHubPopup){
			mobileAsHubPopup = app.popup.create({
							content : /*html*/`
							<div class="popup">
								<div class="page">
									<div class="navbar">
										<div class="navbar-bg"></div>
										<div class="navbar-inner">
											<div class="title">Mobile As Hub</div>
											<div class="right"><a  class="link popup-close"><i class="material-icons" style="font-size: 40px">cancel</i></a></div>
										</div>
									</div>
									<!-- style="background:rgba(0,0,0,.4);transition-duration:.4s;"  -->
									<div class="page-content" >
										<div class="block-title text-color-theme" style="overflow: initial;word-wrap: break-word;word-break: break-all;white-space: break-spaces;line-height: 32px;text-align: center;font-size:18px;">${_('This device is currently being used as a Mobile AS Hub')}</div>
										<div class="block display-flex flex-direction-row align-items-center justify-content-center" style="height:80%;width:100%;">
											<div class="moblie-as-hub-icon signal-tower">
												<div class="signal-wave"></div>
												<div class="signal-wave"></div>
												<div class="signal-wave"></div>
												<div class="signal-wave"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
							`,
						})
						mobileAsHubPopup.open();
		}else{
			mobileAsHubPopup.close();
			setTimeout(()=>{
				mobileAsHubPopup.open();
			},100)
		}
	}
	const initPage = async (pageType) => {
	    
        let res = (await db.get('peripheral')) || null;
        if (isset(res)) {
            const storedPeripheral = JSON.parse(res);
            const newStoredPeripheral = {};
            for(let guid in storedPeripheral){
                
                let exist = false;
                for(let i in profile_device){
                    if(profile_device[i].device == guid){
                        exist = true;
                    }
                }
                if(!exist) continue;
                
                // alert("1"+JSON.stringify(storedPeripheral[guid]));
                newStoredPeripheral[guid] = storedPeripheral[guid];
                
                
    			if (!isset(peripheral[guid])) {
    				peripheral[guid] = new Peripheral(storedPeripheral[guid]);
    			} else {
					if(guid == '6630356563646662363330641201501d'){
					}
    				peripheral[guid].update(storedPeripheral[guid]);
    			}
            }
            await db.set('peripheral', JSON.stringify(storedPeripheral));
        }
	
        // 	// please move these line to the very beginning if flow / page is changed.
        //     db.get('peripheral').then((data)=>{
        //         if(data){
        //             try{
        //                 // alert(data);
        //                 const storedPeripheral = JSON.parse(data);
        //                 for(let guid in storedPeripheral){
        //                     // alert("1"+JSON.stringify(storedPeripheral[guid]));
        //         			if (!isset(peripheral[guid])) {
        //         				peripheral[guid] = new Peripheral(storedPeripheral[guid]);
        //         			} else {
        // 						if(guid == '6630356563646662363330641201501d'){
        // 							console.log("storedPeripheral[guid]",storedPeripheral[guid])
        // 						}
        //         				peripheral[guid].update(storedPeripheral[guid]);
        //         			}
        //                 }
        //             }catch(e){
                        
        //             }
        //         }
        //     });
	  //get the profile permision
		
		rooms = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_room)) : [];
		subdevices = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_subdevice)) : [];
		profile_device = erp.info.profile ? JSON.parse(JSON.stringify(erp.info.profile.profile_device)) : [];
		show_nosubdevice = (rooms.length && !subdevices && !Object.keys(peripheral).length) ? true : false;
		devices = erp.info.device ? JSON.parse(JSON.stringify(erp.info.device)) : [];
		scenesMap = cloneDeep(erp.info.scene);
		for(let i in scenesMap){
			if(!scenesMap[i].is_enabled){
				scenes.push(scenesMap[i])
			}
		}
		if(scenes.length > 0){
			page_margin_top = 152;
			setTimeout(() => {
        const swiper = app.swiper.create('.swiper-container-auto', {
          speed: 200,
          spaceBetween: 20,
					autoplay : true
        });
      }, 1000);
		}
		profile_device = profile_device.reduce((acc, item) => {
			acc[item.name] = item;
			return acc;
		}, {});
		rooms.forEach(item => {
			let count = 0;
			subdevices.forEach(kitem => {
				if (kitem.profile_room === item.name) {
					count++;
				}
			})
			item.subdevices_count = count;
		});
		// init page data, start flow calculation
		subdevices.forEach(subdevice => {
			const vp = {};
			subdevice.signalRfresh = false;//refresh the signal item
			update_subdevice_by_device_button_group(subdevice, device_button_groups[subdevice['device_button_group']]);
			update_peripheral_by_subdevice(vp, subdevice);

			if (devices[subdevice.device]) {
				update_peripheral_by_device(vp, devices[subdevice.device])
				update_subdevice_by_device(subdevice, devices[subdevice.device]);
			}
			if (profile_device[subdevice.profile_device]) {
				update_peripheral_by_profile_device(vp, profile_device[subdevice.profile_device]);
				update_subdevice_by_profile_device(subdevice, profile_device[subdevice.profile_device]);

				if (device_models[profile_device[subdevice.profile_device].device_model]) {
					update_subdevice_by_device_model(subdevice, device_models[profile_device[subdevice.profile_device].device_model]);
				}
			}

			update_subdevice_by_peripheral(
				subdevice,
				peripheral[subdevice.device]?.getProp() || {}
			);

			if (!isset(peripheral[vp.guid])) {
				peripheral[vp.guid] = new Peripheral(vp);
			} else {
				peripheral[vp.guid].update(vp);
			}
		});
		$update();
		// init gateway list
		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway().toLowerCase()));
		const gatewayMap = {};
		for (let i in profile_device) {
			if (!profile_device[i].gateway || profile_device[i].gateway.trim() == "") continue;

			const gatewayhash = md5(md5(profile_device[i].gateway.toLowerCase()));
			if (selfgatewayhash == gatewayhash) { // self gateway, need to listen to cmd
				if(!isset(gatewayMap[`${gatewayhash}`])){
					gatewayMap[`${gatewayhash}`] = true;
					const cmd_topic = `cmd/${gatewayhash}`;
					core_mqtt_subscribe(cmd_topic, 0, false);
					emitter.off(cmd_topic);
					emitter.on(cmd_topic, on_gateway_commands_received);
					//if find this mobile as hub,should update the UI page
					mobileAsHubStatus = true;
					const debounce_init = core_utils_debounce(initPopup,2000,{
							leading: true,
							trailing: false
					});
					if(pageType != 2){
						debounce_init();
					}
					//resetIdleTimer();
				}
			} else { // other gateway, need to listen to status and will
				if(!isset(gatewayMap[`${gatewayhash}`])){
					gatewayMap[`${gatewayhash}`] = true;
					//check if gateway is online / offline
					let will_topic = '';
					let gatewayhashList = gatewayhash.split('-');
					if(gatewayhashList.length > 2){
						will_topic = `will/${gatewayhash}`;
					}else{
						will_topic = `will/${md5(md5(profile_device[i].gateway.toLowerCase()))}`;
					}
					
					core_mqtt_subscribe(will_topic, 1, false);
					emitter.off(will_topic);
					emitter.on(will_topic, on_gateway_will_changed);

					//get the devices' status from gateway
					const status_topic = `status/${gatewayhash}`;
					core_mqtt_subscribe(status_topic, 1, false);
					emitter.off(status_topic);
					emitter.on(status_topic, on_gateway_device_changed);
					
					//refresh gateway
					setTimeout(() => {
						core_mqtt_publish(`cmd/${gatewayhash}`, {
							"command": "Pubmsg",
							"function": "bleHelper.pubmsg",
							"params": "",
							"callback": "",
							"raw": ""
						}, 0, false, false, false).then(() => {

						}).catch(reject => {});
					}, 3000)
				}
			}
		}
		
		// init profile topic
		if(!isset(erp['checksum'])) erp['checksum'] = {};
		if(isset(erp.info.profile)){
    		const profilehash = md5(md5(erp.info.profile.name));
    
    		const cmd_topic = `status/${profilehash}`;
    		core_mqtt_subscribe(cmd_topic, 0, false);
    		emitter.off(cmd_topic);
    		emitter.on(cmd_topic, function(data){
    		  //  alert("Receive2 = "+JSON.stringify(data));
						
        		let message = data.message;
        		
        		if (isset(message) && message) {
        		    
        			let deviceObj = JSON.parse(message);
        		    if(isset(erp.checksum['profile_mqtt']) && erp.checksum['profile_mqtt']==md5(JSON.stringify(deviceObj))){
        		        return;
        		    }
        		    erp.checksum['profile_mqtt'] = md5(JSON.stringify(deviceObj));
        			
        			for(let guid in deviceObj.Device){
        			    let p = {
        				    guid:guid,
        				    mac_address:deviceObj.Device[guid].mac_address,
        				    status:{
        				        mqtt: deviceObj.Device[guid].status,
        				    }
        				};
            			if (!isset(peripheral[guid])) {
            				peripheral[guid] = new Peripheral(p);
            			} else {
            				if(peripheral[guid].getProp().status.mqtt[1] < p.status.mqtt[1]){
            				    peripheral[guid].update(p);
            				}
            			}
        			}
        			
        			for(let subdevice_name in deviceObj.Virtual){
        			    let guid = deviceObj.Virtual[subdevice_name].guid;
        				
        			    if (!isset(peripheral[guid])) {
        			    	continue;
            			}
            			
            			if(!isset(peripheral[guid].getProp().config[subdevice_name]) || !isset(peripheral[guid].getProp().config[subdevice_name].mqtt)){
            			    peripheral[guid].setMqttGangConfig(subdevice_name, deviceObj.Virtual[subdevice_name].config);
        				    continue;
            			}
            			
        				if(peripheral[guid].getProp().config[subdevice_name].mqtt[1] >= deviceObj.Virtual[subdevice_name].config[1]){
        			        continue;
        				}
        				
        				peripheral[guid].setMqttGangConfig(subdevice_name, deviceObj.Virtual[subdevice_name].config);
        				
        			 //   alert("deviceObj.Virtual[subdevice_name].config="+JSON.stringify(deviceObj.Virtual[subdevice_name].config));
        				// subdevices.forEach(subdevice => {
        				//     if(subdevice.name == subdevice_name){
        				//         subdevice.config = peripheral[guid].getGangConfig(subdevice_name);
        				//         alert(subdevice.config);
        				//     }
        				// });
        			}
        		}
    		});
		}
		
	}
	const home_auto_click_scene = (item)=>{
		//excute the scene
		//mian excute the action command
		//first get the action guid ,compare the device to get the action command
	}
	const getProfilePermision = ()=>{
		return new Promise((resolve,reject)=>{
			http2.request(
          encodeURI(`/api/method/appv6.getProfileUserPermision?name=${erp.info.profile.name}`),
          {
            method: 'GET',
            serializer: 'json',
            responseType: 'json',
            timeout: 3,
          }
        ).then(res=>{
					let userList = [];
					let owner = '';
					if(res.data.permision){
						userList = res.data.permision.shared;
						owner = res.data.permision.owner;
						let selfUser = users[users.current].usr;
						userList.forEach(userItem=>{
							if(userItem.user == selfUser && userItem.write == 1){
								profilePermision = true
							}
						});
						if(owner == selfUser){
							profilePermision = true
						}
						resolve({allow : profilePermision});
						//userList = userList.map((item)=>item.owner)
						console.log("userList",userList);
					}
				}).catch(error=>{
					reject(error);
				})
		})
	}
	//ui functions
	const refresh = async (e, done) => {
		await ha_profile_ready();
		// init gateway list
		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway().toLowerCase()));
		for (let i in profile_device) {
			if (!profile_device[i].gateway || profile_device[i].gateway.trim() == "") continue;

			const gatewayhash = md5(md5(profile_device[i].gateway.toLowerCase()));
			if (selfgatewayhash == gatewayhash) { // self gateway, need to listen to cmd

				const cmd_topic = `cmd/${gatewayhash}`;
				core_mqtt_subscribe(cmd_topic, 0, false);
				emitter.off(cmd_topic);
				emitter.on(cmd_topic, on_gateway_commands_received);

			} else { // other gateway, need to listen to status and will

				//check if gateway is online / offline
				const will_topic = `will/${gatewayhash}`;
				core_mqtt_subscribe(will_topic, 1, false);
				emitter.off(will_topic);
				emitter.on(will_topic, on_gateway_will_changed);

				//get the devices' status from gateway
				const status_topic = `status/${gatewayhash}`;
				core_mqtt_subscribe(status_topic, 1, false);
				emitter.off(status_topic);
				emitter.on(status_topic, on_gateway_device_changed);

				//refresh gateway
				setTimeout(() => {
					core_mqtt_publish(`cmd/${gatewayhash}`, {
						"command": "Pubmsg",
						"function": "bleHelper.pubmsg",
						"params": "",
						"callback": "",
						"raw": ""
					}, 0, false, false, false).then(() => {

					}).catch(reject => {});
				}, 3000)
			}
		}
		done();
	};

	const render_ui = () => {
		show_noroom = !rooms.length ? true : false;
		show_nosubdevice = (rooms.length && !subdevices && !Object.keys(peripheral).length) ? true : false;
		refresh_unassigned();

		$update();
	};
	const onDeleted = async (sudevice_item) => {
		$(`.curtain-subdevice[guid="${sudevice_item.guid}"]`).remove();
		$(`.subdevice[guid="${sudevice_item.guid}"]`).remove();
		$(`.iaq-subdevice[guid="${sudevice_item.guid}"]`).remove();
		let this_list = erp.info.profile.profile_subdevice;
		let profile_device = erp.info.profile ? erp.info.profile.profile_device : [];
		//have case:more sudevice mapping 1 profile device
		let count_list = this_list.filter((zitem) => zitem.profile_device === sudevice_item.profile_device);
		let del_record = [];
		let filteredList = this_list.filter(kitem => {
			if (sudevice_item.name == kitem.name) {
				del_record.push(sudevice_item);
				return false;
			}
			return true;
		})
		this_list = filteredList;
		erp.info.profile.profile_subdevice = filteredList;
		if (count_list.length == 1) {
			let profile_device_index = profile_device.findIndex((z) => z.name === sudevice_item.profile_device);
			profile_device.splice(profile_device_index, 1);
		}
		//update the filter of the profile_room_device list
		subdevices.forEach((item, index) => {
			del_record.forEach((kitem, kindex) => {
				if (kitem.name == item.name) {
					subdevices.splice(index, 1);
				}
			})
		})
		//update profile
		try {
			let status = await http.request(encodeURI(`/api/resource/Profile/${erp.info.profile.name}`), {
				method: 'PUT',
				serializer: 'json',
				responseType: 'json',
				data: {
					profile_device: profile_device,
					profile_subdevice: this_list,
				},
			});
		} catch (err) {
			const toast = app.toast.create({
				position: 'bottom',
				closeTimeout: 3000,
				text: err,
			});

			toast.open();
		}
		//init();
		$update();
		mainView.router.refreshPage();
		//check subdevice length is null,delete the profile device
	};
	const refresh_unassigned = () => {
		let _unassigned_subdevices = JSON.parse(JSON.stringify(unassigned_subdevices));
		for (let guid in peripheral) {
			let p = peripheral[guid].getProp();

			if (p.disappear || !p.rssi) { // hide subdevice in unassigned
				for (let i in _unassigned_subdevices) {
					if (_unassigned_subdevices[i].device != guid) continue;
					unassigned_subdevices[i].disappear = true;
				}
				continue;
			}
			//check the local rssi
			let local_rssi = erp.info.device_gateway ? erp.info.device_gateway.rssi_filter : -60;
			if (p.rssi < local_rssi) {
				continue;
			}
			// reshow subdevice in unassigned
			for (let i in _unassigned_subdevices) {
				if (_unassigned_subdevices[i].device != guid) continue;
				unassigned_subdevices[i].disappear = false;
			}
			//check if device setting config
			if(isset(erp.info.device[guid])){
				let thisDeviceMap = cloneDeep(erp.info.device[guid]);
				let settings = thisDeviceMap.settings;
				let rcuSettings = [];
				let device_mode = thisDeviceMap.device_mode;
				let device_model = thisDeviceMap.device_model;
				settings.forEach(zitem=>{
					if(zitem.setting_type.startsWith('active_io')){
						let inputStatus = zitem.setting == 'input'?true:false;
						let status = zitem.setting == 'output'?true:false;
						if(inputStatus || status){
							rcuSettings.push({
								name: zitem.setting_type.replace("active_io_",""),
								inputStatus : inputStatus,
								status : status,
								device_mode : device_mode,
								device_model : device_model
							})
						}
					}
				});
				rcuSettings.forEach(kitem=>{
					let title = `RCU INPUT${kitem.name}`;
					let this_button_group = `RCU INPUT${kitem.name}`;
					//filter the gang of 33 32 31
					if(kitem.name == 33 || kitem.name == 32 || kitem.name == 31){
						return;
					}
					if(kitem.status){
						title = `RCU OUTPUT${kitem.name}`;
						this_button_group = `RCU OUTPUT${kitem.name}`
					}
					const u_subdevice = {
						lastDiscoverDate: p.lastDiscoverDate,
						rssilv: p.rssilv || 0,
						bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
						connected: p.connected,
						connecting: p.connecting,
						device: p.guid,
						device_button_group: this_button_group,
						device_mode: kitem.device_mode,
						device_model: kitem.device_model,
						device_name: p.name,
						name: title, //name is means device model and sort
						password: p.password,
						thumb: erp.doctype.device_model['0346'].image,
						device_status: 0,
						device_config: '',
						device_attachment_status: ''
					};
					let cont = false;
					for (let u_subdevice of _unassigned_subdevices) {
						if (u_subdevice.device != guid) continue;
						if (u_subdevice.device_button_group == this_button_group) {
							cont = true;
							break;
						}
					}
					if (cont) return;
					unassigned_subdevices.push(u_subdevice);
				})
			}
			if (erp.doctype.device_model[p.hexModel]) {
				for (let tp of erp.doctype.device_model[p.hexModel]['device_default_template']) {
					if (!tp.display_in_unassigned) continue;
					//if 
					if(p.hexModel == '0346'){

					}else{
						if ((p.device_mode && p.device_mode != tp.mode) || !p.device_mode && tp.mode != erp.doctype.device_model[p.hexModel].mode) continue;
					}
					


					let cont = false;
					for (let subdevice of subdevices) {
						if (subdevice.device != guid) continue;
						if (subdevice.device_button_group == tp.device_button_group) {
							cont = true;
							break;
						}
						if(tp.device_button_group.startsWith("RCU DIMMING")){
							let config = Math.ceil(parseInt(tp.device_button_group.replace("RCU DIMMING",""))/2);
							//console.log("config",config);
							if(parseInt(subdevice.config) == config && subdevice.device == guid && !subdevice.device_button_group.startsWith("RCU DIMMING")){
								//console.log("subdevice",subdevice)
								cont = true;
								break;
							}
						}
					}
					if (cont) continue;

					for (let u_subdevice of _unassigned_subdevices) {
						if (u_subdevice.device != guid) continue;
						if (u_subdevice.device_button_group == tp.device_button_group) {
							cont = true;
							break;
						}
					}
					if (cont) continue;
					let this_gang = 1;
					if(tp.device_button_group.startsWith("ONOFF GANG")){
						this_gang = tp.device_button_group.replace("ONOFF GANG","");
					}else if(tp.device_button_group.startsWith("IR Setup")){
						this_gang = "IR Setup";
					}else if(tp.device_button_group.startsWith("OPENCLOSE GANG")){
						this_gang = tp.device_button_group.replace("OPENCLOSE GANG","");
					}else if(tp.device_button_group.startsWith("Thermostat")){
						this_gang = "";
					}
					let title = `${erp.doctype.device_model[p.hexModel].name} ${this_gang}`;
					if(tp.device_button_group.startsWith("IR Setup")){
						title = `${this_gang}`;
					}
					if(tp.device_button_group.startsWith("RCU DIMMING")){
						let rcu_gang = tp.device_button_group.replace("RCU DIMMING","");
						let display_name = '';
						if(rcu_gang == 1){
							display_name = `YO780-2GD 1-1`;
						}else if(rcu_gang == 2){
							display_name = `YO780-2GD 1-2`;
						}else if(rcu_gang == 3){
							display_name = `YO780-2GD 2-1`;
						}else if(rcu_gang == 4){
							display_name = `YO780-2GD 2-2`;
						}else if(rcu_gang == 5){
							display_name = `YO780-2GD 3-1`;
						}else if(rcu_gang == 6){
							display_name = `YO780-2GD 3-2`;
						}else if(rcu_gang == 7){
							display_name = `YO780-2GD 4-1`;
						}else if(rcu_gang == 8){
							display_name = `YO780-2GD 4-2`;
						}else if(rcu_gang == 9){
							display_name = `YO780-2GD 5-1`;
						}else if(rcu_gang == 10){
							display_name = `YO780-2GD 5-2`;
						}
						title = display_name
					}
					if(tp.device_button_group.startsWith("RCU OUTPUT") || tp.device_button_group.startsWith("DOOR SIGN")){
						//should check if set unshow in device setting
						if(isset(erp.info.device[guid])){
							let settings = erp.info.device[guid].settings;
							let doorBellStatus = true;
							let cleanDnd = true;
							settings.forEach(zitem=>{
								if(zitem.setting_type.startsWith('door_bell')){
									if(zitem.setting == 0){
										doorBellStatus = false;
									}
								}
								if(zitem.setting_type.startsWith('clean_dnd')){
									if(zitem.setting == 0){
										cleanDnd = false;
									}
								}
							})
							if(!doorBellStatus && tp.device_button_group.startsWith("RCU OUTPUT")){
								continue;
							}
							if(!cleanDnd && tp.device_button_group.startsWith("DOOR SIGN")){
								continue;
							}
						}
						title = tp.device_button_group;
					}
					const u_subdevice = {
						lastDiscoverDate: p.lastDiscoverDate,
						rssilv: p.rssilv || 0,
						bluetooth: p.connected ? 1 : (p.connecting ? 2 : 0),
						connected: p.connected,
						connecting: p.connecting,
						device: p.guid,
						device_button_group: tp.device_button_group,
						device_mode: tp.mode,
						device_model: erp.doctype.device_model[p.hexModel].name,
						device_name: p.name,
						name: title, //name is means device model and sort
						password: p.password,
						thumb: erp.doctype.device_model[p.hexModel].image,
						device_status: peripheral[guid].getGangStatus(tp.device_button_group),
						device_config: peripheral[guid].getGangConfig(tp.device_button_group),
						device_attachment_status: peripheral[guid].getAttachmentStatus(tp.device_button_group).join(',')
					};

					unassigned_subdevices.push(u_subdevice);
				}
			}
		}

		show_unassigned = false;
		for (let i in unassigned_subdevices) {
			if (!unassigned_subdevices[i].disappear) {
				show_unassigned = true;
				break;
			}
		}
	};

	const collapse_room = (index) => {
		const id = `room-${index}-div-title`;
		const room_id = `room-${index}-div`;
		let icon_name = $(`#${id}`).find('i').text();
		if (icon_name == 'expand_more') {
			$(`#${room_id} .room-item`).hide();
			$(`#${id}`).find('i').text('chevron_right');
		} else {
			$(`#${room_id} .room-item`).show();
			$(`#${id}`).find('i').text('expand_more');
		}
	};

	const show_room = (index, count) => {
		let item_id = `room-bar-title-${index}`;
		let id = `room-${index}-div`;
		$('.tab-link').removeClass('tab-link-active');
		$(`#${item_id}`).addClass('tab-link-active');
		if (index == 0) {
			$('.room-null').addClass('device-none');
			$('.media-list').show();
		} else {
			$('.media-list').hide();
			$(`#${id}`).show();
			if (count == 0) {
				$('.room-null').addClass('device-none');
				let html = `
						<div class="block room-null" style="text-align: center">
						<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
						<p>${_('You don\'t have any devices, create one')}</p>
						</div>
						<div class="block block-strong room-null">
						<p class="row">
							<a class="col button button-large" href="/mobile-app/yoswit-device-type"
							>${ _('Create Device') }</a
							>
						</p>
						</div>
					`;
				$(`#${id}`).html(html);
			} else {
				$('.room-null').addClass('device-none');
			}
		}
	};
	const changeRangeBarUi = (guid, device_button_group, present_value) => {
		$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`)
			.find('.range-bar-active')
			.css({
				width: present_value + '%',
			});
		$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`)
			.find('.range-knob-wrap')
			.css({
				left: present_value + '%',
			});
		if (present_value > 1) {
			$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`).removeClass('range-slider-min');
		} else {
			$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${device_button_group}"]`).addClass('range-slider-min');
		}
	}
	//bluetooth functions
	const on_peripheral_changed = (p) => {
		if(p.guid == '3038623631666565383663361203491d'){
			//console.log('comming')
		}
		setTimeout(() => {
			for (let i in subdevices) {
				if (subdevices[i].device == p.guid) {
					update_subdevice_by_peripheral(subdevices[i], p);
				}
			}
			for (let i in unassigned_subdevices) {
				if (unassigned_subdevices[i].device == p.guid) {
					update_subdevice_by_peripheral(unassigned_subdevices[i], p);
				}
			}

			render_ui();
		}, 10);
	};
	emitter.off('on_peripheral_changed',on_peripheral_changed);
	emitter.on('on_peripheral_changed', on_peripheral_changed);

	const on_discovery = (p) => {
		setTimeout(() => {
			delete p.password;
			delete p.connected;
			delete p.connecting;
			scanned_periperals[p.id] = p;
			if (!isset(peripheral[p.guid])) {
				peripheral[p.guid] = new Peripheral(p);
			} else {
				peripheral[p.guid].update(p);

			}

			render_ui();
		}, 10);
	};

	const scan = async () => {
		await bleManager.stopScan();
		await bleManager.wait(200);

		bleManager.scan(on_discovery, async (error) => {
		    //alert(error);
				app.dialog.alert(_(erp.get_log_description(error)));
				$('.signal-view-main').each(function(element){
					$(this).attr('signal',0);
				})
				//mainView.router.refreshPage();
// 			await bleManager.wait(5000);
// 			scan();
		});
	};

	// helper function
	const update_subdevice_by_peripheral = async(s, p) => {
		let device_status = p.guid ? peripheral[p.guid].getGangStatus(s.device_button_group) : 0;
		let device_config = p.guid ? peripheral[p.guid].getGangConfig(s.name) : 'ir|0|25,1,2,1,0,1'; //ir|0|25,1,2,1,0,1
		
		if(p.guid == '30346565303331666337376212012e1d'){
			//debugger
			//console.log(s.device_button_group)
		}
		s['device_config'] = device_config;
		s['rssilv'] = p.rssilv || 0;
		s['mn_head_set'] = p.mn_head_set || 0;
		s['mn_head_connected'] = p.mn_head_connected || 0;
		s['mn_tail_set'] = p.mn_tail_set || 0;
		s['mn_tail_connected'] = p.mn_tail_connected || 0;
		s['bluetooth'] = p.connected ? 1 : (p.connecting ? 2 : 0);
		s['mobmob'] = p.is_mobmob;
		s['is_mobile_gateway'] = p.is_mobile_gateway;
		s['connecting'] = p.connecting;
		s['connected'] = p.connected;
		s['device_attachment_status'] = `0,0,0,26,26,0`;
		if(!s['click_status']){
			s['device_status'] = device_status;
		}
		//s['device_status'] = device_status;
		let hexModel = p.hexModel;
		if (hexModel == '021B') {
			//thermostat
			s['device_attachment_status'] = peripheral[p.guid].getAttachmentStatus(s.device_button_group).join(',');
			let list = peripheral[p.guid].getAttachmentStatus(s.device_button_group);
			if (isset(erp.trigger_thermostat_defined_fun) && isset(erp.trigger_thermostat_defined_fun[p.guid])) {
				erp.trigger_thermostat_defined_fun[p.guid](s);
			}
		} else if (s.device_button_group.startsWith("DIMMING") || s.device_button_group.startsWith("RCU DIMMING")) {
			//dimming
			let range_key =  `${s.device}_${s.device_button_group}`;
			if(isset(range_silder_list[range_key])){
    			const v = Math.ceil((device_status*1.0 / 255.0) * 100.0) || 0;
					// console.log("subdevice",s.title);
					// console.log("peripheral[p.guid]",peripheral[p.guid].prop.status)
					// console.log("v",v)
            	if($(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`).length){
									$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`)
                		.find('.range-bar-active')
                		.css({
                			width: v + '%',
                		});
                	$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`)
                		.find('.range-knob-wrap')
                		.css({
                			left: v + '%',
                		});
                	if (v > 1) {
                		$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`).removeClass('range-slider-min');
                	} else {
                		$(`.page-current .range-slider-home-auto[guid="${p.guid}"][button_group="${s.device_button_group}"]`).addClass('range-slider-min');
                	}
                }
			}
		}else if(s.device_button_group.startsWith("OPENCLOSE UART")){
			//debugger
			if(!s['click_status']){
				//revert
				if(s.device_button_group.startsWith("OPENCLOSE UART REVERSE")){
					if(device_status > 100){
						device_status = 0;
					}else{
						device_status = 100 - device_status*1;
					}
					//s.device_status = device_status;
				}
			}
			if(device_status > 100){
					device_status = 0;
			}
			//openclose uart
			setTimeout(()=>{
				changeRangeBarUi(p.guid, s.device_button_group, device_status);
			},200)
		}else if(s.device_button_group.startsWith("4in1 Sensor")){
			//4in1 sensor
			//console.log("device_status",device_status);
			//console.log("p.guid",p.guid);
			if (device_status > 0) {
          //have people;
					setTimeout(()=>{
						$("li.device[guid='" + p.guid + "'] .rf-sensor i").html('directions_walk');
					},500)
					console.log($("li.device[guid='" + p.guid + "'] .rf-sensor i"));
        } else {
          //$("li.device[guid='" + p.guid + "'] .rf-sensor i").text('block');
        }
		}else if(s.device_button_group.startsWith("DOOR SIGN")){
			//this must be check the 81(clear) and 82(dnd)
			let gangs = peripheral[p.guid].prop.status.control;
			console.log("gangs",gangs)
			let clear = gangs[0][80];
			let dnd = gangs[0][81];
			s['dnd'] = dnd;
			s['clear'] = clear;
			// console.log("clear",clear);
			// console.log("dnd",dnd);
		}
	};
	const update_subdevice_by_device = (s, p) => {};
	const update_subdevice_by_profile_device = (s, p) => {
		s['password'] = p.password;
		s['device_model'] = p.device_model;
		s['device_name'] = p.device_name.substring(0,12);
		s['network_id'] = p.network_id;
		s['network_position'] = p.network_position;
	};
	const update_subdevice_by_device_model = (s, p) => {
		s['thumb'] = p.image;
		s['device_mode'] = s.device_mode ? s.device_mode : p.device_mode;
	};
	const update_subdevice_by_device_button_group = (s, p) => {
		if(!isset(p)) return
		s['device_button_group_type'] = p?p.device_type:'';
		s['device_button_group_list'] = p?p.button_group_list:'';
		s['device_button_group_sub_list'] = p.button_group_sub_list;
		s['device_command'] = p.device_command;
	};


	const update_peripheral_by_subdevice = (s, p) => {
		s['gangs'] = [0, 0, 0, 0, 0, 0, 0, 0];
		if(isset(p.device) && p.device!=""){
    		s['guid'] = p.device;
    		s['hexModel'] = p.device.slice(-6, -2).toUpperCase();
    		s['hexBatch'] = p.device.slice(-2).toUpperCase();
    		s['device_mode'] = p.device_mode || 'Unknown';
		}
	};
	const update_peripheral_by_device = (s, p) => {
		s['device_mode'] = s['device_mode'] == 'Unknown' ? p.device_mode : s['device_mode'];
		s['mac_address'] = p.mac_address;
		s['firmware'] = p.firmware;
	};
	const update_peripheral_by_profile_device = (s, p) => {
		s['name'] = p.device_name;
		s['password'] = p.password;
		s['gateway'] = p.gateway;
		s['default_connect'] = p.default_connect;
		s['network_id'] = p.network_id;
		s['network_position'] = p.network_position;
	};

	// mqtt callback
	const on_gateway_will_changed = (data) => {
		//console.log(data);
		let is_mobmob = 1;
		let is_mobile_gateway = 0;
		if (data.message == "Offline") {
			is_mobmob = 0;
		}

		const selfgatewayhash = md5(md5(deviceInfo.getDeviceGateway().toLowerCase()));
		for (let guid in peripheral) {
			let p = peripheral[guid].getProp();
			if (!p.gateway) {
				peripheral[guid].update({
					'is_mobmob': 0
				});
				continue;
			}
			if (p.gateway.trim() == "") {
				peripheral[guid].update({
					'is_mobmob': 0
				});
				continue;
			}
			let checkhash = '';
			console.log('p.gateway.split',p.gateway.split('-').length)
			if(p.gateway.split('-').length <= 2){
				checkhash = `will/${md5(md5(p.gateway.toLowerCase()))}`
			}else{
				checkhash = `will/${md5(md5(p.gateway))}`;
				if(checkhash == data.topic){
					//debugger
					is_mobile_gateway = 1;
				}
			}
			console.log('checkhash',checkhash)
			if (`will/${selfgatewayhash}` == checkhash) {
				
				peripheral[guid].update({
					'is_mobmob': 0,
				});
				continue;
			}

			if (checkhash != data.topic) continue;
			peripheral[guid].update({
				'is_mobmob': is_mobmob,
				'is_mobile_gateway' : is_mobile_gateway
			});
		}
	};

	const on_gateway_device_changed = (data) => {
		let message = data.message;
		if (isset(message) && message) {
			let deviceObj = JSON.parse(message);
			let deviceInfo = deviceObj.Info;
			deviceInfo.retain = data.retain;
			let guid = deviceInfo.Guid;
			if (isset(guid) && guid) {
				let deviceItem = window.peripheral[guid].prop;
				let manufacturing_data = deviceInfo.manufacturing_data;
				if(isset(deviceObj.Thermostat)){
					if((deviceItem.rssi >= 0 || !isset(deviceItem.rssi)) && (isset(data.retain) && !data.retain)){
						//have no ble 
						let thermostat = deviceObj.Thermostat;
						window.peripheral[guid].prop.status.mobmob[0][42] = thermostat.power;
						window.peripheral[guid].prop.status.mobmob[0][43] = thermostat.mode;
						window.peripheral[guid].prop.status.mobmob[0][44] = thermostat.fan;
						window.peripheral[guid].prop.status.mobmob[0][45] = thermostat.set_temp;
						window.peripheral[guid].prop.status.mobmob[0][46] = thermostat.temp;
						window.peripheral[guid].prop.status.mobmob[1] = DateFormatter.format((new Date(new Date().getTime())), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");		
						window.peripheral[guid].onPropChanged();
					}
				}
				if (isset(manufacturing_data) && manufacturing_data) {
					let hexModel = deviceItem.hexModel;
					if(hexModel == '0351'){
						//curtain motor
						//debugger
						if(isset(peripheral[guid])){
							peripheral[guid].onChangeGateway(deviceInfo)
						}
					}else if (hexModel == '0346') {
						//RCU
						//return
						//update the virtual status
						let virtualDataList = manufacturing_data.split("130504");
						let rcuStatus = virtualDataList[1];
						let statusByteList = splitBytesAndConvertToBinaryArray(rcuStatus);
						$(`.home-scanned-peripheral[guid="${guid}"][button_group="SCENE MUTIWAY ONOFF GANG1"]`).each(function(item){
							
							let config = $(this).attr("config")*1;
							$(this).find(".rcu-virtual-button").attr("ref",statusByteList[config-1]);
						})
						//randar
						let inputDataList = manufacturing_data.split("110304");
						let inputStatus = inputDataList[1].substring(0,8);
						console.log("inputDataList",inputDataList)
						console.log("inputStatus",inputStatus);
						let inputStatusByteList = splitBytesAndConvertToBinaryArray(inputStatus);
						console.log("inputStatusByteList",inputStatusByteList);
						$(`.home-scanned-peripheral[button_group="4in1 Sensor"]`).each(function(item){
							let config = $(this).attr("config")*1;
							let guid = $(this).attr("guid");
							console.log("config",config);
							//signal status,no ble 
							if(!isset(window.peripheral[guid])) return false;
							let thisDeviceMap = window.peripheral[guid].prop;
							if((thisDeviceMap.rssi >= 0 || !isset(thisDeviceMap.rssi)) && (isset(data.retain) && !data.retain)){
								window.peripheral[guid].prop.status.mobmob[0][49] = inputStatusByteList[config-1]>0?1:0;
								window.peripheral[guid].prop.status.mobmob[1] = DateFormatter.format((new Date(new Date().getTime())), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");		
								window.peripheral[guid].onPropChanged();
							}
						})
						let rcuDataList = tindyRcuData(manufacturing_data);
						
						//overflow the status
						const indexMap = {
								'01': [32, 33],
								'02': [34, 35],
								'03': [36, 37],
								'04': [38, 39],
								'05': [40, 41]
						};
						rcuDataList.forEach(item=>{
							if (item.type === '02' && item.index in indexMap) {
									const [firstIndex, secondIndex] = indexMap[item.index];
									deviceItem.status['mobmob'][0][firstIndex] = parseInt(item.data.substring(0, 2), 16);
									deviceItem.status['mobmob'][0][secondIndex] = parseInt(item.data.substring(2, 4), 16);
							}
						})
						deviceItem.status['mobmob'][1] = deviceInfo.date;
						//if this gateway status date > contorl status date,overflow
						if(deviceItem.status['mobmob'][1] >= deviceItem.status['control'][1]){
							
							deviceItem.status['control'][0] = deviceItem.status['mobmob'][0];
							// deviceItem.status['control'][1] = deviceInfo.date;
							//update the last value
							for (let i = 0; i < deviceItem.status.last[0].length; i++) {
									if (deviceItem.status['mobmob'][0][i] > 0) {
										deviceItem.status.last[0][i] = deviceItem.status['mobmob'][0][i];
									}
							}
							
						//change ui
						rcuDataList.forEach(item => {
							subdevices.forEach(kitem => {
								let button_group = kitem.device_button_group;
								let slot_index = kitem.config;
								if (button_group.startsWith("RCU DIMMING") && item.type == '02' && item.index == slot_index) {
									let this_gang = parseInt(button_group.replace("RCU DIMMING", ""));
									let dimming_gang = this_gang - (2 * (parseInt(slot_index) - 1));
									let this_ref = ``;
									this_ref = dimming_gang == 1 ? parseInt(item.data.substring(0, 2), 16) : parseInt(item.data.substring(2, 4), 16);
									let gangs = window.bleHelper.getGangId(button_group) * 1;
									// deviceItem.status['mobmob'][0][gangs] = this_ref;
									// //deviceItem.status['control'][0][gangs] = this_ref;
									// deviceItem.status['mobmob'][1] = deviceInfo.date;
									
									let device_status = window.peripheral[guid].getGangStatus(button_group);
									kitem.device_status = device_status;
									console.log("device_status-----------------------------------------",device_status)
									
									$update();
									// if($(`.home-scanned-peripheral[guid="${guid}"][button_group="${button_group}"]`).length){
									// 	$(`.home-scanned-peripheral[guid="${guid}"][button_group="${button_group}"]`).find(".on_flag").attr("ref",device_status>0?1:0)
									// }
									if($(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`).length){
										const v = Math.ceil((device_status*1.0 / 255.0) * 100.0) || 0;
										$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`)
										.find('.range-bar-active')
                		.css({
                			width: v + '%',
                		});
										$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`)
										.find('.range-knob-wrap')
                		.css({
                			left: v + '%',
                		});
										if(v>0){
											$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`).removeClass('range-slider-min');
										}else{
											$(`.page-current .range-slider-home-auto[guid="${guid}"][button_group="${button_group}"]`).addClass('range-slider-min');
										}
									}
									//changeRangeBarUi(guid, button_group, device_status);
									//emitter.emit('on_peripheral_changed', deviceItem);
								}
							})
						});
						}
					}
				}
				//gateways device
				if(isset(deviceObj.Device)){
					let mobmobDevices = deviceObj.Device;
					for(let thisGuid in mobmobDevices){
						if(isset(peripheral[thisGuid])){
							//get the default connect
							let profile_devices = cloneDeep(erp.info.profile.profile_device);
							profile_devices.forEach((item)=>{
								if(item.device == thisGuid){
									mobmobDevices[thisGuid].default_connect = item.default_connect
								}
							})
							let deviceItme = peripheral[thisGuid].prop;
							let manufacturing_data = deviceItme.manufacturing_data;
							peripheral[thisGuid].onChangeGateway(mobmobDevices[thisGuid])
						}
					}
				}
			}
		}
	};

	const on_gateway_commands_received = (data) => {
		let message = JSON.parse(data.message);
		if (message.data.command != 'Control') {
			return;
		}
		if (message.data.function != 'bleHelper.perform') {
			return;
		}
		// [{"action":"write","guid":"61343334663137396232663312015a10","mac_address":"a4:34:f1:79:b3:9d","service_id":"ff80","char_id":"ff81","value":"029db379f134a480001100"}]
		debugger
		let guidToWrite = {};
		for (let param of message.data.params) {
			if (param.action == 'write') {
				if (!isset(guidToWrite[param.guid])) {
					guidToWrite[param.guid] = [];
				}
				guidToWrite[param.guid].push({
					service: param.service_id,
					characteristic: param.char_id,
					data: param.value,
				})
			}
		}
		for (let guid in guidToWrite) {
			if (!isset(peripheral[guid])) continue;
			peripheral[guid].write(guidToWrite[guid]);
		}
	};
	const splitBytesAndConvertToBinaryArray = (character)=>{
		let bytes = character.match(/.{1,2}/g);
		let binaryArray = bytes.map(byte => {
        let binaryByte = (parseInt(byte, 16) >>> 0).toString(2).padStart(8, '0');
        return binaryByte.split('').map(Number);
    }).flat();
		return binaryArray;
	}
	const tindyRcuData = (str) => {
		let result = [];
		let i = 4;
		while (i < str.length) {
			let index = str.substring(i, i + 2);
			let type = str.substring(i + 2, i + 4);
			let dataLength = type === '01' ? 2 : type === '02' ? 4 : 0;
			let data = str.substring(i + 4, i + 4 + dataLength);

			result.push({
				index,
				type,
				data
			});

			if (index === '05') break;

			i += 4 + dataLength;
		}
		return result;
	}




	//events
	$onBeforeMount(() => {
		document.removeEventListener("touchstart", handleUserActivity);
		document.removeEventListener("touchmove", handleUserActivity);
		document.removeEventListener("click", handleUserActivity);
		clearTimeout(idleTimer);
		mobileAsHubStatus = false;
		
	});
	$onMounted(async() => {
		try{
			let permisionData = await getProfilePermision();
			profilePermision = permisionData.allow;
			//console.log("permisionData",permisionData);
		}catch(error){
			console.log("permision_error",error)
		}
		initPage();
		scan();
		emitter.on('cap:app:resume',()=>{
			app.dialog.preloader();
			let resumeTimer = setTimeout(()=>{
				app.dialog.close();
			},1000*3)
		})
	});	
	$onBeforeUnmount(() => {
		//emitter.off('on_peripheral_changed');
		emitter.off('cap:app:resume');
		bleManager.clear();
		clearTimeout(idleTimer);
		mobileAsHubStatus = false;
		//emitter.off("onNetworkChange",networkChangeFun);
	});
	return $render;
};
</script>

<style>
		.device-hidden {
			display: none;
		}
		.tabbar .tab-link-active,
		.tabbar-labels .tab-link-active {
			background-color: var(--f7-theme-color);
			color: #fff;
		}
		.page-content .rcu-output[ref='1']{
			background-color: var(--f7-theme-color);
    	color: #fff;
		}
		.page-content .rcu-output[ref='0']{
			background-color: var(--f7-block-strong-bg-color);
    	color: #8e8d93;
    	border-color: #8e8d93;
		}
		.room-box .device .swipeout-actions-right {
			transform: translateX(200%);
		}
		.room-box .device .swipeout-actions-left {
			transform: translateX(-200%);
		}
		.ir-signal-cooker i,.rcu-virtual-button i{
			display: none;
		}
		.room-box .ir-signal-cooker[ref='0'][mode='On Off IR'],
		.room-box .rcu-virtual-button[ref='0'],
		.room-box .ir-signal-cooker[ref='0'][mode='Multiway Switch'] {
			display: inline-block;
		}
		.room-box .ir-signal-cooker[ref='1'] .radio-button-unchecked,
		.room-box .rcu-virtual-button[ref='1'] .radio-button-unchecked
		{
			display: none;
		}
		.room-box .ir-signal-cooker[ref='0'][mode='On Off IR'] .radio-button-unchecked,
		.room-box .rcu-virtual-button[ref='0'] .radio-button-unchecked,
		.room-box .ir-signal-cooker[ref='0'][mode='Multiway Switch'] .radio-button-unchecked {
			display: inline-block;
		}
		.room-box .ir-signal-cooker[ref='1'] .circles,.room-box .rcu-virtual-button[ref='1'] .circles {
			display: inline-block;
			color: #3bb33b !important;
		}
		.device[bluetooth='0'][mobmob='0'] .control-panel-right .iaq-button-score-a {
			display: none;
		}
		.device[bluetooth='1'] .control-panel-right .iaq-button-score-a,
		.device[mobmob='1'] .control-panel-right .iaq-button-score-a {
			display: inline-block;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='0'] .on_flag,
		.control-panel-right[type-box='Dimming'][bluetooth='2'][mobmob='0'] .on_flag {
			display: none;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='1'] a.iot-connect,
		.control-panel-right[type-box='Dimming'][mesh='1'] a.iot-connect,
		.control-panel-right[type-box='Dimming'][mobmob='1'] a.iot-connect{
			display: none !important;
		}
		.device .control-panel-right[type-box='Dimming'][bluetooth='1'] .on_flag,
		.device .control-panel-right[type-box='Dimming'][mobmob='1'] .on_flag,
		.device .control-panel-right[type-box='Dimming'][mesh='1'] .on_flag
		 {
			display: inline-block;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='0'][mesh='0'] a.iot-connect {
			display: inline-block;
		}
		.device[bluetooth='0'][mobmob='0'] .iaq-button-score-a {
			display: none;
		}
		.thermostat-subdevice[ref="0"]{
			display: none !important;
		}
		/*.thermostat-subdevice[bluetooth="0"][mobmob='0'][mesh='0']*/
		/*{*/
		/*	display: none !important;*/
		/*}*/
		.thermostat-subdevice[bluetooth='1'][ref="1"],
		.thermostat-subdevice[mobmob='1'][ref="1"],
		.thermostat-subdevice[mesh='1'][ref="1"]
		{
			display: flex !important;
		}
		.device[bluetooth='1'] .iaq-button-score-a,
		.iaq-button-score-a[mobmob='1'] .iaq-button-score-a {
			display: inline-block;
		}
		.iaq-subdevice[bluetooth='0'][mobmob='0'] {
			display: none !important;
		}
		.iaq-subdevice[bluetooth='1'],
		.iaq-subdevice[mobmob='1'] {
			display: flex !important;
		}
		.device-none {
			display: none !important;
		}
		.device-flex {
			display: flex;
		}
		.dimming-subdevice[bluetooth='0'][mobmob='0'] {
			opacity: 0.55 !important;
			pointer-events: none !important;
		}
		.curtain-subdevice[bluetooth='0'][mobmob='0'] {
			opacity: 0.55 !important;
			pointer-events: none !important;
		}
		.device.curtain-subdevice[bluetooth='1'],
		.device.curtain-subdevice[mobmob='1'],
		.device.dimming-subdevice[bluetooth='1'],
		.device.dimming-subdevice[mobmob='1'] {
			display: flex;
		}
		.box-btn {
			margin-bottom: 7.5px;
			margin-top: 7.5px;
		}
		.box-left {
			border-left: 1px solid var(--f7-list-item-border-color);
		}
		.unit {
			font-size: 11px;
		}
		.title-btn {
			width: 100%;
			margin-left: 5px;
		}
		.iaq-title-big {
			font-size: 12px;
		}
		.main-btn .box-btn-img {
			background-color: #3bb33b;
		}
		.device[bluetooth='1'] .iot-connect {
			display: none !important;
		}
		.device[mobmob='1'] .iot-connect {
			display: none !important;
		}
		.device[mesh='1'] .iot-connect {
			display: none !important;
		}
		.device[bluetooth='0'][mobmob='0'][mesh='0'] .iot-connect {
			display: block !important;
		}
		.subdevice[bluetooth='0'][mobmob='0'] {
			display: none;
		}
		.subdevice[bluetooth='1'],
		.subdevice[mobmob='1'] {
			display: block;
		}
		.home-signal-thermostat {
			display: none;
		}
		.arrow-downward-button[ref='1'] .button,
		.arrow-upward-button[ref='1'] .button {
			background-color: var(--f7-theme-color);
			color: #ffffff;
			border-color: var(--f7-theme-color);
		}
		@keyframes refresh {
			0% {
				opacity: 0;
			}
			50% {
				opacity: 1;
			}
			100% {
				opacity: 0;
			}
		}
		li.device .item-content .control-panel-right i.button-icons,
		li.device .item-content .control-panel-right i {
			line-height: 25px !important;
		}
		.tabbar .tab-link-highlight {
			bottom: 0;
			display: none;
		}
		.pair-box-connect {
			position: absolute;
			margin-top: -95px;
			margin-left: 35px;
			transform: rotate(90deg);
			color: var(--f7-theme-color);
		}
		.circle-password {
					width: 70px;
					height: 70px;
					border-radius: 50%;
					background-color: var(--f7-theme-color); /*  */
					display: flex;
					justify-content: center;
					align-items: center;
					color: white;
					font-size: 24px;
					font-weight: bold;
					margin: 10px;
			}
		.device-mobile-as-hub{
			width: 30px;
			height : 30px;
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
			background-size: 100% auto;
			background-position: left top;
		}
		.moblie-as-hub-icon{
			position: relative;
			width: 100px;
			height : 100px;
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
			background-size: 100% auto;
			background-position: left top;
			display: flex;
      justify-content: center;
      align-items: center;
		}
		.page-content *[mobmob='1'][mobilehub='1'] .mobmob{
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
		}
    .signal-wave {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 0, 0, 0.5);
				will-change: transform, opacity; 
        animation: expand 2s infinite;
				transform: scale(1);
    }

    .signal-wave:nth-child(1) {
        animation-delay: 0s;
				background: rgba(255, 165, 0, 0.5);
    }

    .signal-wave:nth-child(2) {
        animation-delay: 0.5s;
				background: rgba(255, 255, 0, 0.5)
    }

    .signal-wave:nth-child(3) {
        animation-delay: 1s;
				background: rgba(0, 128, 0, 0.5)
    }

    .signal-wave:nth-child(4) {
        animation-delay: 1.5s;
				background: rgba(0, 0, 255, 0.5)
    }

    @keyframes expand {
        0% {
					transform: scale(1);
          opacity: 0.5;
        }
        100% {
					transform: scale(20);
          opacity: 0;
        }
    }
</style>
