<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Miele') }}</div>
        <div class="right">
          <a link icon-only>
            <i class="icon material-icons" func="clear_miele_account">logout</i>
          </a>
        </div>
      </div>
    </div>
    <style>
      .page-content .button.onoff[ref='0'],
      .page-content *[onoffref='0'] > .button.onoff {
        background-color: var(--f7-block-strong-bg-color);
        color: #8e8d93;
        border-color: #8e8d93;
      }
      .control-panel-left,
      .subdevice-item-content {
        display: flex !important;
      }
      .subdevice-item-content .openclose {
        display: inline-block !important;
      }
      .subdevice-item-content .active-button,
      .item-content .active-button {
        background: var(--f7-theme-color) !important;
        color: #fff !important;
      }
      .button-big {
        font-size: 10px;
      }
      .page-content .button.onoff[ref='0']:after,
      .page-content *[onoffref='0'] > .button.onoff:after {
        content: 'OFF';
      }
    </style>
    <div class="page-content" style="height: 100%">
      {% raw %}
      <div id="app" style="height: 100%" v-cloak>
        <iframe v-if="!this_miele_token" id="myIframe" :src="targetUrl" frameborder="0" style="height: 100%; width: 100%"></iframe>
        <div id="room-0-div" v-else class="list media-list no-margin device-none">
          <ul>
            <li class="room">
              <div class="item-content">
                <div class="item-inner">
                  <div class="item-title-row">
                    <div class="item-title" lang="en" lang-packet="Unassigned" func="controller_common_home_collapse" ref="0">
                      <i class="room-collapse material-icons" id="collapse-0"> expand_more </i>
                      {{ _('Unassigned') }}
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <button-group
              v-for="(item,index) in deviceList"
              :onoff-ref="item.ref"
              :display-name="item.display_name"
              :device-model="item.device_model"
              :device-name="item.macaddress"
              :image-url="item.url"
              :name="item.name"
              :mode="item.mode?item.mode:''"
              :cooling="item.cooling?item.cooling:''"
              :freezing="item.freezing?item.freezing:''"
              :temp="item.temp?item.temp:0"
              :hexid="item.hexid"
              :action-state="item.action_state"
              @onoff="changeOnoff"
              @state="stateManage"
              @modestate="modeStateManage"
              @coolingstate="coolingManage"
              @freezingstate="freezingManage"
              @tempstate="tempManage"
            ></button-group>
          </ul>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  erp.pageScript['mobile-app/miele-auto-page'] = {};

  erp.pageScript['mobile-app/miele-auto-page'].pageMounted = async (e, page) => {
    erp.pageScript['mobile-app/miele-auto-page'].vueApp = new Vue({
      components: {
        ButtonGroup: erp.pageScript['mobile-app/miele-auto-page'].ButtonGroupComponent,
      },
      el: page.el.querySelector('#app'),
      data: {
        deviceList: [
          {
            display_name: 'Oven',
            hexid: '0225',
            device_model: 'Oven',
            macaddress: '083a8d16fc5a',
            url: 'https://www.miele.com/developer/assets/12_oven.svg',
            name: 1,
            ref: '0',
            action_state: 0, //0 off,1 play,2 pause, 3 stop
          },
          {
            display_name: 'Washer Dryer',
            hexid: '0226',
            device_model: 'Washer Dryer',
            macaddress: '083a8d16fc5b',
            url: 'https://www.miele.com/developer/assets/24_washerdryer.svg',
            name: 2,
            ref: '0',
            action_state: 0,
          },
          {
            display_name: 'Fridge / Freezer',
            hexid: '0227',
            device_model: 'Fridge / Freezer',
            macaddress: '083a8d16fc5c',
            url: 'https://www.miele.com/developer/assets/21_fridgefreezer.svg',
            name: 3,
            ref: '0',
            action_state: 0,
            mode: 0, //0 Normal,1 Sabbath mode,2 Party mode,3 Holiday mode
            cooling: 0, //1 start,0 stop
            freezing: 0, //1 start, 0 stop
            temp: 12,
          },
          {
            display_name: 'Combi Steam',
            hexid: '0228',
            device_model: 'Combi Steam',
            macaddress: '083a8d16fc5c',
            url: 'https://www.miele.com/developer/assets/31_steamovencombination.svg',
            name: 4,
            ref: '0',
            action_state: 0,
          },
          {
            display_name: 'Warming Drawer',
            hexid: '0229',
            device_model: 'Warming Drawer',
            macaddress: '083ad16fc5d',
            url: 'https://www.miele.com/developer/assets/31_steamovencombination.svg',
            name: 5,
            ref: '0',
            action_state: 0,
          },
          {
            display_name: 'Coffee Machine',
            hexid: '0230',
            device_model: 'Coffee Machine',
            macaddress: '083ad16fc5e',
            url: 'https://www.miele.com/developer/assets/17_coffeesystem.svg',
            name: 6,
            ref: '0',
            action_state: 0,
          },
        ],
        this_miele_token: '',
        targetUrl: '',
        postUrl: '',
        responseMap: {
          response_type: '',
          client_id: '',
          redirect_uri: '',
          scope: '',
          client_secret: '',
        },
        thisListenFun: null,
      },
      mounted() {
        let iframe = document.getElementById('myIframe');
        window.addEventListener('message', (event) => {
          console.log('event', event);
          let data = JSON.parse(event.data);
          if (isset(data) && data.access_token) {
            let key = `miele_${users.current}`;
            data.expires_in_date = dayjs().format();
            db.set(key, JSON.stringify(data));
            window.miele_access_token = data.access_token;
            window.miele_express_in = data.expires_in;
            this.this_miele_token = data.access_token;
            this.getDeviceList();
          }
        });
        if (this.thisListenFun) {
          emitter.off('miele/refresh', this.thisListenFun);
        }
        emitter.on('miele/refresh', (data) => {
          this.this_miele_token = '';
          this.init();
        });
        this.init();
      },
      methods: {
        async init() {
          await this.getLocalToken();
          await this.getApiHookParam();
          await this.getData();
        },
        async getLocalToken() {
          try {
            let token = await db.get(`miele_${users.current}`);
            if (token) {
              //check is nor Invalid
              let data = JSON.parse(token);
              let thisTime = dayjs().format();
              let expires_in_date = data.expires_in_date;
              let expires_in = data.expires_in;
              let compare_time = dayjs(thisTime).diff(dayjs(expires_in_date), 'second');
              if (compare_time <= expires_in) {
                window.miele_access_token = data.access_token;
                this.this_miele_token = data.access_token;
                this.getDeviceList();
              } else {
                window.miele_access_token = '';
                this.this_miele_token = '';
              }
            }
          } catch (e) {}
        },
        async getApiHookParam() {
          let url = `/api/method/appv6.getApiHookList?name=Miele Authorization`;
          let list = await http.request(encodeURI(url), {
            method: 'GET',
            serializer: 'json',
            responseType: 'json',
            timeout: 3,
          });
          let data = list.data.data;
          if (isset(data.url)) {
            this.postUrl = data.url;
          }
          let dataList = data.api_params;
          dataList.forEach((item) => {
            if (item.key === 'response_type') {
              this.responseMap.response_type = item.value;
            }
            if (item.key === 'client_id') {
              this.responseMap.client_id = item.value;
            }
            if (item.key === 'redirect_uri') {
              this.responseMap.redirect_uri = item.value;
            }
            if (item.key === 'scope') {
              this.responseMap.scope = item.value;
            }
            if (item.key === 'client_secret') {
              this.responseMap.client_secret = item.value;
            }
          });
        },
        async getData() {
          let url = `${this.postUrl}?response_type=${this.responseMap.response_type}&client_id=${this.responseMap.client_id}&redirect_uri=${this.responseMap.redirect_uri}&scope=${this.responseMap.scope}&state=${md5(
            users.current
          )}`;
          this.targetUrl = url;
        },
        async getDeviceList() {
          let list = await http2.request(encodeURI(`https://api.mcs3.miele.com/v1/devices`), {
            method: 'GET',
            serializer: 'json',
            responseType: 'json',
            headers: {
              'content-type': 'application/json;charset=utf-8',
              'Authorization': `Bearer ${this.this_miele_token}`,
            },
            timeout: 3,
          });
          console.log("list",list);
          if(list.status == 200){
            let devices = list.data;
            for(let i in devices){
              let obj = {
                display_name: devices[i].ident.deviceName,
                device_model: devices[i].ident.type.value_localized,
                macaddress : devices[i].ident.deviceIdentLabel.fabNumber,
                url: this.getDeviceImg(devices[i].ident.type.value_localized),
                name: i,
                ref : this.getStatus(devices[i].state.status.value_localized),
                ident : devices[i].ident,
                state : devices[i].state,
              }
            }
          }
        },
        getStatus(ref){
          let onoffRef = 0;
          if(ref == 'On'){
            onoffRef = 1;
          }else if(ref == 'In use'){
            onoffRef = 1;
          }else if(ref == 'Off'){
            onoffRef = 0;
          }
        },
        getDeviceImg(type){
          let url = `https://www.miele.com/developer/assets/12_oven.svg`;
          if(type == 'Oven'){
            url = `https://www.miele.com/developer/assets/12_oven.svg`;
          }else if(type == 'Washer Dryer'){
            url = `https://www.miele.com/developer/assets/24_washerdryer.svg`;
          }else if(type == 'Warming drawer'){
            url = `https://www.miele.com/developer/assets/31_steamovencombination.svg`;
          }else if(type == 'Coffee Machine'){
            url = `https://www.miele.com/developer/assets/17_coffeesystem.svg`;
          }else if(type == 'Combi Steam'){
            url = `https://www.miele.com/developer/assets/31_steamovencombination.svg`;
          }else if(type == 'Fridge / Freezer'){
            url = `https://www.miele.com/developer/assets/31_steamovencombination.svg`;
          }
          return url
        },
        changeOnoff(data) {
          console.log('data', data);
          this.deviceList.forEach((item) => {
            if (item.name == data.name) {
              let this_ref = '0';
              if (data.ref == '0') {
                this_ref = '1';
              }
              item.ref = this_ref;
            }
          });
        },
        stateManage(data) {
          console.log('data', data);
          this.deviceList.forEach((item) => {
            if (item.name == data.name) {
              item.action_state = data.state;
            }
          });
        },
        modeStateManage(data) {
          console.log('data', data);
          let state = data.state * 1 + 1;
          if (data.state == 3) {
            state = 0;
          }
          this.deviceList.forEach((item) => {
            if (item.name == data.name) {
              item.mode = state;
            }
          });
        },
        coolingManage(data) {
          this.deviceList.forEach((item) => {
            if (item.name == data.name) {
              item.cooling = data.state;
            }
          });
        },
        freezingManage(data) {
          this.deviceList.forEach((item) => {
            if (item.name == data.name) {
              item.freezing = data.state;
            }
          });
        },
        tempManage(data) {
          console.log(data);
          let temp = data.temp;
          let type = data.type;
          if (type == 'reduce') {
            temp--;
          } else {
            temp++;
          }
          this.deviceList.forEach((item) => {
            if (item.name == data.name) {
              item.temp = temp;
            }
          });
        },
      },
      beforeDestroy() {},
    });
  };

  erp.pageScript['mobile-app/miele-auto-page'].pageInit = (e, page) => {};

  erp.pageScript['mobile-app/miele-auto-page'].pageBeforeIn = (e, page) => {};

  erp.pageScript['mobile-app/miele-auto-page'].pageAfterIn = (e, page) => {};

  erp.pageScript['mobile-app/miele-auto-page'].pageBeforeOut = (e, page) => {};

  erp.pageScript['mobile-app/miele-auto-page'].pageAfterOut = (e, page) => {};

  erp.pageScript['mobile-app/miele-auto-page'].pageBeforeRemove = (e, page) => {
    try {
      erp.pageScript['mobile-app/miele-auto-page'].vueApp.$destroy();
      erp.pageScript['mobile-app/miele-auto-page'].vueApp = null;
    } catch (err) {
      // ignore
    }
  };
  erp.pageScript['mobile-app/miele-auto-page'].ButtonGroupComponent = {
    template: `
    <div>
    <li class="device home-scanned-peripheral swipeout swipeout-delete-manual">
      <div class="item-content swipeout-content">
        <a class="item-link item-content no-chevron no-ripple no-active-state">  
          <div class="device-thumb item-media" :style="{'background-position':'center','background-size' : 'contain','position':'relative','background-image':'url(' + imageUrl + ')'}">
        
          </div>
          <div class="item-inner">
            <div class="item-title-row">
              <div class="item-title ellipsis" lang="en" style="width:180px;">
                <i class="material-icons text-muted" style="position:relative;top:5px;">settings</i>
              {{displayName}}
              </div>
            </div>
            <div class="item-subtitle">{{ deviceModel }}-{{ deviceName }}</div>
            <div class="signal-panel item-text height-21" style="width:120%;">
              <div>
                  <div class="signal"></div>
                  <div class="bluetooth"></div>
                  <div class="mesh"></div>
                  <div class="mobmob"></div>
                  <div class="iostatus"></div>
              </div>
            </div>
          </div>
        </a>
        <div class="control-panel-right" style="">
            <a class="on_flag off_flag" :onoffref="onoffRef" @click="clickOnoff(name,onoffRef)" gang="1">
                <div class="button button-raised button-big onoff"></div>
            </a>
          </div>
      </div>
    </li>
    <li class="device home-scanned-peripheral" v-if="hexid != '0227'">
      <div class="item-content subdevice-item-content" style="min-height: 0px;">
          <div class="item-inner" style="min-height: 0px;">
              <div class="row" style="--f7-grid-gap:3px;padding-left:20px;padding-right:15px;"> 
                  
                  <button class="col on_flag off_flag button button-large button-raised openclose cl" :class="actionState == 3?'active-button':''" ref="0"  command-type="Bluetooth" command="" @click="changeStates(name,1)">
                      <div class="display-flex justify-content-center align-items-center" style="margin-left:-5px;margin-top:-5px;">Start</div>
                  </button>      
                  <button class="col on_flag off_flag button button-large button-raised stop" :class="actionState == 2?'active-button':''" ref="n" 
                   command-type="Bluetooth" command="" @click="changeStates(name,2)">
                      <div>Pause</div>
                  </button>      
                  <button class="col on_flag off_flag button button-large button-raised openclose op" :class="actionState == 1?'active-button':''" ref="1" command-type="Bluetooth" command="" @click="changeStates(name,3)">
                      <div class="display-flex justify-content-center align-items-center" style="margin-left:-7px;margin-top:-5px;">Stop</div>
                  </button>
              </div>
          </div>
      </div>
    </li>
    <li class="device home-scanned-peripheral" style="height:auto;" v-if="hexid == '0227'">
      <div class="item-content subdevice-item-content" style="min-height: 0px;">
        <div class="item-inner" style="min-height: 0px;">
          <div class="row" style="--f7-grid-gap:3px;padding-left:20px;padding-right:15px;"> 
            <button class="col on_flag off_flag button button-large button-raised openclose cl" ref="0"  command-type="Bluetooth" command="" @click="changeMode(name,mode)">
                <div class="display-flex justify-content-center align-items-center" style="margin-left:-5px;margin-top:-5px;font-size:12px;">{{modeStr}}</div>
            </button>
            <button class="col on_flag off_flag button button-large button-raised stop" :class="freezing == 1?'active-button':''" ref="n" 
              command-type="Bluetooth" command="" @click="changeFreezing(name,1)">
                <div style="font-size:12px;">Start Freezing</div>
            </button> 
            <button class="col on_flag off_flag button button-large button-raised openclose op" :class="freezing == 2?'active-button':''" ref="1" command-type="Bluetooth" command="" @click="changeFreezing(name,2)">
                <div class="display-flex justify-content-center align-items-center" style="margin-left:-7px;margin-top:-5px;font-size:12px">Stop Freezing</div>
            </button>
          </div>
        </div>
      </div>
      <div class="item-content subdevice-item-content" style="min-height: 0px;">
        <div class="item-inner" style="min-height: 0px;">
          <div class="row" style="--f7-grid-gap:3px;padding-left:20px;padding-right:15px;"> 
            <button class="col on_flag off_flag button button-large button-raised openclose cl" ref="0"  command-type="Bluetooth" command="" @click="changeTemp(name,temp,'reduce')">
                <div class="display-flex justify-content-center align-items-center" style="margin-left:-5px;margin-top:-5px;font-size:24px;">-</div>
            </button>
            <button class="col on_flag off_flag button button-large button-raised stop" :class="freezing == 1?'active-button':''" ref="n" command-type="Bluetooth" command="" style="background:transparent;box-shadow:unset!important;">
                <div style="font-size:18px;"><span>{{temp}}</span>&deg;C</div>
            </button> 
            <button class="col on_flag off_flag button button-large button-raised openclose op" :class="freezing == 2?'active-button':''" ref="1" command-type="Bluetooth" command="" @click="changeTemp(name,temp,'add')">
                <div class="display-flex justify-content-center align-items-center" style="margin-left:-7px;margin-top:-5px;font-size:24px">+</div>
            </button>
          </div>
        </div>
      </div>
    </li>
    </div>
    `,
    props: {
      displayName: {
        type: String,
        default: '',
        required: true,
      },
      deviceModel: {
        type: String,
        default: '',
        required: true,
      },
      deviceName: {
        type: String,
        default: '',
        required: true,
      },
      imageUrl: {
        type: String,
        default: '',
        required: true,
      },
      hexid: {
        type: String,
        default: '',
        required: true,
      },
      name: {
        type: Number,
        default: '',
        required: true,
      },
      onoffRef: {
        type: String,
        default: '',
        required: true,
      },
      actionState: {
        type: Number,
        default: '',
        required: true,
      },
      temp: {
        type: Number,
        default: 0,
        required: true,
      },
      mode: {
        type: Number,
        default: 0,
        required: true,
      },
      cooling: {
        type: Number,
        default: 0,
        required: true,
      },
      freezing: {
        type: Number,
        default: 0,
        required: true,
      },
    },
    data: {},
    computed: {
      modeStr() {
        console.log(this.mode);
        let str = 'NORMAL';
        if (this.mode == 1) {
          str = 'SABBATH';
        } else if (this.mode == 2) {
          str = 'PARTY';
        } else if (this.mode == 3) {
          str = 'HOLIDAY';
        }
        return str;
      },
      coolingStr() {
        let str = 'NO COOL';
        if (this.cooling == 1) {
          str = 'COOLING';
        }
        return str;
      },
      freezingStr() {
        let str = 'NO FREEZ';
        if (this.freezing == 1) {
          str = 'FREEZING';
        }
        return str;
      },
    },
    mounted() {
      console.log(this.displayName);
    },
    methods: {
      clickOnoff(name, ref) {
        console.log('ref', ref);
        console.log('name', name);
        this.$emit('onoff', {
          name: name,
          ref: ref,
        });
      },
      changeStates(name, state) {
        this.$emit('state', {
          name: name,
          state: state,
        });
      },
      changeMode(name, state) {
        this.$emit('modestate', {
          name: name,
          state: state,
        });
      },
      changeCooling(name, state) {
        this.$emit('coolingstate', {
          name: name,
          state: state,
        });
      },
      changeFreezing(name, state) {
        this.$emit('freezingstate', {
          name: name,
          state: state,
        });
      },
      changeTemp(name, temp, type) {
        this.$emit('tempstate', {
          name: name,
          temp: temp,
          type: type,
        });
      },
    },
    beforeDestroy() {},
  };
</script>
