<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Room Device') }}</div>
        <div class="right">
          <a link icon-only @click="${()=>batch_save()}">
            <i class="icon material-icons setting-list-icon p-1" style="font-size: 30px">check</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app">
        <div class="scene-room-box">
          <div class="toolbar tabbar tabbar-scrollable toolbar-home-room no-show" style="z-index: 5; position: fixed">
            <div class="toolbar-inner">
              <a
                href="#tab-hidden-0"
                ref="0"
                id="room-bar-title-0"
                v-on:click="controller_home_switch_room_onclick(0)"
                class="tab-link tab-link-active"
              >
                <i class="material-icons">home</i>
              </a>
              <a
                v-for="(item,index) in roomList"
                :key="item.name"
                :href="'#ab-hidden-'+item.idx"
                :slot="item.idx"
                :id="'room-bar-title-'+item.idx"
                v-on:click="controller_home_switch_room_onclick(item.idx)"
                class="tab-link"
                v-if="!item.isHidden"
              >
                {{tran(item.title)}}
              </a>
            </div>
          </div>
          <div style="height: 48px"></div>
          <!-- room list start -->
          <div
            class="list media-list no-margin"
            :id="'room-'+roomItem.idx+'-div'"
            :room="roomItem.name"
            v-for="(roomItem,roomIndex) in roomList"
            :key="roomItem.name"
            v-if="!roomItem.isHidden"
          >
            <ul>
              <li :id="'room-'+roomItem.idx+'-div-title'" class="swipeout room">
                <div class="item-content swipeout-content">
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div
                        class="item-title"
                        lang="en"
                        :lang-packet="roomItem.title"
                        v-on:click="controller_common_home_collapse(roomItem.idx)"
                      >
                        <i class="room-collapse material-icons" :id="'collapse-'+roomItem.idx"> expand_more </i>
                        {{ tran(roomItem.title) }}
                      </div>
                    </div>
                  </div>
                  <div class="item-after display-flex justify-content-center" style="min-width: 120px;">
                    <button class="button button-round link bg-color-white" style="width: 50px;margin-right: 10px;"  ref="1" v-on:click="batchOnOff(1,roomItem)">ON</button>
                    <button class="button button-round link bg-color-white" style="width: 50px;"  ref="2" v-on:click="batchOnOff(2,roomItem)">OFF</button>
                  </div>
                </div>
              </li>
              <div class="scene-room-device-item">
                <div
                  class="li-item"
                  v-for="(subItem,subIndex) in subdevices"
                  :key="subItem.name"
                  v-if="subItem.profile_room == roomItem.name && !subItem.isHidden"
                >
                  <li class="device swipeout" :guid="subItem.device">
                    <div class="item-content swipeout-content">
                      <a
                        class="item-link item-content no-chevron no-ripple no-active-state"
                        style="width: 100%"
                      >
                        <div
                          class="device-thumb item-media"
                          :style="{
                          'background-image' : 'url('+subItem.imgUrl+')',
                          'background-position' : 'center',
                          'background-size' : 'contain',
                          'position' : 'relative'
                        }"
                        ></div>
                        <div class="item-inner">
                          <div class="item-title-row">
                            <div class="item-title ellipsis" lang="en" style="width: 180px">{{tran(subItem.title)}}</div>
                          </div>
                          <div class="item-subtitle">{{ subItem.device_model }}-{{ subItem.mac_address.substring(0,12) }}</div>
                          <div class="signal-panel item-text height-21" style="width: 120%">
                            <div>
                              <div class="status-info text-color-primary" style="display: none;">{{dealWithType(subItem)}}</div>
                            </div>
                          </div>
                        </div>
                      </a>
                      <div class="control-panel-right" style="">
                        <a class="right" v-on:click="${()=>toScene(subItem)}" v-if="subItem.mainType == 0">
                          <div class="button button-raised button-big circle rf-sensor">
                              <i class="material-icons" style="line-height: 25px!important;">arrow_forward_ios</i>
                          </div>
                        </a>
                        <a class="right" v-on:click="${()=>toScene(subItem)}" v-if="subItem.mainType == 50">
                          <div class="button button-raised button-big circle rf-sensor">
                              <i class="material-icons" style="line-height: 25px!important;">logout</i>
                          </div>
                        </a>
                        <a class="right" v-if="subItem.mainType == 15">
                          <div class="button button-raised button-big circle rf-sensor">
                              <i class="material-icons" style="line-height: 30px!important;font-size: 30px!important;">check</i>
                          </div>
                        </a>
                        <div
                          class="button button-raised button-big circle"
                          style="float: left;"
                          v-if="subItem.virtualStatus"
                          v-on:click="chooseVirtualType(subItem)"
                        >
                          <input type="hidden" name="bind_virtual_type" value="" />
                          <div>
                            <span v-if="subItem.virtualIdType && subItem.virtualIdType != 0" style="font-size: 14px;">{{subItem.virtualIdType == 1?'Rcu':subItem.virtualIdType == 2?'Led':'Both'}}</span>
                            <i v-else class="material-icons" style="line-height: 70px !important; font-size: 25px !important">settings</i>
                          </div>
                        </div>

                        <div
                          class="button button-raised button-big circle"
                          style="float: left;"
                          v-if="subItem.virtualStatus"
                          v-on:click="chooseVirtualId(subItem)"
                        >
                          <input type="hidden" name="bind_virtual_id" value="" />
                          <div>
                            <span v-if="subItem.virtualId && subItem.virtualId != 0" style="font-size: 22px;">{{subItem.virtualId}}</span>
                            <i v-else class="material-icons" style="line-height: 70px !important; font-size: 25px !important">tag</i>
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 1"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">block</i></div>
                        </div>
                        <a
                          :class="subItem.ref == 0?'off_flag':'on_flag'"
                          :onoff="subItem.ref"
                          v-if="subItem.mainType == 2"
                          v-on:click="onOffItem(subItem)"
                        >
                          <div class="button button-raised button-big onoff"></div>
                        </a>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 4"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">touch_app</i></div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 5"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div>
                            <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">brightness_low</i>
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 6"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div>
                            <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">brightness_high</i>
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 7"
                          v-on:click="openCloseItem(subItem)"
                        >
                          <div>
                            <img
                              :src="'https://my.yoswit.com/files/app/'+(subItem.ref === 0 ? 'close' : 'open') +'-curtain.svg'"
                              alt=""
                              style="width: 20px; height: 20px; margin-top: 20px"
                            />
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 9"
                        >
                        <div>
                          <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">pause</i>
                        </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 10"
                          style="background-color: var(--f7-theme-color);"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons text-color-white" style="line-height: 70px !important; font-size: 25px !important">cleaning_services</i></div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 12"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">cleaning_services</i></div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 11"
                          style="background-color: var(--f7-theme-color);"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons text-color-white" style="line-height: 70px !important; font-size: 25px !important">notifications_off</i></div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 13"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">notifications_off</i></div>
                        </div>
                      </div>
                    </div>
                    <div class="swipeout-actions-right">
                      <a v-on:click="cancelTemplate(subItem)" class="link color-red">
                        <i class="icon material-icons">cancel</i>
                      </a>
                    </div>
                  </li>
                  <!-- subdevice bottom box start -->
                  <li
                    class="device subdevice"
                    :class="{'device-hidden':subItem.buttonBoxType == 0?true:false,'display-flex':subItem.buttonBoxType == 0?false:true}"
                    :style="{'height': subItem.buttonBoxType == 3?'77px':'67px'}"
                  >
                    <div class="row padding-tb flex-direction-column justify-content-center" v-if="subItem.buttonBoxType == 1">
                      <div class="col-100 medium-100 large-100">
                        <div class="content display-flex justify-content-center" style="margin-left: 15px; margin-right: 15px">
                          <div class="tip-title"><i class="icon material-icons" style="margin-right: 8px">brightness_low</i></div>
                          <div
                            class="range-slider range-slider-scene"
                            :guid="subItem.device"
                            :button_group="subItem.device_button_group"
                            :name="subItem.name"
                          ></div>
                          <div class="tip-title"><i class="icon material-icons" style="margin-left: 8px">brightness_high</i></div>
                        </div>
                      </div>
                    </div>
                    <div class="row padding-tb flex-direction-column justify-content-center" v-if="subItem.buttonBoxType == 2">
                      <div class="col-100 medium-100 large-100">
                        <div class="content display-flex justify-content-center" style="margin-left: 15px; margin-right: 15px">
                          <div class="tip-title">
                            <img
                              src="https://my.yoswit.com/files/app/close-curtain.svg"
                              alt=""
                              style="width: 20px; height: 20px; margin-right: 8px; margin-top: 5px"
                            />
                          </div>
                          <div
                            class="range-slider range-slider-scene"
                            :guid="subItem.device"
                            :button_group="subItem.device_button_group"
                            :name="subItem.name"
                          ></div>
                          <div class="tip-title">
                            <img
                              src="https://my.yoswit.com/files/app/open-curtain.svg"
                              alt=""
                              style="width: 20px; height: 20px; margin-left: 8px; margin-top: 5px"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="item-content" style="width: 100%" v-if="subItem.buttonBoxType == 3">
                      <div class="item-inner">
                        <div
                          class="display-flex justify-content-space-between align-content-center align-items-center"
                          style="--f7-grid-gap: 3px"
                        >
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'mode')"
                            command-type="mode"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px">
                              <img
                                style="width: 25px; height: 25px"
                                :src="'style/img/air_condition/icon-mode-'+dealWithThermostat(subItem.modeStr)+'.png'"
                              />
                            </div>
                          </a>
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'fan')"
                            command-type="fan"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px">
                              <img
                                style="width: 25px; height: 25px"
                                :src="'style/img/air_condition/icon-speed-'+(subItem.speedVaule?subItem.speedVaule:0)+'.png'"
                              />
                            </div>
                          </a>
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'reduce')"
                            command-type="reduce"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px; font-size: 25px">-</div>
                          </a>
                          <a href="#" class="col set-temp" style="line-height: 60px; margin-top: 8px; text-align: center" button-signal="5">
                            <span>{{subItem.temperature}}</span>â„ƒ
                          </a>
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'add')"
                            command-type="reduce"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px; font-size: 25px">+</div>
                          </a>
                        </div>
                      </div>
                    </div>
                  </li>
                </div>
                <!-- subdevice bottom box end -->
              </div>
            </ul>
          </div>
          <!-- room list end -->
        </div>
        <!-- popup list start -->
        <div class="popup demo-popup-swipe-handler" v-show="clickStatus">
          <div class="view view-init">
            <div class="page page-with-navbar-large">
              <div class="navbar navbar-large navbar-transparent">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="title"></div>
                  <div class="right">
                    <a class="link popup-close"><i class="material-icons" style="font-size: 40px">cancel</i></a>
                  </div>
                  <div class="title-large">
                    <div class="title-large-text"></div>
                  </div>
                </div>
              </div>
              <div class="page-content">
                <div class="block block-strong-ios block-outline-ios" style="padding: 15px">
                  <div class="list list-strong-ios list-dividers-ios">
                    <ul class="operate-box" style="margin-top: 15px">
                      <li class="radio-box card" style="opacity: 0">
                        <label class="item-radio item-radio-icon-end item-content">
                          <input type="radio" name="demo-radio-light" checked value="100" />
                          <i class="icon icon-radio"></i>
                          <div class="item-inner">
                            <div class="item-title">{{_('On')}}</div>
                          </div>
                        </label>
                      </li>
                      <li class="radio-box card" v-for="(labelItem,labelIndex) in labelList" :key="labelItem.value" v-on:click="home_ui_click_touch_app_save(labelItem)">
                        <div style="width: 100%;padding: 15px;">
                          {{_(labelItem.text)}}
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- popup list end -->
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $update = ctx.$update,
      $on = ctx.$on,
      $onBeforeMount = ctx.$onBeforeMount,
      $onMounted = ctx.$onMounted,
      $onBeforeUpdate = ctx.$onBeforeUpdate,
      $onUpdated = ctx.$onUpdated,
      $onBeforeUnmount = ctx.$onBeforeUnmount,
      $onUnmounted = ctx.$onUnmounted;
    const {title,type,target_guid,template_name,gateway_topic} = $f7route.query;
    console.log('gateway_topic', gateway_topic);
    const batch_save = () => {
      roomDeviceVueApp.$batchSave();
    };
    const cancelAll = () => {
      roomDeviceVueApp.$reSet();
    };
    let roomDeviceVueApp = null;
    //let {guid,model,device_mode,button_group,img_url,room_name,mac_address,local_ip,target_guid} = $f7route.query;
    $on('pageMounted', (e, page) => {
      roomDeviceVueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          subdevices: [],
          roomList: [],
          labelList: [],
          popupItem: null,
          subName: 0,
          clickStatus : false
        },
        computed: {
          dealWithType() {
            return function (item) {
              let showStr = '';
              if (!item.mainType) {
                showStr = 'UNSELECTED';
              } else if (item.mainType == 2) {
                showStr = 'TYPE/ONOFF';
              } else if (item.mainType == 4) {
                showStr = 'TYPE/TOGGLE';
              } else if (item.mainType == 5) {
                showStr = 'TYPE/BRIGHTEN';
              } else if (item.mainType == 6) {
                showStr = 'TYPE/DIM';
              } else if (item.mainType == 7) {
                showStr = 'TYPE/OPENCLOSE';
              }
              return showStr;
            };
          },
          dealWithThermostat(){
            return function (modeStr){
              let showStr = '';
              if(modeStr == 0){
                showStr = 4
              }else if(modeStr == 2){
                showStr = 2;
              }else if(modeStr == 1){
                showStr = 5;
              }
              return showStr;
            }
          }
        },
        mounted() {
          this.init();
          Vue.prototype.$batchSave = this.tindyCommand;
        },
        methods: {
          sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          },
          batchOnOff(ref, roomItem){
            const roomName = roomItem && roomItem.name ? roomItem.name : roomItem;
            const isOn = ref == 1;
            const defaultRef = isOn ? 1 : 0;
            // build chooseList the same way chooseTemplate does, take the first option
            const buildChooseList = (item) => {
              const button_group = item.device_button_group || '';
              let chooseList = [
                { value: '01', text: 'ON/OFF', type: 2 },
                { value: '02', text: 'TOGGLE', type: 4 },
              ];
              if (button_group.startsWith('Hdmicec')) {
                chooseList = [
                  { value: '01', text: 'ON/OFF', type: 2 },
                  { value: '02', text: 'TOGGLE', type: 4 },
                  { value: '50', text: 'CHECKOUT', type: 50 },
                ];
              } else if (button_group.startsWith('Thermostat')) {
                chooseList = [
                  { value: '01', text: 'ON/OFF', type: 2 },
                  { value: '50', text: 'CHECKOUT', type: 50 },
                ];
              } else if (button_group.startsWith('RCU DIMMING') || button_group.startsWith('DIMMING')) {
                chooseList = [
                  { value: '4', text: 'ON/OFF', type: 2 },
                  { value: '2', text: 'TOGGLE', type: 4 },
                  { value: '3', text: 'BRIGHTEN', type: 5 },
                  { value: '1', text: 'DIM', type: 6 },
                ];
              } else if (button_group.startsWith('OPENCLOSE UART') || button_group.startsWith('OPENCLOSE WIFI UART')) {
                chooseList = [
                  { value: '01', text: 'OPEN/CLOSE', type: 7 },
                  { value: '02', text: 'PAUSE', type: 9 },
                  { value: '50', text: 'CHECKOUT', type: 50 },
                ];
              } else if (button_group.startsWith('DOOR SIGN')) {
                chooseList = [
                  { value: '31', text: 'CLEAR ON', type: 10 },
                  { value: '34', text: 'CLEAR OFF', type: 12 },
                  { value: '32', text: 'DND ON', type: 11 },
                  { value: '35', text: 'DND OFF', type: 13 },
                ];
              }
              return chooseList;
            };
            const applyTemplate = (item, labelItem) => {
              const button_group = item.device_button_group || '';
              item.mainType = labelItem.type;
              item.chooseStatus = true;
              item.buttonBoxType = 0;
              // default on/off ref
              item.ref = defaultRef;
              // handle special templates similar to home_ui_click_touch_app_save
              if (labelItem.type == 2 && (button_group.startsWith('DIMMING') || button_group.startsWith('RCU DIMMING'))) {
                item.buttonBoxType = 1;
                item.turnlight = labelItem.value;
                item.ref = isOn ? 100 : 0;
                item.chooseType = 4;
                this.initRangeBar(item.device, button_group, item.ref);
                this.changeBarUI(item.device, button_group, item.ref);
              } else if (labelItem.type == 2 && button_group.startsWith('Thermostat')) {
                item.buttonBoxType = 3;
              } else if (labelItem.type == 7) {
                item.buttonBoxType = 2;
                item.ref = isOn ? 100 : 0;
                this.initRangeBar(item.device, button_group, item.ref);
                this.changeBarUI(item.device, button_group, item.ref);
              } else if (labelItem.type == 4) {
                item.chooseType = 2;
              } else if (labelItem.type == 5) {
                item.chooseType = 3;
              } else if (labelItem.type == 6) {
                item.chooseType = 1;
              } else if (labelItem.type == 9) {
                item.chooseType = 8;
                item.ref = 2;
              } else if (labelItem.type > 9) {
                item.chooseType = 9;
                item.ref = labelItem.value;
              }
              return item;
            };
            this.subdevices.forEach((item, index) => {
              if (item.profile_room === roomName && !item.isHidden) {
                const chooseList = buildChooseList(item);
                if (chooseList && chooseList.length) {
                  const firstTemplate = chooseList[0];
                  const newItem = applyTemplate(item, firstTemplate);
                  this.$set(this.subdevices, index, newItem);
                }
              }
            });
          },
          async init() {
            //init the roomList
            this.roomList = cloneDeep(erp.info.profile.profile_room);
            //init the deviceList
            let devices = cloneDeep(erp.info.profile.profile_subdevice);
            //init the profile_device
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            devices.forEach((item) => {
              let device_name = item.profile_device;
              profile_devices.forEach((kitem) => {
                if (device_name === kitem.name) {
                  item.device_model = kitem.device_model;
                  item.mac_address = kitem.device_name.substring(0,12);
                  item.gateway = kitem.gateway;
                }
              });
            });
            //init the modelList
            let models = cloneDeep(erp.doctype.device_model);
            devices.forEach((item) => {
              //this param is used to check if the YO780 is in the virtual id
              item.virtualStatus = false;
              item.virtualIdType = 1;
              item.virtualId = '';
              //var the right button type
              if(type == 1){
                item.mainType = 0;
              }else{
                item.mainType = 1;
              }
              
              item.buttonBoxType = 0;
              item.ref = 1;
              //filter the device not show in the page
              item.isHidden = false;
              //YO780,YO780-Scene-12G,YO780-Scene-6G,YO780-Scene-4G,YO780-Scene-1G,YO105,YO790DC,YO205DC,YO203DC,YO202DS,YO201,YO161-H,YO161,M146-BRL
              let fliterList = ['YO780','YO780-Scene-12G','YO780-Scene-6G','YO780-Scene-4G','YO780-Scene-1G','YO105','YO205DC','YO203DC','YO202DS','YO201','YO161-H','YO161-B','YO161','M146-BRL','M146-BRR','M86-3DP','M86-3BR','M86-3MIR','M86-DP','M86-1G','YO203DC-24G','YO203DC-60G','YO205DC-60G','YO205DC-24G'];
              let fliterButtonGroup = ['RCU INPUT'];
              if(type == 2 || type == 5){
                if(fliterList.indexOf(item.device_model) > -1){
                  item.isHidden = true;
                  //check if the button group is in the fliterButtonGroup
                  if(item.device_model == 'YO780'){
                    if(item.device_button_group != 'ONOFF GANG1'){
                      item.isHidden = false;
                    }
                  }
                }
                if(item.device_button_group.startsWith('RCU INPUT')){
                  item.isHidden = true;
                }
                //if gateway scene,only show the gateway device
                if(gateway_topic){
                  if(item.gateway != gateway_topic){
                    item.isHidden = true;
                  }
                }
              }
              let triggerFliterList = ['YO105','YO121-BLE-LE','YO121-AC','YO103','YO121-AC-R2W','M86-DP'];
              if(type == 1){
                if(triggerFliterList.indexOf(item.device_model) > -1){
                  item.isHidden = true;
                }
                if(item.device_model == 'YO780' && item.device_button_group != 'SCENE MUTIWAY ONOFF GANG1' && !item.device_button_group.startsWith('RCU INPUT')){
                  item.isHidden = true;
                }
                if(gateway_topic){
                  if(item.gateway != gateway_topic){
                    item.isHidden = true;
                  }
                }
              }
              if(type == 100){
                item.isHidden = true;
                if(item.device_button_group.includes('RCU ONOFF GANG') || item.device_button_group.includes('RCU DIMMING') || item.device_button_group.includes('RCU OUTPUT')){
                  item.isHidden = false;
                }
              }
              //rcu,open virtual id to choose
              // if(item.device_model == 'YO780' && item.device_button_group == 'ONOFF GANG1' && type == 2){
              //   item.isHidden = false;
              //   item.virtualStatus = true;
              // }
              //choose status
              item.chooseStatus = false;
              let model = item.device_model;
              if (model == 'YO360' || model == 'M360s') {
                item.modeStr = 2;
                item.speedVaule = 4;
                item.temperature = 26;
              }
              for (let i in models) {
                if (models[i].model_code === model) {
                  if (isset(models[i].image)) {
                    item.imgUrl =  models[i].image;
                  } else {
                    item.imgUrl = 'https://my.yoswit.com/files/products/YO815.svg';
                  }
                }
              }
              
            });
            this.subdevices = devices;
            //filter the room devices
            let roomMap = {};
            this.roomList.forEach(item=>{
              roomMap[item.name] = 0;
              item.isHidden = false;
            })
            devices.forEach(item=>{
              for(let i in roomMap){
                if(item.profile_room == i && !item.isHidden){
                  roomMap[i]++;
                }
              }
            });
            console.log("roomMap",roomMap);
            this.roomList.forEach(item=>{
              if(roomMap[item.name] == 0){
                item.isHidden = true;
              }
            })
          },
          chooseVirtualId(item){
            console.log(item);
            const inputEl = $("input[name=bind_virtual_id]");
            let virtual_id_list = [];
            for(let i = 0;i <= 64;i++){
              virtual_id_list.push(i);
            }
            this.virtualSelect = app.picker.create({  
              inputEl: inputEl,
              cols:[
                {
                  values: virtual_id_list,
                  displayValues: virtual_id_list,
                }
              ],
              on: {
                change: (picker) => {
                  console.log(picker.value);
                  item.virtualId = picker.value[0];
                },
                open: (picker) => {
                  console.log(picker);
                  $(picker.$el).find(".toolbar-save-link").on("click", () => {
                    console.log(picker.value);
                  });
                },
              },
            });
            this.virtualSelect.open();
          },
          chooseVirtualType(item){
            console.log(item);
            const inputEl = $("input[name=bind_virtual_type]");
            let virtual_id_list = [1,2,3];
            let virtual_id_value = ['Rcu','Led','Both']
            this.virtualSelect = app.picker.create({  
              inputEl: inputEl,
              cols:[
                {
                  values: virtual_id_list,
                  displayValues: virtual_id_value,
                }
              ],
              on: {
                change: (picker) => {
                  console.log(picker.value);
                  item.virtualIdType = picker.value;
                },
                open: (picker) => {
                  console.log(picker);
                  $(picker.$el).find(".toolbar-save-link").on("click", () => {
                    console.log(picker.value);
                  });
                },
              },
            });
            this.virtualSelect.open();
          },
          clickThermostatChange(item, click_type) {
            console.log(item, click_type);
            let data = '';
            let post_value = ``;
            switch (click_type) {
              case 'mode':
                if (item.modeStr == 1) {
                  item.modeStr = 0;
                } else if (item.modeStr == 2) {
                  let devices = cloneDeep(erp.info.device);
                  let device = devices[item.device];
                  let mode_seetting = '';
                  if (isset(device)) {
                    let list = device.settings;
                    list.forEach((item) => {
                      if (item.setting_type === 'mode_selection') {
                        mode_seetting = item.setting;
                      }
                    });
                  }
                  if (mode_seetting == 'Cooling') {
                    item.modeStr = 0;
                  } else {
                    item.modeStr = 1;
                  }
                } else if (item.modeStr == 0) {
                  item.modeStr = 2;
                }
                data = '9404000001' + parseInt(item.modeStr).toString(16).pad('00');
                post_value = item.modeStr;
                break;
              case 'fan':
                if (item.speedVaule == 4) {
                  if (item.modeStr == 0) {
                    item.speedVaule = 2;
                  } else {
                    item.speedVaule = 1;
                  }
                } else {
                  item.speedVaule++;
                }
                data = '9405000001' + parseInt(item.speedVaule).toString(16).pad('00');
                post_value = item.speedVaule;
                break;
              case 'reduce':
                if (item.temperature != 5) {
                  item.temperature--;
                }
                data = '9406000001' + parseInt(item.temperature).toString(16).pad('00');
                post_value = item.temperature;
                break;
              case 'add':
                if (item.temperature != 32) {
                  item.temperature++;
                }
                data = '9406000001' + parseInt(item.temperature).toString(16).pad('00');
                post_value = item.temperature;
                break;
            }
          },
          cancelTemplate(subItem) {
            subItem.mainType = 1;
            subItem.buttonBoxType = 0;
            subItem.chooseStatus = false;
          },
          chooseTemplate(subItem) {
            this.clickStatus = true;
            //if type is 5,only show the check
            if(type == 5 || type == 7){
              subItem.mainType = 15;
              subItem.chooseStatus = true;
              return;
            }
            //subItem.chooseStatus = true;
            let button_group = subItem.device_button_group;
            let chooseList = [
              {
                value: '01',
                text: 'ON/OFF',
                type: 2,
              },
              {
                value: '02',
                text: 'TOGGLE',
                type: 4,
              }
            ];
            this.subName = subItem.name;
            if (button_group.startsWith('ONOFF GANG') || button_group.startsWith('RCU ONOFF GANG')) {
              
            }else if(button_group.startsWith('Hdmicec')){
              chooseList = [
                {
                  value: '01',
                  text: 'ON/OFF',
                  type: 2,
                },
                {
                  value: '02',
                  text: 'TOGGLE',
                  type: 4,
                },
                {
                  value: '50',
                  text: 'CHECKOUT',
                  type: 50,
                },
              ];
            } else if (button_group.startsWith('Thermostat')) {
              chooseList = [
                {
                  value: '01',
                  text: 'ON/OFF',
                  type: 2,
                },
                {
                  value: '50',
                  text: 'CHECKOUT',
                  type: 50,
                },
              ];
            } else if (button_group.startsWith('RCU DIMMING') || button_group.startsWith('DIMMING')) {
              chooseList = [{
                value: '4',
                text: 'ON/OFF',
                type: 2,
              }];
              chooseList.push({
                value: '2',
                text: 'TOGGLE',
                type: 4,
              });
              chooseList.push({
                value: '3',
                text: 'BRIGHTEN',
                type: 5,
              });
              chooseList.push({
                value: '1',
                text: 'DIM',
                type: 6,
              });
            } else if (button_group.startsWith('OPENCLOSE UART') || button_group.startsWith('OPENCLOSE WIFI UART')) {
              chooseList = [
                {
                  value: '01',
                  text: 'OPEN/CLOSE',
                  type: 7,
                },
                {
                  value: '02',
                  text: 'PAUSE',
                  type: 9,
                },
                {
                  value: '50',
                  text: 'CHECKOUT',
                  type: 50,
                },
              ];
              //this.home_ui_click_touch_app_save(chooseList[0]);
            }else if(button_group.startsWith('RCU OPENCLOSE GANG')){
              this.home_ui_click_touch_app_save({value: '01',text: 'OPEN/CLOSE',type: 7,});
              return;
            }else if(button_group.startsWith('DOOR SIGN')){
              chooseList = [
                {
                  value: '31',
                  text: 'CLEAR ON',
                  type: 10,
                },
                {
                  value: '34',
                  text: 'CLEAR OFF',
                  type: 12,
                },
                {
                  value: '32',
                  text: 'DND ON',
                  type: 11,
                },
                {
                  value: '35',
                  text: 'DND OFF',
                  type: 13,
                },
              ];
            }
            this.labelList = chooseList;
            debugger
            if(this.$popupItem){
              this.$popupItem.open();
            }else{
              //open the pop
              this.$popupItem = app.popup
                .create({
                  el: '.demo-popup-swipe-handler',
                  swipeToClose: true,
                  push: true,
                })
                .open();
            }
          },
          rangeChangeFunDimming(element) {
            console.log(element);
            let value = element.value;
            let el = element.$el;
            let subName = $(el).attr('name');
            console.log(subName);
            this.subdevices.forEach((kitem) => {
              if (kitem.name === subName) {
                kitem.ref = value;
              }
            });
          },
          initRangeBar(guid, button_group, value) {
            setTimeout(() => {
              console.log($(`.range-slider-scene[guid="${guid}"][button_group="${button_group}"]`));
              let range_silder = app.range.create({
                el: `.range-slider-scene[guid="${guid}"][button_group="${button_group}"]`,
                value: isset(value) ? value : 100,
                min: 0,
                max: 100,
                draggableBar: false,
                label: true,
                step: 1,
                scale: true,
                scaleSteps: 5,
                scaleSubSteps: 4,
                on: {
                  changed: this.rangeChangeFunDimming,
                },
              });
            }, 200);
          },
          changeBarUI(guid, device_button_group, present_value) {
            $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`)
              .find('.range-bar-active')
              .css({
                width: present_value + '%',
              });
            $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`)
              .find('.range-knob-wrap')
              .css({
                left: present_value + '%',
              });
            if (present_value > 1) {
              $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`).removeClass('range-slider-min');
            } else {
              $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`).addClass('range-slider-min');
            }
          },
          openCloseItem(item) {
            if (item.ref == 0) {
              barValue = 100;
              item.ref = barValue;
            } else {
              item.ref = 0;
              barValue = 0;
            }
            this.changeBarUI(item.device, item.device_button_group, barValue);
          },
          onOffItem(item) {
            console.log(item);
            let barStatus = false;
            let barValue = 0;
            let hideBottomBar = null;
            if (item.ref == 0) {
              item.ref = 1;
              barValue = 100;
              if (isset(hideBottomBar)) hideBottomBar = false;
            } else {
              item.ref = 0;
              barValue = 0;
              if (isset(hideBottomBar)) hideBottomBar = true;
            }
            if (item.device_button_group.startsWith('DIMMING') || item.device_button_group.startsWith('RCU DIMMING')) {
              barStatus = true;
              if(item.ref == 1){item.ref = barValue};
            }
            if (item.device_button_group.startsWith('Thermostat')) {
              hideBottomBar = true;
            }
            if (barStatus) {
              this.changeBarUI(item.device, item.device_button_group, barValue);
            }
            if (isset(hideBottomBar)) {
              if (hideBottomBar) {
                item.buttonBoxType = 0;
              } else {
                item.buttonBoxType = 3;
              }
            }
          },
          //tindy the command of the choose list
          async tindyCommand() {
            const roomOrder = {};
            this.roomList.forEach((room, idx) => {
              roomOrder[room.name] = idx;
            });
            let this_list = this.subdevices
              .filter((item) => item.chooseStatus)
              .sort((a, b) => {
                const ra = isset(roomOrder[a.profile_room]) ? roomOrder[a.profile_room] : 9999;
                const rb = isset(roomOrder[b.profile_room]) ? roomOrder[b.profile_room] : 9999;
                if (ra !== rb) return ra - rb;
                const na = a.name || '';
                const nb = b.name || '';
                return na.localeCompare(nb);
              });
            
            this_list.forEach((item) => {
              let { device_button_group, name, device, ref,device_mode ,device_model} = item;
              let mackey = core_utils_get_mac_address_from_guid(device, true);
              let command = ``;
              //on off and the rcu on off
              debugger
              if (device_button_group.startsWith('Thermostat')) {
                if(item.chooseType == 50){
                  item.action_command = `02${mackey}13059721038001059721038000`;
                }else{
                  item.action_command = `02${mackey}9403000001${parseInt(ref).toString(16).pad('00')}`;
                  item.thermostat_mode = `02${mackey}9404000001${parseInt(item.modeStr).toString(16).pad('00')}`;
                  item.thermostat_fan = `02${mackey}9405000001${parseInt(item.speedVaule).toString(16).pad('00')}`;
                  item.thermostat_temp = `02${mackey}9406000001${parseInt(item.temperature).toString(16).pad('00')}`;
                }
              }else if(device_button_group.startsWith('DIMMING') || device_button_group.startsWith('RCU DIMMING')){
                if(item.chooseType == 4){
                  item.turnlight = 4;
                  if(ref == 0){
                    item.turnlight = 5;
                  }
                }else{
                  item.turnlight = item.chooseType;
                }
                item.ref = parseInt((item.ref/100)*255);
              } else if (device_button_group.startsWith('OPENCLOSE UART') || device_button_group.startsWith('OPENCLOSE WIFI UART')) {
                //have differ model to be handle
                //check if have gateway
                // let devices = cloneDeep(erp.info.profile.profile_device);
                // let gateway = '';
                // devices.forEach(deviceItem=>{
                //   if(deviceItem.name == item.profile_device){
                //     gateway = deviceItem.gateway;
                    
                //   }
                // })
                // if(gateway){
                //   let mac_address = gateway.split("-")[0];
                //   let cleanedMac = mac_address.replace(/:/g, '').toLowerCase();
                //   let reversedMac = cleanedMac.match(/.{1,2}/g).reverse().join('');
                //   mackey = reversedMac;
                // }
                if(item.chooseType == 50){
                  item.action_command = `02${mackey}13059721038001059721038000`;
                  return;
                }
                let otherModelStatus = false;
                if(device_model == 'YO121-AC-R2W') otherModelStatus = true;
                if(item.ref == 2){
                  let data = `860255AA050101036DDC`;
                  data += core_util_calculate_crc16_modbus_for_doa(data);
                  if(otherModelStatus){
                    data = `8930`;
                  }
                  command = `02${mackey}${data}`;
                  item.action_command = command;
                }else if (device_button_group.includes('REVERSE')) {
                  let data = `860255AA060102${parseInt(100-item.ref).toString(16).pad('00')}FF`;
                  data += core_util_calculate_crc16_modbus_for_doa(data);
                  if(otherModelStatus){
                    data = `8900${parseInt(100-item.ref).toString(16).pad('00')}`;
                  }
                  command = `02${mackey}${data}`;
                  item.action_command = command;
                }else{
                  let data = `860255AA060102${parseInt(item.ref).toString(16).pad('00')}FF`;
                  data += core_util_calculate_crc16_modbus_for_doa(data);
                  if(otherModelStatus){
                    data = `8900${parseInt(item.ref).toString(16).pad('00')}`;
                  }
                  command = `02${mackey}${data}`;
                  item.action_command = command;
                }
              }else if(device_mode == 'RCU Controller'){
                if(item.chooseType == 2){
                  item.ref = 2;
                }
                if(item.virtualId){
                  item.name = `${item.name}-${item.virtualId}`;
                }
              }
            });
            console.log('this_list', this_list);
            debugger
            //send to page
            if(type == 5){
              emitter.emit('save_device_status', {
                data: JSON.stringify(this_list),
              });
              mainView.router.back(mainView.history[mainView.history.length - 2], { force: false });
              return;
            }
            if(type == 100){
              emitter.emit('trigger_master', {
                data: JSON.stringify(this_list),
              });
              mainView.router.back(mainView.history[mainView.history.length - 2], { force: false });
              return;
            }
            emitter.emit('save_action', {
              data: JSON.stringify(this_list),
            });
            mainView.router.back(mainView.history[mainView.history.length - 2], { force: false });
          },
          home_ui_click_touch_app_save(labelItem) {
            this.clickStatus = false;
            debugger
            if(this.$popupItem){
              this.$popupItem.close(50)
            }
            let value = labelItem.value;
            let type = labelItem.type;
            let thisSubItem = null;
            let thisSubIndex = '';
            this.subdevices.forEach((item, index) => {
              if (item.name == this.subName) {
                item.mainType = type;
                thisSubItem = item;
                thisSubIndex = index;
                item.chooseStatus = true;
              }
            });
            thisSubItem.buttonBoxType = 0;
            
            if (
              type == 2 &&
              (thisSubItem.device_button_group.startsWith('DIMMING') || thisSubItem.device_button_group.startsWith('RCU DIMMING'))
            ) {
              thisSubItem.buttonBoxType = 1; //1 dimming range bar ,2 curtain range bar  , 3 thermostat box ,4 IR box
              this.$set(this.subdevices[thisSubIndex],'buttonBoxType',1);
              this.initRangeBar(thisSubItem.device, thisSubItem.device_button_group);
              thisSubItem.turnlight = value;
              thisSubItem.ref = 100;
              thisSubItem.chooseType = 4;
            } else if (type == 2 && thisSubItem.device_button_group.startsWith('Thermostat')) {
              thisSubItem.buttonBoxType = 3;
            }else if(type == 4 && thisSubItem.device_button_group.startsWith("RCU ONOFF GANG")){
              thisSubItem.ref = 2;
            }else if(type == 4){
              thisSubItem.chooseType = 2;
            }else if(type == 5){
              //bri
              thisSubItem.chooseType = 3;
            }else if(type == 6){
              //dim
              thisSubItem.chooseType = 1;
            } else if (type == 7) {
              thisSubItem.buttonBoxType = 2;
              this.initRangeBar(thisSubItem.device, thisSubItem.device_button_group, 100);
              thisSubItem.ref = 100;
            } else if (type == 8) {
              thisSubItem.buttonBoxType = 2;
              this.initRangeBar(thisSubItem.device, thisSubItem.device_button_group, 0);
            }else if(type == 9){
              thisSubItem.chooseType = 8;
              thisSubItem.ref = 2
            }else if(type > 9){
              thisSubItem.chooseType = 9;
              thisSubItem.ref = value;
            } else { 
              thisSubItem.buttonBoxType = 0;
            }
            this.$set(this.subdevices,thisSubIndex,thisSubItem);
            if (isset(this.$popupItem)) {
              this.$popupItem.close();
            }
          },
          toScene(device_item){
            let {device_mode,device_model,local_ip,gateway,device,device_button_group,title,imgUrl,mac_address,room_name,config} = device_item;
            if(device_button_group == 'SCENE MUTIWAY ONOFF GANG1' || device_button_group.startsWith("RCU INPUT")){
              mainView.router.navigate(`/mobile-app/scene-setting?mode=${device_mode}&gateway=${gateway}&model=${device_model}&guid=${device}&button_group=${device_button_group}&display_name=${tran(title)}&mac_address=${mac_address}&img_url=${imgUrl}&room_name=${tran(room_name)}&config=${config}`);
            }else if(device_model == 'YO780'){
              //mainView.router.navigate(`/mobile-app/scene-setting-rcu?mode=${device_mode}&local_ip=${local_ip}&target_guid=${target_guid}&gateway=${gateway}&model=${device_model}&guid=${device}&button_group=${device_button_group}&display_name=${tran(title)}&mac_address=${mac_address}&img_url=${imgUrl}&room_name=${tran(room_name)}`);
            }else{
              mainView.router.navigate(`/mobile-app/scene-setting?mode=${device_mode}&gateway=${gateway}&model=${device_model}&guid=${device}&button_group=${device_button_group}&display_name=${tran(title)}&mac_address=${mac_address}&img_url=${imgUrl}&room_name=${tran(room_name)}&config=${config}`);
            }
          },
          controller_home_switch_room_onclick(index) {
            //change room
            let item_id = `room-bar-title-${index}`;
            let id = `room-${index}-div`;
            console.log($('.media-list'));
            $('.scene-room-box .tab-link').removeClass('tab-link-active');
            $(`#${item_id}`).addClass('tab-link-active');
            if (index == 0) {
              $('.scene-room-box .media-list').show();
            } else {
              $('.scene-room-box .media-list').hide();
              $(`#${id}`).show();
            }
          },
          controller_common_home_collapse(index) {
            const id = `room-${index}-div-title`;
            const room_id = `room-${index}-div`;
            let icon_name = $(`#${id}`).find('i').text();
            if (icon_name == 'expand_more') {
              $(`#${room_id} .scene-room-device-item`).hide();
              $(`#${id}`).find('i').text('chevron_right');
            } else {
              $(`#${room_id} .scene-room-device-item`).show();
              $(`#${id}`).find('i').text('expand_more');
            }
          },
        },
      });
    });
    $on('pageBeforeRemove', (e, page) => {
    console.log("leave")
      if (roomDeviceVueApp) {
        roomDeviceVueApp.$destroy();
      }
    });
    return $render;
  };
</script>

<style>
  .device-hidden {
    display: none;
  }
  .tabbar .tab-link-active,
  .tabbar-labels .tab-link-active {
    background-color: var(--f7-theme-color);
    color: #fff;
  }
  .smart-select .item-after {
    max-width: 100%;
  }
  .tabbar .tab-link-highlight {
    bottom: 0;
    display: none;
  }
  .off_flag > .button.onoff {
    background-color: var(--f7-block-strong-bg-color);
    color: #8e8d93;
    border-color: #8e8d93;
  }
  .off_flag > .button.onoff:after {
    content: 'OFF';
  }
  .popup .list ul::before,.popup .list ul::after{
    content: none;
  }
</style>
