<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Room Device') }}</div>
        <div class="right">
          <a link icon-only @click="${()=>batch_save()}">
            <i class="icon material-icons setting-list-icon p-1" style="font-size: 30px">check</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content">
      {% raw %}
      <div id="vue-app">
        <div class="scene-room-box">
          <div class="toolbar tabbar tabbar-scrollable toolbar-home-room no-show" style="z-index: 5; position: fixed">
            <div class="toolbar-inner">
              <a
                href="#tab-hidden-0"
                ref="0"
                id="room-bar-title-0"
                v-on:click="controller_home_switch_room_onclick(0)"
                class="tab-link tab-link-active"
              >
                <i class="material-icons">home</i>
              </a>
              <a
                v-for="(item,index) in roomList"
                :key="item.name"
                :href="'#ab-hidden-'+item.idx"
                :slot="item.idx"
                :id="'room-bar-title-'+item.idx"
                v-on:click="controller_home_switch_room_onclick(item.idx)"
                class="tab-link"
              >
                {{tran(item.title)}}
              </a>
            </div>
          </div>
          <div style="height: 48px"></div>
          <!-- room list start -->
          <div
            class="list media-list no-margin"
            :id="'room-'+roomItem.idx+'-div'"
            :room="roomItem.name"
            v-for="(roomItem,roomIndex) in roomList"
            :key="roomItem.name"
          >
            <ul>
              <li :id="'room-'+roomItem.idx+'-div-title'" class="swipeout room">
                <div class="item-content swipeout-content">
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div
                        class="item-title"
                        lang="en"
                        :lang-packet="roomItem.title"
                        v-on:click="controller_common_home_collapse(roomItem.idx)"
                      >
                        <i class="room-collapse material-icons" :id="'collapse-'+roomItem.idx"> expand_more </i>
                        {{ tran(roomItem.title) }}
                      </div>
                    </div>
                  </div>
                </div>
              </li>
              <div class="scene-room-device-item">
                <div
                  class="li-item"
                  v-for="(subItem,subIndex) in subdevices"
                  :key="subItem.name"
                  v-if="subItem.profile_room == roomItem.name"
                >
                  <li class="device swipeout" :guid="subItem.device">
                    <div class="item-content swipeout-content">
                      <a
                        class="item-link item-content no-chevron no-ripple no-active-state"
                        style="width: 100%"
                      >
                        <div
                          class="device-thumb item-media"
                          :style="{
                          'background-image' : 'url('+subItem.imgUrl+')',
                          'background-position' : 'center',
                          'background-size' : 'contain',
                          'position' : 'relative'
                        }"
                        ></div>
                        <div class="item-inner">
                          <div class="item-title-row">
                            <div class="item-title ellipsis" lang="en" style="width: 180px">{{tran(subItem.title)}}</div>
                          </div>
                          <div class="item-subtitle">{{ subItem.device_model }}-{{ subItem.mac_address }}</div>
                          <div class="signal-panel item-text height-21" style="width: 120%">
                            <div>
                              <div class="status-info text-color-primary" style="display: none;">{{dealWithType(subItem)}}</div>
                            </div>
                          </div>
                        </div>
                      </a>
                      <div class="control-panel-right" style="">
                        <a class="right" v-on:click="${()=>toScene(subItem)}" v-if="subItem.mainType == 0">
                          <div class="button button-raised button-big circle rf-sensor">
                              <i class="material-icons" style="line-height: 25px!important;">arrow_forward_ios</i>
                          </div>
                        </a>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 1"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">block</i></div>
                        </div>
                        <a
                          :class="subItem.ref == 0?'off_flag':'on_flag'"
                          :onoff="subItem.ref"
                          v-if="subItem.mainType == 2"
                          v-on:click="onOffItem(subItem)"
                        >
                          <div class="button button-raised button-big onoff"></div>
                        </a>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 4"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div><i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">touch_app</i></div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 5"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div>
                            <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">brightness_low</i>
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 6"
                          v-on:click="chooseTemplate(subItem)"
                        >
                          <div>
                            <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">brightness_high</i>
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 7"
                          v-on:click="openCloseItem(subItem)"
                        >
                          <div>
                            <img
                              :src="'https://my.yoswit.com/files/app/'+(subItem.ref === 0 ? 'close' : 'open') +'-curtain.svg'"
                              alt=""
                              style="width: 20px; height: 20px; margin-top: 20px"
                            />
                          </div>
                        </div>
                        <div
                          class="button button-raised button-big circle"
                          v-if="subItem.mainType == 9"
                        >
                        <div>
                          <i class="material-icons" style="line-height: 70px !important; font-size: 25px !important">pause</i>
                        </div>
                        </div>
                      </div>
                    </div>
                    <div class="swipeout-actions-right">
                      <a v-on:click="cancelTemplate(subItem)" class="link color-red">
                        <i class="icon material-icons">cancel</i>
                      </a>
                    </div>
                  </li>
                  <!-- subdevice bottom box start -->
                  <li
                    class="device subdevice"
                    :class="{'device-hidden':subItem.buttonBoxType == 0?true:false,'display-flex':subItem.buttonBoxType == 0?false:true}"
                    :style="{'height': subItem.buttonBoxType == 3?'77px':'67px'}"
                  >
                    <div class="row padding-tb flex-direction-column justify-content-center" v-if="subItem.buttonBoxType == 1">
                      <div class="col-100 medium-100 large-100">
                        <div class="content display-flex justify-content-center" style="margin-left: 15px; margin-right: 15px">
                          <div class="tip-title"><i class="icon material-icons" style="margin-right: 8px">brightness_low</i></div>
                          <div
                            class="range-slider range-slider-scene"
                            :guid="subItem.device"
                            :button_group="subItem.device_button_group"
                            :name="subItem.name"
                          ></div>
                          <div class="tip-title"><i class="icon material-icons" style="margin-left: 8px">brightness_high</i></div>
                        </div>
                      </div>
                    </div>
                    <div class="row padding-tb flex-direction-column justify-content-center" v-if="subItem.buttonBoxType == 2">
                      <div class="col-100 medium-100 large-100">
                        <div class="content display-flex justify-content-center" style="margin-left: 15px; margin-right: 15px">
                          <div class="tip-title">
                            <img
                              src="https://my.yoswit.com/files/app/close-curtain.svg"
                              alt=""
                              style="width: 20px; height: 20px; margin-right: 8px; margin-top: 5px"
                            />
                          </div>
                          <div
                            class="range-slider range-slider-scene"
                            :guid="subItem.device"
                            :button_group="subItem.device_button_group"
                            :name="subItem.name"
                          ></div>
                          <div class="tip-title">
                            <img
                              src="https://my.yoswit.com/files/app/open-curtain.svg"
                              alt=""
                              style="width: 20px; height: 20px; margin-left: 8px; margin-top: 5px"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="item-content" style="width: 100%" v-if="subItem.buttonBoxType == 3">
                      <div class="item-inner">
                        <div
                          class="display-flex justify-content-space-between align-content-center align-items-center"
                          style="--f7-grid-gap: 3px"
                        >
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'mode')"
                            command-type="mode"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px">
                              <img
                                style="width: 25px; height: 25px"
                                :src="'style/img/air_condition/icon-mode-'+dealWithThermostat(subItem.modeStr)+'.png'"
                              />
                            </div>
                          </a>
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'fan')"
                            command-type="fan"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px">
                              <img
                                style="width: 25px; height: 25px"
                                :src="'style/img/air_condition/icon-speed-'+(subItem.speedVaule?subItem.speedVaule:0)+'.png'"
                              />
                            </div>
                          </a>
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'reduce')"
                            command-type="reduce"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px; font-size: 25px">-</div>
                          </a>
                          <a href="#" class="col set-temp" style="line-height: 60px; margin-top: 8px; text-align: center" button-signal="5">
                            <span>{{subItem.temperature}}</span>â„ƒ
                          </a>
                          <a
                            href="#"
                            class="col"
                            v-on:click="clickThermostatChange(subItem,'add')"
                            command-type="reduce"
                            :guid="subItem.device"
                          >
                            <div class="button button-raised button-big stop" style="width: 70px; font-size: 25px">+</div>
                          </a>
                        </div>
                      </div>
                    </div>
                  </li>
                </div>
                <!-- subdevice bottom box end -->
              </div>
            </ul>
          </div>
          <!-- room list end -->
        </div>
        <!-- popup list start -->
        <div class="popup demo-popup-swipe-handler" v-show="clickStatus">
          <div class="view view-init">
            <div class="page page-with-navbar-large">
              <div class="navbar navbar-large navbar-transparent">
                <div class="navbar-bg"></div>
                <div class="navbar-inner">
                  <div class="title"></div>
                  <div class="right">
                    <a class="link popup-close"><i class="material-icons" style="font-size: 40px">cancel</i></a>
                  </div>
                  <div class="title-large">
                    <div class="title-large-text"></div>
                  </div>
                </div>
              </div>
              <div class="page-content">
                <div class="block block-strong-ios block-outline-ios" style="padding: 15px">
                  <div class="list list-strong-ios list-dividers-ios">
                    <ul class="operate-box" style="margin-top: 15px">
                      <li class="radio-box card" style="opacity: 0">
                        <label class="item-radio item-radio-icon-end item-content">
                          <input type="radio" name="demo-radio-light" checked value="100" />
                          <i class="icon icon-radio"></i>
                          <div class="item-inner">
                            <div class="item-title">On</div>
                          </div>
                        </label>
                      </li>
                      <li class="radio-box card" v-for="(labelItem,labelIndex) in labelList" :key="labelItem.value">
                        <div v-on:click="home_ui_click_touch_app_save(labelItem)" style="width: 100%;padding: 15px;">
                          {{labelItem.text}}
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- popup list end -->
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $update = ctx.$update,
      $on = ctx.$on,
      $onBeforeMount = ctx.$onBeforeMount,
      $onMounted = ctx.$onMounted,
      $onBeforeUpdate = ctx.$onBeforeUpdate,
      $onUpdated = ctx.$onUpdated,
      $onBeforeUnmount = ctx.$onBeforeUnmount,
      $onUnmounted = ctx.$onUnmounted;
    const {title,type,target_guid} = $f7route.query;
    const batch_save = () => {
      vueApp.$batchSave();
    };
    const cancelAll = () => {
      vueApp.$reSet();
    };
    let vueApp = null;
    //let {guid,model,device_mode,button_group,img_url,room_name,mac_address,local_ip,target_guid} = $f7route.query;
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          subdevices: [],
          roomList: [],
          labelList: [],
          popupItem: null,
          subName: 0,
          clickStatus : false
        },
        computed: {
          dealWithType() {
            return function (item) {
              let showStr = '';
              if (!item.mainType) {
                showStr = 'UNSELECTED';
              } else if (item.mainType == 2) {
                showStr = 'TYPE/ONOFF';
              } else if (item.mainType == 4) {
                showStr = 'TYPE/TOGGLE';
              } else if (item.mainType == 5) {
                showStr = 'TYPE/BRIGHTEN';
              } else if (item.mainType == 6) {
                showStr = 'TYPE/DIM';
              } else if (item.mainType == 7) {
                showStr = 'TYPE/OPENCLOSE';
              }
              return showStr;
            };
          },
          dealWithThermostat(){
            return function (modeStr){
              let showStr = '';
              if(modeStr == 0){
                showStr = 4
              }else if(modeStr == 2){
                showStr = 2;
              }else if(modeStr == 1){
                showStr = 5;
              }
              return showStr;
            }
          }
        },
        mounted() {
          this.init();
          Vue.prototype.$batchSave = this.tindyCommand;
        },
        methods: {
          sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          },
          async init() {
            //init the roomList
            this.roomList = cloneDeep(erp.info.profile.profile_room);
            //init the deviceList
            let devices = cloneDeep(erp.info.profile.profile_subdevice);
            //init the profile_device
            let profile_devices = cloneDeep(erp.info.profile.profile_device);
            devices.forEach((item) => {
              let device_name = item.profile_device;
              profile_devices.forEach((kitem) => {
                if (device_name === kitem.name) {
                  item.device_model = kitem.device_model;
                  item.mac_address = kitem.device_name;
                }
              });
            });
            //init the modelList
            let models = cloneDeep(erp.doctype.device_model);
            devices.forEach((item) => {
              //var the right button type
              if(type == 1){
                item.mainType = 0;
              }else{
                item.mainType = 1;
              }
              
              item.buttonBoxType = 0;
              item.ref = 1;
              //choose status
              item.chooseStatus = false;
              let model = item.device_model;
              if (model == 'YO360') {
                item.modeStr = 2;
                item.speedVaule = 4;
                item.temperature = 26;
              }
              for (let i in models) {
                if (models[i].model_code === model) {
                  if (isset(models[i].image)) {
                    item.imgUrl = models[i].image;
                  } else {
                    item.imgUrl = 'https://my.yoswit.com/files/products/YO815.svg';
                  }
                }
              }
            });
            this.subdevices = devices;
          },
          clickThermostatChange(item, click_type) {
            console.log(item, click_type);
            let data = '';
            let post_value = ``;
            switch (click_type) {
              case 'mode':
                if (item.modeStr == 1) {
                  item.modeStr = 0;
                } else if (item.modeStr == 2) {
                  let devices = cloneDeep(erp.info.device);
                  let device = devices[item.device];
                  let mode_seetting = '';
                  if (isset(device)) {
                    let list = device.settings;
                    list.forEach((item) => {
                      if (item.setting_type === 'mode_selection') {
                        mode_seetting = item.setting;
                      }
                    });
                  }
                  if (mode_seetting == 'Cooling') {
                    item.modeStr = 0;
                  } else {
                    item.modeStr = 1;
                  }
                } else if (item.modeStr == 0) {
                  item.modeStr = 2;
                }
                data = '9404000001' + parseInt(item.modeStr).toString(16).pad('00');
                post_value = item.modeStr;
                break;
              case 'fan':
                if (item.speedVaule == 4) {
                  if (item.modeStr == 0) {
                    item.speedVaule = 2;
                  } else {
                    item.speedVaule = 1;
                  }
                } else {
                  item.speedVaule++;
                }
                data = '9405000001' + parseInt(item.speedVaule).toString(16).pad('00');
                post_value = item.speedVaule;
                break;
              case 'reduce':
                if (item.temperature != 5) {
                  item.temperature--;
                }
                data = '9406000001' + parseInt(item.temperature).toString(16).pad('00');
                post_value = item.temperature;
                break;
              case 'add':
                if (item.temperature != 32) {
                  item.temperature++;
                }
                data = '9406000001' + parseInt(item.temperature).toString(16).pad('00');
                post_value = item.temperature;
                break;
            }
          },
          cancelTemplate(subItem) {
            subItem.mainType = 1;
            subItem.buttonBoxType = 0;
            subItem.chooseStatus = false;
          },
          chooseTemplate(subItem) {
            this.clickStatus = true;
            subItem.chooseStatus = true;
            let button_group = subItem.device_button_group;
            let chooseList = [
              {
                value: '01',
                text: 'ON/OFF',
                type: 2,
              },
              {
                value: '02',
                text: 'TOGGLE',
                type: 4,
              }
            ];
            this.subName = subItem.name;
            if (button_group.startsWith('ONOFF GANG') || button_group.startsWith('RCU ONOFF GANG')) {
              
            } else if (button_group.startsWith('Thermostat')) {
              this.home_ui_click_touch_app_save(chooseList[0]);
              return;
            } else if (button_group.startsWith('RCU DIMMING') || button_group.startsWith('DIMMING')) {
              chooseList = [{
                value: '4',
                text: 'ON/OFF',
                type: 2,
              }];
              chooseList.push({
                value: '2',
                text: 'TOGGLE',
                type: 4,
              });
              chooseList.push({
                value: '3',
                text: 'BRIGHTEN',
                type: 5,
              });
              chooseList.push({
                value: '1',
                text: 'DIM',
                type: 6,
              });
            } else if (button_group.startsWith('OPENCLOSE UART')) {
              chooseList = [
                {
                  value: '01',
                  text: 'OPEN/CLOSE',
                  type: 7,
                },
                {
                  value: '02',
                  text: 'PAUSE',
                  type: 9,
                },
              ];
              //this.home_ui_click_touch_app_save(chooseList[0]);
            }
            this.labelList = chooseList;
            //open the pop
            this.popupItem = app.popup
              .create({
                el: '.demo-popup-swipe-handler',
                swipeToClose: true,
                push: true,
              })
              .open();
          },
          rangeChangeFunDimming(element) {
            console.log(element);
            let value = element.value;
            let el = element.$el;
            let subName = $(el).attr('name');
            console.log(subName);
            this.subdevices.forEach((kitem) => {
              if (kitem.name === subName) {
                kitem.ref = value;
              }
            });
          },
          initRangeBar(guid, button_group, value) {
            console.log($(`.range-slider-scene[guid="${guid}"][button_group="${button_group}"]`));
            setTimeout(() => {
              let range_silder = app.range.create({
                el: `.range-slider-scene[guid="${guid}"][button_group="${button_group}"]`,
                value: isset(value) ? value : 100,
                min: 0,
                max: 100,
                draggableBar: false,
                label: true,
                step: 1,
                scale: true,
                scaleSteps: 5,
                scaleSubSteps: 4,
                on: {
                  changed: this.rangeChangeFunDimming,
                },
              });
            }, 150);
          },
          changeBarUI(guid, device_button_group, present_value) {
            $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`)
              .find('.range-bar-active')
              .css({
                width: present_value + '%',
              });
            $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`)
              .find('.range-knob-wrap')
              .css({
                left: present_value + '%',
              });
            if (present_value > 1) {
              $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`).removeClass('range-slider-min');
            } else {
              $(`.range-slider-scene[guid="${guid}"][button_group="${device_button_group}"]`).addClass('range-slider-min');
            }
          },
          openCloseItem(item) {
            if (item.ref == 0) {
              barValue = 100;
              item.ref = barValue;
            } else {
              item.ref = 0;
              barValue = 0;
            }
            this.changeBarUI(item.device, item.device_button_group, barValue);
          },
          onOffItem(item) {
            console.log(item);
            let barStatus = false;
            let barValue = 0;
            let hideBottomBar = null;
            if (item.ref == 0) {
              item.ref = 1;
              barValue = 100;
              if (isset(hideBottomBar)) hideBottomBar = false;
            } else {
              item.ref = 0;
              barValue = 0;
              if (isset(hideBottomBar)) hideBottomBar = true;
            }
            if (item.device_button_group.startsWith('DIMMING') || item.device_button_group.startsWith('RCU DIMMING')) {
              barStatus = true;
              if(item.ref == 1){item.ref = barValue};
            }
            if (item.device_button_group.startsWith('Thermostat')) {
              hideBottomBar = true;
            }
            if (barStatus) {
              this.changeBarUI(item.device, item.device_button_group, barValue);
            }
            if (isset(hideBottomBar)) {
              if (hideBottomBar) {
                item.buttonBoxType = 0;
              } else {
                item.buttonBoxType = 3;
              }
            }
          },
          //tindy the command of the choose list
          async tindyCommand() {
            let this_list = this.subdevices.filter((item) => item.chooseStatus);
            this_list.forEach((item) => {
              let { device_button_group, name, device, ref,device_mode } = item;
              let mackey = core_utils_get_mac_address_from_guid(device, true);
              let command = ``;
              //on off and the rcu on off
              if (device_button_group.startsWith('Thermostat')) {
                item.action_command = `02${mackey}9403000001${parseInt(ref).toString(16).pad('00')}`;
                item.thermostat_mode = `02${mackey}9404000001${parseInt(item.modeStr).toString(16).pad('00')}`;
                item.thermostat_fan = `02${mackey}9405000001${parseInt(item.speedVaule).toString(16).pad('00')}`;
                item.thermostat_temp = `02${mackey}9406000001${parseInt(item.temperature).toString(16).pad('00')}`;
              }else if(device_button_group.startsWith('DIMMING') || device_button_group.startsWith('RCU DIMMING')){
                if(item.chooseType == 4){
                  item.turnlight = 4;
                  if(ref == 0){
                    item.turnlight = 5;
                  }
                }else{
                  item.turnlight = item.chooseType;
                }
                item.ref = parseInt((item.ref/100)*255);
              } else if (device_button_group.startsWith('OPENCLOSE UART')) {
                if(item.ref == 2){
                  let data = `55AA050101036DDC`;
                  data += core_util_calculate_crc16_modbus_for_doa(data);
                  command = `02${mackey}8602${data}`;
                  item.action_command = command;
                }else if (device_button_group.includes('REVERSE')) {
                  let data = `55AA060102${parseInt(100-item.ref).toString(16).pad('00')}FF`;
                  data += core_util_calculate_crc16_modbus_for_doa(data);
                  command = `02${mackey}8602${data}`;
                  item.action_command = command;
                }else{
                  let data = `55AA060102${parseInt(item.ref).toString(16).pad('00')}FF`;
                  data += core_util_calculate_crc16_modbus_for_doa(data);
                  command = `02${mackey}8602${data}`;
                  item.action_command = command;
                }
              }else if(device_mode == 'RCU Controller'){
                if(item.chooseType == 2){
                  item.ref = 2;
                }
              }
            });
            console.log('this_list', this_list);
            //send to page
            emitter.emit('save_action', {
              data: JSON.stringify(this_list),
            });
            mainView.router.back(mainView.history[mainView.history.length - 2], { force: false });
          },
          home_ui_click_touch_app_save(labelItem) {
            this.clickStatus = false;
            if(this.popupItem){
              this.popupItem.close(50)
            }
            let value = labelItem.value;
            let type = labelItem.type;
            let thisSubItem = null;
            let thisSubIndex = '';
            this.subdevices.forEach((item, index) => {
              if (item.name == this.subName) {
                item.mainType = type;
                thisSubItem = item;
                thisSubIndex = index;
              }
            });
            thisSubItem.buttonBoxType = 0;
            if (
              type == 2 &&
              (thisSubItem.device_button_group.startsWith('DIMMING') || thisSubItem.device_button_group.startsWith('RCU DIMMING'))
            ) {
              thisSubItem.buttonBoxType = 1; //1 dimming range bar ,2 curtain range bar  , 3 thermostat box ,4 IR box
              this.initRangeBar(thisSubItem.device, thisSubItem.device_button_group);
              thisSubItem.turnlight = value;
              thisSubItem.ref = 100;
              thisSubItem.chooseType = 4;
            } else if (type == 2 && thisSubItem.device_button_group.startsWith('Thermostat')) {
              thisSubItem.buttonBoxType = 3;
            }else if(type == 4){
              thisSubItem.chooseType = 2;
            }else if(type == 5){
              //bri
              thisSubItem.chooseType = 3;
            }else if(type == 6){
              //dim
              thisSubItem.chooseType = 1;
            } else if (type == 7) {
              thisSubItem.buttonBoxType = 2;
              this.initRangeBar(thisSubItem.device, thisSubItem.device_button_group, 100);
              thisSubItem.ref = 100;
            } else if (type == 8) {
              thisSubItem.buttonBoxType = 2;
              this.initRangeBar(thisSubItem.device, thisSubItem.device_button_group, 0);
            }else if(type == 9){
              thisSubItem.chooseType = 8;
              thisSubItem.ref = 2
            } else { 
              thisSubItem.buttonBoxType = 0;
            }
            if (isset(this.popupItem)) {
              this.popupItem.close();
            }
          },
          toScene(device_item){
            let {device_mode,device_model,local_ip,gateway,device,device_button_group,title,imgUrl,mac_address,room_name,config} = device_item;
            if(device_button_group == 'SCENE MUTIWAY ONOFF GANG1'){
              mainView.router.navigate(`/mobile-app/scene-setting?mode=${device_mode}&gateway=${gateway}&model=${device_model}&guid=${device}&button_group=${device_button_group}&display_name=${tran(title)}&mac_address=${mac_address}&img_url=${imgUrl}&room_name=${tran(room_name)}&config=${config}`);
            }else if(device_model == 'YO780'){
              //mainView.router.navigate(`/mobile-app/scene-setting-rcu?mode=${device_mode}&local_ip=${local_ip}&target_guid=${target_guid}&gateway=${gateway}&model=${device_model}&guid=${device}&button_group=${device_button_group}&display_name=${tran(title)}&mac_address=${mac_address}&img_url=${imgUrl}&room_name=${tran(room_name)}`);
            }else{
              mainView.router.navigate(`/mobile-app/scene-setting?mode=${device_mode}&gateway=${gateway}&model=${device_model}&guid=${device}&button_group=${device_button_group}&display_name=${tran(title)}&mac_address=${mac_address}&img_url=${imgUrl}&room_name=${tran(room_name)}&config=${config}`);
            }
          },
          controller_home_switch_room_onclick(index) {
            //change room
            let item_id = `room-bar-title-${index}`;
            let id = `room-${index}-div`;
            console.log($('.media-list'));
            $('.scene-room-box .tab-link').removeClass('tab-link-active');
            $(`#${item_id}`).addClass('tab-link-active');
            if (index == 0) {
              $('.scene-room-box .media-list').show();
            } else {
              $('.scene-room-box .media-list').hide();
              $(`#${id}`).show();
            }
          },
          controller_common_home_collapse(index) {
            const id = `room-${index}-div-title`;
            const room_id = `room-${index}-div`;
            let icon_name = $(`#${id}`).find('i').text();
            if (icon_name == 'expand_more') {
              $(`#${room_id} .scene-room-device-item`).hide();
              $(`#${id}`).find('i').text('chevron_right');
            } else {
              $(`#${room_id} .scene-room-device-item`).show();
              $(`#${id}`).find('i').text('expand_more');
            }
          },
        },
      });
    });
    $on('pageBeforeUnmount', (e, page) => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });
    return $render;
  };
</script>

<style>
  .device-hidden {
    display: none;
  }
  .tabbar .tab-link-active,
  .tabbar-labels .tab-link-active {
    background-color: var(--f7-theme-color);
    color: #fff;
  }
  .smart-select .item-after {
    max-width: 100%;
  }
  .tabbar .tab-link-highlight {
    bottom: 0;
    display: none;
  }
  .off_flag > .button.onoff {
    background-color: var(--f7-block-strong-bg-color);
    color: #8e8d93;
    border-color: #8e8d93;
  }
  .off_flag > .button.onoff:after {
    content: 'OFF';
  }
  .popup .list ul::before,.popup .list ul::after{
    content: none;
  }
</style>
