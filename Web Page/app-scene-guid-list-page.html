<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Scene List') }}</div>
        <div class="right scene-list-right device-hidden">
          <a class="link icon-only" @click="${()=>checkScene()}">
            <i class="icon material-icons md-only">construction</i>
          </a>
          <a class="link icon-only" @click="${()=>downloadBle()}">
            <i class="icon material-icons md-only">download</i>
          </a>
          <a class="link icon-only" @click="${()=>delAllScene()}">
            <i class="icon material-icons md-only">restart_alt</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content ptr-content" style="height: 100%" @ptr:refresh="${refresh}">
      <div class="ptr-preloader">
        <div class="preloader"></div>
        <div class="ptr-arrow"></div>
      </div>
      {% raw %}
      <div id="vue-app" v-cloak>
        <div class="list ha-guide-list">
          <ul>
            <li class="swipeout scene swipeout-delete-manual" v-for="(item,index) in sceneList" :key="item.name">
              <div class="card swipeout-content no-shadow no-border bg-color-gray margin-bottom overflow-hidden text-color-white h-110">
                <div class="overlay"></div>
                <div
                  class="coverimg width-100 position-absolute lazy lazy-fade-in"
                  :style="{'height': '100%','background-size': 'cover','background-image': 'url('+frappe_get_url(item.image)+')'}"
                ></div>
                <div class="card-content card-content-padding">
                  <div
                    :class="item.isCorrect ? 'template-info' : 'display-flex justify-content-space-between align-items-center'"
                    style="
                      text-shadow:
                        1px 1px 2px grey,
                        0 0 2px black,
                        0 0 2px grey;
                    "
                  >
                    <span v-if="!item.isCorrect" class="material-icons" style="color: red;font-size: 30px;margin-left: 15px;">priority_high</span> 
                    <span v-on:click="showSceneAction(item)">{{_(item.scene_template)}}</span>
                  </div>
                  <div class="item-content">
                    <div class="item-inner">
                      <div
                        class="h5 d-block text-color-white margin-bottom-half"
                        style="
                          text-shadow:
                            1px 1px 2px grey,
                            0 0 2px black,
                            0 0 2px grey;
                        "
                      >
                        {{_(item.title)}}
                        <div v-if="item.virtualId" class="text-color-white" style="font-size: 12px">{{_('V-ID: ')}}{{item.virtualId}}</div>
                      </div>
                    </div>
                    <div class="item-after" style="width: 150px;flex-wrap: wrap;justify-content: center;">
                      <a
                        class="button button-small button-round button-fill icon-button"
                        v-on:click="executeScene(item)"
                        style="width: 40px; height: 40px; border-radius: 50%"
                      >
                        <i class="f7-icons" style="font-size: 18px">play_arrow</i>
                      </a>
                      <a
                        class="button button-small button-round button-fill icon-button"
                        v-on:click="toDetail(item)"
                        style="width: 40px; height: 40px; border-radius: 50%; margin-left: 10px"
                      >
                        <i class="f7-icons" style="font-size: 18px">doc_text_search</i>
                      </a>
                      <a
                        class="button button-small button-round button-fill icon-button"
                        v-on:click="createSubdevice(item)"
                        style="width: 40px; height: 40px; border-radius: 50%; margin-left: 10px"
                      >
                        <i class="icon material-icons" style="font-size: 18px">input</i>
                      </a>
                      <a
                        class="button button-small button-round button-fill icon-button"
                        v-on:click="checkSingleScene(item)"
                        style="width: 40px; height: 40px; border-radius: 50%; margin-left: 10px"
                      >
                        <i class="icon material-icons" style="font-size: 18px">construction</i>
                      </a>
                      <a
                        class="button button-small button-round button-fill icon-button"
                        style="background-color: red; margin-left: 10px; width: 40px; height: 40px; border-radius: 50%"
                        v-on:click="onDeleted(item)"
                      >
                        <i class="icon material-icons" style="font-size: 20px">delete</i>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </div>
        <div class="device-null" v-if="sceneList.length == 0">
          <div class="block" style="text-align: center">
            <span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
            <p></p>
          </div>
          <div class="block block-strong">
            <p class="row">
              <a class="col button button-large" v-on:click="toScene()">{{ _('Create Scene') }}</a>
            </p>
          </div>
        </div>
        <div class="fab fab-right-bottom">
          <a style="text-align: center" v-on:click="toScene()">
            <i class="icon material-icons">add</i>
          </a>
        </div>
      </div>
      {% endraw %}
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $onUnmounted = ctx.$onUnmounted,
      $on = ctx.$on;

    let vueApp = null;
    let { guid, subdevice_name } = $f7route.query;
    const refresh = async (e, done) => {
      await ha_profile_ready();
      vueApp.$init();
      done();
    };
    const checkScene = async () => {
      vueApp.$checkScene();
    };
    const downloadBle = async () => {
      vueApp.$download();
    };
    const delAllScene = async () => {
      let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
      let guid = '';
      profile_subdevices.forEach((item) => {
        if (item.name == subdevice_name) {
          guid = item.device;
        }
      });
      let triggerCommand = `8f210000ff`;
      let actionCommand = `8f1100ff`;
      let deleteRawSwtting = '8f1400ff';
      let deleteToogle = `972203ff02`;
      let deleteToggleOn = `972203ff01`;
      let deleteToggleOff = `972203ff00`;
      app.dialog.confirm(
        `${_('Confirm Deletion?')}`,
        () => {
          app.dialog.preloader();
          let bleList = [{
            service: 'ff80',
            characteristic: 'ff81',
            data: triggerCommand,
          },{
            service: 'ff80',
            characteristic: 'ff81',
            data: actionCommand,
          },
          {
            service: 'ff80',
            characteristic: 'ff81',
            data: deleteRawSwtting,
          },
          {
            service: 'ff80',
            characteristic: 'ff81',
            data: deleteToogle,
          },
          {
            service: 'ff80',
            characteristic: 'ff81',
            data: deleteToggleOn,
          },
          {
            service: 'ff80',
            characteristic: 'ff81',
            data: deleteToggleOff,
          },
        ];
          if (window.peripheral[guid].prop.connected) {
            window.peripheral[guid].disconnect().then(() => {
              window.peripheral[guid]
                .write(bleList)
                .then(() => {
                  app.dialog.close();
                  //disconnect the peripheral
                  window.peripheral[guid].disconnect();
                  app.dialog.alert('BLE Clear Successfully');
                })
                .catch((error) => {
                  app.dialog.close();
                  app.dialog.alert(erp.get_log_description(error));
                  return;
                });
            });
          } else {
            window.peripheral[guid]
              .write(bleList)
              .then(() => {
                app.dialog.close();
                app.dialog.alert('BLE Clear Successfully');
              })
              .catch((error) => {
                app.dialog.close();
                app.dialog.alert(erp.get_log_description(error));
                return;
              });
          }
        },
        () => {}
      );
    };
    window.retryGenerateDeviceModel = ()=>{
      console.log('retryGenerateDeviceModel');
      vueApp.$retryGenerateDeviceModel();
    }
    $on('pageMounted', (e, page) => {
      vueApp = new Vue({
        el: page.el.querySelector('#vue-app'),
        data: {
          sceneList: [],
          localTrigerSceneList: [],
          localActionSceneList: [],
          sheetMap: {},
          sceneMapList:[],
          deviceDetailList:[],
          isSingleCheck: false,
          singleSceneMap:null,
        },
        computed: {},
        mounted() {
          Vue.prototype.$init = this.init;
          Vue.prototype.$download = this.download;
          Vue.prototype.$checkScene = this.checkScene;
          Vue.prototype.$retryGenerateDeviceModel = this.retryGenerateDeviceModel;
          this.scan();
          this.init();
          emitter.on('refresh', (data) => {
            this.init();
          });
        },
        methods: {
          showSceneAction(item){
            console.log('item', item);
            try{
              let action = JSON.parse(item.action);
              let actionList = action.actionList;
              let ui_configuration = item.ui_configuration?JSON.parse(item.ui_configuration):{};
              let deviceStatusList = [];
              if(isset(ui_configuration.deviceStatusList)){
                deviceStatusList = ui_configuration.deviceStatusList;
              }
              let statusHtml = '';
              for(let i in deviceStatusList){
                let deviceStatus = deviceStatusList[i];
                let device = deviceStatus.device;
                let status = deviceStatus.ref;
                statusHtml += `<li class="manufacturing-steps manufacturing-step1">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">
                      <span class="device-title">${tran(deviceStatus.title)}</span>
                      <p>
                        <span class="room-title text-color-gray">${deviceStatus.virtualId?_('virtualId'):deviceStatus.device_button_group}</span>
                      </p>
                    </div>
                  </div>
                </div>
              </li>`;
              }
              //show the action list
              let html = '';
              for(let i in actionList){
                html += `<li class="manufacturing-steps manufacturing-step1">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">
                      <span class="device-title">${tran(actionList[i].title)} - ${actionList[i].mac_address?actionList[i].mac_address:'RCU'}</span>
                      <p>
                        <span class="room-title text-color-gray">${actionList[i].virtualId?_('virtualId'):_('Button Group')}</span>
                        <span class="room-title text-color-gray">/</span>
                        <span class="room-title text-color-gray">${actionList[i].virtualId?actionList[i].virtualId:actionList[i].device_button_group}</span>
                      </p>
                    </div>
                    <div class="item-after">
                      <span>${actionList[i].ref}</span>
                    </div>
                  </div>
                </div>
              </li>`;
              }
              this.sceneSheet = app.sheet.create({
              content: `
                <div class="sheet-modal" style="height:auto">
                  <div class="sheet-modal-inner">
                    <div class="swipe-handler"></div>
                    <div class="page-content" style="height:600px;">
                      <div class="list list-strong list-outline list-dividers-ios">
                        <ul class="manufacturing-steps-list">
                        ${html}
                        </ul>
                      </div>
                      <div class="list list-strong list-outline list-dividers-ios">
                        <div class="item-content">
                          <div class="item-inner">
                            <div class="item-title">
                              <span class="device-title">${_('Device Status')}</span>
                            </div>
                          </div>
                        </div>
                        <ul class="manufacturing-steps-list">
                        ${statusHtml}
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              `,
              on: {
                closed: () => {
                  console.log('closed');
                },
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.sceneSheet.open();
            }catch(error){
              console.log('error', error);
            }
          },
          async checkSingleScene(item){
            console.log('item', item);
            this.isSingleCheck = true;
            this.singleSceneMap = item;
            let deviceList = [];
            let list = item.scene_device_location;
            for(let i in list){
              if(deviceList.indexOf(list[i].device) == -1){
                deviceList.push(list[i].device);
              }
            }
            console.log('deviceList', deviceList);
            let deviceDetailList = [];
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let profile_device = cloneDeep(erp.info.profile.profile_device);
            deviceList.forEach((item) => {
              let titleList = [];
              let roomNameList = [];
              let obj = {
                titleList : [],
                roomNameList : [],
                device : item,
                device_model : '',
                device_name : '',
                connectStatus : 0, //0: not connect, 1: connected 2: connecting
                errorLog : '',
              }
              profile_subdevices.forEach((subdevice) => {
                if(subdevice.device == item){

                  if(titleList.indexOf(subdevice.title) == -1){
                    titleList.push(subdevice.title);
                  }
                  if(roomNameList.indexOf(subdevice.room_name) == -1){
                    roomNameList.push(subdevice.room_name);
                  }
                }
              });
              profile_device.forEach((device) => {
                if(device.device == item){
                  obj.device_name = device.device_name;
                  obj.device_model = device.device_model;
                }
              });
              obj.titleList = titleList;
              obj.roomNameList = roomNameList;
              deviceDetailList.push(obj);
            });
            this.deviceDetailList = deviceDetailList;
            this.generateDeviceModel();
          },
          async checkScene(){
            /*
            1. select all the device in this scene
            2. try to connect the device and get the notification
            3. group the data and save in the erp
            4. design the data object
          [
            {
              guid : '',
              sceneId : '',
              actionCommand : [],
              triggerCommand : [],
              toggleSettingCommand : [],
              toggleOnCommand:[],
              toggleOffCommand : [],
              rawSettingCommand:[],
              virtualIdCommand : [],
            }
          ]
            */
            this.isSingleCheck = false;
            let sceneMap = cloneDeep(erp.info.scene);
            let deviceList = [];
            for(let i in sceneMap){
              let list = sceneMap[i].scene_device_location;
              for(let j in list){
                if(deviceList.indexOf(list[j].device) == -1){
                  deviceList.push(list[j].device);
                }
              }
            }
            console.log('deviceList', deviceList);
            //load the device detail list
            let deviceDetailList = [];
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let profile_device = cloneDeep(erp.info.profile.profile_device);
            deviceList.forEach((item) => {
              let titleList = [];
              let roomNameList = [];
              let obj = {
                titleList : [],
                roomNameList : [],
                device : item,
                device_model : '',
                device_name : '',
                connectStatus : 0, //0: not connect, 1: connected 2: connecting
                errorLog : '',
              }
              profile_subdevices.forEach((subdevice) => {
                if(subdevice.device == item){

                  if(titleList.indexOf(subdevice.title) == -1){
                    titleList.push(subdevice.title);
                  }
                  if(roomNameList.indexOf(subdevice.room_name) == -1){
                    roomNameList.push(subdevice.room_name);
                  }
                }
              });
              profile_device.forEach((device) => {
                if(device.device == item){
                  obj.device_name = device.device_name;
                  obj.device_model = device.device_model;
                }
              });
              obj.titleList = titleList;
              obj.roomNameList = roomNameList;
              deviceDetailList.push(obj);
            });
            console.log('deviceDetailList', deviceDetailList);
            this.deviceDetailList = deviceDetailList;
            this.generateDeviceModel();
          },
          retryGenerateDeviceModel(){
            console.log('retryGenerateDeviceModel');
            this.getDeviceNotification(this.deviceDetailList);
            // this.deviceSheet.close();
            // this.generateDeviceModel(this.deviceDetailList);
          },
          generateSingleDeviceModel(list){
            let html = '';
            for(let i in list){
              if(!list[i].device_name){
                continue;
              }
              html += `<li class="manufacturing-steps manufacturing-step1" deviceName="${list[i].device_name}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">
                      <span class="device-title">${list[i].device_model}</span>
                      <span class="device-title">-</span>
                      <span class="device-title">${list[i].device_name}</span>
                      <p>
                        <span class="room-title text-color-gray">${tran(list[i].roomNameList[0])}</span>
                        <span class="room-title text-color-gray">/</span>
                        <span class="room-title text-color-gray">${tran(list[i].titleList[0])}</span>
                      </p>
                      <p class="error-log text-color-red">${list[i].errorLog}</p>
                    </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>`;
            }
            this.deviceSheet = app.sheet.create({
              content: `
                <div class="sheet-modal" style="height:auto">
                  <div class="sheet-modal-inner">
                    <div class="swipe-handler"></div>
                    <div class="page-content" style="height:600px;">
                      <div class="list list-strong list-outline list-dividers-ios">
                        <ul class="manufacturing-steps-list">
                        ${html}
                        </ul>
                      </div>
                      <div class="block block-strong">
                        <p class="row">
                          <div class="col">
                            <div class="button button-raised button-fill button-save" func="retryGenerateDeviceModel">${ _('Retry') }</div>
                          </div>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              `,
              on: {
                closed: () => {
                  console.log('closed');
                },
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.deviceSheet.open();
            this.getDeviceNotification(list);
          },
          generateDeviceModel(){
            //generate the device model
            let html = '';
            let list = this.deviceDetailList;
            for(let i in list){
              if(!list[i].device_name){
                continue;
              }
              html += `<li class="manufacturing-steps manufacturing-step1" deviceName="${list[i].device_name}">
                <div class="item-content">
                  <div class="item-inner">
                    <div class="item-title">
                      <span class="device-title">${list[i].device_model}</span>
                      <span class="device-title">-</span>
                      <span class="device-title">${list[i].device_name}</span>
                      <p>
                        <span class="room-title text-color-gray">${tran(list[i].roomNameList[0])}</span>
                        <span class="room-title text-color-gray">/</span>
                        <span class="room-title text-color-gray">${tran(list[i].titleList[0])}</span>
                      </p>
                      <p class="error-log text-color-red">${list[i].errorLog}</p>
                    </div>
                    <div class="item-after">
                      <i class="icon material-icons">watch_later</i>
                    </div>
                  </div>
                </div>
              </li>`;
            }
            this.deviceSheet = app.sheet.create({
              content: `
                <div class="sheet-modal" style="height:auto">
                  <div class="sheet-modal-inner">
                    <div class="swipe-handler"></div>
                    <div class="page-content" style="height:600px;">
                      <div class="list list-strong list-outline list-dividers-ios">
                        <ul class="manufacturing-steps-list">
                        ${html}
                        </ul>
                      </div>
                      <div class="block block-strong">
                        <p class="row">
                          <div class="col">
                            <div class="button button-raised button-fill button-save" func="retryGenerateDeviceModel">${ _('Retry') }</div>
                          </div>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              `,
              on: {
                closed: () => {
                  console.log('closed');
                },
              },
              swipeToClose: true,
              push: true,
              backdrop: true,
            });
            this.deviceSheet.open();
            this.getDeviceNotification(list);
          },
          async getDeviceNotification(list){
            const getSceneData = (device_id,guid)=>{
              return new Promise(async(resolve, reject)=>{
                let sceneMap = {
                  guid : guid,
                  actionCommandList : [],
                  triggerCommandList : [],
                  toggleSettingCommandList : [],
                  toggleOnCommandList : [],
                  toggleOffCommandList : [],
                  rawSettingCommandList : [],
                };
                //defind the timeout
                let timeout = 1000*35;
                let timeoutId = null;
                timeoutId = setTimeout(()=>{
                  reject('timeout');
                },timeout);
                let commandList = [];
                //get the notification
                await ble.startNotification(device_id, 'ff80', 'ff82', (rs) => {
                  commandList.push(rs);
                  console.log('rs', rs);
                  if ((rs.startsWith('8f20') || rs.startsWith('8f22')) && rs.length > 8){
                    //trigger command
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    sceneMap.triggerCommandList.push({
                      sceneId : thisSceneId,
                      command : rs,
                    });
                  }else if((rs.startsWith('8f10') || rs.startsWith('8f12')) && rs.length > 8){
                    //action command
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    sceneMap.actionCommandList.push({
                      sceneId : thisSceneId,
                      command : rs,
                    });
                  }else if(rs.startsWith('972303') && rs.length > 10 && rs.substring(8,10) == '02'){
                    //toggle setting command
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    sceneMap.toggleSettingCommandList.push({
                      sceneId : thisSceneId,
                      command : rs,
                    });
                  }else if(rs.startsWith('972303') && rs.length > 10 && rs.substring(8,10) == '01'){
                    //toggle on command
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    sceneMap.toggleOnCommandList.push({
                      sceneId : thisSceneId,
                      command : rs,
                    });
                  }else if(rs.startsWith('972303') && rs.length > 10 && rs.substring(8,10) == '00'){
                    //toggle off command
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    sceneMap.toggleOffCommandList.push({
                      sceneId : thisSceneId,
                      command : rs,
                    });
                  }else if(rs.startsWith('8f13') && rs.length > 8){
                    //raw setting command
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    sceneMap.rawSettingCommandList.push({
                      sceneId : thisSceneId,
                      command : rs,
                    });
                  }else if(commandList.indexOf('8f1300ff') != -1 && 
                          commandList.indexOf('8f200000ff') != -1 &&
                          commandList.indexOf('972303ff02') != -1 &&
                          commandList.indexOf('8f1000ff') != -1){
                    //8f1000ff,972303ff02,8f1300ff,8f200000ff
                    ble.stopNotification(device_id, 'ff80', 'ff82');
                    clearTimeout(timeoutId);
                    resolve(sceneMap);
                  }
                  
                },(error)=>{
                  reject(error);
                });
                let read_action_command = '8F1200FF';
                let read_trriger_command = `8F220000FF`;
                let read_scene_toggle_on_command = `972303ff01`;
                let read_scene_toggle_off_command = `972303ff00`;
                let read_scene_toggle_setting_command = `972303ff02`;
                let read_raw_setting_command = `8f1500ff`;
                await peripheral[guid].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: read_trriger_command,
                  },
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: read_action_command,
                  },
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: read_scene_toggle_setting_command,
                  },
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: read_scene_toggle_on_command,
                  },
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: read_scene_toggle_off_command,
                  },
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: read_raw_setting_command,
                  }
                ]);
              });
            }
            this.sceneMapList = []; 
            for(let i in list){
              
              let guid = list[i].device;
              this.updateStep(list[i].device_name,2);
              let device_id = '';
              try{
                device_id = window.peripheral[guid].prop.id;
              }catch(error){
                device_id = '';
                list[i].errorLog = erp.get_log_description(error);
                this.updateStep(list[i].device_name,0);
              }
              console.log('device_id', device_id);
              if(!device_id){
                list[i].errorLog = erp.get_log_description(6300);
                this.updateDeviceErrorLog(list[i].device_name,erp.get_log_description(6300));
                this.updateStep(list[i].device_name,0);
                continue;
              }
              if(this.deviceDetailList[i].connectStatus == 1){
                this.updateStep(list[i].device_name,1);
                continue;
              }
              try{
                await window.peripheral[guid].connect();
                let objMap = await getSceneData(device_id,guid);
                debugger
                console.log('objMap', objMap);
                this.sceneMapList.push(objMap);
                if(window.peripheral[guid].prop.connected){
                  await window.peripheral[guid].disconnect();
                }
                this.updateStep(list[i].device_name,1);
                this.deviceDetailList[i].connectStatus = 1;
                let status = this.checkDeviceConnectStatus();
                if(status){
                  //all device connect success
                  this.checkSceneData(); 
                }
              }catch(error){
                console.log('error', error);
                list[i].errorLog = erp.get_log_description(error);
                this.updateDeviceErrorLog(list[i].device_name,erp.get_log_description(error));
                this.updateStep(list[i].device_name,0);
              }
            }
          },
          updateStep(name,type){
            //type 0:error 1:success,2:loading
            if(type == 0){
              $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('i').removeClass('rotate-animation');
              $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('i').html('error');
            }else if(type == 1){
              $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('i').removeClass('rotate-animation');
              $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('i').html('check');
            }else if(type == 2){
              //rotate-animation
              $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('i').addClass('rotate-animation');
              $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('i').html('sync');
            }
          },
          updateDeviceErrorLog(name,error){
            $(`.manufacturing-steps-list li[deviceName="${name}"]`).find('p.error-log').text(error);
          },
          checkDeviceConnectStatus(){
            let allCheck = false;
            let count = 0;
            let targetCount = this.deviceDetailList.filter((item)=>{
              return item.device_name
            }).length;
            for(let i in this.deviceDetailList){
              if(this.deviceDetailList[i].connectStatus == 1){
                count++;
              }
            }
            if(count == targetCount){
              allCheck = true;
            }
            return allCheck;
          },
          checkSceneData(){
            console.log("all device connect success");
            if(this.deviceSheet){
              this.deviceSheet.close();
            }
            app.dialog.preloader(_('Checking Scene Data'));
            setTimeout(()=>{
              app.dialog.close();
            },1000*50);
            console.log("this.sceneMapList",this.sceneMapList);
            /*
            check the scene data
            1. select the ui of the trigger command and the action command
            2. select the ui of the toggle setting command
            3. select the ui of the toggle on command
            4. select the ui of the toggle off command
            5. select the ui of the raw setting command
            6. check the command with the ble scene data
            */
            console.log("check scene data",this.sceneList);
            let list = [];
            if(this.isSingleCheck){
              list.push(this.singleSceneMap);
            }else{
              list = this.sceneList;
            }
            let logList = [];
            list.forEach((item)=>{
              try{
                let list = [];
                let scene_device_location = item.scene_device_location || [];
                let actionMap = JSON.parse(item.action);
                let triggerMap = JSON.parse(item.trigger);
                let scene_virtual_button = item.scene_virtual_button || [];
                let sceneTemplate = item.scene_template;
                let sceneName = item.title;
                let checkStatus = true;
                let logMap = {
                  name : item.name,
                  isCorrect : true,
                }
                //if the ui command can not find in the ble scene, means the ui command is not correct
                let commandList = [];
                triggerMap.forEach(titem=>{
                  let guid = titem.guid;
                  let triggerCommand = titem['triggercommand'];
                  if(triggerCommand){
                    commandList.push({
                      guid : guid,
                      command : triggerCommand.toLocaleLowerCase(),
                    });
                  }
                  let actionCommand = titem['actionCommand'];
                  if(actionCommand){
                    commandList.push({
                      guid : guid,
                      command : actionCommand.toLocaleLowerCase(),
                    });
                  }
                  let settingCommandList = isset(titem['settingCommandList']) ? titem['settingCommandList'] : [];
                  if(settingCommandList.length > 0){
                    settingCommandList.forEach(sitem=>{
                      if(sitem.startsWith('972003')){
                        commandList.push({
                          guid : guid,
                          command : sitem.slice(0, 3) + '3' + sitem.slice(4),
                        });
                      }
                    });
                  }
                })
                //action command
                if(sceneTemplate == 'RCU Scene New Toggle'){
                  let guid = scene_device_location[0].device;
                  let sceneId = scene_device_location[0].storage_id;
                  let vId = scene_virtual_button[0].virtual_button_id;
                  let command = this.getActionCommandByNewToggle(sceneId,vId,guid,actionMap['actionList'],sceneName);
                  console.log("actionCommand",command);
                  if(command.length > 0){
                    command.forEach((item)=>{
                      commandList.push({
                        guid : guid,
                        command : item.toLocaleLowerCase(), 
                      }); 
                    });
                  }
                }else if(sceneTemplate == 'RCU Scene Toggle'){
                  let guid = scene_device_location[0].device;
                  let triggerCommand = actionMap[guid].trigger;
                  let actionCommand = actionMap[guid].actionCommand;
                  if(triggerCommand){
                    commandList.push({
                      guid : guid,
                      command : triggerCommand.toLocaleLowerCase(),
                    });
                  }
                  if(actionCommand){
                    commandList.push({
                      guid : guid,
                      command : actionCommand.toLocaleLowerCase(),
                    });
                  }
                }else if(sceneTemplate == 'RCU Curtain'){
                  let guid = scene_device_location[0].device;
                  let actionCommand = actionMap[guid].actionCommand;
                  if(actionCommand){
                    commandList.push({
                      guid : guid,
                      command : actionCommand.toLocaleLowerCase(),
                    });
                  }
                }else if(sceneTemplate == 'RCU Radar' || sceneTemplate == 'Welcome Scene'){
                  let guid = scene_device_location[0].device;
                  let actionCommand = actionMap[guid];
                  let key = `second_action_${guid}`;
                  if(actionCommand){
                    commandList.push({
                      guid : guid,
                      command : actionCommand.toLocaleLowerCase(),
                    });
                  }
                  if(actionMap[key]){
                    commandList.push({
                      guid : guid,
                      command : actionMap[key].toLocaleLowerCase(),
                    });
                  }
                }else{
                  let guid = scene_device_location[0].device;
                  if(actionMap[guid]){
                    commandList.push({
                      guid : guid,
                      command : actionMap[guid].toLocaleLowerCase(),
                    });
                  }
                }
                //check the command
                commandList.forEach((item)=>{
                  let command = item.command;
                  let guid = item.guid;
                  let thisCheckStatus = this.checkSceneDataIsCorrect(guid,command);
                  if(!thisCheckStatus){
                    checkStatus = false;
                  }
                });
                if(!checkStatus){
                  item.isCorrect = false;
                }else{
                  item.isCorrect = true;
                }
                debugger
                logMap.isCorrect = checkStatus;
                logList.push(logMap);
                app.dialog.close();
              }catch(error){
                debugger
                console.log('error',error);
                app.dialog.close();
              }
              
            });
            this.pushTheProfileSubdevice(logList);
          },
          checkSceneDataIsCorrect(guid,command){
            let sceneMap = this.sceneMapList.find((item)=>{
              return item.guid == guid;
            });
            console.log("sceneMap",sceneMap);
            //concat all the command
            //console.log("sceneMap",sceneMap);
            let commandList = [];
            for(let i in sceneMap){
              if(i == 'actionCommandList' || i == 'triggerCommandList' || i == 'toggleSettingCommandList' || i == 'toggleOnCommandList' || i == 'toggleOffCommandList' || i == 'rawSettingCommandList'){
                let list = sceneMap[i];
                for(let j in list){
                  commandList.push(list[j].command);
                }
              }
            }
            console.log("commandList",commandList);
            let commandIndex = commandList.findIndex((item)=>{
              return item == command;
            });
            console.log("command",command);
            console.log("commandIndex",commandIndex);
            return commandIndex != -1;
          },
          getActionCommandByNewToggle(sceneId,vId,guid,actionList,sceneName){
            let commandList = [];
            let actualActionList = this.strucActionList(actionList);
            for(let guid in actualActionList){
              let list = actualActionList[guid].list;
              let toggle_setting_item = ``;
              let toggle_default_on_item = '';
              let toggle_default_off_item = '';
              let pannel_setting_item = ``;
              let settingVirtualList = [];
              let firstSceneFlag = '';
              for(let i in list){
                let device_button_group = list[i].device_button_group;
                if(device_button_group.startsWith('RCU ONOFF GANG')){
                  let solt = list[i].config;
                  let gang = device_button_group.replace('RCU ONOFF GANG','')*1;
                  let target_gang = gang%4;
                  if(target_gang == 0){
                    target_gang = 4;
                  }
                  let on_command = this.getRcuOnOffCommand(solt, target_gang, 1);
                  let off_command = this.getRcuOnOffCommand(solt, target_gang, 0);
                  toggle_setting_item += `04971f${parseInt(solt).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                  
                  toggle_default_on_item += `${on_command}`;
                  toggle_default_off_item += `${off_command}`;
                }else if(device_button_group.startsWith('RCU DIMMING')){
                  let solt = list[i].config;
                  let gang = device_button_group.replace('RCU DIMMING','')*1;
                  let target_gang = gang%2;
                  if(target_gang == 0){
                    target_gang = 2;
                  }
                  toggle_setting_item += `04971f${parseInt(solt).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                  toggle_default_on_item += `06971f${parseInt(solt).toString(16).pad('00')}892${target_gang == 1?0:1}ff`;
                  toggle_default_off_item += `06971f${parseInt(solt).toString(16).pad('00')}892${target_gang == 1?0:1}00`;
                }else if(device_button_group.startsWith('RCU OUTPUT')){
                  let target_gang = device_button_group.replace('RCU OUTPUT','')*1;
                  toggle_setting_item += `04972101${parseInt(target_gang).toString(16).pad('00')}${parseInt(target_gang).toString(16).pad('00')}`;
                  toggle_default_on_item += `05972101${parseInt(target_gang).toString(16).pad('00')}01`;
                  toggle_default_off_item += `05972101${parseInt(target_gang).toString(16).pad('00')}00`;
                }else if(device_button_group.startsWith('ONOFF GANG1') && isset(list[i].virtualId)){
                  settingVirtualList.push({
                    virtualId: list[i].virtualId,
                    ref: list[i].ref
                  });
                  if(list[i].ref == 1){
                    toggle_setting_item += `04972103${parseInt(list[i].virtualId).toString(16).pad('00')}`;
                    //toggle_default_on_item += `05972103${parseInt(list[i].virtualId).toString(16).pad('00')}01`;
                  }
                  //toggle_default_off_item += `05972103${parseInt(list[i].virtualId).toString(16).pad('00')}00`;
                  
                  pannel_setting_item += `04972103${parseInt(list[i].virtualId).toString(16).pad('00')}`;
                }
              }
              let command = `972303${parseInt(vId).toString(16).pad('00')}02${toggle_setting_item}`;
              let pannelCommand = ''; 
              if(pannel_setting_item){
                pannelCommand = `972003${parseInt(vId).toString(16).pad('00')}02${pannel_setting_item}`;
              }
              if(settingVirtualList.length){
                //first is on and thore is off
                let firstOne = settingVirtualList[0].virtualId;
                toggle_default_on_item += `05972103${parseInt(firstOne).toString(16).pad('00')}01`;
                defaultOnCommand = `972303${parseInt(vId).toString(16).pad('00')}0105972103${parseInt(firstOne).toString(16).pad('00')}01`;
                let defaultoffCommandItem = '';
                let defaultOnCommandItem = '';
                //if master , all on 
                debugger
                if(sceneName.toLowerCase().includes('master')){
                  toggle_default_on_item = '';
                  defaultOnCommand = '';
                }
                settingVirtualList.forEach((item, index) => {
                  toggle_default_off_item += `05972103${parseInt(item.virtualId).toString(16).pad('00')}00`;
                  if(item.ref == 1){
                    toggle_default_on_item += `05972103${parseInt(item.virtualId).toString(16).pad('00')}01`;
                  }
                  defaultoffCommandItem += `05972103${parseInt(item.virtualId).toString(16).pad('00')}00`;
                });
                defaultOffCommand = `972303${parseInt(vId).toString(16).pad('00')}00${defaultoffCommandItem}`;
                if(sceneName.toLowerCase().includes('master')){
                  defaultOnCommand = `972303${parseInt(vId).toString(16).pad('00')}01${toggle_default_on_item}`;
                }
              }
              if(toggle_default_on_item){
                commandList.push(`972303${parseInt(vId).toString(16).pad('00')}01${toggle_default_on_item}`)
                
              }
              if(toggle_default_off_item){
                commandList.push(`972303${parseInt(vId).toString(16).pad('00')}00${toggle_default_off_item}`)
              }
              commandList.push(command);
              let actionCommandItem = `0e02${core_utils_get_mac_address_from_guid(guid, true)}1305972103${parseInt(vId).toString(16).pad('00')}02`;
              commandList.push(`8F1000${parseInt(sceneId).toString(16).pad('00')}${actionCommandItem}`);
            }
            return commandList;
          },
          getRcuOnOffCommand(solt,gang,ref){
            let command = ``;
            let onoff_data = `1100`;
            if (gang == 1) {
              if (ref == 1) {
                onoff_data = '1100';
              } else {
                onoff_data = '1000';
              }
            } else if (gang == 2) {
              if (ref == 1) {
                onoff_data = '2200';
              } else {
                onoff_data = '2000';
              }
            } else if (gang == 3) {
              if (ref == 1) {
                onoff_data = '4400';
              } else {
                onoff_data = '4000';
              }
            } else if (gang == 4) {
              if (ref == 1) {
                onoff_data = '8800';
              } else {
                onoff_data = '8000';
              }
            }
            command = `07971f${parseInt(solt).toString(16).pad('00')}8000${onoff_data}`;
            return command;
          },
          strucActionList(list){
            let targetList = [];
            if (list.length == 0) {
              return targetList;
            }
            //filter the differ mac device
            let macMap = {};
            list.forEach((item) => {
              if (!isset(macMap[item.device])) {
                macMap[item.device] = {};
                macMap[item.device]['device_mode'] = item.device_mode;
              }
            });
            for (let i in macMap) {
              macMap[i]['list'] = [];
              list.forEach((kitem) => {
                if (kitem.device === i) {
                  macMap[i]['list'].push(kitem);
                }
              });
            }
            return macMap;
          },
          async pushTheProfileSubdevice(list){
            let profile_subdevice = cloneDeep(erp.info.profile.profile_subdevice);
            profile_subdevice.forEach((item)=>{
              if(item.name == subdevice_name){
                if(this.isSingleCheck){
                  let thisList = isset(item.function)?JSON.parse(item.function):[];
                  list.forEach((zitem)=>{
                    if(thisList.findIndex((kitem)=>{
                      return kitem.name == zitem.name;
                    }) == -1){
                      thisList.push(zitem);
                    }else{
                      thisList[thisList.findIndex((kitem)=>{
                        return kitem.name == zitem.name;
                      })].isCorrect = zitem.isCorrect;
                    }
                  });
                  item.function = JSON.stringify(thisList);
                }else{
                  item.function = JSON.stringify(list);
                }
              }
            });
            try{
              let put_status = await http.request(encodeURI(`/api/resource/Profile/${erp.info.profile.name}`), {
                method: 'PUT',
                serializer: 'json',
                responseType: 'json',
                data: {
                  profile_subdevice: profile_subdevice,
                },
              });
              console.log("put_status",put_status);
              if(put_status.data.status == 200){ 
                debugger
                erp.info.profile.profile_subdevice = put_status.data.data.profile_subdevice;
                this.init();
              }
            }catch(error){ 
              console.log(error);
            }
            
          },
          async onDeleted(item) {
            //if mutiway scene
            if (item.scene_template == 'Multiway Switch') {
              //should be delete the ble setting and del the profile setting
              //get the first device name
              let firstTitle = '';
              let firstRoomName = '';
              let secondTitle = '';
              let secondRoomName = '';
              let thisGuid = '';
              let secondGuid = '';
              let subName = item.profile_subdevice;
              let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
              let condition = JSON.parse(item.condition);
              let this_gang = '';
              let second_gang = '';
              subdevices.forEach((item) => {
                if (subName == item.name) {
                  firstTitle = tran(item.title);
                  firstRoomName = tran(item.room_name);
                  this_gang = item.device_button_group.replace('ONOFF GANG', '');
                  thisGuid = item.device;
                }
              });
              let secondSubName = condition[thisGuid]['mapping'];
              subdevices.forEach((item) => {
                if (secondSubName == item.name) {
                  secondTitle = tran(item.title);
                  secondRoomName = tran(item.room_name);
                  second_gang = item.device_button_group.replace('ONOFF GANG', '');
                  secondGuid = item.device;
                }
              });
              app.dialog.confirm(
                `${_('Are you ready to delete the ')}${firstRoomName + '/' + tran(firstTitle) + '?'}`,
                async () => {
                  app.dialog.preloader();
                  let command = `02${core_utils_get_mac_address_from_guid(thisGuid, true)}81080${this_gang}00`;
                  try {
                    await window.peripheral[thisGuid].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: command,
                      },
                    ]);
                    //dele the subdevice the config
                    app.dialog.close();
                    app.dialog.confirm(
                      `${_('Are you ready to delete the ' + secondRoomName + '/' + tran(secondTitle) + '?')}`,
                      async () => {
                        app.dialog.preloader();
                        try {
                          let thisCommand = `02${core_utils_get_mac_address_from_guid(secondGuid, true)}81080${second_gang}00`;
                          await window.peripheral[thisGuid].write([
                            {
                              service: 'ff80',
                              characteristic: 'ff81',
                              data: thisCommand,
                            },
                          ]);
                          //dele the scene
                          let device_status = await http.request(encodeURI(`/api/resource/Scene/${item.name}`), {
                            method: 'DELETE',
                            serializer: 'json',
                            responseType: 'json',
                            data: {},
                          });
                          let clone_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
                          clone_subdevices.forEach((zitem) => {
                            if (zitem.name == subName) {
                              zitem.config = '';
                            }
                            if (zitem.name == secondSubName) {
                              zitem.config = '';
                            }
                          });
                          let put_status = await http.request(encodeURI(`/api/resource/Profile/${erp.info.profile.name}`), {
                            method: 'PUT',
                            serializer: 'json',
                            responseType: 'json',
                            data: {
                              profile_subdevice: clone_subdevices,
                            },
                          });
                          app.dialog.close();
                          await ha_profile_ready();
                          this.init();
                          window.globalUpdate = true;
                          app.dialog.alert(_('Deletion successful'));
                        } catch (errors) {
                          app.dialog.close();
                          app.dialog.alert(_(erp.get_log_description(errors)));
                        }
                      },
                      () => {}
                    );
                  } catch (error) {
                    app.dialog.close();
                    app.dialog.alert(_(erp.get_log_description(error)));
                  }
                },
                () => {}
              );
              return;
            } else if (item.scene_template == 'Scene Banner' || item.scene_template == 'Room Scene Button') {
              app.dialog.confirm(
                `${_('Confirm Deletion?')}`,
                async () => {
                  //get the sceneId
                  app.dialog.preloader();
                  setTimeout(() => {
                    app.dialog.close();
                  }, 15 * 1000);
                  let scenes = cloneDeep(erp.info.scene);
                  let list = [];
                  for (let i in scenes) {
                    if (item.name == scenes[i].name) {
                      list = scenes[i].scene_device_location;
                    }
                  }
                  try {
                    let device_status = await http.request(encodeURI(`/api/resource/Scene/${item.name}`), {
                      method: 'DELETE',
                      serializer: 'json',
                      responseType: 'json',
                      data: {},
                    });
                    app.dialog.close();
                    await ha_profile_ready();
                    window.globalUpdate = true;
                    this.init();
                    app.dialog.alert(_('Deletion successful'));
                  } catch (error) {
                    app.dialog.close();
                    console.log(error);
                    app.dialog.alert(_(erp.get_log_description(error)));
                  }
                },
                () => {}
              );
              return;
            }
            app.dialog.confirm(
              `${_('Confirm Deletion?')}`,
              async () => {
                //get the sceneId
                app.dialog.preloader();
                setTimeout(() => {
                  app.dialog.close();
                }, 15 * 1000);
                let scenes = cloneDeep(erp.info.scene);
                let list = [];
                let sceneMap = null;
                for (let i in scenes) {
                  if (item.name == scenes[i].name) {
                    list = scenes[i].scene_device_location;
                    sceneMap = scenes[i];
                  }
                }
                try {
                  let bleList = [];
                  for (let i in list) {
                    let delActionCommand = `8F1100${parseInt(list[i].storage_id).toString(16).pad('00')}`;
                    let delTriggerCommand = `8F210000${parseInt(list[i].storage_id).toString(16).pad('00')}`;
                    console.log('device', list[i].device);
                    console.log('delActionCommand', delActionCommand);
                    console.log('delTriggerCommand', delTriggerCommand);
                    await window.peripheral[list[i].device].write([
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: delActionCommand,
                      },
                      {
                        service: 'ff80',
                        characteristic: 'ff81',
                        data: delTriggerCommand,
                      },
                    ]);
                  };
                  //delete the toggle command
                  if(sceneMap.scene_template == 'RCU Scene New Toggle'){
                    let virtualIdList = sceneMap.scene_virtual_button;
                    for(let i in virtualIdList){
                      let virtualId = virtualIdList[i].virtual_button_id;
                      let delToggleCommand = `972203${parseInt(virtualId).toString(16).pad('00')}02`;
                      let delToggleOnCommand = `972203${parseInt(virtualId).toString(16).pad('00')}01`;
                      let delToggleOffCommand = `972203${parseInt(virtualId).toString(16).pad('00')}00`;
                      for(let j in list){
                        let this_guid = list[j].device;
                        await window.peripheral[this_guid].write([
                          {
                            service: 'ff80',
                            characteristic: 'ff81',
                            data: delToggleCommand,
                          },
                          {
                            service: 'ff80',
                            characteristic: 'ff81',
                            data: delToggleOnCommand,
                          },
                          {
                            service: 'ff80',
                            characteristic: 'ff81',
                            data: delToggleOffCommand,
                          }
                        ])
                      }
                    }
                  }
                  let device_status = await http.request(encodeURI(`/api/resource/Scene/${item.name}`), {
                    method: 'DELETE',
                    serializer: 'json',
                    responseType: 'json',
                    data: {},
                  });
                  app.dialog.close();
                  await ha_profile_ready();
                  this.init();
                  app.dialog.alert(_('Deletion successful'));
                } catch (error) {
                  app.dialog.close();
                  console.log(error);
                  app.dialog.alert(_(erp.get_log_description(error)));
                }
              },
              () => {}
            );
          },
          async sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
          },
          async download() {
            //app.dialog.preloader();
            // setTimeout(() => {
            //   app.dialog.close();
            // }, 15 * 1000);
            //load the scene ble data
            let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
            let guid = '';
            profile_subdevices.forEach((item) => {
              if (item.name == subdevice_name) {
                guid = item.device;
              }
            });
            mainView.router.navigate(`/mobile-app/scene-debug?guid=${guid}`);
            return;
            try {
              // if(peripheral[guid].prop.connected){
              //   await peripheral[guid].disconnect();
              //   await this.sleep(3000);
              // }
              await peripheral[guid].connect();
              let device_id = peripheral[guid].prop.id;
              this.localTrigerSceneList = [];
              this.localActionSceneList = [];
              await ble.startNotification(
                device_id,
                'ff80',
                'ff82',
                (rs) => {
                  console.log('rs', rs);
                  if ((rs.startsWith('8f20') || rs.startsWith('8f22')) && rs.length > 8) {
                    let thisSceneId = rs.slice(6, 8);
                    if (thisSceneId == '00') {
                      return;
                    }
                    const foundIndex = this.localTrigerSceneList.findIndex((item) => item.scene_id == rs.slice(6, 8));
                    if (foundIndex === -1) {
                      this.localTrigerSceneList.push({
                        scene_id: rs.slice(6, 8),
                        command: rs,
                      });
                    }
                  } else if ((rs.startsWith('8f10') || rs.startsWith('8f12')) && rs.length > 8) {
                    //this means command is action
                    if (rs.slice(6, 8) == '00') {
                      return;
                    }
                    const foundIndex = this.localActionSceneList.findIndex((item) => item.scene_id == rs.slice(6, 8));
                    if (foundIndex === -1) {
                      this.localActionSceneList.push({
                        scene_id: rs.slice(6, 8),
                        command: rs,
                      });
                    }
                  } else if (rs.startsWith('8f1000ff') || rs.startsWith('8f1200ff')) {
                    app.dialog.close();
                    debugger;
                    this.loadBleScene();
                    ble.stopNotification(peripheral[guid].prop.id, 'ff80', 'ff82');
                    //compareLocalAndErpData();
                  }
                },
                (err) => {
                  //app.dialog.close();
                  //app.dialog.alert(err);
                }
              );
              let read_action_command = '8F1200FF';
              let read_trriger_command = `8F220000FF`;
              await peripheral[guid].write([
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: read_trriger_command,
                },
                {
                  service: 'ff80',
                  characteristic: 'ff81',
                  data: read_action_command,
                },
              ]);
            } catch (error) {
              app.dialog.close();
              const toast = app.toast.create({
                position: 'bottom',
                closeTimeout: 3000,
                text: erp.get_log_description(error),
              });

              toast.open();
              //app.dialog.alert(error);
            }
          },
          async loadBleScene() {
            if (this.sheetMap) {
              this.sheetMap = null;
            }
            try {
              this.sheetMap = app.sheet.create({
                content: `
              <div class="sheet-modal my-sheet-swipe-to-step" style="height:auto; --f7-sheet-bg-color: #fff;">
                <div class="toolbar" style="background-color: #fff;">
                  <div class="toolbar-inner">
                    <div class="left">
                      <div class="block-title block-title-medium py-2">${_('BLE SCENE')}</div>
                    </div>
                    <div class="title"></div>
                    <div class="right"></div>
                  </div>
                </div>
                <div class="block-title">Trigger List</div>
                <div class="list ha-guide-list list-outline-ios list-strong-ios list-dividers-ios">
                  <ul>
                    ${this.localTrigerSceneList
                      .map(
                        (kitem) => `
                    <li v-for="(kitem,kindex) in localTrigerSceneList" :key="kitem.scene_id" style="background: #fff;">
                      <div class="item-content">
                        <div class="item-media">${kitem.scene_id}</div>
                        <div class="item-inner">
                          <div style="word-wrap:break-word;word-break:break-all;">${kitem.command}</div>
                        </div>
                      </div>
                    </li>
                    `
                      )
                      .join('')}
                  </ul>
                </div>
                <div class="block-title">Action List</div>
                <div class="list ha-guide-list list-outline-ios list-strong-ios list-dividers-ios">
                  <ul>
                    ${this.localActionSceneList
                      .map(
                        (kitem) => `
                    <li style="background: #fff;">
                      <div class="item-content">
                        <div class="item-media">${kitem.scene_id}</div>
                        <div class="item-inner">
                          <div style="word-wrap:break-word;word-break:break-all;">${kitem.command}</div>
                        </div>
                      </div>
                    </li>
                    `
                      )
                      .join('')}
                  </ul>
                </div>
              </div>
              `,
                on: {
                  open: (sheet) => {},
                },
                swipeToClose: true,
                backdrop: true,
              });
              this.sheetMap.open();
            } catch (error) {
              this.loadBleScene();
              console.log(error);
            }
          },
          async init() {
            this.sceneList = [];
            let sceneLogList = [];
            console.log(subdevice_name);
            if (isset(subdevice_name) && subdevice_name) {
              $('.scene-list-right').removeClass('device-hidden');
            } else {
              console.log($('.scene-list-right'));
              $('.scene-list-right').addClass('device-hidden');
            }
            //get the check status
            let profile_subdevice = cloneDeep(erp.info.profile.profile_subdevice);
            profile_subdevice.forEach(item=>{
              if(item.name == subdevice_name && item.function){
                try{
                  sceneLogList = JSON.parse(item.function);
                }catch(error){
                  sceneLogList = [];
                }
              }
            })
            let scenes = cloneDeep(erp.info.scene);
            for (let i in scenes) {
              if (!isset(scenes[i].image) || !scenes[i].image) {
                scenes[i].image = `https://dev.mob-mob.com/files/scene.jpg`;
              }
              if (isset(subdevice_name) && subdevice_name) {
                if (subdevice_name == scenes[i].profile_subdevice) {
                  if (scenes[i].scene_virtual_button.length > 0) {
                    scenes[i].virtualId = scenes[i].scene_virtual_button[0].virtual_button_id;
                  }
                  scenes[i].isCorrect = true;
                  let logMap = sceneLogList.find(item=>item.name == scenes[i].name);
                  if(sceneLogList.length && logMap){
                    debugger
                    scenes[i].isCorrect = logMap.isCorrect;
                  }
                  this.sceneList.push(scenes[i]);
                }
                //if normal scene
                if (scenes[i].scene_template == 'Scene Banner' || scenes[i].scene_template == 'Room Scene Button') {
                  scenes[i].isCorrect = true;
                  this.sceneList.push(scenes[i]);
                }
              } else {
                scenes[i].isCorrect = true;
                this.sceneList.push(scenes[i]);
              }
            }
          },
          async scan() {
            await bleManager.stopScan();
            await bleManager.wait(200);
            bleManager.scan(this.onDiscovery, async () => {
              await bleManager.wait(5000);
              this.scan();
            });
          },
          async onDiscovery(p) {
            setTimeout(() => {
              delete p.password;
              delete p.connected;
              delete p.connecting;
              if (!isset(peripheral[p.guid])) {
                peripheral[p.guid] = new Peripheral(p);
              } else {
                peripheral[p.guid].update(p);
              }
            }, 10);
          },
          async executeScene(item) {
            console.log('item', item);
            app.dialog.preloader();
            let list = item.scene_device_location;
            for (let i in list) {
              let command = `8f0200${parseInt(list[i].storage_id).toString(16).pad('00')}`;
              console.log('command', command);
              try {
                await window.peripheral[list[i].device].write([
                  {
                    service: 'ff80',
                    characteristic: 'ff81',
                    data: command,
                  },
                ]);
              } catch (error) {
                console.log(error);
                app.dialog.close();
                app.dialog.alert(_(erp.get_log_description(error)));
              }
            }
            app.dialog.close();
            app.dialog.alert(_('Execution successful'));
            return;
          },
          toScene() {
            mainView.router.navigate(`/mobile-app/scene-guid-operate-page?sub_name=${subdevice_name}`);
          },
          toDetail(item) {
            mainView.router.navigate(`/mobile-app/scene-guid-operate-page?name=${item.name}&sub_name=${subdevice_name}`);
          },
          createSubdevice(item) {
            let list = item.scene_virtual_button || [];
            let idList = item.scene_device_location || [];
            let guid = '';
            let v_id = '';
            let scene_id = '';
            if(list.length){
              guid = list[0].device;
              v_id = list[0].virtual_button_id;
            }else{
              if(idList.length > 1){
                //get the guid
                idList.forEach(item=>{
                  let deviceMap = erp.info.device[item.device];
                  let settings = deviceMap.settings;
                  settings.forEach(kitem=>{
                    if(kitem.setting_type == 'main_rcu'){
                      if(kitem.setting == 1){
                        guid = item.device;
                        scene_id = item.storage_id;
                      }
                    }
                  })
                })
                scene_id = idList.map(item=>{
                  return item.storage_id;
                })
              }else if(idList.length == 1){
                guid = idList[0].device;
                scene_id = idList[0].storage_id;
              }
            }
            console.log('guid', guid);
            //check if null
            if(!guid){
              app.dialog.alert(_('Sorry, this scene cannot create devices.'));
              return;
            }
            /*
            1.
            2.selectinput
            3.framework7
            */
            let roomList = erp.info.profile.profile_room;
            // 
            const selectHtml = roomList.map(t =>
              `<option value="${t.name}">${tran(t.title)}</option>`
            ).join('');
            //Button Group
            let buttonGroupMap = window.ble_button_group_icon_map();
            let buttonGroupList = Object.keys(buttonGroupMap);
            const buttonGroupHtml = buttonGroupList.map(item=>{
              return `<option style="font-size: 12px;" value="${item}">${item}</option>`
            }).join('');
            // 
            const modal = app.dialog.create({
              title: _('Create Subdevice'),
              content: `
              <div class="dialog-form">
                <!--  -->
                <div class="item-content">
                  <div class="list">
                    <ul>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">${_("Room Name")}</div>
                          <div class="item-input-wrap">
                            <select id="subdeviceType" class="select">
                            ${selectHtml}
                            </select>
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">${_("Button Group")}</div>
                          <div class="item-input-wrap">
                            <select id="buttonGroup" class="select" style="font-size: 12px;">
                            ${buttonGroupHtml}
                            </select>
                          </div>
                        </div>
                      </li>
                      <!--  -->
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">${_("Device Name")}</div>
                          <div class="item-input-wrap">
                            <input
                              id="subdeviceName"
                              type="text"
                              placeholder="${_("Input your device name.")}"
                            />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            `,
              buttons: [
                {
                  text: _('Cancel'),
                  id: 'cancelSubdevice',
                  color: 'gray',
                  onClick: (dialog) => {
                    dialog.close(); // 
                  },
                },
                {
                  text: _('Submit'),
                  color: 'blue',
                  id: 'submitSubdevice',
                  onClick:  (dialog, e)=> {
                    // 
                    const deviceType = dialog.$el.find('#subdeviceType').val();
                    const deviceName = dialog.$el.find('#subdeviceName').val();
                    const buttonGroup = dialog.$el.find('#buttonGroup').val();
                    // 
                    if (!deviceName.trim()) {
                      app.dialog.alert(_('Device name cannot be empty.'));
                      return;
                    }
                    //get the profile device name
                    let profile_device = cloneDeep(erp.info.profile.profile_device);
                    let profile_device_map = profile_device.filter(item=>{
                      return item.device === guid;
                    })
                    debugger
                    this.validateSubdevice(v_id).then(res => {
                      let subUrl = `/api/resource/Profile Subdevice`;
                      let subMethod = 'POST';
                      let this_data = {
                        parenttype: 'Profile',
                        parent: erp.info.profile.name,
                        parentfield: 'profile_subdevice',
                        profile_room: deviceType,
                        profile_device: profile_device_map[0].name,
                        device: guid,
                        title: deviceName,
                        device_button_group: buttonGroup,
                        device_mode: 'RCU Controller',
                        config: `${v_id?parseInt(v_id).toString(16).pad("00"):'scene_id='+scene_id+'&enable=true'}`,
                      }
                      return http.request(encodeURI(subUrl), {
                          method: "POST",
                          serializer: 'json',
                          responseType: 'json',
                          data: this_data,
                          debug: true,
                        });
                    }).then(async(res)=>{
                      // 
                      dialog.close();
                      await ha_profile_ready();
                      window.globalUpdate = true;
                      app.dialog.alert(_('Create subdevice successfully.'));
                    }).catch(error=>{
                      // 
                      dialog.close();
                      app.dialog.alert(error);
                    })
                  },
                },
              ],
              // 
              onOpen: function (dialog) {
                // 
                dialog.$el.find('#subdeviceName').focus();
              },
            });

            // 
            modal.open();
          },
          validateSubdevice(v_id){
            return new Promise((resolve, reject) => {
              //check if have the same virtual id
              let profile_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
              let device_map = profile_subdevices.filter(item => {
                return item.virtual_id == parseInt(v_id).toString(16).pad("00");
              });
              if(device_map.length > 0){
                reject(_('The device has already been created.'));
              }else{
                resolve(true);
              }
            });
          },
        },
      });
    });

    $on('pageBeforeRemove', (e, page) => {});

    $onUnmounted(() => {
      if (vueApp) {
        vueApp.$destroy();
      }
    });

    return $render;
  };
</script>

<style>
  .device-hidden {
    display: none !important;
  }
  .template-info {
    font-size: 12px;
    text-align: right;
    margin-bottom: 10px;
  }
  .radio-box {
    height: 75px;
    background-color: #fff;
    margin-bottom: 10px;
  }
  .item-radio {
    height: 100%;
  }
  .timer-item {
    height: 100%;
    padding-right: 10px;
  }
  .list ul::before,
  .list ul::after {
    content: none;
  }
  .fab-right-bottom {
    position: fixed;
  }
  .device-title {
    font-size: 16px;
    color: #000;
    font-weight: bold;
  }
  .room-title {
    font-size: 13px;
  }
  @keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
.rotate-animation {
  animation: rotate 2s linear infinite;
  display: inline-block; /* transform */
}
.rotate-animation.paused {
  animation: none;
}
</style>
