<template>
	<div class="page">
		<div class="navbar active">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				${isHomePage ? $h`
				<div class="left">
					<a href="#" class="button button-fill text-color-theme bg-color-white button-44 panel-open" data-panel="left">
						<i class="icon material-icons">menu</i>
					</a>
				</div>
				<div class="title sliding">
					<div class="logo-small">
						<img src="{{ frappe.get_url(nav_app_logo_image) if nav_app_logo_image else appSetting.iconImageUri }}" />
						<a href="/mobile-app/profile-list" class="link">
							${erp.info.profile ? $h`
							<font class="profile_title" style="text-overflow: ellipsis; max-width: 110px; overflow: hidden">
								${ erp.info.profile.flat ? tran(erp.info.profile.flat) + '-' : '' }${ tran(erp.info.profile.profile_name) }
							</font>
							` : $h`
							<font class="profile_title" style="text-overflow: ellipsis; max-width: 110px; overflow: hidden"> ${ tran('Default') } </font>
							`}
							<div class="home-title-profile-popover" style="margin-left: 5px">
								<i class="icon f7-icons" style="font-size: 14px">chevron_down</i>
							</div>
						</a>
					</div>
				</div>
				<a class="button button-fill text-color-theme bg-color-white button-44" href="#" func="open_accounts">
					<i class="icon material-icons">settings</i>
				</a>
				` : $h`
				<div class="left">
					<a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">${title}</div>
				<div class="right">
					<a link icon-only>
						${mobileAsHubStatus && $h`
            <div class="device-mobile-as-hub" @click="${()=>clickForMobile()}"></div>
						`}
          </a>
					${listCssStatus == 'Card' && $h`
					<a link icon-only @click="${()=>changeListCss(1)}">
						<i class="icon material-icons md-only">grid_view</i>
          </a>
					`}
					${listCssStatus == 'List' && $h`
					<a link icon-only @click="${()=>changeListCss(2)}">
						<i class="icon material-icons md-only">list</i>
          </a>
					`}
				</div>
				`}
			</div>
		</div>
	
		<div class="page-content ptr-content" style="height: 100%" @ptr:refresh="${refresh}" id="container">
			<div class="ptr-preloader"><div class="preloader"></div><div class="ptr-arrow"></div></div>
			<div class="room-box">
					<!-- home scene banner -->
					<div class="banner-swiper-container swiper-container-auto swiper-container home-swiper" style="z-index: 5; position: fixed">
						<div class="swiper-wrapper">
							${scenes.map((sceneItem)=> $h`
								<div class="swiper-slide home-swiper-slide" key="${sceneItem.name}" style="background-image: url('https://dev.mob-mob.com/files/scene.jpg');background-size: cover;">
									<div class="home-swiper-slide-inner">
										<div style="margin: 8px 16px 8px 30px">
											<div style="text-align: left; float: left; width: 50%; line-height: 29px; padding-top: 5px">
												<b style="font-size: 25px; text-shadow: 1px 2px 3px #000; color: #fff">${ tran(sceneItem.title) }</b>
											</div>
											<div style="text-align: right; float: right; width: 50%; display: none">
												<a
													class="button right"
													href=""
												>
													<i class="material-icons">settings</i>
												</a>
											</div>
											<br />
											<div style="text-align: right; float: right; width: 50%; margin-top: -20px; margin-bottom: 20px">
												<!-- <label
													class="switch"
													style="
														margin-top: 10px;
														margin-bottom: 20px;"
												>
													<input type="checkbox" scene-name="${sceneItem.name}" />
													<span class="slider round"></span>
												</label>-->
												<a
													href="#"
													@click="${()=>{home_auto_click_scene(sceneItem)}}"
													sceneref="${sceneItem.name}"
													class="right off_flag"
												>
													<div
														class="button button-small button-raised button-round button-fill"
														style="
															width: 60px;
															height: 60px;
															content: '';
															-webkit-border-radius: 50%;
															-moz-border-radius: 50%;
															border-radius: 50%;
														"
													>
														<i class="material-icons">touch_app</i>
													</div>
												</a>
											</div>
										</div>
									</div>
								</div>
							`)}
						</div>
					</div>
					
					<!-- home room toolbar -->
				${subdevices.length > 0 && $h`
				<div
					class="toolbar tabbar tabbar-scrollable toolbar-home-room"
					style="
						z-index: 5;
						position: fixed;
						${page_margin_top>100?'margin-top:104px;': ''}
						${show_noroom?'display:none;':''}
						${show_nosubdevice?'display:none;':''}
					"
				>
					<div class="toolbar-inner">
						<a
							ref="0"
							id="room-bar-title-0"
							@click="${()=>show_room(0,1)}"
							class="tab-link tab-link-active"
						>
							<i class="material-icons">home</i>
						</a>
						${rooms.map((item)=> $h`
							${item.subdevices_count > 0? $h`
										<a
											ref="${item.idx}"
											id="room-bar-title-${item.name}"
											@click="${()=>show_room(item.name,item.subdevices_count)}"
											class="tab-link"
											key="${item.name}"
										>
											${tran(item.title)}
										</a>
							`: $h`
									<a></a>
							`}
						`)}
					</div>
					${profilePermision && $h`
					<div class="room-more-icon-box">
						<a href="/mobile-app/ha-room-list?page_type=2" class="button">
							<i class="material-icons">more_vert</i>
						</a>
					</div>
					`}
				</div>
				`}
				<!-- for rooms switch -->
				<div class="tabs" style="display: none">
					<div id="tab-hidden-0" class="page-content tab tab-active"></div>
					${rooms.map((item)=> $h`
					<div id="tab-hidden-${item.idx}" class="page-content tab"></div>
					`)}
				</div>
					
					<!-- no room show -->
					<div style="${show_noroom?'':'display:none;'}${show_nosubdevice?'display:none;':''}">
						<div class="block" style="text-align: center;">
							<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
							<p>${_('You don\'t have any room, create one')}</p>
						</div>
						<div class="block block-strong">
							<p class="row">
								<a class="col button button-large" href="/mobile-app/app-room-detail-page?roomTitle=${_('New Room')}"
									>${ _('Create Room') }</a
								>
							</p>
						</div>
				</div>
				
				<!-- no device show -->
					<div style="${show_nosubdevice?'':'display:none;'}">
						<div class="block" style="text-align: center">
							<span class="material-icons" style="font-size: 100px; color: #ddd">meeting_room</span>
							<p>${_('You don\'t have any devices, create one.')}</p>
						</div>
						<div class="block block-strong">
							<p class="row">
								<a class="col button button-large" href="/mobile-app/yoswit-device-type"
									>${ _('Create Device') }</a
								>
							</p>
						</div>
					</div>
				
					${subdevices.length > 0 && $h`
						<div style="height: ${page_margin_top}px;"></div>
				`}
				
				<!-- rooms -->
				${rooms.map((item)=> $h`
						${item.subdevices_count > 0? $h`
								<div id="room-${item.name}-div" key="${item.name}" class="list media-list no-margin">
									<ul>
										<li id="room-${item.name}-div-title" room="${tran(item.name)}" class="swipeout room" ref="${item.idx}">
											<div class="item-content swipeout-content">
												<div class="item-inner">
													<div class="item-title-row">
														<!-- title text -->
														<div
															class="item-title"
															lang="en"
															lang-packet="${item.title}"
															@click="${()=>collapse_room(item.name)}"
															ref="${item.name}"
														>
															<i class="room-collapse material-icons" id="collapse-${item.idx}"> expand_more </i>
															${ tran(item.title) }
														</div>
														
														<!-- click to turn on all device in room -->
														<div class="item-after">
															<p class="segmented segmented-raised segmented-round" style="display: none">
																<button class="button button-round link" func="controller_common_home_click_room_onoff" ref="1">Off</button>
																<button class="button button-round link" func="controller_common_home_click_room_onoff" ref="0">On</button>
															</p>
														</div>
													</div>
												</div>
												<div class="control-panel-right" style="">
													${roomScenes.map((sceneItem)=> $h`
														${sceneItem.profile_room == item.name? $h`
													<a class="right" @click="${()=>clickRoomScene(sceneItem)}">
														<div class="button button-raised button-big circle rf-sensor" style="width: 50px;height: 50px;margin-top: 4px;">
															<span class="icons" style="line-height: 50px !important;font-size: 20px;">${sceneItem.title.substring(0,1).toUpperCase()}</span>
														</div>
													</a>
													`: $h`
													<a style="display: none;"></a>
														`}
													`)}
												</div>
											</div>
											<div class="swipeout-actions-right">
												<a
												href="/mobile-app/app-room-detail-page?roomName=${item.name}&roomTitle=${_('Edit')}${tran(item.title)}"
													class="link color-orange"
												>
													<i class="icon material-icons">settings</i>
												</a>
												<!--<a
												@click="${()=>toFavorite()}"
													class="link color-yellow"
												>
													<i class="icon material-icons">favorite</i>
												</a>
												<a
												@click="${()=>applyFavoriteRoom(item.name)}"
													class="link color-blue"
												>
													<i class="icon material-icons">save</i>
												</a>-->
											</div>
										</li>
										<div class="room-item ${listCssStatus == 'Card'?'display-flex justify-content-space-between':''}" style="${listCssStatus == 'Card'?'flex-wrap: wrap;padding: 15px;':''}">
										${subdevices.map((kitem)=> $h`
											<div class="${kitem.profile_room === item.name && kitem.hidden == 0 && listCssStatus == 'Card'?'show-item':''}" style="${(kitem.device_button_group == 'Thermostat' || kitem.device_button_group == 'DIMMING' || kitem.device_button_group.startsWith('OPENCLOSE GANG') || kitem.device_button_group.startsWith('OPENCLOSE UART') || kitem.device_button_group.startsWith('Air Conditioner') || kitem.device_button_group.startsWith('IR-DIY') || kitem.device_button_group.startsWith('IAQ')  || listCssStatus == 'List') && (screen.availWidth < 500 || listCssStatus == 'List')?'width: 100%;':'width: 49%;'}${kitem.profile_room === item.name && kitem.hidden == 0?'':'display:none;'}">
												${kitem.profile_room === item.name && kitem.hidden == 0? $h`
														
														<li
															style="${listCssStatus == 'Card'?'min-height : 150px;':''}"
																class="device home-scanned-peripheral swipeout swipeout-delete-manual home-scanned-peripheral-smart grid grid-cols-2 medium-grid-cols-4 grid-gap"
															@swipeout:deleted="${()=>onDeleted(kitem)}" guid="${kitem.device}" is-input="${kitem.device_button_group.startsWith('RCU INPUT')?1:0}" button_group="${kitem.device_button_group}" config="${kitem.config}" subdevice_name="${kitem.name}" key="${kitem.name}${md5(kitem.device_attachment_status)}"
														>
															<div class="item-content swipeout-content">
																<a class="item-link item-content no-chevron no-ripple no-active-state" style="${listCssStatus == 'Card'?'flex-wrap: wrap;':''}">
																	<div
																		class="priority-thumb device-thumb item-media display-flex justify-content-center flex-direction-row align-content-center"
																		style="
																			background-position: center;
																			background-size: contain;
																			position: relative;
																			background-image: url('${kitem.thumb}');
																		"
																		@click="${()=>testFun(kitem)}"
																	>
																			${(kitem.device_model && kitem.device_model.includes('YO360')) && $h`
																			<span class="thermostat-current-temp" style="font-size: 12px;">${kitem.device_attachment_status && kitem.device_attachment_status.split(",")[4]>0?parseInt(kitem.device_attachment_status.split(",")[4]):''}</span><span class="${kitem.device_attachment_status && kitem.device_attachment_status.split(',')[4]>0?'':'device-none'}" style="font-size: 12px;" >â„ƒ</span>
																			`}
																			<!--<i class="prioritysss icon material-icons text-color-red device-none" style="font-size: 35px;">priority_high</i>-->
																			<!--<i class="priorityss icon material-icons text-color-orange ${kitem.mac_error_status?'':'device-none'}" style="font-size: 35px;">priority_high</i>-->
																			<i class="prioritys icon material-icons text-color-yellow ${kitem.guid_status?'device-none':''}" style="font-size: 35px;">priority_high</i>
																			<!--<i class="priority icon material-icons text-color-red device-none" style="font-size: 35px;">priority_high</i>-->
																		</div>
																	<div class="item-inner" style="${listCssStatus == 'Card'?'width: 100%;margin-left: 0;':''}">
																		<div class="item-title-row">
																			<div class="item-title ellipsis" lang="en" style="width: 190px" title="${kitem.title}">${tran(kitem.title)}</div>
																		</div>
																		<div class="item-subtitle">${ kitem.device_model }-${ kitem.device_name }</div>
																		${profilePermision && $h`
																		<div class="signal-panel item-text height-21" style="width: 120%">
																				<${renderSignalItem} kitem="${kitem}" key="${kitem.signalRfresh}${kitem.mn_head_connected}${kitem.mn_tail_set}${kitem.mn_head_set}${kitem.mn_tail_connected}${kitem.device_attachment_status}"/>
																		</div>
																		`}
																	</div>
																</a>
																${profilePermision && $h`
																<${renderSwipeLeftPanel} kitem="${kitem}" leftMenuPermision="${leftMenuPermision}"/>
																<${renderSwipeRightPanel} kitem="${kitem}" leftMenuPermision="${leftMenuPermision}" />
																<${renderMainButton} kitem="${kitem}" key="${md5(JSON.stringify(kitem))}"/>
																`}
															</div>
														</li>
														<${renderBottomButton} kitem="${kitem}" key="${md5(kitem.device_attachment_status)}${md5(kitem.config?kitem.config:'')}${md5(kitem.device_config?kitem.device_config:'')}${md5(md5(updateTime+''))}"/>
																			`  : $h`
																					<a style="display: none;"></a>
																			`}
													</div>
										`)}
															</div>
													</ul>
											</div>
					` : $h`
							<div id="room-${item.name}-div" class="room-device-null"></div>
					`}
							`)}
				</div>
				${profilePermision && $h`	
				<div id="room-0-div" class="list media-list no-margin ${show_unassigned?'':'device-none'}">
					<ul>
						<li class="room">
							<div class="item-content">
								<div class="item-inner">
									<div class="item-title-row">
										<div class="item-title" lang="en" lang-packet="Unassigned" func="controller_common_home_collapse" ref="0">
											<i class="room-collapse material-icons" id="collapse-0"> expand_more </i>
											{{ _('Unassigned') }}
										</div>
									</div>
								</div>
							</div>
						</li>
						<div class="unassigned-box ${listCssStatus == 'Card'?'display-flex justify-content-space-between':''}" style="${listCssStatus == 'Card'?'flex-wrap: wrap;padding: 15px;':''}">
									${unassigned_subdevices.map((kitem)=> $h`
							<div class="${listCssStatus == 'Card'?'show-item':''}" style="${(kitem.device_button_group == 'Thermostat' || kitem.device_button_group == 'DIMMING' || kitem.device_button_group.startsWith('OPENCLOSE GANG') || kitem.device_button_group.startsWith('OPENCLOSE UART') || kitem.device_button_group.startsWith('Air Conditioner') || kitem.device_button_group.startsWith('IR-DIY') || kitem.device_button_group.startsWith('IAQ') || listCssStatus == 'List') && (screen.availWidth < 500 || listCssStatus == 'List')?'width: 100%;':'width: 49%;'}">
							<li 
								class="device home-scanned-peripheral home-scanned-peripheral-smart swipeout swipeout-delete-manual"
								style="${kitem.disappear?'display:none;':''}${listCssStatus == 'Card'?'min-height : 150px;':''}"
								guid="${kitem.device}"
								button_group="${kitem.device_button_group}"
								display-name="${tran(kitem.name.substring(0, 16))}"
							>
								<div class="item-content swipeout-content">
									<a class="item-link item-content no-chevron no-ripple no-active-state" func="ble_load_to_device_form_auto" style="${listCssStatus == 'Card'?'flex-wrap: wrap;':''}">
										<div
											class="device-thumb item-media"
											style="
												background-position: center;
												background-size: contain;
												position: relative;
															background-image: url('${kitem.thumb}');
											"
										></div>
										<div class="item-inner" style="${listCssStatus == 'Card'?'width: 100%;margin-left: 0;':''}">
											<div class="item-title-row">
												<div class="item-title ellipsis" lang="en" style="width: 190px" title="${tran(kitem.name)}">
													<i class="material-icons text-muted" style="position: relative; top: 5px">settings</i>
													${tran(kitem.name.substring(0, 16))}
												</div>
											</div>
											<div class="item-subtitle">${ tran(kitem.device_model) }-${ tran(kitem.device_name.substring(0, 12)) }</div>
											<div class="signal-panel item-text height-21" style="width: 120%">
													<${renderSignalItem} kitem="${kitem}" key="${kitem.signalRfresh}"/>
											</div>
										</div>
									</a>
												<${renderMainButton} kitem="${kitem}" key="${md5(JSON.stringify(kitem))}"/>
								</div>
							</li>
							<${renderBottomButton} kitem="${kitem}" />
							</div>
											`)}
							
						</div>
					</ul>
				</div>
				`}
		</div>
	</div>
</template>

<script>
//defined components
const renderSignalItem = (props, {
	$h
}) => {
	//defined the wifi model
	let wifiModel = ['YO360', 'YO360-R2W','YO121-AC', 'YO780-Scene-6G', 'YO780-Scene-12G','YO780-Scene-4G',,'YO780-Scene-3G','YO780-Scene-2G','YO780-Scene-1G', 'YO780', 'YO105','YO790DC'];
	let this_model = props.kitem.device_model;
	let wifiIndex = wifiModel.indexOf(this_model);
	let wifiShowStatus = wifiIndex > -1 ? true : false;
	let devices = cloneDeep(erp.info.device);
	let wifiSetStatus = false;
	if(props.kitem.device){
		let deviceMap = devices[props.kitem.device];
		if(deviceMap){
			let settings = deviceMap.settings;
			settings.forEach(item=>{
				if(item.setting_type == 'Wifi Password' && item.setting!= ''){
					wifiSetStatus = true;
					
				}
			})
		}
	}
	//thermosta config,if yo360-r2w,should show the humidity
	let thermostaHumStatus = false;
	let humidityText = 0;
	if(this_model == 'YO360-R2W'){
		thermostaHumStatus = true;
		console.log("device_attachment_status",props.kitem.device_attachment_status);
		humidityText = props.kitem.device_attachment_status.split(",")[5];
	}
	//mutiway config
	let multiwayConfig = {};
	let pairStatus = false; 
	if(props.kitem.device_mode == "Multiway Switch"){
		multiwayConfig = props.kitem.config?JSON.parse(props.kitem.config):{};
		pairStatus = multiwayConfig.mapping?true:false;
	}
	const fixNetwork = (kitem,is_mesh_status)=>{
		if(!kitem.network_id){
			return
		}
		if(is_mesh_status){
			return
		}
		if(kitem.rssilv == 0){
			app.dialog.alert(`${_('Device is not here')}`);
			return
		}
		app.dialog.preloader(`${_('Network Repair In Progress')}`)
		let network_id = kitem.network_id;
		let network_position = kitem.network_position;
		let devices = cloneDeep(erp.info.profile.profile_device);
		let networkIdList = devices.filter((e)=>e.network_id == network_id && e.network_id != 0).sort((a,b)=>{
			return a.network_position-b.network_position;
		})
		let headBytes = '';
		let tailBytes = '';
		if(network_position == 0){
			headBytes= `8500010000000000000000000000`;
			tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)+1].device,true).toLowerCase()}0100000000`;
		}else if(network_position == networkIdList.length-1){
			headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)-1].device,true).toLowerCase()}0000000000`;
			tailBytes = `8500010000000000000100000000`;
		}else{
			headBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)-1].device,true).toLowerCase()}0000000000`;
			tailBytes = `850001${core_utils_get_mac_address_from_guid(networkIdList[parseInt(network_position)+1].device,true).toLowerCase()}0100000000`;
		}
		let meshCommands = ['85000000', '850200', tailBytes, '850201', headBytes, '850200'];
		let bleList = [];
		meshCommands.forEach(zitem=>{
			bleList.push({
				service: 'ff80',
				characteristic: 'ff81',
				data: zitem,
			})
		})
		bleList.push({
			service: 'ff80',
			characteristic: 'ff81',
			data: '810e',
		})
		try{
			console.log('bleList',bleList)
			peripheral[kitem.device].write(bleList);
			app.dialog.close();
			app.dialog.alert(`${_('Repair completed. The device networking will take some time. Please pay attention to the changes in the networking status.')}`)
		}catch(error){
			app.dialog.close()
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	const definedDeviceNetworkStatus = (network_id,head_connected,head_set,tail_connected,tail_set,is_mobmob,rssilv) =>{
		let is_mesh = false;
		if(network_id){
			is_mesh = true
			if(rssilv){
				if(head_set){
					if(!head_connected){
						is_mesh = false;
					}
				}
				if(tail_set){
					if(!tail_connected){
						is_mesh = false;
					}
				}
			}
		}
		return is_mesh;
	}
	let is_mesh_status = definedDeviceNetworkStatus(props.kitem.network_id,props.kitem.mn_head_connected,props.kitem.mn_head_set,props.kitem.mn_tail_connected,props.kitem.mn_tail_set,props.kitem.mobmob,props.kitem.rssilv);
	if(props.kitem.device == '30346565303331666337376212012e1d'){
		debugger
		console.log("is_mesh_status",is_mesh_status)
	}
	return () => $h`
			<div class="signal-view-main" signal="${props.kitem.rssilv}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob}" mesh="${props.kitem.network_id>0?1:0}" mobilehub="${props.kitem.is_mobile_gateway?props.kitem.is_mobile_gateway:0}">
			<div class="signal"></div>
			<div class="bluetooth"></div>
			<div class="mesh" @click="${()=>fixNetwork(props.kitem,is_mesh_status)}">
				${(props.kitem.network_id>0 && !is_mesh_status) && $h`
				<i class="prioritys icon material-icons text-color-red" style="font-size: 20px;position: relative;top: -6px;">priority_high</i>
				`}
			</div>
			<div class="mobmob">
				<i class="prioritys icon material-icons text-color-red device-none" style="font-size: 20px;position: relative;top: -3px;">priority_high</i>
			</div>
			<div class="thermostat-humidity ${thermostaHumStatus?'':'device-none'}" style="float:left;width:48px;">
				<i class="material-icons" style="font-size:22px;color:#41c604;">water_drop</i>
				<span class="thermostat-humidity-text" style="color:#gray;position:relative;top:-5px;font-size:12px;">${humidityText}%</span>
			</div>
			<div class="wifiicon ${wifiShowStatus?'':'device-none'}" guid="${props.kitem.device}" button_grou="${props.kitem.device_button_group}">
            <i class="material-icons ${props.kitem.mobmob && wifiSetStatus?'text-color-green':'text-color-red'}" style="font-size:22px;">${props.kitem.mobmob && wifiSetStatus?'wifi':"wifi_off"}</i>
						<i class="prioritys icon material-icons text-color-red device-none" style="font-size: 20px;position: relative;top: -8px;left: -21px;">priority_high</i>
      </div>
			<div class="iostatus"></div>
			${(props.kitem.device_mode == 'Parking Lock' || props.kitem.device_mode == 'Geomagnetic') && $h`
			<div class="battery" mode="${props.kitem.device_mode}" battery="${props.kitem.battery?props.kitem.battery:5}"><i class="material-icons text-color-green">battery_full</i></div>
			`}
			${pairStatus && $h`
			<div class="ir-signal-cooker" mode="${props.kitem.device_mode}" ref="${
        props.kitem.device_status > 0 ? 1 : 0
      }"><i class="material-icons radio-button-unchecked" style="font-size:22px;color:#cbcbcb;">radio_button_unchecked</i><i class="material-icons circles" style="font-size:22px;">circle</i>
      </div>
			`}
			<div class="rcu-virtual-button ${props.kitem.device_mode == 'RCU Controller' && props.kitem.device_button_group == 'SCENE MUTIWAY ONOFF GANG1'?'':'device-none'}"  ref="${props.kitem.device_status?1:0}">
				<i class="material-icons radio-button-unchecked" style="font-size:22px;color:#cbcbcb;">radio_button_unchecked</i><i class="material-icons circles" style="font-size:22px;">circle</i>
			</div>
			
			</div>
		`;
};

const renderSwipeLeftPanel = (props, {
	$h,
	$update
}) => {
	let leftMenuPermision = props['leftmenupermision'];
	const click_toggle_connect = (kitem) => { 
		if (!isset(peripheral[kitem.device])) {
			// invalid guid
		}
		//check if bg000 device ,this must be ble connect
		let checkBgStatus = false
		for(let deviceMap in peripheral){
			console.log(peripheral[deviceMap].prop.hexModel.toUpperCase())
			if((peripheral[deviceMap].prop.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[peripheral[deviceMap].prop.hexModel]) && peripheral[deviceMap].prop.id == peripheral[kitem.device].prop.id){
				checkBgStatus = true;
			}
		}
		if(checkBgStatus){
			app.dialog.confirm(`${_('Detected an abnormal device. Would you like to repair it?')}`,()=>{
				kitem.id = peripheral[kitem.device].prop.id;
				manufacturing_device(kitem);
			},()=>{})
			return;
		};
		let prop = peripheral[kitem.device].getProp();
		if (prop.connected || prop.connecting) {
			peripheral[kitem.device].disconnect().then((rs) => {
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",0);
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.signal-item').attr("bluetooth",0);
				$update();
			}, (error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
			});
		} else {
			peripheral[kitem.device].connect().then((rs) => {
				$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
				$update();
				if(isset(window.deviceDebugMap) && isset(window.deviceDebugMap[props.kitem.device])){
					const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
					window.deviceDebugMap[kitem.device]['logList'].push({
						timestamp:now,
						operate:'Connect',
						control_source:`bluetooth`, //MobMob,Bluetooth,Network,Http
						connectStatus : true,
						errorCode : 0
					})
			}
			}, (error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
				const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
				window.deviceDebugMap[kitem.device]['logList'].push({
						timestamp:now,
						operate:'Connect',
						control_source:`BLUETOOTH`, //MobMob,Bluetooth,Network,Http
						connectStatus : true,
						errorCode : erp.get_log_description(error)
					})
			});
		}
	};
	const toScene = async (item) => {
		//delete undefined values
		for (let i in item) {
			if (!isset(item[i])) {
				delete item[i]
			}
		}
		//mainView.router.navigate(`/mobile-app/scene-list?sceneitem=${encodeURIComponent(JSON.stringify(item))}`);
		mainView.router.navigate(`/mobile-app/scene-guid-list?subdevice_name=${item.name}`)
	};
	const openDebug = (item)=>{
		if(isset(window.deviceDebugMap)){
			if(!window.deviceDebugMap[item.device]){
				window.deviceDebugMap[item.device] = {};
				window.deviceDebugMap[item.device]['debug'] = true;
				window.deviceDebugMap[item.device]['logList'] = [];
			}
		}else{
			window.deviceDebugMap = {};
			window.deviceDebugMap[item.device] = {}
			window.deviceDebugMap[item.device]['debug'] = true;
			window.deviceDebugMap[item.device]['logList'] = [];
		}
		let title = `${tran(item.title)} ${_('Log Debug Mode Opened')}`;
		app.dialog.alert(`${title}`);
	}
	return () => $h`
			<div class="swipeout-actions-left">
				<a
					href="/mobile-app/ha-device-setting-connections?guid=${props.kitem.device}&subdevice_name=${props.kitem.name}"
					class="link color-orange"
					><i class="icon material-icons">integration_instructions</i></a
				>
				<a @click="${()=>toScene(props.kitem)}" class="link color-cust-green"
					><i class="icon material-icons">motion_photos_auto</i></a
				>
				<a
					href="/frappe/list/Timer/APP_HA_Device_Timer_V5/Profile Subdevice Timer/null/16/profile_subdevice=${props.kitem.name}/"
					class="link color-cust-blue"
					><i class="icon material-icons">alarm</i></a
				>
				<a
					@click="${()=>openDebug(props.kitem)}"
					class="link color-orange ${leftMenuPermision?'':'device-none'}"
					><i class="icon material-icons">adb</i></a
				>
				<a class="link color-cust-purple" @click="${()=>click_toggle_connect(props.kitem)}"
					><i class="icon material-icons">settings_bluetooth</i></a
				>
			</div>
		`;
};


const renderSwipeRightPanel = (props, {
	$h
}) => {
	const kitem = props.kitem;
	let leftMenuPermision = props['leftmenupermision'];
	/**
 * function description
 *
 * @param 
 * @param 
 * @param 
 * @return 
 */
	const deviceReplaceSearchDevice = ()=>{
		
	};
	return () => $h`
			<div class="swipeout-actions-right">
				<a
					href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(kitem.title))}&guid=${ kitem.device }&name=${kitem.name}&profile_device_name=${kitem.profile_device}&device_mode=${kitem.device_mode}&slot_index=${kitem.config?kitem.config:''}"
					class="link color-orange"
					><i class="icon material-icons">settings</i></a
				>
				<a
					class="link color-cust-green"
					ref="${kitem.device}|${kitem.device_name?kitem.device_name.substring(0,12):''}|${kitem.device_mode}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					href="/mobile-app/device-replace-page?guid=${ kitem.device }&title=${_('Replace')} ${encodeURIComponent(tran(kitem.title))}&name=${kitem.name}"
					><i class="icon material-icons">download</i></a
				>
				<a
					class="link color-cust-purple ${leftMenuPermision?'':'device-none'}"
					guid="${kitem.device}"
					ref="${kitem.device}|${kitem.mac_address}|${kitem.device_model}|${''}|${''}|${''}|${kitem.device_model}|${'YO0012'}|${kitem.profile_device}"
					func="iot_reset_password"
					><i class="icon material-icons">restart_alt</i></a
				>
				<a
					href="/mobile-app/device-control-log?subdevice_name=${kitem.name}"
					class="link color-cust-blue"
					><i class="icon material-icons">content_paste_go</i></a
				>
				<!-- <a func="app_set_device_hidden" ref="${kitem.name}" class="link color-cust-green"
					><i class="icon material-icons">visibility</i></a
				>-->
				<a href="#" data-confirm="${_('Are you sure you want to delete this item?')}" class="link swipeout-delete"
					><i class="icon material-icons">delete</i></a
				>
			</div>
		`;
};


const renderMainButton = (props, {
	$h,
	$update
}) => {
	
	const mode = props.kitem.device_mode;
	window.dealwithBleCommand = async(uuid,commandList)=>{
		let writeStatus = true;
		let bleWriteCount = 0;
		for(let commands in commandList){
			try{
				await ble.withPromises.write(uuid,'ff80','ff81',commands.toLocaleLowerCase().convertToBytes());
				bleWriteCount++;
			}catch(error){
				writeStatus = false;
			}
		}
		return new Promise((resolve,reject)=>{
			if(writeStatus && bleWriteCount == commandList.length){
				resolve(1)
			}else{
				reject(0)
			}
		})
	}
	window.manufacturing_device = async(kitem)=>{
		console.log(kitem);
		app.dialog.preloader(_('Connecting...'));
		//get the device info pass the mac_address
		//get the mac_address
		let uuid = kitem.id;
		try{
			ble.connect(uuid,(rs)=>{
				//read mac
				let service="180a", characteristic="2a23";
				ble.read(uuid, service, characteristic,(data)=>{
					let macaddress = data.toLowerCase();
					let iot_macaddress = '';
					while (macaddress.length < 16) macaddress = macaddress + "0";
					if (macaddress.substring(6, 10) === "0000") {
							let i = macaddress.length - 2;
							while (i >= 0) {
								if ((i >= 10 || i <= 4) && i > 0) {
									iot_macaddress += macaddress.substring(i, i + 2) + ":";
								}
								if (i === 0) {
									iot_macaddress += macaddress.substring(i, i + 2);
								}
								i = i - 2;
							}
						} else {
							let i = macaddress.length - 6;
							while (i >= 0) {
								if (i > 0) {
									iot_macaddress += macaddress.substring(i, i + 2) + ":";
								}
								if (i === 0) {
									iot_macaddress += macaddress.substring(i, i + 2);
								}
								i = i - 2;
							}
						}
						console.log(iot_macaddress);
						let macs = iot_macaddress.split(":");
						//compare to the erp data
						http2.request(`${encodeURI(`/api/method/appv6.getDeviceByMac?mac_address=${iot_macaddress}`)}`, {
                method: 'GET',
                serializer: 'json',
                responseType: 'json',
								debug:true
              }).then((resData)=>{
								let devices = resData.data.data;
								console.log("devices",devices);
								if(devices.length > 0){
									let this_guid = devices[0].guid;
									//wirte the guid in device 
									let numbers_data = `88014B${macs[3]}${macs[0]}A16E95`;
									// write super password 
									let paw_data = `880083${macs[2]}${macs[5]}543e15`;
									let this_data = `8100${this_guid}`;
									debugger
									return new Promise((resolve,reject)=>{
										ble.write(uuid,"ff80", "ff81",numbers_data.toLocaleLowerCase().convertToBytes(),()=>{
											ble.write(uuid,"ff80", "ff81",paw_data.toLocaleLowerCase().convertToBytes(),()=>{
												ble.write(uuid,"ff80", "ff81",this_data.convertToBytes(),()=>{
													resolve(1);
												},(writeError)=>{
													reject(writeError);
												})
											},()=>{});
										},()=>{

										})
									})
								}else{
									return new Promise((resolve,reject)=>{
										reject('The device has not been initialized. Please contact the relevant personnel.')
									})
								}
							}).then(()=>{
								let this_data = `810E`;
								return new Promise((resolve,reject)=>{
										ble.write(uuid,"ff80", "ff81",this_data.convertToBytes(),()=>{
											resolve(1);
										},(writeError)=>{
											reject(writeError);
										})
									})
							}).then(()=>{
								setTimeout(()=>{
									ble.connect(uuid,(rs)=>{
										debugger
										ble.disconnect(uuid,(res)=>{
											debugger
											ble.connect(uuid,(rs)=>{
												debugger
												ble.read(uuid, "180a", "2a29",(data)=>{
													debugger
													ble.disconnect(uuid,(res)=>{
														debugger
														ble.connect(uuid,(rs)=>{
															debugger
															ble.read(uuid, "180a", "2a29",(data)=>{
																debugger
															ble.disconnect(uuid,(res)=>{
																//refresh
																app.dialog.close();
																debugger
																//del the device 
																for(let deviceMap in peripheral){
																	if((peripheral[deviceMap].prop.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[peripheral[deviceMap].prop.hexModel]) && peripheral[deviceMap].prop.id == uuid){
																		delete peripheral[deviceMap]
																	}
																}
																//cancel the dvice show status
																// for(let deviceMap in unassigned_subdevices){
																// 	if(unassigned_subdevices[deviceMap].name == 'BG000' && unassigned_subdevices[deviceMap].id == uuid){
																// 		unassigned_subdevices[deviceMap].disappear = true;
																// 	}
																// }
																mainView.router.refreshPage();
															},(err3)=>{
																console.log("err3",err3)
															})
															},()=>{})
														},(err2)=>{
															console.log(err2);
														})
													},()=>{})
												},()=>{

												})
											},(err1)=>{
												console.log("err1",err1)
											})
										},(disconnectError)=>{
											console.log("disconnectError",disconnectError);
											app.dialog.close();
											app.dialog.alert(disconnectError)
										})
									},(connectError)=>{
										console.log("connectError",connectError)
										setTimeout(()=>{
											app.dialog.close();
											mainView.router.refreshPage();
										},6000)
										// app.dialog.close();
										// app.dialog.alert(connectError)
									})
								},6000)
							}).catch(errorss=>{
								app.dialog.close();
								console.log("errorss",errorss)
								app.dialog.alert(_(errorss))
							})
				},(errors)=>{
					app.dialog.close();
					app.dialog.alert(_('Failed to read Mac Address'));
				})
			},(err0)=>{
				console.log("err0",err0)
				// app.dialog.close();
				// app.dialog.alert(err0);
			})
		}catch(error){
			app.dialog.close();
			app.dialog.alert(_('Failed to connect'));
		}
	};
	const click_connect = (kitem) => {
		setTimeout(function() {
			//check if bg000 device ,this must be ble connect
			let checkBgStatus = false
			for(let deviceMap in peripheral){
				if((peripheral[deviceMap].prop.hexModel.toUpperCase() == '011A' || !erp.doctype.device_model[peripheral[deviceMap].prop.hexModel]) && peripheral[deviceMap].prop.id == peripheral[kitem.device].prop.id){
					checkBgStatus = true;
				}
			}
			if(checkBgStatus){
				app.dialog.confirm(`${_('Detected an abnormal device. Would you like to repair it?')}`,()=>{
					//manufacturing_device(kitem);
				},()=>{})
				return;
			};
			if (peripheral[kitem.device]) {
				peripheral[kitem.device].connect().then((rs) => {
					$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
					update_ble_iaq_data(kitem);
					//test connect log 
					const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
					let url = encodeURI('/api/resource/Device Log');
					http2.request(url, {
							method: "POST",
							responseType: "json",
							serializer: 'json',
							data: {
								device : kitem.device,
								owner : users[users.current].usr,
								timestamp : now,
								log_type : '7001',
								details : JSON.stringify({
									description : 'Bluetooth connection timed out'
								})
							}
					})
					$update();
				}).catch((error) => {
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(kitem.device).then(()=>{
							$(`.home-scanned-peripheral[guid="${kitem.device}"]`).find('.control-panel-right').attr("bluetooth",1);
            })
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				});
			}
		}, 1);
	};
	const update_ble_iaq_data = (kitem)=>{
		if(kitem.device_button_group.startsWith("IAQ")){
			//should mtu
			if(deviceInfo.operatingSystem === 'ios'){
				peripheral[kitem.device].write([{
					service: 'ff80',
					characteristic: 'ff81',
					data: `9380`,
				}])
			}else{
				ble.requestMtu(
					peripheral[kitem.device].prop.id,
					512,
					() => {
						console.log('>>>> device request mtu success');
						peripheral[kitem.device].write([{
								service: 'ff80',
                characteristic: 'ff81',
                data: `9380`,
						}])
					},
					(err) => {
						console.log('>>>> device request mtu fail: ' + err);
					}
				)
			}
		}else{
			return
		}
	}
	const click_curtain_switch = (kitem,type)=>{
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},10000)
		if(kitem.device_status == 0){
			props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
		}else{
			props.kitem.device_status = 0;
		}
		$(`.range-slider[guid="${kitem.device}"]`).find(".range-bar-active").css({
			width: props.kitem.device_status + '%'
		})
		$(`.range-slider[guid="${kitem.device}"]`).find(".range-knob-wrap").css({
			left: props.kitem.device_status + '%'
		})
		if (props.kitem.device_status > 1) {
			$(`.page-current .range-slider-home-auto[guid="${kitem.device}"][button_group="${kitem.device_button_group}"]`).removeClass('range-slider-min')
		} else {
			$(`.page-current .range-slider-home-auto[guid="${kitem.device}"][button_group="${kitem.device_button_group}"]`).addClass('range-slider-min')
		}
		if(kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')){
			peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {

			}).catch((error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
						
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}
			});
		}else{
			peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {


			}).catch((error) => {
				if(error == 7200){
					erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
						
					})
				}else{
					app.dialog.alert(_(erp.get_log_description(error)));
				}

			});
		}
	}
	const click_curtain_motor = (kitem, type) => {
		//console.log("click_curtain_motor");
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},30000)
		let otherModelStatus = false;
		if(kitem.device_model == 'YO121-AC-R2W') otherModelStatus = true;
		let reverse = kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') ? true : false;
		let bar_value = 0;
		let data = ``;
		if (type) {
			data = "55AA050101036DDC";
			//this have differ model command
			if(otherModelStatus){
				data = '55fefe0303';
			}
		} else {
			if (kitem.device_status == 0 || kitem.device_status == 1) {
				//props.kitem.device_status = 1;
				props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
				// if (isset(window.dimmingRecord[props.kitem.name]) && window.dimmingRecord[props.kitem.name]['lastref'] > 0) {
				// 	bar_value = window.dimmingRecord[props.kitem.name]['lastref'];
				// } else {
				// 	bar_value = 100;
				// }
			} else {
				props.kitem.device_status = 0;
			}
			$(`.range-slider[guid="${kitem.device}"]`).find(".range-bar-active").css({
				width: props.kitem.device_status + '%'
			})
			$(`.range-slider[guid="${kitem.device}"]`).find(".range-knob-wrap").css({
				left: props.kitem.device_status + '%'
			})
			if (props.kitem.device_status > 1) {
				$(`.page-current .range-slider-home-auto[guid="${kitem.device}"]`).removeClass('range-slider-min')
			} else {
				$(`.page-current .range-slider-home-auto[guid="${kitem.device}"]`).addClass('range-slider-min')
			}
			if (reverse) {
				data = `55AA060102${(100-props.kitem.device_status*1).toString(16).pad("00")}FF`;
				if(otherModelStatus){
					data = `55fefe0304${(100-props.kitem.device_status*1).toString(16).pad("00")}`;
				}
			} else {
				data = `55AA060102${props.kitem.device_status.toString(16).pad("00")}FF`;
				if(otherModelStatus){
					data = `55fefe0304${props.kitem.device_status.toString(16).pad("00")}`;
				}
			}

		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		let command = "8602" + data.toLowerCase();
		console.log("command",command);
		window.peripheral[props.kitem.device].curtainmotor([{
			gang: bleHelper.getGangId(kitem.device_button_group),
			value: props.kitem.device_status,
			command: command
		}]).then(()=>{

		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
		$update();
	}
	const click_onoff_thermostat = (kitem) => {
		if (kitem.device_status == 0) {
			props.kitem.device_status = 1;
		} else {
			props.kitem.device_status = 0;
		}
		let data = '9403000001' + parseInt(kitem.device_status).toString(16).pad('00');
		window.peripheral[props.kitem.device].thermostat([{
			gang: bleHelper.getGangId(kitem.device_button_group),
			value: props.kitem.device_status,
			command: data
		}]).then(()=>{

		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
		//emitter.off(`thermostat_${props.kitem.device}`);
		emitter.emit(`thermostat_${props.kitem.device}`, {
			guid: props.kitem.device,
			ref: props.kitem.device_status
		})
		$update();
	}
	const click_onoff = async(kitem) => {
		let oldStatus = kitem.device_status;
		// try{
		// 	await iot_ble_check_enable();
		// }catch(error){
		// 	app.dialog.alert(error);
		// 	return;
		// }
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		kitem['timeout'] = setTimeout(()=>{
			kitem['click_status'] = null;
		},10000)
		if (kitem.device_status == 0) {
			if (
				kitem.device_button_group.startsWith('RCU DIMMING') ||
				kitem.device_button_group.startsWith('DIMMING')
			) {
				props.kitem.device_status = peripheral[kitem.device].getLastOnStatus(kitem.device_button_group);
			} else {
				props.kitem.device_status = 1;
			}
		} else {
			props.kitem.device_status = 0;
		}
		$update();
		setTimeout(function() {
			if (peripheral[kitem.device]) {
				if (kitem.device_button_group.startsWith('RCU ONOFF GANG')) {
					peripheral[kitem.device].rcuOnoff([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then((rs) => {

					}).catch((error) => {
						if(error == 7200){
							erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
								
							})
						}else{
							app.dialog.alert(_(erp.get_log_description(error)));
						}
					});
				} else if (kitem.device_button_group.startsWith('DIMMING') || kitem.device_button_group.startsWith('RCU DIMMING')) {
					
					const v = Math.ceil((props.kitem.device_status*1.0 / 255.0) * 100.0) || 0;

					if($(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).length){
							$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`)
								.find('.range-bar-active')
								.css({
									width: v + '%',
								});
							$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`)
								.find('.range-knob-wrap')
								.css({
									left: v + '%',
								});
							if (v > 1) {
								$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).removeClass('range-slider-min');
							} else {
								$(`.page-current .range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`).addClass('range-slider-min');
							}
						}
						if(kitem.device_button_group.startsWith('RCU DIMMING')){
							peripheral[props.kitem.device].rcuDimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(()=>{

							}).catch(error=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}else{
							peripheral[props.kitem.device].dimming([{
								gang: bleHelper.getGangId(props.kitem.device_button_group),
								value: props.kitem.device_status
							}]).then(()=>{
								
							}).catch((error)=>{
								if(error == 7200){
									erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
										
									})
								}else{
									app.dialog.alert(_(erp.get_log_description(error)));
								}
							})
						}
					
				} else {
					let service = "ff80", characteristic = "ff81";
					let data = [0,0,0,0,0,0,0,0];
					let this_gang = bleHelper.getGangId(kitem.device_button_group);
					data[(4-this_gang)] = 1;
					if(props.kitem.device_status){
						data[(8-this_gang)] = 1;
					}
					data = parseInt(data.join(""), 2).toString(16).toUpperCase().pad("00");
					data = `8000${data}00`;
					peripheral[kitem.device].onoff([{
						gang: bleHelper.getGangId(kitem.device_button_group),
						on: props.kitem.device_status
					}]).then(async(rs) => {
						const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
						let saveUrl = app_core_encode_link('/api/resource/Device Control Log');
						let bodyData = {
								device : kitem.device,
								status : props.kitem.device_status,
								control_source : `Bluetooth`, //MobMob,Bluetooth,Network,Http
								timestamp:now,
								profile_subdevice:kitem.name
						}
						http2.request(saveUrl, {
								method: "POST",
								responseType: "json",
								serializer: 'json',
								data: bodyData
						});
						if(isset(window.deviceDebugMap) && isset(window.deviceDebugMap[props.kitem.device])){
							window.deviceDebugMap[props.kitem.device]['logList'].push({
								timestamp:now,
								operate:props.kitem.device_status,
								control_source:`${await peripheral[props.kitem.device].findRoute()}`, //MobMob,Bluetooth,Network,Http
								connectStatus : true,
								command : data,
								service : service,
								characteristic : characteristic,
								button_group : kitem.device_button_group,
								errorCode : 0
							})
						}
					}).catch(async(error) => {
						//if error change the old status
						//check if paw error
						if(error == 7200){
							erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
								
							})
						}else{
							props.kitem.device_status = oldStatus;
							app.dialog.alert(_(erp.get_log_description(error)));
							const now = DateFormatter.format((new Date()), "Y-m-d H:i:s");
							window.deviceDebugMap[props.kitem.device]['logList'].push({
								timestamp:now,
								operate:props.kitem.device_status,
								control_source:`${await peripheral[props.kitem.device].findRoute()}`, //MobMob,Bluetooth,Network,Http
								connectStatus : false,
								command : data,
								service : service,
								characteristic : characteristic,
								button_group : kitem.device_button_group,
								errorCode : erp.get_log_description(error)
							})
							$update();
						}
					});
				}
			}
		}, 1);
	};
	//this bacnet flow
	const bacnet_click_onoff = (kitem)=>{
		let configString = kitem.config;
		if(kitem.device_status == 0){
			kitem.device_status = 1;
		}else{
			kitem.device_status = 0;
		}
		if(configString){
			let config = configString.split("|");
			let airconfig = config[5].split(",");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			temp = tagCode.split("_");
			let roomCode = temp[0];
			let message = [];
			console.log("airconfig[0]",airconfig[0])
			if(airconfig[0] == "1"){
				
				airconfig[0] = "0";
			}else{
				kitem.device_status = 1;
				airconfig[0] = "1";
			}
			config[5] = airconfig.join(",");
			kitem.config = config.join("|");
			message.push({
				"operate": "write",
				"deviceCode": deviceCode,
				"tagCode": roomCode + "_ONOFF_CTRL",
				"val": `${airconfig[0]}`
			});
			message = JSON.stringify(message);
			console.log("message",message)
			core_mqtt_publish(config[1], message, 0, false, false, true);
			try{
				let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
				subdevices.forEach(item=>{
						if(item.name == kitem.name){
								item.config = config.join("|")
						}
				})
				http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
							profile_subdevice : subdevices
					}
			})
			}catch(error){
				console.log(error);
			}
			$update();
			// cordova.plugin.innocow.mqtt.execute({
			// 	command: "publish",
			// 	id: (Math.floor(Math.random() * 100000) + 1),
			// 	topic: config[1],
			// 	msg: message,
			// 	qos: 0,
			// 	retained: false
			// }, function() {}, function() {});
		}

	}
	const bacnet_light_scene_click_onoff = (kitem,type)=>{
		let configString = kitem.config;
		if(configString){
			let config = configString.split("|");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			let message = [];
			message.push({
					"operate":"write",
					"deviceCode":deviceCode,
					"tagCode":tagCode,
					"val":`${type}`
			});
			message = JSON.stringify(message);
			console.log("message",message)
			core_mqtt_publish(config[1], message, 0, false, false, true);
			$update();
		}
	}
	const iot_rcu_output_change = (kitem,type)=>{
		kitem['click_status'] = true;
		kitem['timeout'] = null;
		if(kitem['timeout']){
			clearTimeout(kitem['timeout']);
		}
		//let config = kitem.config?JSON.parse(kitem.config):{};
		//let {dnd,clear} = config;
		let dnd = 32;
		let clear = 31;
		let dnd_virtual_button_group = `RCU OUTPUT${dnd}`;
		let clear_virtual_button_group = `RCU OUTPUT${clear}`;
		let dndOldStatus = isset(kitem.dnd)?kitem.dnd:0;
		let clearOldStatus = isset(kitem.clear)?kitem.clear:0;
		if(type == 'dnd'){
			if(kitem.dnd == 0 || !isset(kitem.dnd)){
				props.kitem.dnd = 1;
				//if click this status,change other status
				props.kitem.clear = 0;
			}else{
				props.kitem.dnd = 0;
			}
		}else if(type == 'clear'){
			if(kitem.clear == 0 || !isset(kitem.dnd)){
				props.kitem.clear = 1;
				props.kitem.dnd = 0;
			}else{
				props.kitem.clear = 0;
			}
		}
		peripheral[kitem.device].rcuOutput([{
			gang: bleHelper.getGangId(dnd_virtual_button_group),
			value: props.kitem.dnd
		}]).then((rs) => {

		}).catch((error) => {
			props.kitem.dnd = dndOldStatus;
			props.kitem.clear = clearOldStatus;
			$update();
			app.dialog.alert(_(erp.get_log_description(error)));
		});
		peripheral[kitem.device].rcuOutput([{
			gang: bleHelper.getGangId(clear_virtual_button_group),
			value: props.kitem.clear
		}]).then((rs) => {

		}).catch((error) => {
			//app.dialog.alert(error)
			//props.kitem.dnd = dndOldStatus;
			props.kitem.clear = clearOldStatus;
			$update();
			app.dialog.alert(_(erp.get_log_description(error)));
		});
		$update();
	}
	const click_onoff_start = (kitem) => {
		if (kitem.device_model.startsWith("YO780")) {
			if (kitem.device_status == 1) {
				props.kitem.device_status = 0;
			} else {
				props.kitem.device_status = 1;
			}
			peripheral[kitem.device].rcuOutput([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				value: props.kitem.device_status
			}]).then((rs) => {

			}).catch((error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
				//app.dialog.alert(error)
			});
		} else {
			kitem.device_status = 1;
			peripheral[kitem.device].onoff([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				on: true
			}]).then((rs) => {

			}).catch((error) => {
				app.dialog.alert(_(erp.get_log_description(error)));
				//app.dialog.alert(error)
			});
		}
	}
	const click_onoff_end = (kitem) => {
		kitem.device_status = 0;
		if (kitem.device_model.startsWith("YO780")) {
			peripheral[kitem.device].rcuOutput([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				value: kitem.device_status
			}]).then((rs) => {

			}).catch((error) => {
				//app.dialog.alert(error)
			});
		} else {
			peripheral[kitem.device].onoff([{
				gang: bleHelper.getGangId(kitem.device_button_group),
				on: true
			}]).then((rs) => {

			}).catch((error) => {
				//app.dialog.alert(error)
			});
		}
	}
	const click_ir = (kitem)=>{
		//let { device_button_group, guid, id, device_command, password, name, network_id,device } = kitem;
// 		let irConfig = peripheral[kitem.device].prop.config;//{}
// 		let configStr = 'ir|0|25,1,2,1,0,1'; //ir|0|tem,speed,direction,swing,onoff,mode
// 		if(isset(irConfig[kitem.name])){
// 			configStr = irConfig[kitem.name]
// 		}
		let configStr = kitem.device_config;
		let this_config = configStr.split("|");
		let airconfig = isset(this_config[2]) && this_config[2] != ',,,,NaN' ? this_config[2].split(',') : '25,1,2,1,0,1'.split(',');
		kitem['click_status'] = true;
		//let config = configStr.split('|');
		let onoffRef = configStr.substring(14,15);
		if(onoffRef == 0){
			onoffRef = 1
		}else{
			onoffRef = 0;
		}
		configStr =`${configStr.substring(0,14)}${onoffRef}${configStr.substring(15,configStr.length)}`;
// 		peripheral[kitem.device].prop.config[kitem.name] = configStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, configStr);
		props.kitem.device_status = onoffRef;
		props.kitem.device_config = configStr;
		props.kitem.config = configStr;
		
		
		let command = kitem.device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,"ARC_ON_OFF",configStr.substring(5,configStr.length));
		peripheral[kitem.device].sendIR(ref_command);
		//peripheral[kitem.device].onPropChanged();
		$update();
	}
	const press_openclose = (kitem, direction, press) => {
		setTimeout(function() {
			if (peripheral[kitem.device]) {

				if (kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
					peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {

					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));
					});
				} else {
					peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, press).then((rs) => {


					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));

					});
				}
			}
		}, 1);
	};

	const iot_get_music_player_password = (item) => {
		//if not in profile ,false
		if (!item.name) {
			app.dialog.alert(`${tran('You do not have permission to use this device.')}`, runtime.appInfo.name, () => {});
			return false;
		}
		//first get the unique key form the function;
		//1.get time form the device setting,if have time,use it,else input the time
		let deviceObj = cloneDeep(erp.info.device);
		let settings = [];
		let deviceTime = [];
		let erp_keys = '';
		if (deviceObj[item.device] && deviceObj[item.device].settings) {
			settings = deviceObj[item.device].settings;
		}
		settings.forEach(item => {
			if (item.setting_type == "TimeStream") {
				let time = JSON.parse(item.setting);
				deviceTime = time;
			}
			if (item.setting_type == "ConnectKey") {
				erp_keys = item.setting;
			}
		});
		//verify the time check now > the device time
		let status = compareTimeToMusicPlayer(deviceTime);
		if (!status) {
			//update the time of the music player
			//input the time
			app.dialog.prompt('Please enter the length of stay in days', async (days) => {
				const regex = /^\d+(\.\d+)?$/;
				if (!regex.test(days)) {
					app.dialog.alert('Please enter the correct value', runtime.appInfo.name, () => {});
					return false
				} else {
					//get the timeList 
					const currentDate = dayjs();
					const futureDate = currentDate.add(days, 'day');
					let list = [currentDate.format('YYYY-MM-DD HH:mm:ss'), futureDate.format('YYYY-MM-DD HH:mm:ss')];
					let this_password = getRandomNumbers().join("");
					try {
						await window.peripheral[props.kitem.device].doConnect();
						//get the years and months and the days and the hours and the seconds
						let this_time_list = calculateFutureTime(days);
						let this_year = this_time_list[0];
						let this_month = this_time_list[1];
						let this_day = this_time_list[2];
						let this_hour = this_time_list[3];
						let this_minute = this_time_list[4];
						let this_second = this_time_list[5];
						let data = `9800000008${this_password.convertToHex()}${this_second.toString(16).pad('00')}${this_minute.toString(16).pad('00')}${this_hour.toString(16).pad('00')}${this_day.toString(16).pad('00')}${this_month.toString(16).pad('00')}${iot_utils_to_little_endian_hex(this_year,2)}`;
						
						await window.peripheral[props.kitem.device].write([{
							service: 'ff80',
							characteristic: 'ff81',
							data: data,
						}]);
						await iot_device_setting_sync_server(item.device, 'TimeStream', JSON.stringify(list));
						await iot_device_setting_sync_server(item.device, 'ConnectKey', this_password);
						let sheet = app.sheet.create({
							content: `\
									<div class="sheet-modal">\
										<div class="toolbar">\
											<div class="toolbar-inner justify-content-flex-end">\
												<a  class="link sheet-close">Close</a>\
											</div>\
										</div>\
										<div class="sheet-modal-inner display-flex justify-content-center align-content-center align-items-center">\
											<div class="circle-password">${this_password[0]}</div>\
											<div class="circle-password">${this_password[1]}</div>\
											<div class="circle-password">${this_password[2]}</div>\
											<div class="circle-password">${this_password[3]}</div>\
										</div>\
									</div>\
								`
						});
						sheet.open();
						//app.dialog.alert(`${tran('Connection Key: ')}${this_password}`, runtime.appInfo.name, () => {});
					} catch (error) {
						app.dialog.alert(`${tran('Get the music player password failed')}`, runtime.appInfo.name, () => {});
					}
				}
			}, () => {})
		} else {
			if (erp_keys) {
				let sheet = app.sheet.create({
					content: `\
							<div class="sheet-modal">\
								<div class="toolbar">\
									<div class="toolbar-inner justify-content-flex-end">\
										<a  class="link sheet-close">Close</a>\
									</div>\
								</div>\
								<div class="sheet-modal-inner display-flex justify-content-center align-content-center align-items-center">\
									<div class="circle-password">${erp_keys[0]}</div>\
									<div class="circle-password">${erp_keys[1]}</div>\
									<div class="circle-password">${erp_keys[2]}</div>\
									<div class="circle-password">${erp_keys[3]}</div>\
								</div>\
							</div>\
						`
				});
				sheet.open();
				//app.dialog.alert(`${tran('Connection Key: ')}${erp_keys}`, runtime.appInfo.name, () => {});
			}
		}
	}
	const compareTimeToMusicPlayer = (timeRange) => {
		if (timeRange.length == 0 || timeRange.length == 1) {
			return false;
		}
		const startTimeStr = timeRange[0];
		const endTimeStr = timeRange[1];
		const currentTime = dayjs();
		const startTime = dayjs(startTimeStr);
		const endTime = dayjs(endTimeStr);
		if (currentTime.isAfter(startTime) && currentTime.isBefore(endTime) || currentTime.isSame(startTime) || currentTime.isSame(endTime)) {
			return true;
		} else {
			return false;
		}
	}
	const getRandomNumbers = () => {
		let numbers = new Set();
		while (numbers.size < 4) {
			const randomNum = Math.floor(Math.random() * 10);
			numbers.add(randomNum);
		}
		return Array.from(numbers);
	}
	const calculateFutureTime = (days) => {
		const futureDate = dayjs().add(days, 'day');
		const futureTimeArray = [
			futureDate.year(),
			futureDate.month() + 1,
			futureDate.date(),
			futureDate.hour(),
			futureDate.minute(),
			futureDate.second()
		];
		return futureTimeArray;
	}
	const iot_music_player_change_source = async(kitem)=>{
		let subdevice_name = kitem.name;
		try{
			await window.peripheral[kitem.device].doMusicPlayer();
			if(kitem.config == 'phone_iphone'){
				kitem.config = 'tv';
			}else{
				kitem.config = 'phone_iphone';
			}
			//update profile
			let this_subdevices = cloneDeep(erp.info.profile.profile_subdevice);
			this_subdevices.forEach(item=>{
				if(item.name == kitem.name){
					item.config = kitem.config;
				}
			})
			try{
				http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
					serializer: "json",
					responseType: "json",
					method: "PUT",
					data: {
							profile_subdevice : this_subdevices
					}
			})
			}catch(error){
				console.log(error);
			}
			//app.dialog.alert(`Audio Source Switched Successfully`);
		}catch(error){
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	//virtual Button click
	const clickSceneVirtualButton = (kitem)=>{
		console.log(kitem);
		//command
		let config = kitem.config;
		let guid = kitem.device;
		if(!config){
			app.dialog.alert(`${_('Error')}`);
			return 
		}
		let command = `8f0200${parseInt(config).toString(16).pad('00')}`;
		try{
			window.peripheral[guid].write([{
				service: 'ff80',
				characteristic: 'ff81',
				data: command,
			}])
		}catch(error){
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	if (
		props.kitem.device_button_group.startsWith('OPENCLOSE GANG') ||
		props.kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')
	) {	
		let ref = props.kitem.device_status;
		let curtainCloseIcon = `close-curtain.svg`;
		let curtainOpenIcon = `open-curtain.svg`;
		let imgurl = `${'https://my.yoswit.com/'}/files/app/${ref > 0?curtainOpenIcon:curtainCloseIcon}`;
		return () => $h`
			<div class="control-panel-right" type-box='Dimming' bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
				<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
					<div class="button button-raised button-big circle">
						<i class="material-icons">bluetooth_connected</i>
					</div>
				</a>
				<a class="left off_flag" @touchstart="${()=>press_openclose(props.kitem, 'close', true)}"  @touchend="${()=>press_openclose(props.kitem, 'close', false)}">
					<div class="button button-raised button-big openclose cl" style="width:57px"><div class="rotate-90" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;">unfold_less</i></div></div>
				</a>
				<a class="left on_flag" @touchstart="${()=>press_openclose(props.kitem, 'open', true)}"  @touchend="${()=>press_openclose(props.kitem, 'open', false)}">
					<div class="button button-raised button-big openclose op" style="width:57px"><div class="rotate-90" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;">unfold_more</i></div></div>
				</a>
			</div>
		`;
	} else if (
		props.kitem.device_button_group.startsWith('RCU ONOFF GANG') ||
		props.kitem.device_button_group.startsWith('ONOFF GANG')
	) {
		if (props.kitem.device_model == 'YO790DC') {
			let music_config = props.kitem.config;
			return () => $h`
					<a class="control-panel-right">
						<div class="left button button-raised button-big circle"  @click="${()=>iot_get_music_player_password(props.kitem)}">
								<i class="material-icons">key</i>
						</div>
						<div class="left button button-raised button-big circle"  @click="${()=>iot_music_player_change_source(props.kitem)}">
								<i class="material-icons" style="font-size:30px!important;line-height:30px!important;">${music_config?music_config:'phone_iphone'}</i>
						</div>
					</a>
					`;
		}else if(props.kitem.device_mode == 'Multiway Switch'){
			//start the mutiway logic
			//shoud check if have the config on the profile
			//console.log("props.kitem.light_ref",props.kitem.light_ref);
			//console.log("update ref",isset(props.kitem.light_ref)?props.kitem.light_ref:0)
			let config = props.kitem.config;
			let be_pairing = true;
			let is_pairing = false;
			if(config){
				let configMap = JSON.parse(props.kitem.config);
				be_pairing = configMap.be_pairing == 1?true:false;
				is_pairing = configMap.is_pairing == 1?true:false;
			}
			if(be_pairing){
				return () => $h`
				<div class="control-panel-right" style="">
					<a class="on_flag off_flag" ref="${isset(props.kitem.light_ref)?props.kitem.light_ref:props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}">
						<div class="button button-raised button-big onoff"></div>
					</a>
				</div>
			`;
			}else if(is_pairing){
				return () => $h`
					<div>
					</div>
				`;
			}else{
				return () => $h`
					<div>
					</div>
				`;
			}
		}else if(props.kitem.device_model == 'YO780-Scene-6G' || props.kitem.device_model == 'YO780-Scene-12G' || props.kitem.device_model == 'YO780-Scene-4G' || props.kitem.device_model == 'YO780-Scene-2G' || props.kitem.device_model == 'YO780-Scene-3G' || props.kitem.device_model == 'YO780-Scene-1G'){
			return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
		} else if (props.kitem.device_mode == 'RCU Controller' && props.kitem.device_model == 'YO780') {
			return () => $h`
        <div class="control-panel-right">
            <a href="/mobile-app/setting-page?title=${_('Edit')} ${encodeURIComponent(tran(props.kitem.title))}&guid=${ props.kitem.device }&name=${props.kitem.name}&profile_device_name=${props.kitem.profile_device}&device_mode=${props.kitem.device_mode}&slot_index=${props.kitem.config?props.kitem.config:''}" class="right" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;">settings</i></div></div>
            </a>
        </div>
        `;
		}else if(props.kitem.device_mode == 'Parking Lock'){
			return () => $h`
        <div class="control-panel-right">
            <a ref="${props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}" class="right park-lock" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;"></i></div></div>
            </a>
        </div>
        `;
		}else if(props.kitem.device_mode == 'Geomagnetic'){
			return () => $h`
        <div class="control-panel-right">
            <a ref="${isset(props.kitem.dc_status)?props.kitem.dc_status:0}" class="right geomagnetic" >
                <div class="button button-raised button-big circle"><div><i class="material-icons" style="line-height:70px!important;font-size:20px;"></i></div></div>
            </a>
        </div>
        `;
		} else {
			return () => $h`
					<div class="control-panel-right" style="">
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
		}
	}else if(props.kitem.device_button_group.startsWith('Hdmicec')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/hdmicec-page?guid=${props.kitem.device}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">view_sidebar</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('Geomagnetic')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/hdmicec-page?guid=${props.kitem.device}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">view_sidebar</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('DOOR SIGN')){
		return () => $h`
					<a class="control-panel-right">
						<div class="left button button-raised button-big circle rcu-output" ref="${isset(props.kitem.dnd)?props.kitem.dnd:0}"  @click="${()=>iot_rcu_output_change(props.kitem,'dnd')}">
								<i class="material-icons">notifications_off</i>
						</div>
						<div class="left button button-raised button-big circle rcu-output" ref="${isset(props.kitem.clear)?props.kitem.clear:0}"  @click="${()=>iot_rcu_output_change(props.kitem,'clear')}">
								<i class="material-icons">cleaning_services</i>
						</div>
					</a>
					`;
	}else if(props.kitem.device_button_group.startsWith('RCU INPUT')){
		//cable block
		return ()=> $h`
			<a class="control-panel-right">
				<div class="left button button-raised button-big circle rcu-output" guid="${props.kitem.device}" device_button_group="${props.kitem.device_button_group}">
						<i class="material-icons">block</i>
				</div>
			</a>
		`;
	} else if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING')) {
		return () => $h`
					<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
						<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
							<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
							</div>
						</a>
						<a href="#" class="on_flag off_flag" ref="${props.kitem.device_status>0?1:0}" @click="${() => click_onoff(props.kitem)}">
								<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	} else if (props.kitem.device_mode === 'Access Controller') {
		if (props.kitem.device_button_group == 'TOGGLE GANG1') {
			return () => $h`
				<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
					<a class="iot-connect" @click="${()=>click_connect(props.kitem)}">
						<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
						</div>
					</a>
					<a class="on_flag off_flag touch-button-group" ref="${props.kitem.device_status}" @touchstart="${() => click_onoff_start(props.kitem)}" @touchend="${() => click_onoff_end(props.kitem)}">
							<div class="button button-raised button-big circle" style="border-radius:50%;">
								<div class="" style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;margin-left:1px;margin-top:1px;">touch_app</i></div>
							</div>
					</a>
				</div>
				`;
		}
	} else if (props.kitem.device_button_group.startsWith('RCU OUTPUT')) {
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff_start(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	} else if (props.kitem.device_button_group.startsWith('OPENCLOSE UART')) {
		let ref = props.kitem.device_status;
		let curtainCloseIcon = `close-curtain.svg`;
		let curtainOpenIcon = `open-curtain.svg`;
		
		if(props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE')){
			if(!props.kitem['click_status']){
				//debugger
				console.log("click_status",ref)
				ref = 100 - ref*1;
			}
		}
		console.log("ref",ref);
		let imgurl = `${'https://my.yoswit.com/'}/files/app/${ref > 1?curtainOpenIcon:curtainCloseIcon}`;
		return () => $h`
			<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
				<a class="iot-connect" @click="${()=>click_connect(props.kitem)}">
					<div class="button button-raised button-big circle">
							<i class="material-icons">bluetooth_connected</i>
					</div>
				</a>
				<a class="left on_flag" ref="2" @click="${()=>click_curtain_motor(props.kitem,'pause')}" button_group="${props.kitem.device_button_group}" command-type="Bluetooth" command="">
						<div class="button button-raised button-big openclose cl" style="width:57px"><div style="height:100%;width:100%;"><i class="material-icons" style="font-size:24px!important;margin-top:6px;">pause</i></div></div>
				</a>
				<a class="left on_flag" ref="${ref}" direction="${props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE')?'reverse':'standard'}" @click="${()=>click_curtain_motor(props.kitem)}" button_group="${props.kitem.device_button_group}" command-type="Bluetooth" command="">
						<div class="button button-raised button-big openclose op" style="width:57px"><div style="height:100%;width:100%;"><img src="${imgurl}" alt="" style="width:20px;height:20px;margin-top:5px;" /></div></div>
				</a>
			</div>
			`;
	} else if (props.kitem.device_button_group.startsWith('Thermostat')) {
		return () => $h`
					<div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
						<a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
							<div class="button button-raised button-big circle">
								<i class="material-icons">bluetooth_connected</i>
							</div>
						</a>
						<a class="on_flag off_flag" ref="${props.kitem.device_status}" @click="${() => click_onoff_thermostat(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
					</div>
				`;
	}else if(props.kitem.device_button_group.startsWith('BACNET AIR CONDITIONER')){
		let configString = props.kitem.config;
		if(configString){
			let config = configString.split("|");
			let airconfig = config[5].split(",");
			props.kitem.device_status = airconfig[0];
		}
		// if(!isset(props.kitem.device_status) && props.kitem.device_status != 0){
		// 	props.kitem.device_status = 1;
		// }
		console.log("props.kitem.device_status",props.kitem.device_status)
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="${isset(props.kitem.device_status)?props.kitem.device_status:0}" @click="${() => bacnet_click_onoff(props.kitem)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	}else if(props.kitem.device_button_group.startsWith('BACNET LIGHTING SCENE')){
		return () => $h`
        <div class="control-panel-right">
					<a class="on_flag off_flag" ref="0" @click="${() => bacnet_light_scene_click_onoff(props.kitem,1)}">
							<div class="button button-raised button-big onoff"></div>
						</a>
        </div>
        `;
	} else if (mode == 'RF Sensor' || mode == '4in1 Sensor' || mode == 'Radar Sensor') {
		return () => $h`
      <div class="control-panel-right">
          <a class="right">
              <div class="button button-raised button-big circle rf-sensor">
                  <i class="material-icons">block</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group == 'IR-DIY-no_model'){
		return () => $h`
      <div class="control-panel-right">
          <a class="right" href="/mobile-app/device-ir-diy-panel?subdevice=${props.kitem.name}">
              <div class="button button-raised button-big circle">
                  <i class="material-icons" style="line-height: 25px !important;">view_sidebar</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group_type == 'Air Conditioner'){
		return () => $h`
    		<div class="control-panel-right"  bluetooth="${props.kitem.bluetooth}">
                <a class="right" @click="${() =>
                    click_ir(props.kitem)}" button-signal="ARC_ON_OFF" command="${
                        props.kitem.device_command
                    }">
                    <div class="button button-raised button-big circle">
                        <i class="material-icons">power_settings_new</i>
                    </div>
                </a>
    		</div>
        `;
	} else if (
		props.kitem.device_button_group_type == 'Television' ||
		props.kitem.device_button_group_type == 'Set-top boxes' ||
		props.kitem.device_button_group_type == 'Audio' ||
		props.kitem.device_button_group_type == 'Projector' ||
		props.kitem.device_button_group_type == 'Fan' ||
		props.kitem.device_button_group_type == 'IPTV' ||
		props.kitem.device_button_group_type == 'Air Purifier' ||
		props.kitem.device_button_group_type == 'Camera' ||
		props.kitem.device_button_group_type == 'Dehumidifier' ||
		props.kitem.device_button_group_type == 'Robot'
	) {
		return () => $h`
      <div class="control-panel-right">
          <a class="right" func="controller_iot_device_ir_full_panel_click" guid="${props.kitem.device}" button-signal="5"  command="0141BE02FD0DF209F603FC52AD53AC00FF10EF11EE13EC14EB15EA17E818E719E6FF001BE4FF000AF54AB547B849B64BB44DB248B720DF0000" command-type="Bluetooth">
              <div class="button button-raised button-big circle">
                  <i class="material-icons">power_settings_new</i>
              </div>
          </a>
          <a class="right" href="/mobile-app/device-ir-full-panel?subdevice=${props.kitem.name}&device_type=${props.kitem.device_button_group_type}" button-signal="ARC_ON_OFF"  command="0141BE02FD0DF209F603FC52AD53AC00FF10EF11EE13EC14EB15EA17E818E719E6FF001BE4FF000AF54AB547B849B64BB44DB248B720DF0000" command-type="Bluetooth">
              <div class="button button-raised button-big circle">
                  <i class="material-icons" style="line-height: 25px !important;">view_sidebar</i>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_button_group.startsWith('Yoswit Gateway')){
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="/mobile-app/gateway-wifi-config?guid=${props.kitem.device}&device_name=${props.kitem.profile_device}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith("SCENE MUTIWAY ONOFF GANG1")){
		return () => $h`
				<div class="control-panel-right" style="">
					<a class="right" @click="${()=>clickSceneVirtualButton(props.kitem)}">
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">power_settings_new</i></div></div>
					</a>
				</div>
				`;
	}else if(props.kitem.device_button_group.startsWith("IAQ")){
		// if(props.kitem.device_model == 'YO161'){

		// }else if(props.kitem.device_model == 'YO161-H'){

		// }
		return () => $h`
      <div class="control-panel-right" type-box="Dimming" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}">
          <a class="iot-connect non-connect" @click="${()=>click_connect(props.kitem)}">
              <div class="button button-raised button-big circle">
                  <i class="material-icons">bluetooth_connected</i>
              </div>
          </a>
          <a class="right iaq-button-score-a">
              <div class="button iaq-button-score button-raised button-big circle display-flex flex-direction-column justify-content-center align-content-center align-items-center" style="background-color:green;line-height:18px;padding-top:10px;color:#fff;">
                  <span class="score text-color-white" style="height:29px;font-size:23px;">${props.kitem.ref}</span>
                  <div class="score-desc text-color-white" style="font-size: 12px;height:29px;line-height:29px;">Good</div>
              </div>
          </a>
      </div>
      `;
	}else if(props.kitem.device_model == 'BG000'){
		return () => $h` 
				<div class="control-panel-right" style="">
					<a href="#" @click="${()=>manufacturing_device(props.kitem)}" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}else {
		return () => $h`
				<div class="control-panel-right" style="">
					<a href="#" func="ble_load_to_device_form_auto" class="right" >
						<div class="button button-raised button-big circle"><div><i class="material-icons" style="font-size:20px;position:relative;top:5px;">settings</i></div></div>
					</a>
				</div>
				`;
	}
};
//vervify the password
const iotEntryPasswordVerify = () => {

}
//fixed the mac issue
const fixedMacRever = (kitem)=>{
	app.dialog.confirm(`${_('Device configuration has some issues, do you want to fix them?')}`,()=>{
		let scan_mac_address = erp.info.device[kitem.device]['mac_address'];
		let init_mac_address = '';
		if(scan_mac_address){
			init_mac_address = scan_mac_address.replace(/:/g, '').toLowerCase();
		}else{
			init_mac_address = kitem.mac_address;
		}
		let this_guid = macToGuid(init_mac_address,kitem.model);
		try{
			
		}catch(error){

		}
	},()=>{})
}
//render the bottom button ex.air and the dimming bar
let range_silder_list = {};
erp.trigger_thermostat_defined_fun = {};
window.dimmingRecord = {};
const renderBottomButton = (props, {
	$h,
	$onMounted,
	$update
}) => {
	let mode = props.kitem.device_mode;
	let device_button_group = props.kitem.device_button_group
	let key = `dimer_slidebar_${props.kitem.device}`;
	let guid = props.kitem.device || props.kitem.guid;
	//thie function control the Dimming mode bar change 
	const range_change_fun_dimming = (element) => {
			debugger
	    props.kitem.device_status = element.value;
	    let range_value = parseInt((element.value*1.0 / 100.0) * 255.0);
	    
	    if(props.kitem.disableControl){
	        props.kitem.disableControl = null;
	        delete props.kitem.disableControl;
	        return;
	    }
	    
	    
	    try {
			if (device_button_group.startsWith("DIMMING")) {
				peripheral[props.kitem.device].dimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(()=>{

				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			} else if (device_button_group.startsWith("RCU DIMMING")) {
				// debugger
				peripheral[props.kitem.device].rcuDimming([{
					gang: bleHelper.getGangId(props.kitem.device_button_group),
					value: range_value
				}]).then(()=>{

				}).catch(error=>{
					if(error == 7200){
						erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
							
						})
					}else{
						app.dialog.alert(_(erp.get_log_description(error)));
					}
				})
			}
		} catch (error) {
			app.dialog.alert(_(erp.get_log_description(error)));
		}
	}
	const curtain_switch_custom = (kitem,direction)=>{
		//type 0-left 1-right 2-right
		if(peripheral[kitem.device]){
			if (kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
					peripheral[kitem.device].rcuOpenClose(bleHelper.getGangId(kitem.device_button_group), direction, true).then((rs) => {

					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));
					});
				} else {

					peripheral[kitem.device].openClose(bleHelper.getGangId(kitem.device_button_group), direction, true).then((rs) => {


					}).catch((error) => {
						app.dialog.alert(_(erp.get_log_description(error)));

					});
				}
		}
	}
	const range_change_fun_switch_curtain = (element)=>{
		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},10000)
		let parentElemt = $(element.el).parents('.device').prev();
		let thisvalue = element.value;
		const now = DateFormatter.format(new Date(), 'Y-m-d H:i:s');
	}
	const range_change_fun_curtain = (element) => {
		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},30000)
		let otherModelStatus = false;
		if(props.kitem.device_model == 'YO121-AC-R2W') otherModelStatus = true;
		let parentElemt = $(element.el).parents('.device').prev();
		let thisvalue = element.value;
		const now = DateFormatter.format(new Date(), 'Y-m-d H:i:s');
		let reverse = props.kitem.device_button_group.startsWith('OPENCLOSE UART REVERSE') ? true : false;
		if (thisvalue > 0) {
			props.kitem.device_status = thisvalue;
		} else {
			props.kitem.device_status = 0;
		}
		if (reverse) {
			data = `55AA060102${(100-thisvalue).toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${(100-props.kitem.device_status*1).toString(16).pad("00")}`;
			}
		} else {
			data = `55AA060102${thisvalue.toString(16).pad("00")}FF`;
			if(otherModelStatus){
				data = `55fefe0304${props.kitem.device_status.toString(16).pad("00")}`;
			}
		}
		if(otherModelStatus){
			data += erp.script.core_util_calculate_crc16_for_motor(data);
		}else{
			data += core_util_calculate_crc16_modbus_for_doa(data);
		}
		let command = "8602" + data.toLowerCase();
		console.log('command',command)
		window.peripheral[props.kitem.device].curtainmotor([{
			gang: bleHelper.getGangId(props.kitem.device_button_group),
			value: thisvalue,
			command: command
		}]).then(()=>{

		}).catch(error=>{
			if(error == 7200){
				erp.script.iot_entry_class_password_verify(props.kitem.device,props.kitem.name).then(()=>{
					
				})
			}else{
				app.dialog.alert(_(erp.get_log_description(error)));
			}
		})
	}
	const bacnet_light_scene_click_change = (kitem,type)=>{
		let configString = kitem.config;
		if(configString){
			let config = configString.split("|");
			let temp = config[0].split(".");
			let deviceCode = temp[0];
			let tagCode = temp[1];
			let message = [];
			message.push({
					"operate":"write",
					"deviceCode":deviceCode,
					"tagCode":tagCode,
					"val":`${type}`
			});
			message = JSON.stringify(message);
			core_mqtt_publish(config[1], message, 0, false, false, true);
			$update();
		}
	}
	// bacnet change flow
	const click_bacnet_change = (kitem, click_type) => {
		//mode-1 auto mode-2 cool mode-3 dry model-4 fan model-5 heat
		let configStr = props.kitem.config;
		let config = configStr.split('|');
		let airconfig = isset(config[5]) && config[5] != ',,,,NaN'?config[5].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[1]; //thermostat mode
		let speed_vaule = airconfig[2]; //thermostat speed
		// let swing_value = airconfig[3];
		// let direction_value = airconfig[2];
		let temperature = airconfig[3]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		let temp = config[0].split(".");
		let deviceCode = temp[0];
		let tagCode = temp[1];
		temp = tagCode.split("_");
		let roomCode = temp[0];
		let message = [];
		switch (click_type) {
			case "ARC_MODE":
				if (mode_value == 2) {
					mode_value = 4;
				} else if (mode_value == 4) {
					mode_value = 8
				} else if (mode_value == 8) {
					mode_value = 16;
				}else if (mode_value == 16) {
					mode_value = 2;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_MODE_CTRL",
					"val": mode_value + ""
				});
				break;
			case "ARC_SPEED":
				if(speed_vaule == 2){
					speed_vaule = 8;
				}else if(speed_vaule == 4){
					speed_vaule = 2;
				}else if(speed_vaule == 8){
					speed_vaule = 4;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_SPEED_CTRL",
					"val": speed_vaule + ""
				});
				break;
			case "ARC_REDUCE_TEMP":
				if (temperature != 5) {
					temperature--;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_CONTROL_ROOM_TEMP_SETPOINT",
					"val": temperature + ""
				});
				break;
			case "ARC_ADD_TEMP":
				if (temperature != 32) {
					temperature++;
				}
				message.push({
					"operate": "write",
					"deviceCode": deviceCode,
					"tagCode": roomCode + "_CONTROL_ROOM_TEMP_SETPOINT",
					"val": temperature + ""
				});
				break;
		}
		//ir|0|tem,speed,direction,swing,onoff,mode
		config[5] = `1,${mode_value},${speed_vaule},${temperature}`;
		const newConfigStr = config.join("|");
// 		peripheral[kitem.device].prop.config[kitem.name] = newConfigStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, newConfigStr);
		//props.kitem.device_status = 1;
		//props.kitem.device_config = newConfigStr;
		props.kitem.config = newConfigStr;
		message = JSON.stringify(message);
		console.log("message",message);
		core_mqtt_publish(config[1], message, 0, false, false, true);
		try{
			let subdevices = cloneDeep(erp.info.profile.profile_subdevice);
			subdevices.forEach(item=>{
					if(item.name == kitem.name){
							item.config = newConfigStr
					}
			})
			http2.request(encodeURI('/api/resource/Profile/' + erp.info.profile.name), {
				serializer: "json",
				responseType: "json",
				method: "PUT",
				data: {
						profile_subdevice : subdevices 
				}
		})
		}catch(error){
			console.log(error);
		}
		//iot_update_profile_subdevice_config(kitem.name,JSON.stringify({config : newConfigStr}));
		//let command = kitem.device_command['function'];
		//let ref_command = iot_ble_generate_ir_code(command,click_type,`${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`);
		//peripheral[kitem.device].sendIR(ref_command);
		//debugger
		$update();
	}
	const click_ir_diy_change = async(code)=>{
		const TAG = 'iot_ir_test';
    console.log(TAG);
		let bytes_string = code;
		let bytes_array = [];
		let this_data = `3003${bytes_string.substring(2, bytes_string.length)}`;
		let count_string = `${this_data}${addChecksum(iotConvertHexToData(this_data))}`;
		let handle_data = iot_ir_learned_init(this_data);
		let ref = `${handle_data}${count_string.toString(16).pad('00')}`;
		console.log('ref', ref);
		try {
			await window.peripheral[props.kitem.device].sendIR(ref);
			} catch (err) {
				app.dialog.alert(_(erp.get_log_description(err)));
			}
	}
	//this is the thermostat click function
	
	const click_thermostat_change = (kitem, click_type) => {
		let value_list = kitem.device_attachment_status.split(',');
		let mode_value = value_list[1];
		let speed_vaule = value_list[2]; //thermostat speed
		let temperature = parseInt(value_list[3]); //temperature
		let room_temperature = value_list[4];
		let data = "";
		let this_gang = 42;
		let post_value = ``;
		let devices = cloneDeep(erp.info.device);
		let device = devices[guid];
		let mode_seetting = '';
		let speed_setting = '';
		let setpoint_limit_lower_cooling = '';
		let setpoint_limit_upper_cooling = '';
		let setpoint_limit_lower_heat = '';
		let setpoint_limit_upper_heat = '';
		if (isset(device)) {
			let list = device.settings;
			list.forEach(item => {
				if (item.setting_type === 'mode_selection') {
					mode_seetting = item.setting;
				}
				if (item.setting_type === 'fan_speed') {
					speed_setting = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_lower'){
					setpoint_limit_lower_cooling = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_upper'){
					setpoint_limit_upper_cooling = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_lower_heat'){
					setpoint_limit_lower_heat = item.setting;
				}
				if(item.setting_type === 'setpoint_limit_upper_heat'){
					setpoint_limit_upper_heat = item.setting;
				}
			})
		}
		//init the lastClickTime 
		if(!isset(window.lastClickTime[props.kitem.device])){
			window.lastClickTime[props.kitem.device] = 0;
		};
		const currentTime = Date.now();

		props.kitem['click_status'] = true;
		props.kitem['timeout'] = setTimeout(()=>{
			props.kitem['click_status'] = null;
		},10000)
		//props.kitem.device_attachment_status = [0,0,0,26,26,Math.random()].join(',');
		switch (click_type) {
			case "mode":
				this_gang = 43;
				
				if (mode_value == 1) {
					mode_value = 0
					$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
					$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-4.png');
				} else if (mode_value == 2) {
					if (mode_seetting == 'Cooling') {
						mode_value = 0;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-4.png');
					}else {
						mode_value = 1
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-5.png');
					}
				} else if (mode_value == 0) {
					if(mode_seetting == 'Heating'){
						mode_value = 1;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-5.png');
					} else{
						mode_value = 2;
						$('li.device[guid="' + guid + '"] a[command-type="mode"]').attr('ref', mode_value);
						$('li.device[guid="' + guid + '"] a[command-type="mode"] img').attr('src', 'style/img/air_condition/icon-mode-2.png');
					}
				}
				data = "9404000001" + parseInt(mode_value).toString(16).pad("00");
				post_value = mode_value;
				break;
			case "fan":
				this_gang = 44;
				if(speed_setting){
					// Disable ,1 Speed ,2 Speed, 3 Speed
				}
				if (speed_vaule == 4) {
					if (mode_value == 0) {
						//mode fan 
						speed_vaule = 2;
					} else {
						speed_vaule = 1;
					}
				}else if(speed_vaule == 3){
					if(speed_setting == '2 Speed'){
						if (mode_value == 0) {
							//mode fan 
							speed_vaule = 2;
						} else {
							speed_vaule = 1;
						}
					}else{
						speed_vaule++
					}
				}else if(speed_vaule == 2){
					if(speed_setting == '1 Speed'){
						speed_vaule = 1;
					}else{
						speed_vaule++
					}
				} else {
					speed_vaule++
				}
				$('li.device[guid="' + guid + '"] a[command-type="fan"]').attr('ref', speed_vaule);
				$('li.device[guid="' + guid + '"] a[command-type="fan"] img').attr('src', 'style/img/air_condition/icon-speed-' + speed_vaule + '.png');
				data = "9405000001" + parseInt(speed_vaule).toString(16).pad("00");
				post_value = speed_vaule;
				break;
			case "reduce":
				this_gang = 45;
				if(mode_value == 2){
					//cooling
					if(setpoint_limit_lower_cooling){
						if (temperature != setpoint_limit_lower_cooling && temperature > setpoint_limit_lower_cooling) {
							temperature--;
						}
					}else{
						if (temperature != 5 && temperature > 5) {
							temperature--;
						}
					}
				}else if(mode_value == 1){
					//heating
					if(setpoint_limit_lower_heat){
						if (temperature != setpoint_limit_lower_heat && temperature > setpoint_limit_lower_heat) {
							temperature--;
						}
					}else{
						if (temperature != 5 && temperature > 5) {
							temperature--;
						}
					}
				}else if(mode_value == 0){
					if (temperature != 5 && temperature > 5) {
							temperature--;
						}
				}
				$('li.device[guid="' + guid + '"] a[button-signal="5"] span').text(temperature);
				$('li.device[guid="' + guid + '"] a[command-type="add"]').attr('ref', temperature);
				$('li.device[guid="' + guid + '"] a[command-type="reduce"]').attr('ref', temperature);
				data = "9406000001" + parseInt(temperature).toString(16).pad("00");
				post_value = temperature;
				break;
			case "add":
				this_gang = 45;
				if(mode_value == 2){
					//cooling
					if(setpoint_limit_upper_cooling){
						if (temperature != setpoint_limit_upper_cooling && temperature < setpoint_limit_upper_cooling) {
							temperature++;
						}
					}else{
						if (temperature != 32 && temperature < 32) {
							temperature++;
						}
					}
				}else if(mode_value == 1){
					//heating
					if(setpoint_limit_upper_heat){
						if (temperature != setpoint_limit_upper_heat && temperature < setpoint_limit_upper_heat) {
							temperature++;
						}
					}else{
						if (temperature != 32 && temperature < 32) {
							temperature++;
						}
					}
				}else if(mode_value == 0){
					if (temperature != 32 && temperature < 32) {
						temperature++;
					}
				}
				$('li.device[guid="' + guid + '"] a[button-signal="5"] span').text(temperature);
				$('li.device[guid="' + guid + '"] a[command-type="add"]').attr('ref', temperature);
				$('li.device[guid="' + guid + '"] a[command-type="reduce"]').attr('ref', temperature);
				data = "9406000001" + parseInt(temperature).toString(16).pad("00");
				post_value = temperature;
				break;
		}
		props.kitem.device_status = 1;
		window.peripheral[props.kitem.device].prop.status['control'][0][42] = 1;
		props.kitem.device_attachment_status = [1, mode_value, speed_vaule, temperature, room_temperature, 0].join(',');
		console.log(currentTime - window.lastClickTime[props.kitem.device])
		if ((currentTime - window.lastClickTime[props.kitem.device] < window.clickInterval) || window.lastClickTime[props.kitem.device] == 0) {
			console.log("post_value",post_value);
			$update();
			window.lastClickTime[props.kitem.device] = currentTime;
			if (timeoutId) {
				window.peripheral[props.kitem.device].prop.status.control[0][this_gang] = post_value;
				window.peripheral[props.kitem.device].prop.status.control[1] = DateFormatter.format((new Date(new Date().getTime() + 15000)), "Y-m-d H:i:s")+"."+(new Date().getMilliseconds() % 1000).toString().pad("0000");
				clearTimeout(timeoutId);
			}
			timeoutId = setTimeout(() => {
				window.peripheral[props.kitem.device].thermostat([{
					gang: this_gang,
					value: post_value,
					command: data
				}]);
				$update();
			}, window.clickInterval);
			return; // é—´éš”å°äºŽè®¾å®šæ—¶é—´ï¼Œå¿½ç•¥æ­¤ç‚¹å‡»
		}
		console.log("posting")
		window.peripheral[props.kitem.device].thermostat([{
			gang: this_gang,
			value: post_value,
			command: data
		}]);
		$update();
		window.lastClickTime[props.kitem.device] = currentTime;
	}
	const click_ir_change = (kitem, click_type)=>{
// 		let configStr = peripheral[kitem.device].prop.config[kitem.name];
		let configStr = kitem.device_config;
		if(!isset(configStr)){
			app.dialog.alert('error');
			return
		}
		
		let config = configStr.split('|');
		let airconfig = isset(config[2]) && config[2] != ',,,,NaN'?config[2].split(','):'25,1,2,1,0,1'.split(',')
		let mode_value = airconfig[5]>=0 ? airconfig[5] : 1; //thermostat mode
		let speed_vaule = airconfig[1]; //thermostat speed
		let swing_value = airconfig[3];
		let direction_value = airconfig[2];
		let temperature = airconfig[0]; //temperature
		switch (click_type) {
			case "ARC_MODE":
				if (mode_value == 1) {
					mode_value = 0
				} else if (mode_value == 2) {
					mode_value = 1
				} else if (mode_value == 0) {
					mode_value = 2;
				}
				break;
			case "ARC_SPEED":
				if(speed_vaule == 4){
					speed_vaule = 1;
				}else{
					speed_vaule++
				}
				break;
			case "ARC_SWING":
				swing_value = swing_value*1-1;
				if(swing_value < 0){
					swing_value = 1;
				}
				break;
			case "ARC_REDUCE_TEMP":
				if (temperature != 5) {
					temperature--;
				}
				break;
			case "ARC_ADD_TEMP":
				if (temperature != 32) {
					temperature++;
				}
				break;
		}
		//ir|0|tem,speed,direction,swing,onoff,mode
		const newConfigStr = `ir|0|${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`;
// 		peripheral[kitem.device].prop.config[kitem.name] = newConfigStr;
		peripheral[kitem.device].setLocalGangConfig(kitem.name, newConfigStr);
		props.kitem.device_status = 1;
		props.kitem.device_config = newConfigStr;
		props.kitem.config = newConfigStr;
		
		let command = kitem.device_command['function'];
		let ref_command = iot_ble_generate_ir_code(command,click_type,`${temperature},${speed_vaule},${direction_value},${swing_value},1,${mode_value}`);
		peripheral[kitem.device].sendIR(ref_command);
		//debugger
		$update();
	}
	erp.trigger_thermostat_defined_fun[props.kitem.device] = (kitem) => {
		//this function can change the ui
		if (isset(kitem.device_attachment_status)) {
			props.kitem.device_attachment_status = kitem.device_attachment_status;
			$update();
		}
	}
	$onMounted(() => {
		let element = $(`.curtain-subdevice .range-slider[data-id="${key}"]`);
		setTimeout(() => {
			if (props.kitem.device_button_group.startsWith('OPENCLOSE UART')) {
				let range_silder = app.range.create({
					el: `.range-slider[guid="${props.kitem.device}"]`,
					value: props.kitem.device_status || 0,
					min: 0,
					max: 100,
					draggableBar: false,
					label: true,
					step: 1,
					scale: true,
					scaleSteps: 5,
					scaleSubSteps: 4,
					on: {
						changed: range_change_fun_curtain,
					},
				});
			}else if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING')) {
				const v = Math.ceil((props.kitem.device_status*1.0 / 255.0) * 100.0) || 0;
				    let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
						//console.log("range_silder_list[range_key]",range_silder_list[range_key]);
				    if(!isset(range_silder_list[range_key])){
							setTimeout(()=>{
								//console.log($(`.range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`));
									range_silder_list[range_key] = app.range.create({
									el: `.range-slider-home-auto[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`,
									value: v,
									min: 0,
									max: 100,
									draggableBar: false,
									label: true,
									step: 1,
									scale: true,
									scaleSteps: 5,
									scaleSubSteps: 4,
									on: {
										changed: range_change_fun_dimming,
									},
								});
							},500)
				    }
			}else if(props.kitem.device_button_group.startsWith('OPENCLOSE GANG') || props.kitem.device_button_group.startsWith('RCU OPENCLOSE GANG')) {
				let range_key = `${props.kitem.device}_${props.kitem.device_button_group}`;
				    if(!isset(range_silder_list[range_key])){
    				    range_silder_list[range_key] = app.range.create({
    						el: `.range-slider[guid="${props.kitem.device}"][button_group="${props.kitem.device_button_group}"]`,
    						value: 0,
    						min: 0,
    						max: 100,
    						draggableBar: false,
    						label: true,
    						step: 1,
    						scale: true,
    						scaleSteps: 5,
    						scaleSubSteps: 4,
    						on: {
    							changed: range_change_fun_switch_curtain,
    						},
    					});
				    }
			}
		}, 0)
	});
	if (props.kitem.device_button_group.startsWith('RCU DIMMING') || props.kitem.device_button_group.startsWith('DIMMING')) {

		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex dimming-subdevice" style="" guid="${
					props.kitem.guid
				}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" config="${props.kitem.config}" mesh="${props.kitem.network_id>0?1:0}" button_group="${props.kitem.device_button_group}">
						<div class="row padding-tb flex-direction-column justify-content-center ${props.kitem.bluetooth== 0 && props.kitem.mobmob == 0 && !props.kitem.mesh?'disabled':''} ">
								<div class="col-100 medium-100 large-100">
										<div class="content display-flex justify-content-center" style="margin-left: 15px;margin-right:15px;">
												<div class="tip-title"><i class="icon material-icons" style="margin-right:8px;">brightness_low</i></div>
												<div class="range-slider range-slider-home-auto range-slider-init"
														button_group="${props.kitem.device_button_group}"
														guid="${props.kitem.device}"
														subdevice-name="${props.kitem.name}"
												></div>
												<div class="tip-title"><i class="icon material-icons" style="margin-left:8px;">brightness_high</i></div>
										</div>
										<div></div>
								</div>
						</div>
				</li>
				`;
	} else if (device_button_group.startsWith("OPENCLOSE UART")) {
		return () => $h`
				<li class="device home-scanned-peripheral home-scanned-peripheral-smart display-flex curtain-subdevice" direction="standard" style="" guid="${
					props.kitem.device
				}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
						<div class="row padding-tb flex-direction-column justify-content-center ${props.kitem.bluetooth== 0 && props.kitem.mobmob == 0 && !props.kitem.mesh?'disabled':''} ">
								<div class="col-100 medium-100 large-100">
										<div class="content display-flex justify-content-center" style="margin-left: 15px;margin-right:15px;">
												<div class="tip-title"><img src="${
													'https://my.yoswit.com/'
												}/files/app/close-curtain.svg" alt="" style="width:20px;height:20px;margin-right:8px;margin-top:5px;" /></div>
												<div class="range-slider range-slider-home-auto range-slider-init"
														button_group="${props.kitem.device_button_group}"
														guid="${props.kitem.device}"
														subdevice-name="${props.kitem.name}"
												></div>
												<div class="tip-title"><img src="${
													'https://my.yoswit.com/'
												}/files/app/open-curtain.svg" alt="" style="width:20px;height:20px;margin-left:8px;margin-top:5px;" /></div>
										</div>
										<div></div>
								</div>
						</div>
				</li>
			`;
	}else if(device_button_group.startsWith("OPENCLOSE GANG") || device_button_group.startsWith("RCU OPENCLOSE GANG")){
		return () => $h`
      <li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob}" mesh="${props.kitem.network_id>0?1:0}" slot-index="${props.kitem.config}" style="height:auto;">
          <div class="item-content subdevice-item-content" style="min-height: 0px;">
              <div class="item-inner" style="min-height: 0px;">
                  <div class="row" style="--f7-grid-gap:3px;padding-left:20px;padding-right:15px;">
                      <button class="col on_flag off_flag button button-large button-raised openclose cl" ref="0" @click="${()=>curtain_switch_custom(props.kitem,'close')}" command-type="Bluetooth" command="">
                          <div style="margin-left:-5px;"><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_right</i><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_left</i></div>
                      </button>
                      <button class="col on_flag off_flag button button-large button-raised stop" ref="n" @click="${()=>curtain_switch_custom(props.kitem,'stop')}" command-type="Bluetooth" command="">
                          <div><i class="material-icons" style="line-height:65px;font-size:18px!important;">pause</i></div>
                      </button>
                      <button class="col on_flag off_flag button button-large button-raised openclose op" ref="1" @click="${()=>curtain_switch_custom(props.kitem,'open')}" command-type="Bluetooth" command="">
                          <div style="margin-left:-7px;"><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_left</i><i class="material-icons" style="font-size:22px!important;">keyboard_double_arrow_right</i></div>
                      </button>
                  </div>
              </div>
          </div>
      </li>
      `;
	}else if(props.kitem.device_mode == 'Multiway Switch'){
		let configStr = props.kitem.config;
		let is_pairing = false;
		if(configStr){
			let configMap = JSON.parse(configStr);
			
			if(isset(configMap.is_pairing)){
				is_pairing = configMap.is_pairing == 1?true:false;
			}
		}
		if(is_pairing){
			return () => $h`
        <div class="pair-box-connect">
          <i class="icon material-icons" style="margin-left:8px;">link</i>
        </div>
        `;
		}else{
			return () => $h`
        <a></a>
        `;
		}
	}else if (device_button_group.startsWith('Thermostat')) {
		emitter.on(`thermostat_${props.kitem.device}`, (data) => {
			$update();
		})
		if (!isset(props.kitem.device_attachment_status)) {
			props.kitem.device_attachment_status = [0, 0, 0, 26, 26, 0].join(',');
		}else if(props.kitem.device_attachment_status.startsWith('0,0,0,0,0,0')){
			props.kitem.device_attachment_status = [0, 0, 0, 26, 26, 0].join(',');
		}
		let this_list = props.kitem.device_attachment_status.split(',')
		let mode_value = this_list[1]; //thermostat mode
		let speed_vaule = this_list[2]; //thermostat speed
		let temperature = this_list[3] == 0 ? 26 : this_list[3]; //temperature
		let room_temperature = this_list[4]; //room_temperature
		let humidity = this_list[5]; //humidity
		let mode_str = 4;
		let mode_ref = 0;
		if (mode_value == 1) {
			mode_ref = 1;
			mode_str = 5;
		} else if (mode_value == 2) {
			mode_ref = 2;
			mode_str = 2;
		}
		if (speed_vaule == 0) {
			speed_vaule = 1;
		}
		if (!temperature) {
			temperature = 26;
		}
		//render the modeã€fanã€temperature
		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex thermostat-subdevice" style="height:80px;" ref="${props.kitem.device_status}" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.network_id>0?1:0}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center" style="--f7-grid-gap:3px;">
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'mode')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'fan')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'reduce')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>â„ƒ
								</a>
								<a href="#" class="col" @click="${()=>click_thermostat_change(props.kitem,'add')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith('BACNET LIGHTING SCENE')){
		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex thermostat-subdevice" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,2)}" command-type="mode" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 1</div>
								</a>
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,3)}" command-type="fan" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 2</div>
								</a>
								<a href="#" @click="${()=>bacnet_light_scene_click_change(props.kitem,4)}" command-type="reduce" guid="${props.kitem.device}" style="width:33%;">
									<div class="button button-raised button-big stop" style="width:100%">${_('Scene')} 3</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if (device_button_group.startsWith('BACNET AIR CONDITIONER')) {
		let configStr = props.kitem.config;
		let config = configStr.split('|');
		console.log("config[5]",props.kitem)
		let airconfig = isset(config[5]) && config[5] != ',,,,NaN'?config[5].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[1]; //thermostat mode
		let speed_vaule = airconfig[2]; //thermostat speed
		// let swing_value = airconfig[3];
		// let direction_value = airconfig[2];
		let temperature = airconfig[3]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		props.kitem.device_status = airconfig[4];
		if (mode_value == 2) {
			mode_ref = 1;
			mode_str = 2;
		} else if (mode_value == 4) {
			mode_ref = 2;
			mode_str = 3;
		}else if (mode_value == 8) {
			mode_ref = 2;
			mode_str = 1;
		}else if (mode_value == 16) {
			mode_ref = 2;
			mode_str = 4;
		}
		if (speed_vaule == 2) {
			speed_vaule = 4;
		}else if(speed_vaule == 4){
			speed_vaule = 3;
		}else if(speed_vaule == 8){
			speed_vaule = 2;
		}
		if (!temperature) {
			temperature = 26
		}
		//render the modeã€fanã€temperature
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice home-scanned-peripheral-smart" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center" style="--f7-grid-gap:3px;">
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_MODE')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_SPEED')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:70px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_REDUCE_TEMP')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>â„ƒ
								</a>
								<a href="#" class="col" @click="${()=>click_bacnet_change(props.kitem,'ARC_ADD_TEMP')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:70px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(props.kitem.device_button_group_type == 'Air Conditioner'){
		let configStr = props.kitem.device_config;
		let config = configStr.split('|');
		let airconfig = isset(config[2]) && config[2] != ',,,,NaN'?config[2].split(','):'25,1,2,1,0,1'.split(',')
		
		let mode_value = airconfig[5]>=0 ? airconfig[5] : 1; //thermostat mode
		let speed_vaule = airconfig[1]; //thermostat speed
		let swing_value = airconfig[3];
		let direction_value = airconfig[2];
		let temperature = airconfig[0]; //temperature
		let room_temperature = 26; //room_temperature
		let mode_str = 4;
		let mode_ref = 0;
		props.kitem.device_status = airconfig[4];
		if (mode_value == 1) {
			mode_ref = 1;
			mode_str = 5;
		} else if (mode_value == 2) {
			mode_ref = 2;
			mode_str = 2;
		}
		if (speed_vaule == 0) {
			speed_vaule = 1;
		}
		if (!temperature) {
			temperature = 26
		}
		return () => $h`
				<li class="device subdevice home-scanned-peripheral display-flex thermostat-subdevice home-scanned-peripheral-smart" style="height:80px;" ref="${airconfig[4]}" guid="${
					props.kitem.device
				}" config="${props.kitem.config}" device_config="${props.kitem.device_config}" button_group="${props.kitem.device_button_group}" gateway="${props.kitem.gateway}" bluetooth="${props.kitem.bluetooth}" mobmob="${props.kitem.mobmob || 0}" mesh="${props.kitem.mesh || 0}">
					<div class="item-content" style="width:100%;" list="${props.kitem.device_attachment_status}">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_MODE')}" command-type="mode" guid="${props.kitem.device}" ref="${mode_ref}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-mode-${mode_str}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_SPEED')}" command-type="fan" guid="${props.kitem.device}" ref="${speed_vaule}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-speed-${speed_vaule?speed_vaule:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_SWING')}" command-type="ARC_SWING" guid="${props.kitem.device}" ref="${swing_value}">
									<div class="button button-raised button-big stop" style="width:60px"><img style="width:25px;height:25px;" src="style/img/air_condition/icon-swing-${swing_value?swing_value:0}.png" /></div>
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_REDUCE_TEMP')}" command-type="reduce" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:60px;font-size:25px;">-</div>
								</a>
								<a href="#" class="col set-temp" style="line-height:60px;margin-top:8px;text-align:center;" button-signal="5">
									<span>${temperature}</span>â„ƒ
								</a>
								<a href="#" class="col" @click="${()=>click_ir_change(props.kitem,'ARC_ADD_TEMP')}" command-type="add" guid="${props.kitem.device}" ref="${temperature}">
									<div class="button button-raised button-big stop" style="width:60px;font-size:25px;">+</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith('IR-DIY-no_model')){
		//DIY template
		let configStr = props.kitem.config;
		let configMap = JSON.parse(configStr);
		let configList = configMap.list;
		console.log("configStr",configList);
		return () => $h`
				<li class="device subdevice home-scanned-peripheral home-scanned-peripheral-smart display-flex thermostat-subdevice" style="height:80px;" ref="1" guid="${
					props.kitem.device
				}" button_group="${props.kitem.device_button_group}">
					<div class="item-content" style="width:100%;">
						<div class="item-inner">
							<div class="display-flex justify-content-space-between align-content-center align-items-center">
								<a href="#" @click="${()=>click_ir_diy_change(configList[0].code)}" command-type="mode" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[0].text)}</div>
								</a>
								<a href="#" @click="${()=>click_ir_diy_change(configList[1].code)}" command-type="fan" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[1].text)}</div>
								</a>
								<a href="#" @click="${()=>click_ir_diy_change(configList[2].code)}" command-type="reduce" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[2].text)}</div>
								</a>
								<a href="#" @click="${()=>click_ir_diy_change(configList[3].code)}" command-type="reduce" guid="${props.kitem.device}" style="width:24%;">
									<div class="button button-raised button-big stop" style="width:100%">${_(configList[3].text)}</div>
								</a>
							</div>
						</div>
					</div>
				</li>
				`;
	}else if(device_button_group.startsWith("IAQ")){
		return () => $h`
      <li class="device iaq-subdevice home-scanned-peripheral home-scanned-peripheral-smart device-none" gateway="${props.kitem.gateway}" guid="${
        props.kitem.device
      }" mobmob="${props.kitem.mobmob}" bluetooth="${props.kitem.bluetooth}" button_group="${
        device_button_group
      }" style="height:auto;">
        <div class="display-flex justify-content-start align-content-center align-items-center" style="flex-wrap:wrap;height:auto;width:100%;">
          <!-- Temperature -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center">
                    <div class="Temperature display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/Temperature_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">â„ƒ</span> 
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM1.0 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM1 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="PM1 box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM1.0_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">Î¼g/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM2.5 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM2_5 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM2.5_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">Î¼g/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- PM4 -->
            <div class="main-btn" style="width: 20%;">
                <div class="box-btn display-flex justify-content-center align-content-center align-items-center box-left">
                    <div class="PM4 display-flex flex-direction-column justify-content-center align-content-center align-items-center">
                        <div class="box-btn-img display-flex justify-content-center align-content-center align-items-center" style="width: 30px;height:30px;border-radius: 50%;padding:5px;">
                            <img class="" src="${'https://my.yoswit.com/'}/files/app/PM4.0_1.svg" alt="" style="width: 25px;height:25px;"/>
                        </div>
                        <div class="title-btn display-flex justify-content-center align-items-center">
                            <span class="iaq-title-big">--</span>
                            <span class="unit">Î¼g/m3</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-
</script>

<style>
		.device-hidden {
			display: none;
		}
		.battery[battery='5'] i{
			content: 'battery_full';
		}
		.battery[battery='4'] i{
			content: 'battery_6_bar';
		}
		.battery[battery='3'] i{
			content: 'battery_5_bar';
		}
		.battery[battery='2'] i{
			content: 'battery_4_bar';
		}
		.battery[battery='1'] i{
			content: 'battery_2_bar';
		}
		.geomagnetic[ref='1'] .circle{
			background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
			border-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
		}
		.geomagnetic[ref='1'] i::before{
			content: 'directions_car';
			font-size: 20px;
			color: #ffffff;
		}
		.geomagnetic[ref='0'] i::before{
			content: 'logout';
			font-size: 20px;
		}
		.park-lock[ref='1'] .circle{
			background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
			border-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
		}
		.park-lock[ref='1'] i::before{
			content: 'keyboard_capslock';
			font-size: 20px;
			color: #ffffff;
		}
		.park-lock[ref='0'] i::before{
			content: 'power_input';
			font-size: 20px;
		}
		.page-content .button.onoff {
				-webkit-border-radius: 50%;
				-moz-border-radius: 50%;
				border-radius: 50%;
				background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
				color: #ffffff;
				border-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
				width: 65px;
				height: 65px;
				margin-top: 5px;
				margin-bottom: 0px;
				line-height: 65px;
				font-size: 12px;
		}
		.tabbar .tab-link-active,
		.tabbar-labels .tab-link-active {
			background-color: var(--f7-button-fill-bg-color, var(--f7-theme-color));
			color: #fff;
		}
		.page-content .rcu-output[ref='1']{
			background-color: var(--f7-theme-color);
    	color: #fff;
		}
		.page-content .rcu-output[ref='0']{
			background-color: var(--f7-block-strong-bg-color);
    	color: #8e8d93;
    	border-color: #8e8d93;
		}
		.room-box .device .swipeout-actions-right {
			transform: translateX(200%);
		}
		.room-box .device .swipeout-actions-left {
			transform: translateX(-200%);
		}
		.ir-signal-cooker i,.rcu-virtual-button i{
			display: none;
		}
		.room-box .ir-signal-cooker[ref='0'][mode='On Off IR'],
		.room-box .rcu-virtual-button[ref='0'],
		.room-box .ir-signal-cooker[ref='0'][mode='Multiway Switch'] {
			display: inline-block;
		}
		.room-box .ir-signal-cooker[ref='1'] .radio-button-unchecked,
		.room-box .rcu-virtual-button[ref='1'] .radio-button-unchecked
		{
			display: none;
		}
		.room-box .ir-signal-cooker[ref='0'][mode='On Off IR'] .radio-button-unchecked,
		.room-box .rcu-virtual-button[ref='0'] .radio-button-unchecked,
		.room-box .ir-signal-cooker[ref='0'][mode='Multiway Switch'] .radio-button-unchecked {
			display: inline-block;
		}
		.room-box .ir-signal-cooker[ref='1'] .circles,.room-box .rcu-virtual-button[ref='1'] .circles {
			display: inline-block;
			color: #3bb33b !important;
		}
		.control-panel-right[bluetooth='0'][mobmob='0'] .control-panel-right .iaq-button-score-a {
			display: none;
		}
		.control-panel-right[bluetooth='1'] .control-panel-right .iaq-button-score-a,
		.control-panel-right[mobmob='1'] .control-panel-right .iaq-button-score-a {
			display: inline-block;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='0'] .on_flag,
		.control-panel-right[type-box='Dimming'][bluetooth='2'][mobmob='0'] .on_flag {
			display: none;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='1'] a.iot-connect,
		.control-panel-right[type-box='Dimming'][mesh='1'] a.iot-connect,
		.control-panel-right[type-box='Dimming'][mobmob='1'] a.iot-connect{
			display: none !important;
		}
		.device .control-panel-right[type-box='Dimming'][bluetooth='1'] .on_flag,
		.device .control-panel-right[type-box='Dimming'][mobmob='1'] .on_flag,
		.device .control-panel-right[type-box='Dimming'][mesh='1'] .on_flag
		 {
			display: inline-block;
		}
		.control-panel-right[type-box='Dimming'][bluetooth='0'][mobmob='0'][mesh='0'] a.iot-connect {
			display: inline-block;
		}
		.control-panel-right[bluetooth='0'][mobmob='0'] .iaq-button-score-a {
			display: none;
		}
		.thermostat-subdevice[ref="0"]{
			display: none !important;
		}
		.thermostat-subdevice[ref="1"][bluetooth="0"][mobmob='0'][mesh='0']{
			display: none !important;
		}
		/*.thermostat-subdevice[bluetooth="0"][mobmob='0'][mesh='0']*/
		/*{*/
		/*	display: none !important;*/
		/*}*/
		.thermostat-subdevice[bluetooth='1'][ref="1"],
		.thermostat-subdevice[mobmob='1'][ref="1"],
		.thermostat-subdevice[mesh='1'][ref="1"]
		{
			display: flex !important;
		}
		.control-panel-right[bluetooth='1'] .iaq-button-score-a,
		.iaq-button-score-a[mobmob='1'] .iaq-button-score-a {
			display: inline-block;
		}
		.iaq-subdevice[bluetooth='0'][mobmob='0'] {
			display: none !important;
		}
		.iaq-subdevice[bluetooth='1'],
		.iaq-subdevice[mobmob='1'] {
			display: flex !important;
		}
		.device-none {
			display: none !important;
		}
		.device-flex {
			display: flex;
		}
		.dimming-subdevice[bluetooth='0'][mobmob='0'],
		.dimming-subdevice[bluetooth='2'][mobmob='0']
		{
			/* opacity: 0.55 !important;
			pointer-events: none !important; */
			height:0px!important;
			overflow: hidden;
		}
		.curtain-subdevice[bluetooth='0'][mobmob='0'],
		.curtain-subdevice[bluetooth='2'][mobmob='0']
		{
			/* opacity: 0.55 !important;
			pointer-events: none !important; */
			height:0px!important;
			overflow: hidden;
		}
		.device.curtain-subdevice[bluetooth='1'],
		.device.curtain-subdevice[mobmob='1'],
		.device.curtain-subdevice[mesh='1'],
		.device.dimming-subdevice[bluetooth='1'],
		.device.dimming-subdevice[mesh='1'],
		.device.dimming-subdevice[mobmob='1'] {
			height:67px!important;
			display: flex;
		}
		.box-btn {
			margin-bottom: 7.5px;
			margin-top: 7.5px;
		}
		.box-left {
			border-left: 1px solid var(--f7-list-item-border-color);
		}
		.unit {
			font-size: 11px;
		}
		.title-btn {
			width: 100%;
			margin-left: 5px;
		}
		.iaq-title-big {
			font-size: 12px;
		}
		.main-btn .box-btn-img {
			background-color: #3bb33b;
		}
		.device[bluetooth='1'] .iot-connect {
			display: none !important;
		}
		.device[mobmob='1'] .iot-connect {
			display: none !important;
		}
		.device[mesh='1'] .iot-connect {
			display: none !important;
		}
		.device[bluetooth='0'][mobmob='0'][mesh='0'] .iot-connect {
			display: block !important;
		}
		.subdevice[bluetooth='0'][mobmob='0'][mesh="0"] {
			display: none;
		}
		.subdevice[bluetooth='1'],
		.subdevice[mobmob='1'] {
			display: block;
		}
		.home-signal-thermostat {
			display: none;
		}
		.arrow-downward-button[ref='1'] .button,
		.arrow-upward-button[ref='1'] .button {
			background-color: var(--f7-theme-color);
			color: #ffffff;
			border-color: var(--f7-theme-color);
		}
		@keyframes refresh {
			0% {
				opacity: 0;
			}
			50% {
				opacity: 1;
			}
			100% {
				opacity: 0;
			}
		}
		li.device .item-content .control-panel-right i.button-icons,
		li.device .item-content .control-panel-right i {
			line-height: 25px !important;
		}
		.tabbar .tab-link-highlight {
			bottom: 0;
			display: none;
		}
		.pair-box-connect {
			position: absolute;
			margin-top: -95px;
			margin-left: 35px;
			transform: rotate(90deg);
			color: var(--f7-theme-color);
		}
		.circle-password {
					width: 70px;
					height: 70px;
					border-radius: 50%;
					background-color: var(--f7-theme-color); /* è®¾ç½®åœ†åœˆé¢œè‰²ä¸ºè“è‰² */
					display: flex;
					justify-content: center;
					align-items: center;
					color: white;
					font-size: 24px;
					font-weight: bold;
					margin: 10px;
			}
		.device-mobile-as-hub{
			width: 30px;
			height : 30px;
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
			background-size: 100% auto;
			background-position: left top;
		}
		.moblie-as-hub-icon{
			position: relative;
			width: 100px;
			height : 100px;
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
			background-size: 100% auto;
			background-position: left top;
			display: flex;
      justify-content: center;
      align-items: center;
		}
		.page-content *[mobmob='1'][mobilehub='1'] .mobmob{
			background-image: url('https://my.yoswit.com/files/gateway_new.png');
		}
    .signal-wave {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 0, 0, 0.5);
				will-change: transform, opacity; 
        animation: expand 2s infinite;
				transform: scale(1);
    }

    .signal-wave:nth-child(1) {
        animation-delay: 0s;
				background: rgba(255, 165, 0, 0.5);
    }

    .signal-wave:nth-child(2) {
        animation-delay: 0.5s;
				background: rgba(255, 255, 0, 0.5)
    }

    .signal-wave:nth-child(3) {
        animation-delay: 1s;
				background: rgba(0, 128, 0, 0.5)
    }

    .signal-wave:nth-child(4) {
        animation-delay: 1.5s;
				background: rgba(0, 0, 255, 0.5)
    }

    @keyframes expand {
        0% {
					transform: scale(1);
          opacity: 0.5;
        }
        100% {
					transform: scale(20);
          opacity: 0;
        }
    }
		.show-item{
			width: 49%;
			background: #fff;
			border-radius: 15px;
			overflow: hidden;
			min-height: 150px;
			margin-bottom: 15px;
		}
</style>
