<template>
  <div class="page">
    <div class="navbar active">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44 back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">{{ _('Plugin Template') }}</div>
        <div class="right">
          <a href="#" class="button button-fill text-color-theme bg-color-white button-44" func="init_eruda">
            <i class="icon material-icons">bug_report</i>
          </a>
        </div>
      </div>
    </div>

    <div class="page-content">
      <div id="vue-app" v-cloak></div>
    </div>
  </div>
</template>

<script>
  export default async (props, ctx) => {
    const $f7 = ctx.$f7,
      $f7route = ctx.$f7route,
      $ref = ctx.$ref,
      $update = ctx.$update,
      $on = ctx.$on,
      $onBeforeMount = ctx.$onBeforeMount,
      $onMounted = ctx.$onMounted,
      $onBeforeUpdate = ctx.$onBeforeUpdate,
      $onUpdated = ctx.$onUpdated,
      $onBeforeUnmount = ctx.$onBeforeUnmount,
      $onUnmounted = ctx.$onUnmounted;

    // ---------------------------------------------------------------------------------
    // ----------------------------- 插件测试代码编写 -------------------------------------
    // ---------------------------------------------------------------------------------

    /**
     * 配置对象，key为方法名，value为方法配置，符合 Capacitor Plugins设计的配置
     * 例 https://capacitorjs.com/docs/apis/camera
     *
     * 如果不需要填写请清空，例如空对象{}，避免大老板扣问号
     */
    const defaultJSONConfig = {
      print: {
        ticket_name: '#Test',
        valid_from: dayjs().format('YYYY-MM-DD HH:mm:ss'),
        valid_to: dayjs().add(1, 'hour').format('YYYY-MM-DD HH:mm:ss'),
        qr_code: 'https://www.google.com',
        ticket_type: 'Booking Fee',
        g_printer_title_x : 20,
        g_printer_title_y : 50,
        g_printer_qr_code_x : 20,
        g_printer_qr_code_y : 90,
        g_printer_name_x : 130,
        g_printer_name_y : 290,
        g_printer_from_time_x : 90,
        g_printer_from_time_y : 290,
        g_printer_to_time_x : 50,
        g_printer_to_time_y : 290
      }
    };

    /**
     * 插件方法测试配置，每个Action拥有三个参数，
     * method: 方法名，会对应获取配置
     * description: 方法描述
     * onClick: 方法执行函数
     */
    const pluginActions = [
      {
        method: 'print',
        description: 'Prompt the user to pick a photo from an album, or take a new photo with the camera.',
        /**
         * @param config: 配置对象
         * @param allConfig: 所有配置对象
         * @param applyCfg: 用于合并配置对象的函数
         */
        onClick: async (config, allConfig, applyCfg) => {
          console.log(config);
          debugger
          //这里可以再次对对象进行二次加工
          let configMap = {
            name: config.ticket_name,
            ticket_name: config.ticket_name,
            valid_from: config.valid_from,
            valid_to: config.valid_to,
            qr_code: config.qr_code,
            ticket_type: config.ticket_type,
            opt : {
              g_printer_title_x: config['g_printer_title_x'],
                g_printer_title_y: config['g_printer_title_y'],
                g_printer_qr_code_x: config['g_printer_qr_code_x'],
                g_printer_qr_code_y: config['g_printer_qr_code_y'],
                g_printer_name_x: config['g_printer_name_x'],
                g_printer_name_y: config['g_printer_name_y'],
                g_printer_from_time_x: config['g_printer_from_time_x'],
                g_printer_from_time_y: config['g_printer_from_time_y'],
                g_printer_to_time_x: config['g_printer_to_time_x'],
                g_printer_to_time_y: config['g_printer_to_time_y'],
            }
          }
          const ret = await Capacitor.Plugins.YoswitGPrinter.printUseGPinter(configMap);
          console.log(ret);
          applyCfg('print', ret);
        },
      }
    ];

    /**
     * 页面初始化时调用，插件如需初始化可在这里执行
     */
    async function init() {
      // TODO
    }

    /**
     * 页面销毁时调用，插件如需销毁可在这里执行
     */
    async function deinit() {
      // TODO
    }

    // ---------------------------------------------------------------------------------
    // ------------------- 以下UI模版无需更改，如有更新则直接覆盖以下代码即可 -------------------
    // ---------------------------------------------------------------------------------

    let globalVueApp = null;
    const formSetting = {
      web_form_fields: [
        {
          'fieldname': 'section_1',
          'fieldtype': 'Column Break',
          'label': 'Configuration',
          'reqd': 0,
          'read_only': 0,
          'show_in_filter': 0,
          'hidden': 0,
          'options': '',
          'max_length': 0,
          'max_value': 0,
          'precision': '',
          'default': '',
        },
        {
          'fieldname': 'config',
          'fieldtype': 'HTML',
          'label': 'Configuration',
          'allow_read_on_all_link_options': 0,
          'reqd': 0,
          'read_only': 0,
          'show_in_filter': 0,
          'hidden': 0,
          'options': '',
          'max_length': 0,
          'max_value': 0,
          'precision': '',
          'default': JSON.stringify(defaultJSONConfig, null, 2),
        },
        {
          'fieldname': 'section_2',
          'fieldtype': 'Column Break',
          'label': 'Actions',
          'reqd': 0,
          'read_only': 0,
          'show_in_filter': 0,
          'hidden': 0,
          'options': '',
          'max_length': 0,
          'max_value': 0,
          'precision': '',
          'default': '',
        },
        {
          'fieldname': 'action',
          'fieldtype': 'HTML',
          'label': 'Actions',
          'allow_read_on_all_link_options': 0,
          'reqd': 0,
          'read_only': 0,
          'show_in_filter': 0,
          'hidden': 0,
          'options': '',
          'max_length': 0,
          'max_value': 0,
          'precision': '',
          'default': '',
        },
      ],
      button_label: 'Test',
    };

    ctx.$on('pageMounted', async (e, page) => {
      globalVueApp = erp.script.core_app_basic_form_render(
        {
          web_form: formSetting,
        },
        page.el.querySelector('#vue-app'),
        {},
        {
          'web_form.after_load': function () {
            this.web_form.set_show_next_button(false);
          },
          'web_form.submit': function () {
            /* Submit logic */
          },
          '$ui.config.$vnode': {
            template: `
            <div class="position-relative" style="width: 100%">
              <!-- Segmented View Switch -->
              <div class="segmented segmented-strong" style="margin-bottom: 16px">
                <button class="button" :class="{ 'button-active': viewMode === 'form' }" @click="viewMode = 'form'" :title="_('Form View')">
                  <i class="icon f7-icons">square_list</i>
                </button>
                <button class="button" :class="{ 'button-active': viewMode === 'json' }" @click="viewMode = 'json'" :title="_('JSON View')">
                  <i class="icon f7-icons">doc_text</i>
                </button>
              </div>

              <!-- Form View -->
              <div v-if="viewMode === 'form'">
                <!-- Configuration Overview Card -->
                <div class="card" style="margin:0;">
                  <div class="card-header" style="display: flex; justify-content: space-between; align-items: center">
                    {{ _('Configuration Overview') }}
                    <div style="margin-left: auto; display: flex; gap: 8px; align-items: center">
                      <button class="button button-small button-fill" @click="showAddMethodDialog" :title="_('Add Method')">
                        <i class="icon f7-icons" style="font-size: 14px">plus</i>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Table View -->
                  <div class="card-content card-content-padding" v-if="previewMode === 'table'">
                    <!-- Empty State -->
                    <div v-if="methods.length === 0" class="text-align-center" style="padding: 40px 0">
                      <p class="text-color-gray">{{ _('No methods yet, click + to add') }}</p>
                    </div>
                    
                    <!-- Methods List -->
                    <div v-for="(method, index) in methods" :key="method" :style="{ marginBottom: index < methods.length - 1 ? '32px' : '0' }">
                      <!-- Method Header -->
                      <div class="display-flex justify-content-space-between align-items-center" style="margin-bottom: 12px">
                        <div class="block-title" style="margin: 0; display: flex; align-items: center; gap: 8px">
                          <!-- Editable Method Name -->
                          <input 
                            v-if="isMethodEdit(method) && editingMethodName === method"
                            type="text"
                            :value="editingMethodValue"
                            @input="editingMethodValue = $event.target.value"
                            @blur="finishEditMethodName(method)"
                            @keyup.enter="finishEditMethodName(method)"
                            style="padding: 4px 8px; border: 1px solid #007aff; border-radius: 4px; font-size: 15px; font-weight: 600"
                          />
                          <span v-else @click="handleMethodNameClick(method)" :style="{ cursor: isMethodEdit(method) ? 'pointer' : 'default' }">
                            {{ method }}
                          </span>
                          <span class="badge color-blue">
                            {{ Object.keys(configData[method] || {}).length }}
                          </span>
                        </div>
                        <div class="display-flex" style="gap: 6px">
                          <button class="button button-small button-fill" :class="isMethodEdit(method) ? 'color-blue' : 'color-gray'" @click="toggleMethodEdit(method)" :title="isMethodEdit(method) ? _('View Mode') : _('Edit Mode')">
                            <i class="icon f7-icons" style="font-size: 14px" v-if="isMethodEdit(method)">eye</i>
                            <i class="icon f7-icons" style="font-size: 14px" v-else>pencil</i>
                          </button>
                          <button class="button button-small button-fill" @click="showAddFieldDialog(method)" :title="_('Add Field')">
                            <i class="icon f7-icons" style="font-size: 12px">plus</i>
                          </button>
                          <button class="button button-small button-fill color-red" @click="deleteMethod(method)" :title="_('Delete Method')">
                            <i class="icon f7-icons" style="font-size: 12px">trash</i>
                          </button>
                        </div>
                      </div>
                      
                      <!-- Fields Table -->
                      <table class="config-list-table" v-if="Object.keys(configData[method] || {}).length > 0">
                        <thead>
                          <tr>
                            <th style="width: 30%">{{ _('Field Name') }}</th>
                            <th style="width: 55%">{{ _('Value') }}</th>
                            <th v-if="isMethodEdit(method)" style="width: 15%; text-align: center">{{ _('Actions') }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="(fieldValue, fieldKey) in configData[method]" :key="fieldKey">
                            <!-- Field Name Column -->
                            <td class="field-name-cell">
                              <!-- Edit Mode: Editable Field Name -->
                              <input 
                                v-if="isMethodEdit(method) && isEditingField(method, fieldKey)"
                                type="text"
                                :value="editingFieldName"
                                @input="editingFieldName = $event.target.value"
                                @blur="finishEditFieldName(method, fieldKey)"
                                @keyup.enter="finishEditFieldName(method, fieldKey)"
                                style="width: 100%; padding: 4px 6px; border: 1px solid #007aff; border-radius: 4px; font-weight: 600"
                              />
                              <!-- View/Edit Mode: Display Field Name -->
                              <strong 
                                v-else
                                @click="handleFieldNameClick(method, fieldKey)" 
                                :style="{ cursor: isMethodEdit(method) ? 'pointer' : 'default', color: '#007aff' }"
                                :title="fieldKey"
                              >
                                {{ fieldKey }}
                              </strong>
                            </td>
                            
                            <!-- Value Column -->
                            <td class="field-value-cell">
                              <!-- Edit Mode -->
                              <div v-if="isMethodEdit(method)">
                                <!-- Boolean -->
                                <label v-if="typeof fieldValue === 'boolean'" class="toggle toggle-init" style="display: inline-block">
                                  <input 
                                    type="checkbox" 
                                    :checked="configData[method][fieldKey]"
                                    @change="updateFieldDirect(method, fieldKey, $event.target.checked)"
                                  />
                                  <span class="toggle-icon"></span>
                                </label>
                                
                                <!-- Number -->
                                <input 
                                  v-else-if="typeof fieldValue === 'number'"
                                  type="number"
                                  :value="configData[method][fieldKey]"
                                  @input="updateFieldDirect(method, fieldKey, Number($event.target.value))"
                                  :placeholder="_('Enter number')"
                                  class="table-input"
                                />
                                
                                <!-- String -->
                                <input 
                                  v-else-if="typeof fieldValue === 'string'"
                                  type="text"
                                  :value="configData[method][fieldKey]"
                                  @input="updateFieldDirect(method, fieldKey, $event.target.value)"
                                  :placeholder="_('Enter text')"
                                  class="table-input"
                                />
                                
                                <!-- Complex types -->
                                <textarea 
                                  v-else
                                  :value="JSON.stringify(configData[method][fieldKey], null, 2)"
                                  @input="updateFieldJSON(method, fieldKey, $event.target.value)"
                                  placeholder="JSON"
                                  class="table-textarea"
                                ></textarea>
                              </div>
                              
                              <!-- View Mode -->
                              <div v-else>
                                <!-- Boolean -->
                                <span v-if="typeof fieldValue === 'boolean'" class="badge" :class="fieldValue ? 'color-green' : 'color-gray'">
                                  {{ fieldValue ? 'true' : 'false' }}
                                </span>
                                
                                <!-- Number -->
                                <span v-else-if="typeof fieldValue === 'number'" class="value-text">
                                  {{ fieldValue }}
                                </span>
                                
                                <!-- String -->
                                <span v-else-if="typeof fieldValue === 'string'" class="value-text" :title="fieldValue">
                                  {{ truncateText(fieldValue, 50) }}
                                </span>
                                
                                <!-- Complex types -->
                                <code v-else class="value-code" :title="JSON.stringify(fieldValue)">
                                  {{ truncateText(JSON.stringify(fieldValue), 50) }}
                                </code>
                              </div>
                            </td>
                            
                            <!-- Actions Column (Edit Mode Only) -->
                            <td v-if="isMethodEdit(method)" style="text-align: center">
                              <button class="button button-small button-fill color-red" @click="deleteFieldDirect(method, fieldKey)" :title="_('Delete')">
                                <i class="icon f7-icons" style="font-size: 14px">trash</i>
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                      <div v-else class="text-align-center" style="padding: 20px; background: #f7f7f8; border-radius: 8px">
                        <p class="text-color-gray" style="margin: 0">{{ _('No fields yet') }}</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- JSON Preview -->
                  <div class="card-content" v-else>
                    <pre class="code-block">{{ formattedJSON }}</pre>
                    <div style="text-align: center; margin-top: 12px">
                      <a href="#" class="link" @click.prevent="copyJSON">
                        <i class="icon f7-icons">doc_on_doc</i>
                        {{ _('Copy JSON') }}
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Quick Actions -->
                <div class="block" style="margin-top:10px;">
                  <div class="display-flex" style="gap: 8px">
                    <button class="button button-fill color-orange" @click="resetConfig" :title="_('Reset to Default')">
                      <i class="icon f7-icons">arrow_counterclockwise</i>
                    </button>
                    <button class="button button-fill color-green" @click="save" :title="_('Save')">
                      <i class="icon f7-icons">floppy_disk</i>
                    </button>
                    <button class="button button-fill color-blue" @click="load" :title="_('Load')">
                      <i class="icon f7-icons">folder</i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- JSON View -->
              <div v-else>
                <div class="card">
                  <div class="card-header">
                    {{ _('JSON Editor') }}
                    <span v-if="invalid" class="badge color-red" style="margin-left: 8px">{{ _('Invalid Format') }}</span>
                    <span v-else class="badge color-green" style="margin-left: 8px">{{ _('Valid Format') }}</span>
                  </div>
                  <div class="card-content card-content-padding">
                    <textarea
                      class="resizable"
                :value="value"
                      :style="{ 
                        border: invalid ? 'solid 1px var(--f7-color-red)' : 'solid 1px var(--f7-input-outline-color)',
                        borderRadius: '8px',
                        padding: '12px',
                        fontFamily: 'monospace',
                        fontSize: '13px',
                        width: '100%',
                        minHeight: '60vh'
                      }"
                @input="$emit('input', $event.target.value)"
                      :placeholder="_('Enter JSON configuration...')"
              ></textarea>
                  </div>
                </div>
                
                <div class="block">
                  <div class="display-flex" style="gap: 8px">
                    <button class="button button-fill" @click="format" :title="_('Format')">
                      <i class="icon f7-icons">wand_stars</i>
                    </button>
                    <button class="button button-fill color-green" @click="save" :title="_('Save')">
                      <i class="icon f7-icons">floppy_disk</i>
                    </button>
                    <button class="button button-fill color-blue" @click="load" :title="_('Load')">
                      <i class="icon f7-icons">folder</i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            `,
            props: ['value', 'reqd'],
            data() {
              return {
                invalid: false,
                viewMode: 'form',
                previewMode: 'table', // 'table' or 'json'
                editingMethods: {}, // 每个方法的编辑模式状态
                methods: [],
                configData: {},
                addFieldTargetMethod: '',
                newFieldName: '',
                newFieldType: 'string',
                // 方法名编辑
                editingMethodName: '',
                editingMethodValue: '',
                // 字段名编辑
                editingFieldKey: '',
                editingFieldName: '',
              };
            },
            computed: {
              formattedJSON() {
                return JSON.stringify(this.configData, null, 2);
              }
            },
            watch: {
              value: {
                immediate: true,
                handler(v) {
                try {
                    const parsed = v ? JSON.parse(v) : {};
                    this.configData = parsed;
                    this.methods = Object.keys(this.configData);
                  this.invalid = false;
                    
                    if (this.selectedMethod && this.configData[this.selectedMethod]) {
                      this.currentConfig = this.configData[this.selectedMethod];
                    }
                } catch (err) {
                  this.invalid = true;
                    this.configData = {};
                    this.methods = [];
                  }
                }
              },
              configData: {
                deep: true,
                handler(newData) {
                  this.$emit('input', JSON.stringify(newData, null, 2));
                }
              }
            },
            methods: {
              // 截断长文本
              truncateText(text, maxLength) {
                if (!text) return '';
                const str = String(text);
                if (str.length <= maxLength) return str;
                return str.substring(0, maxLength) + '...';
              },
              
              // 判断某方法是否处于编辑模式
              isMethodEdit(method) {
                return !!this.editingMethods[method];
              },

              // 切换某方法的编辑模式
              toggleMethodEdit(method) {
                const current = !!this.editingMethods[method];
                this.$set(this.editingMethods, method, !current);
                // 退出方法编辑时，清理正在编辑的名称状态，避免错位
                if (!this.editingMethods[method]) {
                  if (this.editingMethodName === method) {
                    this.editingMethodName = '';
                    this.editingMethodValue = '';
                  }
                  if (this.editingFieldKey && this.editingFieldKey.startsWith(method + '_')) {
                    this.editingFieldKey = '';
                    this.editingFieldName = '';
                  }
                }
              },

              // 检查是否正在编辑该字段
              isEditingField(method, fieldKey) {
                return this.editingFieldKey === method + '_' + fieldKey;
              },
              
              // 处理方法名点击
              handleMethodNameClick(method) {
                if (this.isMethodEdit(method)) {
                  this.startEditMethodName(method);
                }
              },
              
              // 处理字段名点击
              handleFieldNameClick(method, fieldKey) {
                if (this.isMethodEdit(method)) {
                  this.startEditFieldName(method, fieldKey);
                }
              },
              
              // 开始编辑方法名
              startEditMethodName(methodName) {
                this.editingMethodName = methodName;
                this.editingMethodValue = methodName;
                this.$nextTick(() => {
                  const input = this.$el.querySelector('.block-title input');
                  if (input) input.focus();
                });
              },
              
              // 完成编辑方法名
              finishEditMethodName(oldMethodName) {
                const newMethodName = this.editingMethodValue.trim();
                if (!newMethodName) {
                  app.toast.create({ text: _('Method name cannot be empty'), closeTimeout: 2000 }).open();
                  this.editingMethodName = '';
                  return;
                }
                
                if (newMethodName !== oldMethodName) {
                  if (this.configData[newMethodName]) {
                    app.toast.create({ text: _('Method already exists'), closeTimeout: 2000 }).open();
                    this.editingMethodName = '';
                    return;
                  }
                  
                  // 重命名方法
                  const methodData = this.configData[oldMethodName];
                  this.$set(this.configData, newMethodName, methodData);
                  this.$delete(this.configData, oldMethodName);
                  this.methods = Object.keys(this.configData);
                }
                
                this.editingMethodName = '';
                this.editingMethodValue = '';
              },
              
              // 开始编辑字段名
              startEditFieldName(methodName, fieldKey) {
                this.editingFieldKey = methodName + '_' + fieldKey;
                this.editingFieldName = fieldKey;
                this.$nextTick(() => {
                  const input = this.$el.querySelector('.field-name-cell input');
                  if (input) input.focus();
                });
              },
              
              // 完成编辑字段名
              finishEditFieldName(methodName, oldFieldKey) {
                const newFieldKey = this.editingFieldName.trim();
                if (!newFieldKey) {
                  app.toast.create({ text: _('Field name cannot be empty'), closeTimeout: 2000 }).open();
                  this.editingFieldKey = '';
                  return;
                }
                
                if (newFieldKey !== oldFieldKey) {
                  if (this.configData[methodName].hasOwnProperty(newFieldKey)) {
                    app.toast.create({ text: _('Field already exists'), closeTimeout: 2000 }).open();
                    this.editingFieldKey = '';
                    return;
                  }
                  
                  // 重命名字段
                  const fieldValue = this.configData[methodName][oldFieldKey];
                  this.$set(this.configData[methodName], newFieldKey, fieldValue);
                  this.$delete(this.configData[methodName], oldFieldKey);
                }
                
                this.editingFieldKey = '';
                this.editingFieldName = '';
              }, 
              
              getFieldType(value) {
                if (Array.isArray(value)) return _('Array');
                if (value === null) return _('Null');
                const type = typeof value;
                const typeMap = {
                  'string': _('String'),
                  'number': _('Number'),
                  'boolean': _('Boolean'),
                  'object': _('Object')
                };
                return typeMap[type] || type;
              },
              
              showAddMethodDialog() {
                const self = this;
                app.dialog.prompt(_('Please enter method name'), _('Add New Method'), function(methodName) {
                  if (!methodName || !methodName.trim()) {
                    app.toast.create({ text: _('Method name cannot be empty'), closeTimeout: 2000 }).open();
                    return;
                  }
                  
                  if (self.configData[methodName]) {
                    app.toast.create({ text: _('Method already exists'), closeTimeout: 2000 }).open();
                    return;
                  }
                  
                  self.$set(self.configData, methodName, {});
                  self.methods = Object.keys(self.configData);
                  
                  app.toast.create({ text: _('Method added successfully'), closeTimeout: 2000 }).open();
                });
              },
              
              deleteMethod(methodName) {
                const self = this;
                app.dialog.confirm(
                  _('Are you sure to delete method "' + methodName + '"?'),
                  _('Delete Confirmation'),
                  function() {
                    self.$delete(self.configData, methodName);
                    self.methods = Object.keys(self.configData);
                    
                    app.toast.create({ text: _('Method deleted'), closeTimeout: 2000 }).open();
                  }
                );
              },
              
              showAddFieldDialog(methodName) {
                const self = this;
                self.addFieldTargetMethod = methodName;
                
                app.dialog.create({
                  title: _('Add Field to') + ' ' + methodName,
                  content: '<div class="list no-hairlines"><ul>' +
                    '<li class="item-content item-input"><div class="item-inner"><div class="item-title item-label">' + _('Field Name') + '</div><div class="item-input-wrap"><input type="text" id="field-name-input" placeholder="' + _('e.g: quality') + '"></div></div></li>' +
                    '<li class="item-content item-input"><div class="item-inner"><div class="item-title item-label">' + _('Type') + '</div><div class="item-input-wrap"><select id="field-type-select">' +
                    '<option value="string">' + _('String') + '</option>' +
                    '<option value="number">' + _('Number') + '</option>' +
                    '<option value="boolean">' + _('Boolean') + '</option>' +
                    '<option value="array">' + _('Array') + '</option>' +
                    '<option value="object">' + _('Object') + '</option>' +
                    '</select></div></div></li>' +
                    '</ul></div>',
                  buttons: [
                    { text: _('Cancel') },
                    { 
                      text: _('Add'),
                      bold: true,
                      onClick: function() {
                        const fieldName = document.getElementById('field-name-input').value;
                        const fieldType = document.getElementById('field-type-select').value;
                        
                        if (!fieldName || !fieldName.trim()) {
                          app.toast.create({ text: _('Please enter field name'), closeTimeout: 2000 }).open();
                          return false;
                        }
                        
                        if (self.configData[self.addFieldTargetMethod].hasOwnProperty(fieldName)) {
                          app.toast.create({ text: _('Field already exists'), closeTimeout: 2000 }).open();
                          return false;
                        }

                        let defaultValue;
                        switch (fieldType) {
                          case 'string': defaultValue = ''; break;
                          case 'number': defaultValue = 0; break;
                          case 'boolean': defaultValue = false; break;
                          case 'array': defaultValue = []; break;
                          case 'object': defaultValue = {}; break;
                          default: defaultValue = '';
                        }

                        self.updateFieldDirect(self.addFieldTargetMethod, fieldName, defaultValue);
                        app.toast.create({ text: _('Field added successfully'), closeTimeout: 2000 }).open();
                      }
                    }
                  ]
                }).open();
              },
              
              updateFieldDirect(methodName, fieldKey, value) {
                if (!this.configData[methodName]) {
                  this.$set(this.configData, methodName, {});
                }
                this.$set(this.configData[methodName], fieldKey, value);
              },
              
              updateFieldJSON(methodName, fieldKey, jsonString) {
                try {
                  const value = JSON.parse(jsonString);
                  this.updateFieldDirect(methodName, fieldKey, value);
                } catch (err) {
                  // 用户可能正在输入
                }
              },
              
              deleteFieldDirect(methodName, fieldKey) {
                const self = this;
                app.dialog.confirm(
                  _('Are you sure to delete field "' + fieldKey + '"?'),
                  _('Delete Confirmation'),
                  function() {
                    self.$delete(self.configData[methodName], fieldKey);
                    app.toast.create({ text: _('Field deleted'), closeTimeout: 2000 }).open();
                  }
                );
              },
              
              resetConfig() {
                const self = this;
                app.dialog.confirm(
                  _('Are you sure to reset all configurations to default?'),
                  _('Reset Confirmation'),
                  function() {
                    self.configData = JSON.parse(JSON.stringify(defaultJSONConfig));
                    self.methods = Object.keys(self.configData);
                    app.toast.create({ text: _('Reset to default configuration'), closeTimeout: 2000 }).open();
                  }
                );
              },
              
              format() {
                try {
                  const json = JSON.parse(this.value);
                  this.$emit('input', JSON.stringify(json, null, 2));
                  app.toast.create({ text: _('Formatted successfully'), closeTimeout: 2000 }).open();
                } catch (err) {
                  app.toast.create({ text: _('Format failed: ') + err.message, closeTimeout: 2000 }).open();
                }
              },
              
              async save() {
                try {
                  console.log('save', this.value);
                  await db.set($f7route.path, this.value);
                  app.toast.create({ text: _('Saved successfully'), closeTimeout: 2000 }).open();
                } catch (err) {
                  app.toast.create({ text: _('Save failed: ') + err.message, closeTimeout: 2000 }).open();
                }
              },
              
              async load() {
                try {
                  const json = await db.get($f7route.path);
                  if (json) {
                  this.$emit('input', json);
                    app.toast.create({ text: _('Loaded successfully'), closeTimeout: 2000 }).open();
                  } else {
                    app.toast.create({ text: _('No saved configuration'), closeTimeout: 2000 }).open();
                  }
                } catch (err) {
                  app.toast.create({ text: _('Load failed: ') + err.message, closeTimeout: 2000 }).open();
                }
              },
              
              copyJSON() {
                try {
                  if (navigator.clipboard) {
                    navigator.clipboard.writeText(this.formattedJSON);
                    app.toast.create({ text: _('Copied to clipboard'), closeTimeout: 2000 }).open();
                  } else {
                    app.toast.create({ text: _('Browser does not support copy'), closeTimeout: 2000 }).open();
                  }
                } catch (err) {
                  app.toast.create({ text: _('Copy failed'), closeTimeout: 2000 }).open();
                }
              }
            },
            mounted() {
              // 初始化时如果没有配置，提示用户
              if (Object.keys(this.configData).length === 0 && this.viewMode === 'form') {
                setTimeout(() => {
                  app.toast.create({ 
                    text: _('Configuration is empty, please click "Add Method" to start'), 
                    closeTimeout: 3000 
                  }).open();
                }, 500);
              }
              
              // 初始化Smart Select
              this.$nextTick(() => {
                const smartSelects = this.$el.querySelectorAll('.smart-select-init');
                smartSelects.forEach(el => {
                  if (!el.f7SmartSelect) {
                    app.smartSelect.create({
                      el: el,
                      openIn: 'popup',
                      closeOnSelect: true
                    });
                  }
                });
              });
            },
            updated() {
              // 更新时重新初始化Smart Select
              this.$nextTick(() => {
                const smartSelects = this.$el.querySelectorAll('.smart-select-init');
                smartSelects.forEach(el => {
                  if (!el.f7SmartSelect) {
                    app.smartSelect.create({
                      el: el,
                      openIn: 'popup',
                      closeOnSelect: true
                    });
                  }
                });
              });
            }
          },
          '$ui.action.$vnode': {
            template: `
            <div class="position-relative" style="width: 100%">
              <div v-if="actions.length === 0" class="text-color-gray">No actions define.</div>
              <div class="display-flex flex-direction-column justify-content-center align-items-center" style="width: 100%" v-else>
                <div v-for="action in actions" style="margin: 10px 0; width: 100%">
                  <div class="button button-fill" style="text-transform: none !important" @click="callMethod(action)">{{ action.method }}</div>
                  <div class="description" v-if="action.description" style="background-color: rgb(249, 250, 251); padding: 1rem 0; color: rgb(75, 85, 99)" v-html="action.description"></div>
                </div>
              </div>
            </div>
            `,
            inject: ['getFrappe'],
            data() {
              return {
                actions: pluginActions,
              };
            },
            methods: {
              async callMethod(act) {
                const clickFn = act.onClick;
                if (typeof clickFn === 'function') {
                  const config = this.getFrappe().web_form.get_value('config');
                  debugger
                  try {
                    const configObj = JSON.parse(config);

                    const applyCfg = (key, newCfg) => {
                      // merge
                      configObj[key] = window.lodash.merge(configObj[key] || {}, newCfg || {});
                      this.getFrappe().web_form.set_value('config', JSON.stringify(configObj, null, 2));
                    };

                    clickFn(configObj[act.method] || defaultJSONConfig[act.method] || {}, configObj, applyCfg);
                  } catch (err) {
                    app.dialog.alert('Config parse error: ' + err);
                  }
                } else {
                  app.dialog.alert('Method not implemented.');
                }
              },
            },
          },
        }
      );

      try {
        await init();
      } catch (err) {
        console.error(err);
      }
    });

    ctx.$onUnmounted(async () => {
      globalVueApp && globalVueApp.$destroy();

      try {
        await deinit();
      } catch (err) {
        console.error(err);
      }
    });

    return $render;
  };
</script>

<style>
  .code-block {
    background: #1e293b;
    color: #10b981;
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 12px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
    line-height: 1.6;
    margin: 0;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .button i.icon {
    margin: 0;
  }
  
  .button.button-fill {
    min-width: 44px; 
    height: 44px;
  }
  
  .card-header .segmented {
    display: flex;
  }
  
  .card-header .segmented .button {
    min-width: 40px;
    padding: 4px 8px;
  }
  
  .block-title {
    font-size: 15px;
    font-weight: 600;
    margin: 16px 0 8px;
  }
  
  .config-list-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  
  .config-list-table th,
  .config-list-table td {
    padding: 12px;
    text-align: left;
    border: 1px solid #e5e7eb;
  }
  
  .config-list-table thead th {
    background-color: #f7f7f8;
    color: #374151;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .config-list-table tbody tr:hover {
    background-color: #f9fafb;
  }
  
  .config-list-table .field-name-cell {
    vertical-align: top;
  }
  
  .config-list-table .field-name-cell strong {
    color: #007aff;
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
  }
  
  .config-list-table .field-value-cell {
    vertical-align: middle;
  }
  
  /* 表格输入框样式 */
  .table-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 13px;
    transition: border-color 0.2s;
  }
  
  .table-input:focus {
    outline: none;
    border-color: #007aff;
  }
  
  .table-textarea {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    min-height: 60px;
    resize: vertical;
    transition: border-color 0.2s;
  }
  
  .table-textarea:focus {
    outline: none;
    border-color: #007aff;
  }
  
  /* 只读模式下的值显示样式 */
  .value-text {
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    max-width: 100%;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    color: #1c1c1e;
  }
  
  .value-code {
    display: -webkit-box;
    line-clamp: 2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    max-width: 100%;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    background-color: #f5f5f7;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 12px;
    color: #007aff;
  }

  @media (max-width: 640px) {
    .config-list-table .field-name-cell strong,
    .value-text,
    .value-code {
      line-clamp: 3;
      -webkit-line-clamp: 3;
    }
  }
  
  /* 编辑模式下的方法名和字段名可点击效果 */
  .block-title span:hover {
    opacity: 0.8;
  }
  
  .field-name-cell strong:hover {
    opacity: 0.8;
  }
</style>
